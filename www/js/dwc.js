	!function(e,t){"use strict";"object"==typeof module&&"object"==typeof module.exports?module.exports=e.document?t(e,!0):function(e){if(!e.document)throw new Error("jQuery requires a window with a document");return t(e)}:t(e)}("undefined"!=typeof window?window:this,function(e,t){"use strict";function DOMEval(e,t){var n=(t=t||r).createElement("script");n.text=e,t.head.appendChild(n).parentNode.removeChild(n)}function isArrayLike(e){var t=!!e&&"length"in e&&e.length,n=g.type(e);return"function"!==n&&!g.isWindow(e)&&("array"===n||0===t||"number"==typeof t&&t>0&&t-1 in e)}function winnow(e,t,n){if(g.isFunction(t))return g.grep(e,function(e,r){return!!t.call(e,r,e)!==n});if(t.nodeType)return g.grep(e,function(e){return e===t!==n});if("string"==typeof t){if(k.test(t))return g.filter(t,e,n);t=g.filter(t,e)}return g.grep(e,function(e){return u.call(t,e)>-1!==n&&1===e.nodeType})}function sibling(e,t){for(;(e=e[t])&&1!==e.nodeType;);return e}function createOptions(e){var t={};return g.each(e.match(j)||[],function(e,n){t[n]=!0}),t}function Identity(e){return e}function Thrower(e){throw e}function adoptValue(e,t,n){var r;try{e&&g.isFunction(r=e.promise)?r.call(e).done(t).fail(n):e&&g.isFunction(r=e.then)?r.call(e,t,n):t.call(void 0,e)}catch(e){n.call(void 0,e)}}function completed(){r.removeEventListener("DOMContentLoaded",completed),e.removeEventListener("load",completed),g.ready()}function Data(){this.expando=g.expando+Data.uid++}function dataAttr(e,t,n){var r;if(void 0===n&&1===e.nodeType)if(r="data-"+t.replace(z,"-$&").toLowerCase(),"string"==typeof(n=e.getAttribute(r))){try{n="true"===n||"false"!==n&&("null"===n?null:+n+""===n?+n:M.test(n)?JSON.parse(n):n)}catch(e){}O.set(e,t,n)}else n=void 0;return n}function adjustCSS(e,t,n,r){var i,o=1,a=20,s=r?function(){return r.cur()}:function(){return g.css(e,t,"")},u=s(),l=n&&n[3]||(g.cssNumber[t]?"":"px"),c=(g.cssNumber[t]||"px"!==l&&+u)&&R.exec(g.css(e,t));if(c&&c[3]!==l){l=l||c[3],n=n||[],c=+u||1;do{c/=o=o||".5",g.style(e,t,c+l)}while(o!==(o=s()/u)&&1!==o&&--a)}return n&&(c=+c||+u||0,i=n[1]?c+(n[1]+1)*n[2]:+n[2],r&&(r.unit=l,r.start=c,r.end=i)),i}function getDefaultDisplay(e){var t,n=e.ownerDocument,r=e.nodeName,i=_[r];return i||(t=n.body.appendChild(n.createElement(r)),i=g.css(t,"display"),t.parentNode.removeChild(t),"none"===i&&(i="block"),_[r]=i,i)}function showHide(e,t){for(var n,r,i=[],o=0,a=e.length;o<a;o++)(r=e[o]).style&&(n=r.style.display,t?("none"===n&&(i[o]=P.get(r,"display")||null,i[o]||(r.style.display="")),""===r.style.display&&$(r)&&(i[o]=getDefaultDisplay(r))):"none"!==n&&(i[o]="none",P.set(r,"display",n)));for(o=0;o<a;o++)null!=i[o]&&(e[o].style.display=i[o]);return e}function getAll(e,t){var n=void 0!==e.getElementsByTagName?e.getElementsByTagName(t||"*"):void 0!==e.querySelectorAll?e.querySelectorAll(t||"*"):[];return void 0===t||t&&g.nodeName(e,t)?g.merge([e],n):n}function setGlobalEval(e,t){for(var n=0,r=e.length;n<r;n++)P.set(e[n],"globalEval",!t||P.get(t[n],"globalEval"))}function buildFragment(e,t,n,r,i){for(var o,a,s,u,l,c,f=t.createDocumentFragment(),d=[],p=0,h=e.length;p<h;p++)if((o=e[p])||0===o)if("object"===g.type(o))g.merge(d,o.nodeType?[o]:o);else if(Y.test(o)){for(a=a||f.appendChild(t.createElement("div")),s=(G.exec(o)||["",""])[1].toLowerCase(),u=V[s]||V._default,a.innerHTML=u[1]+g.htmlPrefilter(o)+u[2],c=u[0];c--;)a=a.lastChild;g.merge(d,a.childNodes),(a=f.firstChild).textContent=""}else d.push(t.createTextNode(o));for(f.textContent="",p=0;o=d[p++];)if(r&&g.inArray(o,r)>-1)i&&i.push(o);else if(l=g.contains(o.ownerDocument,o),a=getAll(f.appendChild(o),"script"),l&&setGlobalEval(a),n)for(c=0;o=a[c++];)U.test(o.type||"")&&n.push(o);return f}function returnTrue(){return!0}function returnFalse(){return!1}function safeActiveElement(){try{return r.activeElement}catch(e){}}function on(e,t,n,r,i,o){var a,s;if("object"==typeof t){"string"!=typeof n&&(r=r||n,n=void 0);for(s in t)on(e,s,n,r,t[s],o);return e}if(null==r&&null==i?(i=n,r=n=void 0):null==i&&("string"==typeof n?(i=r,r=void 0):(i=r,r=n,n=void 0)),!1===i)i=returnFalse;else if(!i)return e;return 1===o&&(a=i,(i=function(e){return g().off(e),a.apply(this,arguments)}).guid=a.guid||(a.guid=g.guid++)),e.each(function(){g.event.add(this,t,i,r,n)})}function manipulationTarget(e,t){return g.nodeName(e,"table")&&g.nodeName(11!==t.nodeType?t:t.firstChild,"tr")?e.getElementsByTagName("tbody")[0]||e:e}function disableScript(e){return e.type=(null!==e.getAttribute("type"))+"/"+e.type,e}function restoreScript(e){var t=re.exec(e.type);return t?e.type=t[1]:e.removeAttribute("type"),e}function cloneCopyEvent(e,t){var n,r,i,o,a,s,u,l;if(1===t.nodeType){if(P.hasData(e)&&(o=P.access(e),a=P.set(t,o),l=o.events)){delete a.handle,a.events={};for(i in l)for(n=0,r=l[i].length;n<r;n++)g.event.add(t,i,l[i][n])}O.hasData(e)&&(s=O.access(e),u=g.extend({},s),O.set(t,u))}}function fixInput(e,t){var n=t.nodeName.toLowerCase();"input"===n&&X.test(e.type)?t.checked=e.checked:"input"!==n&&"textarea"!==n||(t.defaultValue=e.defaultValue)}function domManip(e,t,n,r){t=a.apply([],t);var i,o,s,u,l,c,f=0,d=e.length,p=d-1,m=t[0],v=g.isFunction(m);if(v||d>1&&"string"==typeof m&&!h.checkClone&&ne.test(m))return e.each(function(i){var o=e.eq(i);v&&(t[0]=m.call(this,i,o.html())),domManip(o,t,n,r)});if(d&&(i=buildFragment(t,e[0].ownerDocument,!1,e,r),o=i.firstChild,1===i.childNodes.length&&(i=o),o||r)){for(u=(s=g.map(getAll(i,"script"),disableScript)).length;f<d;f++)l=i,f!==p&&(l=g.clone(l,!0,!0),u&&g.merge(s,getAll(l,"script"))),n.call(e[f],l,f);if(u)for(c=s[s.length-1].ownerDocument,g.map(s,restoreScript),f=0;f<u;f++)l=s[f],U.test(l.type||"")&&!P.access(l,"globalEval")&&g.contains(c,l)&&(l.src?g._evalUrl&&g._evalUrl(l.src):DOMEval(l.textContent.replace(ie,""),c))}return e}function remove(e,t,n){for(var r,i=t?g.filter(t,e):e,o=0;null!=(r=i[o]);o++)n||1!==r.nodeType||g.cleanData(getAll(r)),r.parentNode&&(n&&g.contains(r.ownerDocument,r)&&setGlobalEval(getAll(r,"script")),r.parentNode.removeChild(r));return e}function curCSS(e,t,n){var r,i,o,a,s=e.style;return(n=n||se(e))&&(""!==(a=n.getPropertyValue(t)||n[t])||g.contains(e.ownerDocument,e)||(a=g.style(e,t)),!h.pixelMarginRight()&&ae.test(a)&&oe.test(t)&&(r=s.width,i=s.minWidth,o=s.maxWidth,s.minWidth=s.maxWidth=s.width=a,a=n.width,s.width=r,s.minWidth=i,s.maxWidth=o)),void 0!==a?a+"":a}function addGetHookIf(e,t){return{get:function(){if(!e())return(this.get=t).apply(this,arguments);delete this.get}}}function vendorPropName(e){if(e in de)return e;for(var t=e[0].toUpperCase()+e.slice(1),n=fe.length;n--;)if((e=fe[n]+t)in de)return e}function setPositiveNumber(e,t,n){var r=R.exec(t);return r?Math.max(0,r[2]-(n||0))+(r[3]||"px"):t}function augmentWidthOrHeight(e,t,n,r,i){for(var o=n===(r?"border":"content")?4:"width"===t?1:0,a=0;o<4;o+=2)"margin"===n&&(a+=g.css(e,n+W[o],!0,i)),r?("content"===n&&(a-=g.css(e,"padding"+W[o],!0,i)),"margin"!==n&&(a-=g.css(e,"border"+W[o]+"Width",!0,i))):(a+=g.css(e,"padding"+W[o],!0,i),"padding"!==n&&(a+=g.css(e,"border"+W[o]+"Width",!0,i)));return a}function getWidthOrHeight(e,t,n){var r,i=!0,o=se(e),a="border-box"===g.css(e,"boxSizing",!1,o);if(e.getClientRects().length&&(r=e.getBoundingClientRect()[t]),r<=0||null==r){if(((r=curCSS(e,t,o))<0||null==r)&&(r=e.style[t]),ae.test(r))return r;i=a&&(h.boxSizingReliable()||r===e.style[t]),r=parseFloat(r)||0}return r+augmentWidthOrHeight(e,t,n||(a?"border":"content"),i,o)+"px"}function Tween(e,t,n,r,i){return new Tween.prototype.init(e,t,n,r,i)}function raf(){he&&(e.requestAnimationFrame(raf),g.fx.tick())}function createFxNow(){return e.setTimeout(function(){pe=void 0}),pe=g.now()}function genFx(e,t){var n,r=0,i={height:e};for(t=t?1:0;r<4;r+=2-t)i["margin"+(n=W[r])]=i["padding"+n]=e;return t&&(i.opacity=i.width=e),i}function createTween(e,t,n){for(var r,i=(Animation.tweeners[t]||[]).concat(Animation.tweeners["*"]),o=0,a=i.length;o<a;o++)if(r=i[o].call(n,t,e))return r}function propFilter(e,t){var n,r,i,o,a;for(n in e)if(r=g.camelCase(n),i=t[r],o=e[n],g.isArray(o)&&(i=o[1],o=e[n]=o[0]),n!==r&&(e[r]=o,delete e[n]),(a=g.cssHooks[r])&&"expand"in a){o=a.expand(o),delete e[r];for(n in o)n in e||(e[n]=o[n],t[n]=i)}else t[r]=i}function Animation(e,t,n){var r,i,o=0,a=Animation.prefilters.length,s=g.Deferred().always(function(){delete u.elem}),u=function(){if(i)return!1;for(var t=pe||createFxNow(),n=Math.max(0,l.startTime+l.duration-t),r=1-(n/l.duration||0),o=0,a=l.tweens.length;o<a;o++)l.tweens[o].run(r);return s.notifyWith(e,[l,r,n]),r<1&&a?n:(s.resolveWith(e,[l]),!1)},l=s.promise({elem:e,props:g.extend({},t),opts:g.extend(!0,{specialEasing:{},easing:g.easing._default},n),originalProperties:t,originalOptions:n,startTime:pe||createFxNow(),duration:n.duration,tweens:[],createTween:function(t,n){var r=g.Tween(e,l.opts,t,n,l.opts.specialEasing[t]||l.opts.easing);return l.tweens.push(r),r},stop:function(t){var n=0,r=t?l.tweens.length:0;if(i)return this;for(i=!0;n<r;n++)l.tweens[n].run(1);return t?(s.notifyWith(e,[l,1,0]),s.resolveWith(e,[l,t])):s.rejectWith(e,[l,t]),this}}),c=l.props;for(propFilter(c,l.opts.specialEasing);o<a;o++)if(r=Animation.prefilters[o].call(l,e,c,l.opts))return g.isFunction(r.stop)&&(g._queueHooks(l.elem,l.opts.queue).stop=g.proxy(r.stop,r)),r;return g.map(c,createTween,l),g.isFunction(l.opts.start)&&l.opts.start.call(e,l),g.fx.timer(g.extend(u,{elem:e,anim:l,queue:l.opts.queue})),l.progress(l.opts.progress).done(l.opts.done,l.opts.complete).fail(l.opts.fail).always(l.opts.always)}function getClass(e){return e.getAttribute&&e.getAttribute("class")||""}function buildParams(e,t,n,r){var i;if(g.isArray(t))g.each(t,function(t,i){n||Ne.test(e)?r(e,i):buildParams(e+"["+("object"==typeof i&&null!=i?t:"")+"]",i,n,r)});else if(n||"object"!==g.type(t))r(e,t);else for(i in t)buildParams(e+"["+i+"]",t[i],n,r)}function addToPrefiltersOrTransports(e){return function(t,n){"string"!=typeof t&&(n=t,t="*");var r,i=0,o=t.toLowerCase().match(j)||[];if(g.isFunction(n))for(;r=o[i++];)"+"===r[0]?(r=r.slice(1)||"*",(e[r]=e[r]||[]).unshift(n)):(e[r]=e[r]||[]).push(n)}}function inspectPrefiltersOrTransports(e,t,n,r){function inspect(a){var s;return i[a]=!0,g.each(e[a]||[],function(e,a){var u=a(t,n,r);return"string"!=typeof u||o||i[u]?o?!(s=u):void 0:(t.dataTypes.unshift(u),inspect(u),!1)}),s}var i={},o=e===Re;return inspect(t.dataTypes[0])||!i["*"]&&inspect("*")}function ajaxExtend(e,t){var n,r,i=g.ajaxSettings.flatOptions||{};for(n in t)void 0!==t[n]&&((i[n]?e:r||(r={}))[n]=t[n]);return r&&g.extend(!0,e,r),e}function ajaxHandleResponses(e,t,n){for(var r,i,o,a,s=e.contents,u=e.dataTypes;"*"===u[0];)u.shift(),void 0===r&&(r=e.mimeType||t.getResponseHeader("Content-Type"));if(r)for(i in s)if(s[i]&&s[i].test(r)){u.unshift(i);break}if(u[0]in n)o=u[0];else{for(i in n){if(!u[0]||e.converters[i+" "+u[0]]){o=i;break}a||(a=i)}o=o||a}if(o)return o!==u[0]&&u.unshift(o),n[o]}function ajaxConvert(e,t,n,r){var i,o,a,s,u,l={},c=e.dataTypes.slice();if(c[1])for(a in e.converters)l[a.toLowerCase()]=e.converters[a];for(o=c.shift();o;)if(e.responseFields[o]&&(n[e.responseFields[o]]=t),!u&&r&&e.dataFilter&&(t=e.dataFilter(t,e.dataType)),u=o,o=c.shift())if("*"===o)o=u;else if("*"!==u&&u!==o){if(!(a=l[u+" "+o]||l["* "+o]))for(i in l)if((s=i.split(" "))[1]===o&&(a=l[u+" "+s[0]]||l["* "+s[0]])){!0===a?a=l[i]:!0!==l[i]&&(o=s[0],c.unshift(s[1]));break}if(!0!==a)if(a&&e.throws)t=a(t);else try{t=a(t)}catch(e){return{state:"parsererror",error:a?e:"No conversion from "+u+" to "+o}}}return{state:"success",data:t}}function getWindow(e){return g.isWindow(e)?e:9===e.nodeType&&e.defaultView}var n=[],r=e.document,i=Object.getPrototypeOf,o=n.slice,a=n.concat,s=n.push,u=n.indexOf,l={},c=l.toString,f=l.hasOwnProperty,d=f.toString,p=d.call(Object),h={},g=function(e,t){return new g.fn.init(e,t)},m=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,v=/^-ms-/,y=/-([a-z])/g,x=function(e,t){return t.toUpperCase()};g.fn=g.prototype={jquery:"3.1.0",constructor:g,length:0,toArray:function(){return o.call(this)},get:function(e){return null!=e?e<0?this[e+this.length]:this[e]:o.call(this)},pushStack:function(e){var t=g.merge(this.constructor(),e);return t.prevObject=this,t},each:function(e){return g.each(this,e)},map:function(e){return this.pushStack(g.map(this,function(t,n){return e.call(t,n,t)}))},slice:function(){return this.pushStack(o.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(e){var t=this.length,n=+e+(e<0?t:0);return this.pushStack(n>=0&&n<t?[this[n]]:[])},end:function(){return this.prevObject||this.constructor()},push:s,sort:n.sort,splice:n.splice},g.extend=g.fn.extend=function(){var e,t,n,r,i,o,a=arguments[0]||{},s=1,u=arguments.length,l=!1;for("boolean"==typeof a&&(l=a,a=arguments[s]||{},s++),"object"==typeof a||g.isFunction(a)||(a={}),s===u&&(a=this,s--);s<u;s++)if(null!=(e=arguments[s]))for(t in e)n=a[t],a!==(r=e[t])&&(l&&r&&(g.isPlainObject(r)||(i=g.isArray(r)))?(i?(i=!1,o=n&&g.isArray(n)?n:[]):o=n&&g.isPlainObject(n)?n:{},a[t]=g.extend(l,o,r)):void 0!==r&&(a[t]=r));return a},g.extend({expando:"jQuery"+("3.1.0"+Math.random()).replace(/\D/g,""),isReady:!0,error:function(e){throw new Error(e)},noop:function(){},isFunction:function(e){return"function"===g.type(e)},isArray:Array.isArray,isWindow:function(e){return null!=e&&e===e.window},isNumeric:function(e){var t=g.type(e);return("number"===t||"string"===t)&&!isNaN(e-parseFloat(e))},isPlainObject:function(e){var t,n;return!(!e||"[object Object]"!==c.call(e))&&(!(t=i(e))||"function"==typeof(n=f.call(t,"constructor")&&t.constructor)&&d.call(n)===p)},isEmptyObject:function(e){var t;for(t in e)return!1;return!0},type:function(e){return null==e?e+"":"object"==typeof e||"function"==typeof e?l[c.call(e)]||"object":typeof e},globalEval:function(e){DOMEval(e)},camelCase:function(e){return e.replace(v,"ms-").replace(y,x)},nodeName:function(e,t){return e.nodeName&&e.nodeName.toLowerCase()===t.toLowerCase()},each:function(e,t){var n,r=0;if(isArrayLike(e))for(n=e.length;r<n&&!1!==t.call(e[r],r,e[r]);r++);else for(r in e)if(!1===t.call(e[r],r,e[r]))break;return e},trim:function(e){return null==e?"":(e+"").replace(m,"")},makeArray:function(e,t){var n=t||[];return null!=e&&(isArrayLike(Object(e))?g.merge(n,"string"==typeof e?[e]:e):s.call(n,e)),n},inArray:function(e,t,n){return null==t?-1:u.call(t,e,n)},merge:function(e,t){for(var n=+t.length,r=0,i=e.length;r<n;r++)e[i++]=t[r];return e.length=i,e},grep:function(e,t,n){for(var r=[],i=0,o=e.length,a=!n;i<o;i++)!t(e[i],i)!==a&&r.push(e[i]);return r},map:function(e,t,n){var r,i,o=0,s=[];if(isArrayLike(e))for(r=e.length;o<r;o++)null!=(i=t(e[o],o,n))&&s.push(i);else for(o in e)null!=(i=t(e[o],o,n))&&s.push(i);return a.apply([],s)},guid:1,proxy:function(e,t){var n,r,i;if("string"==typeof t&&(n=e[t],t=e,e=n),g.isFunction(e))return r=o.call(arguments,2),i=function(){return e.apply(t||this,r.concat(o.call(arguments)))},i.guid=e.guid=e.guid||g.guid++,i},now:Date.now,support:h}),"function"==typeof Symbol&&(g.fn[Symbol.iterator]=n[Symbol.iterator]),g.each("Boolean Number String Function Array Date RegExp Object Error Symbol".split(" "),function(e,t){l["[object "+t+"]"]=t.toLowerCase()});var b=function(e){function Sizzle(e,t,r,i){var o,s,l,c,f,h,v,y=t&&t.ownerDocument,T=t?t.nodeType:9;if(r=r||[],"string"!=typeof e||!e||1!==T&&9!==T&&11!==T)return r;if(!i&&((t?t.ownerDocument||t:w)!==p&&d(t),t=t||p,g)){if(11!==T&&(f=J.exec(e)))if(o=f[1]){if(9===T){if(!(l=t.getElementById(o)))return r;if(l.id===o)return r.push(l),r}else if(y&&(l=y.getElementById(o))&&x(t,l)&&l.id===o)return r.push(l),r}else{if(f[2])return H.apply(r,t.getElementsByTagName(e)),r;if((o=f[3])&&n.getElementsByClassName&&t.getElementsByClassName)return H.apply(r,t.getElementsByClassName(o)),r}if(n.qsa&&!E[e+" "]&&(!m||!m.test(e))){if(1!==T)y=t,v=e;else if("object"!==t.nodeName.toLowerCase()){for((c=t.getAttribute("id"))?c=c.replace(te,ne):t.setAttribute("id",c=b),s=(h=a(e)).length;s--;)h[s]="#"+c+" "+toSelector(h[s]);v=h.join(","),y=K.test(e)&&testContext(t.parentNode)||t}if(v)try{return H.apply(r,y.querySelectorAll(v)),r}catch(e){}finally{c===b&&t.removeAttribute("id")}}}return u(e.replace(W,"$1"),t,r,i)}function createCache(){function cache(t,n){return e.push(t+" ")>r.cacheLength&&delete cache[e.shift()],cache[t+" "]=n}var e=[];return cache}function markFunction(e){return e[b]=!0,e}function assert(e){var t=p.createElement("fieldset");try{return!!e(t)}catch(e){return!1}finally{t.parentNode&&t.parentNode.removeChild(t),t=null}}function addHandle(e,t){for(var n=e.split("|"),i=n.length;i--;)r.attrHandle[n[i]]=t}function siblingCheck(e,t){var n=t&&e,r=n&&1===e.nodeType&&1===t.nodeType&&e.sourceIndex-t.sourceIndex;if(r)return r;if(n)for(;n=n.nextSibling;)if(n===t)return-1;return e?1:-1}function createDisabledPseudo(e){return function(t){return"label"in t&&t.disabled===e||"form"in t&&t.disabled===e||"form"in t&&!1===t.disabled&&(t.isDisabled===e||t.isDisabled!==!e&&("label"in t||!ie(t))!==e)}}function createPositionalPseudo(e){return markFunction(function(t){return t=+t,markFunction(function(n,r){for(var i,o=e([],n.length,t),a=o.length;a--;)n[i=o[a]]&&(n[i]=!(r[i]=n[i]))})})}function testContext(e){return e&&void 0!==e.getElementsByTagName&&e}function setFilters(){}function toSelector(e){for(var t=0,n=e.length,r="";t<n;t++)r+=e[t].value;return r}function addCombinator(e,t,n){var r=t.dir,i=t.next,o=i||r,a=n&&"parentNode"===o,s=C++;return t.first?function(t,n,i){for(;t=t[r];)if(1===t.nodeType||a)return e(t,n,i)}:function(t,n,u){var l,c,f,d=[T,s];if(u){for(;t=t[r];)if((1===t.nodeType||a)&&e(t,n,u))return!0}else for(;t=t[r];)if(1===t.nodeType||a)if(f=t[b]||(t[b]={}),c=f[t.uniqueID]||(f[t.uniqueID]={}),i&&i===t.nodeName.toLowerCase())t=t[r]||t;else{if((l=c[o])&&l[0]===T&&l[1]===s)return d[2]=l[2];if(c[o]=d,d[2]=e(t,n,u))return!0}}}function elementMatcher(e){return e.length>1?function(t,n,r){for(var i=e.length;i--;)if(!e[i](t,n,r))return!1;return!0}:e[0]}function multipleContexts(e,t,n){for(var r=0,i=t.length;r<i;r++)Sizzle(e,t[r],n);return n}function condense(e,t,n,r,i){for(var o,a=[],s=0,u=e.length,l=null!=t;s<u;s++)(o=e[s])&&(n&&!n(o,r,i)||(a.push(o),l&&t.push(s)));return a}function setMatcher(e,t,n,r,i,o){return r&&!r[b]&&(r=setMatcher(r)),i&&!i[b]&&(i=setMatcher(i,o)),markFunction(function(o,a,s,u){var l,c,f,d=[],p=[],h=a.length,g=o||multipleContexts(t||"*",s.nodeType?[s]:s,[]),m=!e||!o&&t?g:condense(g,d,e,s,u),v=n?i||(o?e:h||r)?[]:a:m;if(n&&n(m,v,s,u),r)for(l=condense(v,p),r(l,[],s,u),c=l.length;c--;)(f=l[c])&&(v[p[c]]=!(m[p[c]]=f));if(o){if(i||e){if(i){for(l=[],c=v.length;c--;)(f=v[c])&&l.push(m[c]=f);i(null,v=[],l,u)}for(c=v.length;c--;)(f=v[c])&&(l=i?L(o,f):d[c])>-1&&(o[l]=!(a[l]=f))}}else v=condense(v===a?v.splice(h,v.length):v),i?i(null,a,v,u):H.apply(a,v)})}function matcherFromTokens(e){for(var t,n,i,o=e.length,a=r.relative[e[0].type],s=a||r.relative[" "],u=a?1:0,c=addCombinator(function(e){return e===t},s,!0),f=addCombinator(function(e){return L(t,e)>-1},s,!0),d=[function(e,n,r){var i=!a&&(r||n!==l)||((t=n).nodeType?c(e,n,r):f(e,n,r));return t=null,i}];u<o;u++)if(n=r.relative[e[u].type])d=[addCombinator(elementMatcher(d),n)];else{if((n=r.filter[e[u].type].apply(null,e[u].matches))[b]){for(i=++u;i<o&&!r.relative[e[i].type];i++);return setMatcher(u>1&&elementMatcher(d),u>1&&toSelector(e.slice(0,u-1).concat({value:" "===e[u-2].type?"*":""})).replace(W,"$1"),n,u<i&&matcherFromTokens(e.slice(u,i)),i<o&&matcherFromTokens(e=e.slice(i)),i<o&&toSelector(e))}d.push(n)}return elementMatcher(d)}function matcherFromGroupMatchers(e,t){var n=t.length>0,i=e.length>0,o=function(o,a,s,u,c){var f,h,m,v=0,y="0",x=o&&[],b=[],w=l,C=o||i&&r.find.TAG("*",c),S=T+=null==w?1:Math.random()||.1,k=C.length;for(c&&(l=a===p||a||c);y!==k&&null!=(f=C[y]);y++){if(i&&f){for(h=0,a||f.ownerDocument===p||(d(f),s=!g);m=e[h++];)if(m(f,a||p,s)){u.push(f);break}c&&(T=S)}n&&((f=!m&&f)&&v--,o&&x.push(f))}if(v+=y,n&&y!==v){for(h=0;m=t[h++];)m(x,b,a,s);if(o){if(v>0)for(;y--;)x[y]||b[y]||(b[y]=j.call(u));b=condense(b)}H.apply(u,b),c&&!o&&b.length>0&&v+t.length>1&&Sizzle.uniqueSort(u)}return c&&(T=S,l=w),x};return n?markFunction(o):o}var t,n,r,i,o,a,s,u,l,c,f,d,p,h,g,m,v,y,x,b="sizzle"+1*new Date,w=e.document,T=0,C=0,S=createCache(),k=createCache(),E=createCache(),A=function(e,t){return e===t&&(f=!0),0},N={}.hasOwnProperty,D=[],j=D.pop,F=D.push,H=D.push,q=D.slice,L=function(e,t){for(var n=0,r=e.length;n<r;n++)if(e[n]===t)return n;return-1},P="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",O="[\\x20\\t\\r\\n\\f]",M="(?:\\\\.|[\\w-]|[^\0-\\xa0])+",z="\\["+O+"*("+M+")(?:"+O+"*([*^$|!~]?=)"+O+"*(?:'((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\"|("+M+"))|)"+O+"*\\]",I=":("+M+")(?:\\((('((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\")|((?:\\\\.|[^\\\\()[\\]]|"+z+")*)|.*)\\)|)",R=new RegExp(O+"+","g"),W=new RegExp("^"+O+"+|((?:^|[^\\\\])(?:\\\\.)*)"+O+"+$","g"),$=new RegExp("^"+O+"*,"+O+"*"),B=new RegExp("^"+O+"*([>+~]|"+O+")"+O+"*"),_=new RegExp("="+O+"*([^\\]'\"]*?)"+O+"*\\]","g"),X=new RegExp(I),G=new RegExp("^"+M+"$"),U={ID:new RegExp("^#("+M+")"),CLASS:new RegExp("^\\.("+M+")"),TAG:new RegExp("^("+M+"|[*])"),ATTR:new RegExp("^"+z),PSEUDO:new RegExp("^"+I),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+O+"*(even|odd|(([+-]|)(\\d*)n|)"+O+"*(?:([+-]|)"+O+"*(\\d+)|))"+O+"*\\)|)","i"),bool:new RegExp("^(?:"+P+")$","i"),needsContext:new RegExp("^"+O+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+O+"*((?:-\\d)?\\d*)"+O+"*\\)|)(?=[^-]|$)","i")},V=/^(?:input|select|textarea|button)$/i,Y=/^h\d$/i,Q=/^[^{]+\{\s*\[native \w/,J=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,K=/[+~]/,Z=new RegExp("\\\\([\\da-f]{1,6}"+O+"?|("+O+")|.)","ig"),ee=function(e,t,n){var r="0x"+t-65536;return r!==r||n?t:r<0?String.fromCharCode(r+65536):String.fromCharCode(r>>10|55296,1023&r|56320)},te=/([\0-\x1f\x7f]|^-?\d)|^-$|[^\x80-\uFFFF\w-]/g,ne=function(e,t){return t?"\0"===e?"�":e.slice(0,-1)+"\\"+e.charCodeAt(e.length-1).toString(16)+" ":"\\"+e},re=function(){d()},ie=addCombinator(function(e){return!0===e.disabled},{dir:"parentNode",next:"legend"});try{H.apply(D=q.call(w.childNodes),w.childNodes),D[w.childNodes.length].nodeType}catch(e){H={apply:D.length?function(e,t){F.apply(e,q.call(t))}:function(e,t){for(var n=e.length,r=0;e[n++]=t[r++];);e.length=n-1}}}n=Sizzle.support={},o=Sizzle.isXML=function(e){var t=e&&(e.ownerDocument||e).documentElement;return!!t&&"HTML"!==t.nodeName},d=Sizzle.setDocument=function(e){var t,i,a=e?e.ownerDocument||e:w;return a!==p&&9===a.nodeType&&a.documentElement?(p=a,h=p.documentElement,g=!o(p),w!==p&&(i=p.defaultView)&&i.top!==i&&(i.addEventListener?i.addEventListener("unload",re,!1):i.attachEvent&&i.attachEvent("onunload",re)),n.attributes=assert(function(e){return e.className="i",!e.getAttribute("className")}),n.getElementsByTagName=assert(function(e){return e.appendChild(p.createComment("")),!e.getElementsByTagName("*").length}),n.getElementsByClassName=Q.test(p.getElementsByClassName),n.getById=assert(function(e){return h.appendChild(e).id=b,!p.getElementsByName||!p.getElementsByName(b).length}),n.getById?(r.find.ID=function(e,t){if(void 0!==t.getElementById&&g){var n=t.getElementById(e);return n?[n]:[]}},r.filter.ID=function(e){var t=e.replace(Z,ee);return function(e){return e.getAttribute("id")===t}}):(delete r.find.ID,r.filter.ID=function(e){var t=e.replace(Z,ee);return function(e){var n=void 0!==e.getAttributeNode&&e.getAttributeNode("id");return n&&n.value===t}}),r.find.TAG=n.getElementsByTagName?function(e,t){return void 0!==t.getElementsByTagName?t.getElementsByTagName(e):n.qsa?t.querySelectorAll(e):void 0}:function(e,t){var n,r=[],i=0,o=t.getElementsByTagName(e);if("*"===e){for(;n=o[i++];)1===n.nodeType&&r.push(n);return r}return o},r.find.CLASS=n.getElementsByClassName&&function(e,t){if(void 0!==t.getElementsByClassName&&g)return t.getElementsByClassName(e)},v=[],m=[],(n.qsa=Q.test(p.querySelectorAll))&&(assert(function(e){h.appendChild(e).innerHTML="<a id='"+b+"'></a><select id='"+b+"-\r\\' msallowcapture=''><option selected=''></option></select>",e.querySelectorAll("[msallowcapture^='']").length&&m.push("[*^$]="+O+"*(?:''|\"\")"),e.querySelectorAll("[selected]").length||m.push("\\["+O+"*(?:value|"+P+")"),e.querySelectorAll("[id~="+b+"-]").length||m.push("~="),e.querySelectorAll(":checked").length||m.push(":checked"),e.querySelectorAll("a#"+b+"+*").length||m.push(".#.+[+~]")}),assert(function(e){e.innerHTML="<a href='' disabled='disabled'></a><select disabled='disabled'><option/></select>";var t=p.createElement("input");t.setAttribute("type","hidden"),e.appendChild(t).setAttribute("name","D"),e.querySelectorAll("[name=d]").length&&m.push("name"+O+"*[*^$|!~]?="),2!==e.querySelectorAll(":enabled").length&&m.push(":enabled",":disabled"),h.appendChild(e).disabled=!0,2!==e.querySelectorAll(":disabled").length&&m.push(":enabled",":disabled"),e.querySelectorAll("*,:x"),m.push(",.*:")})),(n.matchesSelector=Q.test(y=h.matches||h.webkitMatchesSelector||h.mozMatchesSelector||h.oMatchesSelector||h.msMatchesSelector))&&assert(function(e){n.disconnectedMatch=y.call(e,"*"),y.call(e,"[s!='']:x"),v.push("!=",I)}),m=m.length&&new RegExp(m.join("|")),v=v.length&&new RegExp(v.join("|")),t=Q.test(h.compareDocumentPosition),x=t||Q.test(h.contains)?function(e,t){var n=9===e.nodeType?e.documentElement:e,r=t&&t.parentNode;return e===r||!(!r||1!==r.nodeType||!(n.contains?n.contains(r):e.compareDocumentPosition&&16&e.compareDocumentPosition(r)))}:function(e,t){if(t)for(;t=t.parentNode;)if(t===e)return!0;return!1},A=t?function(e,t){if(e===t)return f=!0,0;var r=!e.compareDocumentPosition-!t.compareDocumentPosition;return r||(1&(r=(e.ownerDocument||e)===(t.ownerDocument||t)?e.compareDocumentPosition(t):1)||!n.sortDetached&&t.compareDocumentPosition(e)===r?e===p||e.ownerDocument===w&&x(w,e)?-1:t===p||t.ownerDocument===w&&x(w,t)?1:c?L(c,e)-L(c,t):0:4&r?-1:1)}:function(e,t){if(e===t)return f=!0,0;var n,r=0,i=e.parentNode,o=t.parentNode,a=[e],s=[t];if(!i||!o)return e===p?-1:t===p?1:i?-1:o?1:c?L(c,e)-L(c,t):0;if(i===o)return siblingCheck(e,t);for(n=e;n=n.parentNode;)a.unshift(n);for(n=t;n=n.parentNode;)s.unshift(n);for(;a[r]===s[r];)r++;return r?siblingCheck(a[r],s[r]):a[r]===w?-1:s[r]===w?1:0},p):p},Sizzle.matches=function(e,t){return Sizzle(e,null,null,t)},Sizzle.matchesSelector=function(e,t){if((e.ownerDocument||e)!==p&&d(e),t=t.replace(_,"='$1']"),n.matchesSelector&&g&&!E[t+" "]&&(!v||!v.test(t))&&(!m||!m.test(t)))try{var r=y.call(e,t);if(r||n.disconnectedMatch||e.document&&11!==e.document.nodeType)return r}catch(e){}return Sizzle(t,p,null,[e]).length>0},Sizzle.contains=function(e,t){return(e.ownerDocument||e)!==p&&d(e),x(e,t)},Sizzle.attr=function(e,t){(e.ownerDocument||e)!==p&&d(e);var i=r.attrHandle[t.toLowerCase()],o=i&&N.call(r.attrHandle,t.toLowerCase())?i(e,t,!g):void 0;return void 0!==o?o:n.attributes||!g?e.getAttribute(t):(o=e.getAttributeNode(t))&&o.specified?o.value:null},Sizzle.escape=function(e){return(e+"").replace(te,ne)},Sizzle.error=function(e){throw new Error("Syntax error, unrecognized expression: "+e)},Sizzle.uniqueSort=function(e){var t,r=[],i=0,o=0;if(f=!n.detectDuplicates,c=!n.sortStable&&e.slice(0),e.sort(A),f){for(;t=e[o++];)t===e[o]&&(i=r.push(o));for(;i--;)e.splice(r[i],1)}return c=null,e},i=Sizzle.getText=function(e){var t,n="",r=0,o=e.nodeType;if(o){if(1===o||9===o||11===o){if("string"==typeof e.textContent)return e.textContent;for(e=e.firstChild;e;e=e.nextSibling)n+=i(e)}else if(3===o||4===o)return e.nodeValue}else for(;t=e[r++];)n+=i(t);return n},(r=Sizzle.selectors={cacheLength:50,createPseudo:markFunction,match:U,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(e){return e[1]=e[1].replace(Z,ee),e[3]=(e[3]||e[4]||e[5]||"").replace(Z,ee),"~="===e[2]&&(e[3]=" "+e[3]+" "),e.slice(0,4)},CHILD:function(e){return e[1]=e[1].toLowerCase(),"nth"===e[1].slice(0,3)?(e[3]||Sizzle.error(e[0]),e[4]=+(e[4]?e[5]+(e[6]||1):2*("even"===e[3]||"odd"===e[3])),e[5]=+(e[7]+e[8]||"odd"===e[3])):e[3]&&Sizzle.error(e[0]),e},PSEUDO:function(e){var t,n=!e[6]&&e[2];return U.CHILD.test(e[0])?null:(e[3]?e[2]=e[4]||e[5]||"":n&&X.test(n)&&(t=a(n,!0))&&(t=n.indexOf(")",n.length-t)-n.length)&&(e[0]=e[0].slice(0,t),e[2]=n.slice(0,t)),e.slice(0,3))}},filter:{TAG:function(e){var t=e.replace(Z,ee).toLowerCase();return"*"===e?function(){return!0}:function(e){return e.nodeName&&e.nodeName.toLowerCase()===t}},CLASS:function(e){var t=S[e+" "];return t||(t=new RegExp("(^|"+O+")"+e+"("+O+"|$)"))&&S(e,function(e){return t.test("string"==typeof e.className&&e.className||void 0!==e.getAttribute&&e.getAttribute("class")||"")})},ATTR:function(e,t,n){return function(r){var i=Sizzle.attr(r,e);return null==i?"!="===t:!t||(i+="","="===t?i===n:"!="===t?i!==n:"^="===t?n&&0===i.indexOf(n):"*="===t?n&&i.indexOf(n)>-1:"$="===t?n&&i.slice(-n.length)===n:"~="===t?(" "+i.replace(R," ")+" ").indexOf(n)>-1:"|="===t&&(i===n||i.slice(0,n.length+1)===n+"-"))}},CHILD:function(e,t,n,r,i){var o="nth"!==e.slice(0,3),a="last"!==e.slice(-4),s="of-type"===t;return 1===r&&0===i?function(e){return!!e.parentNode}:function(t,n,u){var l,c,f,d,p,h,g=o!==a?"nextSibling":"previousSibling",m=t.parentNode,v=s&&t.nodeName.toLowerCase(),y=!u&&!s,x=!1;if(m){if(o){for(;g;){for(d=t;d=d[g];)if(s?d.nodeName.toLowerCase()===v:1===d.nodeType)return!1;h=g="only"===e&&!h&&"nextSibling"}return!0}if(h=[a?m.firstChild:m.lastChild],a&&y){for(x=(p=(l=(c=(f=(d=m)[b]||(d[b]={}))[d.uniqueID]||(f[d.uniqueID]={}))[e]||[])[0]===T&&l[1])&&l[2],d=p&&m.childNodes[p];d=++p&&d&&d[g]||(x=p=0)||h.pop();)if(1===d.nodeType&&++x&&d===t){c[e]=[T,p,x];break}}else if(y&&(x=p=(l=(c=(f=(d=t)[b]||(d[b]={}))[d.uniqueID]||(f[d.uniqueID]={}))[e]||[])[0]===T&&l[1]),!1===x)for(;(d=++p&&d&&d[g]||(x=p=0)||h.pop())&&((s?d.nodeName.toLowerCase()!==v:1!==d.nodeType)||!++x||(y&&((c=(f=d[b]||(d[b]={}))[d.uniqueID]||(f[d.uniqueID]={}))[e]=[T,x]),d!==t)););return(x-=i)===r||x%r==0&&x/r>=0}}},PSEUDO:function(e,t){var n,i=r.pseudos[e]||r.setFilters[e.toLowerCase()]||Sizzle.error("unsupported pseudo: "+e);return i[b]?i(t):i.length>1?(n=[e,e,"",t],r.setFilters.hasOwnProperty(e.toLowerCase())?markFunction(function(e,n){for(var r,o=i(e,t),a=o.length;a--;)e[r=L(e,o[a])]=!(n[r]=o[a])}):function(e){return i(e,0,n)}):i}},pseudos:{not:markFunction(function(e){var t=[],n=[],r=s(e.replace(W,"$1"));return r[b]?markFunction(function(e,t,n,i){for(var o,a=r(e,null,i,[]),s=e.length;s--;)(o=a[s])&&(e[s]=!(t[s]=o))}):function(e,i,o){return t[0]=e,r(t,null,o,n),t[0]=null,!n.pop()}}),has:markFunction(function(e){return function(t){return Sizzle(e,t).length>0}}),contains:markFunction(function(e){return e=e.replace(Z,ee),function(t){return(t.textContent||t.innerText||i(t)).indexOf(e)>-1}}),lang:markFunction(function(e){return G.test(e||"")||Sizzle.error("unsupported lang: "+e),e=e.replace(Z,ee).toLowerCase(),function(t){var n;do{if(n=g?t.lang:t.getAttribute("xml:lang")||t.getAttribute("lang"))return(n=n.toLowerCase())===e||0===n.indexOf(e+"-")}while((t=t.parentNode)&&1===t.nodeType);return!1}}),target:function(t){var n=e.location&&e.location.hash;return n&&n.slice(1)===t.id},root:function(e){return e===h},focus:function(e){return e===p.activeElement&&(!p.hasFocus||p.hasFocus())&&!!(e.type||e.href||~e.tabIndex)},enabled:createDisabledPseudo(!1),disabled:createDisabledPseudo(!0),checked:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&!!e.checked||"option"===t&&!!e.selected},selected:function(e){return e.parentNode&&e.parentNode.selectedIndex,!0===e.selected},empty:function(e){for(e=e.firstChild;e;e=e.nextSibling)if(e.nodeType<6)return!1;return!0},parent:function(e){return!r.pseudos.empty(e)},header:function(e){return Y.test(e.nodeName)},input:function(e){return V.test(e.nodeName)},button:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&"button"===e.type||"button"===t},text:function(e){var t;return"input"===e.nodeName.toLowerCase()&&"text"===e.type&&(null==(t=e.getAttribute("type"))||"text"===t.toLowerCase())},first:createPositionalPseudo(function(){return[0]}),last:createPositionalPseudo(function(e,t){return[t-1]}),eq:createPositionalPseudo(function(e,t,n){return[n<0?n+t:n]}),even:createPositionalPseudo(function(e,t){for(var n=0;n<t;n+=2)e.push(n);return e}),odd:createPositionalPseudo(function(e,t){for(var n=1;n<t;n+=2)e.push(n);return e}),lt:createPositionalPseudo(function(e,t,n){for(var r=n<0?n+t:n;--r>=0;)e.push(r);return e}),gt:createPositionalPseudo(function(e,t,n){for(var r=n<0?n+t:n;++r<t;)e.push(r);return e})}}).pseudos.nth=r.pseudos.eq;for(t in{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})r.pseudos[t]=function createInputPseudo(e){return function(t){return"input"===t.nodeName.toLowerCase()&&t.type===e}}(t);for(t in{submit:!0,reset:!0})r.pseudos[t]=function createButtonPseudo(e){return function(t){var n=t.nodeName.toLowerCase();return("input"===n||"button"===n)&&t.type===e}}(t);return setFilters.prototype=r.filters=r.pseudos,r.setFilters=new setFilters,a=Sizzle.tokenize=function(e,t){var n,i,o,a,s,u,l,c=k[e+" "];if(c)return t?0:c.slice(0);for(s=e,u=[],l=r.preFilter;s;){n&&!(i=$.exec(s))||(i&&(s=s.slice(i[0].length)||s),u.push(o=[])),n=!1,(i=B.exec(s))&&(n=i.shift(),o.push({value:n,type:i[0].replace(W," ")}),s=s.slice(n.length));for(a in r.filter)!(i=U[a].exec(s))||l[a]&&!(i=l[a](i))||(n=i.shift(),o.push({value:n,type:a,matches:i}),s=s.slice(n.length));if(!n)break}return t?s.length:s?Sizzle.error(e):k(e,u).slice(0)},s=Sizzle.compile=function(e,t){var n,r=[],i=[],o=E[e+" "];if(!o){for(t||(t=a(e)),n=t.length;n--;)(o=matcherFromTokens(t[n]))[b]?r.push(o):i.push(o);(o=E(e,matcherFromGroupMatchers(i,r))).selector=e}return o},u=Sizzle.select=function(e,t,i,o){var u,l,c,f,d,p="function"==typeof e&&e,h=!o&&a(e=p.selector||e);if(i=i||[],1===h.length){if((l=h[0]=h[0].slice(0)).length>2&&"ID"===(c=l[0]).type&&n.getById&&9===t.nodeType&&g&&r.relative[l[1].type]){if(!(t=(r.find.ID(c.matches[0].replace(Z,ee),t)||[])[0]))return i;p&&(t=t.parentNode),e=e.slice(l.shift().value.length)}for(u=U.needsContext.test(e)?0:l.length;u--&&(c=l[u],!r.relative[f=c.type]);)if((d=r.find[f])&&(o=d(c.matches[0].replace(Z,ee),K.test(l[0].type)&&testContext(t.parentNode)||t))){if(l.splice(u,1),!(e=o.length&&toSelector(l)))return H.apply(i,o),i;break}}return(p||s(e,h))(o,t,!g,i,!t||K.test(e)&&testContext(t.parentNode)||t),i},n.sortStable=b.split("").sort(A).join("")===b,n.detectDuplicates=!!f,d(),n.sortDetached=assert(function(e){return 1&e.compareDocumentPosition(p.createElement("fieldset"))}),assert(function(e){return e.innerHTML="<a href='#'></a>","#"===e.firstChild.getAttribute("href")})||addHandle("type|href|height|width",function(e,t,n){if(!n)return e.getAttribute(t,"type"===t.toLowerCase()?1:2)}),n.attributes&&assert(function(e){return e.innerHTML="<input/>",e.firstChild.setAttribute("value",""),""===e.firstChild.getAttribute("value")})||addHandle("value",function(e,t,n){if(!n&&"input"===e.nodeName.toLowerCase())return e.defaultValue}),assert(function(e){return null==e.getAttribute("disabled")})||addHandle(P,function(e,t,n){var r;if(!n)return!0===e[t]?t.toLowerCase():(r=e.getAttributeNode(t))&&r.specified?r.value:null}),Sizzle}(e);g.find=b,g.expr=b.selectors,g.expr[":"]=g.expr.pseudos,g.uniqueSort=g.unique=b.uniqueSort,g.text=b.getText,g.isXMLDoc=b.isXML,g.contains=b.contains,g.escapeSelector=b.escape;var w=function(e,t,n){for(var r=[],i=void 0!==n;(e=e[t])&&9!==e.nodeType;)if(1===e.nodeType){if(i&&g(e).is(n))break;r.push(e)}return r},T=function(e,t){for(var n=[];e;e=e.nextSibling)1===e.nodeType&&e!==t&&n.push(e);return n},C=g.expr.match.needsContext,S=/^<([a-z][^\/\0>:\x20\t\r\n\f]*)[\x20\t\r\n\f]*\/?>(?:<\/\1>|)$/i,k=/^.[^:#\[\.,]*$/;g.filter=function(e,t,n){var r=t[0];return n&&(e=":not("+e+")"),1===t.length&&1===r.nodeType?g.find.matchesSelector(r,e)?[r]:[]:g.find.matches(e,g.grep(t,function(e){return 1===e.nodeType}))},g.fn.extend({find:function(e){var t,n,r=this.length,i=this;if("string"!=typeof e)return this.pushStack(g(e).filter(function(){for(t=0;t<r;t++)if(g.contains(i[t],this))return!0}));for(n=this.pushStack([]),t=0;t<r;t++)g.find(e,i[t],n);return r>1?g.uniqueSort(n):n},filter:function(e){return this.pushStack(winnow(this,e||[],!1))},not:function(e){return this.pushStack(winnow(this,e||[],!0))},is:function(e){return!!winnow(this,"string"==typeof e&&C.test(e)?g(e):e||[],!1).length}});var E,A=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]+))$/;(g.fn.init=function(e,t,n){var i,o;if(!e)return this;if(n=n||E,"string"==typeof e){if(!(i="<"===e[0]&&">"===e[e.length-1]&&e.length>=3?[null,e,null]:A.exec(e))||!i[1]&&t)return!t||t.jquery?(t||n).find(e):this.constructor(t).find(e);if(i[1]){if(t=t instanceof g?t[0]:t,g.merge(this,g.parseHTML(i[1],t&&t.nodeType?t.ownerDocument||t:r,!0)),S.test(i[1])&&g.isPlainObject(t))for(i in t)g.isFunction(this[i])?this[i](t[i]):this.attr(i,t[i]);return this}return(o=r.getElementById(i[2]))&&(this[0]=o,this.length=1),this}return e.nodeType?(this[0]=e,this.length=1,this):g.isFunction(e)?void 0!==n.ready?n.ready(e):e(g):g.makeArray(e,this)}).prototype=g.fn,E=g(r);var N=/^(?:parents|prev(?:Until|All))/,D={children:!0,contents:!0,next:!0,prev:!0};g.fn.extend({has:function(e){var t=g(e,this),n=t.length;return this.filter(function(){for(var e=0;e<n;e++)if(g.contains(this,t[e]))return!0})},closest:function(e,t){var n,r=0,i=this.length,o=[],a="string"!=typeof e&&g(e);if(!C.test(e))for(;r<i;r++)for(n=this[r];n&&n!==t;n=n.parentNode)if(n.nodeType<11&&(a?a.index(n)>-1:1===n.nodeType&&g.find.matchesSelector(n,e))){o.push(n);break}return this.pushStack(o.length>1?g.uniqueSort(o):o)},index:function(e){return e?"string"==typeof e?u.call(g(e),this[0]):u.call(this,e.jquery?e[0]:e):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(e,t){return this.pushStack(g.uniqueSort(g.merge(this.get(),g(e,t))))},addBack:function(e){return this.add(null==e?this.prevObject:this.prevObject.filter(e))}}),g.each({parent:function(e){var t=e.parentNode;return t&&11!==t.nodeType?t:null},parents:function(e){return w(e,"parentNode")},parentsUntil:function(e,t,n){return w(e,"parentNode",n)},next:function(e){return sibling(e,"nextSibling")},prev:function(e){return sibling(e,"previousSibling")},nextAll:function(e){return w(e,"nextSibling")},prevAll:function(e){return w(e,"previousSibling")},nextUntil:function(e,t,n){return w(e,"nextSibling",n)},prevUntil:function(e,t,n){return w(e,"previousSibling",n)},siblings:function(e){return T((e.parentNode||{}).firstChild,e)},children:function(e){return T(e.firstChild)},contents:function(e){return e.contentDocument||g.merge([],e.childNodes)}},function(e,t){g.fn[e]=function(n,r){var i=g.map(this,t,n);return"Until"!==e.slice(-5)&&(r=n),r&&"string"==typeof r&&(i=g.filter(r,i)),this.length>1&&(D[e]||g.uniqueSort(i),N.test(e)&&i.reverse()),this.pushStack(i)}});var j=/\S+/g;g.Callbacks=function(e){e="string"==typeof e?createOptions(e):g.extend({},e);var t,n,r,i,o=[],a=[],s=-1,u=function(){for(i=e.once,r=t=!0;a.length;s=-1)for(n=a.shift();++s<o.length;)!1===o[s].apply(n[0],n[1])&&e.stopOnFalse&&(s=o.length,n=!1);e.memory||(n=!1),t=!1,i&&(o=n?[]:"")},l={add:function(){return o&&(n&&!t&&(s=o.length-1,a.push(n)),function add(t){g.each(t,function(t,n){g.isFunction(n)?e.unique&&l.has(n)||o.push(n):n&&n.length&&"string"!==g.type(n)&&add(n)})}(arguments),n&&!t&&u()),this},remove:function(){return g.each(arguments,function(e,t){for(var n;(n=g.inArray(t,o,n))>-1;)o.splice(n,1),n<=s&&s--}),this},has:function(e){return e?g.inArray(e,o)>-1:o.length>0},empty:function(){return o&&(o=[]),this},disable:function(){return i=a=[],o=n="",this},disabled:function(){return!o},lock:function(){return i=a=[],n||t||(o=n=""),this},locked:function(){return!!i},fireWith:function(e,n){return i||(n=[e,(n=n||[]).slice?n.slice():n],a.push(n),t||u()),this},fire:function(){return l.fireWith(this,arguments),this},fired:function(){return!!r}};return l},g.extend({Deferred:function(t){var n=[["notify","progress",g.Callbacks("memory"),g.Callbacks("memory"),2],["resolve","done",g.Callbacks("once memory"),g.Callbacks("once memory"),0,"resolved"],["reject","fail",g.Callbacks("once memory"),g.Callbacks("once memory"),1,"rejected"]],r="pending",i={state:function(){return r},always:function(){return o.done(arguments).fail(arguments),this},catch:function(e){return i.then(null,e)},pipe:function(){var e=arguments;return g.Deferred(function(t){g.each(n,function(n,r){var i=g.isFunction(e[r[4]])&&e[r[4]];o[r[1]](function(){var e=i&&i.apply(this,arguments);e&&g.isFunction(e.promise)?e.promise().progress(t.notify).done(t.resolve).fail(t.reject):t[r[0]+"With"](this,i?[e]:arguments)})}),e=null}).promise()},then:function(t,r,i){function resolve(t,n,r,i){return function(){var a=this,s=arguments,u=function(){var e,u;if(!(t<o)){if((e=r.apply(a,s))===n.promise())throw new TypeError("Thenable self-resolution");u=e&&("object"==typeof e||"function"==typeof e)&&e.then,g.isFunction(u)?i?u.call(e,resolve(o,n,Identity,i),resolve(o,n,Thrower,i)):(o++,u.call(e,resolve(o,n,Identity,i),resolve(o,n,Thrower,i),resolve(o,n,Identity,n.notifyWith))):(r!==Identity&&(a=void 0,s=[e]),(i||n.resolveWith)(a,s))}},l=i?u:function(){try{u()}catch(e){g.Deferred.exceptionHook&&g.Deferred.exceptionHook(e,l.stackTrace),t+1>=o&&(r!==Thrower&&(a=void 0,s=[e]),n.rejectWith(a,s))}};t?l():(g.Deferred.getStackHook&&(l.stackTrace=g.Deferred.getStackHook()),e.setTimeout(l))}}var o=0;return g.Deferred(function(e){n[0][3].add(resolve(0,e,g.isFunction(i)?i:Identity,e.notifyWith)),n[1][3].add(resolve(0,e,g.isFunction(t)?t:Identity)),n[2][3].add(resolve(0,e,g.isFunction(r)?r:Thrower))}).promise()},promise:function(e){return null!=e?g.extend(e,i):i}},o={};return g.each(n,function(e,t){var a=t[2],s=t[5];i[t[1]]=a.add,s&&a.add(function(){r=s},n[3-e][2].disable,n[0][2].lock),a.add(t[3].fire),o[t[0]]=function(){return o[t[0]+"With"](this===o?void 0:this,arguments),this},o[t[0]+"With"]=a.fireWith}),i.promise(o),t&&t.call(o,o),o},when:function(e){var t=arguments.length,n=t,r=Array(n),i=o.call(arguments),a=g.Deferred(),s=function(e){return function(n){r[e]=this,i[e]=arguments.length>1?o.call(arguments):n,--t||a.resolveWith(r,i)}};if(t<=1&&(adoptValue(e,a.done(s(n)).resolve,a.reject),"pending"===a.state()||g.isFunction(i[n]&&i[n].then)))return a.then();for(;n--;)adoptValue(i[n],s(n),a.reject);return a.promise()}});var F=/^(Eval|Internal|Range|Reference|Syntax|Type|URI)Error$/;g.Deferred.exceptionHook=function(t,n){e.console&&e.console.warn&&t&&F.test(t.name)&&e.console.warn("jQuery.Deferred exception: "+t.message,t.stack,n)},g.readyException=function(t){e.setTimeout(function(){throw t})};var H=g.Deferred();g.fn.ready=function(e){return H.then(e).catch(function(e){g.readyException(e)}),this},g.extend({isReady:!1,readyWait:1,holdReady:function(e){e?g.readyWait++:g.ready(!0)},ready:function(e){(!0===e?--g.readyWait:g.isReady)||(g.isReady=!0,!0!==e&&--g.readyWait>0||H.resolveWith(r,[g]))}}),g.ready.then=H.then,"complete"===r.readyState||"loading"!==r.readyState&&!r.documentElement.doScroll?e.setTimeout(g.ready):(r.addEventListener("DOMContentLoaded",completed),e.addEventListener("load",completed));var q=function(e,t,n,r,i,o,a){var s=0,u=e.length,l=null==n;if("object"===g.type(n)){i=!0;for(s in n)q(e,t,s,n[s],!0,o,a)}else if(void 0!==r&&(i=!0,g.isFunction(r)||(a=!0),l&&(a?(t.call(e,r),t=null):(l=t,t=function(e,t,n){return l.call(g(e),n)})),t))for(;s<u;s++)t(e[s],n,a?r:r.call(e[s],s,t(e[s],n)));return i?e:l?t.call(e):u?t(e[0],n):o},L=function(e){return 1===e.nodeType||9===e.nodeType||!+e.nodeType};Data.uid=1,Data.prototype={cache:function(e){var t=e[this.expando];return t||(t={},L(e)&&(e.nodeType?e[this.expando]=t:Object.defineProperty(e,this.expando,{value:t,configurable:!0}))),t},set:function(e,t,n){var r,i=this.cache(e);if("string"==typeof t)i[g.camelCase(t)]=n;else for(r in t)i[g.camelCase(r)]=t[r];return i},get:function(e,t){return void 0===t?this.cache(e):e[this.expando]&&e[this.expando][g.camelCase(t)]},access:function(e,t,n){return void 0===t||t&&"string"==typeof t&&void 0===n?this.get(e,t):(this.set(e,t,n),void 0!==n?n:t)},remove:function(e,t){var n,r=e[this.expando];if(void 0!==r){if(void 0!==t){n=(t=g.isArray(t)?t.map(g.camelCase):(t=g.camelCase(t))in r?[t]:t.match(j)||[]).length;for(;n--;)delete r[t[n]]}(void 0===t||g.isEmptyObject(r))&&(e.nodeType?e[this.expando]=void 0:delete e[this.expando])}},hasData:function(e){var t=e[this.expando];return void 0!==t&&!g.isEmptyObject(t)}};var P=new Data,O=new Data,M=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,z=/[A-Z]/g;g.extend({hasData:function(e){return O.hasData(e)||P.hasData(e)},data:function(e,t,n){return O.access(e,t,n)},removeData:function(e,t){O.remove(e,t)},_data:function(e,t,n){return P.access(e,t,n)},_removeData:function(e,t){P.remove(e,t)}}),g.fn.extend({data:function(e,t){var n,r,i,o=this[0],a=o&&o.attributes;if(void 0===e){if(this.length&&(i=O.get(o),1===o.nodeType&&!P.get(o,"hasDataAttrs"))){for(n=a.length;n--;)a[n]&&0===(r=a[n].name).indexOf("data-")&&(r=g.camelCase(r.slice(5)),dataAttr(o,r,i[r]));P.set(o,"hasDataAttrs",!0)}return i}return"object"==typeof e?this.each(function(){O.set(this,e)}):q(this,function(t){var n;if(o&&void 0===t){if(void 0!==(n=O.get(o,e)))return n;if(void 0!==(n=dataAttr(o,e)))return n}else this.each(function(){O.set(this,e,t)})},null,t,arguments.length>1,null,!0)},removeData:function(e){return this.each(function(){O.remove(this,e)})}}),g.extend({queue:function(e,t,n){var r;if(e)return t=(t||"fx")+"queue",r=P.get(e,t),n&&(!r||g.isArray(n)?r=P.access(e,t,g.makeArray(n)):r.push(n)),r||[]},dequeue:function(e,t){t=t||"fx";var n=g.queue(e,t),r=n.length,i=n.shift(),o=g._queueHooks(e,t);"inprogress"===i&&(i=n.shift(),r--),i&&("fx"===t&&n.unshift("inprogress"),delete o.stop,i.call(e,function(){g.dequeue(e,t)},o)),!r&&o&&o.empty.fire()},_queueHooks:function(e,t){var n=t+"queueHooks";return P.get(e,n)||P.access(e,n,{empty:g.Callbacks("once memory").add(function(){P.remove(e,[t+"queue",n])})})}}),g.fn.extend({queue:function(e,t){var n=2;return"string"!=typeof e&&(t=e,e="fx",n--),arguments.length<n?g.queue(this[0],e):void 0===t?this:this.each(function(){var n=g.queue(this,e,t);g._queueHooks(this,e),"fx"===e&&"inprogress"!==n[0]&&g.dequeue(this,e)})},dequeue:function(e){return this.each(function(){g.dequeue(this,e)})},clearQueue:function(e){return this.queue(e||"fx",[])},promise:function(e,t){var n,r=1,i=g.Deferred(),o=this,a=this.length,s=function(){--r||i.resolveWith(o,[o])};for("string"!=typeof e&&(t=e,e=void 0),e=e||"fx";a--;)(n=P.get(o[a],e+"queueHooks"))&&n.empty&&(r++,n.empty.add(s));return s(),i.promise(t)}});var I=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,R=new RegExp("^(?:([+-])=|)("+I+")([a-z%]*)$","i"),W=["Top","Right","Bottom","Left"],$=function(e,t){return"none"===(e=t||e).style.display||""===e.style.display&&g.contains(e.ownerDocument,e)&&"none"===g.css(e,"display")},B=function(e,t,n,r){var i,o,a={};for(o in t)a[o]=e.style[o],e.style[o]=t[o];i=n.apply(e,r||[]);for(o in t)e.style[o]=a[o];return i},_={};g.fn.extend({show:function(){return showHide(this,!0)},hide:function(){return showHide(this)},toggle:function(e){return"boolean"==typeof e?e?this.show():this.hide():this.each(function(){$(this)?g(this).show():g(this).hide()})}});var X=/^(?:checkbox|radio)$/i,G=/<([a-z][^\/\0>\x20\t\r\n\f]+)/i,U=/^$|\/(?:java|ecma)script/i,V={option:[1,"<select multiple='multiple'>","</select>"],thead:[1,"<table>","</table>"],col:[2,"<table><colgroup>","</colgroup></table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[0,"",""]};V.optgroup=V.option,V.tbody=V.tfoot=V.colgroup=V.caption=V.thead,V.th=V.td;var Y=/<|&#?\w+;/;!function(){var e=r.createDocumentFragment().appendChild(r.createElement("div")),t=r.createElement("input");t.setAttribute("type","radio"),t.setAttribute("checked","checked"),t.setAttribute("name","t"),e.appendChild(t),h.checkClone=e.cloneNode(!0).cloneNode(!0).lastChild.checked,e.innerHTML="<textarea>x</textarea>",h.noCloneChecked=!!e.cloneNode(!0).lastChild.defaultValue}();var Q=r.documentElement,J=/^key/,K=/^(?:mouse|pointer|contextmenu|drag|drop)|click/,Z=/^([^.]*)(?:\.(.+)|)/;g.event={global:{},add:function(e,t,n,r,i){var o,a,s,u,l,c,f,d,p,h,m,v=P.get(e);if(v)for(n.handler&&(n=(o=n).handler,i=o.selector),i&&g.find.matchesSelector(Q,i),n.guid||(n.guid=g.guid++),(u=v.events)||(u=v.events={}),(a=v.handle)||(a=v.handle=function(t){return void 0!==g&&g.event.triggered!==t.type?g.event.dispatch.apply(e,arguments):void 0}),l=(t=(t||"").match(j)||[""]).length;l--;)p=m=(s=Z.exec(t[l])||[])[1],h=(s[2]||"").split(".").sort(),p&&(f=g.event.special[p]||{},p=(i?f.delegateType:f.bindType)||p,f=g.event.special[p]||{},c=g.extend({type:p,origType:m,data:r,handler:n,guid:n.guid,selector:i,needsContext:i&&g.expr.match.needsContext.test(i),namespace:h.join(".")},o),(d=u[p])||((d=u[p]=[]).delegateCount=0,f.setup&&!1!==f.setup.call(e,r,h,a)||e.addEventListener&&e.addEventListener(p,a)),f.add&&(f.add.call(e,c),c.handler.guid||(c.handler.guid=n.guid)),i?d.splice(d.delegateCount++,0,c):d.push(c),g.event.global[p]=!0)},remove:function(e,t,n,r,i){var o,a,s,u,l,c,f,d,p,h,m,v=P.hasData(e)&&P.get(e);if(v&&(u=v.events)){for(l=(t=(t||"").match(j)||[""]).length;l--;)if(s=Z.exec(t[l])||[],p=m=s[1],h=(s[2]||"").split(".").sort(),p){for(f=g.event.special[p]||{},d=u[p=(r?f.delegateType:f.bindType)||p]||[],s=s[2]&&new RegExp("(^|\\.)"+h.join("\\.(?:.*\\.|)")+"(\\.|$)"),a=o=d.length;o--;)c=d[o],!i&&m!==c.origType||n&&n.guid!==c.guid||s&&!s.test(c.namespace)||r&&r!==c.selector&&("**"!==r||!c.selector)||(d.splice(o,1),c.selector&&d.delegateCount--,f.remove&&f.remove.call(e,c));a&&!d.length&&(f.teardown&&!1!==f.teardown.call(e,h,v.handle)||g.removeEvent(e,p,v.handle),delete u[p])}else for(p in u)g.event.remove(e,p+t[l],n,r,!0);g.isEmptyObject(u)&&P.remove(e,"handle events")}},dispatch:function(e){var t,n,r,i,o,a,s=g.event.fix(e),u=new Array(arguments.length),l=(P.get(this,"events")||{})[s.type]||[],c=g.event.special[s.type]||{};for(u[0]=s,t=1;t<arguments.length;t++)u[t]=arguments[t];if(s.delegateTarget=this,!c.preDispatch||!1!==c.preDispatch.call(this,s)){for(a=g.event.handlers.call(this,s,l),t=0;(i=a[t++])&&!s.isPropagationStopped();)for(s.currentTarget=i.elem,n=0;(o=i.handlers[n++])&&!s.isImmediatePropagationStopped();)s.rnamespace&&!s.rnamespace.test(o.namespace)||(s.handleObj=o,s.data=o.data,void 0!==(r=((g.event.special[o.origType]||{}).handle||o.handler).apply(i.elem,u))&&!1===(s.result=r)&&(s.preventDefault(),s.stopPropagation()));return c.postDispatch&&c.postDispatch.call(this,s),s.result}},handlers:function(e,t){var n,r,i,o,a=[],s=t.delegateCount,u=e.target;if(s&&u.nodeType&&("click"!==e.type||isNaN(e.button)||e.button<1))for(;u!==this;u=u.parentNode||this)if(1===u.nodeType&&(!0!==u.disabled||"click"!==e.type)){for(r=[],n=0;n<s;n++)void 0===r[i=(o=t[n]).selector+" "]&&(r[i]=o.needsContext?g(i,this).index(u)>-1:g.find(i,this,null,[u]).length),r[i]&&r.push(o);r.length&&a.push({elem:u,handlers:r})}return s<t.length&&a.push({elem:this,handlers:t.slice(s)}),a},addProp:function(e,t){Object.defineProperty(g.Event.prototype,e,{enumerable:!0,configurable:!0,get:g.isFunction(t)?function(){if(this.originalEvent)return t(this.originalEvent)}:function(){if(this.originalEvent)return this.originalEvent[e]},set:function(t){Object.defineProperty(this,e,{enumerable:!0,configurable:!0,writable:!0,value:t})}})},fix:function(e){return e[g.expando]?e:new g.Event(e)},special:{load:{noBubble:!0},focus:{trigger:function(){if(this!==safeActiveElement()&&this.focus)return this.focus(),!1},delegateType:"focusin"},blur:{trigger:function(){if(this===safeActiveElement()&&this.blur)return this.blur(),!1},delegateType:"focusout"},click:{trigger:function(){if("checkbox"===this.type&&this.click&&g.nodeName(this,"input"))return this.click(),!1},_default:function(e){return g.nodeName(e.target,"a")}},beforeunload:{postDispatch:function(e){void 0!==e.result&&e.originalEvent&&(e.originalEvent.returnValue=e.result)}}}},g.removeEvent=function(e,t,n){e.removeEventListener&&e.removeEventListener(t,n)},g.Event=function(e,t){if(!(this instanceof g.Event))return new g.Event(e,t);e&&e.type?(this.originalEvent=e,this.type=e.type,this.isDefaultPrevented=e.defaultPrevented||void 0===e.defaultPrevented&&!1===e.returnValue?returnTrue:returnFalse,this.target=e.target&&3===e.target.nodeType?e.target.parentNode:e.target,this.currentTarget=e.currentTarget,this.relatedTarget=e.relatedTarget):this.type=e,t&&g.extend(this,t),this.timeStamp=e&&e.timeStamp||g.now(),this[g.expando]=!0},g.Event.prototype={constructor:g.Event,isDefaultPrevented:returnFalse,isPropagationStopped:returnFalse,isImmediatePropagationStopped:returnFalse,isSimulated:!1,preventDefault:function(){var e=this.originalEvent;this.isDefaultPrevented=returnTrue,e&&!this.isSimulated&&e.preventDefault()},stopPropagation:function(){var e=this.originalEvent;this.isPropagationStopped=returnTrue,e&&!this.isSimulated&&e.stopPropagation()},stopImmediatePropagation:function(){var e=this.originalEvent;this.isImmediatePropagationStopped=returnTrue,e&&!this.isSimulated&&e.stopImmediatePropagation(),this.stopPropagation()}},g.each({altKey:!0,bubbles:!0,cancelable:!0,changedTouches:!0,ctrlKey:!0,detail:!0,eventPhase:!0,metaKey:!0,pageX:!0,pageY:!0,shiftKey:!0,view:!0,char:!0,charCode:!0,key:!0,keyCode:!0,button:!0,buttons:!0,clientX:!0,clientY:!0,offsetX:!0,offsetY:!0,pointerId:!0,pointerType:!0,screenX:!0,screenY:!0,targetTouches:!0,toElement:!0,touches:!0,which:function(e){var t=e.button;return null==e.which&&J.test(e.type)?null!=e.charCode?e.charCode:e.keyCode:!e.which&&void 0!==t&&K.test(e.type)?1&t?1:2&t?3:4&t?2:0:e.which}},g.event.addProp),g.each({mouseenter:"mouseover",mouseleave:"mouseout",pointerenter:"pointerover",pointerleave:"pointerout"},function(e,t){g.event.special[e]={delegateType:t,bindType:t,handle:function(e){var n,r=this,i=e.relatedTarget,o=e.handleObj;return i&&(i===r||g.contains(r,i))||(e.type=o.origType,n=o.handler.apply(this,arguments),e.type=t),n}}}),g.fn.extend({on:function(e,t,n,r){return on(this,e,t,n,r)},one:function(e,t,n,r){return on(this,e,t,n,r,1)},off:function(e,t,n){var r,i;if(e&&e.preventDefault&&e.handleObj)return r=e.handleObj,g(e.delegateTarget).off(r.namespace?r.origType+"."+r.namespace:r.origType,r.selector,r.handler),this;if("object"==typeof e){for(i in e)this.off(i,t,e[i]);return this}return!1!==t&&"function"!=typeof t||(n=t,t=void 0),!1===n&&(n=returnFalse),this.each(function(){g.event.remove(this,e,n,t)})}});var ee=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([a-z][^\/\0>\x20\t\r\n\f]*)[^>]*)\/>/gi,te=/<script|<style|<link/i,ne=/checked\s*(?:[^=]|=\s*.checked.)/i,re=/^true\/(.*)/,ie=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g;g.extend({htmlPrefilter:function(e){return e.replace(ee,"<$1></$2>")},clone:function(e,t,n){var r,i,o,a,s=e.cloneNode(!0),u=g.contains(e.ownerDocument,e);if(!(h.noCloneChecked||1!==e.nodeType&&11!==e.nodeType||g.isXMLDoc(e)))for(a=getAll(s),r=0,i=(o=getAll(e)).length;r<i;r++)fixInput(o[r],a[r]);if(t)if(n)for(o=o||getAll(e),a=a||getAll(s),r=0,i=o.length;r<i;r++)cloneCopyEvent(o[r],a[r]);else cloneCopyEvent(e,s);return(a=getAll(s,"script")).length>0&&setGlobalEval(a,!u&&getAll(e,"script")),s},cleanData:function(e){for(var t,n,r,i=g.event.special,o=0;void 0!==(n=e[o]);o++)if(L(n)){if(t=n[P.expando]){if(t.events)for(r in t.events)i[r]?g.event.remove(n,r):g.removeEvent(n,r,t.handle);n[P.expando]=void 0}n[O.expando]&&(n[O.expando]=void 0)}}}),g.fn.extend({detach:function(e){return remove(this,e,!0)},remove:function(e){return remove(this,e)},text:function(e){return q(this,function(e){return void 0===e?g.text(this):this.empty().each(function(){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||(this.textContent=e)})},null,e,arguments.length)},append:function(){return domManip(this,arguments,function(e){1!==this.nodeType&&11!==this.nodeType&&9!==this.nodeType||manipulationTarget(this,e).appendChild(e)})},prepend:function(){return domManip(this,arguments,function(e){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var t=manipulationTarget(this,e);t.insertBefore(e,t.firstChild)}})},before:function(){return domManip(this,arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this)})},after:function(){return domManip(this,arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this.nextSibling)})},empty:function(){for(var e,t=0;null!=(e=this[t]);t++)1===e.nodeType&&(g.cleanData(getAll(e,!1)),e.textContent="");return this},clone:function(e,t){return e=null!=e&&e,t=null==t?e:t,this.map(function(){return g.clone(this,e,t)})},html:function(e){return q(this,function(e){var t=this[0]||{},n=0,r=this.length;if(void 0===e&&1===t.nodeType)return t.innerHTML;if("string"==typeof e&&!te.test(e)&&!V[(G.exec(e)||["",""])[1].toLowerCase()]){e=g.htmlPrefilter(e);try{for(;n<r;n++)1===(t=this[n]||{}).nodeType&&(g.cleanData(getAll(t,!1)),t.innerHTML=e);t=0}catch(e){}}t&&this.empty().append(e)},null,e,arguments.length)},replaceWith:function(){var e=[];return domManip(this,arguments,function(t){var n=this.parentNode;g.inArray(this,e)<0&&(g.cleanData(getAll(this)),n&&n.replaceChild(t,this))},e)}}),g.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(e,t){g.fn[e]=function(e){for(var n,r=[],i=g(e),o=i.length-1,a=0;a<=o;a++)n=a===o?this:this.clone(!0),g(i[a])[t](n),s.apply(r,n.get());return this.pushStack(r)}});var oe=/^margin/,ae=new RegExp("^("+I+")(?!px)[a-z%]+$","i"),se=function(t){var n=t.ownerDocument.defaultView;return n&&n.opener||(n=e),n.getComputedStyle(t)};!function(){function computeStyleTests(){if(s){s.style.cssText="box-sizing:border-box;position:relative;display:block;margin:auto;border:1px;padding:1px;top:1%;width:50%",s.innerHTML="",Q.appendChild(a);var r=e.getComputedStyle(s);t="1%"!==r.top,o="2px"===r.marginLeft,n="4px"===r.width,s.style.marginRight="50%",i="4px"===r.marginRight,Q.removeChild(a),s=null}}var t,n,i,o,a=r.createElement("div"),s=r.createElement("div");s.style&&(s.style.backgroundClip="content-box",s.cloneNode(!0).style.backgroundClip="",h.clearCloneStyle="content-box"===s.style.backgroundClip,a.style.cssText="border:0;width:8px;height:0;top:0;left:-9999px;padding:0;margin-top:1px;position:absolute",a.appendChild(s),g.extend(h,{pixelPosition:function(){return computeStyleTests(),t},boxSizingReliable:function(){return computeStyleTests(),n},pixelMarginRight:function(){return computeStyleTests(),i},reliableMarginLeft:function(){return computeStyleTests(),o}}))}();var ue=/^(none|table(?!-c[ea]).+)/,le={position:"absolute",visibility:"hidden",display:"block"},ce={letterSpacing:"0",fontWeight:"400"},fe=["Webkit","Moz","ms"],de=r.createElement("div").style;g.extend({cssHooks:{opacity:{get:function(e,t){if(t){var n=curCSS(e,"opacity");return""===n?"1":n}}}},cssNumber:{animationIterationCount:!0,columnCount:!0,fillOpacity:!0,flexGrow:!0,flexShrink:!0,fontWeight:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{float:"cssFloat"},style:function(e,t,n,r){if(e&&3!==e.nodeType&&8!==e.nodeType&&e.style){var i,o,a,s=g.camelCase(t),u=e.style;if(t=g.cssProps[s]||(g.cssProps[s]=vendorPropName(s)||s),a=g.cssHooks[t]||g.cssHooks[s],void 0===n)return a&&"get"in a&&void 0!==(i=a.get(e,!1,r))?i:u[t];"string"==(o=typeof n)&&(i=R.exec(n))&&i[1]&&(n=adjustCSS(e,t,i),o="number"),null!=n&&n===n&&("number"===o&&(n+=i&&i[3]||(g.cssNumber[s]?"":"px")),h.clearCloneStyle||""!==n||0!==t.indexOf("background")||(u[t]="inherit"),a&&"set"in a&&void 0===(n=a.set(e,n,r))||(u[t]=n))}},css:function(e,t,n,r){var i,o,a,s=g.camelCase(t);return t=g.cssProps[s]||(g.cssProps[s]=vendorPropName(s)||s),(a=g.cssHooks[t]||g.cssHooks[s])&&"get"in a&&(i=a.get(e,!0,n)),void 0===i&&(i=curCSS(e,t,r)),"normal"===i&&t in ce&&(i=ce[t]),""===n||n?(o=parseFloat(i),!0===n||isFinite(o)?o||0:i):i}}),g.each(["height","width"],function(e,t){g.cssHooks[t]={get:function(e,n,r){if(n)return!ue.test(g.css(e,"display"))||e.getClientRects().length&&e.getBoundingClientRect().width?getWidthOrHeight(e,t,r):B(e,le,function(){return getWidthOrHeight(e,t,r)})},set:function(e,n,r){var i,o=r&&se(e),a=r&&augmentWidthOrHeight(e,t,r,"border-box"===g.css(e,"boxSizing",!1,o),o);return a&&(i=R.exec(n))&&"px"!==(i[3]||"px")&&(e.style[t]=n,n=g.css(e,t)),setPositiveNumber(0,n,a)}}}),g.cssHooks.marginLeft=addGetHookIf(h.reliableMarginLeft,function(e,t){if(t)return(parseFloat(curCSS(e,"marginLeft"))||e.getBoundingClientRect().left-B(e,{marginLeft:0},function(){return e.getBoundingClientRect().left}))+"px"}),g.each({margin:"",padding:"",border:"Width"},function(e,t){g.cssHooks[e+t]={expand:function(n){for(var r=0,i={},o="string"==typeof n?n.split(" "):[n];r<4;r++)i[e+W[r]+t]=o[r]||o[r-2]||o[0];return i}},oe.test(e)||(g.cssHooks[e+t].set=setPositiveNumber)}),g.fn.extend({css:function(e,t){return q(this,function(e,t,n){var r,i,o={},a=0;if(g.isArray(t)){for(r=se(e),i=t.length;a<i;a++)o[t[a]]=g.css(e,t[a],!1,r);return o}return void 0!==n?g.style(e,t,n):g.css(e,t)},e,t,arguments.length>1)}}),g.Tween=Tween,Tween.prototype={constructor:Tween,init:function(e,t,n,r,i,o){this.elem=e,this.prop=n,this.easing=i||g.easing._default,this.options=t,this.start=this.now=this.cur(),this.end=r,this.unit=o||(g.cssNumber[n]?"":"px")},cur:function(){var e=Tween.propHooks[this.prop];return e&&e.get?e.get(this):Tween.propHooks._default.get(this)},run:function(e){var t,n=Tween.propHooks[this.prop];return this.options.duration?this.pos=t=g.easing[this.easing](e,this.options.duration*e,0,1,this.options.duration):this.pos=t=e,this.now=(this.end-this.start)*t+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),n&&n.set?n.set(this):Tween.propHooks._default.set(this),this}},Tween.prototype.init.prototype=Tween.prototype,Tween.propHooks={_default:{get:function(e){var t;return 1!==e.elem.nodeType||null!=e.elem[e.prop]&&null==e.elem.style[e.prop]?e.elem[e.prop]:(t=g.css(e.elem,e.prop,""))&&"auto"!==t?t:0},set:function(e){g.fx.step[e.prop]?g.fx.step[e.prop](e):1!==e.elem.nodeType||null==e.elem.style[g.cssProps[e.prop]]&&!g.cssHooks[e.prop]?e.elem[e.prop]=e.now:g.style(e.elem,e.prop,e.now+e.unit)}}},Tween.propHooks.scrollTop=Tween.propHooks.scrollLeft={set:function(e){e.elem.nodeType&&e.elem.parentNode&&(e.elem[e.prop]=e.now)}},g.easing={linear:function(e){return e},swing:function(e){return.5-Math.cos(e*Math.PI)/2},_default:"swing"},g.fx=Tween.prototype.init,g.fx.step={};var pe,he,ge=/^(?:toggle|show|hide)$/,me=/queueHooks$/;g.Animation=g.extend(Animation,{tweeners:{"*":[function(e,t){var n=this.createTween(e,t);return adjustCSS(n.elem,e,R.exec(t),n),n}]},tweener:function(e,t){g.isFunction(e)?(t=e,e=["*"]):e=e.match(j);for(var n,r=0,i=e.length;r<i;r++)n=e[r],Animation.tweeners[n]=Animation.tweeners[n]||[],Animation.tweeners[n].unshift(t)},prefilters:[function defaultPrefilter(e,t,n){var r,i,o,a,s,u,l,c,f="width"in t||"height"in t,d=this,p={},h=e.style,m=e.nodeType&&$(e),v=P.get(e,"fxshow");n.queue||(null==(a=g._queueHooks(e,"fx")).unqueued&&(a.unqueued=0,s=a.empty.fire,a.empty.fire=function(){a.unqueued||s()}),a.unqueued++,d.always(function(){d.always(function(){a.unqueued--,g.queue(e,"fx").length||a.empty.fire()})}));for(r in t)if(i=t[r],ge.test(i)){if(delete t[r],o=o||"toggle"===i,i===(m?"hide":"show")){if("show"!==i||!v||void 0===v[r])continue;m=!0}p[r]=v&&v[r]||g.style(e,r)}if((u=!g.isEmptyObject(t))||!g.isEmptyObject(p)){f&&1===e.nodeType&&(n.overflow=[h.overflow,h.overflowX,h.overflowY],null==(l=v&&v.display)&&(l=P.get(e,"display")),"none"===(c=g.css(e,"display"))&&(l?c=l:(showHide([e],!0),l=e.style.display||l,c=g.css(e,"display"),showHide([e]))),("inline"===c||"inline-block"===c&&null!=l)&&"none"===g.css(e,"float")&&(u||(d.done(function(){h.display=l}),null==l&&(c=h.display,l="none"===c?"":c)),h.display="inline-block")),n.overflow&&(h.overflow="hidden",d.always(function(){h.overflow=n.overflow[0],h.overflowX=n.overflow[1],h.overflowY=n.overflow[2]})),u=!1;for(r in p)u||(v?"hidden"in v&&(m=v.hidden):v=P.access(e,"fxshow",{display:l}),o&&(v.hidden=!m),m&&showHide([e],!0),d.done(function(){m||showHide([e]),P.remove(e,"fxshow");for(r in p)g.style(e,r,p[r])})),u=createTween(m?v[r]:0,r,d),r in v||(v[r]=u.start,m&&(u.end=u.start,u.start=0))}}],prefilter:function(e,t){t?Animation.prefilters.unshift(e):Animation.prefilters.push(e)}}),g.speed=function(e,t,n){var i=e&&"object"==typeof e?g.extend({},e):{complete:n||!n&&t||g.isFunction(e)&&e,duration:e,easing:n&&t||t&&!g.isFunction(t)&&t};return g.fx.off||r.hidden?i.duration=0:i.duration="number"==typeof i.duration?i.duration:i.duration in g.fx.speeds?g.fx.speeds[i.duration]:g.fx.speeds._default,null!=i.queue&&!0!==i.queue||(i.queue="fx"),i.old=i.complete,i.complete=function(){g.isFunction(i.old)&&i.old.call(this),i.queue&&g.dequeue(this,i.queue)},i},g.fn.extend({fadeTo:function(e,t,n,r){return this.filter($).css("opacity",0).show().end().animate({opacity:t},e,n,r)},animate:function(e,t,n,r){var i=g.isEmptyObject(e),o=g.speed(t,n,r),a=function(){var t=Animation(this,g.extend({},e),o);(i||P.get(this,"finish"))&&t.stop(!0)};return a.finish=a,i||!1===o.queue?this.each(a):this.queue(o.queue,a)},stop:function(e,t,n){var r=function(e){var t=e.stop;delete e.stop,t(n)};return"string"!=typeof e&&(n=t,t=e,e=void 0),t&&!1!==e&&this.queue(e||"fx",[]),this.each(function(){var t=!0,i=null!=e&&e+"queueHooks",o=g.timers,a=P.get(this);if(i)a[i]&&a[i].stop&&r(a[i]);else for(i in a)a[i]&&a[i].stop&&me.test(i)&&r(a[i]);for(i=o.length;i--;)o[i].elem!==this||null!=e&&o[i].queue!==e||(o[i].anim.stop(n),t=!1,o.splice(i,1));!t&&n||g.dequeue(this,e)})},finish:function(e){return!1!==e&&(e=e||"fx"),this.each(function(){var t,n=P.get(this),r=n[e+"queue"],i=n[e+"queueHooks"],o=g.timers,a=r?r.length:0;for(n.finish=!0,g.queue(this,e,[]),i&&i.stop&&i.stop.call(this,!0),t=o.length;t--;)o[t].elem===this&&o[t].queue===e&&(o[t].anim.stop(!0),o.splice(t,1));for(t=0;t<a;t++)r[t]&&r[t].finish&&r[t].finish.call(this);delete n.finish})}}),g.each(["toggle","show","hide"],function(e,t){var n=g.fn[t];g.fn[t]=function(e,r,i){return null==e||"boolean"==typeof e?n.apply(this,arguments):this.animate(genFx(t,!0),e,r,i)}}),g.each({slideDown:genFx("show"),slideUp:genFx("hide"),slideToggle:genFx("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(e,t){g.fn[e]=function(e,n,r){return this.animate(t,e,n,r)}}),g.timers=[],g.fx.tick=function(){var e,t=0,n=g.timers;for(pe=g.now();t<n.length;t++)(e=n[t])()||n[t]!==e||n.splice(t--,1);n.length||g.fx.stop(),pe=void 0},g.fx.timer=function(e){g.timers.push(e),e()?g.fx.start():g.timers.pop()},g.fx.interval=13,g.fx.start=function(){he||(he=e.requestAnimationFrame?e.requestAnimationFrame(raf):e.setInterval(g.fx.tick,g.fx.interval))},g.fx.stop=function(){e.cancelAnimationFrame?e.cancelAnimationFrame(he):e.clearInterval(he),he=null},g.fx.speeds={slow:600,fast:200,_default:400},g.fn.delay=function(t,n){return t=g.fx?g.fx.speeds[t]||t:t,n=n||"fx",this.queue(n,function(n,r){var i=e.setTimeout(n,t);r.stop=function(){e.clearTimeout(i)}})},function(){var e=r.createElement("input"),t=r.createElement("select").appendChild(r.createElement("option"));e.type="checkbox",h.checkOn=""!==e.value,h.optSelected=t.selected,(e=r.createElement("input")).value="t",e.type="radio",h.radioValue="t"===e.value}();var ve,ye=g.expr.attrHandle;g.fn.extend({attr:function(e,t){return q(this,g.attr,e,t,arguments.length>1)},removeAttr:function(e){return this.each(function(){g.removeAttr(this,e)})}}),g.extend({attr:function(e,t,n){var r,i,o=e.nodeType;if(3!==o&&8!==o&&2!==o)return void 0===e.getAttribute?g.prop(e,t,n):(1===o&&g.isXMLDoc(e)||(i=g.attrHooks[t.toLowerCase()]||(g.expr.match.bool.test(t)?ve:void 0)),void 0!==n?null===n?void g.removeAttr(e,t):i&&"set"in i&&void 0!==(r=i.set(e,n,t))?r:(e.setAttribute(t,n+""),n):i&&"get"in i&&null!==(r=i.get(e,t))?r:null==(r=g.find.attr(e,t))?void 0:r)},attrHooks:{type:{set:function(e,t){if(!h.radioValue&&"radio"===t&&g.nodeName(e,"input")){var n=e.value;return e.setAttribute("type",t),n&&(e.value=n),t}}}},removeAttr:function(e,t){var n,r=0,i=t&&t.match(j);if(i&&1===e.nodeType)for(;n=i[r++];)e.removeAttribute(n)}}),ve={set:function(e,t,n){return!1===t?g.removeAttr(e,n):e.setAttribute(n,n),n}},g.each(g.expr.match.bool.source.match(/\w+/g),function(e,t){var n=ye[t]||g.find.attr;ye[t]=function(e,t,r){var i,o,a=t.toLowerCase();return r||(o=ye[a],ye[a]=i,i=null!=n(e,t,r)?a:null,ye[a]=o),i}});var xe=/^(?:input|select|textarea|button)$/i,be=/^(?:a|area)$/i;g.fn.extend({prop:function(e,t){return q(this,g.prop,e,t,arguments.length>1)},removeProp:function(e){return this.each(function(){delete this[g.propFix[e]||e]})}}),g.extend({prop:function(e,t,n){var r,i,o=e.nodeType;if(3!==o&&8!==o&&2!==o)return 1===o&&g.isXMLDoc(e)||(t=g.propFix[t]||t,i=g.propHooks[t]),void 0!==n?i&&"set"in i&&void 0!==(r=i.set(e,n,t))?r:e[t]=n:i&&"get"in i&&null!==(r=i.get(e,t))?r:e[t]},propHooks:{tabIndex:{get:function(e){var t=g.find.attr(e,"tabindex");return t?parseInt(t,10):xe.test(e.nodeName)||be.test(e.nodeName)&&e.href?0:-1}}},propFix:{for:"htmlFor",class:"className"}}),h.optSelected||(g.propHooks.selected={get:function(e){var t=e.parentNode;return t&&t.parentNode&&t.parentNode.selectedIndex,null},set:function(e){var t=e.parentNode;t&&(t.selectedIndex,t.parentNode&&t.parentNode.selectedIndex)}}),g.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){g.propFix[this.toLowerCase()]=this});var we=/[\t\r\n\f]/g;g.fn.extend({addClass:function(e){var t,n,r,i,o,a,s,u=0;if(g.isFunction(e))return this.each(function(t){g(this).addClass(e.call(this,t,getClass(this)))});if("string"==typeof e&&e)for(t=e.match(j)||[];n=this[u++];)if(i=getClass(n),r=1===n.nodeType&&(" "+i+" ").replace(we," ")){for(a=0;o=t[a++];)r.indexOf(" "+o+" ")<0&&(r+=o+" ");i!==(s=g.trim(r))&&n.setAttribute("class",s)}return this},removeClass:function(e){var t,n,r,i,o,a,s,u=0;if(g.isFunction(e))return this.each(function(t){g(this).removeClass(e.call(this,t,getClass(this)))});if(!arguments.length)return this.attr("class","");if("string"==typeof e&&e)for(t=e.match(j)||[];n=this[u++];)if(i=getClass(n),r=1===n.nodeType&&(" "+i+" ").replace(we," ")){for(a=0;o=t[a++];)for(;r.indexOf(" "+o+" ")>-1;)r=r.replace(" "+o+" "," ");i!==(s=g.trim(r))&&n.setAttribute("class",s)}return this},toggleClass:function(e,t){var n=typeof e;return"boolean"==typeof t&&"string"===n?t?this.addClass(e):this.removeClass(e):g.isFunction(e)?this.each(function(n){g(this).toggleClass(e.call(this,n,getClass(this),t),t)}):this.each(function(){var t,r,i,o;if("string"===n)for(r=0,i=g(this),o=e.match(j)||[];t=o[r++];)i.hasClass(t)?i.removeClass(t):i.addClass(t);else void 0!==e&&"boolean"!==n||((t=getClass(this))&&P.set(this,"__className__",t),this.setAttribute&&this.setAttribute("class",t||!1===e?"":P.get(this,"__className__")||""))})},hasClass:function(e){var t,n,r=0;for(t=" "+e+" ";n=this[r++];)if(1===n.nodeType&&(" "+getClass(n)+" ").replace(we," ").indexOf(t)>-1)return!0;return!1}});var Te=/\r/g,Ce=/[\x20\t\r\n\f]+/g;g.fn.extend({val:function(e){var t,n,r,i=this[0];{if(arguments.length)return r=g.isFunction(e),this.each(function(n){var i;1===this.nodeType&&(null==(i=r?e.call(this,n,g(this).val()):e)?i="":"number"==typeof i?i+="":g.isArray(i)&&(i=g.map(i,function(e){return null==e?"":e+""})),(t=g.valHooks[this.type]||g.valHooks[this.nodeName.toLowerCase()])&&"set"in t&&void 0!==t.set(this,i,"value")||(this.value=i))});if(i)return(t=g.valHooks[i.type]||g.valHooks[i.nodeName.toLowerCase()])&&"get"in t&&void 0!==(n=t.get(i,"value"))?n:"string"==typeof(n=i.value)?n.replace(Te,""):null==n?"":n}}}),g.extend({valHooks:{option:{get:function(e){var t=g.find.attr(e,"value");return null!=t?t:g.trim(g.text(e)).replace(Ce," ")}},select:{get:function(e){for(var t,n,r=e.options,i=e.selectedIndex,o="select-one"===e.type,a=o?null:[],s=o?i+1:r.length,u=i<0?s:o?i:0;u<s;u++)if(((n=r[u]).selected||u===i)&&!n.disabled&&(!n.parentNode.disabled||!g.nodeName(n.parentNode,"optgroup"))){if(t=g(n).val(),o)return t;a.push(t)}return a},set:function(e,t){for(var n,r,i=e.options,o=g.makeArray(t),a=i.length;a--;)((r=i[a]).selected=g.inArray(g.valHooks.option.get(r),o)>-1)&&(n=!0);return n||(e.selectedIndex=-1),o}}}}),g.each(["radio","checkbox"],function(){g.valHooks[this]={set:function(e,t){if(g.isArray(t))return e.checked=g.inArray(g(e).val(),t)>-1}},h.checkOn||(g.valHooks[this].get=function(e){return null===e.getAttribute("value")?"on":e.value})});var Se=/^(?:focusinfocus|focusoutblur)$/;g.extend(g.event,{trigger:function(t,n,i,o){var a,s,u,l,c,d,p,h=[i||r],m=f.call(t,"type")?t.type:t,v=f.call(t,"namespace")?t.namespace.split("."):[];if(s=u=i=i||r,3!==i.nodeType&&8!==i.nodeType&&!Se.test(m+g.event.triggered)&&(m.indexOf(".")>-1&&(m=(v=m.split(".")).shift(),v.sort()),c=m.indexOf(":")<0&&"on"+m,t=t[g.expando]?t:new g.Event(m,"object"==typeof t&&t),t.isTrigger=o?2:3,t.namespace=v.join("."),t.rnamespace=t.namespace?new RegExp("(^|\\.)"+v.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,t.result=void 0,t.target||(t.target=i),n=null==n?[t]:g.makeArray(n,[t]),p=g.event.special[m]||{},o||!p.trigger||!1!==p.trigger.apply(i,n))){if(!o&&!p.noBubble&&!g.isWindow(i)){for(l=p.delegateType||m,Se.test(l+m)||(s=s.parentNode);s;s=s.parentNode)h.push(s),u=s;u===(i.ownerDocument||r)&&h.push(u.defaultView||u.parentWindow||e)}for(a=0;(s=h[a++])&&!t.isPropagationStopped();)t.type=a>1?l:p.bindType||m,(d=(P.get(s,"events")||{})[t.type]&&P.get(s,"handle"))&&d.apply(s,n),(d=c&&s[c])&&d.apply&&L(s)&&(t.result=d.apply(s,n),!1===t.result&&t.preventDefault());return t.type=m,o||t.isDefaultPrevented()||p._default&&!1!==p._default.apply(h.pop(),n)||!L(i)||c&&g.isFunction(i[m])&&!g.isWindow(i)&&((u=i[c])&&(i[c]=null),g.event.triggered=m,i[m](),g.event.triggered=void 0,u&&(i[c]=u)),t.result}},simulate:function(e,t,n){var r=g.extend(new g.Event,n,{type:e,isSimulated:!0});g.event.trigger(r,null,t)}}),g.fn.extend({trigger:function(e,t){return this.each(function(){g.event.trigger(e,t,this)})},triggerHandler:function(e,t){var n=this[0];if(n)return g.event.trigger(e,t,n,!0)}}),g.each("blur focus focusin focusout resize scroll click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup contextmenu".split(" "),function(e,t){g.fn[t]=function(e,n){return arguments.length>0?this.on(t,null,e,n):this.trigger(t)}}),g.fn.extend({hover:function(e,t){return this.mouseenter(e).mouseleave(t||e)}}),h.focusin="onfocusin"in e,h.focusin||g.each({focus:"focusin",blur:"focusout"},function(e,t){var n=function(e){g.event.simulate(t,e.target,g.event.fix(e))};g.event.special[t]={setup:function(){var r=this.ownerDocument||this,i=P.access(r,t);i||r.addEventListener(e,n,!0),P.access(r,t,(i||0)+1)},teardown:function(){var r=this.ownerDocument||this,i=P.access(r,t)-1;i?P.access(r,t,i):(r.removeEventListener(e,n,!0),P.remove(r,t))}}});var ke=e.location,Ee=g.now(),Ae=/\?/;g.parseXML=function(t){var n;if(!t||"string"!=typeof t)return null;try{n=(new e.DOMParser).parseFromString(t,"text/xml")}catch(e){n=void 0}return n&&!n.getElementsByTagName("parsererror").length||g.error("Invalid XML: "+t),n};var Ne=/\[\]$/,De=/\r?\n/g,je=/^(?:submit|button|image|reset|file)$/i,Fe=/^(?:input|select|textarea|keygen)/i;g.param=function(e,t){var n,r=[],i=function(e,t){var n=g.isFunction(t)?t():t;r[r.length]=encodeURIComponent(e)+"="+encodeURIComponent(null==n?"":n)};if(g.isArray(e)||e.jquery&&!g.isPlainObject(e))g.each(e,function(){i(this.name,this.value)});else for(n in e)buildParams(n,e[n],t,i);return r.join("&")},g.fn.extend({serialize:function(){return g.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var e=g.prop(this,"elements");return e?g.makeArray(e):this}).filter(function(){var e=this.type;return this.name&&!g(this).is(":disabled")&&Fe.test(this.nodeName)&&!je.test(e)&&(this.checked||!X.test(e))}).map(function(e,t){var n=g(this).val();return null==n?null:g.isArray(n)?g.map(n,function(e){return{name:t.name,value:e.replace(De,"\r\n")}}):{name:t.name,value:n.replace(De,"\r\n")}}).get()}});var He=/%20/g,qe=/#.*$/,Le=/([?&])_=[^&]*/,Pe=/^(.*?):[ \t]*([^\r\n]*)$/gm,Oe=/^(?:about|app|app-storage|.+-extension|file|res|widget):$/,Me=/^(?:GET|HEAD)$/,ze=/^\/\//,Ie={},Re={},We="*/".concat("*"),$e=r.createElement("a");$e.href=ke.href,g.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:ke.href,type:"GET",isLocal:Oe.test(ke.protocol),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":We,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/\bxml\b/,html:/\bhtml/,json:/\bjson\b/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":JSON.parse,"text xml":g.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(e,t){return t?ajaxExtend(ajaxExtend(e,g.ajaxSettings),t):ajaxExtend(g.ajaxSettings,e)},ajaxPrefilter:addToPrefiltersOrTransports(Ie),ajaxTransport:addToPrefiltersOrTransports(Re),ajax:function(t,n){function done(t,n,r,s){var l,d,p,w,T,C=n;c||(c=!0,u&&e.clearTimeout(u),i=void 0,a=s||"",S.readyState=t>0?4:0,l=t>=200&&t<300||304===t,r&&(w=ajaxHandleResponses(h,S,r)),w=ajaxConvert(h,w,S,l),l?(h.ifModified&&((T=S.getResponseHeader("Last-Modified"))&&(g.lastModified[o]=T),(T=S.getResponseHeader("etag"))&&(g.etag[o]=T)),204===t||"HEAD"===h.type?C="nocontent":304===t?C="notmodified":(C=w.state,d=w.data,l=!(p=w.error))):(p=C,!t&&C||(C="error",t<0&&(t=0))),S.status=t,S.statusText=(n||C)+"",l?y.resolveWith(m,[d,C,S]):y.rejectWith(m,[S,C,p]),S.statusCode(b),b=void 0,f&&v.trigger(l?"ajaxSuccess":"ajaxError",[S,h,l?d:p]),x.fireWith(m,[S,C]),f&&(v.trigger("ajaxComplete",[S,h]),--g.active||g.event.trigger("ajaxStop")))}"object"==typeof t&&(n=t,t=void 0),n=n||{};var i,o,a,s,u,l,c,f,d,p,h=g.ajaxSetup({},n),m=h.context||h,v=h.context&&(m.nodeType||m.jquery)?g(m):g.event,y=g.Deferred(),x=g.Callbacks("once memory"),b=h.statusCode||{},w={},T={},C="canceled",S={readyState:0,getResponseHeader:function(e){var t;if(c){if(!s)for(s={};t=Pe.exec(a);)s[t[1].toLowerCase()]=t[2];t=s[e.toLowerCase()]}return null==t?null:t},getAllResponseHeaders:function(){return c?a:null},setRequestHeader:function(e,t){return null==c&&(e=T[e.toLowerCase()]=T[e.toLowerCase()]||e,w[e]=t),this},overrideMimeType:function(e){return null==c&&(h.mimeType=e),this},statusCode:function(e){var t;if(e)if(c)S.always(e[S.status]);else for(t in e)b[t]=[b[t],e[t]];return this},abort:function(e){var t=e||C;return i&&i.abort(t),done(0,t),this}};if(y.promise(S),h.url=((t||h.url||ke.href)+"").replace(ze,ke.protocol+"//"),h.type=n.method||n.type||h.method||h.type,h.dataTypes=(h.dataType||"*").toLowerCase().match(j)||[""],null==h.crossDomain){l=r.createElement("a");try{l.href=h.url,l.href=l.href,h.crossDomain=$e.protocol+"//"+$e.host!=l.protocol+"//"+l.host}catch(e){h.crossDomain=!0}}if(h.data&&h.processData&&"string"!=typeof h.data&&(h.data=g.param(h.data,h.traditional)),inspectPrefiltersOrTransports(Ie,h,n,S),c)return S;(f=g.event&&h.global)&&0==g.active++&&g.event.trigger("ajaxStart"),h.type=h.type.toUpperCase(),h.hasContent=!Me.test(h.type),o=h.url.replace(qe,""),h.hasContent?h.data&&h.processData&&0===(h.contentType||"").indexOf("application/x-www-form-urlencoded")&&(h.data=h.data.replace(He,"+")):(p=h.url.slice(o.length),h.data&&(o+=(Ae.test(o)?"&":"?")+h.data,delete h.data),!1===h.cache&&(o=o.replace(Le,""),p=(Ae.test(o)?"&":"?")+"_="+Ee+++p),h.url=o+p),h.ifModified&&(g.lastModified[o]&&S.setRequestHeader("If-Modified-Since",g.lastModified[o]),g.etag[o]&&S.setRequestHeader("If-None-Match",g.etag[o])),(h.data&&h.hasContent&&!1!==h.contentType||n.contentType)&&S.setRequestHeader("Content-Type",h.contentType),S.setRequestHeader("Accept",h.dataTypes[0]&&h.accepts[h.dataTypes[0]]?h.accepts[h.dataTypes[0]]+("*"!==h.dataTypes[0]?", "+We+"; q=0.01":""):h.accepts["*"]);for(d in h.headers)S.setRequestHeader(d,h.headers[d]);if(h.beforeSend&&(!1===h.beforeSend.call(m,S,h)||c))return S.abort();if(C="abort",x.add(h.complete),S.done(h.success),S.fail(h.error),i=inspectPrefiltersOrTransports(Re,h,n,S)){if(S.readyState=1,f&&v.trigger("ajaxSend",[S,h]),c)return S;h.async&&h.timeout>0&&(u=e.setTimeout(function(){S.abort("timeout")},h.timeout));try{c=!1,i.send(w,done)}catch(e){if(c)throw e;done(-1,e)}}else done(-1,"No Transport");return S},getJSON:function(e,t,n){return g.get(e,t,n,"json")},getScript:function(e,t){return g.get(e,void 0,t,"script")}}),g.each(["get","post"],function(e,t){g[t]=function(e,n,r,i){return g.isFunction(n)&&(i=i||r,r=n,n=void 0),g.ajax(g.extend({url:e,type:t,dataType:i,data:n,success:r},g.isPlainObject(e)&&e))}}),g._evalUrl=function(e){return g.ajax({url:e,type:"GET",dataType:"script",cache:!0,async:!1,global:!1,throws:!0})},g.fn.extend({wrapAll:function(e){var t;return this[0]&&(g.isFunction(e)&&(e=e.call(this[0])),t=g(e,this[0].ownerDocument).eq(0).clone(!0),this[0].parentNode&&t.insertBefore(this[0]),t.map(function(){for(var e=this;e.firstElementChild;)e=e.firstElementChild;return e}).append(this)),this},wrapInner:function(e){return g.isFunction(e)?this.each(function(t){g(this).wrapInner(e.call(this,t))}):this.each(function(){var t=g(this),n=t.contents();n.length?n.wrapAll(e):t.append(e)})},wrap:function(e){var t=g.isFunction(e);return this.each(function(n){g(this).wrapAll(t?e.call(this,n):e)})},unwrap:function(e){return this.parent(e).not("body").each(function(){g(this).replaceWith(this.childNodes)}),this}}),g.expr.pseudos.hidden=function(e){return!g.expr.pseudos.visible(e)},g.expr.pseudos.visible=function(e){return!!(e.offsetWidth||e.offsetHeight||e.getClientRects().length)},g.ajaxSettings.xhr=function(){try{return new e.XMLHttpRequest}catch(e){}};var Be={0:200,1223:204},_e=g.ajaxSettings.xhr();h.cors=!!_e&&"withCredentials"in _e,h.ajax=_e=!!_e,g.ajaxTransport(function(t){var n,r;if(h.cors||_e&&!t.crossDomain)return{send:function(i,o){var a,s=t.xhr();if(s.open(t.type,t.url,t.async,t.username,t.password),t.xhrFields)for(a in t.xhrFields)s[a]=t.xhrFields[a];t.mimeType&&s.overrideMimeType&&s.overrideMimeType(t.mimeType),t.crossDomain||i["X-Requested-With"]||(i["X-Requested-With"]="XMLHttpRequest");for(a in i)s.setRequestHeader(a,i[a]);n=function(e){return function(){n&&(n=r=s.onload=s.onerror=s.onabort=s.onreadystatechange=null,"abort"===e?s.abort():"error"===e?"number"!=typeof s.status?o(0,"error"):o(s.status,s.statusText):o(Be[s.status]||s.status,s.statusText,"text"!==(s.responseType||"text")||"string"!=typeof s.responseText?{binary:s.response}:{text:s.responseText},s.getAllResponseHeaders()))}},s.onload=n(),r=s.onerror=n("error"),void 0!==s.onabort?s.onabort=r:s.onreadystatechange=function(){4===s.readyState&&e.setTimeout(function(){n&&r()})},n=n("abort");try{s.send(t.hasContent&&t.data||null)}catch(e){if(n)throw e}},abort:function(){n&&n()}}}),g.ajaxPrefilter(function(e){e.crossDomain&&(e.contents.script=!1)}),g.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/\b(?:java|ecma)script\b/},converters:{"text script":function(e){return g.globalEval(e),e}}}),g.ajaxPrefilter("script",function(e){void 0===e.cache&&(e.cache=!1),e.crossDomain&&(e.type="GET")}),g.ajaxTransport("script",function(e){if(e.crossDomain){var t,n;return{send:function(i,o){t=g("<script>").prop({charset:e.scriptCharset,src:e.url}).on("load error",n=function(e){t.remove(),n=null,e&&o("error"===e.type?404:200,e.type)}),r.head.appendChild(t[0])},abort:function(){n&&n()}}}});var Xe=[],Ge=/(=)\?(?=&|$)|\?\?/;g.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var e=Xe.pop()||g.expando+"_"+Ee++;return this[e]=!0,e}}),g.ajaxPrefilter("json jsonp",function(t,n,r){var i,o,a,s=!1!==t.jsonp&&(Ge.test(t.url)?"url":"string"==typeof t.data&&0===(t.contentType||"").indexOf("application/x-www-form-urlencoded")&&Ge.test(t.data)&&"data");if(s||"jsonp"===t.dataTypes[0])return i=t.jsonpCallback=g.isFunction(t.jsonpCallback)?t.jsonpCallback():t.jsonpCallback,s?t[s]=t[s].replace(Ge,"$1"+i):!1!==t.jsonp&&(t.url+=(Ae.test(t.url)?"&":"?")+t.jsonp+"="+i),t.converters["script json"]=function(){return a||g.error(i+" was not called"),a[0]},t.dataTypes[0]="json",o=e[i],e[i]=function(){a=arguments},r.always(function(){void 0===o?g(e).removeProp(i):e[i]=o,t[i]&&(t.jsonpCallback=n.jsonpCallback,Xe.push(i)),a&&g.isFunction(o)&&o(a[0]),a=o=void 0}),"script"}),h.createHTMLDocument=function(){var e=r.implementation.createHTMLDocument("").body;return e.innerHTML="<form></form><form></form>",2===e.childNodes.length}(),g.parseHTML=function(e,t,n){if("string"!=typeof e)return[];"boolean"==typeof t&&(n=t,t=!1);var i,o,a;return t||(h.createHTMLDocument?((i=(t=r.implementation.createHTMLDocument("")).createElement("base")).href=r.location.href,t.head.appendChild(i)):t=r),o=S.exec(e),a=!n&&[],o?[t.createElement(o[1])]:(o=buildFragment([e],t,a),a&&a.length&&g(a).remove(),g.merge([],o.childNodes))},g.fn.load=function(e,t,n){var r,i,o,a=this,s=e.indexOf(" ");return s>-1&&(r=g.trim(e.slice(s)),e=e.slice(0,s)),g.isFunction(t)?(n=t,t=void 0):t&&"object"==typeof t&&(i="POST"),a.length>0&&g.ajax({url:e,type:i||"GET",dataType:"html",data:t}).done(function(e){o=arguments,a.html(r?g("<div>").append(g.parseHTML(e)).find(r):e)}).always(n&&function(e,t){a.each(function(){n.apply(this,o||[e.responseText,t,e])})}),this},g.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(e,t){g.fn[t]=function(e){return this.on(t,e)}}),g.expr.pseudos.animated=function(e){return g.grep(g.timers,function(t){return e===t.elem}).length},g.offset={setOffset:function(e,t,n){var r,i,o,a,s,u,l=g.css(e,"position"),c=g(e),f={};"static"===l&&(e.style.position="relative"),s=c.offset(),o=g.css(e,"top"),u=g.css(e,"left"),("absolute"===l||"fixed"===l)&&(o+u).indexOf("auto")>-1?(a=(r=c.position()).top,i=r.left):(a=parseFloat(o)||0,i=parseFloat(u)||0),g.isFunction(t)&&(t=t.call(e,n,g.extend({},s))),null!=t.top&&(f.top=t.top-s.top+a),null!=t.left&&(f.left=t.left-s.left+i),"using"in t?t.using.call(e,f):c.css(f)}},g.fn.extend({offset:function(e){if(arguments.length)return void 0===e?this:this.each(function(t){g.offset.setOffset(this,e,t)});var t,n,r,i,o=this[0];if(o)return o.getClientRects().length?(r=o.getBoundingClientRect()).width||r.height?(i=o.ownerDocument,n=getWindow(i),t=i.documentElement,{top:r.top+n.pageYOffset-t.clientTop,left:r.left+n.pageXOffset-t.clientLeft}):r:{top:0,left:0}},position:function(){if(this[0]){var e,t,n=this[0],r={top:0,left:0};return"fixed"===g.css(n,"position")?t=n.getBoundingClientRect():(e=this.offsetParent(),t=this.offset(),g.nodeName(e[0],"html")||(r=e.offset()),r={top:r.top+g.css(e[0],"borderTopWidth",!0),left:r.left+g.css(e[0],"borderLeftWidth",!0)}),{top:t.top-r.top-g.css(n,"marginTop",!0),left:t.left-r.left-g.css(n,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){for(var e=this.offsetParent;e&&"static"===g.css(e,"position");)e=e.offsetParent;return e||Q})}}),g.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(e,t){var n="pageYOffset"===t;g.fn[e]=function(r){return q(this,function(e,r,i){var o=getWindow(e);if(void 0===i)return o?o[t]:e[r];o?o.scrollTo(n?o.pageXOffset:i,n?i:o.pageYOffset):e[r]=i},e,r,arguments.length)}}),g.each(["top","left"],function(e,t){g.cssHooks[t]=addGetHookIf(h.pixelPosition,function(e,n){if(n)return n=curCSS(e,t),ae.test(n)?g(e).position()[t]+"px":n})}),g.each({Height:"height",Width:"width"},function(e,t){g.each({padding:"inner"+e,content:t,"":"outer"+e},function(n,r){g.fn[r]=function(i,o){var a=arguments.length&&(n||"boolean"!=typeof i),s=n||(!0===i||!0===o?"margin":"border");return q(this,function(t,n,i){var o;return g.isWindow(t)?0===r.indexOf("outer")?t["inner"+e]:t.document.documentElement["client"+e]:9===t.nodeType?(o=t.documentElement,Math.max(t.body["scroll"+e],o["scroll"+e],t.body["offset"+e],o["offset"+e],o["client"+e])):void 0===i?g.css(t,n,s):g.style(t,n,i,s)},t,a?i:void 0,a)}})}),g.fn.extend({bind:function(e,t,n){return this.on(e,null,t,n)},unbind:function(e,t){return this.off(e,null,t)},delegate:function(e,t,n,r){return this.on(t,e,n,r)},undelegate:function(e,t,n){return 1===arguments.length?this.off(e,"**"):this.off(t,e||"**",n)}}),g.parseJSON=JSON.parse,"function"==typeof define&&define.amd&&define("jquery",[],function(){return g});var Ue=e.jQuery,Ve=e.$;return g.noConflict=function(t){return e.$===g&&(e.$=Ve),t&&e.jQuery===g&&(e.jQuery=Ue),g},t||(e.jQuery=e.$=g),g});
	!function(t){t.color={},t.color.make=function(e,i,o,n){var a={};return a.r=e||0,a.g=i||0,a.b=o||0,a.a=null!=n?n:1,a.add=function(t,e){for(var i=0;i<t.length;++i)a[t.charAt(i)]+=e;return a.normalize()},a.scale=function(t,e){for(var i=0;i<t.length;++i)a[t.charAt(i)]*=e;return a.normalize()},a.toString=function(){return a.a>=1?"rgb("+[a.r,a.g,a.b].join(",")+")":"rgba("+[a.r,a.g,a.b,a.a].join(",")+")"},a.normalize=function(){function clamp(t,e,i){return e<t?t:e>i?i:e}return a.r=clamp(0,parseInt(a.r),255),a.g=clamp(0,parseInt(a.g),255),a.b=clamp(0,parseInt(a.b),255),a.a=clamp(0,a.a,1),a},a.clone=function(){return t.color.make(a.r,a.b,a.g,a.a)},a.normalize()},t.color.extract=function(e,i){var o;do{if(""!=(o=e.css(i).toLowerCase())&&"transparent"!=o)break;e=e.parent()}while(e.length&&!t.nodeName(e.get(0),"body"));return"rgba(0, 0, 0, 0)"==o&&(o="transparent"),t.color.parse(o)},t.color.parse=function(i){var o,n=t.color.make;if(o=/rgb\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*\)/.exec(i))return n(parseInt(o[1],10),parseInt(o[2],10),parseInt(o[3],10));if(o=/rgba\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]+(?:\.[0-9]+)?)\s*\)/.exec(i))return n(parseInt(o[1],10),parseInt(o[2],10),parseInt(o[3],10),parseFloat(o[4]));if(o=/rgb\(\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*\)/.exec(i))return n(2.55*parseFloat(o[1]),2.55*parseFloat(o[2]),2.55*parseFloat(o[3]));if(o=/rgba\(\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\s*\)/.exec(i))return n(2.55*parseFloat(o[1]),2.55*parseFloat(o[2]),2.55*parseFloat(o[3]),parseFloat(o[4]));if(o=/#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})/.exec(i))return n(parseInt(o[1],16),parseInt(o[2],16),parseInt(o[3],16));if(o=/#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])/.exec(i))return n(parseInt(o[1]+o[1],16),parseInt(o[2]+o[2],16),parseInt(o[3]+o[3],16));var a=t.trim(i).toLowerCase();return"transparent"==a?n(255,255,255,0):(o=e[a]||[0,0,0],n(o[0],o[1],o[2]))};var e={aqua:[0,255,255],azure:[240,255,255],beige:[245,245,220],black:[0,0,0],blue:[0,0,255],brown:[165,42,42],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgrey:[169,169,169],darkgreen:[0,100,0],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkviolet:[148,0,211],fuchsia:[255,0,255],gold:[255,215,0],green:[0,128,0],indigo:[75,0,130],khaki:[240,230,140],lightblue:[173,216,230],lightcyan:[224,255,255],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightyellow:[255,255,224],lime:[0,255,0],magenta:[255,0,255],maroon:[128,0,0],navy:[0,0,128],olive:[128,128,0],orange:[255,165,0],pink:[255,192,203],purple:[128,0,128],violet:[128,0,128],red:[255,0,0],silver:[192,192,192],white:[255,255,255],yellow:[255,255,0]}}(jQuery),function(t){function Canvas(e,i){var o=i.children("."+e)[0];if(null==o&&(o=document.createElement("canvas"),o.className=e,t(o).css({direction:"ltr",position:"absolute",left:0,top:0}).appendTo(i),!o.getContext)){if(!window.G_vmlCanvasManager)throw new Error("Canvas is not available. If you're using IE with a fall-back such as Excanvas, then there's either a mistake in your conditional include, or the page has no DOCTYPE and is rendering in Quirks Mode.");o=window.G_vmlCanvasManager.initElement(o)}this.element=o;var n=this.context=o.getContext("2d"),a=window.devicePixelRatio||1,r=n.webkitBackingStorePixelRatio||n.mozBackingStorePixelRatio||n.msBackingStorePixelRatio||n.oBackingStorePixelRatio||n.backingStorePixelRatio||1;this.pixelRatio=a/r,this.resize(i.width(),i.height()),this.textContainer=null,this.text={},this._textCache={}}function Plot(e,i,o,n){function executeHooks(t,e){e=[v].concat(e);for(var i=0;i<t.length;++i)t[i].apply(this,e)}function setData(t){a=parseData(t),fillInSeriesOptions(),processData()}function parseData(e){for(var i=[],o=0;o<e.length;++o){var n=t.extend(!0,{},r.series);null!=e[o].data?(n.data=e[o].data,delete e[o].data,t.extend(!0,n,e[o]),e[o].data=n.data):n.data=e[o],i.push(n)}return i}function axisNumber(t,e){var i=t[e+"axis"];return"object"==typeof i&&(i=i.n),"number"!=typeof i&&(i=1),i}function allAxes(){return t.grep(d.concat(f),function(t){return t})}function canvasToAxisCoords(t){var e,i,o={};for(e=0;e<d.length;++e)(i=d[e])&&i.used&&(o["x"+i.n]=i.c2p(t.left));for(e=0;e<f.length;++e)(i=f[e])&&i.used&&(o["y"+i.n]=i.c2p(t.top));return void 0!==o.x1&&(o.x=o.x1),void 0!==o.y1&&(o.y=o.y1),o}function getOrCreateAxis(e,i){return e[i-1]||(e[i-1]={n:i,direction:e==d?"x":"y",options:t.extend(!0,{},e==d?r.xaxis:r.yaxis)}),e[i-1]}function fillInSeriesOptions(){var e,i=a.length,o=-1;for(e=0;e<a.length;++e){var n=a[e].color;null!=n&&(i--,"number"==typeof n&&n>o&&(o=n))}i<=o&&(i=o+1);var l,s=[],c=r.colors,h=c.length,u=0;for(e=0;e<i;e++)l=t.color.parse(c[e%h]||"#666"),e%h==0&&e&&(u=u>=0?u<.5?-u-.2:0:-u),s[e]=l.scale("rgb",1+u);var p,g=0;for(e=0;e<a.length;++e){if(null==(p=a[e]).color?(p.color=s[g].toString(),++g):"number"==typeof p.color&&(p.color=s[p.color].toString()),null==p.lines.show){var x,m=!0;for(x in p)if(p[x]&&p[x].show){m=!1;break}m&&(p.lines.show=!0)}null==p.lines.zero&&(p.lines.zero=!!p.lines.fill),p.xaxis=getOrCreateAxis(d,axisNumber(p,"x")),p.yaxis=getOrCreateAxis(f,axisNumber(p,"y"))}}function processData(){function updateAxis(t,e,i){e<t.datamin&&e!=-x&&(t.datamin=e),i>t.datamax&&i!=x&&(t.datamax=i)}var e,i,o,n,r,l,s,c,h,u,d,f,p=Number.POSITIVE_INFINITY,g=Number.NEGATIVE_INFINITY,x=Number.MAX_VALUE;for(t.each(allAxes(),function(t,e){e.datamin=p,e.datamax=g,e.used=!1}),e=0;e<a.length;++e)(r=a[e]).datapoints={points:[]},executeHooks(m.processRawData,[r,r.data,r.datapoints]);for(e=0;e<a.length;++e){if(r=a[e],d=r.data,!(f=r.datapoints.format)){if((f=[]).push({x:!0,number:!0,required:!0}),f.push({y:!0,number:!0,required:!0}),r.bars.show||r.lines.show&&r.lines.fill){var v=!!(r.bars.show&&r.bars.zero||r.lines.show&&r.lines.zero);f.push({y:!0,number:!0,required:!1,defaultValue:0,autoscale:v}),r.bars.horizontal&&(delete f[f.length-1].y,f[f.length-1].x=!0)}r.datapoints.format=f}if(null==r.datapoints.pointsize){r.datapoints.pointsize=f.length,s=r.datapoints.pointsize,l=r.datapoints.points;var b=r.lines.show&&r.lines.steps;for(r.xaxis.used=r.yaxis.used=!0,i=o=0;i<d.length;++i,o+=s){var k=null==(u=d[i]);if(!k)for(n=0;n<s;++n)c=u[n],(h=f[n])&&(h.number&&null!=c&&(c=+c,isNaN(c)?c=null:c==1/0?c=x:c==-1/0&&(c=-x)),null==c&&(h.required&&(k=!0),null!=h.defaultValue&&(c=h.defaultValue))),l[o+n]=c;if(k)for(n=0;n<s;++n)null!=(c=l[o+n])&&!1!==(h=f[n]).autoscale&&(h.x&&updateAxis(r.xaxis,c,c),h.y&&updateAxis(r.yaxis,c,c)),l[o+n]=null;else if(b&&o>0&&null!=l[o-s]&&l[o-s]!=l[o]&&l[o-s+1]!=l[o+1]){for(n=0;n<s;++n)l[o+s+n]=l[o+n];l[o+1]=l[o-s+1],o+=s}}}}for(e=0;e<a.length;++e)r=a[e],executeHooks(m.processDatapoints,[r,r.datapoints]);for(e=0;e<a.length;++e){l=(r=a[e]).datapoints.points,s=r.datapoints.pointsize,f=r.datapoints.format;var y=p,w=p,C=g,M=g;for(i=0;i<l.length;i+=s)if(null!=l[i])for(n=0;n<s;++n)c=l[i+n],(h=f[n])&&!1!==h.autoscale&&c!=x&&c!=-x&&(h.x&&(c<y&&(y=c),c>C&&(C=c)),h.y&&(c<w&&(w=c),c>M&&(M=c)));if(r.bars.show){var T;switch(r.bars.align){case"left":T=0;break;case"right":T=-r.bars.barWidth;break;default:T=-r.bars.barWidth/2}r.bars.horizontal?(w+=T,M+=T+r.bars.barWidth):(y+=T,C+=T+r.bars.barWidth)}updateAxis(r.xaxis,y,C),updateAxis(r.yaxis,w,M)}t.each(allAxes(),function(t,e){e.datamin==p&&(e.datamin=null),e.datamax==g&&(e.datamax=null)})}function shutdown(){k&&clearTimeout(k),c.unbind("mousemove",onMouseMove),c.unbind("mouseleave",onMouseLeave),c.unbind("click",onClick),executeHooks(m.shutdown,[c])}function setTransformationHelpers(t){function identity(t){return t}var e,i,o=t.options.transform||identity,n=t.options.inverseTransform;"x"==t.direction?(e=t.scale=g/Math.abs(o(t.max)-o(t.min)),i=Math.min(o(t.max),o(t.min))):(e=t.scale=x/Math.abs(o(t.max)-o(t.min)),e=-e,i=Math.max(o(t.max),o(t.min))),t.p2c=o==identity?function(t){return(t-i)*e}:function(t){return(o(t)-i)*e},t.c2p=n?function(t){return n(i+t/e)}:function(t){return i+t/e}}function measureTickLabels(t){for(var e=t.options,i=t.ticks||[],o=e.labelWidth||0,n=e.labelHeight||0,a=o||("x"==t.direction?Math.floor(l.width/(i.length||1)):null),r=t.direction+"Axis "+t.direction+t.n+"Axis",s="flot-"+t.direction+"-axis flot-"+t.direction+t.n+"-axis "+r,c=e.font||"flot-tick-label tickLabel",h=0;h<i.length;++h){var u=i[h];if(u.label){var d=l.getTextInfo(s,u.label,c,null,a);o=Math.max(o,d.width),n=Math.max(n,d.height)}}t.labelWidth=e.labelWidth||o,t.labelHeight=e.labelHeight||n}function allocateAxisBoxFirstPhase(e){var i=e.labelWidth,o=e.labelHeight,n=e.options.position,a="x"===e.direction,s=e.options.tickLength,c=r.grid.axisMargin,h=r.grid.labelMargin,u=!0,g=!0,x=!0,m=!1;t.each(a?d:f,function(t,i){i&&(i.show||i.reserveSpace)&&(i===e?m=!0:i.options.position===n&&(m?g=!1:u=!1),m||(x=!1))}),g&&(c=0),null==s&&(s=x?"full":5),isNaN(+s)||(h+=+s),a?(o+=h,"bottom"==n?(p.bottom+=o+c,e.box={top:l.height-p.bottom,height:o}):(e.box={top:p.top+c,height:o},p.top+=o+c)):(i+=h,"left"==n?(e.box={left:p.left+c,width:i},p.left+=i+c):(p.right+=i+c,e.box={left:l.width-p.right,width:i})),e.position=n,e.tickLength=s,e.box.padding=h,e.innermost=u}function allocateAxisBoxSecondPhase(t){"x"==t.direction?(t.box.left=p.left-t.labelWidth/2,t.box.width=l.width-p.left-p.right+t.labelWidth):(t.box.top=p.top-t.labelHeight/2,t.box.height=l.height-p.bottom-p.top+t.labelHeight)}function adjustLayoutForThingsStickingOut(){var e,i=r.grid.minBorderMargin;if(null==i)for(i=0,e=0;e<a.length;++e)i=Math.max(i,2*(a[e].points.radius+a[e].points.lineWidth/2));var o={left:i,right:i,top:i,bottom:i};t.each(allAxes(),function(t,e){e.reserveSpace&&e.ticks&&e.ticks.length&&("x"===e.direction?(o.left=Math.max(o.left,e.labelWidth/2),o.right=Math.max(o.right,e.labelWidth/2)):(o.bottom=Math.max(o.bottom,e.labelHeight/2),o.top=Math.max(o.top,e.labelHeight/2)))}),p.left=Math.ceil(Math.max(o.left,p.left)),p.right=Math.ceil(Math.max(o.right,p.right)),p.top=Math.ceil(Math.max(o.top,p.top)),p.bottom=Math.ceil(Math.max(o.bottom,p.bottom))}function setupGrid(){var e,i=allAxes(),o=r.grid.show;for(var n in p){var a=r.grid.margin||0;p[n]="number"==typeof a?a:a[n]||0}executeHooks(m.processOffset,[p]);for(var n in p)"object"==typeof r.grid.borderWidth?p[n]+=o?r.grid.borderWidth[n]:0:p[n]+=o?r.grid.borderWidth:0;if(t.each(i,function(t,e){var i=e.options;e.show=null==i.show?e.used:i.show,e.reserveSpace=null==i.reserveSpace?e.show:i.reserveSpace,setRange(e)}),o){var s=t.grep(i,function(t){return t.show||t.reserveSpace});for(t.each(s,function(t,e){setupTickGeneration(e),setTicks(e),snapRangeToTicks(e,e.ticks),measureTickLabels(e)}),e=s.length-1;e>=0;--e)allocateAxisBoxFirstPhase(s[e]);adjustLayoutForThingsStickingOut(),t.each(s,function(t,e){allocateAxisBoxSecondPhase(e)})}g=l.width-p.left-p.right,x=l.height-p.bottom-p.top,t.each(i,function(t,e){setTransformationHelpers(e)}),o&&drawAxisLabels(),insertLegend()}function setRange(t){var e=t.options,i=+(null!=e.min?e.min:t.datamin),o=+(null!=e.max?e.max:t.datamax),n=o-i;if(0==n){var a=0==o?1:.01;null==e.min&&(i-=a),null!=e.max&&null==e.min||(o+=a)}else{var r=e.autoscaleMargin;null!=r&&(null==e.min&&(i-=n*r)<0&&null!=t.datamin&&t.datamin>=0&&(i=0),null==e.max&&(o+=n*r)>0&&null!=t.datamax&&t.datamax<=0&&(o=0))}t.min=i,t.max=o}function setupTickGeneration(e){var i,o=e.options;i="number"==typeof o.ticks&&o.ticks>0?o.ticks:.3*Math.sqrt("x"==e.direction?l.width:l.height);var n=(e.max-e.min)/i,a=-Math.floor(Math.log(n)/Math.LN10),r=o.tickDecimals;null!=r&&a>r&&(a=r);var s,c=Math.pow(10,-a),h=n/c;if(h<1.5?s=1:h<3?(s=2,h>2.25&&(null==r||a+1<=r)&&(s=2.5,++a)):s=h<7.5?5:10,s*=c,null!=o.minTickSize&&s<o.minTickSize&&(s=o.minTickSize),e.delta=n,e.tickDecimals=Math.max(0,null!=r?r:a),e.tickSize=o.tickSize||s,"time"==o.mode&&!e.tickGenerator)throw new Error("Time mode requires the flot.time plugin.");if(e.tickGenerator||(e.tickGenerator=function(t){var e,i=[],o=floorInBase(t.min,t.tickSize),n=0,a=Number.NaN;do{e=a,a=o+n*t.tickSize,i.push(a),++n}while(a<t.max&&a!=e);return i},e.tickFormatter=function(t,e){var i=e.tickDecimals?Math.pow(10,e.tickDecimals):1,o=""+Math.round(t*i)/i;if(null!=e.tickDecimals){var n=o.indexOf("."),a=-1==n?0:o.length-n-1;if(a<e.tickDecimals)return(a?o:o+".")+(""+i).substr(1,e.tickDecimals-a)}return o}),t.isFunction(o.tickFormatter)&&(e.tickFormatter=function(t,e){return""+o.tickFormatter(t,e)}),null!=o.alignTicksWithAxis){var u=("x"==e.direction?d:f)[o.alignTicksWithAxis-1];if(u&&u.used&&u!=e){var p=e.tickGenerator(e);if(p.length>0&&(null==o.min&&(e.min=Math.min(e.min,p[0])),null==o.max&&p.length>1&&(e.max=Math.max(e.max,p[p.length-1]))),e.tickGenerator=function(t){var e,i,o=[];for(i=0;i<u.ticks.length;++i)e=(u.ticks[i].v-u.min)/(u.max-u.min),e=t.min+e*(t.max-t.min),o.push(e);return o},!e.mode&&null==o.tickDecimals){var g=Math.max(0,1-Math.floor(Math.log(e.delta)/Math.LN10)),x=e.tickGenerator(e);x.length>1&&/\..*0$/.test((x[1]-x[0]).toFixed(g))||(e.tickDecimals=g)}}}}function setTicks(e){var i=e.options.ticks,o=[];null==i||"number"==typeof i&&i>0?o=e.tickGenerator(e):i&&(o=t.isFunction(i)?i(e):i);var n,a;for(e.ticks=[],n=0;n<o.length;++n){var r=null,l=o[n];"object"==typeof l?(a=+l[0],l.length>1&&(r=l[1])):a=+l,null==r&&(r=e.tickFormatter(a,e)),isNaN(a)||e.ticks.push({v:a,label:r})}}function snapRangeToTicks(t,e){t.options.autoscaleMargin&&e.length>0&&(null==t.options.min&&(t.min=Math.min(t.min,e[0].v)),null==t.options.max&&e.length>1&&(t.max=Math.max(t.max,e[e.length-1].v)))}function draw(){l.clear(),executeHooks(m.drawBackground,[h]);var t=r.grid;t.show&&t.backgroundColor&&drawBackground(),t.show&&!t.aboveData&&drawGrid();for(var e=0;e<a.length;++e)executeHooks(m.drawSeries,[h,a[e]]),drawSeries(a[e]);executeHooks(m.draw,[h]),t.show&&t.aboveData&&drawGrid(),l.render(),triggerRedrawOverlay()}function extractRange(t,e){for(var i,o,n,a,r=allAxes(),l=0;l<r.length;++l)if((i=r[l]).direction==e&&(a=e+i.n+"axis",t[a]||1!=i.n||(a=e+"axis"),t[a])){o=t[a].from,n=t[a].to;break}if(t[a]||(i="x"==e?d[0]:f[0],o=t[e+"1"],n=t[e+"2"]),null!=o&&null!=n&&o>n){var s=o;o=n,n=s}return{from:o,to:n,axis:i}}function drawBackground(){h.save(),h.translate(p.left,p.top),h.fillStyle=getColorOrGradient(r.grid.backgroundColor,x,0,"rgba(255, 255, 255, 0)"),h.fillRect(0,0,g,x),h.restore()}function drawGrid(){var e,i,o,n;h.save(),h.translate(p.left,p.top);var a=r.grid.markings;if(a)for(t.isFunction(a)&&((i=v.getAxes()).xmin=i.xaxis.min,i.xmax=i.xaxis.max,i.ymin=i.yaxis.min,i.ymax=i.yaxis.max,a=a(i)),e=0;e<a.length;++e){var l=a[e],s=extractRange(l,"x"),c=extractRange(l,"y");if(null==s.from&&(s.from=s.axis.min),null==s.to&&(s.to=s.axis.max),null==c.from&&(c.from=c.axis.min),null==c.to&&(c.to=c.axis.max),!(s.to<s.axis.min||s.from>s.axis.max||c.to<c.axis.min||c.from>c.axis.max)){s.from=Math.max(s.from,s.axis.min),s.to=Math.min(s.to,s.axis.max),c.from=Math.max(c.from,c.axis.min),c.to=Math.min(c.to,c.axis.max);var u=s.from===s.to,d=c.from===c.to;if(!u||!d)if(s.from=Math.floor(s.axis.p2c(s.from)),s.to=Math.floor(s.axis.p2c(s.to)),c.from=Math.floor(c.axis.p2c(c.from)),c.to=Math.floor(c.axis.p2c(c.to)),u||d){var f=l.lineWidth||r.grid.markingsLineWidth,m=f%2?.5:0;h.beginPath(),h.strokeStyle=l.color||r.grid.markingsColor,h.lineWidth=f,u?(h.moveTo(s.to+m,c.from),h.lineTo(s.to+m,c.to)):(h.moveTo(s.from,c.to+m),h.lineTo(s.to,c.to+m)),h.stroke()}else h.fillStyle=l.color||r.grid.markingsColor,h.fillRect(s.from,c.to,s.to-s.from,c.from-c.to)}}i=allAxes(),o=r.grid.borderWidth;for(var b=0;b<i.length;++b){var k,y,w,C,M=i[b],T=M.box,S=M.tickLength;if(M.show&&0!=M.ticks.length){for(h.lineWidth=1,"x"==M.direction?(k=0,y="full"==S?"top"==M.position?0:x:T.top-p.top+("top"==M.position?T.height:0)):(y=0,k="full"==S?"left"==M.position?0:g:T.left-p.left+("left"==M.position?T.width:0)),M.innermost||(h.strokeStyle=M.options.color,h.beginPath(),w=C=0,"x"==M.direction?w=g+1:C=x+1,1==h.lineWidth&&("x"==M.direction?y=Math.floor(y)+.5:k=Math.floor(k)+.5),h.moveTo(k,y),h.lineTo(k+w,y+C),h.stroke()),h.strokeStyle=M.options.tickColor,h.beginPath(),e=0;e<M.ticks.length;++e){var A=M.ticks[e].v;w=C=0,isNaN(A)||A<M.min||A>M.max||"full"==S&&("object"==typeof o&&o[M.position]>0||o>0)&&(A==M.min||A==M.max)||("x"==M.direction?(k=M.p2c(A),C="full"==S?-x:S,"top"==M.position&&(C=-C)):(y=M.p2c(A),w="full"==S?-g:S,"left"==M.position&&(w=-w)),1==h.lineWidth&&("x"==M.direction?k=Math.floor(k)+.5:y=Math.floor(y)+.5),h.moveTo(k,y),h.lineTo(k+w,y+C))}h.stroke()}}o&&(n=r.grid.borderColor,"object"==typeof o||"object"==typeof n?("object"!=typeof o&&(o={top:o,right:o,bottom:o,left:o}),"object"!=typeof n&&(n={top:n,right:n,bottom:n,left:n}),o.top>0&&(h.strokeStyle=n.top,h.lineWidth=o.top,h.beginPath(),h.moveTo(0-o.left,0-o.top/2),h.lineTo(g,0-o.top/2),h.stroke()),o.right>0&&(h.strokeStyle=n.right,h.lineWidth=o.right,h.beginPath(),h.moveTo(g+o.right/2,0-o.top),h.lineTo(g+o.right/2,x),h.stroke()),o.bottom>0&&(h.strokeStyle=n.bottom,h.lineWidth=o.bottom,h.beginPath(),h.moveTo(g+o.right,x+o.bottom/2),h.lineTo(0,x+o.bottom/2),h.stroke()),o.left>0&&(h.strokeStyle=n.left,h.lineWidth=o.left,h.beginPath(),h.moveTo(0-o.left/2,x+o.bottom),h.lineTo(0-o.left/2,0),h.stroke())):(h.lineWidth=o,h.strokeStyle=r.grid.borderColor,h.strokeRect(-o/2,-o/2,g+o,x+o))),h.restore()}function drawAxisLabels(){t.each(allAxes(),function(t,e){var i,o,n,a,r,s=e.box,c=e.direction+"Axis "+e.direction+e.n+"Axis",h="flot-"+e.direction+"-axis flot-"+e.direction+e.n+"-axis "+c,u=e.options.font||"flot-tick-label tickLabel";if(l.removeText(h),e.show&&0!=e.ticks.length)for(var d=0;d<e.ticks.length;++d)!(i=e.ticks[d]).label||i.v<e.min||i.v>e.max||("x"==e.direction?(a="center",o=p.left+e.p2c(i.v),"bottom"==e.position?n=s.top+s.padding:(n=s.top+s.height-s.padding,r="bottom")):(r="middle",n=p.top+e.p2c(i.v),"left"==e.position?(o=s.left+s.width-s.padding,a="right"):o=s.left+s.padding),l.addText(h,o,n,i.label,u,null,null,a,r))})}function drawSeries(t){t.lines.show&&drawSeriesLines(t),t.bars.show&&drawSeriesBars(t),t.points.show&&drawSeriesPoints(t)}function drawSeriesLines(t){function plotLine(t,e,i,o,n){var a=t.points,r=t.pointsize,l=null,s=null;h.beginPath();for(var c=r;c<a.length;c+=r){var u=a[c-r],d=a[c-r+1],f=a[c],p=a[c+1];if(null!=u&&null!=f){if(d<=p&&d<n.min){if(p<n.min)continue;u=(n.min-d)/(p-d)*(f-u)+u,d=n.min}else if(p<=d&&p<n.min){if(d<n.min)continue;f=(n.min-d)/(p-d)*(f-u)+u,p=n.min}if(d>=p&&d>n.max){if(p>n.max)continue;u=(n.max-d)/(p-d)*(f-u)+u,d=n.max}else if(p>=d&&p>n.max){if(d>n.max)continue;f=(n.max-d)/(p-d)*(f-u)+u,p=n.max}if(u<=f&&u<o.min){if(f<o.min)continue;d=(o.min-u)/(f-u)*(p-d)+d,u=o.min}else if(f<=u&&f<o.min){if(u<o.min)continue;p=(o.min-u)/(f-u)*(p-d)+d,f=o.min}if(u>=f&&u>o.max){if(f>o.max)continue;d=(o.max-u)/(f-u)*(p-d)+d,u=o.max}else if(f>=u&&f>o.max){if(u>o.max)continue;p=(o.max-u)/(f-u)*(p-d)+d,f=o.max}u==l&&d==s||h.moveTo(o.p2c(u)+e,n.p2c(d)+i),l=f,s=p,h.lineTo(o.p2c(f)+e,n.p2c(p)+i)}}h.stroke()}h.save(),h.translate(p.left,p.top),h.lineJoin="round";var e=t.lines.lineWidth,i=t.shadowSize;if(e>0&&i>0){h.lineWidth=i,h.strokeStyle="rgba(0,0,0,0.1)";var o=Math.PI/18;plotLine(t.datapoints,Math.sin(o)*(e/2+i/2),Math.cos(o)*(e/2+i/2),t.xaxis,t.yaxis),h.lineWidth=i/2,plotLine(t.datapoints,Math.sin(o)*(e/2+i/4),Math.cos(o)*(e/2+i/4),t.xaxis,t.yaxis)}h.lineWidth=e,h.strokeStyle=t.color;var n=getFillStyle(t.lines,t.color,0,x);n&&(h.fillStyle=n,function plotLineArea(t,e,i){for(var o=t.points,n=t.pointsize,a=Math.min(Math.max(0,i.min),i.max),r=0,l=!1,s=1,c=0,u=0;!(n>0&&r>o.length+n);){var d=o[(r+=n)-n],f=o[r-n+s],p=o[r],g=o[r+s];if(l){if(n>0&&null!=d&&null==p){u=r,n=-n,s=2;continue}if(n<0&&r==c+n){h.fill(),l=!1,s=1,r=c=u+(n=-n);continue}}if(null!=d&&null!=p){if(d<=p&&d<e.min){if(p<e.min)continue;f=(e.min-d)/(p-d)*(g-f)+f,d=e.min}else if(p<=d&&p<e.min){if(d<e.min)continue;g=(e.min-d)/(p-d)*(g-f)+f,p=e.min}if(d>=p&&d>e.max){if(p>e.max)continue;f=(e.max-d)/(p-d)*(g-f)+f,d=e.max}else if(p>=d&&p>e.max){if(d>e.max)continue;g=(e.max-d)/(p-d)*(g-f)+f,p=e.max}if(l||(h.beginPath(),h.moveTo(e.p2c(d),i.p2c(a)),l=!0),f>=i.max&&g>=i.max)h.lineTo(e.p2c(d),i.p2c(i.max)),h.lineTo(e.p2c(p),i.p2c(i.max));else if(f<=i.min&&g<=i.min)h.lineTo(e.p2c(d),i.p2c(i.min)),h.lineTo(e.p2c(p),i.p2c(i.min));else{var x=d,m=p;f<=g&&f<i.min&&g>=i.min?(d=(i.min-f)/(g-f)*(p-d)+d,f=i.min):g<=f&&g<i.min&&f>=i.min&&(p=(i.min-f)/(g-f)*(p-d)+d,g=i.min),f>=g&&f>i.max&&g<=i.max?(d=(i.max-f)/(g-f)*(p-d)+d,f=i.max):g>=f&&g>i.max&&f<=i.max&&(p=(i.max-f)/(g-f)*(p-d)+d,g=i.max),d!=x&&h.lineTo(e.p2c(x),i.p2c(f)),h.lineTo(e.p2c(d),i.p2c(f)),h.lineTo(e.p2c(p),i.p2c(g)),p!=m&&(h.lineTo(e.p2c(p),i.p2c(g)),h.lineTo(e.p2c(m),i.p2c(g)))}}}}(t.datapoints,t.xaxis,t.yaxis)),e>0&&plotLine(t.datapoints,0,0,t.xaxis,t.yaxis),h.restore()}function drawSeriesPoints(t){function plotPoints(t,e,i,o,n,a,r,l){for(var s=t.points,c=t.pointsize,u=0;u<s.length;u+=c){var d=s[u],f=s[u+1];null==d||d<a.min||d>a.max||f<r.min||f>r.max||(h.beginPath(),d=a.p2c(d),f=r.p2c(f)+o,"circle"==l?h.arc(d,f,e,0,n?Math.PI:2*Math.PI,!1):l(h,d,f,e,n),h.closePath(),i&&(h.fillStyle=i,h.fill()),h.stroke())}}h.save(),h.translate(p.left,p.top);var e=t.points.lineWidth,i=t.shadowSize,o=t.points.radius,n=t.points.symbol;if(0==e&&(e=1e-4),e>0&&i>0){var a=i/2;h.lineWidth=a,h.strokeStyle="rgba(0,0,0,0.1)",plotPoints(t.datapoints,o,null,a+a/2,!0,t.xaxis,t.yaxis,n),h.strokeStyle="rgba(0,0,0,0.2)",plotPoints(t.datapoints,o,null,a/2,!0,t.xaxis,t.yaxis,n)}h.lineWidth=e,h.strokeStyle=t.color,plotPoints(t.datapoints,o,getFillStyle(t.points,t.color),0,!1,t.xaxis,t.yaxis,n),h.restore()}function drawBar(t,e,i,o,n,a,r,l,s,c,h){var u,d,f,p,g,x,m,v,b;c?(v=x=m=!0,g=!1,p=e+o,f=e+n,(d=t)<(u=i)&&(b=d,d=u,u=b,g=!0,x=!1)):(g=x=m=!0,v=!1,u=t+o,d=t+n,(p=e)<(f=i)&&(b=p,p=f,f=b,v=!0,m=!1)),d<r.min||u>r.max||p<l.min||f>l.max||(u<r.min&&(u=r.min,g=!1),d>r.max&&(d=r.max,x=!1),f<l.min&&(f=l.min,v=!1),p>l.max&&(p=l.max,m=!1),u=r.p2c(u),f=l.p2c(f),d=r.p2c(d),p=l.p2c(p),a&&(s.fillStyle=a(f,p),s.fillRect(u,p,d-u,f-p)),h>0&&(g||x||m||v)&&(s.beginPath(),s.moveTo(u,f),g?s.lineTo(u,p):s.moveTo(u,p),m?s.lineTo(d,p):s.moveTo(d,p),x?s.lineTo(d,f):s.moveTo(d,f),v?s.lineTo(u,f):s.moveTo(u,f),s.stroke()))}function drawSeriesBars(t){h.save(),h.translate(p.left,p.top),h.lineWidth=t.bars.lineWidth,h.strokeStyle=t.color;var e;switch(t.bars.align){case"left":e=0;break;case"right":e=-t.bars.barWidth;break;default:e=-t.bars.barWidth/2}var i=t.bars.fill?function(e,i){return getFillStyle(t.bars,t.color,e,i)}:null;!function plotBars(e,i,o,n,a,r){for(var l=e.points,s=e.pointsize,c=0;c<l.length;c+=s)null!=l[c]&&drawBar(l[c],l[c+1],l[c+2],i,o,n,a,r,h,t.bars.horizontal,t.bars.lineWidth)}(t.datapoints,e,e+t.bars.barWidth,i,t.xaxis,t.yaxis),h.restore()}function getFillStyle(e,i,o,n){var a=e.fill;if(!a)return null;if(e.fillColor)return getColorOrGradient(e.fillColor,o,n,i);var r=t.color.parse(i);return r.a="number"==typeof a?a:.4,r.normalize(),r.toString()}function insertLegend(){if(null!=r.legend.container?t(r.legend.container).html(""):e.find(".legend").remove(),r.legend.show){for(var i,o,n=[],l=[],s=!1,c=r.legend.labelFormatter,h=0;h<a.length;++h)(i=a[h]).label&&(o=c?c(i.label,i):i.label)&&l.push({label:o,color:i.color});if(r.legend.sorted)if(t.isFunction(r.legend.sorted))l.sort(r.legend.sorted);else if("reverse"==r.legend.sorted)l.reverse();else{var u="descending"!=r.legend.sorted;l.sort(function(t,e){return t.label==e.label?0:t.label<e.label!=u?1:-1})}for(h=0;h<l.length;++h){var d=l[h];h%r.legend.noColumns==0&&(s&&n.push("</tr>"),n.push("<tr>"),s=!0),n.push('<td class="legendColorBox"><div style="border:1px solid '+r.legend.labelBoxBorderColor+';padding:1px"><div style="width:4px;height:0;border:5px solid '+d.color+';overflow:hidden"></div></div></td><td class="legendLabel">'+d.label+"</td>")}if(s&&n.push("</tr>"),0!=n.length){var f='<table style="font-size:smaller;color:'+r.grid.color+'">'+n.join("")+"</table>";if(null!=r.legend.container)t(r.legend.container).html(f);else{var g="",x=r.legend.position,m=r.legend.margin;null==m[0]&&(m=[m,m]),"n"==x.charAt(0)?g+="top:"+(m[1]+p.top)+"px;":"s"==x.charAt(0)&&(g+="bottom:"+(m[1]+p.bottom)+"px;"),"e"==x.charAt(1)?g+="right:"+(m[0]+p.right)+"px;":"w"==x.charAt(1)&&(g+="left:"+(m[0]+p.left)+"px;");var v=t('<div class="legend">'+f.replace('style="','style="position:absolute;'+g+";")+"</div>").appendTo(e);if(0!=r.legend.backgroundOpacity){var b=r.legend.backgroundColor;null==b&&((b=(b=r.grid.backgroundColor)&&"string"==typeof b?t.color.parse(b):t.color.extract(v,"background-color")).a=1,b=b.toString());var k=v.children();t('<div style="position:absolute;width:'+k.width()+"px;height:"+k.height()+"px;"+g+"background-color:"+b+';"> </div>').prependTo(v).css("opacity",r.legend.backgroundOpacity)}}}}}function findNearbyItem(t,e,i){var o,n,l,s=r.grid.mouseActiveRadius,c=s*s+1,h=null;for(o=a.length-1;o>=0;--o)if(i(a[o])){var u=a[o],d=u.xaxis,f=u.yaxis,p=u.datapoints.points,g=d.c2p(t),x=f.c2p(e),m=s/d.scale,v=s/f.scale;if(l=u.datapoints.pointsize,d.options.inverseTransform&&(m=Number.MAX_VALUE),f.options.inverseTransform&&(v=Number.MAX_VALUE),u.lines.show||u.points.show)for(n=0;n<p.length;n+=l){var b=p[n],k=p[n+1];if(null!=b&&!(b-g>m||b-g<-m||k-x>v||k-x<-v)){var y=Math.abs(d.p2c(b)-t),w=Math.abs(f.p2c(k)-e),C=y*y+w*w;C<c&&(c=C,h=[o,n/l])}}if(u.bars.show&&!h){var M,T;switch(u.bars.align){case"left":M=0;break;case"right":M=-u.bars.barWidth;break;default:M=-u.bars.barWidth/2}for(T=M+u.bars.barWidth,n=0;n<p.length;n+=l){var b=p[n],k=p[n+1],S=p[n+2];null!=b&&((a[o].bars.horizontal?g<=Math.max(S,b)&&g>=Math.min(S,b)&&x>=k+M&&x<=k+T:g>=b+M&&g<=b+T&&x>=Math.min(S,k)&&x<=Math.max(S,k))&&(h=[o,n/l]))}}}return h?(o=h[0],n=h[1],l=a[o].datapoints.pointsize,{datapoint:a[o].datapoints.points.slice(n*l,(n+1)*l),dataIndex:n,series:a[o],seriesIndex:o}):null}function onMouseMove(t){r.grid.hoverable&&triggerClickHoverEvent("plothover",t,function(t){return 0!=t.hoverable})}function onMouseLeave(t){r.grid.hoverable&&triggerClickHoverEvent("plothover",t,function(t){return!1})}function onClick(t){triggerClickHoverEvent("plotclick",t,function(t){return 0!=t.clickable})}function triggerClickHoverEvent(t,i,o){var n=c.offset(),a=i.pageX-n.left-p.left,l=i.pageY-n.top-p.top,s=canvasToAxisCoords({left:a,top:l});s.pageX=i.pageX,s.pageY=i.pageY;var h=findNearbyItem(a,l,o);if(h&&(h.pageX=parseInt(h.series.xaxis.p2c(h.datapoint[0])+n.left+p.left,10),h.pageY=parseInt(h.series.yaxis.p2c(h.datapoint[1])+n.top+p.top,10)),r.grid.autoHighlight){for(var u=0;u<b.length;++u){var d=b[u];d.auto!=t||h&&d.series==h.series&&d.point[0]==h.datapoint[0]&&d.point[1]==h.datapoint[1]||unhighlight(d.series,d.point)}h&&highlight(h.series,h.datapoint,t)}e.trigger(t,[s,h])}function triggerRedrawOverlay(){var t=r.interaction.redrawOverlayInterval;-1!=t?k||(k=setTimeout(drawOverlay,t)):drawOverlay()}function drawOverlay(){if(k=null,void 0!=u){u.save(),s.clear(),u.translate(p.left,p.top);var t,e;for(t=0;t<b.length;++t)(e=b[t]).series.bars.show?drawBarHighlight(e.series,e.point):drawPointHighlight(e.series,e.point);u.restore(),executeHooks(m.drawOverlay,[u])}}function highlight(t,e,i){if("number"==typeof t&&(t=a[t]),"number"==typeof e){var o=t.datapoints.pointsize;e=t.datapoints.points.slice(o*e,o*(e+1))}var n=indexOfHighlight(t,e);-1==n?(b.push({series:t,point:e,auto:i}),triggerRedrawOverlay()):i||(b[n].auto=!1)}function unhighlight(t,e){if(null==t&&null==e)return b=[],void triggerRedrawOverlay();if("number"==typeof t&&(t=a[t]),"number"==typeof e){var i=t.datapoints.pointsize;e=t.datapoints.points.slice(i*e,i*(e+1))}var o=indexOfHighlight(t,e);-1!=o&&(b.splice(o,1),triggerRedrawOverlay())}function indexOfHighlight(t,e){for(var i=0;i<b.length;++i){var o=b[i];if(o.series==t&&o.point[0]==e[0]&&o.point[1]==e[1])return i}return-1}function drawPointHighlight(e,i){var o=i[0],n=i[1],a=e.xaxis,r=e.yaxis,l="string"==typeof e.highlightColor?e.highlightColor:t.color.parse(e.color).scale("a",.5).toString();if(!(o<a.min||o>a.max||n<r.min||n>r.max)){var s=e.points.radius+e.points.lineWidth/2;u.lineWidth=s,u.strokeStyle=l;var c=1.5*s;o=a.p2c(o),n=r.p2c(n),u.beginPath(),"circle"==e.points.symbol?u.arc(o,n,c,0,2*Math.PI,!1):e.points.symbol(u,o,n,c,!1),u.closePath(),u.stroke()}}function drawBarHighlight(e,i){var o,n="string"==typeof e.highlightColor?e.highlightColor:t.color.parse(e.color).scale("a",.5).toString(),a=n;switch(e.bars.align){case"left":o=0;break;case"right":o=-e.bars.barWidth;break;default:o=-e.bars.barWidth/2}u.lineWidth=e.bars.lineWidth,u.strokeStyle=n,drawBar(i[0],i[1],i[2]||0,o,o+e.bars.barWidth,function(){return a},e.xaxis,e.yaxis,u,e.bars.horizontal,e.bars.lineWidth)}function getColorOrGradient(e,i,o,n){if("string"==typeof e)return e;for(var a=h.createLinearGradient(0,o,0,i),r=0,l=e.colors.length;r<l;++r){var s=e.colors[r];if("string"!=typeof s){var c=t.color.parse(n);null!=s.brightness&&(c=c.scale("rgb",s.brightness)),null!=s.opacity&&(c.a*=s.opacity),s=c.toString()}a.addColorStop(r/(l-1),s)}return a}var a=[],r={colors:["#edc240","#afd8f8","#cb4b4b","#4da74d","#9440ed"],legend:{show:!0,noColumns:1,labelFormatter:null,labelBoxBorderColor:"#ccc",container:null,position:"ne",margin:5,backgroundColor:null,backgroundOpacity:.85,sorted:null},xaxis:{show:null,position:"bottom",mode:null,font:null,color:null,tickColor:null,transform:null,inverseTransform:null,min:null,max:null,autoscaleMargin:null,ticks:null,tickFormatter:null,labelWidth:null,labelHeight:null,reserveSpace:null,tickLength:null,alignTicksWithAxis:null,tickDecimals:null,tickSize:null,minTickSize:null},yaxis:{autoscaleMargin:.02,position:"left"},xaxes:[],yaxes:[],series:{points:{show:!1,radius:3,lineWidth:2,fill:!0,fillColor:"#ffffff",symbol:"circle"},lines:{lineWidth:2,fill:!1,fillColor:null,steps:!1},bars:{show:!1,lineWidth:2,barWidth:1,fill:!0,fillColor:null,align:"left",horizontal:!1,zero:!0},shadowSize:3,highlightColor:null},grid:{show:!0,aboveData:!1,color:"#545454",backgroundColor:null,borderColor:null,tickColor:null,margin:0,labelMargin:5,axisMargin:8,borderWidth:2,minBorderMargin:null,markings:null,markingsColor:"#f4f4f4",markingsLineWidth:2,clickable:!1,hoverable:!1,autoHighlight:!0,mouseActiveRadius:10},interaction:{redrawOverlayInterval:1e3/60},hooks:{}},l=null,s=null,c=null,h=null,u=null,d=[],f=[],p={left:0,right:0,top:0,bottom:0},g=0,x=0,m={processOptions:[],processRawData:[],processDatapoints:[],processOffset:[],drawBackground:[],drawSeries:[],draw:[],bindEvents:[],drawOverlay:[],shutdown:[]},v=this;v.setData=setData,v.setupGrid=setupGrid,v.draw=draw,v.getPlaceholder=function(){return e},v.getCanvas=function(){return l.element},v.getPlotOffset=function(){return p},v.width=function(){return g},v.height=function(){return x},v.offset=function(){var t=c.offset();return t.left+=p.left,t.top+=p.top,t},v.getData=function(){return a},v.getAxes=function(){var e={};return t.each(d.concat(f),function(t,i){i&&(e[i.direction+(1!=i.n?i.n:"")+"axis"]=i)}),e},v.getXAxes=function(){return d},v.getYAxes=function(){return f},v.c2p=canvasToAxisCoords,v.p2c=function axisToCanvasCoords(t){var e,i,o,n={};for(e=0;e<d.length;++e)if((i=d[e])&&i.used&&(o="x"+i.n,null==t[o]&&1==i.n&&(o="x"),null!=t[o])){n.left=i.p2c(t[o]);break}for(e=0;e<f.length;++e)if((i=f[e])&&i.used&&(o="y"+i.n,null==t[o]&&1==i.n&&(o="y"),null!=t[o])){n.top=i.p2c(t[o]);break}return n},v.getOptions=function(){return r},v.highlight=highlight,v.unhighlight=unhighlight,v.triggerRedrawOverlay=triggerRedrawOverlay,v.pointOffset=function(t){return{left:parseInt(d[axisNumber(t,"x")-1].p2c(+t.x)+p.left,10),top:parseInt(f[axisNumber(t,"y")-1].p2c(+t.y)+p.top,10)}},v.shutdown=shutdown,v.destroy=function(){shutdown(),e.removeData("plot").empty(),a=[],r=null,l=null,s=null,c=null,h=null,u=null,d=[],f=[],m=null,b=[],v=null},v.resize=function(){var t=e.width(),i=e.height();l.resize(t,i),s.resize(t,i)},v.hooks=m,function initPlugins(){for(var e={Canvas:Canvas},i=0;i<n.length;++i){var o=n[i];o.init(v,e),o.options&&t.extend(!0,r,o.options)}}(),function parseOptions(i){t.extend(!0,r,i),i&&i.colors&&(r.colors=i.colors),null==r.xaxis.color&&(r.xaxis.color=t.color.parse(r.grid.color).scale("a",.22).toString()),null==r.yaxis.color&&(r.yaxis.color=t.color.parse(r.grid.color).scale("a",.22).toString()),null==r.xaxis.tickColor&&(r.xaxis.tickColor=r.grid.tickColor||r.xaxis.color),null==r.yaxis.tickColor&&(r.yaxis.tickColor=r.grid.tickColor||r.yaxis.color),null==r.grid.borderColor&&(r.grid.borderColor=r.grid.color),null==r.grid.tickColor&&(r.grid.tickColor=t.color.parse(r.grid.color).scale("a",.22).toString());var o,n,a,l=e.css("font-size"),s=l?+l.replace("px",""):13,c={style:e.css("font-style"),size:Math.round(.8*s),variant:e.css("font-variant"),weight:e.css("font-weight"),family:e.css("font-family")};for(a=r.xaxes.length||1,o=0;o<a;++o)(n=r.xaxes[o])&&!n.tickColor&&(n.tickColor=n.color),n=t.extend(!0,{},r.xaxis,n),r.xaxes[o]=n,n.font&&(n.font=t.extend({},c,n.font),n.font.color||(n.font.color=n.color),n.font.lineHeight||(n.font.lineHeight=Math.round(1.15*n.font.size)));for(a=r.yaxes.length||1,o=0;o<a;++o)(n=r.yaxes[o])&&!n.tickColor&&(n.tickColor=n.color),n=t.extend(!0,{},r.yaxis,n),r.yaxes[o]=n,n.font&&(n.font=t.extend({},c,n.font),n.font.color||(n.font.color=n.color),n.font.lineHeight||(n.font.lineHeight=Math.round(1.15*n.font.size)));for(r.xaxis.noTicks&&null==r.xaxis.ticks&&(r.xaxis.ticks=r.xaxis.noTicks),r.yaxis.noTicks&&null==r.yaxis.ticks&&(r.yaxis.ticks=r.yaxis.noTicks),r.x2axis&&(r.xaxes[1]=t.extend(!0,{},r.xaxis,r.x2axis),r.xaxes[1].position="top",null==r.x2axis.min&&(r.xaxes[1].min=null),null==r.x2axis.max&&(r.xaxes[1].max=null)),r.y2axis&&(r.yaxes[1]=t.extend(!0,{},r.yaxis,r.y2axis),r.yaxes[1].position="right",null==r.y2axis.min&&(r.yaxes[1].min=null),null==r.y2axis.max&&(r.yaxes[1].max=null)),r.grid.coloredAreas&&(r.grid.markings=r.grid.coloredAreas),r.grid.coloredAreasColor&&(r.grid.markingsColor=r.grid.coloredAreasColor),r.lines&&t.extend(!0,r.series.lines,r.lines),r.points&&t.extend(!0,r.series.points,r.points),r.bars&&t.extend(!0,r.series.bars,r.bars),null!=r.shadowSize&&(r.series.shadowSize=r.shadowSize),null!=r.highlightColor&&(r.series.highlightColor=r.highlightColor),o=0;o<r.xaxes.length;++o)getOrCreateAxis(d,o+1).options=r.xaxes[o];for(o=0;o<r.yaxes.length;++o)getOrCreateAxis(f,o+1).options=r.yaxes[o];for(var h in m)r.hooks[h]&&r.hooks[h].length&&(m[h]=m[h].concat(r.hooks[h]));executeHooks(m.processOptions,[r])}(o),function setupCanvases(){e.css("padding",0).children().filter(function(){return!t(this).hasClass("flot-overlay")&&!t(this).hasClass("flot-base")}).remove(),"static"==e.css("position")&&e.css("position","relative"),l=new Canvas("flot-base",e),s=new Canvas("flot-overlay",e),h=l.context,u=s.context,c=t(s.element).unbind();var i=e.data("plot");i&&(i.shutdown(),s.clear()),e.data("plot",v)}(),setData(i),setupGrid(),draw(),function bindEvents(){r.grid.hoverable&&(c.mousemove(onMouseMove),c.bind("mouseleave",onMouseLeave)),r.grid.clickable&&c.click(onClick),executeHooks(m.bindEvents,[c])}();var b=[],k=null}function floorInBase(t,e){return e*Math.floor(t/e)}var e=Object.prototype.hasOwnProperty;t.fn.detach||(t.fn.detach=function(){return this.each(function(){this.parentNode&&this.parentNode.removeChild(this)})}),Canvas.prototype.resize=function(t,e){if(t<=0||e<=0)throw new Error("Invalid dimensions for plot, width = "+t+", height = "+e);var i=this.element,o=this.context,n=this.pixelRatio;this.width!=t&&(i.width=t*n,i.style.width=t+"px",this.width=t),this.height!=e&&(i.height=e*n,i.style.height=e+"px",this.height=e),o.restore(),o.save(),o.scale(n,n)},Canvas.prototype.clear=function(){this.context.clearRect(0,0,this.width,this.height)},Canvas.prototype.render=function(){var t=this._textCache;for(var i in t)if(e.call(t,i)){var o=this.getTextLayer(i),n=t[i];o.hide();for(var a in n)if(e.call(n,a)){var r=n[a];for(var l in r)if(e.call(r,l)){for(var s,c=r[l].positions,h=0;s=c[h];h++)s.active?s.rendered||(o.append(s.element),s.rendered=!0):(c.splice(h--,1),s.rendered&&s.element.detach());0==c.length&&delete r[l]}}o.show()}},Canvas.prototype.getTextLayer=function(e){var i=this.text[e];return null==i&&(null==this.textContainer&&(this.textContainer=t("<div class='flot-text'></div>").css({position:"absolute",top:0,left:0,bottom:0,right:0,"font-size":"smaller",color:"#545454"}).insertAfter(this.element)),i=this.text[e]=t("<div></div>").addClass(e).css({position:"absolute",top:0,left:0,bottom:0,right:0}).appendTo(this.textContainer)),i},Canvas.prototype.getTextInfo=function(e,i,o,n,a){var r,l,s,c;if(i=""+i,r="object"==typeof o?o.style+" "+o.variant+" "+o.weight+" "+o.size+"px/"+o.lineHeight+"px "+o.family:o,null==(l=this._textCache[e])&&(l=this._textCache[e]={}),null==(s=l[r])&&(s=l[r]={}),null==(c=s[i])){var h=t("<div></div>").html(i).css({position:"absolute","max-width":a,top:-9999}).appendTo(this.getTextLayer(e));"object"==typeof o?h.css({font:r,color:o.color}):"string"==typeof o&&h.addClass(o),c=s[i]={width:h.outerWidth(!0),height:h.outerHeight(!0),element:h,positions:[]},h.detach()}return c},Canvas.prototype.addText=function(t,e,i,o,n,a,r,l,s){var c=this.getTextInfo(t,o,n,a,r),h=c.positions;"center"==l?e-=c.width/2:"right"==l&&(e-=c.width),"middle"==s?i-=c.height/2:"bottom"==s&&(i-=c.height);for(var u,d=0;u=h[d];d++)if(u.x==e&&u.y==i)return void(u.active=!0);u={active:!0,rendered:!1,element:h.length?c.element.clone():c.element,x:e,y:i},h.push(u),u.element.css({top:Math.round(i),left:Math.round(e),"text-align":l})},Canvas.prototype.removeText=function(t,i,o,n,a,r){if(null==n){var l=this._textCache[t];if(null!=l)for(var s in l)if(e.call(l,s)){var c=l[s];for(var h in c)if(e.call(c,h))for(var u=c[h].positions,d=0;f=u[d];d++)f.active=!1}}else for(var f,u=this.getTextInfo(t,n,a,r).positions,d=0;f=u[d];d++)f.x==i&&f.y==o&&(f.active=!1)},t.plot=function(e,i,o){return new Plot(t(e),i,o,t.plot.plugins)},t.plot.version="0.8.3",t.plot.plugins=[],t.fn.plot=function(e,i){return this.each(function(){t.plot(this,e,i)})}}(jQuery);
	!function(e){jQuery.plot.plugins.push({init:function init(e){e.hooks.drawSeries.push(function(e,a,i){function plotDashes(e,t){var o,h,l=i.datapoints.points,d=i.datapoints.pointsize,m=null,r=null,f=0,p=!0;i.dashes.dashLength[0]?(o=i.dashes.dashLength[0],h=i.dashes.dashLength[1]?i.dashes.dashLength[1]:o):h=o=i.dashes.dashLength,a.beginPath();for(var c=d;c<l.length;c+=d){var u=l[c-d],x=l[c-d+1],M=l[c],v=l[c+1];if(null!=u&&null!=M){if(x<=v&&x<s.min){if(v<s.min)continue;u=(s.min-x)/(v-x)*(M-u)+u,x=s.min}else if(v<=x&&v<s.min){if(x<s.min)continue;M=(s.min-x)/(v-x)*(M-u)+u,v=s.min}if(x>=v&&x>s.max){if(v>s.max)continue;u=(s.max-x)/(v-x)*(M-u)+u,x=s.max}else if(v>=x&&v>s.max){if(x>s.max)continue;M=(s.max-x)/(v-x)*(M-u)+u,v=s.max}if(u<=M&&u<n.min){if(M<n.min)continue;x=(n.min-u)/(M-u)*(v-x)+x,u=n.min}else if(M<=u&&M<n.min){if(u<n.min)continue;v=(n.min-u)/(M-u)*(v-x)+x,M=n.min}if(u>=M&&u>n.max){if(M>n.max)continue;x=(n.max-u)/(M-u)*(v-x)+x,u=n.max}else if(M>=u&&M>n.max){if(u>n.max)continue;v=(n.max-u)/(M-u)*(v-x)+x,M=n.max}u==m&&x==r||a.moveTo(n.p2c(u)+e,s.p2c(x)+t);var g,w=n.p2c(u)+e,L=s.p2c(x)+t,X=n.p2c(M)+e,Y=s.p2c(v)+t;do{0==(g=function lineSegmentOffset(e){var a=Math.sqrt(Math.pow(X-w,2)+Math.pow(Y-L,2));if(a<=e)return{deltaX:X-w,deltaY:Y-L,distance:a,remainder:e-a};var i=X>w?1:-1,t=Y>L?1:-1;return{deltaX:i*Math.sqrt(Math.pow(e,2)/(1+Math.pow((Y-L)/(X-w),2))),deltaY:t*Math.sqrt(Math.pow(e,2)-Math.pow(e,2)/(1+Math.pow((Y-L)/(X-w),2))),distance:e,remainder:0}}(f>0?f:p?o:h)).deltaX&&0==g.deltaY||(p?a.lineTo(w+g.deltaX,L+g.deltaY):a.moveTo(w+g.deltaX,L+g.deltaY)),p=!p,f=g.remainder,w+=g.deltaX,L+=g.deltaY}while(g.distance>0);m=M,r=v}}a.stroke()}if(i.dashes.show){var t=e.getPlotOffset(),n=i.xaxis,s=i.yaxis;a.save(),a.translate(t.left,t.top),a.lineJoin="round";var o=i.dashes.lineWidth,h=i.shadowSize;if(o>0&&h>0){a.lineWidth=h,a.strokeStyle="rgba(0,0,0,0.1)";var l=Math.PI/18;plotDashes(Math.sin(l)*(o/2+h/2),Math.cos(l)*(o/2+h/2)),a.lineWidth=h/2,plotDashes(Math.sin(l)*(o/2+h/4),Math.cos(l)*(o/2+h/4))}a.lineWidth=o,a.strokeStyle=i.color,o>0&&plotDashes(0,0),a.restore()}})},options:{series:{dashes:{show:!1,lineWidth:2,dashLength:10}}},name:"dashes",version:"0.1"})}();
	!function(e,i,t){"$:nomunge";function h(t){!0===s&&(s=t||1);for(var a=r.length-1;a>=0;a--){var u=e(r[a]);if(u[0]==i||u.is(":visible")){var d=u.width(),f=u.height(),v=u.data(l);!v||d===v.w&&f===v.h||(u.trigger(m,[v.w=d,v.h=f]),s=t||!0)}else(v=u.data(l)).w=0,v.h=0}null!==n&&(s&&(null==t||t-s<1e3)?n=i.requestAnimationFrame(h):(n=setTimeout(h,o[c]),s=!1))}var n,r=[],o=e.resize=e.extend(e.resize,{}),s=!1,u="setTimeout",m="resize",l=m+"-special-event",c="pendingDelay",d="activeDelay",f="throttleWindow";o[c]=200,o[d]=20,o[f]=!0,e.event.special[m]={setup:function(){if(!o[f]&&this[u])return!1;var i=e(this);r.push(this),i.data(l,{w:i.width(),h:i.height()}),1===r.length&&(n=t,h())},teardown:function(){if(!o[f]&&this[u])return!1;for(var i=e(this),t=r.length-1;t>=0;t--)if(r[t]==this){r.splice(t,1);break}i.removeData(l),r.length||(s?cancelAnimationFrame(n):clearTimeout(n),n=null)},add:function(i){function a(i,a,r){var o=e(this),s=o.data(l)||{};s.w=a!==t?a:o.width(),s.h=r!==t?r:o.height(),n.apply(this,arguments)}if(!o[f]&&this[u])return!1;var n;if(e.isFunction(i))return n=i,a;n=i.handler,i.handler=a}},i.requestAnimationFrame||(i.requestAnimationFrame=i.webkitRequestAnimationFrame||i.mozRequestAnimationFrame||i.oRequestAnimationFrame||i.msRequestAnimationFrame||function(e,t){return i.setTimeout(function(){e((new Date).getTime())},o[d])}),i.cancelAnimationFrame||(i.cancelAnimationFrame=i.webkitCancelRequestAnimationFrame||i.mozCancelRequestAnimationFrame||i.oCancelRequestAnimationFrame||i.msCancelRequestAnimationFrame||clearTimeout)}(jQuery,this),function(e){var i={};jQuery.plot.plugins.push({init:function init(e){function onResize(){var i=e.getPlaceholder();0!=i.width()&&0!=i.height()&&(e.resize(),e.setupGrid(),e.draw())}e.hooks.bindEvents.push(function bindEvents(e,i){e.getPlaceholder().resize(onResize)}),e.hooks.shutdown.push(function shutdown(e,i){e.getPlaceholder().unbind("resize",onResize)})},options:i,name:"resize",version:"1.0"})}();
	!function(t){function e(r){var s,u=this,l=r.data||{};if(l.elem)u=r.dragTarget=l.elem,r.dragProxy=a.proxy||u,r.cursorOffsetX=l.pageX-l.left,r.cursorOffsetY=l.pageY-l.top,r.offsetX=r.pageX-r.cursorOffsetX,r.offsetY=r.pageY-r.cursorOffsetY;else if(a.dragging||l.which>0&&r.which!=l.which||t(r.target).is(l.not))return;switch(r.type){case"mousedown":return t.extend(l,t(u).offset(),{elem:u,target:r.target,pageX:r.pageX,pageY:r.pageY}),n.add(document,"mousemove mouseup",e,l),i(u,!1),a.dragging=null,!1;case!a.dragging&&"mousemove":if(g(r.pageX-l.pageX)+g(r.pageY-l.pageY)<l.distance)break;r.target=l.target,!1!==(s=f(r,"dragstart",u))&&(a.dragging=u,a.proxy=r.dragProxy=t(s||u)[0]);case"mousemove":if(a.dragging){if(s=f(r,"drag",u),o.drop&&(o.drop.allowed=!1!==s,o.drop.handler(r)),!1!==s)break;r.type="mouseup"}case"mouseup":n.remove(document,"mousemove mouseup",e),a.dragging&&(o.drop&&o.drop.handler(r),f(r,"dragend",u)),i(u,!0),a.dragging=a.proxy=l.elem=!1}return!0}function f(e,n,o){e.type=n;var a=t.event.dispatch.call(o,e);return!1!==a&&(a||e.result)}function g(e){return Math.pow(e,2)}function h(){return!1===a.dragging}function i(e,t){e&&(e.unselectable=t?"off":"on",e.onselectstart=function(){return t},e.style&&(e.style.MozUserSelect=t?"":"none"))}t.fn.drag=function(e,t,n){return t&&this.bind("dragstart",e),n&&this.bind("dragend",n),e?this.bind("drag",t||e):this.trigger("drag")};var n=t.event,o=n.special,a=o.drag={not:":input",distance:0,which:1,dragging:!1,setup:function(o){(o=t.extend({distance:a.distance,which:a.which,not:a.not},o||{})).distance=g(o.distance),n.add(this,"mousedown",e,o),this.attachEvent&&this.attachEvent("ondragstart",h)},teardown:function(){n.remove(this,"mousedown",e),this===a.dragging&&(a.dragging=a.proxy=!1),i(this,!0),this.detachEvent&&this.detachEvent("ondragstart",h)}};o.dragstart=o.dragend={setup:function(){},teardown:function(){}}}(jQuery),function(t){function e(e){var n=e||window.event,o=[].slice.call(arguments,1),a=0,r=0,i=0;return(e=t.event.fix(n)).type="mousewheel",n.wheelDelta&&(a=n.wheelDelta/120),n.detail&&(a=-n.detail/3),i=a,void 0!==n.axis&&n.axis===n.HORIZONTAL_AXIS&&(i=0,r=-1*a),void 0!==n.wheelDeltaY&&(i=n.wheelDeltaY/120),void 0!==n.wheelDeltaX&&(r=-1*n.wheelDeltaX/120),o.unshift(e,a,r,i),(t.event.dispatch||t.event.handle).apply(this,o)}var n=["DOMMouseScroll","mousewheel"];if(t.event.fixHooks)for(var o=n.length;o;)t.event.fixHooks[n[--o]]=t.event.mouseHooks;t.event.special.mousewheel={setup:function(){if(this.addEventListener)for(var t=n.length;t;)this.addEventListener(n[--t],e,!1);else this.onmousewheel=e},teardown:function(){if(this.removeEventListener)for(var t=n.length;t;)this.removeEventListener(n[--t],e,!1);else this.onmousewheel=null}},t.fn.extend({mousewheel:function(e){return e?this.bind("mousewheel",e):this.trigger("mousewheel")},unmousewheel:function(e){return this.unbind("mousewheel",e)}})}(jQuery),function(e){var t={xaxis:{zoomRange:null,panRange:null},zoom:{interactive:!1,trigger:"dblclick",amount:1.5},pan:{interactive:!1,cursor:"move",frameRate:20}};e.plot.plugins.push({init:function init(t){function onZoomClick(e,n){var o=t.offset();o.left=e.pageX-o.left,o.top=e.pageY-o.top,n?t.zoomOut({center:o}):t.zoom({center:o})}function onMouseWheel(e,t){return e.preventDefault(),onZoomClick(e,t<0),!1}function onDragStart(e){if(1!=e.which)return!1;var r=t.getPlaceholder().css("cursor");r&&(n=r),t.getPlaceholder().css("cursor",t.getOptions().pan.cursor),o=e.pageX,a=e.pageY}function onDrag(e){var n=t.getOptions().pan.frameRate;!r&&n&&(r=setTimeout(function(){t.pan({left:o-e.pageX,top:a-e.pageY}),o=e.pageX,a=e.pageY,r=null},1/n*1e3))}function onDragEnd(e){r&&(clearTimeout(r),r=null),t.getPlaceholder().css("cursor",n),t.pan({left:o-e.pageX,top:a-e.pageY})}var n="default",o=0,a=0,r=null;t.zoomOut=function(e){e||(e={}),e.amount||(e.amount=t.getOptions().zoom.amount),e.amount=1/e.amount,t.zoom(e)},t.zoom=function(n){n||(n={});var o=n.center,a=n.amount||t.getOptions().zoom.amount,r=t.width(),i=t.height();o||(o={left:r/2,top:i/2});var s=o.left/r,u=o.top/i,g={x:{min:o.left-s*r/a,max:o.left+(1-s)*r/a},y:{min:o.top-u*i/a,max:o.top+(1-u)*i/a}};e.each(t.getAxes(),function(e,t){var n=t.options,o=g[t.direction].min,r=g[t.direction].max,i=n.zoomRange,s=n.panRange;if(!1!==i){if(o=t.c2p(o),r=t.c2p(r),o>r){var u=o;o=r,r=u}s&&(null!=s[0]&&o<s[0]&&(o=s[0]),null!=s[1]&&r>s[1]&&(r=s[1]));var l=r-o;i&&(null!=i[0]&&l<i[0]&&a>1||null!=i[1]&&l>i[1]&&a<1)||(n.min=o,n.max=r)}}),t.setupGrid(),t.draw(),n.preventEvent||t.getPlaceholder().trigger("plotzoom",[t,n])},t.pan=function(n){var o={x:+n.left,y:+n.top};isNaN(o.x)&&(o.x=0),isNaN(o.y)&&(o.y=0),e.each(t.getAxes(),function(e,t){var n,a,r=t.options,i=o[t.direction];n=t.c2p(t.p2c(t.min)+i),a=t.c2p(t.p2c(t.max)+i);var s=r.panRange;!1!==s&&(s&&(null!=s[0]&&s[0]>n&&(n+=i=s[0]-n,a+=i),null!=s[1]&&s[1]<a&&(n+=i=s[1]-a,a+=i)),r.min=n,r.max=a)}),t.setupGrid(),t.draw(),n.preventEvent||t.getPlaceholder().trigger("plotpan",[t,n])},t.hooks.bindEvents.push(function bindEvents(e,t){var n=e.getOptions();n.zoom.interactive&&(t[n.zoom.trigger](onZoomClick),t.mousewheel(onMouseWheel)),n.pan.interactive&&(t.bind("dragstart",{distance:10},onDragStart),t.bind("drag",onDrag),t.bind("dragend",onDragEnd))}),t.hooks.shutdown.push(function shutdown(e,t){t.unbind(e.getOptions().zoom.trigger,onZoomClick),t.unbind("mousewheel",onMouseWheel),t.unbind("dragstart",onDragStart),t.unbind("drag",onDrag),t.unbind("dragend",onDragEnd),r&&clearTimeout(r)})},options:t,name:"navigate",version:"1.3"})}(jQuery);
	if("undefined"==typeof jQuery)throw new Error("Bootstrap's JavaScript requires jQuery");+function(t){"use strict";var e=jQuery.fn.jquery.split(" ")[0].split(".");if(e[0]<2&&e[1]<9||1==e[0]&&9==e[1]&&e[2]<1||e[0]>3)throw new Error("Bootstrap's JavaScript requires jQuery version 1.9.1 or higher, but lower than version 4")}(),function(t){"use strict";function transitionEnd(){var t=document.createElement("bootstrap"),e={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd otransitionend",transition:"transitionend"};for(var i in e)if(void 0!==t.style[i])return{end:e[i]};return!1}t.fn.emulateTransitionEnd=function(e){var i=!1,o=this;t(this).one("bsTransitionEnd",function(){i=!0});return setTimeout(function(){i||t(o).trigger(t.support.transition.end)},e),this},t(function(){t.support.transition=transitionEnd(),t.support.transition&&(t.event.special.bsTransitionEnd={bindType:t.support.transition.end,delegateType:t.support.transition.end,handle:function(e){if(t(e.target).is(this))return e.handleObj.handler.apply(this,arguments)}})})}(jQuery),function(t){"use strict";var e='[data-dismiss="alert"]',i=function(i){t(i).on("click",e,this.close)};i.VERSION="3.3.7",i.TRANSITION_DURATION=150,i.prototype.close=function(e){function removeElement(){s.detach().trigger("closed.bs.alert").remove()}var o=t(this),n=o.attr("data-target");n||(n=(n=o.attr("href"))&&n.replace(/.*(?=#[^\s]*$)/,""));var s=t("#"===n?[]:n);e&&e.preventDefault(),s.length||(s=o.closest(".alert")),s.trigger(e=t.Event("close.bs.alert")),e.isDefaultPrevented()||(s.removeClass("in"),t.support.transition&&s.hasClass("fade")?s.one("bsTransitionEnd",removeElement).emulateTransitionEnd(i.TRANSITION_DURATION):removeElement())};var o=t.fn.alert;t.fn.alert=function Plugin(e){return this.each(function(){var o=t(this),n=o.data("bs.alert");n||o.data("bs.alert",n=new i(this)),"string"==typeof e&&n[e].call(o)})},t.fn.alert.Constructor=i,t.fn.alert.noConflict=function(){return t.fn.alert=o,this},t(document).on("click.bs.alert.data-api",e,i.prototype.close)}(jQuery),function(t){"use strict";function Plugin(i){return this.each(function(){var o=t(this),n=o.data("bs.button"),s="object"==typeof i&&i;n||o.data("bs.button",n=new e(this,s)),"toggle"==i?n.toggle():i&&n.setState(i)})}var e=function(i,o){this.$element=t(i),this.options=t.extend({},e.DEFAULTS,o),this.isLoading=!1};e.VERSION="3.3.7",e.DEFAULTS={loadingText:"loading..."},e.prototype.setState=function(e){var i="disabled",o=this.$element,n=o.is("input")?"val":"html",s=o.data();e+="Text",null==s.resetText&&o.data("resetText",o[n]()),setTimeout(t.proxy(function(){o[n](null==s[e]?this.options[e]:s[e]),"loadingText"==e?(this.isLoading=!0,o.addClass(i).attr(i,i).prop(i,!0)):this.isLoading&&(this.isLoading=!1,o.removeClass(i).removeAttr(i).prop(i,!1))},this),0)},e.prototype.toggle=function(){var t=!0,e=this.$element.closest('[data-toggle="buttons"]');if(e.length){var i=this.$element.find("input");"radio"==i.prop("type")?(i.prop("checked")&&(t=!1),e.find(".active").removeClass("active"),this.$element.addClass("active")):"checkbox"==i.prop("type")&&(i.prop("checked")!==this.$element.hasClass("active")&&(t=!1),this.$element.toggleClass("active")),i.prop("checked",this.$element.hasClass("active")),t&&i.trigger("change")}else this.$element.attr("aria-pressed",!this.$element.hasClass("active")),this.$element.toggleClass("active")};var i=t.fn.button;t.fn.button=Plugin,t.fn.button.Constructor=e,t.fn.button.noConflict=function(){return t.fn.button=i,this},t(document).on("click.bs.button.data-api",'[data-toggle^="button"]',function(e){var i=t(e.target).closest(".btn");Plugin.call(i,"toggle"),t(e.target).is('input[type="radio"], input[type="checkbox"]')||(e.preventDefault(),i.is("input,button")?i.trigger("focus"):i.find("input:visible,button:visible").first().trigger("focus"))}).on("focus.bs.button.data-api blur.bs.button.data-api",'[data-toggle^="button"]',function(e){t(e.target).closest(".btn").toggleClass("focus",/^focus(in)?$/.test(e.type))})}(jQuery),function(t){"use strict";function Plugin(i){return this.each(function(){var o=t(this),n=o.data("bs.carousel"),s=t.extend({},e.DEFAULTS,o.data(),"object"==typeof i&&i),r="string"==typeof i?i:s.slide;n||o.data("bs.carousel",n=new e(this,s)),"number"==typeof i?n.to(i):r?n[r]():s.interval&&n.pause().cycle()})}var e=function(e,i){this.$element=t(e),this.$indicators=this.$element.find(".carousel-indicators"),this.options=i,this.paused=null,this.sliding=null,this.interval=null,this.$active=null,this.$items=null,this.options.keyboard&&this.$element.on("keydown.bs.carousel",t.proxy(this.keydown,this)),"hover"==this.options.pause&&!("ontouchstart"in document.documentElement)&&this.$element.on("mouseenter.bs.carousel",t.proxy(this.pause,this)).on("mouseleave.bs.carousel",t.proxy(this.cycle,this))};e.VERSION="3.3.7",e.TRANSITION_DURATION=600,e.DEFAULTS={interval:5e3,pause:"hover",wrap:!0,keyboard:!0},e.prototype.keydown=function(t){if(!/input|textarea/i.test(t.target.tagName)){switch(t.which){case 37:this.prev();break;case 39:this.next();break;default:return}t.preventDefault()}},e.prototype.cycle=function(e){return e||(this.paused=!1),this.interval&&clearInterval(this.interval),this.options.interval&&!this.paused&&(this.interval=setInterval(t.proxy(this.next,this),this.options.interval)),this},e.prototype.getItemIndex=function(t){return this.$items=t.parent().children(".item"),this.$items.index(t||this.$active)},e.prototype.getItemForDirection=function(t,e){var i=this.getItemIndex(e);if(("prev"==t&&0===i||"next"==t&&i==this.$items.length-1)&&!this.options.wrap)return e;var o=(i+("prev"==t?-1:1))%this.$items.length;return this.$items.eq(o)},e.prototype.to=function(t){var e=this,i=this.getItemIndex(this.$active=this.$element.find(".item.active"));if(!(t>this.$items.length-1||t<0))return this.sliding?this.$element.one("slid.bs.carousel",function(){e.to(t)}):i==t?this.pause().cycle():this.slide(t>i?"next":"prev",this.$items.eq(t))},e.prototype.pause=function(e){return e||(this.paused=!0),this.$element.find(".next, .prev").length&&t.support.transition&&(this.$element.trigger(t.support.transition.end),this.cycle(!0)),this.interval=clearInterval(this.interval),this},e.prototype.next=function(){if(!this.sliding)return this.slide("next")},e.prototype.prev=function(){if(!this.sliding)return this.slide("prev")},e.prototype.slide=function(i,o){var n=this.$element.find(".item.active"),s=o||this.getItemForDirection(i,n),r=this.interval,a="next"==i?"left":"right",l=this;if(s.hasClass("active"))return this.sliding=!1;var h=s[0],d=t.Event("slide.bs.carousel",{relatedTarget:h,direction:a});if(this.$element.trigger(d),!d.isDefaultPrevented()){if(this.sliding=!0,r&&this.pause(),this.$indicators.length){this.$indicators.find(".active").removeClass("active");var p=t(this.$indicators.children()[this.getItemIndex(s)]);p&&p.addClass("active")}var c=t.Event("slid.bs.carousel",{relatedTarget:h,direction:a});return t.support.transition&&this.$element.hasClass("slide")?(s.addClass(i),s[0].offsetWidth,n.addClass(a),s.addClass(a),n.one("bsTransitionEnd",function(){s.removeClass([i,a].join(" ")).addClass("active"),n.removeClass(["active",a].join(" ")),l.sliding=!1,setTimeout(function(){l.$element.trigger(c)},0)}).emulateTransitionEnd(e.TRANSITION_DURATION)):(n.removeClass("active"),s.addClass("active"),this.sliding=!1,this.$element.trigger(c)),r&&this.cycle(),this}};var i=t.fn.carousel;t.fn.carousel=Plugin,t.fn.carousel.Constructor=e,t.fn.carousel.noConflict=function(){return t.fn.carousel=i,this};var o=function(e){var i,o=t(this),n=t(o.attr("data-target")||(i=o.attr("href"))&&i.replace(/.*(?=#[^\s]+$)/,""));if(n.hasClass("carousel")){var s=t.extend({},n.data(),o.data()),r=o.attr("data-slide-to");r&&(s.interval=!1),Plugin.call(n,s),r&&n.data("bs.carousel").to(r),e.preventDefault()}};t(document).on("click.bs.carousel.data-api","[data-slide]",o).on("click.bs.carousel.data-api","[data-slide-to]",o),t(window).on("load",function(){t('[data-ride="carousel"]').each(function(){var e=t(this);Plugin.call(e,e.data())})})}(jQuery),function(t){"use strict";function getTargetFromTrigger(e){var i,o=e.attr("data-target")||(i=e.attr("href"))&&i.replace(/.*(?=#[^\s]+$)/,"");return t(o)}function Plugin(i){return this.each(function(){var o=t(this),n=o.data("bs.collapse"),s=t.extend({},e.DEFAULTS,o.data(),"object"==typeof i&&i);!n&&s.toggle&&/show|hide/.test(i)&&(s.toggle=!1),n||o.data("bs.collapse",n=new e(this,s)),"string"==typeof i&&n[i]()})}var e=function(i,o){this.$element=t(i),this.options=t.extend({},e.DEFAULTS,o),this.$trigger=t('[data-toggle="collapse"][href="#'+i.id+'"],[data-toggle="collapse"][data-target="#'+i.id+'"]'),this.transitioning=null,this.options.parent?this.$parent=this.getParent():this.addAriaAndCollapsedClass(this.$element,this.$trigger),this.options.toggle&&this.toggle()};e.VERSION="3.3.7",e.TRANSITION_DURATION=350,e.DEFAULTS={toggle:!0},e.prototype.dimension=function(){return this.$element.hasClass("width")?"width":"height"},e.prototype.show=function(){if(!this.transitioning&&!this.$element.hasClass("in")){var i,o=this.$parent&&this.$parent.children(".panel").children(".in, .collapsing");if(!(o&&o.length&&(i=o.data("bs.collapse"))&&i.transitioning)){var n=t.Event("show.bs.collapse");if(this.$element.trigger(n),!n.isDefaultPrevented()){o&&o.length&&(Plugin.call(o,"hide"),i||o.data("bs.collapse",null));var s=this.dimension();this.$element.removeClass("collapse").addClass("collapsing")[s](0).attr("aria-expanded",!0),this.$trigger.removeClass("collapsed").attr("aria-expanded",!0),this.transitioning=1;var r=function(){this.$element.removeClass("collapsing").addClass("collapse in")[s](""),this.transitioning=0,this.$element.trigger("shown.bs.collapse")};if(!t.support.transition)return r.call(this);var a=t.camelCase(["scroll",s].join("-"));this.$element.one("bsTransitionEnd",t.proxy(r,this)).emulateTransitionEnd(e.TRANSITION_DURATION)[s](this.$element[0][a])}}}},e.prototype.hide=function(){if(!this.transitioning&&this.$element.hasClass("in")){var i=t.Event("hide.bs.collapse");if(this.$element.trigger(i),!i.isDefaultPrevented()){var o=this.dimension();this.$element[o](this.$element[o]())[0].offsetHeight,this.$element.addClass("collapsing").removeClass("collapse in").attr("aria-expanded",!1),this.$trigger.addClass("collapsed").attr("aria-expanded",!1),this.transitioning=1;var n=function(){this.transitioning=0,this.$element.removeClass("collapsing").addClass("collapse").trigger("hidden.bs.collapse")};if(!t.support.transition)return n.call(this);this.$element[o](0).one("bsTransitionEnd",t.proxy(n,this)).emulateTransitionEnd(e.TRANSITION_DURATION)}}},e.prototype.toggle=function(){this[this.$element.hasClass("in")?"hide":"show"]()},e.prototype.getParent=function(){return t(this.options.parent).find('[data-toggle="collapse"][data-parent="'+this.options.parent+'"]').each(t.proxy(function(e,i){var o=t(i);this.addAriaAndCollapsedClass(getTargetFromTrigger(o),o)},this)).end()},e.prototype.addAriaAndCollapsedClass=function(t,e){var i=t.hasClass("in");t.attr("aria-expanded",i),e.toggleClass("collapsed",!i).attr("aria-expanded",i)};var i=t.fn.collapse;t.fn.collapse=Plugin,t.fn.collapse.Constructor=e,t.fn.collapse.noConflict=function(){return t.fn.collapse=i,this},t(document).on("click.bs.collapse.data-api",'[data-toggle="collapse"]',function(e){var i=t(this);i.attr("data-target")||e.preventDefault();var o=getTargetFromTrigger(i),n=o.data("bs.collapse")?"toggle":i.data();Plugin.call(o,n)})}(jQuery),function(t){"use strict";function getParent(e){var i=e.attr("data-target");i||(i=(i=e.attr("href"))&&/#[A-Za-z]/.test(i)&&i.replace(/.*(?=#[^\s]*$)/,""));var o=i&&t(i);return o&&o.length?o:e.parent()}function clearMenus(o){o&&3===o.which||(t(e).remove(),t(i).each(function(){var e=t(this),i=getParent(e),n={relatedTarget:this};i.hasClass("open")&&(o&&"click"==o.type&&/input|textarea/i.test(o.target.tagName)&&t.contains(i[0],o.target)||(i.trigger(o=t.Event("hide.bs.dropdown",n)),o.isDefaultPrevented()||(e.attr("aria-expanded","false"),i.removeClass("open").trigger(t.Event("hidden.bs.dropdown",n)))))}))}var e=".dropdown-backdrop",i='[data-toggle="dropdown"]',o=function(e){t(e).on("click.bs.dropdown",this.toggle)};o.VERSION="3.3.7",o.prototype.toggle=function(e){var i=t(this);if(!i.is(".disabled, :disabled")){var o=getParent(i),n=o.hasClass("open");if(clearMenus(),!n){"ontouchstart"in document.documentElement&&!o.closest(".navbar-nav").length&&t(document.createElement("div")).addClass("dropdown-backdrop").insertAfter(t(this)).on("click",clearMenus);var s={relatedTarget:this};if(o.trigger(e=t.Event("show.bs.dropdown",s)),e.isDefaultPrevented())return;i.trigger("focus").attr("aria-expanded","true"),o.toggleClass("open").trigger(t.Event("shown.bs.dropdown",s))}return!1}},o.prototype.keydown=function(e){if(/(38|40|27|32)/.test(e.which)&&!/input|textarea/i.test(e.target.tagName)){var o=t(this);if(e.preventDefault(),e.stopPropagation(),!o.is(".disabled, :disabled")){var n=getParent(o),s=n.hasClass("open");if(!s&&27!=e.which||s&&27==e.which)return 27==e.which&&n.find(i).trigger("focus"),o.trigger("click");var r=n.find(".dropdown-menu li:not(.disabled):visible a");if(r.length){var a=r.index(e.target);38==e.which&&a>0&&a--,40==e.which&&a<r.length-1&&a++,~a||(a=0),r.eq(a).trigger("focus")}}}};var n=t.fn.dropdown;t.fn.dropdown=function Plugin(e){return this.each(function(){var i=t(this),n=i.data("bs.dropdown");n||i.data("bs.dropdown",n=new o(this)),"string"==typeof e&&n[e].call(i)})},t.fn.dropdown.Constructor=o,t.fn.dropdown.noConflict=function(){return t.fn.dropdown=n,this},t(document).on("click.bs.dropdown.data-api",clearMenus).on("click.bs.dropdown.data-api",".dropdown form",function(t){t.stopPropagation()}).on("click.bs.dropdown.data-api",i,o.prototype.toggle).on("keydown.bs.dropdown.data-api",i,o.prototype.keydown).on("keydown.bs.dropdown.data-api",".dropdown-menu",o.prototype.keydown)}(jQuery),function(t){"use strict";function Plugin(i,o){return this.each(function(){var n=t(this),s=n.data("bs.modal"),r=t.extend({},e.DEFAULTS,n.data(),"object"==typeof i&&i);s||n.data("bs.modal",s=new e(this,r)),"string"==typeof i?s[i](o):r.show&&s.show(o)})}var e=function(e,i){this.options=i,this.$body=t(document.body),this.$element=t(e),this.$dialog=this.$element.find(".modal-dialog"),this.$backdrop=null,this.isShown=null,this.originalBodyPad=null,this.scrollbarWidth=0,this.ignoreBackdropClick=!1,this.options.remote&&this.$element.find(".modal-content").load(this.options.remote,t.proxy(function(){this.$element.trigger("loaded.bs.modal")},this))};e.VERSION="3.3.7",e.TRANSITION_DURATION=300,e.BACKDROP_TRANSITION_DURATION=150,e.DEFAULTS={backdrop:!0,keyboard:!0,show:!0},e.prototype.toggle=function(t){return this.isShown?this.hide():this.show(t)},e.prototype.show=function(i){var o=this,n=t.Event("show.bs.modal",{relatedTarget:i});this.$element.trigger(n),this.isShown||n.isDefaultPrevented()||(this.isShown=!0,this.checkScrollbar(),this.setScrollbar(),this.$body.addClass("modal-open"),this.escape(),this.resize(),this.$element.on("click.dismiss.bs.modal",'[data-dismiss="modal"]',t.proxy(this.hide,this)),this.$dialog.on("mousedown.dismiss.bs.modal",function(){o.$element.one("mouseup.dismiss.bs.modal",function(e){t(e.target).is(o.$element)&&(o.ignoreBackdropClick=!0)})}),this.backdrop(function(){var n=t.support.transition&&o.$element.hasClass("fade");o.$element.parent().length||o.$element.appendTo(o.$body),o.$element.show().scrollTop(0),o.adjustDialog(),n&&o.$element[0].offsetWidth,o.$element.addClass("in"),o.enforceFocus();var s=t.Event("shown.bs.modal",{relatedTarget:i});n?o.$dialog.one("bsTransitionEnd",function(){o.$element.trigger("focus").trigger(s)}).emulateTransitionEnd(e.TRANSITION_DURATION):o.$element.trigger("focus").trigger(s)}))},e.prototype.hide=function(i){i&&i.preventDefault(),i=t.Event("hide.bs.modal"),this.$element.trigger(i),this.isShown&&!i.isDefaultPrevented()&&(this.isShown=!1,this.escape(),this.resize(),t(document).off("focusin.bs.modal"),this.$element.removeClass("in").off("click.dismiss.bs.modal").off("mouseup.dismiss.bs.modal"),this.$dialog.off("mousedown.dismiss.bs.modal"),t.support.transition&&this.$element.hasClass("fade")?this.$element.one("bsTransitionEnd",t.proxy(this.hideModal,this)).emulateTransitionEnd(e.TRANSITION_DURATION):this.hideModal())},e.prototype.enforceFocus=function(){t(document).off("focusin.bs.modal").on("focusin.bs.modal",t.proxy(function(t){document===t.target||this.$element[0]===t.target||this.$element.has(t.target).length||this.$element.trigger("focus")},this))},e.prototype.escape=function(){this.isShown&&this.options.keyboard?this.$element.on("keydown.dismiss.bs.modal",t.proxy(function(t){27==t.which&&this.hide()},this)):this.isShown||this.$element.off("keydown.dismiss.bs.modal")},e.prototype.resize=function(){this.isShown?t(window).on("resize.bs.modal",t.proxy(this.handleUpdate,this)):t(window).off("resize.bs.modal")},e.prototype.hideModal=function(){var t=this;this.$element.hide(),this.backdrop(function(){t.$body.removeClass("modal-open"),t.resetAdjustments(),t.resetScrollbar(),t.$element.trigger("hidden.bs.modal")})},e.prototype.removeBackdrop=function(){this.$backdrop&&this.$backdrop.remove(),this.$backdrop=null},e.prototype.backdrop=function(i){var o=this,n=this.$element.hasClass("fade")?"fade":"";if(this.isShown&&this.options.backdrop){var s=t.support.transition&&n;if(this.$backdrop=t(document.createElement("div")).addClass("modal-backdrop "+n).appendTo(this.$body),this.$element.on("click.dismiss.bs.modal",t.proxy(function(t){this.ignoreBackdropClick?this.ignoreBackdropClick=!1:t.target===t.currentTarget&&("static"==this.options.backdrop?this.$element[0].focus():this.hide())},this)),s&&this.$backdrop[0].offsetWidth,this.$backdrop.addClass("in"),!i)return;s?this.$backdrop.one("bsTransitionEnd",i).emulateTransitionEnd(e.BACKDROP_TRANSITION_DURATION):i()}else if(!this.isShown&&this.$backdrop){this.$backdrop.removeClass("in");var r=function(){o.removeBackdrop(),i&&i()};t.support.transition&&this.$element.hasClass("fade")?this.$backdrop.one("bsTransitionEnd",r).emulateTransitionEnd(e.BACKDROP_TRANSITION_DURATION):r()}else i&&i()},e.prototype.handleUpdate=function(){this.adjustDialog()},e.prototype.adjustDialog=function(){var t=this.$element[0].scrollHeight>document.documentElement.clientHeight;this.$element.css({paddingLeft:!this.bodyIsOverflowing&&t?this.scrollbarWidth:"",paddingRight:this.bodyIsOverflowing&&!t?this.scrollbarWidth:""})},e.prototype.resetAdjustments=function(){this.$element.css({paddingLeft:"",paddingRight:""})},e.prototype.checkScrollbar=function(){var t=window.innerWidth;if(!t){var e=document.documentElement.getBoundingClientRect();t=e.right-Math.abs(e.left)}this.bodyIsOverflowing=document.body.clientWidth<t,this.scrollbarWidth=this.measureScrollbar()},e.prototype.setScrollbar=function(){var t=parseInt(this.$body.css("padding-right")||0,10);this.originalBodyPad=document.body.style.paddingRight||"",this.bodyIsOverflowing&&this.$body.css("padding-right",t+this.scrollbarWidth)},e.prototype.resetScrollbar=function(){this.$body.css("padding-right",this.originalBodyPad)},e.prototype.measureScrollbar=function(){var t=document.createElement("div");t.className="modal-scrollbar-measure",this.$body.append(t);var e=t.offsetWidth-t.clientWidth;return this.$body[0].removeChild(t),e};var i=t.fn.modal;t.fn.modal=Plugin,t.fn.modal.Constructor=e,t.fn.modal.noConflict=function(){return t.fn.modal=i,this},t(document).on("click.bs.modal.data-api",'[data-toggle="modal"]',function(e){var i=t(this),o=i.attr("href"),n=t(i.attr("data-target")||o&&o.replace(/.*(?=#[^\s]+$)/,"")),s=n.data("bs.modal")?"toggle":t.extend({remote:!/#/.test(o)&&o},n.data(),i.data());i.is("a")&&e.preventDefault(),n.one("show.bs.modal",function(t){t.isDefaultPrevented()||n.one("hidden.bs.modal",function(){i.is(":visible")&&i.trigger("focus")})}),Plugin.call(n,s,this)})}(jQuery),function(t){"use strict";var e=function(t,e){this.type=null,this.options=null,this.enabled=null,this.timeout=null,this.hoverState=null,this.$element=null,this.inState=null,this.init("tooltip",t,e)};e.VERSION="3.3.7",e.TRANSITION_DURATION=150,e.DEFAULTS={animation:!0,placement:"top",selector:!1,template:'<div class="tooltip" role="tooltip"><div class="tooltip-arrow"></div><div class="tooltip-inner"></div></div>',trigger:"hover focus",title:"",delay:0,html:!1,container:!1,viewport:{selector:"body",padding:0}},e.prototype.init=function(e,i,o){if(this.enabled=!0,this.type=e,this.$element=t(i),this.options=this.getOptions(o),this.$viewport=this.options.viewport&&t(t.isFunction(this.options.viewport)?this.options.viewport.call(this,this.$element):this.options.viewport.selector||this.options.viewport),this.inState={click:!1,hover:!1,focus:!1},this.$element[0]instanceof document.constructor&&!this.options.selector)throw new Error("`selector` option must be specified when initializing "+this.type+" on the window.document object!");for(var n=this.options.trigger.split(" "),s=n.length;s--;){var r=n[s];if("click"==r)this.$element.on("click."+this.type,this.options.selector,t.proxy(this.toggle,this));else if("manual"!=r){var a="hover"==r?"mouseenter":"focusin",l="hover"==r?"mouseleave":"focusout";this.$element.on(a+"."+this.type,this.options.selector,t.proxy(this.enter,this)),this.$element.on(l+"."+this.type,this.options.selector,t.proxy(this.leave,this))}}this.options.selector?this._options=t.extend({},this.options,{trigger:"manual",selector:""}):this.fixTitle()},e.prototype.getDefaults=function(){return e.DEFAULTS},e.prototype.getOptions=function(e){return(e=t.extend({},this.getDefaults(),this.$element.data(),e)).delay&&"number"==typeof e.delay&&(e.delay={show:e.delay,hide:e.delay}),e},e.prototype.getDelegateOptions=function(){var e={},i=this.getDefaults();return this._options&&t.each(this._options,function(t,o){i[t]!=o&&(e[t]=o)}),e},e.prototype.enter=function(e){var i=e instanceof this.constructor?e:t(e.currentTarget).data("bs."+this.type);if(i||(i=new this.constructor(e.currentTarget,this.getDelegateOptions()),t(e.currentTarget).data("bs."+this.type,i)),e instanceof t.Event&&(i.inState["focusin"==e.type?"focus":"hover"]=!0),i.tip().hasClass("in")||"in"==i.hoverState)i.hoverState="in";else{if(clearTimeout(i.timeout),i.hoverState="in",!i.options.delay||!i.options.delay.show)return i.show();i.timeout=setTimeout(function(){"in"==i.hoverState&&i.show()},i.options.delay.show)}},e.prototype.isInStateTrue=function(){for(var t in this.inState)if(this.inState[t])return!0;return!1},e.prototype.leave=function(e){var i=e instanceof this.constructor?e:t(e.currentTarget).data("bs."+this.type);if(i||(i=new this.constructor(e.currentTarget,this.getDelegateOptions()),t(e.currentTarget).data("bs."+this.type,i)),e instanceof t.Event&&(i.inState["focusout"==e.type?"focus":"hover"]=!1),!i.isInStateTrue()){if(clearTimeout(i.timeout),i.hoverState="out",!i.options.delay||!i.options.delay.hide)return i.hide();i.timeout=setTimeout(function(){"out"==i.hoverState&&i.hide()},i.options.delay.hide)}},e.prototype.show=function(){var i=t.Event("show.bs."+this.type);if(this.hasContent()&&this.enabled){this.$element.trigger(i);var o=t.contains(this.$element[0].ownerDocument.documentElement,this.$element[0]);if(i.isDefaultPrevented()||!o)return;var n=this,s=this.tip(),r=this.getUID(this.type);this.setContent(),s.attr("id",r),this.$element.attr("aria-describedby",r),this.options.animation&&s.addClass("fade");var a="function"==typeof this.options.placement?this.options.placement.call(this,s[0],this.$element[0]):this.options.placement,l=/\s?auto?\s?/i,h=l.test(a);h&&(a=a.replace(l,"")||"top"),s.detach().css({top:0,left:0,display:"block"}).addClass(a).data("bs."+this.type,this),this.options.container?s.appendTo(this.options.container):s.insertAfter(this.$element),this.$element.trigger("inserted.bs."+this.type);var d=this.getPosition(),p=s[0].offsetWidth,c=s[0].offsetHeight;if(h){var f=a,u=this.getPosition(this.$viewport);a="bottom"==a&&d.bottom+c>u.bottom?"top":"top"==a&&d.top-c<u.top?"bottom":"right"==a&&d.right+p>u.width?"left":"left"==a&&d.left-p<u.left?"right":a,s.removeClass(f).addClass(a)}var g=this.getCalculatedOffset(a,d,p,c);this.applyPlacement(g,a);var m=function(){var t=n.hoverState;n.$element.trigger("shown.bs."+n.type),n.hoverState=null,"out"==t&&n.leave(n)};t.support.transition&&this.$tip.hasClass("fade")?s.one("bsTransitionEnd",m).emulateTransitionEnd(e.TRANSITION_DURATION):m()}},e.prototype.applyPlacement=function(e,i){var o=this.tip(),n=o[0].offsetWidth,s=o[0].offsetHeight,r=parseInt(o.css("margin-top"),10),a=parseInt(o.css("margin-left"),10);isNaN(r)&&(r=0),isNaN(a)&&(a=0),e.top+=r,e.left+=a,t.offset.setOffset(o[0],t.extend({using:function(t){o.css({top:Math.round(t.top),left:Math.round(t.left)})}},e),0),o.addClass("in");var l=o[0].offsetWidth,h=o[0].offsetHeight;"top"==i&&h!=s&&(e.top=e.top+s-h);var d=this.getViewportAdjustedDelta(i,e,l,h);d.left?e.left+=d.left:e.top+=d.top;var p=/top|bottom/.test(i),c=p?2*d.left-n+l:2*d.top-s+h,f=p?"offsetWidth":"offsetHeight";o.offset(e),this.replaceArrow(c,o[0][f],p)},e.prototype.replaceArrow=function(t,e,i){this.arrow().css(i?"left":"top",50*(1-t/e)+"%").css(i?"top":"left","")},e.prototype.setContent=function(){var t=this.tip(),e=this.getTitle();t.find(".tooltip-inner")[this.options.html?"html":"text"](e),t.removeClass("fade in top bottom left right")},e.prototype.hide=function(i){function complete(){"in"!=o.hoverState&&n.detach(),o.$element&&o.$element.removeAttr("aria-describedby").trigger("hidden.bs."+o.type),i&&i()}var o=this,n=t(this.$tip),s=t.Event("hide.bs."+this.type);if(this.$element.trigger(s),!s.isDefaultPrevented())return n.removeClass("in"),t.support.transition&&n.hasClass("fade")?n.one("bsTransitionEnd",complete).emulateTransitionEnd(e.TRANSITION_DURATION):complete(),this.hoverState=null,this},e.prototype.fixTitle=function(){var t=this.$element;(t.attr("title")||"string"!=typeof t.attr("data-original-title"))&&t.attr("data-original-title",t.attr("title")||"").attr("title","")},e.prototype.hasContent=function(){return this.getTitle()},e.prototype.getPosition=function(e){var i=(e=e||this.$element)[0],o="BODY"==i.tagName,n=i.getBoundingClientRect();null==n.width&&(n=t.extend({},n,{width:n.right-n.left,height:n.bottom-n.top}));var s=window.SVGElement&&i instanceof window.SVGElement,r=o?{top:0,left:0}:s?null:e.offset(),a={scroll:o?document.documentElement.scrollTop||document.body.scrollTop:e.scrollTop()},l=o?{width:t(window).width(),height:t(window).height()}:null;return t.extend({},n,a,l,r)},e.prototype.getCalculatedOffset=function(t,e,i,o){return"bottom"==t?{top:e.top+e.height,left:e.left+e.width/2-i/2}:"top"==t?{top:e.top-o,left:e.left+e.width/2-i/2}:"left"==t?{top:e.top+e.height/2-o/2,left:e.left-i}:{top:e.top+e.height/2-o/2,left:e.left+e.width}},e.prototype.getViewportAdjustedDelta=function(t,e,i,o){var n={top:0,left:0};if(!this.$viewport)return n;var s=this.options.viewport&&this.options.viewport.padding||0,r=this.getPosition(this.$viewport);if(/right|left/.test(t)){var a=e.top-s-r.scroll,l=e.top+s-r.scroll+o;a<r.top?n.top=r.top-a:l>r.top+r.height&&(n.top=r.top+r.height-l)}else{var h=e.left-s,d=e.left+s+i;h<r.left?n.left=r.left-h:d>r.right&&(n.left=r.left+r.width-d)}return n},e.prototype.getTitle=function(){var t=this.$element,e=this.options;return t.attr("data-original-title")||("function"==typeof e.title?e.title.call(t[0]):e.title)},e.prototype.getUID=function(t){do{t+=~~(1e6*Math.random())}while(document.getElementById(t));return t},e.prototype.tip=function(){if(!this.$tip&&(this.$tip=t(this.options.template),1!=this.$tip.length))throw new Error(this.type+" `template` option must consist of exactly 1 top-level element!");return this.$tip},e.prototype.arrow=function(){return this.$arrow=this.$arrow||this.tip().find(".tooltip-arrow")},e.prototype.enable=function(){this.enabled=!0},e.prototype.disable=function(){this.enabled=!1},e.prototype.toggleEnabled=function(){this.enabled=!this.enabled},e.prototype.toggle=function(e){var i=this;e&&((i=t(e.currentTarget).data("bs."+this.type))||(i=new this.constructor(e.currentTarget,this.getDelegateOptions()),t(e.currentTarget).data("bs."+this.type,i))),e?(i.inState.click=!i.inState.click,i.isInStateTrue()?i.enter(i):i.leave(i)):i.tip().hasClass("in")?i.leave(i):i.enter(i)},e.prototype.destroy=function(){var t=this;clearTimeout(this.timeout),this.hide(function(){t.$element.off("."+t.type).removeData("bs."+t.type),t.$tip&&t.$tip.detach(),t.$tip=null,t.$arrow=null,t.$viewport=null,t.$element=null})};var i=t.fn.tooltip;t.fn.tooltip=function Plugin(i){return this.each(function(){var o=t(this),n=o.data("bs.tooltip"),s="object"==typeof i&&i;!n&&/destroy|hide/.test(i)||(n||o.data("bs.tooltip",n=new e(this,s)),"string"==typeof i&&n[i]())})},t.fn.tooltip.Constructor=e,t.fn.tooltip.noConflict=function(){return t.fn.tooltip=i,this}}(jQuery),function(t){"use strict";var e=function(t,e){this.init("popover",t,e)};if(!t.fn.tooltip)throw new Error("Popover requires tooltip.js");e.VERSION="3.3.7",e.DEFAULTS=t.extend({},t.fn.tooltip.Constructor.DEFAULTS,{placement:"right",trigger:"click",content:"",template:'<div class="popover" role="tooltip"><div class="arrow"></div><h3 class="popover-title"></h3><div class="popover-content"></div></div>'}),e.prototype=t.extend({},t.fn.tooltip.Constructor.prototype),e.prototype.constructor=e,e.prototype.getDefaults=function(){return e.DEFAULTS},e.prototype.setContent=function(){var t=this.tip(),e=this.getTitle(),i=this.getContent();t.find(".popover-title")[this.options.html?"html":"text"](e),t.find(".popover-content").children().detach().end()[this.options.html?"string"==typeof i?"html":"append":"text"](i),t.removeClass("fade top bottom left right in"),t.find(".popover-title").html()||t.find(".popover-title").hide()},e.prototype.hasContent=function(){return this.getTitle()||this.getContent()},e.prototype.getContent=function(){var t=this.$element,e=this.options;return t.attr("data-content")||("function"==typeof e.content?e.content.call(t[0]):e.content)},e.prototype.arrow=function(){return this.$arrow=this.$arrow||this.tip().find(".arrow")};var i=t.fn.popover;t.fn.popover=function Plugin(i){return this.each(function(){var o=t(this),n=o.data("bs.popover"),s="object"==typeof i&&i;!n&&/destroy|hide/.test(i)||(n||o.data("bs.popover",n=new e(this,s)),"string"==typeof i&&n[i]())})},t.fn.popover.Constructor=e,t.fn.popover.noConflict=function(){return t.fn.popover=i,this}}(jQuery),function(t){"use strict";function ScrollSpy(e,i){this.$body=t(document.body),this.$scrollElement=t(t(e).is(document.body)?window:e),this.options=t.extend({},ScrollSpy.DEFAULTS,i),this.selector=(this.options.target||"")+" .nav li > a",this.offsets=[],this.targets=[],this.activeTarget=null,this.scrollHeight=0,this.$scrollElement.on("scroll.bs.scrollspy",t.proxy(this.process,this)),this.refresh(),this.process()}function Plugin(e){return this.each(function(){var i=t(this),o=i.data("bs.scrollspy"),n="object"==typeof e&&e;o||i.data("bs.scrollspy",o=new ScrollSpy(this,n)),"string"==typeof e&&o[e]()})}ScrollSpy.VERSION="3.3.7",ScrollSpy.DEFAULTS={offset:10},ScrollSpy.prototype.getScrollHeight=function(){return this.$scrollElement[0].scrollHeight||Math.max(this.$body[0].scrollHeight,document.documentElement.scrollHeight)},ScrollSpy.prototype.refresh=function(){var e=this,i="offset",o=0;this.offsets=[],this.targets=[],this.scrollHeight=this.getScrollHeight(),t.isWindow(this.$scrollElement[0])||(i="position",o=this.$scrollElement.scrollTop()),this.$body.find(this.selector).map(function(){var e=t(this),n=e.data("target")||e.attr("href"),s=/^#./.test(n)&&t(n);return s&&s.length&&s.is(":visible")&&[[s[i]().top+o,n]]||null}).sort(function(t,e){return t[0]-e[0]}).each(function(){e.offsets.push(this[0]),e.targets.push(this[1])})},ScrollSpy.prototype.process=function(){var t,e=this.$scrollElement.scrollTop()+this.options.offset,i=this.getScrollHeight(),o=this.options.offset+i-this.$scrollElement.height(),n=this.offsets,s=this.targets,r=this.activeTarget;if(this.scrollHeight!=i&&this.refresh(),e>=o)return r!=(t=s[s.length-1])&&this.activate(t);if(r&&e<n[0])return this.activeTarget=null,this.clear();for(t=n.length;t--;)r!=s[t]&&e>=n[t]&&(void 0===n[t+1]||e<n[t+1])&&this.activate(s[t])},ScrollSpy.prototype.activate=function(e){this.activeTarget=e,this.clear();var i=this.selector+'[data-target="'+e+'"],'+this.selector+'[href="'+e+'"]',o=t(i).parents("li").addClass("active");o.parent(".dropdown-menu").length&&(o=o.closest("li.dropdown").addClass("active")),o.trigger("activate.bs.scrollspy")},ScrollSpy.prototype.clear=function(){t(this.selector).parentsUntil(this.options.target,".active").removeClass("active")};var e=t.fn.scrollspy;t.fn.scrollspy=Plugin,t.fn.scrollspy.Constructor=ScrollSpy,t.fn.scrollspy.noConflict=function(){return t.fn.scrollspy=e,this},t(window).on("load.bs.scrollspy.data-api",function(){t('[data-spy="scroll"]').each(function(){var e=t(this);Plugin.call(e,e.data())})})}(jQuery),function(t){"use strict";function Plugin(i){return this.each(function(){var o=t(this),n=o.data("bs.tab");n||o.data("bs.tab",n=new e(this)),"string"==typeof i&&n[i]()})}var e=function(e){this.element=t(e)};e.VERSION="3.3.7",e.TRANSITION_DURATION=150,e.prototype.show=function(){var e=this.element,i=e.closest("ul:not(.dropdown-menu)"),o=e.data("target");if(o||(o=(o=e.attr("href"))&&o.replace(/.*(?=#[^\s]*$)/,"")),!e.parent("li").hasClass("active")){var n=i.find(".active:last a"),s=t.Event("hide.bs.tab",{relatedTarget:e[0]}),r=t.Event("show.bs.tab",{relatedTarget:n[0]});if(n.trigger(s),e.trigger(r),!r.isDefaultPrevented()&&!s.isDefaultPrevented()){var a=t(o);this.activate(e.closest("li"),i),this.activate(a,a.parent(),function(){n.trigger({type:"hidden.bs.tab",relatedTarget:e[0]}),e.trigger({type:"shown.bs.tab",relatedTarget:n[0]})})}}},e.prototype.activate=function(i,o,n){function next(){s.removeClass("active").find("> .dropdown-menu > .active").removeClass("active").end().find('[data-toggle="tab"]').attr("aria-expanded",!1),i.addClass("active").find('[data-toggle="tab"]').attr("aria-expanded",!0),r?(i[0].offsetWidth,i.addClass("in")):i.removeClass("fade"),i.parent(".dropdown-menu").length&&i.closest("li.dropdown").addClass("active").end().find('[data-toggle="tab"]').attr("aria-expanded",!0),n&&n()}var s=o.find("> .active"),r=n&&t.support.transition&&(s.length&&s.hasClass("fade")||!!o.find("> .fade").length);s.length&&r?s.one("bsTransitionEnd",next).emulateTransitionEnd(e.TRANSITION_DURATION):next(),s.removeClass("in")};var i=t.fn.tab;t.fn.tab=Plugin,t.fn.tab.Constructor=e,t.fn.tab.noConflict=function(){return t.fn.tab=i,this};var o=function(e){e.preventDefault(),Plugin.call(t(this),"show")};t(document).on("click.bs.tab.data-api",'[data-toggle="tab"]',o).on("click.bs.tab.data-api",'[data-toggle="pill"]',o)}(jQuery),function(t){"use strict";function Plugin(i){return this.each(function(){var o=t(this),n=o.data("bs.affix"),s="object"==typeof i&&i;n||o.data("bs.affix",n=new e(this,s)),"string"==typeof i&&n[i]()})}var e=function(i,o){this.options=t.extend({},e.DEFAULTS,o),this.$target=t(this.options.target).on("scroll.bs.affix.data-api",t.proxy(this.checkPosition,this)).on("click.bs.affix.data-api",t.proxy(this.checkPositionWithEventLoop,this)),this.$element=t(i),this.affixed=null,this.unpin=null,this.pinnedOffset=null,this.checkPosition()};e.VERSION="3.3.7",e.RESET="affix affix-top affix-bottom",e.DEFAULTS={offset:0,target:window},e.prototype.getState=function(t,e,i,o){var n=this.$target.scrollTop(),s=this.$element.offset(),r=this.$target.height();if(null!=i&&"top"==this.affixed)return n<i&&"top";if("bottom"==this.affixed)return null!=i?!(n+this.unpin<=s.top)&&"bottom":!(n+r<=t-o)&&"bottom";var a=null==this.affixed,l=a?n:s.top,h=a?r:e;return null!=i&&n<=i?"top":null!=o&&l+h>=t-o&&"bottom"},e.prototype.getPinnedOffset=function(){if(this.pinnedOffset)return this.pinnedOffset;this.$element.removeClass(e.RESET).addClass("affix");var t=this.$target.scrollTop(),i=this.$element.offset();return this.pinnedOffset=i.top-t},e.prototype.checkPositionWithEventLoop=function(){setTimeout(t.proxy(this.checkPosition,this),1)},e.prototype.checkPosition=function(){if(this.$element.is(":visible")){var i=this.$element.height(),o=this.options.offset,n=o.top,s=o.bottom,r=Math.max(t(document).height(),t(document.body).height());"object"!=typeof o&&(s=n=o),"function"==typeof n&&(n=o.top(this.$element)),"function"==typeof s&&(s=o.bottom(this.$element));var a=this.getState(r,i,n,s);if(this.affixed!=a){null!=this.unpin&&this.$element.css("top","");var l="affix"+(a?"-"+a:""),h=t.Event(l+".bs.affix");if(this.$element.trigger(h),h.isDefaultPrevented())return;this.affixed=a,this.unpin="bottom"==a?this.getPinnedOffset():null,this.$element.removeClass(e.RESET).addClass(l).trigger(l.replace("affix","affixed")+".bs.affix")}"bottom"==a&&this.$element.offset({top:r-i-s})}};var i=t.fn.affix;t.fn.affix=Plugin,t.fn.affix.Constructor=e,t.fn.affix.noConflict=function(){return t.fn.affix=i,this},t(window).on("load",function(){t('[data-spy="affix"]').each(function(){var e=t(this),i=e.data();i.offset=i.offset||{},null!=i.offsetBottom&&(i.offset.bottom=i.offsetBottom),null!=i.offsetTop&&(i.offset.top=i.offsetTop),Plugin.call(e,i)})})}(jQuery);
	!function(t){"function"==typeof define&&define.amd?define(["jquery"],t):t("object"==typeof exports?require("jquery"):jQuery)}(function(t){function Notify(s,i,n){var i={content:{message:"object"==typeof i?i.message:i,title:i.title?i.title:"",icon:i.icon?i.icon:"",url:i.url?i.url:"#",target:i.target?i.target:"-"}};n=t.extend(!0,{},i,n),this.settings=t.extend(!0,{},e,n),this._defaults=e,"-"==this.settings.content.target&&(this.settings.content.target=this.settings.url_target),this.animations={start:"webkitAnimationStart oanimationstart MSAnimationStart animationstart",end:"webkitAnimationEnd oanimationend MSAnimationEnd animationend"},"number"==typeof this.settings.offset&&(this.settings.offset={x:this.settings.offset,y:this.settings.offset}),this.init()}var e={element:"body",position:null,type:"info",allow_dismiss:!0,newest_on_top:!1,showProgressbar:!1,placement:{from:"top",align:"right"},offset:20,spacing:10,z_index:1031,delay:5e3,timer:1e3,url_target:"_blank",mouse_over:null,animate:{enter:"animated fadeInDown",exit:"animated fadeOutUp"},onShow:null,onShown:null,onClose:null,onClosed:null,icon_type:"class",template:'<div data-notify="container" class="col-xs-11 col-sm-4 alert alert-{0}" role="alert"><button type="button" aria-hidden="true" class="close" data-notify="dismiss">&times;</button><span data-notify="icon"></span> <span data-notify="title">{1}</span> <span data-notify="message">{2}</span><div class="progress" data-notify="progressbar"><div class="progress-bar progress-bar-{0}" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;"></div></div><a href="{3}" target="{4}" data-notify="url"></a></div>'};String.format=function(){for(var t=arguments[0],e=1;e<arguments.length;e++)t=t.replace(RegExp("\\{"+(e-1)+"\\}","gm"),arguments[e]);return t},t.extend(Notify.prototype,{init:function(){var t=this;this.buildNotify(),this.settings.content.icon&&this.setIcon(),"#"!=this.settings.content.url&&this.styleURL(),this.placement(),this.bind(),this.notify={$ele:this.$ele,update:function(e,s){var i={};"string"==typeof e?i[e]=s:i=e;for(var e in i)switch(e){case"type":this.$ele.removeClass("alert-"+t.settings.type),this.$ele.find('[data-notify="progressbar"] > .progress-bar').removeClass("progress-bar-"+t.settings.type),t.settings.type=i[e],this.$ele.addClass("alert-"+i[e]).find('[data-notify="progressbar"] > .progress-bar').addClass("progress-bar-"+i[e]);break;case"icon":var n=this.$ele.find('[data-notify="icon"]');"class"==t.settings.icon_type.toLowerCase()?n.removeClass(t.settings.content.icon).addClass(i[e]):(n.is("img")||n.find("img"),n.attr("src",i[e]));break;case"progress":var a=t.settings.delay-t.settings.delay*(i[e]/100);this.$ele.data("notify-delay",a),this.$ele.find('[data-notify="progressbar"] > div').attr("aria-valuenow",i[e]).css("width",i[e]+"%");break;case"url":this.$ele.find('[data-notify="url"]').attr("href",i[e]);break;case"target":this.$ele.find('[data-notify="url"]').attr("target",i[e]);break;default:this.$ele.find('[data-notify="'+e+'"]').html(i[e])}var o=this.$ele.outerHeight()+parseInt(t.settings.spacing)+parseInt(t.settings.offset.y);t.reposition(o)},close:function(){t.close()}}},buildNotify:function(){var e=this.settings.content;this.$ele=t(String.format(this.settings.template,this.settings.type,e.title,e.message,e.url,e.target)),this.$ele.attr("data-notify-position",this.settings.placement.from+"-"+this.settings.placement.align),this.settings.allow_dismiss||this.$ele.find('[data-notify="dismiss"]').css("display","none"),(this.settings.delay<=0&&!this.settings.showProgressbar||!this.settings.showProgressbar)&&this.$ele.find('[data-notify="progressbar"]').remove()},setIcon:function(){"class"==this.settings.icon_type.toLowerCase()?this.$ele.find('[data-notify="icon"]').addClass(this.settings.content.icon):this.$ele.find('[data-notify="icon"]').is("img")?this.$ele.find('[data-notify="icon"]').attr("src",this.settings.content.icon):this.$ele.find('[data-notify="icon"]').append('<img src="'+this.settings.content.icon+'" alt="Notify Icon" />')},styleURL:function(){this.$ele.find('[data-notify="url"]').css({backgroundImage:"url(data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7)",height:"100%",left:"0px",position:"absolute",top:"0px",width:"100%",zIndex:this.settings.z_index+1}),this.$ele.find('[data-notify="dismiss"]').css({position:"absolute",right:"10px",top:"5px",zIndex:this.settings.z_index+2})},placement:function(){var e=this,s=this.settings.offset.y,i={display:"inline-block",margin:"0px auto",position:this.settings.position?this.settings.position:"body"===this.settings.element?"fixed":"absolute",transition:"all .5s ease-in-out",zIndex:this.settings.z_index},n=!1,a=this.settings;switch(t('[data-notify-position="'+this.settings.placement.from+"-"+this.settings.placement.align+'"]:not([data-closing="true"])').each(function(){return s=Math.max(s,parseInt(t(this).css(a.placement.from))+parseInt(t(this).outerHeight())+parseInt(a.spacing))}),1==this.settings.newest_on_top&&(s=this.settings.offset.y),i[this.settings.placement.from]=s+"px",this.settings.placement.align){case"left":case"right":i[this.settings.placement.align]=this.settings.offset.x+"px";break;case"center":i.left=0,i.right=0}this.$ele.css(i).addClass(this.settings.animate.enter),t.each(Array("webkit","moz","o","ms",""),function(t,s){e.$ele[0].style[s+"AnimationIterationCount"]=1}),t(this.settings.element).append(this.$ele),1==this.settings.newest_on_top&&(s=parseInt(s)+parseInt(this.settings.spacing)+this.$ele.outerHeight(),this.reposition(s)),t.isFunction(e.settings.onShow)&&e.settings.onShow.call(this.$ele),this.$ele.one(this.animations.start,function(t){n=!0}).one(this.animations.end,function(s){t.isFunction(e.settings.onShown)&&e.settings.onShown.call(this)}),setTimeout(function(){n||t.isFunction(e.settings.onShown)&&e.settings.onShown.call(this)},600)},bind:function(){var e=this;if(this.$ele.find('[data-notify="dismiss"]').on("click",function(){e.close()}),this.$ele.mouseover(function(e){t(this).data("data-hover","true")}).mouseout(function(e){t(this).data("data-hover","false")}),this.$ele.data("data-hover","false"),this.settings.delay>0){e.$ele.data("notify-delay",e.settings.delay);var s=setInterval(function(){var t=parseInt(e.$ele.data("notify-delay"))-e.settings.timer;if("false"===e.$ele.data("data-hover")&&"pause"==e.settings.mouse_over||"pause"!=e.settings.mouse_over){var i=(e.settings.delay-t)/e.settings.delay*100;e.$ele.data("notify-delay",t),e.$ele.find('[data-notify="progressbar"] > div').attr("aria-valuenow",i).css("width",i+"%")}t<=-e.settings.timer&&(clearInterval(s),e.close())},e.settings.timer)}},close:function(){var e=this,s=parseInt(this.$ele.css(this.settings.placement.from)),i=!1;this.$ele.data("closing","true").addClass(this.settings.animate.exit),e.reposition(s),t.isFunction(e.settings.onClose)&&e.settings.onClose.call(this.$ele),this.$ele.one(this.animations.start,function(t){i=!0}).one(this.animations.end,function(s){t(this).remove(),t.isFunction(e.settings.onClosed)&&e.settings.onClosed.call(this)}),setTimeout(function(){i||(e.$ele.remove(),e.settings.onClosed&&e.settings.onClosed(e.$ele))},600)},reposition:function(e){var s=this,i='[data-notify-position="'+this.settings.placement.from+"-"+this.settings.placement.align+'"]:not([data-closing="true"])',n=this.$ele.nextAll(i);1==this.settings.newest_on_top&&(n=this.$ele.prevAll(i)),n.each(function(){t(this).css(s.settings.placement.from,e),e=parseInt(e)+parseInt(s.settings.spacing)+t(this).outerHeight()})}}),t.notify=function(t,e){return new Notify(this,t,e).notify},t.notifyDefaults=function(s){return e=t.extend(!0,{},e,s)},t.notifyClose=function(e){void 0===e||"all"==e?t("[data-notify]").find('[data-notify="dismiss"]').trigger("click"):t('[data-notify-position="'+e+'"]').find('[data-notify="dismiss"]').trigger("click")}});
	"use strict";function _typeof(t){return t&&"undefined"!=typeof Symbol&&t.constructor===Symbol?"symbol":typeof t}!function(t){if("function"==typeof define&&define.amd)define(["jquery"],t);else if("object"===("undefined"==typeof module?"undefined":_typeof(module))&&module.exports){var i;try{i=require("jquery")}catch(t){i=null}module.exports=t(i)}else window&&(window.Slider=t(window.jQuery))}(function(t){var i;return function(t){function noop(){}var i=Array.prototype.slice;!function defineBridget(t){function addOptionMethod(i){i.prototype.option||(i.prototype.option=function(i){t.isPlainObject(i)&&(this.options=t.extend(!0,this.options,i))})}function bridge(s,o){t.fn[s]=function(n){if("string"==typeof n){for(var a=i.call(arguments,1),h=0,l=this.length;h<l;h++){var r=this[h],p=t.data(r,s);if(p)if(t.isFunction(p[n])&&"_"!==n.charAt(0)){var d=p[n].apply(p,a);if(void 0!==d&&d!==p)return d}else e("no such method '"+n+"' for "+s+" instance");else e("cannot call methods on "+s+" prior to initialization; attempted to call '"+n+"'")}return this}var c=this.map(function(){var i=t.data(this,s);return i?(i.option(n),i._init()):(i=new o(this,n),t.data(this,s,i)),t(this)});return!c||c.length>1?c:c[0]}}if(t){var e="undefined"==typeof console?noop:function(t){console.error(t)};return t.bridget=function(t,i){addOptionMethod(i),bridge(t,i)},t.bridget}}(t)}(t),function(t){function createNewSlider(i,e){this._state={value:null,enabled:null,offset:null,size:null,percentage:null,inDrag:!1,over:!1},"string"==typeof i?this.element=document.querySelector(i):i instanceof HTMLElement&&(this.element=i),e=e||{};for(var o=Object.keys(this.defaultOptions),n=0;n<o.length;n++){var a=o[n],h=e[a];h=null!==(h=void 0!==h?h:function getDataAttrib(t,i){var e="data-slider-"+i.replace(/_/g,"-"),s=t.getAttribute(e);try{return JSON.parse(s)}catch(t){return s}}(this.element,a))?h:this.defaultOptions[a],this.options||(this.options={}),this.options[a]=h}"vertical"!==this.options.orientation||"top"!==this.options.tooltip_position&&"bottom"!==this.options.tooltip_position?"horizontal"!==this.options.orientation||"left"!==this.options.tooltip_position&&"right"!==this.options.tooltip_position||(this.options.tooltip_position="top"):this.options.tooltip_position="right";var l,r,p,d,c,u=this.element.style.width,m=!1,_=this.element.parentNode;if(this.sliderElem)m=!0;else{this.sliderElem=document.createElement("div"),this.sliderElem.className="slider";var v=document.createElement("div");v.className="slider-track",(r=document.createElement("div")).className="slider-track-low",(l=document.createElement("div")).className="slider-selection",(p=document.createElement("div")).className="slider-track-high",(d=document.createElement("div")).className="slider-handle min-slider-handle",d.setAttribute("role","slider"),d.setAttribute("aria-valuemin",this.options.min),d.setAttribute("aria-valuemax",this.options.max),(c=document.createElement("div")).className="slider-handle max-slider-handle",c.setAttribute("role","slider"),c.setAttribute("aria-valuemin",this.options.min),c.setAttribute("aria-valuemax",this.options.max),v.appendChild(r),v.appendChild(l),v.appendChild(p);var f=Array.isArray(this.options.labelledby);if(f&&this.options.labelledby[0]&&d.setAttribute("aria-labelledby",this.options.labelledby[0]),f&&this.options.labelledby[1]&&c.setAttribute("aria-labelledby",this.options.labelledby[1]),!f&&this.options.labelledby&&(d.setAttribute("aria-labelledby",this.options.labelledby),c.setAttribute("aria-labelledby",this.options.labelledby)),this.ticks=[],Array.isArray(this.options.ticks)&&this.options.ticks.length>0){for(n=0;n<this.options.ticks.length;n++){var g=document.createElement("div");g.className="slider-tick",this.ticks.push(g),v.appendChild(g)}l.className+=" tick-slider-selection"}if(v.appendChild(d),v.appendChild(c),this.tickLabels=[],Array.isArray(this.options.ticks_labels)&&this.options.ticks_labels.length>0)for(this.tickLabelContainer=document.createElement("div"),this.tickLabelContainer.className="slider-tick-label-container",n=0;n<this.options.ticks_labels.length;n++){var y=document.createElement("div"),b=0===this.options.ticks_positions.length,E=this.options.reversed&&b?this.options.ticks_labels.length-(n+1):n;y.className="slider-tick-label",y.innerHTML=this.options.ticks_labels[E],this.tickLabels.push(y),this.tickLabelContainer.appendChild(y)}var k=function createAndAppendTooltipSubElements(t){var i=document.createElement("div");i.className="tooltip-arrow";var e=document.createElement("div");e.className="tooltip-inner",t.appendChild(i),t.appendChild(e)},x=document.createElement("div");x.className="tooltip tooltip-main",x.setAttribute("role","presentation"),k(x);var C=document.createElement("div");C.className="tooltip tooltip-min",C.setAttribute("role","presentation"),k(C);var w=document.createElement("div");w.className="tooltip tooltip-max",w.setAttribute("role","presentation"),k(w),this.sliderElem.appendChild(v),this.sliderElem.appendChild(x),this.sliderElem.appendChild(C),this.sliderElem.appendChild(w),this.tickLabelContainer&&this.sliderElem.appendChild(this.tickLabelContainer),_.insertBefore(this.sliderElem,this.element),this.element.style.display="none"}if(t&&(this.$element=t(this.element),this.$sliderElem=t(this.sliderElem)),this.eventToCallbackMap={},this.sliderElem.id=this.options.id,this.touchCapable="ontouchstart"in window||window.DocumentTouch&&document instanceof window.DocumentTouch,this.tooltip=this.sliderElem.querySelector(".tooltip-main"),this.tooltipInner=this.tooltip.querySelector(".tooltip-inner"),this.tooltip_min=this.sliderElem.querySelector(".tooltip-min"),this.tooltipInner_min=this.tooltip_min.querySelector(".tooltip-inner"),this.tooltip_max=this.sliderElem.querySelector(".tooltip-max"),this.tooltipInner_max=this.tooltip_max.querySelector(".tooltip-inner"),s[this.options.scale]&&(this.options.scale=s[this.options.scale]),!0===m&&(this._removeClass(this.sliderElem,"slider-horizontal"),this._removeClass(this.sliderElem,"slider-vertical"),this._removeClass(this.tooltip,"hide"),this._removeClass(this.tooltip_min,"hide"),this._removeClass(this.tooltip_max,"hide"),["left","top","width","height"].forEach(function(t){this._removeProperty(this.trackLow,t),this._removeProperty(this.trackSelection,t),this._removeProperty(this.trackHigh,t)},this),[this.handle1,this.handle2].forEach(function(t){this._removeProperty(t,"left"),this._removeProperty(t,"top")},this),[this.tooltip,this.tooltip_min,this.tooltip_max].forEach(function(t){this._removeProperty(t,"left"),this._removeProperty(t,"top"),this._removeProperty(t,"margin-left"),this._removeProperty(t,"margin-top"),this._removeClass(t,"right"),this._removeClass(t,"top")},this)),"vertical"===this.options.orientation?(this._addClass(this.sliderElem,"slider-vertical"),this.stylePos="top",this.mousePos="pageY",this.sizePos="offsetHeight"):(this._addClass(this.sliderElem,"slider-horizontal"),this.sliderElem.style.width=u,this.options.orientation="horizontal",this.stylePos="left",this.mousePos="pageX",this.sizePos="offsetWidth"),this._setTooltipPosition(),Array.isArray(this.options.ticks)&&this.options.ticks.length>0&&(this.options.max=Math.max.apply(Math,this.options.ticks),this.options.min=Math.min.apply(Math,this.options.ticks)),Array.isArray(this.options.value)?(this.options.range=!0,this._state.value=this.options.value):this.options.range?this._state.value=[this.options.value,this.options.max]:this._state.value=this.options.value,this.trackLow=r||this.trackLow,this.trackSelection=l||this.trackSelection,this.trackHigh=p||this.trackHigh,"none"===this.options.selection&&(this._addClass(this.trackLow,"hide"),this._addClass(this.trackSelection,"hide"),this._addClass(this.trackHigh,"hide")),this.handle1=d||this.handle1,this.handle2=c||this.handle2,!0===m)for(this._removeClass(this.handle1,"round triangle"),this._removeClass(this.handle2,"round triangle hide"),n=0;n<this.ticks.length;n++)this._removeClass(this.ticks[n],"round triangle hide");if(-1!==["round","triangle","custom"].indexOf(this.options.handle))for(this._addClass(this.handle1,this.options.handle),this._addClass(this.handle2,this.options.handle),n=0;n<this.ticks.length;n++)this._addClass(this.ticks[n],this.options.handle);this._state.offset=this._offset(this.sliderElem),this._state.size=this.sliderElem[this.sizePos],this.setValue(this._state.value),this.handle1Keydown=this._keydown.bind(this,0),this.handle1.addEventListener("keydown",this.handle1Keydown,!1),this.handle2Keydown=this._keydown.bind(this,1),this.handle2.addEventListener("keydown",this.handle2Keydown,!1),this.mousedown=this._mousedown.bind(this),this.touchCapable&&this.sliderElem.addEventListener("touchstart",this.mousedown,!1),this.sliderElem.addEventListener("mousedown",this.mousedown,!1),this.resize=this._resize.bind(this),window.addEventListener("resize",this.resize,!1),"hide"===this.options.tooltip?(this._addClass(this.tooltip,"hide"),this._addClass(this.tooltip_min,"hide"),this._addClass(this.tooltip_max,"hide")):"always"===this.options.tooltip?(this._showTooltip(),this._alwaysShowTooltip=!0):(this.showTooltip=this._showTooltip.bind(this),this.hideTooltip=this._hideTooltip.bind(this),this.sliderElem.addEventListener("mouseenter",this.showTooltip,!1),this.sliderElem.addEventListener("mouseleave",this.hideTooltip,!1),this.handle1.addEventListener("focus",this.showTooltip,!1),this.handle1.addEventListener("blur",this.hideTooltip,!1),this.handle2.addEventListener("focus",this.showTooltip,!1),this.handle2.addEventListener("blur",this.hideTooltip,!1)),this.options.enabled?this.enable():this.disable()}var e={formatInvalidInputErrorMsg:function formatInvalidInputErrorMsg(t){return"Invalid input value '"+t+"' passed in"},callingContextNotSliderInstance:"Calling context element does not have instance of Slider bound to it. Check your code to make sure the JQuery object returned from the call to the slider() initializer is calling the method"},s={linear:{toValue:function toValue(t){var i=t/100*(this.options.max-this.options.min),e=!0;if(this.options.ticks_positions.length>0){for(var s,o,n,a=0,h=1;h<this.options.ticks_positions.length;h++)if(t<=this.options.ticks_positions[h]){s=this.options.ticks[h-1],n=this.options.ticks_positions[h-1],o=this.options.ticks[h],a=this.options.ticks_positions[h];break}i=s+(t-n)/(a-n)*(o-s),e=!1}var l=(e?this.options.min:0)+Math.round(i/this.options.step)*this.options.step;return l<this.options.min?this.options.min:l>this.options.max?this.options.max:l},toPercentage:function toPercentage(t){if(this.options.max===this.options.min)return 0;if(this.options.ticks_positions.length>0){for(var i,e,s,o=0,n=0;n<this.options.ticks.length;n++)if(t<=this.options.ticks[n]){i=n>0?this.options.ticks[n-1]:0,s=n>0?this.options.ticks_positions[n-1]:0,e=this.options.ticks[n],o=this.options.ticks_positions[n];break}if(n>0)return s+(t-i)/(e-i)*(o-s)}return 100*(t-this.options.min)/(this.options.max-this.options.min)}},logarithmic:{toValue:function toValue(t){var i=0===this.options.min?0:Math.log(this.options.min),e=Math.log(this.options.max),s=Math.exp(i+(e-i)*t/100);return(s=this.options.min+Math.round((s-this.options.min)/this.options.step)*this.options.step)<this.options.min?this.options.min:s>this.options.max?this.options.max:s},toPercentage:function toPercentage(t){if(this.options.max===this.options.min)return 0;var i=Math.log(this.options.max),e=0===this.options.min?0:Math.log(this.options.min);return 100*((0===t?0:Math.log(t))-e)/(i-e)}}};if(i=function(t,i){return createNewSlider.call(this,t,i),this},i.prototype={_init:function _init(){},constructor:i,defaultOptions:{id:"",min:0,max:10,step:1,precision:0,orientation:"horizontal",value:5,range:!1,selection:"before",tooltip:"show",tooltip_split:!1,handle:"round",reversed:!1,enabled:!0,formatter:function formatter(t){return Array.isArray(t)?t[0]+" : "+t[1]:t},natural_arrow_keys:!1,ticks:[],ticks_positions:[],ticks_labels:[],ticks_snap_bounds:0,scale:"linear",focus:!1,tooltip_position:null,labelledby:null},getElement:function getElement(){return this.sliderElem},getValue:function getValue(){return this.options.range?this._state.value:this._state.value[0]},setValue:function setValue(t,i,e){t||(t=0);var s=this.getValue();this._state.value=this._validateInputValue(t);var o=this._applyPrecision.bind(this);this.options.range?(this._state.value[0]=o(this._state.value[0]),this._state.value[1]=o(this._state.value[1]),this._state.value[0]=Math.max(this.options.min,Math.min(this.options.max,this._state.value[0])),this._state.value[1]=Math.max(this.options.min,Math.min(this.options.max,this._state.value[1]))):(this._state.value=o(this._state.value),this._state.value=[Math.max(this.options.min,Math.min(this.options.max,this._state.value))],this._addClass(this.handle2,"hide"),"after"===this.options.selection?this._state.value[1]=this.options.max:this._state.value[1]=this.options.min),this.options.max>this.options.min?this._state.percentage=[this._toPercentage(this._state.value[0]),this._toPercentage(this._state.value[1]),100*this.options.step/(this.options.max-this.options.min)]:this._state.percentage=[0,0,100],this._layout();var n=this.options.range?this._state.value:this._state.value[0];return this._setDataVal(n),!0===i&&this._trigger("slide",n),s!==n&&!0===e&&this._trigger("change",{oldValue:s,newValue:n}),this},destroy:function destroy(){this._removeSliderEventHandlers(),this.sliderElem.parentNode.removeChild(this.sliderElem),this.element.style.display="",this._cleanUpEventCallbacksMap(),this.element.removeAttribute("data"),t&&(this._unbindJQueryEventHandlers(),this.$element.removeData("slider"))},disable:function disable(){return this._state.enabled=!1,this.handle1.removeAttribute("tabindex"),this.handle2.removeAttribute("tabindex"),this._addClass(this.sliderElem,"slider-disabled"),this._trigger("slideDisabled"),this},enable:function enable(){return this._state.enabled=!0,this.handle1.setAttribute("tabindex",0),this.handle2.setAttribute("tabindex",0),this._removeClass(this.sliderElem,"slider-disabled"),this._trigger("slideEnabled"),this},toggle:function toggle(){return this._state.enabled?this.disable():this.enable(),this},isEnabled:function isEnabled(){return this._state.enabled},on:function on(t,i){return this._bindNonQueryEventHandler(t,i),this},off:function off(i,e){t?(this.$element.off(i,e),this.$sliderElem.off(i,e)):this._unbindNonQueryEventHandler(i,e)},getAttribute:function getAttribute(t){return t?this.options[t]:this.options},setAttribute:function setAttribute(t,i){return this.options[t]=i,this},refresh:function refresh(){return this._removeSliderEventHandlers(),createNewSlider.call(this,this.element,this.options),t&&t.data(this.element,"slider",this),this},relayout:function relayout(){return this._layout(),this},_removeSliderEventHandlers:function _removeSliderEventHandlers(){this.handle1.removeEventListener("keydown",this.handle1Keydown,!1),this.handle2.removeEventListener("keydown",this.handle2Keydown,!1),this.showTooltip&&(this.handle1.removeEventListener("focus",this.showTooltip,!1),this.handle2.removeEventListener("focus",this.showTooltip,!1)),this.hideTooltip&&(this.handle1.removeEventListener("blur",this.hideTooltip,!1),this.handle2.removeEventListener("blur",this.hideTooltip,!1)),this.showTooltip&&this.sliderElem.removeEventListener("mouseenter",this.showTooltip,!1),this.hideTooltip&&this.sliderElem.removeEventListener("mouseleave",this.hideTooltip,!1),this.sliderElem.removeEventListener("touchstart",this.mousedown,!1),this.sliderElem.removeEventListener("mousedown",this.mousedown,!1),window.removeEventListener("resize",this.resize,!1)},_bindNonQueryEventHandler:function _bindNonQueryEventHandler(t,i){void 0===this.eventToCallbackMap[t]&&(this.eventToCallbackMap[t]=[]),this.eventToCallbackMap[t].push(i)},_unbindNonQueryEventHandler:function _unbindNonQueryEventHandler(t,i){var e=this.eventToCallbackMap[t];if(void 0!==e)for(var s=0;s<e.length;s++)if(e[s]===i){e.splice(s,1);break}},_cleanUpEventCallbacksMap:function _cleanUpEventCallbacksMap(){for(var t=Object.keys(this.eventToCallbackMap),i=0;i<t.length;i++){var e=t[i];this.eventToCallbackMap[e]=null}},_showTooltip:function _showTooltip(){!1===this.options.tooltip_split?(this._addClass(this.tooltip,"in"),this.tooltip_min.style.display="none",this.tooltip_max.style.display="none"):(this._addClass(this.tooltip_min,"in"),this._addClass(this.tooltip_max,"in"),this.tooltip.style.display="none"),this._state.over=!0},_hideTooltip:function _hideTooltip(){!1===this._state.inDrag&&!0!==this.alwaysShowTooltip&&(this._removeClass(this.tooltip,"in"),this._removeClass(this.tooltip_min,"in"),this._removeClass(this.tooltip_max,"in")),this._state.over=!1},_layout:function _layout(){var t;if(t=this.options.reversed?[100-this._state.percentage[0],this.options.range?100-this._state.percentage[1]:this._state.percentage[1]]:[this._state.percentage[0],this._state.percentage[1]],this.handle1.style[this.stylePos]=t[0]+"%",this.handle1.setAttribute("aria-valuenow",this._state.value[0]),this.handle2.style[this.stylePos]=t[1]+"%",this.handle2.setAttribute("aria-valuenow",this._state.value[1]),Array.isArray(this.options.ticks)&&this.options.ticks.length>0){var i="vertical"===this.options.orientation?"height":"width",e="vertical"===this.options.orientation?"marginTop":"marginLeft",s=this._state.size/(this.options.ticks.length-1);if(this.tickLabelContainer){var o=0;if(0===this.options.ticks_positions.length)"vertical"!==this.options.orientation&&(this.tickLabelContainer.style[e]=-s/2+"px"),o=this.tickLabelContainer.offsetHeight;else for(n=0;n<this.tickLabelContainer.childNodes.length;n++)this.tickLabelContainer.childNodes[n].offsetHeight>o&&(o=this.tickLabelContainer.childNodes[n].offsetHeight);"horizontal"===this.options.orientation&&(this.sliderElem.style.marginBottom=o+"px")}for(var n=0;n<this.options.ticks.length;n++){var a=this.options.ticks_positions[n]||this._toPercentage(this.options.ticks[n]);this.options.reversed&&(a=100-a),this.ticks[n].style[this.stylePos]=a+"%",this._removeClass(this.ticks[n],"in-selection"),this.options.range?a>=t[0]&&a<=t[1]&&this._addClass(this.ticks[n],"in-selection"):"after"===this.options.selection&&a>=t[0]?this._addClass(this.ticks[n],"in-selection"):"before"===this.options.selection&&a<=t[0]&&this._addClass(this.ticks[n],"in-selection"),this.tickLabels[n]&&(this.tickLabels[n].style[i]=s+"px","vertical"!==this.options.orientation&&void 0!==this.options.ticks_positions[n]?(this.tickLabels[n].style.position="absolute",this.tickLabels[n].style[this.stylePos]=a+"%",this.tickLabels[n].style[e]=-s/2+"px"):"vertical"===this.options.orientation&&(this.tickLabels[n].style.marginLeft=this.sliderElem.offsetWidth+"px",this.tickLabelContainer.style.marginTop=this.sliderElem.offsetWidth/2*-1+"px"))}}var h;if(this.options.range){h=this.options.formatter(this._state.value),this._setText(this.tooltipInner,h),this.tooltip.style[this.stylePos]=(t[1]+t[0])/2+"%","vertical"===this.options.orientation?this._css(this.tooltip,"margin-top",-this.tooltip.offsetHeight/2+"px"):this._css(this.tooltip,"margin-left",-this.tooltip.offsetWidth/2+"px"),"vertical"===this.options.orientation?this._css(this.tooltip,"margin-top",-this.tooltip.offsetHeight/2+"px"):this._css(this.tooltip,"margin-left",-this.tooltip.offsetWidth/2+"px");var l=this.options.formatter(this._state.value[0]);this._setText(this.tooltipInner_min,l);var r=this.options.formatter(this._state.value[1]);this._setText(this.tooltipInner_max,r),this.tooltip_min.style[this.stylePos]=t[0]+"%","vertical"===this.options.orientation?this._css(this.tooltip_min,"margin-top",-this.tooltip_min.offsetHeight/2+"px"):this._css(this.tooltip_min,"margin-left",-this.tooltip_min.offsetWidth/2+"px"),this.tooltip_max.style[this.stylePos]=t[1]+"%","vertical"===this.options.orientation?this._css(this.tooltip_max,"margin-top",-this.tooltip_max.offsetHeight/2+"px"):this._css(this.tooltip_max,"margin-left",-this.tooltip_max.offsetWidth/2+"px")}else h=this.options.formatter(this._state.value[0]),this._setText(this.tooltipInner,h),this.tooltip.style[this.stylePos]=t[0]+"%","vertical"===this.options.orientation?this._css(this.tooltip,"margin-top",-this.tooltip.offsetHeight/2+"px"):this._css(this.tooltip,"margin-left",-this.tooltip.offsetWidth/2+"px");if("vertical"===this.options.orientation)this.trackLow.style.top="0",this.trackLow.style.height=Math.min(t[0],t[1])+"%",this.trackSelection.style.top=Math.min(t[0],t[1])+"%",this.trackSelection.style.height=Math.abs(t[0]-t[1])+"%",this.trackHigh.style.bottom="0",this.trackHigh.style.height=100-Math.min(t[0],t[1])-Math.abs(t[0]-t[1])+"%";else{this.trackLow.style.left="0",this.trackLow.style.width=Math.min(t[0],t[1])+"%",this.trackSelection.style.left=Math.min(t[0],t[1])+"%",this.trackSelection.style.width=Math.abs(t[0]-t[1])+"%",this.trackHigh.style.right="0",this.trackHigh.style.width=100-Math.min(t[0],t[1])-Math.abs(t[0]-t[1])+"%";var p=this.tooltip_min.getBoundingClientRect(),d=this.tooltip_max.getBoundingClientRect();"bottom"===this.options.tooltip_position?p.right>d.left?(this._removeClass(this.tooltip_max,"bottom"),this._addClass(this.tooltip_max,"top"),this.tooltip_max.style.top="",this.tooltip_max.style.bottom="22px"):(this._removeClass(this.tooltip_max,"top"),this._addClass(this.tooltip_max,"bottom"),this.tooltip_max.style.top=this.tooltip_min.style.top,this.tooltip_max.style.bottom=""):p.right>d.left?(this._removeClass(this.tooltip_max,"top"),this._addClass(this.tooltip_max,"bottom"),this.tooltip_max.style.top="18px"):(this._removeClass(this.tooltip_max,"bottom"),this._addClass(this.tooltip_max,"top"),this.tooltip_max.style.top=this.tooltip_min.style.top)}},_resize:function _resize(t){this._state.offset=this._offset(this.sliderElem),this._state.size=this.sliderElem[this.sizePos],this._layout()},_removeProperty:function _removeProperty(t,i){t.style.removeProperty?t.style.removeProperty(i):t.style.removeAttribute(i)},_mousedown:function _mousedown(t){if(!this._state.enabled)return!1;this._state.offset=this._offset(this.sliderElem),this._state.size=this.sliderElem[this.sizePos];var i=this._getPercentage(t);if(this.options.range){var e=Math.abs(this._state.percentage[0]-i),s=Math.abs(this._state.percentage[1]-i);this._state.dragged=e<s?0:1}else this._state.dragged=0;this._state.percentage[this._state.dragged]=i,this._layout(),this.touchCapable&&(document.removeEventListener("touchmove",this.mousemove,!1),document.removeEventListener("touchend",this.mouseup,!1)),this.mousemove&&document.removeEventListener("mousemove",this.mousemove,!1),this.mouseup&&document.removeEventListener("mouseup",this.mouseup,!1),this.mousemove=this._mousemove.bind(this),this.mouseup=this._mouseup.bind(this),this.touchCapable&&(document.addEventListener("touchmove",this.mousemove,!1),document.addEventListener("touchend",this.mouseup,!1)),document.addEventListener("mousemove",this.mousemove,!1),document.addEventListener("mouseup",this.mouseup,!1),this._state.inDrag=!0;var o=this._calculateValue();return this._trigger("slideStart",o),this._setDataVal(o),this.setValue(o,!1,!0),this._pauseEvent(t),this.options.focus&&this._triggerFocusOnHandle(this._state.dragged),!0},_triggerFocusOnHandle:function _triggerFocusOnHandle(t){0===t&&this.handle1.focus(),1===t&&this.handle2.focus()},_keydown:function _keydown(t,i){if(!this._state.enabled)return!1;var e;switch(i.keyCode){case 37:case 40:e=-1;break;case 39:case 38:e=1}if(e){if(this.options.natural_arrow_keys){var s="vertical"===this.options.orientation&&!this.options.reversed,o="horizontal"===this.options.orientation&&this.options.reversed;(s||o)&&(e=-e)}var n=this._state.value[t]+e*this.options.step;return this.options.range&&(n=[t?this._state.value[0]:n,t?n:this._state.value[1]]),this._trigger("slideStart",n),this._setDataVal(n),this.setValue(n,!0,!0),this._setDataVal(n),this._trigger("slideStop",n),this._layout(),this._pauseEvent(i),!1}},_pauseEvent:function _pauseEvent(t){t.stopPropagation&&t.stopPropagation(),t.preventDefault&&t.preventDefault(),t.cancelBubble=!0,t.returnValue=!1},_mousemove:function _mousemove(t){if(!this._state.enabled)return!1;var i=this._getPercentage(t);this._adjustPercentageForRangeSliders(i),this._state.percentage[this._state.dragged]=i,this._layout();var e=this._calculateValue(!0);return this.setValue(e,!0,!0),!1},_adjustPercentageForRangeSliders:function _adjustPercentageForRangeSliders(t){if(this.options.range){var i=this._getNumDigitsAfterDecimalPlace(t);i=i?i-1:0;var e=this._applyToFixedAndParseFloat(t,i);0===this._state.dragged&&this._applyToFixedAndParseFloat(this._state.percentage[1],i)<e?(this._state.percentage[0]=this._state.percentage[1],this._state.dragged=1):1===this._state.dragged&&this._applyToFixedAndParseFloat(this._state.percentage[0],i)>e&&(this._state.percentage[1]=this._state.percentage[0],this._state.dragged=0)}},_mouseup:function _mouseup(){if(!this._state.enabled)return!1;this.touchCapable&&(document.removeEventListener("touchmove",this.mousemove,!1),document.removeEventListener("touchend",this.mouseup,!1)),document.removeEventListener("mousemove",this.mousemove,!1),document.removeEventListener("mouseup",this.mouseup,!1),this._state.inDrag=!1,!1===this._state.over&&this._hideTooltip();var t=this._calculateValue(!0);return this._layout(),this._setDataVal(t),this._trigger("slideStop",t),!1},_calculateValue:function _calculateValue(t){var i;if(this.options.range?(i=[this.options.min,this.options.max],0!==this._state.percentage[0]&&(i[0]=this._toValue(this._state.percentage[0]),i[0]=this._applyPrecision(i[0])),100!==this._state.percentage[1]&&(i[1]=this._toValue(this._state.percentage[1]),i[1]=this._applyPrecision(i[1]))):(i=this._toValue(this._state.percentage[0]),i=parseFloat(i),i=this._applyPrecision(i)),t){for(var e=[i,1/0],s=0;s<this.options.ticks.length;s++){var o=Math.abs(this.options.ticks[s]-i);o<=e[1]&&(e=[this.options.ticks[s],o])}if(e[1]<=this.options.ticks_snap_bounds)return e[0]}return i},_applyPrecision:function _applyPrecision(t){var i=this.options.precision||this._getNumDigitsAfterDecimalPlace(this.options.step);return this._applyToFixedAndParseFloat(t,i)},_getNumDigitsAfterDecimalPlace:function _getNumDigitsAfterDecimalPlace(t){var i=(""+t).match(/(?:\.(\d+))?(?:[eE]([+-]?\d+))?$/);return i?Math.max(0,(i[1]?i[1].length:0)-(i[2]?+i[2]:0)):0},_applyToFixedAndParseFloat:function _applyToFixedAndParseFloat(t,i){var e=t.toFixed(i);return parseFloat(e)},_getPercentage:function _getPercentage(t){!this.touchCapable||"touchstart"!==t.type&&"touchmove"!==t.type||(t=t.touches[0]);var i=(t[this.mousePos]-this._state.offset[this.stylePos])/this._state.size*100;return i=Math.round(i/this._state.percentage[2])*this._state.percentage[2],this.options.reversed&&(i=100-i),Math.max(0,Math.min(100,i))},_validateInputValue:function _validateInputValue(t){if("number"==typeof t)return t;if(Array.isArray(t))return this._validateArray(t),t;throw new Error(e.formatInvalidInputErrorMsg(t))},_validateArray:function _validateArray(t){for(var i=0;i<t.length;i++){var s=t[i];if("number"!=typeof s)throw new Error(e.formatInvalidInputErrorMsg(s))}},_setDataVal:function _setDataVal(t){this.element.setAttribute("data-value",t),this.element.setAttribute("value",t),this.element.value=t},_trigger:function _trigger(i,e){e=e||0===e?e:void 0;var s=this.eventToCallbackMap[i];if(s&&s.length)for(var o=0;o<s.length;o++)(0,s[o])(e);t&&this._triggerJQueryEvent(i,e)},_triggerJQueryEvent:function _triggerJQueryEvent(t,i){var e={type:t,value:i};this.$element.trigger(e),this.$sliderElem.trigger(e)},_unbindJQueryEventHandlers:function _unbindJQueryEventHandlers(){this.$element.off(),this.$sliderElem.off()},_setText:function _setText(t,i){void 0!==t.textContent?t.textContent=i:void 0!==t.innerText&&(t.innerText=i)},_removeClass:function _removeClass(t,i){for(var e=i.split(" "),s=t.className,o=0;o<e.length;o++){var n=e[o],a=new RegExp("(?:\\s|^)"+n+"(?:\\s|$)");s=s.replace(a," ")}t.className=s.trim()},_addClass:function _addClass(t,i){for(var e=i.split(" "),s=t.className,o=0;o<e.length;o++){var n=e[o];new RegExp("(?:\\s|^)"+n+"(?:\\s|$)").test(s)||(s+=" "+n)}t.className=s.trim()},_offsetLeft:function _offsetLeft(t){return t.getBoundingClientRect().left},_offsetTop:function _offsetTop(t){for(var i=t.offsetTop;(t=t.offsetParent)&&!isNaN(t.offsetTop);)i+=t.offsetTop,"BODY"!==t.tagName&&(i-=t.scrollTop);return i},_offset:function _offset(t){return{left:this._offsetLeft(t),top:this._offsetTop(t)}},_css:function _css(i,e,s){if(t)t.style(i,e,s);else{var o=e.replace(/^-ms-/,"ms-").replace(/-([\da-z])/gi,function(t,i){return i.toUpperCase()});i.style[o]=s}},_toValue:function _toValue(t){return this.options.scale.toValue.apply(this,[t])},_toPercentage:function _toPercentage(t){return this.options.scale.toPercentage.apply(this,[t])},_setTooltipPosition:function _setTooltipPosition(){var t=[this.tooltip,this.tooltip_min,this.tooltip_max];if("vertical"===this.options.orientation){var i=this.options.tooltip_position||"right",e="left"===i?"right":"left";t.forEach(function(t){this._addClass(t,i),t.style[e]="100%"}.bind(this))}else"bottom"===this.options.tooltip_position?t.forEach(function(t){this._addClass(t,"bottom"),t.style.top="22px"}.bind(this)):t.forEach(function(t){this._addClass(t,"top"),t.style.top=-this.tooltip.outerHeight-14+"px"}.bind(this))}},t){var o=t.fn.slider?"bootstrapSlider":"slider";t.bridget(o,i),t(function(){t("input[data-provide=slider]")[o]()})}}(t),i});
	!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).JSZip=e()}}(function(){return function e(t,r,n){function s(a,o){if(!r[a]){if(!t[a]){var l="function"==typeof require&&require;if(!o&&l)return l(a,!0);if(i)return i(a,!0);var u=new Error("Cannot find module '"+a+"'");throw u.code="MODULE_NOT_FOUND",u}var h=r[a]={exports:{}};t[a][0].call(h.exports,function(e){var r=t[a][1][e];return s(r||e)},h,h.exports,e,t,r,n)}return r[a].exports}for(var i="function"==typeof require&&require,a=0;a<n.length;a++)s(n[a]);return s}({1:[function(e,t,r){"use strict";var n=e("./utils"),i=e("./support"),a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";r.encode=function(e){for(var t,r,i,s,o,l,u,h=[],d=0,c=e.length,f=c,p="string"!==n.getTypeOf(e);d<e.length;)f=c-d,p?(t=e[d++],r=d<c?e[d++]:0,i=d<c?e[d++]:0):(t=e.charCodeAt(d++),r=d<c?e.charCodeAt(d++):0,i=d<c?e.charCodeAt(d++):0),s=t>>2,o=(3&t)<<4|r>>4,l=f>1?(15&r)<<2|i>>6:64,u=f>2?63&i:64,h.push(a.charAt(s)+a.charAt(o)+a.charAt(l)+a.charAt(u));return h.join("")},r.decode=function(e){var t,r,n,s,o,l,u=0,h=0;if("data:"===e.substr(0,"data:".length))throw new Error("Invalid base64 input, it looks like a data url.");var d=3*(e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"")).length/4;if(e.charAt(e.length-1)===a.charAt(64)&&d--,e.charAt(e.length-2)===a.charAt(64)&&d--,d%1!=0)throw new Error("Invalid base64 input, bad content length.");var c;for(c=i.uint8array?new Uint8Array(0|d):new Array(0|d);u<e.length;)t=a.indexOf(e.charAt(u++))<<2|(s=a.indexOf(e.charAt(u++)))>>4,r=(15&s)<<4|(o=a.indexOf(e.charAt(u++)))>>2,n=(3&o)<<6|(l=a.indexOf(e.charAt(u++))),c[h++]=t,64!==o&&(c[h++]=r),64!==l&&(c[h++]=n);return c}},{"./support":30,"./utils":32}],2:[function(e,t,r){"use strict";function CompressedObject(e,t,r,n,i){this.compressedSize=e,this.uncompressedSize=t,this.crc32=r,this.compression=n,this.compressedContent=i}var n=e("./external"),i=e("./stream/DataWorker"),a=e("./stream/DataLengthProbe"),s=e("./stream/Crc32Probe"),a=e("./stream/DataLengthProbe");CompressedObject.prototype={getContentWorker:function(){var e=new i(n.Promise.resolve(this.compressedContent)).pipe(this.compression.uncompressWorker()).pipe(new a("data_length")),t=this;return e.on("end",function(){if(this.streamInfo.data_length!==t.uncompressedSize)throw new Error("Bug : uncompressed data size mismatch")}),e},getCompressedWorker:function(){return new i(n.Promise.resolve(this.compressedContent)).withStreamInfo("compressedSize",this.compressedSize).withStreamInfo("uncompressedSize",this.uncompressedSize).withStreamInfo("crc32",this.crc32).withStreamInfo("compression",this.compression)}},CompressedObject.createWorkerFrom=function(e,t,r){return e.pipe(new s).pipe(new a("uncompressedSize")).pipe(t.compressWorker(r)).pipe(new a("compressedSize")).withStreamInfo("compression",t)},t.exports=CompressedObject},{"./external":6,"./stream/Crc32Probe":25,"./stream/DataLengthProbe":26,"./stream/DataWorker":27}],3:[function(e,t,r){"use strict";var n=e("./stream/GenericWorker");r.STORE={magic:"\0\0",compressWorker:function(e){return new n("STORE compression")},uncompressWorker:function(){return new n("STORE decompression")}},r.DEFLATE=e("./flate")},{"./flate":7,"./stream/GenericWorker":28}],4:[function(e,t,r){"use strict";function crc32(e,t,r,n){var a=i,s=n+r;e^=-1;for(var o=n;o<s;o++)e=e>>>8^a[255&(e^t[o])];return-1^e}function crc32str(e,t,r,n){var a=i,s=n+r;e^=-1;for(var o=n;o<s;o++)e=e>>>8^a[255&(e^t.charCodeAt(o))];return-1^e}var n=e("./utils"),i=function makeTable(){for(var e,t=[],r=0;r<256;r++){e=r;for(var n=0;n<8;n++)e=1&e?3988292384^e>>>1:e>>>1;t[r]=e}return t}();t.exports=function crc32wrapper(e,t){return void 0!==e&&e.length?"string"!==n.getTypeOf(e)?crc32(0|t,e,e.length,0):crc32str(0|t,e,e.length,0):0}},{"./utils":32}],5:[function(e,t,r){"use strict";r.base64=!1,r.binary=!1,r.dir=!1,r.createFolders=!0,r.date=null,r.compression=null,r.compressionOptions=null,r.comment=null,r.unixPermissions=null,r.dosPermissions=null},{}],6:[function(e,t,r){"use strict";var n=null;n="undefined"!=typeof Promise?Promise:e("lie"),t.exports={Promise:n}},{lie:58}],7:[function(e,t,r){"use strict";function FlateWorker(e,t){s.call(this,"FlateWorker/"+e),this._pako=new i[e]({raw:!0,level:t.level||-1}),this.meta={};var r=this;this._pako.onData=function(e){r.push({data:e,meta:r.meta})}}var n="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Uint32Array,i=e("pako"),a=e("./utils"),s=e("./stream/GenericWorker"),o=n?"uint8array":"array";r.magic="\b\0",a.inherits(FlateWorker,s),FlateWorker.prototype.processChunk=function(e){this.meta=e.meta,this._pako.push(a.transformTo(o,e.data),!1)},FlateWorker.prototype.flush=function(){s.prototype.flush.call(this),this._pako.push([],!0)},FlateWorker.prototype.cleanUp=function(){s.prototype.cleanUp.call(this),this._pako=null},r.compressWorker=function(e){return new FlateWorker("Deflate",e)},r.uncompressWorker=function(){return new FlateWorker("Inflate",{})}},{"./stream/GenericWorker":28,"./utils":32,pako:59}],8:[function(e,t,r){"use strict";function ZipFileWorker(e,t,r,n){i.call(this,"ZipFileWorker"),this.bytesWritten=0,this.zipComment=t,this.zipPlatform=r,this.encodeFileName=n,this.streamFiles=e,this.accumulate=!1,this.contentBuffer=[],this.dirRecords=[],this.currentSourceOffset=0,this.entriesCount=0,this.currentFile=null,this._sources=[]}var n=e("../utils"),i=e("../stream/GenericWorker"),a=e("../utf8"),s=e("../crc32"),o=e("../signature"),l=function(e,t){var r,n="";for(r=0;r<t;r++)n+=String.fromCharCode(255&e),e>>>=8;return n},u=function(e,t){var r=e;return e||(r=t?16893:33204),(65535&r)<<16},h=function(e,t){return 63&(e||0)},d=function(e,t,r,i,d,c){var f,p,_=e.file,m=e.compression,g=c!==a.utf8encode,b=n.transformTo("string",c(_.name)),y=n.transformTo("string",a.utf8encode(_.name)),w=_.comment,v=n.transformTo("string",c(w)),k=n.transformTo("string",a.utf8encode(w)),x=y.length!==_.name.length,S=k.length!==w.length,z="",C="",A="",E=_.dir,I=_.date,R={crc32:0,compressedSize:0,uncompressedSize:0};t&&!r||(R.crc32=e.crc32,R.compressedSize=e.compressedSize,R.uncompressedSize=e.uncompressedSize);var T=0;t&&(T|=8),g||!x&&!S||(T|=2048);var O=0,D=0;E&&(O|=16),"UNIX"===d?(D=798,O|=u(_.unixPermissions,E)):(D=20,O|=h(_.dosPermissions)),f=I.getUTCHours(),f<<=6,f|=I.getUTCMinutes(),f<<=5,f|=I.getUTCSeconds()/2,p=I.getUTCFullYear()-1980,p<<=4,p|=I.getUTCMonth()+1,p<<=5,p|=I.getUTCDate(),x&&(C=l(1,1)+l(s(b),4)+y,z+="up"+l(C.length,2)+C),S&&(A=l(1,1)+l(s(v),4)+k,z+="uc"+l(A.length,2)+A);var B="";return B+="\n\0",B+=l(T,2),B+=m.magic,B+=l(f,2),B+=l(p,2),B+=l(R.crc32,4),B+=l(R.compressedSize,4),B+=l(R.uncompressedSize,4),B+=l(b.length,2),B+=l(z.length,2),{fileRecord:o.LOCAL_FILE_HEADER+B+b+z,dirRecord:o.CENTRAL_FILE_HEADER+l(D,2)+B+l(v.length,2)+"\0\0\0\0"+l(O,4)+l(i,4)+b+z+v}},c=function(e,t,r,i,a){var s=n.transformTo("string",a(i));return o.CENTRAL_DIRECTORY_END+"\0\0\0\0"+l(e,2)+l(e,2)+l(t,4)+l(r,4)+l(s.length,2)+s},f=function(e){return o.DATA_DESCRIPTOR+l(e.crc32,4)+l(e.compressedSize,4)+l(e.uncompressedSize,4)};n.inherits(ZipFileWorker,i),ZipFileWorker.prototype.push=function(e){var t=e.meta.percent||0,r=this.entriesCount,n=this._sources.length;this.accumulate?this.contentBuffer.push(e):(this.bytesWritten+=e.data.length,i.prototype.push.call(this,{data:e.data,meta:{currentFile:this.currentFile,percent:r?(t+100*(r-n-1))/r:100}}))},ZipFileWorker.prototype.openedSource=function(e){this.currentSourceOffset=this.bytesWritten,this.currentFile=e.file.name;var t=this.streamFiles&&!e.file.dir;if(t){var r=d(e,t,!1,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);this.push({data:r.fileRecord,meta:{percent:0}})}else this.accumulate=!0},ZipFileWorker.prototype.closedSource=function(e){this.accumulate=!1;var t=this.streamFiles&&!e.file.dir,r=d(e,t,!0,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);if(this.dirRecords.push(r.dirRecord),t)this.push({data:f(e),meta:{percent:100}});else for(this.push({data:r.fileRecord,meta:{percent:0}});this.contentBuffer.length;)this.push(this.contentBuffer.shift());this.currentFile=null},ZipFileWorker.prototype.flush=function(){for(var e=this.bytesWritten,t=0;t<this.dirRecords.length;t++)this.push({data:this.dirRecords[t],meta:{percent:100}});var r=this.bytesWritten-e,n=c(this.dirRecords.length,r,e,this.zipComment,this.encodeFileName);this.push({data:n,meta:{percent:100}})},ZipFileWorker.prototype.prepareNextSource=function(){this.previous=this._sources.shift(),this.openedSource(this.previous.streamInfo),this.isPaused?this.previous.pause():this.previous.resume()},ZipFileWorker.prototype.registerPrevious=function(e){this._sources.push(e);var t=this;return e.on("data",function(e){t.processChunk(e)}),e.on("end",function(){t.closedSource(t.previous.streamInfo),t._sources.length?t.prepareNextSource():t.end()}),e.on("error",function(e){t.error(e)}),this},ZipFileWorker.prototype.resume=function(){return!!i.prototype.resume.call(this)&&(!this.previous&&this._sources.length?(this.prepareNextSource(),!0):this.previous||this._sources.length||this.generatedError?void 0:(this.end(),!0))},ZipFileWorker.prototype.error=function(e){var t=this._sources;if(!i.prototype.error.call(this,e))return!1;for(var r=0;r<t.length;r++)try{t[r].error(e)}catch(e){}return!0},ZipFileWorker.prototype.lock=function(){i.prototype.lock.call(this);for(var e=this._sources,t=0;t<e.length;t++)e[t].lock()},t.exports=ZipFileWorker},{"../crc32":4,"../signature":23,"../stream/GenericWorker":28,"../utf8":31,"../utils":32}],9:[function(e,t,r){"use strict";var n=e("../compressions"),i=e("./ZipFileWorker"),a=function(e,t){var r=e||t,i=n[r];if(!i)throw new Error(r+" is not a valid compression method !");return i};r.generateWorker=function(e,t,r){var n=new i(t.streamFiles,r,t.platform,t.encodeFileName),s=0;try{e.forEach(function(e,r){s++;var i=a(r.options.compression,t.compression),o=r.options.compressionOptions||t.compressionOptions||{},l=r.dir,u=r.date;r._compressWorker(i,o).withStreamInfo("file",{name:e,dir:l,date:u,comment:r.comment||"",unixPermissions:r.unixPermissions,dosPermissions:r.dosPermissions}).pipe(n)}),n.entriesCount=s}catch(e){n.error(e)}return n}},{"../compressions":3,"./ZipFileWorker":8}],10:[function(e,t,r){"use strict";function JSZip(){if(!(this instanceof JSZip))return new JSZip;if(arguments.length)throw new Error("The constructor with parameters has been removed in JSZip 3.0, please check the upgrade guide.");this.files={},this.comment=null,this.root="",this.clone=function(){var e=new JSZip;for(var t in this)"function"!=typeof this[t]&&(e[t]=this[t]);return e}}JSZip.prototype=e("./object"),JSZip.prototype.loadAsync=e("./load"),JSZip.support=e("./support"),JSZip.defaults=e("./defaults"),JSZip.version="3.1.3",JSZip.loadAsync=function(e,t){return(new JSZip).loadAsync(e,t)},JSZip.external=e("./external"),t.exports=JSZip},{"./defaults":5,"./external":6,"./load":11,"./object":15,"./support":30}],11:[function(e,t,r){"use strict";function checkEntryCRC32(e){return new i.Promise(function(t,r){var n=e.decompressed.getContentWorker().pipe(new o);n.on("error",function(e){r(e)}).on("end",function(){n.streamInfo.crc32!==e.decompressed.crc32?r(new Error("Corrupted zip : CRC32 mismatch")):t()}).resume()})}var n=e("./utils"),i=e("./external"),a=e("./utf8"),n=e("./utils"),s=e("./zipEntries"),o=e("./stream/Crc32Probe"),l=e("./nodejsUtils");t.exports=function(e,t){var r=this;return t=n.extend(t||{},{base64:!1,checkCRC32:!1,optimizedBinaryString:!1,createFolders:!1,decodeFileName:a.utf8decode}),l.isNode&&l.isStream(e)?i.Promise.reject(new Error("JSZip can't accept a stream when loading a zip file.")):n.prepareContent("the loaded zip file",e,!0,t.optimizedBinaryString,t.base64).then(function(e){var r=new s(t);return r.load(e),r}).then(function checkCRC32(e){var r=[i.Promise.resolve(e)],n=e.files;if(t.checkCRC32)for(var a=0;a<n.length;a++)r.push(checkEntryCRC32(n[a]));return i.Promise.all(r)}).then(function addFiles(e){for(var n=e.shift(),i=n.files,a=0;a<i.length;a++){var s=i[a];r.file(s.fileNameStr,s.decompressed,{binary:!0,optimizedBinaryString:!0,date:s.date,dir:s.dir,comment:s.fileCommentStr.length?s.fileCommentStr:null,unixPermissions:s.unixPermissions,dosPermissions:s.dosPermissions,createFolders:t.createFolders})}return n.zipComment.length&&(r.comment=n.zipComment),r})}},{"./external":6,"./nodejsUtils":14,"./stream/Crc32Probe":25,"./utf8":31,"./utils":32,"./zipEntries":33}],12:[function(e,t,r){"use strict";function NodejsStreamInputAdapter(e,t){i.call(this,"Nodejs stream input adapter for "+e),this._upstreamEnded=!1,this._bindStream(t)}var n=e("../utils"),i=e("../stream/GenericWorker");n.inherits(NodejsStreamInputAdapter,i),NodejsStreamInputAdapter.prototype._bindStream=function(e){var t=this;this._stream=e,e.pause(),e.on("data",function(e){t.push({data:e,meta:{percent:0}})}).on("error",function(e){t.isPaused?this.generatedError=e:t.error(e)}).on("end",function(){t.isPaused?t._upstreamEnded=!0:t.end()})},NodejsStreamInputAdapter.prototype.pause=function(){return!!i.prototype.pause.call(this)&&(this._stream.pause(),!0)},NodejsStreamInputAdapter.prototype.resume=function(){return!!i.prototype.resume.call(this)&&(this._upstreamEnded?this.end():this._stream.resume(),!0)},t.exports=NodejsStreamInputAdapter},{"../stream/GenericWorker":28,"../utils":32}],13:[function(e,t,r){"use strict";function NodejsStreamOutputAdapter(e,t,r){n.call(this,t),this._helper=e;var i=this;e.on("data",function(e,t){i.push(e)||i._helper.pause(),r&&r(t)}).on("error",function(e){i.emit("error",e)}).on("end",function(){i.push(null)})}var n=e("readable-stream").Readable;e("util").inherits(NodejsStreamOutputAdapter,n),NodejsStreamOutputAdapter.prototype._read=function(){this._helper.resume()},t.exports=NodejsStreamOutputAdapter},{"readable-stream":16,util:void 0}],14:[function(e,t,r){"use strict";t.exports={isNode:"undefined"!=typeof Buffer,newBuffer:function(e,t){return new Buffer(e,t)},isBuffer:function(e){return Buffer.isBuffer(e)},isStream:function(e){return e&&"function"==typeof e.on&&"function"==typeof e.pause&&"function"==typeof e.resume}}},{}],15:[function(e,t,r){"use strict";function isRegExp(e){return"[object RegExp]"===Object.prototype.toString.call(e)}var n=e("./utf8"),i=e("./utils"),a=e("./stream/GenericWorker"),s=e("./stream/StreamHelper"),o=e("./defaults"),l=e("./compressedObject"),u=e("./zipObject"),h=e("./generate"),d=e("./nodejsUtils"),c=e("./nodejs/NodejsStreamInputAdapter"),f=function(e,t,r){var n,s=i.getTypeOf(t),h=i.extend(r||{},o);h.date=h.date||new Date,null!==h.compression&&(h.compression=h.compression.toUpperCase()),"string"==typeof h.unixPermissions&&(h.unixPermissions=parseInt(h.unixPermissions,8)),h.unixPermissions&&16384&h.unixPermissions&&(h.dir=!0),h.dosPermissions&&16&h.dosPermissions&&(h.dir=!0),h.dir&&(e=_(e)),h.createFolders&&(n=p(e))&&m.call(this,n,!0);var f="string"===s&&!1===h.binary&&!1===h.base64;r&&void 0!==r.binary||(h.binary=!f),(t instanceof l&&0===t.uncompressedSize||h.dir||!t||0===t.length)&&(h.base64=!1,h.binary=!0,t="",h.compression="STORE",s="string");var g=null;g=t instanceof l||t instanceof a?t:d.isNode&&d.isStream(t)?new c(e,t):i.prepareContent(e,t,h.binary,h.optimizedBinaryString,h.base64);var b=new u(e,g,h);this.files[e]=b},p=function(e){"/"===e.slice(-1)&&(e=e.substring(0,e.length-1));var t=e.lastIndexOf("/");return t>0?e.substring(0,t):""},_=function(e){return"/"!==e.slice(-1)&&(e+="/"),e},m=function(e,t){return t=void 0!==t?t:o.createFolders,e=_(e),this.files[e]||f.call(this,e,null,{dir:!0,createFolders:t}),this.files[e]},g={load:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},forEach:function(e){var t,r,n;for(t in this.files)this.files.hasOwnProperty(t)&&(n=this.files[t],(r=t.slice(this.root.length,t.length))&&t.slice(0,this.root.length)===this.root&&e(r,n))},filter:function(e){var t=[];return this.forEach(function(r,n){e(r,n)&&t.push(n)}),t},file:function(e,t,r){if(1===arguments.length){if(isRegExp(e)){var n=e;return this.filter(function(e,t){return!t.dir&&n.test(e)})}var i=this.files[this.root+e];return i&&!i.dir?i:null}return e=this.root+e,f.call(this,e,t,r),this},folder:function(e){if(!e)return this;if(isRegExp(e))return this.filter(function(t,r){return r.dir&&e.test(t)});var t=this.root+e,r=m.call(this,t),n=this.clone();return n.root=r.name,n},remove:function(e){e=this.root+e;var t=this.files[e];if(t||("/"!==e.slice(-1)&&(e+="/"),t=this.files[e]),t&&!t.dir)delete this.files[e];else for(var r=this.filter(function(t,r){return r.name.slice(0,e.length)===e}),n=0;n<r.length;n++)delete this.files[r[n].name];return this},generate:function(e){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")},generateInternalStream:function(e){var t,r={};try{if(r=i.extend(e||{},{streamFiles:!1,compression:"STORE",compressionOptions:null,type:"",platform:"DOS",comment:null,mimeType:"application/zip",encodeFileName:n.utf8encode}),r.type=r.type.toLowerCase(),r.compression=r.compression.toUpperCase(),"binarystring"===r.type&&(r.type="string"),!r.type)throw new Error("No output type specified.");i.checkSupport(r.type),"darwin"!==r.platform&&"freebsd"!==r.platform&&"linux"!==r.platform&&"sunos"!==r.platform||(r.platform="UNIX"),"win32"===r.platform&&(r.platform="DOS");var o=r.comment||this.comment||"";t=h.generateWorker(this,r,o)}catch(e){(t=new a("error")).error(e)}return new s(t,r.type||"string",r.mimeType)},generateAsync:function(e,t){return this.generateInternalStream(e).accumulate(t)},generateNodeStream:function(e,t){return(e=e||{}).type||(e.type="nodebuffer"),this.generateInternalStream(e).toNodejsStream(t)}};t.exports=g},{"./compressedObject":2,"./defaults":5,"./generate":9,"./nodejs/NodejsStreamInputAdapter":12,"./nodejsUtils":14,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31,"./utils":32,"./zipObject":35}],16:[function(e,t,r){t.exports=e("stream")},{stream:void 0}],17:[function(e,t,r){"use strict";function ArrayReader(e){n.call(this,e);for(var t=0;t<this.data.length;t++)e[t]=255&e[t]}var n=e("./DataReader");e("../utils").inherits(ArrayReader,n),ArrayReader.prototype.byteAt=function(e){return this.data[this.zero+e]},ArrayReader.prototype.lastIndexOfSignature=function(e){for(var t=e.charCodeAt(0),r=e.charCodeAt(1),n=e.charCodeAt(2),i=e.charCodeAt(3),a=this.length-4;a>=0;--a)if(this.data[a]===t&&this.data[a+1]===r&&this.data[a+2]===n&&this.data[a+3]===i)return a-this.zero;return-1},ArrayReader.prototype.readAndCheckSignature=function(e){var t=e.charCodeAt(0),r=e.charCodeAt(1),n=e.charCodeAt(2),i=e.charCodeAt(3),a=this.readData(4);return t===a[0]&&r===a[1]&&n===a[2]&&i===a[3]},ArrayReader.prototype.readData=function(e){if(this.checkOffset(e),0===e)return[];var t=this.data.slice(this.zero+this.index,this.zero+this.index+e);return this.index+=e,t},t.exports=ArrayReader},{"../utils":32,"./DataReader":18}],18:[function(e,t,r){"use strict";function DataReader(e){this.data=e,this.length=e.length,this.index=0,this.zero=0}var n=e("../utils");DataReader.prototype={checkOffset:function(e){this.checkIndex(this.index+e)},checkIndex:function(e){if(this.length<this.zero+e||e<0)throw new Error("End of data reached (data length = "+this.length+", asked index = "+e+"). Corrupted zip ?")},setIndex:function(e){this.checkIndex(e),this.index=e},skip:function(e){this.setIndex(this.index+e)},byteAt:function(e){},readInt:function(e){var t,r=0;for(this.checkOffset(e),t=this.index+e-1;t>=this.index;t--)r=(r<<8)+this.byteAt(t);return this.index+=e,r},readString:function(e){return n.transformTo("string",this.readData(e))},readData:function(e){},lastIndexOfSignature:function(e){},readAndCheckSignature:function(e){},readDate:function(){var e=this.readInt(4);return new Date(Date.UTC(1980+(e>>25&127),(e>>21&15)-1,e>>16&31,e>>11&31,e>>5&63,(31&e)<<1))}},t.exports=DataReader},{"../utils":32}],19:[function(e,t,r){"use strict";function NodeBufferReader(e){n.call(this,e)}var n=e("./Uint8ArrayReader");e("../utils").inherits(NodeBufferReader,n),NodeBufferReader.prototype.readData=function(e){this.checkOffset(e);var t=this.data.slice(this.zero+this.index,this.zero+this.index+e);return this.index+=e,t},t.exports=NodeBufferReader},{"../utils":32,"./Uint8ArrayReader":21}],20:[function(e,t,r){"use strict";function StringReader(e){n.call(this,e)}var n=e("./DataReader");e("../utils").inherits(StringReader,n),StringReader.prototype.byteAt=function(e){return this.data.charCodeAt(this.zero+e)},StringReader.prototype.lastIndexOfSignature=function(e){return this.data.lastIndexOf(e)-this.zero},StringReader.prototype.readAndCheckSignature=function(e){return e===this.readData(4)},StringReader.prototype.readData=function(e){this.checkOffset(e);var t=this.data.slice(this.zero+this.index,this.zero+this.index+e);return this.index+=e,t},t.exports=StringReader},{"../utils":32,"./DataReader":18}],21:[function(e,t,r){"use strict";function Uint8ArrayReader(e){n.call(this,e)}var n=e("./ArrayReader");e("../utils").inherits(Uint8ArrayReader,n),Uint8ArrayReader.prototype.readData=function(e){if(this.checkOffset(e),0===e)return new Uint8Array(0);var t=this.data.subarray(this.zero+this.index,this.zero+this.index+e);return this.index+=e,t},t.exports=Uint8ArrayReader},{"../utils":32,"./ArrayReader":17}],22:[function(e,t,r){"use strict";var n=e("../utils"),i=e("../support"),a=e("./ArrayReader"),s=e("./StringReader"),o=e("./NodeBufferReader"),l=e("./Uint8ArrayReader");t.exports=function(e){var t=n.getTypeOf(e);return n.checkSupport(t),"string"!==t||i.uint8array?"nodebuffer"===t?new o(e):i.uint8array?new l(n.transformTo("uint8array",e)):new a(n.transformTo("array",e)):new s(e)}},{"../support":30,"../utils":32,"./ArrayReader":17,"./NodeBufferReader":19,"./StringReader":20,"./Uint8ArrayReader":21}],23:[function(e,t,r){"use strict";r.LOCAL_FILE_HEADER="PK",r.CENTRAL_FILE_HEADER="PK",r.CENTRAL_DIRECTORY_END="PK",r.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK",r.ZIP64_CENTRAL_DIRECTORY_END="PK",r.DATA_DESCRIPTOR="PK\b"},{}],24:[function(e,t,r){"use strict";function ConvertWorker(e){n.call(this,"ConvertWorker to "+e),this.destType=e}var n=e("./GenericWorker"),i=e("../utils");i.inherits(ConvertWorker,n),ConvertWorker.prototype.processChunk=function(e){this.push({data:i.transformTo(this.destType,e.data),meta:e.meta})},t.exports=ConvertWorker},{"../utils":32,"./GenericWorker":28}],25:[function(e,t,r){"use strict";function Crc32Probe(){n.call(this,"Crc32Probe"),this.withStreamInfo("crc32",0)}var n=e("./GenericWorker"),i=e("../crc32");e("../utils").inherits(Crc32Probe,n),Crc32Probe.prototype.processChunk=function(e){this.streamInfo.crc32=i(e.data,this.streamInfo.crc32||0),this.push(e)},t.exports=Crc32Probe},{"../crc32":4,"../utils":32,"./GenericWorker":28}],26:[function(e,t,r){"use strict";function DataLengthProbe(e){i.call(this,"DataLengthProbe for "+e),this.propName=e,this.withStreamInfo(e,0)}var n=e("../utils"),i=e("./GenericWorker");n.inherits(DataLengthProbe,i),DataLengthProbe.prototype.processChunk=function(e){if(e){var t=this.streamInfo[this.propName]||0;this.streamInfo[this.propName]=t+e.data.length}i.prototype.processChunk.call(this,e)},t.exports=DataLengthProbe},{"../utils":32,"./GenericWorker":28}],27:[function(e,t,r){"use strict";function DataWorker(e){i.call(this,"DataWorker");var t=this;this.dataIsReady=!1,this.index=0,this.max=0,this.data=null,this.type="",this._tickScheduled=!1,e.then(function(e){t.dataIsReady=!0,t.data=e,t.max=e&&e.length||0,t.type=n.getTypeOf(e),t.isPaused||t._tickAndRepeat()},function(e){t.error(e)})}var n=e("../utils"),i=e("./GenericWorker");n.inherits(DataWorker,i),DataWorker.prototype.cleanUp=function(){i.prototype.cleanUp.call(this),this.data=null},DataWorker.prototype.resume=function(){return!!i.prototype.resume.call(this)&&(!this._tickScheduled&&this.dataIsReady&&(this._tickScheduled=!0,n.delay(this._tickAndRepeat,[],this)),!0)},DataWorker.prototype._tickAndRepeat=function(){this._tickScheduled=!1,this.isPaused||this.isFinished||(this._tick(),this.isFinished||(n.delay(this._tickAndRepeat,[],this),this._tickScheduled=!0))},DataWorker.prototype._tick=function(){if(this.isPaused||this.isFinished)return!1;var e=null,t=Math.min(this.max,this.index+16384);if(this.index>=this.max)return this.end();switch(this.type){case"string":e=this.data.substring(this.index,t);break;case"uint8array":e=this.data.subarray(this.index,t);break;case"array":case"nodebuffer":e=this.data.slice(this.index,t)}return this.index=t,this.push({data:e,meta:{percent:this.max?this.index/this.max*100:0}})},t.exports=DataWorker},{"../utils":32,"./GenericWorker":28}],28:[function(e,t,r){"use strict";function GenericWorker(e){this.name=e||"default",this.streamInfo={},this.generatedError=null,this.extraStreamInfo={},this.isPaused=!0,this.isFinished=!1,this.isLocked=!1,this._listeners={data:[],end:[],error:[]},this.previous=null}GenericWorker.prototype={push:function(e){this.emit("data",e)},end:function(){if(this.isFinished)return!1;this.flush();try{this.emit("end"),this.cleanUp(),this.isFinished=!0}catch(e){this.emit("error",e)}return!0},error:function(e){return!this.isFinished&&(this.isPaused?this.generatedError=e:(this.isFinished=!0,this.emit("error",e),this.previous&&this.previous.error(e),this.cleanUp()),!0)},on:function(e,t){return this._listeners[e].push(t),this},cleanUp:function(){this.streamInfo=this.generatedError=this.extraStreamInfo=null,this._listeners=[]},emit:function(e,t){if(this._listeners[e])for(var r=0;r<this._listeners[e].length;r++)this._listeners[e][r].call(this,t)},pipe:function(e){return e.registerPrevious(this)},registerPrevious:function(e){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.streamInfo=e.streamInfo,this.mergeStreamInfo(),this.previous=e;var t=this;return e.on("data",function(e){t.processChunk(e)}),e.on("end",function(){t.end()}),e.on("error",function(e){t.error(e)}),this},pause:function(){return!this.isPaused&&!this.isFinished&&(this.isPaused=!0,this.previous&&this.previous.pause(),!0)},resume:function(){if(!this.isPaused||this.isFinished)return!1;this.isPaused=!1;var e=!1;return this.generatedError&&(this.error(this.generatedError),e=!0),this.previous&&this.previous.resume(),!e},flush:function(){},processChunk:function(e){this.push(e)},withStreamInfo:function(e,t){return this.extraStreamInfo[e]=t,this.mergeStreamInfo(),this},mergeStreamInfo:function(){for(var e in this.extraStreamInfo)this.extraStreamInfo.hasOwnProperty(e)&&(this.streamInfo[e]=this.extraStreamInfo[e])},lock:function(){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.isLocked=!0,this.previous&&this.previous.lock()},toString:function(){var e="Worker "+this.name;return this.previous?this.previous+" -> "+e:e}},t.exports=GenericWorker},{}],29:[function(e,t,r){"use strict";function transformZipOutput(e,t,r,i){var a=null;switch(e){case"blob":return n.newBlob(r,i);case"base64":return a=concat(t,r),s.encode(a);default:return a=concat(t,r),n.transformTo(e,a)}}function concat(e,t){var r,n=0,i=null,a=0;for(r=0;r<t.length;r++)a+=t[r].length;switch(e){case"string":return t.join("");case"array":return Array.prototype.concat.apply([],t);case"uint8array":for(i=new Uint8Array(a),r=0;r<t.length;r++)i.set(t[r],n),n+=t[r].length;return i;case"nodebuffer":return Buffer.concat(t);default:throw new Error("concat : unsupported type '"+e+"'")}}function accumulate(e,t){return new l.Promise(function(r,n){var i=[],a=e._internalType,s=e._outputType,o=e._mimeType;e.on("data",function(e,r){i.push(e),t&&t(r)}).on("error",function(e){i=[],n(e)}).on("end",function(){try{var e=transformZipOutput(s,a,i,o);r(e)}catch(e){n(e)}i=[]}).resume()})}function StreamHelper(e,t,r){var s=t;switch(t){case"blob":s="arraybuffer";break;case"arraybuffer":s="uint8array";break;case"base64":s="string"}try{this._internalType=s,this._outputType=t,this._mimeType=r,n.checkSupport(s),this._worker=e.pipe(new i(s)),e.lock()}catch(e){this._worker=new a("error"),this._worker.error(e)}}var n=e("../utils"),i=e("./ConvertWorker"),a=e("./GenericWorker"),s=e("../base64"),o=e("../support"),l=e("../external"),u=null;if(o.nodestream)try{u=e("../nodejs/NodejsStreamOutputAdapter")}catch(e){}StreamHelper.prototype={accumulate:function(e){return accumulate(this,e)},on:function(e,t){var r=this;return"data"===e?this._worker.on(e,function(e){t.call(r,e.data,e.meta)}):this._worker.on(e,function(){n.delay(t,arguments,r)}),this},resume:function(){return n.delay(this._worker.resume,[],this._worker),this},pause:function(){return this._worker.pause(),this},toNodejsStream:function(e){if(n.checkSupport("nodestream"),"nodebuffer"!==this._outputType)throw new Error(this._outputType+" is not supported by this method");return new u(this,{objectMode:"nodebuffer"!==this._outputType},e)}},t.exports=StreamHelper},{"../base64":1,"../external":6,"../nodejs/NodejsStreamOutputAdapter":13,"../support":30,"../utils":32,"./ConvertWorker":24,"./GenericWorker":28}],30:[function(e,t,r){"use strict";if(r.base64=!0,r.array=!0,r.string=!0,r.arraybuffer="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof Uint8Array,r.nodebuffer="undefined"!=typeof Buffer,r.uint8array="undefined"!=typeof Uint8Array,"undefined"==typeof ArrayBuffer)r.blob=!1;else{var n=new ArrayBuffer(0);try{r.blob=0===new Blob([n],{type:"application/zip"}).size}catch(e){try{var i=new(window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder);i.append(n),r.blob=0===i.getBlob("application/zip").size}catch(e){r.blob=!1}}}try{r.nodestream=!!e("readable-stream").Readable}catch(e){r.nodestream=!1}},{"readable-stream":16}],31:[function(e,t,r){"use strict";function Utf8DecodeWorker(){s.call(this,"utf-8 decode"),this.leftOver=null}function Utf8EncodeWorker(){s.call(this,"utf-8 encode")}for(var n=e("./utils"),i=e("./support"),a=e("./nodejsUtils"),s=e("./stream/GenericWorker"),o=new Array(256),l=0;l<256;l++)o[l]=l>=252?6:l>=248?5:l>=240?4:l>=224?3:l>=192?2:1;o[254]=o[254]=1;var u=function(e){var t,r,n,a,s,o=e.length,l=0;for(a=0;a<o;a++)55296==(64512&(r=e.charCodeAt(a)))&&a+1<o&&56320==(64512&(n=e.charCodeAt(a+1)))&&(r=65536+(r-55296<<10)+(n-56320),a++),l+=r<128?1:r<2048?2:r<65536?3:4;for(t=i.uint8array?new Uint8Array(l):new Array(l),s=0,a=0;s<l;a++)55296==(64512&(r=e.charCodeAt(a)))&&a+1<o&&56320==(64512&(n=e.charCodeAt(a+1)))&&(r=65536+(r-55296<<10)+(n-56320),a++),r<128?t[s++]=r:r<2048?(t[s++]=192|r>>>6,t[s++]=128|63&r):r<65536?(t[s++]=224|r>>>12,t[s++]=128|r>>>6&63,t[s++]=128|63&r):(t[s++]=240|r>>>18,t[s++]=128|r>>>12&63,t[s++]=128|r>>>6&63,t[s++]=128|63&r);return t},h=function(e,t){var r;for((t=t||e.length)>e.length&&(t=e.length),r=t-1;r>=0&&128==(192&e[r]);)r--;return r<0?t:0===r?t:r+o[e[r]]>t?r:t},d=function(e){var t,r,i,a,s=e.length,l=new Array(2*s);for(r=0,t=0;t<s;)if((i=e[t++])<128)l[r++]=i;else if((a=o[i])>4)l[r++]=65533,t+=a-1;else{for(i&=2===a?31:3===a?15:7;a>1&&t<s;)i=i<<6|63&e[t++],a--;a>1?l[r++]=65533:i<65536?l[r++]=i:(i-=65536,l[r++]=55296|i>>10&1023,l[r++]=56320|1023&i)}return l.length!==r&&(l.subarray?l=l.subarray(0,r):l.length=r),n.applyFromCharCode(l)};r.utf8encode=function utf8encode(e){return i.nodebuffer?a.newBuffer(e,"utf-8"):u(e)},r.utf8decode=function utf8decode(e){return i.nodebuffer?n.transformTo("nodebuffer",e).toString("utf-8"):(e=n.transformTo(i.uint8array?"uint8array":"array",e),d(e))},n.inherits(Utf8DecodeWorker,s),Utf8DecodeWorker.prototype.processChunk=function(e){var t=n.transformTo(i.uint8array?"uint8array":"array",e.data);if(this.leftOver&&this.leftOver.length){if(i.uint8array){var a=t;(t=new Uint8Array(a.length+this.leftOver.length)).set(this.leftOver,0),t.set(a,this.leftOver.length)}else t=this.leftOver.concat(t);this.leftOver=null}var s=h(t),o=t;s!==t.length&&(i.uint8array?(o=t.subarray(0,s),this.leftOver=t.subarray(s,t.length)):(o=t.slice(0,s),this.leftOver=t.slice(s,t.length))),this.push({data:r.utf8decode(o),meta:e.meta})},Utf8DecodeWorker.prototype.flush=function(){this.leftOver&&this.leftOver.length&&(this.push({data:r.utf8decode(this.leftOver),meta:{}}),this.leftOver=null)},r.Utf8DecodeWorker=Utf8DecodeWorker,n.inherits(Utf8EncodeWorker,s),Utf8EncodeWorker.prototype.processChunk=function(e){this.push({data:r.utf8encode(e.data),meta:e.meta})},r.Utf8EncodeWorker=Utf8EncodeWorker},{"./nodejsUtils":14,"./stream/GenericWorker":28,"./support":30,"./utils":32}],32:[function(e,t,r){"use strict";function string2binary(e){var t=null;return t=n.uint8array?new Uint8Array(e.length):new Array(e.length),stringToArrayLike(e,t)}function identity(e){return e}function stringToArrayLike(e,t){for(var r=0;r<e.length;++r)t[r]=255&e.charCodeAt(r);return t}function arrayLikeToString(e){var t=65536,n=r.getTypeOf(e),i=!0;if("uint8array"===n?i=l.applyCanBeUsed.uint8array:"nodebuffer"===n&&(i=l.applyCanBeUsed.nodebuffer),i)for(;t>1;)try{return l.stringifyByChunk(e,n,t)}catch(e){t=Math.floor(t/2)}return l.stringifyByChar(e)}function arrayLikeToArrayLike(e,t){for(var r=0;r<e.length;r++)t[r]=e[r];return t}var n=e("./support"),i=e("./base64"),a=e("./nodejsUtils"),s=e("core-js/library/fn/set-immediate"),o=e("./external");r.newBlob=function(e,t){r.checkSupport("blob");try{return new Blob(e,{type:t})}catch(r){try{for(var n=new(window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder),i=0;i<e.length;i++)n.append(e[i]);return n.getBlob(t)}catch(e){throw new Error("Bug : can't construct the Blob.")}}};var l={stringifyByChunk:function(e,t,r){var n=[],i=0,a=e.length;if(a<=r)return String.fromCharCode.apply(null,e);for(;i<a;)"array"===t||"nodebuffer"===t?n.push(String.fromCharCode.apply(null,e.slice(i,Math.min(i+r,a)))):n.push(String.fromCharCode.apply(null,e.subarray(i,Math.min(i+r,a)))),i+=r;return n.join("")},stringifyByChar:function(e){for(var t="",r=0;r<e.length;r++)t+=String.fromCharCode(e[r]);return t},applyCanBeUsed:{uint8array:function(){try{return n.uint8array&&1===String.fromCharCode.apply(null,new Uint8Array(1)).length}catch(e){return!1}}(),nodebuffer:function(){try{return n.nodebuffer&&1===String.fromCharCode.apply(null,a.newBuffer(1)).length}catch(e){return!1}}()}};r.applyFromCharCode=arrayLikeToString;var u={};u.string={string:identity,array:function(e){return stringToArrayLike(e,new Array(e.length))},arraybuffer:function(e){return u.string.uint8array(e).buffer},uint8array:function(e){return stringToArrayLike(e,new Uint8Array(e.length))},nodebuffer:function(e){return stringToArrayLike(e,a.newBuffer(e.length))}},u.array={string:arrayLikeToString,array:identity,arraybuffer:function(e){return new Uint8Array(e).buffer},uint8array:function(e){return new Uint8Array(e)},nodebuffer:function(e){return a.newBuffer(e)}},u.arraybuffer={string:function(e){return arrayLikeToString(new Uint8Array(e))},array:function(e){return arrayLikeToArrayLike(new Uint8Array(e),new Array(e.byteLength))},arraybuffer:identity,uint8array:function(e){return new Uint8Array(e)},nodebuffer:function(e){return a.newBuffer(new Uint8Array(e))}},u.uint8array={string:arrayLikeToString,array:function(e){return arrayLikeToArrayLike(e,new Array(e.length))},arraybuffer:function(e){var t=new Uint8Array(e.length);return e.length&&t.set(e,0),t.buffer},uint8array:identity,nodebuffer:function(e){return a.newBuffer(e)}},u.nodebuffer={string:arrayLikeToString,array:function(e){return arrayLikeToArrayLike(e,new Array(e.length))},arraybuffer:function(e){return u.nodebuffer.uint8array(e).buffer},uint8array:function(e){return arrayLikeToArrayLike(e,new Uint8Array(e.length))},nodebuffer:identity},r.transformTo=function(e,t){if(t||(t=""),!e)return t;r.checkSupport(e);var n=r.getTypeOf(t);return u[n][e](t)},r.getTypeOf=function(e){return"string"==typeof e?"string":"[object Array]"===Object.prototype.toString.call(e)?"array":n.nodebuffer&&a.isBuffer(e)?"nodebuffer":n.uint8array&&e instanceof Uint8Array?"uint8array":n.arraybuffer&&e instanceof ArrayBuffer?"arraybuffer":void 0},r.checkSupport=function(e){if(!n[e.toLowerCase()])throw new Error(e+" is not supported by this platform")},r.MAX_VALUE_16BITS=65535,r.MAX_VALUE_32BITS=-1,r.pretty=function(e){var t,r,n="";for(r=0;r<(e||"").length;r++)n+="\\x"+((t=e.charCodeAt(r))<16?"0":"")+t.toString(16).toUpperCase();return n},r.delay=function(e,t,r){s(function(){e.apply(r||null,t||[])})},r.inherits=function(e,t){var r=function(){};r.prototype=t.prototype,e.prototype=new r},r.extend=function(){var e,t,r={};for(e=0;e<arguments.length;e++)for(t in arguments[e])arguments[e].hasOwnProperty(t)&&void 0===r[t]&&(r[t]=arguments[e][t]);return r},r.prepareContent=function(e,t,a,s,l){return o.Promise.resolve(t).then(function(e){return n.blob&&(e instanceof Blob||-1!==["[object File]","[object Blob]"].indexOf(Object.prototype.toString.call(e)))&&"undefined"!=typeof FileReader?new o.Promise(function(t,r){var n=new FileReader;n.onload=function(e){t(e.target.result)},n.onerror=function(e){r(e.target.error)},n.readAsArrayBuffer(e)}):e}).then(function(t){var n=r.getTypeOf(t);return n?("arraybuffer"===n?t=r.transformTo("uint8array",t):"string"===n&&(l?t=i.decode(t):a&&!0!==s&&(t=string2binary(t))),t):o.Promise.reject(new Error("The data of '"+e+"' is in an unsupported format !"))})}},{"./base64":1,"./external":6,"./nodejsUtils":14,"./support":30,"core-js/library/fn/set-immediate":36}],33:[function(e,t,r){"use strict";function ZipEntries(e){this.files=[],this.loadOptions=e}var n=e("./reader/readerFor"),i=e("./utils"),a=e("./signature"),s=e("./zipEntry"),o=(e("./utf8"),e("./support"));ZipEntries.prototype={checkSignature:function(e){if(!this.reader.readAndCheckSignature(e)){this.reader.index-=4;var t=this.reader.readString(4);throw new Error("Corrupted zip or bug : unexpected signature ("+i.pretty(t)+", expected "+i.pretty(e)+")")}},isSignature:function(e,t){var r=this.reader.index;this.reader.setIndex(e);var n=this.reader.readString(4)===t;return this.reader.setIndex(r),n},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2),this.diskWithCentralDirStart=this.reader.readInt(2),this.centralDirRecordsOnThisDisk=this.reader.readInt(2),this.centralDirRecords=this.reader.readInt(2),this.centralDirSize=this.reader.readInt(4),this.centralDirOffset=this.reader.readInt(4),this.zipCommentLength=this.reader.readInt(2);var e=this.reader.readData(this.zipCommentLength),t=o.uint8array?"uint8array":"array",r=i.transformTo(t,e);this.zipComment=this.loadOptions.decodeFileName(r)},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8),this.reader.skip(4),this.diskNumber=this.reader.readInt(4),this.diskWithCentralDirStart=this.reader.readInt(4),this.centralDirRecordsOnThisDisk=this.reader.readInt(8),this.centralDirRecords=this.reader.readInt(8),this.centralDirSize=this.reader.readInt(8),this.centralDirOffset=this.reader.readInt(8),this.zip64ExtensibleData={};for(var e,t,r,n=this.zip64EndOfCentralSize-44;0<n;)e=this.reader.readInt(2),t=this.reader.readInt(4),r=this.reader.readData(t),this.zip64ExtensibleData[e]={id:e,length:t,value:r}},readBlockZip64EndOfCentralLocator:function(){if(this.diskWithZip64CentralDirStart=this.reader.readInt(4),this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8),this.disksCount=this.reader.readInt(4),this.disksCount>1)throw new Error("Multi-volumes zip are not supported")},readLocalFiles:function(){var e,t;for(e=0;e<this.files.length;e++)t=this.files[e],this.reader.setIndex(t.localHeaderOffset),this.checkSignature(a.LOCAL_FILE_HEADER),t.readLocalPart(this.reader),t.handleUTF8(),t.processAttributes()},readCentralDir:function(){var e;for(this.reader.setIndex(this.centralDirOffset);this.reader.readAndCheckSignature(a.CENTRAL_FILE_HEADER);)(e=new s({zip64:this.zip64},this.loadOptions)).readCentralPart(this.reader),this.files.push(e);if(this.centralDirRecords!==this.files.length&&0!==this.centralDirRecords&&0===this.files.length)throw new Error("Corrupted zip or bug: expected "+this.centralDirRecords+" records in central dir, got "+this.files.length)},readEndOfCentral:function(){var e=this.reader.lastIndexOfSignature(a.CENTRAL_DIRECTORY_END);if(e<0)throw!this.isSignature(0,a.LOCAL_FILE_HEADER)?new Error("Can't find end of central directory : is this a zip file ? If it is, see http://stuk.github.io/jszip/documentation/howto/read_zip.html"):new Error("Corrupted zip : can't find end of central directory");this.reader.setIndex(e);var t=e;if(this.checkSignature(a.CENTRAL_DIRECTORY_END),this.readBlockEndOfCentral(),this.diskNumber===i.MAX_VALUE_16BITS||this.diskWithCentralDirStart===i.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===i.MAX_VALUE_16BITS||this.centralDirRecords===i.MAX_VALUE_16BITS||this.centralDirSize===i.MAX_VALUE_32BITS||this.centralDirOffset===i.MAX_VALUE_32BITS){if(this.zip64=!0,(e=this.reader.lastIndexOfSignature(a.ZIP64_CENTRAL_DIRECTORY_LOCATOR))<0)throw new Error("Corrupted zip : can't find the ZIP64 end of central directory locator");if(this.reader.setIndex(e),this.checkSignature(a.ZIP64_CENTRAL_DIRECTORY_LOCATOR),this.readBlockZip64EndOfCentralLocator(),!this.isSignature(this.relativeOffsetEndOfZip64CentralDir,a.ZIP64_CENTRAL_DIRECTORY_END)&&(this.relativeOffsetEndOfZip64CentralDir=this.reader.lastIndexOfSignature(a.ZIP64_CENTRAL_DIRECTORY_END),this.relativeOffsetEndOfZip64CentralDir<0))throw new Error("Corrupted zip : can't find the ZIP64 end of central directory");this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir),this.checkSignature(a.ZIP64_CENTRAL_DIRECTORY_END),this.readBlockZip64EndOfCentral()}var r=this.centralDirOffset+this.centralDirSize;this.zip64&&(r+=20,r+=12+this.zip64EndOfCentralSize);var n=t-r;if(n>0)this.isSignature(t,a.CENTRAL_FILE_HEADER)||(this.reader.zero=n);else if(n<0)throw new Error("Corrupted zip: missing "+Math.abs(n)+" bytes.")},prepareReader:function(e){this.reader=n(e)},load:function(e){this.prepareReader(e),this.readEndOfCentral(),this.readCentralDir(),this.readLocalFiles()}},t.exports=ZipEntries},{"./reader/readerFor":22,"./signature":23,"./support":30,"./utf8":31,"./utils":32,"./zipEntry":34}],34:[function(e,t,r){"use strict";function ZipEntry(e,t){this.options=e,this.loadOptions=t}var n=e("./reader/readerFor"),i=e("./utils"),a=e("./compressedObject"),s=e("./crc32"),o=e("./utf8"),l=e("./compressions"),u=e("./support"),h=function(e){for(var t in l)if(l.hasOwnProperty(t)&&l[t].magic===e)return l[t];return null};ZipEntry.prototype={isEncrypted:function(){return 1==(1&this.bitFlag)},useUTF8:function(){return 2048==(2048&this.bitFlag)},readLocalPart:function(e){var t,r;if(e.skip(22),this.fileNameLength=e.readInt(2),r=e.readInt(2),this.fileName=e.readData(this.fileNameLength),e.skip(r),-1===this.compressedSize||-1===this.uncompressedSize)throw new Error("Bug or corrupted zip : didn't get enough informations from the central directory (compressedSize === -1 || uncompressedSize === -1)");if(null===(t=h(this.compressionMethod)))throw new Error("Corrupted zip : compression "+i.pretty(this.compressionMethod)+" unknown (inner file : "+i.transformTo("string",this.fileName)+")");this.decompressed=new a(this.compressedSize,this.uncompressedSize,this.crc32,t,e.readData(this.compressedSize))},readCentralPart:function(e){this.versionMadeBy=e.readInt(2),e.skip(2),this.bitFlag=e.readInt(2),this.compressionMethod=e.readString(2),this.date=e.readDate(),this.crc32=e.readInt(4),this.compressedSize=e.readInt(4),this.uncompressedSize=e.readInt(4);var t=e.readInt(2);if(this.extraFieldsLength=e.readInt(2),this.fileCommentLength=e.readInt(2),this.diskNumberStart=e.readInt(2),this.internalFileAttributes=e.readInt(2),this.externalFileAttributes=e.readInt(4),this.localHeaderOffset=e.readInt(4),this.isEncrypted())throw new Error("Encrypted zip are not supported");e.skip(t),this.readExtraFields(e),this.parseZIP64ExtraField(e),this.fileComment=e.readData(this.fileCommentLength)},processAttributes:function(){this.unixPermissions=null,this.dosPermissions=null;var e=this.versionMadeBy>>8;this.dir=!!(16&this.externalFileAttributes),0===e&&(this.dosPermissions=63&this.externalFileAttributes),3===e&&(this.unixPermissions=this.externalFileAttributes>>16&65535),this.dir||"/"!==this.fileNameStr.slice(-1)||(this.dir=!0)},parseZIP64ExtraField:function(e){if(this.extraFields[1]){var t=n(this.extraFields[1].value);this.uncompressedSize===i.MAX_VALUE_32BITS&&(this.uncompressedSize=t.readInt(8)),this.compressedSize===i.MAX_VALUE_32BITS&&(this.compressedSize=t.readInt(8)),this.localHeaderOffset===i.MAX_VALUE_32BITS&&(this.localHeaderOffset=t.readInt(8)),this.diskNumberStart===i.MAX_VALUE_32BITS&&(this.diskNumberStart=t.readInt(4))}},readExtraFields:function(e){var t,r,n,i=e.index+this.extraFieldsLength;for(this.extraFields||(this.extraFields={});e.index<i;)t=e.readInt(2),r=e.readInt(2),n=e.readData(r),this.extraFields[t]={id:t,length:r,value:n}},handleUTF8:function(){var e=u.uint8array?"uint8array":"array";if(this.useUTF8())this.fileNameStr=o.utf8decode(this.fileName),this.fileCommentStr=o.utf8decode(this.fileComment);else{var t=this.findExtraFieldUnicodePath();if(null!==t)this.fileNameStr=t;else{var r=i.transformTo(e,this.fileName);this.fileNameStr=this.loadOptions.decodeFileName(r)}var n=this.findExtraFieldUnicodeComment();if(null!==n)this.fileCommentStr=n;else{var a=i.transformTo(e,this.fileComment);this.fileCommentStr=this.loadOptions.decodeFileName(a)}}},findExtraFieldUnicodePath:function(){var e=this.extraFields[28789];if(e){var t=n(e.value);return 1!==t.readInt(1)?null:s(this.fileName)!==t.readInt(4)?null:o.utf8decode(t.readData(e.length-5))}return null},findExtraFieldUnicodeComment:function(){var e=this.extraFields[25461];if(e){var t=n(e.value);return 1!==t.readInt(1)?null:s(this.fileComment)!==t.readInt(4)?null:o.utf8decode(t.readData(e.length-5))}return null}},t.exports=ZipEntry},{"./compressedObject":2,"./compressions":3,"./crc32":4,"./reader/readerFor":22,"./support":30,"./utf8":31,"./utils":32}],35:[function(e,t,r){"use strict";var n=e("./stream/StreamHelper"),i=e("./stream/DataWorker"),a=e("./utf8"),s=e("./compressedObject"),o=e("./stream/GenericWorker"),l=function(e,t,r){this.name=e,this.dir=r.dir,this.date=r.date,this.comment=r.comment,this.unixPermissions=r.unixPermissions,this.dosPermissions=r.dosPermissions,this._data=t,this._dataBinary=r.binary,this.options={compression:r.compression,compressionOptions:r.compressionOptions}};l.prototype={internalStream:function(e){var t=e.toLowerCase(),r="string"===t||"text"===t;"binarystring"!==t&&"text"!==t||(t="string");var i=this._decompressWorker(),s=!this._dataBinary;return s&&!r&&(i=i.pipe(new a.Utf8EncodeWorker)),!s&&r&&(i=i.pipe(new a.Utf8DecodeWorker)),new n(i,t,"")},async:function(e,t){return this.internalStream(e).accumulate(t)},nodeStream:function(e,t){return this.internalStream(e||"nodebuffer").toNodejsStream(t)},_compressWorker:function(e,t){if(this._data instanceof s&&this._data.compression.magic===e.magic)return this._data.getCompressedWorker();var r=this._decompressWorker();return this._dataBinary||(r=r.pipe(new a.Utf8EncodeWorker)),s.createWorkerFrom(r,e,t)},_decompressWorker:function(){return this._data instanceof s?this._data.getContentWorker():this._data instanceof o?this._data:new i(this._data)}};for(var u=["asText","asBinary","asNodeBuffer","asUint8Array","asArrayBuffer"],h=0;h<u.length;h++)l.prototype[u[h]]=function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.")};t.exports=l},{"./compressedObject":2,"./stream/DataWorker":27,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31}],36:[function(e,t,r){e("../modules/web.immediate"),t.exports=e("../modules/_core").setImmediate},{"../modules/_core":40,"../modules/web.immediate":56}],37:[function(e,t,r){t.exports=function(e){if("function"!=typeof e)throw TypeError(e+" is not a function!");return e}},{}],38:[function(e,t,r){var n=e("./_is-object");t.exports=function(e){if(!n(e))throw TypeError(e+" is not an object!");return e}},{"./_is-object":51}],39:[function(e,t,r){var n={}.toString;t.exports=function(e){return n.call(e).slice(8,-1)}},{}],40:[function(e,t,r){var n=t.exports={version:"2.3.0"};"number"==typeof __e&&(__e=n)},{}],41:[function(e,t,r){var n=e("./_a-function");t.exports=function(e,t,r){if(n(e),void 0===t)return e;switch(r){case 1:return function(r){return e.call(t,r)};case 2:return function(r,n){return e.call(t,r,n)};case 3:return function(r,n,i){return e.call(t,r,n,i)}}return function(){return e.apply(t,arguments)}}},{"./_a-function":37}],42:[function(e,t,r){t.exports=!e("./_fails")(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},{"./_fails":45}],43:[function(e,t,r){var n=e("./_is-object"),i=e("./_global").document,a=n(i)&&n(i.createElement);t.exports=function(e){return a?i.createElement(e):{}}},{"./_global":46,"./_is-object":51}],44:[function(e,t,r){var n=e("./_global"),i=e("./_core"),a=e("./_ctx"),s=e("./_hide"),o=function(e,t,r){var l,u,h,d=e&o.F,c=e&o.G,f=e&o.S,p=e&o.P,_=e&o.B,m=e&o.W,g=c?i:i[t]||(i[t]={}),b=g.prototype,y=c?n:f?n[t]:(n[t]||{}).prototype;c&&(r=t);for(l in r)(u=!d&&y&&void 0!==y[l])&&l in g||(h=u?y[l]:r[l],g[l]=c&&"function"!=typeof y[l]?r[l]:_&&u?a(h,n):m&&y[l]==h?function(e){var t=function(t,r,n){if(this instanceof e){switch(arguments.length){case 0:return new e;case 1:return new e(t);case 2:return new e(t,r)}return new e(t,r,n)}return e.apply(this,arguments)};return t.prototype=e.prototype,t}(h):p&&"function"==typeof h?a(Function.call,h):h,p&&((g.virtual||(g.virtual={}))[l]=h,e&o.R&&b&&!b[l]&&s(b,l,h)))};o.F=1,o.G=2,o.S=4,o.P=8,o.B=16,o.W=32,o.U=64,o.R=128,t.exports=o},{"./_core":40,"./_ctx":41,"./_global":46,"./_hide":47}],45:[function(e,t,r){t.exports=function(e){try{return!!e()}catch(e){return!0}}},{}],46:[function(e,t,r){var n=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=n)},{}],47:[function(e,t,r){var n=e("./_object-dp"),i=e("./_property-desc");t.exports=e("./_descriptors")?function(e,t,r){return n.f(e,t,i(1,r))}:function(e,t,r){return e[t]=r,e}},{"./_descriptors":42,"./_object-dp":52,"./_property-desc":53}],48:[function(e,t,r){t.exports=e("./_global").document&&document.documentElement},{"./_global":46}],49:[function(e,t,r){t.exports=!e("./_descriptors")&&!e("./_fails")(function(){return 7!=Object.defineProperty(e("./_dom-create")("div"),"a",{get:function(){return 7}}).a})},{"./_descriptors":42,"./_dom-create":43,"./_fails":45}],50:[function(e,t,r){t.exports=function(e,t,r){var n=void 0===r;switch(t.length){case 0:return n?e():e.call(r);case 1:return n?e(t[0]):e.call(r,t[0]);case 2:return n?e(t[0],t[1]):e.call(r,t[0],t[1]);case 3:return n?e(t[0],t[1],t[2]):e.call(r,t[0],t[1],t[2]);case 4:return n?e(t[0],t[1],t[2],t[3]):e.call(r,t[0],t[1],t[2],t[3])}return e.apply(r,t)}},{}],51:[function(e,t,r){t.exports=function(e){return"object"==typeof e?null!==e:"function"==typeof e}},{}],52:[function(e,t,r){var n=e("./_an-object"),i=e("./_ie8-dom-define"),a=e("./_to-primitive"),s=Object.defineProperty;r.f=e("./_descriptors")?Object.defineProperty:function defineProperty(e,t,r){if(n(e),t=a(t,!0),n(r),i)try{return s(e,t,r)}catch(e){}if("get"in r||"set"in r)throw TypeError("Accessors not supported!");return"value"in r&&(e[t]=r.value),e}},{"./_an-object":38,"./_descriptors":42,"./_ie8-dom-define":49,"./_to-primitive":55}],53:[function(e,t,r){t.exports=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}}},{}],54:[function(e,t,r){var n,i,a,s=e("./_ctx"),o=e("./_invoke"),l=e("./_html"),u=e("./_dom-create"),h=e("./_global"),d=h.process,c=h.setImmediate,f=h.clearImmediate,p=h.MessageChannel,_=0,m={},g=function(){var e=+this;if(m.hasOwnProperty(e)){var t=m[e];delete m[e],t()}},b=function(e){g.call(e.data)};c&&f||(c=function setImmediate(e){for(var t=[],r=1;arguments.length>r;)t.push(arguments[r++]);return m[++_]=function(){o("function"==typeof e?e:Function(e),t)},n(_),_},f=function clearImmediate(e){delete m[e]},"process"==e("./_cof")(d)?n=function(e){d.nextTick(s(g,e,1))}:p?(a=(i=new p).port2,i.port1.onmessage=b,n=s(a.postMessage,a,1)):h.addEventListener&&"function"==typeof postMessage&&!h.importScripts?(n=function(e){h.postMessage(e+"","*")},h.addEventListener("message",b,!1)):n="onreadystatechange"in u("script")?function(e){l.appendChild(u("script")).onreadystatechange=function(){l.removeChild(this),g.call(e)}}:function(e){setTimeout(s(g,e,1),0)}),t.exports={set:c,clear:f}},{"./_cof":39,"./_ctx":41,"./_dom-create":43,"./_global":46,"./_html":48,"./_invoke":50}],55:[function(e,t,r){var n=e("./_is-object");t.exports=function(e,t){if(!n(e))return e;var r,i;if(t&&"function"==typeof(r=e.toString)&&!n(i=r.call(e)))return i;if("function"==typeof(r=e.valueOf)&&!n(i=r.call(e)))return i;if(!t&&"function"==typeof(r=e.toString)&&!n(i=r.call(e)))return i;throw TypeError("Can't convert object to primitive value")}},{"./_is-object":51}],56:[function(e,t,r){var n=e("./_export"),i=e("./_task");n(n.G+n.B,{setImmediate:i.set,clearImmediate:i.clear})},{"./_export":44,"./_task":54}],57:[function(e,t,r){(function(e){"use strict";function nextTick(){l=!0;for(var e,t,r=u.length;r;){for(t=u,u=[],e=-1;++e<r;)t[e]();r=u.length}l=!1}var r,n=e.MutationObserver||e.WebKitMutationObserver;if(n){var i=0,a=new n(nextTick),s=e.document.createTextNode("");a.observe(s,{characterData:!0}),r=function(){s.data=i=++i%2}}else if(e.setImmediate||void 0===e.MessageChannel)r="document"in e&&"onreadystatechange"in e.document.createElement("script")?function(){var t=e.document.createElement("script");t.onreadystatechange=function(){nextTick(),t.onreadystatechange=null,t.parentNode.removeChild(t),t=null},e.document.documentElement.appendChild(t)}:function(){setTimeout(nextTick,0)};else{var o=new e.MessageChannel;o.port1.onmessage=nextTick,r=function(){o.port2.postMessage(0)}}var l,u=[];t.exports=function immediate(e){1!==u.push(e)||l||r()}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],58:[function(e,t,r){"use strict";function INTERNAL(){}function Promise(e){if("function"!=typeof e)throw new TypeError("resolver must be a function");this.state=o,this.queue=[],this.outcome=void 0,e!==INTERNAL&&safelyResolveThenable(this,e)}function QueueItem(e,t,r){this.promise=e,"function"==typeof t&&(this.onFulfilled=t,this.callFulfilled=this.otherCallFulfilled),"function"==typeof r&&(this.onRejected=r,this.callRejected=this.otherCallRejected)}function unwrap(e,t,r){n(function(){var n;try{n=t(r)}catch(t){return i.reject(e,t)}n===e?i.reject(e,new TypeError("Cannot resolve promise with itself")):i.resolve(e,n)})}function getThen(e){var t=e&&e.then;if(e&&"object"==typeof e&&"function"==typeof t)return function appyThen(){t.apply(e,arguments)}}function safelyResolveThenable(e,t){function onError(t){r||(r=!0,i.reject(e,t))}function onSuccess(t){r||(r=!0,i.resolve(e,t))}var r=!1,n=tryCatch(function tryToUnwrap(){t(onSuccess,onError)});"error"===n.status&&onError(n.value)}function tryCatch(e,t){var r={};try{r.value=e(t),r.status="success"}catch(e){r.status="error",r.value=e}return r}var n=e("immediate"),i={},a=["REJECTED"],s=["FULFILLED"],o=["PENDING"];t.exports=Promise,Promise.prototype.catch=function(e){return this.then(null,e)},Promise.prototype.then=function(e,t){if("function"!=typeof e&&this.state===s||"function"!=typeof t&&this.state===a)return this;var r=new this.constructor(INTERNAL);return this.state!==o?unwrap(r,this.state===s?e:t,this.outcome):this.queue.push(new QueueItem(r,e,t)),r},QueueItem.prototype.callFulfilled=function(e){i.resolve(this.promise,e)},QueueItem.prototype.otherCallFulfilled=function(e){unwrap(this.promise,this.onFulfilled,e)},QueueItem.prototype.callRejected=function(e){i.reject(this.promise,e)},QueueItem.prototype.otherCallRejected=function(e){unwrap(this.promise,this.onRejected,e)},i.resolve=function(e,t){var r=tryCatch(getThen,t);if("error"===r.status)return i.reject(e,r.value);var n=r.value;if(n)safelyResolveThenable(e,n);else{e.state=s,e.outcome=t;for(var a=-1,o=e.queue.length;++a<o;)e.queue[a].callFulfilled(t)}return e},i.reject=function(e,t){e.state=a,e.outcome=t;for(var r=-1,n=e.queue.length;++r<n;)e.queue[r].callRejected(t);return e},Promise.resolve=function resolve(e){return e instanceof this?e:i.resolve(new this(INTERNAL),e)},Promise.reject=function reject(e){var t=new this(INTERNAL);return i.reject(t,e)},Promise.all=function all(e){var t=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var r=e.length,n=!1;if(!r)return this.resolve([]);for(var a=new Array(r),s=0,o=-1,l=new this(INTERNAL);++o<r;)!function allResolver(e,o){t.resolve(e).then(function resolveFromAll(e){a[o]=e,++s!==r||n||(n=!0,i.resolve(l,a))},function(e){n||(n=!0,i.reject(l,e))})}(e[o],o);return l},Promise.race=function race(e){var t=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var r=e.length,n=!1;if(!r)return this.resolve([]);for(var a=-1,s=new this(INTERNAL);++a<r;)!function resolver(e){t.resolve(e).then(function(e){n||(n=!0,i.resolve(s,e))},function(e){n||(n=!0,i.reject(s,e))})}(e[a]);return s}},{immediate:57}],59:[function(e,t,r){"use strict";var n={};(0,e("./lib/utils/common").assign)(n,e("./lib/deflate"),e("./lib/inflate"),e("./lib/zlib/constants")),t.exports=n},{"./lib/deflate":60,"./lib/inflate":61,"./lib/utils/common":62,"./lib/zlib/constants":65}],60:[function(e,t,r){"use strict";function Deflate(e){if(!(this instanceof Deflate))return new Deflate(e);this.options=i.assign({level:h,method:c,chunkSize:16384,windowBits:15,memLevel:8,strategy:d,to:""},e||{});var t=this.options;t.raw&&t.windowBits>0?t.windowBits=-t.windowBits:t.gzip&&t.windowBits>0&&t.windowBits<16&&(t.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new o,this.strm.avail_out=0;var r=n.deflateInit2(this.strm,t.level,t.method,t.windowBits,t.memLevel,t.strategy);if(r!==u)throw new Error(s[r]);if(t.header&&n.deflateSetHeader(this.strm,t.header),t.dictionary){var f;if(f="string"==typeof t.dictionary?a.string2buf(t.dictionary):"[object ArrayBuffer]"===l.call(t.dictionary)?new Uint8Array(t.dictionary):t.dictionary,(r=n.deflateSetDictionary(this.strm,f))!==u)throw new Error(s[r]);this._dict_set=!0}}function deflate(e,t){var r=new Deflate(t);if(r.push(e,!0),r.err)throw r.msg;return r.result}var n=e("./zlib/deflate"),i=e("./utils/common"),a=e("./utils/strings"),s=e("./zlib/messages"),o=e("./zlib/zstream"),l=Object.prototype.toString,u=0,h=-1,d=0,c=8;Deflate.prototype.push=function(e,t){var r,s,o=this.strm,h=this.options.chunkSize;if(this.ended)return!1;s=t===~~t?t:!0===t?4:0,"string"==typeof e?o.input=a.string2buf(e):"[object ArrayBuffer]"===l.call(e)?o.input=new Uint8Array(e):o.input=e,o.next_in=0,o.avail_in=o.input.length;do{if(0===o.avail_out&&(o.output=new i.Buf8(h),o.next_out=0,o.avail_out=h),1!==(r=n.deflate(o,s))&&r!==u)return this.onEnd(r),this.ended=!0,!1;0!==o.avail_out&&(0!==o.avail_in||4!==s&&2!==s)||("string"===this.options.to?this.onData(a.buf2binstring(i.shrinkBuf(o.output,o.next_out))):this.onData(i.shrinkBuf(o.output,o.next_out)))}while((o.avail_in>0||0===o.avail_out)&&1!==r);return 4===s?(r=n.deflateEnd(this.strm),this.onEnd(r),this.ended=!0,r===u):2!==s||(this.onEnd(u),o.avail_out=0,!0)},Deflate.prototype.onData=function(e){this.chunks.push(e)},Deflate.prototype.onEnd=function(e){e===u&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=i.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg},r.Deflate=Deflate,r.deflate=deflate,r.deflateRaw=function deflateRaw(e,t){return t=t||{},t.raw=!0,deflate(e,t)},r.gzip=function gzip(e,t){return t=t||{},t.gzip=!0,deflate(e,t)}},{"./utils/common":62,"./utils/strings":63,"./zlib/deflate":67,"./zlib/messages":72,"./zlib/zstream":74}],61:[function(e,t,r){"use strict";function Inflate(e){if(!(this instanceof Inflate))return new Inflate(e);this.options=i.assign({chunkSize:16384,windowBits:0,to:""},e||{});var t=this.options;t.raw&&t.windowBits>=0&&t.windowBits<16&&(t.windowBits=-t.windowBits,0===t.windowBits&&(t.windowBits=-15)),!(t.windowBits>=0&&t.windowBits<16)||e&&e.windowBits||(t.windowBits+=32),t.windowBits>15&&t.windowBits<48&&0==(15&t.windowBits)&&(t.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new l,this.strm.avail_out=0;var r=n.inflateInit2(this.strm,t.windowBits);if(r!==s.Z_OK)throw new Error(o[r]);this.header=new u,n.inflateGetHeader(this.strm,this.header)}function inflate(e,t){var r=new Inflate(t);if(r.push(e,!0),r.err)throw r.msg;return r.result}var n=e("./zlib/inflate"),i=e("./utils/common"),a=e("./utils/strings"),s=e("./zlib/constants"),o=e("./zlib/messages"),l=e("./zlib/zstream"),u=e("./zlib/gzheader"),h=Object.prototype.toString;Inflate.prototype.push=function(e,t){var r,o,l,u,d,c,f=this.strm,p=this.options.chunkSize,_=this.options.dictionary,m=!1;if(this.ended)return!1;o=t===~~t?t:!0===t?s.Z_FINISH:s.Z_NO_FLUSH,"string"==typeof e?f.input=a.binstring2buf(e):"[object ArrayBuffer]"===h.call(e)?f.input=new Uint8Array(e):f.input=e,f.next_in=0,f.avail_in=f.input.length;do{if(0===f.avail_out&&(f.output=new i.Buf8(p),f.next_out=0,f.avail_out=p),(r=n.inflate(f,s.Z_NO_FLUSH))===s.Z_NEED_DICT&&_&&(c="string"==typeof _?a.string2buf(_):"[object ArrayBuffer]"===h.call(_)?new Uint8Array(_):_,r=n.inflateSetDictionary(this.strm,c)),r===s.Z_BUF_ERROR&&!0===m&&(r=s.Z_OK,m=!1),r!==s.Z_STREAM_END&&r!==s.Z_OK)return this.onEnd(r),this.ended=!0,!1;f.next_out&&(0!==f.avail_out&&r!==s.Z_STREAM_END&&(0!==f.avail_in||o!==s.Z_FINISH&&o!==s.Z_SYNC_FLUSH)||("string"===this.options.to?(l=a.utf8border(f.output,f.next_out),u=f.next_out-l,d=a.buf2string(f.output,l),f.next_out=u,f.avail_out=p-u,u&&i.arraySet(f.output,f.output,l,u,0),this.onData(d)):this.onData(i.shrinkBuf(f.output,f.next_out)))),0===f.avail_in&&0===f.avail_out&&(m=!0)}while((f.avail_in>0||0===f.avail_out)&&r!==s.Z_STREAM_END);return r===s.Z_STREAM_END&&(o=s.Z_FINISH),o===s.Z_FINISH?(r=n.inflateEnd(this.strm),this.onEnd(r),this.ended=!0,r===s.Z_OK):o!==s.Z_SYNC_FLUSH||(this.onEnd(s.Z_OK),f.avail_out=0,!0)},Inflate.prototype.onData=function(e){this.chunks.push(e)},Inflate.prototype.onEnd=function(e){e===s.Z_OK&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=i.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg},r.Inflate=Inflate,r.inflate=inflate,r.inflateRaw=function inflateRaw(e,t){return t=t||{},t.raw=!0,inflate(e,t)},r.ungzip=inflate},{"./utils/common":62,"./utils/strings":63,"./zlib/constants":65,"./zlib/gzheader":68,"./zlib/inflate":70,"./zlib/messages":72,"./zlib/zstream":74}],62:[function(e,t,r){"use strict";var n="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Int32Array;r.assign=function(e){for(var t=Array.prototype.slice.call(arguments,1);t.length;){var r=t.shift();if(r){if("object"!=typeof r)throw new TypeError(r+"must be non-object");for(var n in r)r.hasOwnProperty(n)&&(e[n]=r[n])}}return e},r.shrinkBuf=function(e,t){return e.length===t?e:e.subarray?e.subarray(0,t):(e.length=t,e)};var i={arraySet:function(e,t,r,n,i){if(t.subarray&&e.subarray)e.set(t.subarray(r,r+n),i);else for(var a=0;a<n;a++)e[i+a]=t[r+a]},flattenChunks:function(e){var t,r,n,i,a,s;for(n=0,t=0,r=e.length;t<r;t++)n+=e[t].length;for(s=new Uint8Array(n),i=0,t=0,r=e.length;t<r;t++)a=e[t],s.set(a,i),i+=a.length;return s}},a={arraySet:function(e,t,r,n,i){for(var a=0;a<n;a++)e[i+a]=t[r+a]},flattenChunks:function(e){return[].concat.apply([],e)}};r.setTyped=function(e){e?(r.Buf8=Uint8Array,r.Buf16=Uint16Array,r.Buf32=Int32Array,r.assign(r,i)):(r.Buf8=Array,r.Buf16=Array,r.Buf32=Array,r.assign(r,a))},r.setTyped(n)},{}],63:[function(e,t,r){"use strict";function buf2binstring(e,t){if(t<65537&&(e.subarray&&a||!e.subarray&&i))return String.fromCharCode.apply(null,n.shrinkBuf(e,t));for(var r="",s=0;s<t;s++)r+=String.fromCharCode(e[s]);return r}var n=e("./common"),i=!0,a=!0;try{String.fromCharCode.apply(null,[0])}catch(e){i=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(e){a=!1}for(var s=new n.Buf8(256),o=0;o<256;o++)s[o]=o>=252?6:o>=248?5:o>=240?4:o>=224?3:o>=192?2:1;s[254]=s[254]=1,r.string2buf=function(e){var t,r,i,a,s,o=e.length,l=0;for(a=0;a<o;a++)55296==(64512&(r=e.charCodeAt(a)))&&a+1<o&&56320==(64512&(i=e.charCodeAt(a+1)))&&(r=65536+(r-55296<<10)+(i-56320),a++),l+=r<128?1:r<2048?2:r<65536?3:4;for(t=new n.Buf8(l),s=0,a=0;s<l;a++)55296==(64512&(r=e.charCodeAt(a)))&&a+1<o&&56320==(64512&(i=e.charCodeAt(a+1)))&&(r=65536+(r-55296<<10)+(i-56320),a++),r<128?t[s++]=r:r<2048?(t[s++]=192|r>>>6,t[s++]=128|63&r):r<65536?(t[s++]=224|r>>>12,t[s++]=128|r>>>6&63,t[s++]=128|63&r):(t[s++]=240|r>>>18,t[s++]=128|r>>>12&63,t[s++]=128|r>>>6&63,t[s++]=128|63&r);return t},r.buf2binstring=function(e){return buf2binstring(e,e.length)},r.binstring2buf=function(e){for(var t=new n.Buf8(e.length),r=0,i=t.length;r<i;r++)t[r]=e.charCodeAt(r);return t},r.buf2string=function(e,t){var r,n,i,a,o=t||e.length,l=new Array(2*o);for(n=0,r=0;r<o;)if((i=e[r++])<128)l[n++]=i;else if((a=s[i])>4)l[n++]=65533,r+=a-1;else{for(i&=2===a?31:3===a?15:7;a>1&&r<o;)i=i<<6|63&e[r++],a--;a>1?l[n++]=65533:i<65536?l[n++]=i:(i-=65536,l[n++]=55296|i>>10&1023,l[n++]=56320|1023&i)}return buf2binstring(l,n)},r.utf8border=function(e,t){var r;for((t=t||e.length)>e.length&&(t=e.length),r=t-1;r>=0&&128==(192&e[r]);)r--;return r<0?t:0===r?t:r+s[e[r]]>t?r:t}},{"./common":62}],64:[function(e,t,r){"use strict";t.exports=function adler32(e,t,r,n){for(var i=65535&e|0,a=e>>>16&65535|0,s=0;0!==r;){r-=s=r>2e3?2e3:r;do{a=a+(i=i+t[n++]|0)|0}while(--s);i%=65521,a%=65521}return i|a<<16|0}},{}],65:[function(e,t,r){"use strict";t.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}},{}],66:[function(e,t,r){"use strict";var n=function makeTable(){for(var e,t=[],r=0;r<256;r++){e=r;for(var n=0;n<8;n++)e=1&e?3988292384^e>>>1:e>>>1;t[r]=e}return t}();t.exports=function crc32(e,t,r,i){var a=n,s=i+r;e^=-1;for(var o=i;o<s;o++)e=e>>>8^a[255&(e^t[o])];return-1^e}},{}],67:[function(e,t,r){"use strict";function err(e,t){return e.msg=l[t],t}function rank(e){return(e<<1)-(e>4?9:0)}function zero(e){for(var t=e.length;--t>=0;)e[t]=0}function flush_pending(e){var t=e.state,r=t.pending;r>e.avail_out&&(r=e.avail_out),0!==r&&(i.arraySet(e.output,t.pending_buf,t.pending_out,r,e.next_out),e.next_out+=r,t.pending_out+=r,e.total_out+=r,e.avail_out-=r,t.pending-=r,0===t.pending&&(t.pending_out=0))}function flush_block_only(e,t){a._tr_flush_block(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,flush_pending(e.strm)}function put_byte(e,t){e.pending_buf[e.pending++]=t}function putShortMSB(e,t){e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=255&t}function read_buf(e,t,r,n){var a=e.avail_in;return a>n&&(a=n),0===a?0:(e.avail_in-=a,i.arraySet(t,e.input,e.next_in,a,r),1===e.state.wrap?e.adler=s(e.adler,t,a,r):2===e.state.wrap&&(e.adler=o(e.adler,t,a,r)),e.next_in+=a,e.total_in+=a,a)}function longest_match(e,t){var r,n,i=e.max_chain_length,a=e.strstart,s=e.prev_length,o=e.nice_match,l=e.strstart>e.w_size-L?e.strstart-(e.w_size-L):0,u=e.window,h=e.w_mask,d=e.prev,c=e.strstart+N,f=u[a+s-1],p=u[a+s];e.prev_length>=e.good_match&&(i>>=2),o>e.lookahead&&(o=e.lookahead);do{if(r=t,u[r+s]===p&&u[r+s-1]===f&&u[r]===u[a]&&u[++r]===u[a+1]){a+=2,r++;do{}while(u[++a]===u[++r]&&u[++a]===u[++r]&&u[++a]===u[++r]&&u[++a]===u[++r]&&u[++a]===u[++r]&&u[++a]===u[++r]&&u[++a]===u[++r]&&u[++a]===u[++r]&&a<c);if(n=N-(c-a),a=c-N,n>s){if(e.match_start=t,s=n,n>=o)break;f=u[a+s-1],p=u[a+s]}}}while((t=d[t&h])>l&&0!=--i);return s<=e.lookahead?s:e.lookahead}function fill_window(e){var t,r,n,a,s,o=e.w_size;do{if(a=e.window_size-e.lookahead-e.strstart,e.strstart>=o+(o-L)){i.arraySet(e.window,e.window,o,o,0),e.match_start-=o,e.strstart-=o,e.block_start-=o,t=r=e.hash_size;do{n=e.head[--t],e.head[t]=n>=o?n-o:0}while(--r);t=r=o;do{n=e.prev[--t],e.prev[t]=n>=o?n-o:0}while(--r);a+=o}if(0===e.strm.avail_in)break;if(r=read_buf(e.strm,e.window,e.strstart+e.lookahead,a),e.lookahead+=r,e.lookahead+e.insert>=F)for(s=e.strstart-e.insert,e.ins_h=e.window[s],e.ins_h=(e.ins_h<<e.hash_shift^e.window[s+1])&e.hash_mask;e.insert&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[s+F-1])&e.hash_mask,e.prev[s&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=s,s++,e.insert--,!(e.lookahead+e.insert<F)););}while(e.lookahead<L&&0!==e.strm.avail_in)}function deflate_fast(e,t){for(var r,n;;){if(e.lookahead<L){if(fill_window(e),e.lookahead<L&&t===u)return K;if(0===e.lookahead)break}if(r=0,e.lookahead>=F&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+F-1])&e.hash_mask,r=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),0!==r&&e.strstart-r<=e.w_size-L&&(e.match_length=longest_match(e,r)),e.match_length>=F)if(n=a._tr_tally(e,e.strstart-e.match_start,e.match_length-F),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=F){e.match_length--;do{e.strstart++,e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+F-1])&e.hash_mask,r=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart}while(0!=--e.match_length);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+1])&e.hash_mask;else n=a._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(n&&(flush_block_only(e,!1),0===e.strm.avail_out))return K}return e.insert=e.strstart<F-1?e.strstart:F-1,t===c?(flush_block_only(e,!0),0===e.strm.avail_out?Y:X):e.last_lit&&(flush_block_only(e,!1),0===e.strm.avail_out)?K:J}function deflate_slow(e,t){for(var r,n,i;;){if(e.lookahead<L){if(fill_window(e),e.lookahead<L&&t===u)return K;if(0===e.lookahead)break}if(r=0,e.lookahead>=F&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+F-1])&e.hash_mask,r=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=F-1,0!==r&&e.prev_length<e.max_lazy_match&&e.strstart-r<=e.w_size-L&&(e.match_length=longest_match(e,r),e.match_length<=5&&(e.strategy===w||e.match_length===F&&e.strstart-e.match_start>4096)&&(e.match_length=F-1)),e.prev_length>=F&&e.match_length<=e.prev_length){i=e.strstart+e.lookahead-F,n=a._tr_tally(e,e.strstart-1-e.prev_match,e.prev_length-F),e.lookahead-=e.prev_length-1,e.prev_length-=2;do{++e.strstart<=i&&(e.ins_h=(e.ins_h<<e.hash_shift^e.window[e.strstart+F-1])&e.hash_mask,r=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart)}while(0!=--e.prev_length);if(e.match_available=0,e.match_length=F-1,e.strstart++,n&&(flush_block_only(e,!1),0===e.strm.avail_out))return K}else if(e.match_available){if((n=a._tr_tally(e,0,e.window[e.strstart-1]))&&flush_block_only(e,!1),e.strstart++,e.lookahead--,0===e.strm.avail_out)return K}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(n=a._tr_tally(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<F-1?e.strstart:F-1,t===c?(flush_block_only(e,!0),0===e.strm.avail_out?Y:X):e.last_lit&&(flush_block_only(e,!1),0===e.strm.avail_out)?K:J}function deflate_rle(e,t){for(var r,n,i,s,o=e.window;;){if(e.lookahead<=N){if(fill_window(e),e.lookahead<=N&&t===u)return K;if(0===e.lookahead)break}if(e.match_length=0,e.lookahead>=F&&e.strstart>0&&(i=e.strstart-1,(n=o[i])===o[++i]&&n===o[++i]&&n===o[++i])){s=e.strstart+N;do{}while(n===o[++i]&&n===o[++i]&&n===o[++i]&&n===o[++i]&&n===o[++i]&&n===o[++i]&&n===o[++i]&&n===o[++i]&&i<s);e.match_length=N-(s-i),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=F?(r=a._tr_tally(e,1,e.match_length-F),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(r=a._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),r&&(flush_block_only(e,!1),0===e.strm.avail_out))return K}return e.insert=0,t===c?(flush_block_only(e,!0),0===e.strm.avail_out?Y:X):e.last_lit&&(flush_block_only(e,!1),0===e.strm.avail_out)?K:J}function deflate_huff(e,t){for(var r;;){if(0===e.lookahead&&(fill_window(e),0===e.lookahead)){if(t===u)return K;break}if(e.match_length=0,r=a._tr_tally(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,r&&(flush_block_only(e,!1),0===e.strm.avail_out))return K}return e.insert=0,t===c?(flush_block_only(e,!0),0===e.strm.avail_out?Y:X):e.last_lit&&(flush_block_only(e,!1),0===e.strm.avail_out)?K:J}function Config(e,t,r,n,i){this.good_length=e,this.max_lazy=t,this.nice_length=r,this.max_chain=n,this.func=i}function lm_init(e){e.window_size=2*e.w_size,zero(e.head),e.max_lazy_match=n[e.level].max_lazy,e.good_match=n[e.level].good_length,e.nice_match=n[e.level].nice_length,e.max_chain_length=n[e.level].max_chain,e.strstart=0,e.block_start=0,e.lookahead=0,e.insert=0,e.match_length=e.prev_length=F-1,e.match_available=0,e.ins_h=0}function DeflateState(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=C,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new i.Buf16(2*D),this.dyn_dtree=new i.Buf16(2*(2*T+1)),this.bl_tree=new i.Buf16(2*(2*O+1)),zero(this.dyn_ltree),zero(this.dyn_dtree),zero(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new i.Buf16(B+1),this.heap=new i.Buf16(2*R+1),zero(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new i.Buf16(2*R+1),zero(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function deflateResetKeep(e){var t;return e&&e.state?(e.total_in=e.total_out=0,e.data_type=z,t=e.state,t.pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=t.wrap?U:H,e.adler=2===t.wrap?0:1,t.last_flush=u,a._tr_init(t),p):err(e,m)}function deflateReset(e){var t=deflateResetKeep(e);return t===p&&lm_init(e.state),t}function deflateInit2(e,t,r,n,a,s){if(!e)return m;var o=1;if(t===y&&(t=6),n<0?(o=0,n=-n):n>15&&(o=2,n-=16),a<1||a>A||r!==C||n<8||n>15||t<0||t>9||s<0||s>x)return err(e,m);8===n&&(n=9);var l=new DeflateState;return e.state=l,l.strm=e,l.wrap=o,l.gzhead=null,l.w_bits=n,l.w_size=1<<l.w_bits,l.w_mask=l.w_size-1,l.hash_bits=a+7,l.hash_size=1<<l.hash_bits,l.hash_mask=l.hash_size-1,l.hash_shift=~~((l.hash_bits+F-1)/F),l.window=new i.Buf8(2*l.w_size),l.head=new i.Buf16(l.hash_size),l.prev=new i.Buf16(l.w_size),l.lit_bufsize=1<<a+6,l.pending_buf_size=4*l.lit_bufsize,l.pending_buf=new i.Buf8(l.pending_buf_size),l.d_buf=1*l.lit_bufsize,l.l_buf=3*l.lit_bufsize,l.level=t,l.strategy=s,l.method=r,deflateReset(e)}var n,i=e("../utils/common"),a=e("./trees"),s=e("./adler32"),o=e("./crc32"),l=e("./messages"),u=0,h=1,d=3,c=4,f=5,p=0,_=1,m=-2,g=-3,b=-5,y=-1,w=1,v=2,k=3,x=4,S=0,z=2,C=8,A=9,E=15,I=8,R=286,T=30,O=19,D=2*R+1,B=15,F=3,N=258,L=N+F+1,P=32,U=42,W=69,j=73,Z=91,M=103,H=113,G=666,K=1,J=2,Y=3,X=4,q=3;n=[new Config(0,0,0,0,function deflate_stored(e,t){var r=65535;for(r>e.pending_buf_size-5&&(r=e.pending_buf_size-5);;){if(e.lookahead<=1){if(fill_window(e),0===e.lookahead&&t===u)return K;if(0===e.lookahead)break}e.strstart+=e.lookahead,e.lookahead=0;var n=e.block_start+r;if((0===e.strstart||e.strstart>=n)&&(e.lookahead=e.strstart-n,e.strstart=n,flush_block_only(e,!1),0===e.strm.avail_out))return K;if(e.strstart-e.block_start>=e.w_size-L&&(flush_block_only(e,!1),0===e.strm.avail_out))return K}return e.insert=0,t===c?(flush_block_only(e,!0),0===e.strm.avail_out?Y:X):(e.strstart>e.block_start&&(flush_block_only(e,!1),e.strm.avail_out),K)}),new Config(4,4,8,4,deflate_fast),new Config(4,5,16,8,deflate_fast),new Config(4,6,32,32,deflate_fast),new Config(4,4,16,16,deflate_slow),new Config(8,16,32,32,deflate_slow),new Config(8,16,128,128,deflate_slow),new Config(8,32,128,256,deflate_slow),new Config(32,128,258,1024,deflate_slow),new Config(32,258,258,4096,deflate_slow)],r.deflateInit=function deflateInit(e,t){return deflateInit2(e,t,C,E,I,S)},r.deflateInit2=deflateInit2,r.deflateReset=deflateReset,r.deflateResetKeep=deflateResetKeep,r.deflateSetHeader=function deflateSetHeader(e,t){return e&&e.state?2!==e.state.wrap?m:(e.state.gzhead=t,p):m},r.deflate=function deflate(e,t){var r,i,s,l;if(!e||!e.state||t>f||t<0)return e?err(e,m):m;if(i=e.state,!e.output||!e.input&&0!==e.avail_in||i.status===G&&t!==c)return err(e,0===e.avail_out?b:m);if(i.strm=e,r=i.last_flush,i.last_flush=t,i.status===U)if(2===i.wrap)e.adler=0,put_byte(i,31),put_byte(i,139),put_byte(i,8),i.gzhead?(put_byte(i,(i.gzhead.text?1:0)+(i.gzhead.hcrc?2:0)+(i.gzhead.extra?4:0)+(i.gzhead.name?8:0)+(i.gzhead.comment?16:0)),put_byte(i,255&i.gzhead.time),put_byte(i,i.gzhead.time>>8&255),put_byte(i,i.gzhead.time>>16&255),put_byte(i,i.gzhead.time>>24&255),put_byte(i,9===i.level?2:i.strategy>=v||i.level<2?4:0),put_byte(i,255&i.gzhead.os),i.gzhead.extra&&i.gzhead.extra.length&&(put_byte(i,255&i.gzhead.extra.length),put_byte(i,i.gzhead.extra.length>>8&255)),i.gzhead.hcrc&&(e.adler=o(e.adler,i.pending_buf,i.pending,0)),i.gzindex=0,i.status=W):(put_byte(i,0),put_byte(i,0),put_byte(i,0),put_byte(i,0),put_byte(i,0),put_byte(i,9===i.level?2:i.strategy>=v||i.level<2?4:0),put_byte(i,q),i.status=H);else{var g=C+(i.w_bits-8<<4)<<8;g|=(i.strategy>=v||i.level<2?0:i.level<6?1:6===i.level?2:3)<<6,0!==i.strstart&&(g|=P),g+=31-g%31,i.status=H,putShortMSB(i,g),0!==i.strstart&&(putShortMSB(i,e.adler>>>16),putShortMSB(i,65535&e.adler)),e.adler=1}if(i.status===W)if(i.gzhead.extra){for(s=i.pending;i.gzindex<(65535&i.gzhead.extra.length)&&(i.pending!==i.pending_buf_size||(i.gzhead.hcrc&&i.pending>s&&(e.adler=o(e.adler,i.pending_buf,i.pending-s,s)),flush_pending(e),s=i.pending,i.pending!==i.pending_buf_size));)put_byte(i,255&i.gzhead.extra[i.gzindex]),i.gzindex++;i.gzhead.hcrc&&i.pending>s&&(e.adler=o(e.adler,i.pending_buf,i.pending-s,s)),i.gzindex===i.gzhead.extra.length&&(i.gzindex=0,i.status=j)}else i.status=j;if(i.status===j)if(i.gzhead.name){s=i.pending;do{if(i.pending===i.pending_buf_size&&(i.gzhead.hcrc&&i.pending>s&&(e.adler=o(e.adler,i.pending_buf,i.pending-s,s)),flush_pending(e),s=i.pending,i.pending===i.pending_buf_size)){l=1;break}l=i.gzindex<i.gzhead.name.length?255&i.gzhead.name.charCodeAt(i.gzindex++):0,put_byte(i,l)}while(0!==l);i.gzhead.hcrc&&i.pending>s&&(e.adler=o(e.adler,i.pending_buf,i.pending-s,s)),0===l&&(i.gzindex=0,i.status=Z)}else i.status=Z;if(i.status===Z)if(i.gzhead.comment){s=i.pending;do{if(i.pending===i.pending_buf_size&&(i.gzhead.hcrc&&i.pending>s&&(e.adler=o(e.adler,i.pending_buf,i.pending-s,s)),flush_pending(e),s=i.pending,i.pending===i.pending_buf_size)){l=1;break}l=i.gzindex<i.gzhead.comment.length?255&i.gzhead.comment.charCodeAt(i.gzindex++):0,put_byte(i,l)}while(0!==l);i.gzhead.hcrc&&i.pending>s&&(e.adler=o(e.adler,i.pending_buf,i.pending-s,s)),0===l&&(i.status=M)}else i.status=M;if(i.status===M&&(i.gzhead.hcrc?(i.pending+2>i.pending_buf_size&&flush_pending(e),i.pending+2<=i.pending_buf_size&&(put_byte(i,255&e.adler),put_byte(i,e.adler>>8&255),e.adler=0,i.status=H)):i.status=H),0!==i.pending){if(flush_pending(e),0===e.avail_out)return i.last_flush=-1,p}else if(0===e.avail_in&&rank(t)<=rank(r)&&t!==c)return err(e,b);if(i.status===G&&0!==e.avail_in)return err(e,b);if(0!==e.avail_in||0!==i.lookahead||t!==u&&i.status!==G){var y=i.strategy===v?deflate_huff(i,t):i.strategy===k?deflate_rle(i,t):n[i.level].func(i,t);if(y!==Y&&y!==X||(i.status=G),y===K||y===Y)return 0===e.avail_out&&(i.last_flush=-1),p;if(y===J&&(t===h?a._tr_align(i):t!==f&&(a._tr_stored_block(i,0,0,!1),t===d&&(zero(i.head),0===i.lookahead&&(i.strstart=0,i.block_start=0,i.insert=0))),flush_pending(e),0===e.avail_out))return i.last_flush=-1,p}return t!==c?p:i.wrap<=0?_:(2===i.wrap?(put_byte(i,255&e.adler),put_byte(i,e.adler>>8&255),put_byte(i,e.adler>>16&255),put_byte(i,e.adler>>24&255),put_byte(i,255&e.total_in),put_byte(i,e.total_in>>8&255),put_byte(i,e.total_in>>16&255),put_byte(i,e.total_in>>24&255)):(putShortMSB(i,e.adler>>>16),putShortMSB(i,65535&e.adler)),flush_pending(e),i.wrap>0&&(i.wrap=-i.wrap),0!==i.pending?p:_)},r.deflateEnd=function deflateEnd(e){var t;return e&&e.state?(t=e.state.status)!==U&&t!==W&&t!==j&&t!==Z&&t!==M&&t!==H&&t!==G?err(e,m):(e.state=null,t===H?err(e,g):p):m},r.deflateSetDictionary=function deflateSetDictionary(e,t){var r,n,a,o,l,u,h,d,c=t.length;if(!e||!e.state)return m;if(r=e.state,2===(o=r.wrap)||1===o&&r.status!==U||r.lookahead)return m;for(1===o&&(e.adler=s(e.adler,t,c,0)),r.wrap=0,c>=r.w_size&&(0===o&&(zero(r.head),r.strstart=0,r.block_start=0,r.insert=0),d=new i.Buf8(r.w_size),i.arraySet(d,t,c-r.w_size,r.w_size,0),t=d,c=r.w_size),l=e.avail_in,u=e.next_in,h=e.input,e.avail_in=c,e.next_in=0,e.input=t,fill_window(r);r.lookahead>=F;){n=r.strstart,a=r.lookahead-(F-1);do{r.ins_h=(r.ins_h<<r.hash_shift^r.window[n+F-1])&r.hash_mask,r.prev[n&r.w_mask]=r.head[r.ins_h],r.head[r.ins_h]=n,n++}while(--a);r.strstart=n,r.lookahead=F-1,fill_window(r)}return r.strstart+=r.lookahead,r.block_start=r.strstart,r.insert=r.lookahead,r.lookahead=0,r.match_length=r.prev_length=F-1,r.match_available=0,e.next_in=u,e.input=h,e.avail_in=l,r.wrap=o,p},r.deflateInfo="pako deflate (from Nodeca project)"},{"../utils/common":62,"./adler32":64,"./crc32":66,"./messages":72,"./trees":73}],68:[function(e,t,r){"use strict";t.exports=function GZheader(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}},{}],69:[function(e,t,r){"use strict";t.exports=function inflate_fast(e,t){var r,n,i,a,s,o,l,u,h,d,c,f,p,_,m,g,b,y,w,v,k,x,S,z,C;r=e.state,n=e.next_in,z=e.input,i=n+(e.avail_in-5),a=e.next_out,C=e.output,s=a-(t-e.avail_out),o=a+(e.avail_out-257),l=r.dmax,u=r.wsize,h=r.whave,d=r.wnext,c=r.window,f=r.hold,p=r.bits,_=r.lencode,m=r.distcode,g=(1<<r.lenbits)-1,b=(1<<r.distbits)-1;e:do{p<15&&(f+=z[n++]<<p,p+=8,f+=z[n++]<<p,p+=8),y=_[f&g];t:for(;;){if(w=y>>>24,f>>>=w,p-=w,0===(w=y>>>16&255))C[a++]=65535&y;else{if(!(16&w)){if(0==(64&w)){y=_[(65535&y)+(f&(1<<w)-1)];continue t}if(32&w){r.mode=12;break e}e.msg="invalid literal/length code",r.mode=30;break e}v=65535&y,(w&=15)&&(p<w&&(f+=z[n++]<<p,p+=8),v+=f&(1<<w)-1,f>>>=w,p-=w),p<15&&(f+=z[n++]<<p,p+=8,f+=z[n++]<<p,p+=8),y=m[f&b];r:for(;;){if(w=y>>>24,f>>>=w,p-=w,!(16&(w=y>>>16&255))){if(0==(64&w)){y=m[(65535&y)+(f&(1<<w)-1)];continue r}e.msg="invalid distance code",r.mode=30;break e}if(k=65535&y,w&=15,p<w&&(f+=z[n++]<<p,(p+=8)<w&&(f+=z[n++]<<p,p+=8)),(k+=f&(1<<w)-1)>l){e.msg="invalid distance too far back",r.mode=30;break e}if(f>>>=w,p-=w,w=a-s,k>w){if((w=k-w)>h&&r.sane){e.msg="invalid distance too far back",r.mode=30;break e}if(x=0,S=c,0===d){if(x+=u-w,w<v){v-=w;do{C[a++]=c[x++]}while(--w);x=a-k,S=C}}else if(d<w){if(x+=u+d-w,(w-=d)<v){v-=w;do{C[a++]=c[x++]}while(--w);if(x=0,d<v){v-=w=d;do{C[a++]=c[x++]}while(--w);x=a-k,S=C}}}else if(x+=d-w,w<v){v-=w;do{C[a++]=c[x++]}while(--w);x=a-k,S=C}for(;v>2;)C[a++]=S[x++],C[a++]=S[x++],C[a++]=S[x++],v-=3;v&&(C[a++]=S[x++],v>1&&(C[a++]=S[x++]))}else{x=a-k;do{C[a++]=C[x++],C[a++]=C[x++],C[a++]=C[x++],v-=3}while(v>2);v&&(C[a++]=C[x++],v>1&&(C[a++]=C[x++]))}break}}break}}while(n<i&&a<o);n-=v=p>>3,f&=(1<<(p-=v<<3))-1,e.next_in=n,e.next_out=a,e.avail_in=n<i?i-n+5:5-(n-i),e.avail_out=a<o?o-a+257:257-(a-o),r.hold=f,r.bits=p}},{}],70:[function(e,t,r){"use strict";function zswap32(e){return(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24)}function InflateState(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new a.Buf16(320),this.work=new a.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function inflateResetKeep(e){var t;return e&&e.state?(t=e.state,e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=S,t.last=0,t.havedict=0,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new a.Buf32(re),t.distcode=t.distdyn=new a.Buf32(ne),t.sane=1,t.back=-1,m):y}function inflateReset(e){var t;return e&&e.state?(t=e.state,t.wsize=0,t.whave=0,t.wnext=0,inflateResetKeep(e)):y}function inflateReset2(e,t){var r,n;return e&&e.state?(n=e.state,t<0?(r=0,t=-t):(r=1+(t>>4),t<48&&(t&=15)),t&&(t<8||t>15)?y:(null!==n.window&&n.wbits!==t&&(n.window=null),n.wrap=r,n.wbits=t,inflateReset(e))):y}function inflateInit2(e,t){var r,n;return e?(n=new InflateState,e.state=n,n.window=null,(r=inflateReset2(e,t))!==m&&(e.state=null),r):y}function fixedtables(e){if(ae){var t;for(n=new a.Buf32(512),i=new a.Buf32(32),t=0;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(u(d,e.lens,0,288,n,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;u(c,e.lens,0,32,i,0,e.work,{bits:5}),ae=!1}e.lencode=n,e.lenbits=9,e.distcode=i,e.distbits=5}function updatewindow(e,t,r,n){var i,s=e.state;return null===s.window&&(s.wsize=1<<s.wbits,s.wnext=0,s.whave=0,s.window=new a.Buf8(s.wsize)),n>=s.wsize?(a.arraySet(s.window,t,r-s.wsize,s.wsize,0),s.wnext=0,s.whave=s.wsize):((i=s.wsize-s.wnext)>n&&(i=n),a.arraySet(s.window,t,r-n,i,s.wnext),(n-=i)?(a.arraySet(s.window,t,r-n,n,0),s.wnext=n,s.whave=s.wsize):(s.wnext+=i,s.wnext===s.wsize&&(s.wnext=0),s.whave<s.wsize&&(s.whave+=i))),0}var n,i,a=e("../utils/common"),s=e("./adler32"),o=e("./crc32"),l=e("./inffast"),u=e("./inftrees"),h=0,d=1,c=2,f=4,p=5,_=6,m=0,g=1,b=2,y=-2,w=-3,v=-4,k=-5,x=8,S=1,z=2,C=3,A=4,E=5,I=6,R=7,T=8,O=9,D=10,B=11,F=12,N=13,L=14,P=15,U=16,W=17,j=18,Z=19,M=20,H=21,G=22,K=23,J=24,Y=25,X=26,q=27,V=28,Q=29,$=30,ee=31,te=32,re=852,ne=592,ie=15,ae=!0;r.inflateReset=inflateReset,r.inflateReset2=inflateReset2,r.inflateResetKeep=inflateResetKeep,r.inflateInit=function inflateInit(e){return inflateInit2(e,ie)},r.inflateInit2=inflateInit2,r.inflate=function inflate(e,t){var r,n,i,re,ne,ie,ae,se,oe,le,ue,he,de,ce,fe,pe,_e,me,ge,be,ye,we,ve,ke,xe=0,Se=new a.Buf8(4),ze=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!e||!e.state||!e.output||!e.input&&0!==e.avail_in)return y;(r=e.state).mode===F&&(r.mode=N),ne=e.next_out,i=e.output,ae=e.avail_out,re=e.next_in,n=e.input,ie=e.avail_in,se=r.hold,oe=r.bits,le=ie,ue=ae,we=m;e:for(;;)switch(r.mode){case S:if(0===r.wrap){r.mode=N;break}for(;oe<16;){if(0===ie)break e;ie--,se+=n[re++]<<oe,oe+=8}if(2&r.wrap&&35615===se){r.check=0,Se[0]=255&se,Se[1]=se>>>8&255,r.check=o(r.check,Se,2,0),se=0,oe=0,r.mode=z;break}if(r.flags=0,r.head&&(r.head.done=!1),!(1&r.wrap)||(((255&se)<<8)+(se>>8))%31){e.msg="incorrect header check",r.mode=$;break}if((15&se)!==x){e.msg="unknown compression method",r.mode=$;break}if(se>>>=4,oe-=4,ye=8+(15&se),0===r.wbits)r.wbits=ye;else if(ye>r.wbits){e.msg="invalid window size",r.mode=$;break}r.dmax=1<<ye,e.adler=r.check=1,r.mode=512&se?D:F,se=0,oe=0;break;case z:for(;oe<16;){if(0===ie)break e;ie--,se+=n[re++]<<oe,oe+=8}if(r.flags=se,(255&r.flags)!==x){e.msg="unknown compression method",r.mode=$;break}if(57344&r.flags){e.msg="unknown header flags set",r.mode=$;break}r.head&&(r.head.text=se>>8&1),512&r.flags&&(Se[0]=255&se,Se[1]=se>>>8&255,r.check=o(r.check,Se,2,0)),se=0,oe=0,r.mode=C;case C:for(;oe<32;){if(0===ie)break e;ie--,se+=n[re++]<<oe,oe+=8}r.head&&(r.head.time=se),512&r.flags&&(Se[0]=255&se,Se[1]=se>>>8&255,Se[2]=se>>>16&255,Se[3]=se>>>24&255,r.check=o(r.check,Se,4,0)),se=0,oe=0,r.mode=A;case A:for(;oe<16;){if(0===ie)break e;ie--,se+=n[re++]<<oe,oe+=8}r.head&&(r.head.xflags=255&se,r.head.os=se>>8),512&r.flags&&(Se[0]=255&se,Se[1]=se>>>8&255,r.check=o(r.check,Se,2,0)),se=0,oe=0,r.mode=E;case E:if(1024&r.flags){for(;oe<16;){if(0===ie)break e;ie--,se+=n[re++]<<oe,oe+=8}r.length=se,r.head&&(r.head.extra_len=se),512&r.flags&&(Se[0]=255&se,Se[1]=se>>>8&255,r.check=o(r.check,Se,2,0)),se=0,oe=0}else r.head&&(r.head.extra=null);r.mode=I;case I:if(1024&r.flags&&((he=r.length)>ie&&(he=ie),he&&(r.head&&(ye=r.head.extra_len-r.length,r.head.extra||(r.head.extra=new Array(r.head.extra_len)),a.arraySet(r.head.extra,n,re,he,ye)),512&r.flags&&(r.check=o(r.check,n,he,re)),ie-=he,re+=he,r.length-=he),r.length))break e;r.length=0,r.mode=R;case R:if(2048&r.flags){if(0===ie)break e;he=0;do{ye=n[re+he++],r.head&&ye&&r.length<65536&&(r.head.name+=String.fromCharCode(ye))}while(ye&&he<ie);if(512&r.flags&&(r.check=o(r.check,n,he,re)),ie-=he,re+=he,ye)break e}else r.head&&(r.head.name=null);r.length=0,r.mode=T;case T:if(4096&r.flags){if(0===ie)break e;he=0;do{ye=n[re+he++],r.head&&ye&&r.length<65536&&(r.head.comment+=String.fromCharCode(ye))}while(ye&&he<ie);if(512&r.flags&&(r.check=o(r.check,n,he,re)),ie-=he,re+=he,ye)break e}else r.head&&(r.head.comment=null);r.mode=O;case O:if(512&r.flags){for(;oe<16;){if(0===ie)break e;ie--,se+=n[re++]<<oe,oe+=8}if(se!==(65535&r.check)){e.msg="header crc mismatch",r.mode=$;break}se=0,oe=0}r.head&&(r.head.hcrc=r.flags>>9&1,r.head.done=!0),e.adler=r.check=0,r.mode=F;break;case D:for(;oe<32;){if(0===ie)break e;ie--,se+=n[re++]<<oe,oe+=8}e.adler=r.check=zswap32(se),se=0,oe=0,r.mode=B;case B:if(0===r.havedict)return e.next_out=ne,e.avail_out=ae,e.next_in=re,e.avail_in=ie,r.hold=se,r.bits=oe,b;e.adler=r.check=1,r.mode=F;case F:if(t===p||t===_)break e;case N:if(r.last){se>>>=7&oe,oe-=7&oe,r.mode=q;break}for(;oe<3;){if(0===ie)break e;ie--,se+=n[re++]<<oe,oe+=8}switch(r.last=1&se,se>>>=1,oe-=1,3&se){case 0:r.mode=L;break;case 1:if(fixedtables(r),r.mode=M,t===_){se>>>=2,oe-=2;break e}break;case 2:r.mode=W;break;case 3:e.msg="invalid block type",r.mode=$}se>>>=2,oe-=2;break;case L:for(se>>>=7&oe,oe-=7&oe;oe<32;){if(0===ie)break e;ie--,se+=n[re++]<<oe,oe+=8}if((65535&se)!=(se>>>16^65535)){e.msg="invalid stored block lengths",r.mode=$;break}if(r.length=65535&se,se=0,oe=0,r.mode=P,t===_)break e;case P:r.mode=U;case U:if(he=r.length){if(he>ie&&(he=ie),he>ae&&(he=ae),0===he)break e;a.arraySet(i,n,re,he,ne),ie-=he,re+=he,ae-=he,ne+=he,r.length-=he;break}r.mode=F;break;case W:for(;oe<14;){if(0===ie)break e;ie--,se+=n[re++]<<oe,oe+=8}if(r.nlen=257+(31&se),se>>>=5,oe-=5,r.ndist=1+(31&se),se>>>=5,oe-=5,r.ncode=4+(15&se),se>>>=4,oe-=4,r.nlen>286||r.ndist>30){e.msg="too many length or distance symbols",r.mode=$;break}r.have=0,r.mode=j;case j:for(;r.have<r.ncode;){for(;oe<3;){if(0===ie)break e;ie--,se+=n[re++]<<oe,oe+=8}r.lens[ze[r.have++]]=7&se,se>>>=3,oe-=3}for(;r.have<19;)r.lens[ze[r.have++]]=0;if(r.lencode=r.lendyn,r.lenbits=7,ve={bits:r.lenbits},we=u(h,r.lens,0,19,r.lencode,0,r.work,ve),r.lenbits=ve.bits,we){e.msg="invalid code lengths set",r.mode=$;break}r.have=0,r.mode=Z;case Z:for(;r.have<r.nlen+r.ndist;){for(;xe=r.lencode[se&(1<<r.lenbits)-1],fe=xe>>>24,pe=xe>>>16&255,_e=65535&xe,!(fe<=oe);){if(0===ie)break e;ie--,se+=n[re++]<<oe,oe+=8}if(_e<16)se>>>=fe,oe-=fe,r.lens[r.have++]=_e;else{if(16===_e){for(ke=fe+2;oe<ke;){if(0===ie)break e;ie--,se+=n[re++]<<oe,oe+=8}if(se>>>=fe,oe-=fe,0===r.have){e.msg="invalid bit length repeat",r.mode=$;break}ye=r.lens[r.have-1],he=3+(3&se),se>>>=2,oe-=2}else if(17===_e){for(ke=fe+3;oe<ke;){if(0===ie)break e;ie--,se+=n[re++]<<oe,oe+=8}oe-=fe,ye=0,he=3+(7&(se>>>=fe)),se>>>=3,oe-=3}else{for(ke=fe+7;oe<ke;){if(0===ie)break e;ie--,se+=n[re++]<<oe,oe+=8}oe-=fe,ye=0,he=11+(127&(se>>>=fe)),se>>>=7,oe-=7}if(r.have+he>r.nlen+r.ndist){e.msg="invalid bit length repeat",r.mode=$;break}for(;he--;)r.lens[r.have++]=ye}}if(r.mode===$)break;if(0===r.lens[256]){e.msg="invalid code -- missing end-of-block",r.mode=$;break}if(r.lenbits=9,ve={bits:r.lenbits},we=u(d,r.lens,0,r.nlen,r.lencode,0,r.work,ve),r.lenbits=ve.bits,we){e.msg="invalid literal/lengths set",r.mode=$;break}if(r.distbits=6,r.distcode=r.distdyn,ve={bits:r.distbits},we=u(c,r.lens,r.nlen,r.ndist,r.distcode,0,r.work,ve),r.distbits=ve.bits,we){e.msg="invalid distances set",r.mode=$;break}if(r.mode=M,t===_)break e;case M:r.mode=H;case H:if(ie>=6&&ae>=258){e.next_out=ne,e.avail_out=ae,e.next_in=re,e.avail_in=ie,r.hold=se,r.bits=oe,l(e,ue),ne=e.next_out,i=e.output,ae=e.avail_out,re=e.next_in,n=e.input,ie=e.avail_in,se=r.hold,oe=r.bits,r.mode===F&&(r.back=-1);break}for(r.back=0;xe=r.lencode[se&(1<<r.lenbits)-1],fe=xe>>>24,pe=xe>>>16&255,_e=65535&xe,!(fe<=oe);){if(0===ie)break e;ie--,se+=n[re++]<<oe,oe+=8}if(pe&&0==(240&pe)){for(me=fe,ge=pe,be=_e;xe=r.lencode[be+((se&(1<<me+ge)-1)>>me)],fe=xe>>>24,pe=xe>>>16&255,_e=65535&xe,!(me+fe<=oe);){if(0===ie)break e;ie--,se+=n[re++]<<oe,oe+=8}se>>>=me,oe-=me,r.back+=me}if(se>>>=fe,oe-=fe,r.back+=fe,r.length=_e,0===pe){r.mode=X;break}if(32&pe){r.back=-1,r.mode=F;break}if(64&pe){e.msg="invalid literal/length code",r.mode=$;break}r.extra=15&pe,r.mode=G;case G:if(r.extra){for(ke=r.extra;oe<ke;){if(0===ie)break e;ie--,se+=n[re++]<<oe,oe+=8}r.length+=se&(1<<r.extra)-1,se>>>=r.extra,oe-=r.extra,r.back+=r.extra}r.was=r.length,r.mode=K;case K:for(;xe=r.distcode[se&(1<<r.distbits)-1],fe=xe>>>24,pe=xe>>>16&255,_e=65535&xe,!(fe<=oe);){if(0===ie)break e;ie--,se+=n[re++]<<oe,oe+=8}if(0==(240&pe)){for(me=fe,ge=pe,be=_e;xe=r.distcode[be+((se&(1<<me+ge)-1)>>me)],fe=xe>>>24,pe=xe>>>16&255,_e=65535&xe,!(me+fe<=oe);){if(0===ie)break e;ie--,se+=n[re++]<<oe,oe+=8}se>>>=me,oe-=me,r.back+=me}if(se>>>=fe,oe-=fe,r.back+=fe,64&pe){e.msg="invalid distance code",r.mode=$;break}r.offset=_e,r.extra=15&pe,r.mode=J;case J:if(r.extra){for(ke=r.extra;oe<ke;){if(0===ie)break e;ie--,se+=n[re++]<<oe,oe+=8}r.offset+=se&(1<<r.extra)-1,se>>>=r.extra,oe-=r.extra,r.back+=r.extra}if(r.offset>r.dmax){e.msg="invalid distance too far back",r.mode=$;break}r.mode=Y;case Y:if(0===ae)break e;if(he=ue-ae,r.offset>he){if((he=r.offset-he)>r.whave&&r.sane){e.msg="invalid distance too far back",r.mode=$;break}he>r.wnext?(he-=r.wnext,de=r.wsize-he):de=r.wnext-he,he>r.length&&(he=r.length),ce=r.window}else ce=i,de=ne-r.offset,he=r.length;he>ae&&(he=ae),ae-=he,r.length-=he;do{i[ne++]=ce[de++]}while(--he);0===r.length&&(r.mode=H);break;case X:if(0===ae)break e;i[ne++]=r.length,ae--,r.mode=H;break;case q:if(r.wrap){for(;oe<32;){if(0===ie)break e;ie--,se|=n[re++]<<oe,oe+=8}if(ue-=ae,e.total_out+=ue,r.total+=ue,ue&&(e.adler=r.check=r.flags?o(r.check,i,ue,ne-ue):s(r.check,i,ue,ne-ue)),ue=ae,(r.flags?se:zswap32(se))!==r.check){e.msg="incorrect data check",r.mode=$;break}se=0,oe=0}r.mode=V;case V:if(r.wrap&&r.flags){for(;oe<32;){if(0===ie)break e;ie--,se+=n[re++]<<oe,oe+=8}if(se!==(4294967295&r.total)){e.msg="incorrect length check",r.mode=$;break}se=0,oe=0}r.mode=Q;case Q:we=g;break e;case $:we=w;break e;case ee:return v;case te:default:return y}return e.next_out=ne,e.avail_out=ae,e.next_in=re,e.avail_in=ie,r.hold=se,r.bits=oe,(r.wsize||ue!==e.avail_out&&r.mode<$&&(r.mode<q||t!==f))&&updatewindow(e,e.output,e.next_out,ue-e.avail_out)?(r.mode=ee,v):(le-=e.avail_in,ue-=e.avail_out,e.total_in+=le,e.total_out+=ue,r.total+=ue,r.wrap&&ue&&(e.adler=r.check=r.flags?o(r.check,i,ue,e.next_out-ue):s(r.check,i,ue,e.next_out-ue)),e.data_type=r.bits+(r.last?64:0)+(r.mode===F?128:0)+(r.mode===M||r.mode===P?256:0),(0===le&&0===ue||t===f)&&we===m&&(we=k),we)},r.inflateEnd=function inflateEnd(e){if(!e||!e.state)return y;var t=e.state;return t.window&&(t.window=null),e.state=null,m},r.inflateGetHeader=function inflateGetHeader(e,t){var r;return e&&e.state?0==(2&(r=e.state).wrap)?y:(r.head=t,t.done=!1,m):y},r.inflateSetDictionary=function inflateSetDictionary(e,t){var r,n,i=t.length;return e&&e.state?0!==(r=e.state).wrap&&r.mode!==B?y:r.mode===B&&(n=1,(n=s(n,t,i,0))!==r.check)?w:updatewindow(e,t,i,i)?(r.mode=ee,v):(r.havedict=1,m):y},r.inflateInfo="pako inflate (from Nodeca project)"},{"../utils/common":62,"./adler32":64,"./crc32":66,"./inffast":69,"./inftrees":71}],71:[function(e,t,r){"use strict";var n=e("../utils/common"),i=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],a=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],s=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],o=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];t.exports=function inflate_table(e,t,r,l,u,h,d,c){var f,p,_,m,g,b,y,w,v,k=c.bits,x=0,S=0,z=0,C=0,A=0,E=0,I=0,R=0,T=0,O=0,D=null,B=0,F=new n.Buf16(16),N=new n.Buf16(16),L=null,P=0;for(x=0;x<=15;x++)F[x]=0;for(S=0;S<l;S++)F[t[r+S]]++;for(A=k,C=15;C>=1&&0===F[C];C--);if(A>C&&(A=C),0===C)return u[h++]=20971520,u[h++]=20971520,c.bits=1,0;for(z=1;z<C&&0===F[z];z++);for(A<z&&(A=z),R=1,x=1;x<=15;x++)if(R<<=1,(R-=F[x])<0)return-1;if(R>0&&(0===e||1!==C))return-1;for(N[1]=0,x=1;x<15;x++)N[x+1]=N[x]+F[x];for(S=0;S<l;S++)0!==t[r+S]&&(d[N[t[r+S]]++]=S);if(0===e?(D=L=d,b=19):1===e?(D=i,B-=257,L=a,P-=257,b=256):(D=s,L=o,b=-1),O=0,S=0,x=z,g=h,E=A,I=0,_=-1,T=1<<A,m=T-1,1===e&&T>852||2===e&&T>592)return 1;for(;;){0,y=x-I,d[S]<b?(w=0,v=d[S]):d[S]>b?(w=L[P+d[S]],v=D[B+d[S]]):(w=96,v=0),f=1<<x-I,z=p=1<<E;do{u[g+(O>>I)+(p-=f)]=y<<24|w<<16|v|0}while(0!==p);for(f=1<<x-1;O&f;)f>>=1;if(0!==f?(O&=f-1,O+=f):O=0,S++,0==--F[x]){if(x===C)break;x=t[r+d[S]]}if(x>A&&(O&m)!==_){for(0===I&&(I=A),g+=z,R=1<<(E=x-I);E+I<C&&!((R-=F[E+I])<=0);)E++,R<<=1;if(T+=1<<E,1===e&&T>852||2===e&&T>592)return 1;u[_=O&m]=A<<24|E<<16|g-h|0}}return 0!==O&&(u[g+O]=x-I<<24|64<<16|0),c.bits=A,0}},{"../utils/common":62}],72:[function(e,t,r){"use strict";t.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}},{}],73:[function(e,t,r){"use strict";function zero(e){for(var t=e.length;--t>=0;)e[t]=0}function StaticTreeDesc(e,t,r,n,i){this.static_tree=e,this.extra_bits=t,this.extra_base=r,this.elems=n,this.max_length=i,this.has_stree=e&&e.length}function TreeDesc(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t}function d_code(e){return e<256?R[e]:R[256+(e>>>7)]}function put_short(e,t){e.pending_buf[e.pending++]=255&t,e.pending_buf[e.pending++]=t>>>8&255}function send_bits(e,t,r){e.bi_valid>b-r?(e.bi_buf|=t<<e.bi_valid&65535,put_short(e,e.bi_buf),e.bi_buf=t>>b-e.bi_valid,e.bi_valid+=r-b):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=r)}function send_code(e,t,r){send_bits(e,r[2*t],r[2*t+1])}function bi_reverse(e,t){var r=0;do{r|=1&e,e>>>=1,r<<=1}while(--t>0);return r>>>1}function bi_flush(e){16===e.bi_valid?(put_short(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)}function gen_bitlen(e,t){var r,n,i,a,s,o,l=t.dyn_tree,u=t.max_code,h=t.stat_desc.static_tree,d=t.stat_desc.has_stree,c=t.stat_desc.extra_bits,f=t.stat_desc.extra_base,p=t.stat_desc.max_length,_=0;for(a=0;a<=g;a++)e.bl_count[a]=0;for(l[2*e.heap[e.heap_max]+1]=0,r=e.heap_max+1;r<m;r++)(a=l[2*l[2*(n=e.heap[r])+1]+1]+1)>p&&(a=p,_++),l[2*n+1]=a,n>u||(e.bl_count[a]++,s=0,n>=f&&(s=c[n-f]),o=l[2*n],e.opt_len+=o*(a+s),d&&(e.static_len+=o*(h[2*n+1]+s)));if(0!==_){do{for(a=p-1;0===e.bl_count[a];)a--;e.bl_count[a]--,e.bl_count[a+1]+=2,e.bl_count[p]--,_-=2}while(_>0);for(a=p;0!==a;a--)for(n=e.bl_count[a];0!==n;)(i=e.heap[--r])>u||(l[2*i+1]!==a&&(e.opt_len+=(a-l[2*i+1])*l[2*i],l[2*i+1]=a),n--)}}function gen_codes(e,t,r){var n,i,a=new Array(g+1),s=0;for(n=1;n<=g;n++)a[n]=s=s+r[n-1]<<1;for(i=0;i<=t;i++){var o=e[2*i+1];0!==o&&(e[2*i]=bi_reverse(a[o]++,o))}}function tr_static_init(){var e,t,r,n,i,a=new Array(g+1);for(r=0,n=0;n<d-1;n++)for(O[n]=r,e=0;e<1<<S[n];e++)T[r++]=n;for(T[r-1]=n,i=0,n=0;n<16;n++)for(D[n]=i,e=0;e<1<<z[n];e++)R[i++]=n;for(i>>=7;n<p;n++)for(D[n]=i<<7,e=0;e<1<<z[n]-7;e++)R[256+i++]=n;for(t=0;t<=g;t++)a[t]=0;for(e=0;e<=143;)E[2*e+1]=8,e++,a[8]++;for(;e<=255;)E[2*e+1]=9,e++,a[9]++;for(;e<=279;)E[2*e+1]=7,e++,a[7]++;for(;e<=287;)E[2*e+1]=8,e++,a[8]++;for(gen_codes(E,f+1,a),e=0;e<p;e++)I[2*e+1]=5,I[2*e]=bi_reverse(e,5);B=new StaticTreeDesc(E,S,c+1,f,g),F=new StaticTreeDesc(I,z,0,p,g),N=new StaticTreeDesc(new Array(0),C,0,_,y)}function init_block(e){var t;for(t=0;t<f;t++)e.dyn_ltree[2*t]=0;for(t=0;t<p;t++)e.dyn_dtree[2*t]=0;for(t=0;t<_;t++)e.bl_tree[2*t]=0;e.dyn_ltree[2*w]=1,e.opt_len=e.static_len=0,e.last_lit=e.matches=0}function bi_windup(e){e.bi_valid>8?put_short(e,e.bi_buf):e.bi_valid>0&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0}function copy_block(e,t,r,i){bi_windup(e),i&&(put_short(e,r),put_short(e,~r)),n.arraySet(e.pending_buf,e.window,t,r,e.pending),e.pending+=r}function smaller(e,t,r,n){var i=2*t,a=2*r;return e[i]<e[a]||e[i]===e[a]&&n[t]<=n[r]}function pqdownheap(e,t,r){for(var n=e.heap[r],i=r<<1;i<=e.heap_len&&(i<e.heap_len&&smaller(t,e.heap[i+1],e.heap[i],e.depth)&&i++,!smaller(t,n,e.heap[i],e.depth));)e.heap[r]=e.heap[i],r=i,i<<=1;e.heap[r]=n}function compress_block(e,t,r){var n,i,a,s,o=0;if(0!==e.last_lit)do{n=e.pending_buf[e.d_buf+2*o]<<8|e.pending_buf[e.d_buf+2*o+1],i=e.pending_buf[e.l_buf+o],o++,0===n?send_code(e,i,t):(send_code(e,(a=T[i])+c+1,t),0!==(s=S[a])&&send_bits(e,i-=O[a],s),send_code(e,a=d_code(--n),r),0!==(s=z[a])&&send_bits(e,n-=D[a],s))}while(o<e.last_lit);send_code(e,w,t)}function build_tree(e,t){var r,n,i,a=t.dyn_tree,s=t.stat_desc.static_tree,o=t.stat_desc.has_stree,l=t.stat_desc.elems,u=-1;for(e.heap_len=0,e.heap_max=m,r=0;r<l;r++)0!==a[2*r]?(e.heap[++e.heap_len]=u=r,e.depth[r]=0):a[2*r+1]=0;for(;e.heap_len<2;)a[2*(i=e.heap[++e.heap_len]=u<2?++u:0)]=1,e.depth[i]=0,e.opt_len--,o&&(e.static_len-=s[2*i+1]);for(t.max_code=u,r=e.heap_len>>1;r>=1;r--)pqdownheap(e,a,r);i=l;do{r=e.heap[1],e.heap[1]=e.heap[e.heap_len--],pqdownheap(e,a,1),n=e.heap[1],e.heap[--e.heap_max]=r,e.heap[--e.heap_max]=n,a[2*i]=a[2*r]+a[2*n],e.depth[i]=(e.depth[r]>=e.depth[n]?e.depth[r]:e.depth[n])+1,a[2*r+1]=a[2*n+1]=i,e.heap[1]=i++,pqdownheap(e,a,1)}while(e.heap_len>=2);e.heap[--e.heap_max]=e.heap[1],gen_bitlen(e,t),gen_codes(a,u,e.bl_count)}function scan_tree(e,t,r){var n,i,a=-1,s=t[1],o=0,l=7,u=4;for(0===s&&(l=138,u=3),t[2*(r+1)+1]=65535,n=0;n<=r;n++)i=s,s=t[2*(n+1)+1],++o<l&&i===s||(o<u?e.bl_tree[2*i]+=o:0!==i?(i!==a&&e.bl_tree[2*i]++,e.bl_tree[2*v]++):o<=10?e.bl_tree[2*k]++:e.bl_tree[2*x]++,o=0,a=i,0===s?(l=138,u=3):i===s?(l=6,u=3):(l=7,u=4))}function send_tree(e,t,r){var n,i,a=-1,s=t[1],o=0,l=7,u=4;for(0===s&&(l=138,u=3),n=0;n<=r;n++)if(i=s,s=t[2*(n+1)+1],!(++o<l&&i===s)){if(o<u)do{send_code(e,i,e.bl_tree)}while(0!=--o);else 0!==i?(i!==a&&(send_code(e,i,e.bl_tree),o--),send_code(e,v,e.bl_tree),send_bits(e,o-3,2)):o<=10?(send_code(e,k,e.bl_tree),send_bits(e,o-3,3)):(send_code(e,x,e.bl_tree),send_bits(e,o-11,7));o=0,a=i,0===s?(l=138,u=3):i===s?(l=6,u=3):(l=7,u=4)}}function build_bl_tree(e){var t;for(scan_tree(e,e.dyn_ltree,e.l_desc.max_code),scan_tree(e,e.dyn_dtree,e.d_desc.max_code),build_tree(e,e.bl_desc),t=_-1;t>=3&&0===e.bl_tree[2*A[t]+1];t--);return e.opt_len+=3*(t+1)+5+5+4,t}function send_all_trees(e,t,r,n){var i;for(send_bits(e,t-257,5),send_bits(e,r-1,5),send_bits(e,n-4,4),i=0;i<n;i++)send_bits(e,e.bl_tree[2*A[i]+1],3);send_tree(e,e.dyn_ltree,t-1),send_tree(e,e.dyn_dtree,r-1)}function detect_data_type(e){var t,r=4093624447;for(t=0;t<=31;t++,r>>>=1)if(1&r&&0!==e.dyn_ltree[2*t])return a;if(0!==e.dyn_ltree[18]||0!==e.dyn_ltree[20]||0!==e.dyn_ltree[26])return s;for(t=32;t<c;t++)if(0!==e.dyn_ltree[2*t])return s;return a}function _tr_stored_block(e,t,r,n){send_bits(e,(l<<1)+(n?1:0),3),copy_block(e,t,r,!0)}var n=e("../utils/common"),i=4,a=0,s=1,o=2,l=0,u=1,h=2,d=29,c=256,f=c+1+d,p=30,_=19,m=2*f+1,g=15,b=16,y=7,w=256,v=16,k=17,x=18,S=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],z=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],C=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],A=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],E=new Array(2*(f+2));zero(E);var I=new Array(2*p);zero(I);var R=new Array(512);zero(R);var T=new Array(256);zero(T);var O=new Array(d);zero(O);var D=new Array(p);zero(D);var B,F,N,L=!1;r._tr_init=function _tr_init(e){L||(tr_static_init(),L=!0),e.l_desc=new TreeDesc(e.dyn_ltree,B),e.d_desc=new TreeDesc(e.dyn_dtree,F),e.bl_desc=new TreeDesc(e.bl_tree,N),e.bi_buf=0,e.bi_valid=0,init_block(e)},r._tr_stored_block=_tr_stored_block,r._tr_flush_block=function _tr_flush_block(e,t,r,n){var a,s,l=0;e.level>0?(e.strm.data_type===o&&(e.strm.data_type=detect_data_type(e)),build_tree(e,e.l_desc),build_tree(e,e.d_desc),l=build_bl_tree(e),a=e.opt_len+3+7>>>3,(s=e.static_len+3+7>>>3)<=a&&(a=s)):a=s=r+5,r+4<=a&&-1!==t?_tr_stored_block(e,t,r,n):e.strategy===i||s===a?(send_bits(e,(u<<1)+(n?1:0),3),compress_block(e,E,I)):(send_bits(e,(h<<1)+(n?1:0),3),send_all_trees(e,e.l_desc.max_code+1,e.d_desc.max_code+1,l+1),compress_block(e,e.dyn_ltree,e.dyn_dtree)),init_block(e),n&&bi_windup(e)},r._tr_tally=function _tr_tally(e,t,r){return e.pending_buf[e.d_buf+2*e.last_lit]=t>>>8&255,e.pending_buf[e.d_buf+2*e.last_lit+1]=255&t,e.pending_buf[e.l_buf+e.last_lit]=255&r,e.last_lit++,0===t?e.dyn_ltree[2*r]++:(e.matches++,t--,e.dyn_ltree[2*(T[r]+c+1)]++,e.dyn_dtree[2*d_code(t)]++),e.last_lit===e.lit_bufsize-1},r._tr_align=function _tr_align(e){send_bits(e,u<<1,3),send_code(e,w,E),bi_flush(e)}},{"../utils/common":62}],74:[function(e,t,r){"use strict";t.exports=function ZStream(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}},{}]},{},[10])(10)});
	var saveAs=saveAs||function(e){"use strict";if(!(void 0===e||"undefined"!=typeof navigator&&/MSIE [1-9]\./.test(navigator.userAgent))){var t=function(){return e.URL||e.webkitURL||e},n=e.document.createElementNS("http://www.w3.org/1999/xhtml","a"),o="download"in n,r=function(e){var t=new MouseEvent("click");e.dispatchEvent(t)},a=/constructor/i.test(e.HTMLElement)||e.safari,i=/CriOS\/[\d]+/.test(navigator.userAgent),d=function(t){(e.setImmediate||e.setTimeout)(function(){throw t},0)},f=function(e){setTimeout(function(){"string"==typeof e?t().revokeObjectURL(e):e.remove()},4e4)},s=function(e,t,n){for(var o=(t=[].concat(t)).length;o--;){var r=e["on"+t[o]];if("function"==typeof r)try{r.call(e,n||e)}catch(e){d(e)}}},u=function(e){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)?new Blob([String.fromCharCode(65279),e],{type:e.type}):e},c=function(d,c,l){l||(d=u(d));var p,v=this,w="application/octet-stream"===d.type,m=function(){s(v,"writestart progress write writeend".split(" "))};if(v.readyState=v.INIT,o)return p=t().createObjectURL(d),void setTimeout(function(){n.href=p,n.download=c,r(n),m(),f(p),v.readyState=v.DONE});!function(){if((i||w&&a)&&e.FileReader){var n=new FileReader;return n.onloadend=function(){var t=i?n.result:n.result.replace(/^data:[^;]*;/,"data:attachment/file;");e.open(t,"_blank")||(e.location.href=t),t=void 0,v.readyState=v.DONE,m()},n.readAsDataURL(d),void(v.readyState=v.INIT)}p||(p=t().createObjectURL(d)),w?e.location.href=p:e.open(p,"_blank")||(e.location.href=p),v.readyState=v.DONE,m(),f(p)}()},l=c.prototype;return"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob?function(e,t,n){return t=t||e.name||"download",n||(e=u(e)),navigator.msSaveOrOpenBlob(e,t)}:(l.abort=function(){},l.readyState=l.INIT=0,l.WRITING=1,l.DONE=2,l.error=l.onwritestart=l.onprogress=l.onwrite=l.onabort=l.onerror=l.onwriteend=null,function(e,t,n){return new c(e,t||e.name||"download",n)})}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content);"undefined"!=typeof module&&module.exports?module.exports.saveAs=saveAs:"undefined"!=typeof define&&null!==define&&null!==define.amd&&define("FileSaver.js",function(){return saveAs});
	!function(){var t={},e=null,i=null,n=null,o=null,a={},r={color:"#ff0084",background:"#bbb",shadow:"#fff",fallback:!1},h=window.devicePixelRatio>1,l=function(){var t=navigator.userAgent.toLowerCase();return function(e){return-1!==t.indexOf(e)}}(),c={ie:l("msie"),chrome:l("chrome"),webkit:l("chrome")||l("safari"),safari:l("safari")&&!l("chrome"),mozilla:l("mozilla")&&!l("chrome")&&!l("safari")},f=function(){for(var t=document.getElementsByTagName("link"),e=0,i=t.length;e<i;e++)if("icon"===t[e].getAttribute("rel")||"shortcut icon"===t[e].getAttribute("rel"))return t[e];return!1},u=function(){for(var t=Array.prototype.slice.call(document.getElementsByTagName("link"),0),e=document.getElementsByTagName("head")[0],i=0,n=t.length;i<n;i++)"icon"!==t[i].getAttribute("rel")&&"shortcut icon"!==t[i].getAttribute("rel")||e.removeChild(t[i])},d=function(t){u();var e=document.createElement("link");e.type="image/x-icon",e.rel="icon",e.href=t,document.getElementsByTagName("head")[0].appendChild(e)},g=function(){return o||(o=document.createElement("canvas"),h?(o.width=32,o.height=32):(o.width=16,o.height=16)),o},m=function(t){var e=g(),i=e.getContext("2d");t=t||0,i&&(i.clearRect(0,0,e.width,e.height),i.beginPath(),i.moveTo(e.width/2,e.height/2),i.arc(e.width/2,e.height/2,Math.min(e.width/2,e.height/2),0,2*Math.PI,!1),i.fillStyle=a.shadow,i.fill(),i.beginPath(),i.moveTo(e.width/2,e.height/2),i.arc(e.width/2,e.height/2,Math.min(e.width/2,e.height/2)-2,0,2*Math.PI,!1),i.fillStyle=a.background,i.fill(),t>0&&(i.beginPath(),i.moveTo(e.width/2,e.height/2),i.arc(e.width/2,e.height/2,Math.min(e.width/2,e.height/2)-2,-.5*Math.PI,(2*t/100-.5)*Math.PI,!1),i.lineTo(e.width/2,e.height/2),i.fillStyle=a.color,i.fill()),d(e.toDataURL()))},s=function(t){document.title=t>0?"("+t+"%) "+n:n};t.setOptions=function(t){a={};for(var e in r)a[e]=t.hasOwnProperty(e)?t[e]:r[e];return this},t.setProgress=function(t){if(n||(n=document.title),!i||!e){var o=f();i=e=o?o.getAttribute("href"):"/favicon.ico"}return!(isNaN(parseFloat(t))||!isFinite(t))&&(!g().getContext||c.ie||c.safari||!0===a.fallback?s(t):("force"===a.fallback&&s(t),m(t)))},t.reset=function(){n&&(document.title=n),i&&d(e=i)},t.setOptions(r),"function"==typeof define&&define.amd?define(t):"undefined"!=typeof module?module.exports=t:window.Piecon=t}();
	!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.THREE=e.THREE||{})}(this,function(e){"use strict";function EventDispatcher(){}function Vector2(e,t){this.x=e||0,this.y=t||0}function Texture(e,t,r,i,n,a,o,s,c,l){Object.defineProperty(this,"id",{value:TextureIdCount()}),this.uuid=ut.generateUUID(),this.name="",this.sourceFile="",this.image=void 0!==e?e:Texture.DEFAULT_IMAGE,this.mipmaps=[],this.mapping=void 0!==t?t:Texture.DEFAULT_MAPPING,this.wrapS=void 0!==r?r:de,this.wrapT=void 0!==i?i:de,this.magFilter=void 0!==n?n:ye,this.minFilter=void 0!==a?a:be,this.anisotropy=void 0!==c?c:1,this.format=void 0!==o?o:Ue,this.type=void 0!==s?s:Me,this.offset=new Vector2(0,0),this.repeat=new Vector2(1,1),this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.encoding=void 0!==l?l:rt,this.version=0,this.onUpdate=null}function TextureIdCount(){return dt++}function Vector4(e,t,r,i){this.x=e||0,this.y=t||0,this.z=r||0,this.w=void 0!==i?i:1}function WebGLRenderTarget(e,t,r){this.uuid=ut.generateUUID(),this.width=e,this.height=t,this.scissor=new Vector4(0,0,e,t),this.scissorTest=!1,this.viewport=new Vector4(0,0,e,t),void 0===(r=r||{}).minFilter&&(r.minFilter=ye),this.texture=new Texture(void 0,void 0,r.wrapS,r.wrapT,r.magFilter,r.minFilter,r.format,r.type,r.anisotropy,r.encoding),this.depthBuffer=void 0===r.depthBuffer||r.depthBuffer,this.stencilBuffer=void 0===r.stencilBuffer||r.stencilBuffer,this.depthTexture=void 0!==r.depthTexture?r.depthTexture:null}function WebGLRenderTargetCube(e,t,r){WebGLRenderTarget.call(this,e,t,r),this.activeCubeFace=0,this.activeMipMapLevel=0}function Quaternion(e,t,r,i){this._x=e||0,this._y=t||0,this._z=r||0,this._w=void 0!==i?i:1}function Vector3(e,t,r){this.x=e||0,this.y=t||0,this.z=r||0}function Matrix4(){this.elements=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),arguments.length>0&&console.error("THREE.Matrix4: the constructor no longer reads arguments. use .set() instead.")}function CubeTexture(e,t,r,i,n,a,o,s,c,l){e=void 0!==e?e:[],t=void 0!==t?t:ie,Texture.call(this,e,t,r,i,n,a,o,s,c,l),this.flipY=!1}function UniformContainer(){this.seq=[],this.map={}}function flatten(e,t,r){var i=e[0];if(i<=0||i>0)return e;var n=t*r,a=mt[n];if(void 0===a&&(a=new Float32Array(n),mt[n]=a),0!==t){i.toArray(a,0);for(var o=1,s=0;o!==t;++o)s+=r,e[o].toArray(a,s)}return a}function allocTexUnits(e,t){var r=gt[t];void 0===r&&(r=new Int32Array(t),gt[t]=r);for(var i=0;i!==t;++i)r[i]=e.allocTextureUnit();return r}function setValue1f(e,t){e.uniform1f(this.addr,t)}function setValue1i(e,t){e.uniform1i(this.addr,t)}function setValue2fv(e,t){void 0===t.x?e.uniform2fv(this.addr,t):e.uniform2f(this.addr,t.x,t.y)}function setValue3fv(e,t){void 0!==t.x?e.uniform3f(this.addr,t.x,t.y,t.z):void 0!==t.r?e.uniform3f(this.addr,t.r,t.g,t.b):e.uniform3fv(this.addr,t)}function setValue4fv(e,t){void 0===t.x?e.uniform4fv(this.addr,t):e.uniform4f(this.addr,t.x,t.y,t.z,t.w)}function setValue2fm(e,t){e.uniformMatrix2fv(this.addr,!1,t.elements||t)}function setValue3fm(e,t){e.uniformMatrix3fv(this.addr,!1,t.elements||t)}function setValue4fm(e,t){e.uniformMatrix4fv(this.addr,!1,t.elements||t)}function setValueT1(e,t,r){var i=r.allocTextureUnit();e.uniform1i(this.addr,i),r.setTexture2D(t||pt,i)}function setValueT6(e,t,r){var i=r.allocTextureUnit();e.uniform1i(this.addr,i),r.setTextureCube(t||ft,i)}function setValue2iv(e,t){e.uniform2iv(this.addr,t)}function setValue3iv(e,t){e.uniform3iv(this.addr,t)}function setValue4iv(e,t){e.uniform4iv(this.addr,t)}function getSingularSetter(e){switch(e){case 5126:return setValue1f;case 35664:return setValue2fv;case 35665:return setValue3fv;case 35666:return setValue4fv;case 35674:return setValue2fm;case 35675:return setValue3fm;case 35676:return setValue4fm;case 35678:return setValueT1;case 35680:return setValueT6;case 5124:case 35670:return setValue1i;case 35667:case 35671:return setValue2iv;case 35668:case 35672:return setValue3iv;case 35669:case 35673:return setValue4iv}}function setValue1fv(e,t){e.uniform1fv(this.addr,t)}function setValue1iv(e,t){e.uniform1iv(this.addr,t)}function setValueV2a(e,t){e.uniform2fv(this.addr,flatten(t,this.size,2))}function setValueV3a(e,t){e.uniform3fv(this.addr,flatten(t,this.size,3))}function setValueV4a(e,t){e.uniform4fv(this.addr,flatten(t,this.size,4))}function setValueM2a(e,t){e.uniformMatrix2fv(this.addr,!1,flatten(t,this.size,4))}function setValueM3a(e,t){e.uniformMatrix3fv(this.addr,!1,flatten(t,this.size,9))}function setValueM4a(e,t){e.uniformMatrix4fv(this.addr,!1,flatten(t,this.size,16))}function setValueT1a(e,t,r){var i=t.length,n=allocTexUnits(r,i);e.uniform1iv(this.addr,n);for(var a=0;a!==i;++a)r.setTexture2D(t[a]||pt,n[a])}function setValueT6a(e,t,r){var i=t.length,n=allocTexUnits(r,i);e.uniform1iv(this.addr,n);for(var a=0;a!==i;++a)r.setTextureCube(t[a]||ft,n[a])}function getPureArraySetter(e){switch(e){case 5126:return setValue1fv;case 35664:return setValueV2a;case 35665:return setValueV3a;case 35666:return setValueV4a;case 35674:return setValueM2a;case 35675:return setValueM3a;case 35676:return setValueM4a;case 35678:return setValueT1a;case 35680:return setValueT6a;case 5124:case 35670:return setValue1iv;case 35667:case 35671:return setValue2iv;case 35668:case 35672:return setValue3iv;case 35669:case 35673:return setValue4iv}}function SingleUniform(e,t,r){this.id=e,this.addr=r,this.setValue=getSingularSetter(t.type)}function PureArrayUniform(e,t,r){this.id=e,this.addr=r,this.size=t.size,this.setValue=getPureArraySetter(t.type)}function StructuredUniform(e){this.id=e,UniformContainer.call(this)}function addUniform(e,t){e.seq.push(t),e.map[t.id]=t}function parseUniform(e,t,r){var i=e.name,n=i.length;for(vt.lastIndex=0;;){var a=vt.exec(i),o=vt.lastIndex,s=a[1],c="]"===a[2],l=a[3];if(c&&(s|=0),void 0===l||"["===l&&o+2===n){addUniform(r,void 0===l?new SingleUniform(s,e,t):new PureArrayUniform(s,e,t));break}var h=r.map[s];void 0===h&&addUniform(r,h=new StructuredUniform(s)),r=h}}function WebGLUniforms(e,t,r){UniformContainer.call(this),this.renderer=r;for(var i=e.getProgramParameter(t,e.ACTIVE_UNIFORMS),n=0;n!==i;++n){var a=e.getActiveUniform(t,n),o=a.name;parseUniform(a,e.getUniformLocation(t,o),this)}}function Color(e,t,r){return void 0===t&&void 0===r?this.set(e):this.setRGB(e,t,r)}function Box2(e,t){this.min=void 0!==e?e:new Vector2(1/0,1/0),this.max=void 0!==t?t:new Vector2(-1/0,-1/0)}function LensFlarePlugin(e,t){function init(){var e=new Float32Array([-1,-1,0,0,1,-1,1,0,1,1,1,1,-1,1,0,1]),t=new Uint16Array([0,1,2,0,2,3]);r=h.createBuffer(),i=h.createBuffer(),h.bindBuffer(h.ARRAY_BUFFER,r),h.bufferData(h.ARRAY_BUFFER,e,h.STATIC_DRAW),h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,i),h.bufferData(h.ELEMENT_ARRAY_BUFFER,t,h.STATIC_DRAW),c=h.createTexture(),l=h.createTexture(),u.bindTexture(h.TEXTURE_2D,c),h.texImage2D(h.TEXTURE_2D,0,h.RGB,16,16,0,h.RGB,h.UNSIGNED_BYTE,null),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_S,h.CLAMP_TO_EDGE),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_T,h.CLAMP_TO_EDGE),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MAG_FILTER,h.NEAREST),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MIN_FILTER,h.NEAREST),u.bindTexture(h.TEXTURE_2D,l),h.texImage2D(h.TEXTURE_2D,0,h.RGBA,16,16,0,h.RGBA,h.UNSIGNED_BYTE,null),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_S,h.CLAMP_TO_EDGE),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_T,h.CLAMP_TO_EDGE),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MAG_FILTER,h.NEAREST),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MIN_FILTER,h.NEAREST),n={vertexShader:["uniform lowp int renderType;","uniform vec3 screenPosition;","uniform vec2 scale;","uniform float rotation;","uniform sampler2D occlusionMap;","attribute vec2 position;","attribute vec2 uv;","varying vec2 vUV;","varying float vVisibility;","void main() {","vUV = uv;","vec2 pos = position;","if ( renderType == 2 ) {","vec4 visibility = texture2D( occlusionMap, vec2( 0.1, 0.1 ) );","visibility += texture2D( occlusionMap, vec2( 0.5, 0.1 ) );","visibility += texture2D( occlusionMap, vec2( 0.9, 0.1 ) );","visibility += texture2D( occlusionMap, vec2( 0.9, 0.5 ) );","visibility += texture2D( occlusionMap, vec2( 0.9, 0.9 ) );","visibility += texture2D( occlusionMap, vec2( 0.5, 0.9 ) );","visibility += texture2D( occlusionMap, vec2( 0.1, 0.9 ) );","visibility += texture2D( occlusionMap, vec2( 0.1, 0.5 ) );","visibility += texture2D( occlusionMap, vec2( 0.5, 0.5 ) );","vVisibility =        visibility.r / 9.0;","vVisibility *= 1.0 - visibility.g / 9.0;","vVisibility *=       visibility.b / 9.0;","vVisibility *= 1.0 - visibility.a / 9.0;","pos.x = cos( rotation ) * position.x - sin( rotation ) * position.y;","pos.y = sin( rotation ) * position.x + cos( rotation ) * position.y;","}","gl_Position = vec4( ( pos * scale + screenPosition.xy ).xy, screenPosition.z, 1.0 );","}"].join("\n"),fragmentShader:["uniform lowp int renderType;","uniform sampler2D map;","uniform float opacity;","uniform vec3 color;","varying vec2 vUV;","varying float vVisibility;","void main() {","if ( renderType == 0 ) {","gl_FragColor = vec4( 1.0, 0.0, 1.0, 0.0 );","} else if ( renderType == 1 ) {","gl_FragColor = texture2D( map, vUV );","} else {","vec4 texture = texture2D( map, vUV );","texture.a *= opacity * vVisibility;","gl_FragColor = texture;","gl_FragColor.rgb *= color;","}","}"].join("\n")},a=createProgram(n),o={vertex:h.getAttribLocation(a,"position"),uv:h.getAttribLocation(a,"uv")},s={renderType:h.getUniformLocation(a,"renderType"),map:h.getUniformLocation(a,"map"),occlusionMap:h.getUniformLocation(a,"occlusionMap"),opacity:h.getUniformLocation(a,"opacity"),color:h.getUniformLocation(a,"color"),scale:h.getUniformLocation(a,"scale"),rotation:h.getUniformLocation(a,"rotation"),screenPosition:h.getUniformLocation(a,"screenPosition")}}function createProgram(t){var r=h.createProgram(),i=h.createShader(h.FRAGMENT_SHADER),n=h.createShader(h.VERTEX_SHADER),a="precision "+e.getPrecision()+" float;\n";return h.shaderSource(i,a+t.fragmentShader),h.shaderSource(n,a+t.vertexShader),h.compileShader(i),h.compileShader(n),h.attachShader(r,i),h.attachShader(r,n),h.linkProgram(r),r}var r,i,n,a,o,s,c,l,h=e.context,u=e.state;this.render=function(n,d,p){if(0!==t.length){var f=new Vector3,m=p.w/p.z,g=.5*p.z,v=.5*p.w,y=16/p.w,x=new Vector2(y*m,y),b=new Vector3(1,1,0),_=new Vector2(1,1),M=new Box2;M.min.set(p.x,p.y),M.max.set(p.x+(p.z-16),p.y+(p.w-16)),void 0===a&&init(),h.useProgram(a),u.initAttributes(),u.enableAttribute(o.vertex),u.enableAttribute(o.uv),u.disableUnusedAttributes(),h.uniform1i(s.occlusionMap,0),h.uniform1i(s.map,1),h.bindBuffer(h.ARRAY_BUFFER,r),h.vertexAttribPointer(o.vertex,2,h.FLOAT,!1,16,0),h.vertexAttribPointer(o.uv,2,h.FLOAT,!1,16,8),h.bindBuffer(h.ELEMENT_ARRAY_BUFFER,i),u.disable(h.CULL_FACE),u.setDepthWrite(!1);for(var w=0,T=t.length;w<T;w++){y=16/p.w,x.set(y*m,y);var S=t[w];if(f.set(S.matrixWorld.elements[12],S.matrixWorld.elements[13],S.matrixWorld.elements[14]),f.applyMatrix4(d.matrixWorldInverse),f.applyProjection(d.projectionMatrix),b.copy(f),_.x=p.x+b.x*g+g-8,_.y=p.y+b.y*v+v-8,!0===M.containsPoint(_)){u.activeTexture(h.TEXTURE0),u.bindTexture(h.TEXTURE_2D,null),u.activeTexture(h.TEXTURE1),u.bindTexture(h.TEXTURE_2D,c),h.copyTexImage2D(h.TEXTURE_2D,0,h.RGB,_.x,_.y,16,16,0),h.uniform1i(s.renderType,0),h.uniform2f(s.scale,x.x,x.y),h.uniform3f(s.screenPosition,b.x,b.y,b.z),u.disable(h.BLEND),u.enable(h.DEPTH_TEST),h.drawElements(h.TRIANGLES,6,h.UNSIGNED_SHORT,0),u.activeTexture(h.TEXTURE0),u.bindTexture(h.TEXTURE_2D,l),h.copyTexImage2D(h.TEXTURE_2D,0,h.RGBA,_.x,_.y,16,16,0),h.uniform1i(s.renderType,1),u.disable(h.DEPTH_TEST),u.activeTexture(h.TEXTURE1),u.bindTexture(h.TEXTURE_2D,c),h.drawElements(h.TRIANGLES,6,h.UNSIGNED_SHORT,0),S.positionScreen.copy(b),S.customUpdateCallback?S.customUpdateCallback(S):S.updateLensFlares(),h.uniform1i(s.renderType,2),u.enable(h.BLEND);for(var E=0,A=S.lensFlares.length;E<A;E++){var L=S.lensFlares[E];L.opacity>.001&&L.scale>.001&&(b.x=L.x,b.y=L.y,b.z=L.z,y=L.size*L.scale/p.w,x.x=y*m,x.y=y,h.uniform3f(s.screenPosition,b.x,b.y,b.z),h.uniform2f(s.scale,x.x,x.y),h.uniform1f(s.rotation,L.rotation),h.uniform1f(s.opacity,L.opacity),h.uniform3f(s.color,L.color.r,L.color.g,L.color.b),u.setBlending(L.blending,L.blendEquation,L.blendSrc,L.blendDst),e.setTexture2D(L.texture,1),h.drawElements(h.TRIANGLES,6,h.UNSIGNED_SHORT,0))}}}u.enable(h.CULL_FACE),u.enable(h.DEPTH_TEST),u.setDepthWrite(!0),e.resetGLState()}}}function SpritePlugin(e,t){function init(){var e=new Float32Array([-.5,-.5,0,0,.5,-.5,1,0,.5,.5,1,1,-.5,.5,0,1]),t=new Uint16Array([0,1,2,0,2,3]);r=c.createBuffer(),i=c.createBuffer(),c.bindBuffer(c.ARRAY_BUFFER,r),c.bufferData(c.ARRAY_BUFFER,e,c.STATIC_DRAW),c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,i),c.bufferData(c.ELEMENT_ARRAY_BUFFER,t,c.STATIC_DRAW),n=createProgram(),a={position:c.getAttribLocation(n,"position"),uv:c.getAttribLocation(n,"uv")},o={uvOffset:c.getUniformLocation(n,"uvOffset"),uvScale:c.getUniformLocation(n,"uvScale"),rotation:c.getUniformLocation(n,"rotation"),scale:c.getUniformLocation(n,"scale"),color:c.getUniformLocation(n,"color"),map:c.getUniformLocation(n,"map"),opacity:c.getUniformLocation(n,"opacity"),modelViewMatrix:c.getUniformLocation(n,"modelViewMatrix"),projectionMatrix:c.getUniformLocation(n,"projectionMatrix"),fogType:c.getUniformLocation(n,"fogType"),fogDensity:c.getUniformLocation(n,"fogDensity"),fogNear:c.getUniformLocation(n,"fogNear"),fogFar:c.getUniformLocation(n,"fogFar"),fogColor:c.getUniformLocation(n,"fogColor"),alphaTest:c.getUniformLocation(n,"alphaTest")};var l=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");l.width=8,l.height=8;var h=l.getContext("2d");h.fillStyle="white",h.fillRect(0,0,8,8),(s=new Texture(l)).needsUpdate=!0}function createProgram(){var t=c.createProgram(),r=c.createShader(c.VERTEX_SHADER),i=c.createShader(c.FRAGMENT_SHADER);return c.shaderSource(r,["precision "+e.getPrecision()+" float;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform float rotation;","uniform vec2 scale;","uniform vec2 uvOffset;","uniform vec2 uvScale;","attribute vec2 position;","attribute vec2 uv;","varying vec2 vUV;","void main() {","vUV = uvOffset + uv * uvScale;","vec2 alignedPosition = position * scale;","vec2 rotatedPosition;","rotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;","rotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;","vec4 finalPosition;","finalPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );","finalPosition.xy += rotatedPosition;","finalPosition = projectionMatrix * finalPosition;","gl_Position = finalPosition;","}"].join("\n")),c.shaderSource(i,["precision "+e.getPrecision()+" float;","uniform vec3 color;","uniform sampler2D map;","uniform float opacity;","uniform int fogType;","uniform vec3 fogColor;","uniform float fogDensity;","uniform float fogNear;","uniform float fogFar;","uniform float alphaTest;","varying vec2 vUV;","void main() {","vec4 texture = texture2D( map, vUV );","if ( texture.a < alphaTest ) discard;","gl_FragColor = vec4( color * texture.xyz, texture.a * opacity );","if ( fogType > 0 ) {","float depth = gl_FragCoord.z / gl_FragCoord.w;","float fogFactor = 0.0;","if ( fogType == 1 ) {","fogFactor = smoothstep( fogNear, fogFar, depth );","} else {","const float LOG2 = 1.442695;","fogFactor = exp2( - fogDensity * fogDensity * depth * depth * LOG2 );","fogFactor = 1.0 - clamp( fogFactor, 0.0, 1.0 );","}","gl_FragColor = mix( gl_FragColor, vec4( fogColor, gl_FragColor.w ), fogFactor );","}","}"].join("\n")),c.compileShader(r),c.compileShader(i),c.attachShader(t,r),c.attachShader(t,i),c.linkProgram(t),t}function painterSortStable(e,t){return e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.z!==t.z?t.z-e.z:t.id-e.id}var r,i,n,a,o,s,c=e.context,l=e.state,h=new Vector3,u=new Quaternion,d=new Vector3;this.render=function(p,f){if(0!==t.length){void 0===n&&init(),c.useProgram(n),l.initAttributes(),l.enableAttribute(a.position),l.enableAttribute(a.uv),l.disableUnusedAttributes(),l.disable(c.CULL_FACE),l.enable(c.BLEND),c.bindBuffer(c.ARRAY_BUFFER,r),c.vertexAttribPointer(a.position,2,c.FLOAT,!1,16,0),c.vertexAttribPointer(a.uv,2,c.FLOAT,!1,16,8),c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,i),c.uniformMatrix4fv(o.projectionMatrix,!1,f.projectionMatrix.elements),l.activeTexture(c.TEXTURE0),c.uniform1i(o.map,0);var m=0,g=0,v=p.fog;v?(c.uniform3f(o.fogColor,v.color.r,v.color.g,v.color.b),v&&v.isFog?(c.uniform1f(o.fogNear,v.near),c.uniform1f(o.fogFar,v.far),c.uniform1i(o.fogType,1),m=1,g=1):v&&v.isFogExp2&&(c.uniform1f(o.fogDensity,v.density),c.uniform1i(o.fogType,2),m=2,g=2)):(c.uniform1i(o.fogType,0),m=0,g=0);for(var y=0,x=t.length;y<x;y++)(_=t[y]).modelViewMatrix.multiplyMatrices(f.matrixWorldInverse,_.matrixWorld),_.z=-_.modelViewMatrix.elements[14];t.sort(painterSortStable);for(var b=[],y=0,x=t.length;y<x;y++){var _=t[y],M=_.material;if(!1!==M.visible){c.uniform1f(o.alphaTest,M.alphaTest),c.uniformMatrix4fv(o.modelViewMatrix,!1,_.modelViewMatrix.elements),_.matrixWorld.decompose(h,u,d),b[0]=d.x,b[1]=d.y;var w=0;p.fog&&M.fog&&(w=g),m!==w&&(c.uniform1i(o.fogType,w),m=w),null!==M.map?(c.uniform2f(o.uvOffset,M.map.offset.x,M.map.offset.y),c.uniform2f(o.uvScale,M.map.repeat.x,M.map.repeat.y)):(c.uniform2f(o.uvOffset,0,0),c.uniform2f(o.uvScale,1,1)),c.uniform1f(o.opacity,M.opacity),c.uniform3f(o.color,M.color.r,M.color.g,M.color.b),c.uniform1f(o.rotation,M.rotation),c.uniform2fv(o.scale,b),l.setBlending(M.blending,M.blendEquation,M.blendSrc,M.blendDst),l.setDepthTest(M.depthTest),l.setDepthWrite(M.depthWrite),M.map?e.setTexture2D(M.map,0):e.setTexture2D(s,0),c.drawElements(c.TRIANGLES,6,c.UNSIGNED_SHORT,0)}}l.enable(c.CULL_FACE),e.resetGLState()}}}function Material(){Object.defineProperty(this,"id",{value:MaterialIdCount()}),this.uuid=ut.generateUUID(),this.name="",this.type="Material",this.fog=!0,this.lights=!0,this.blending=x,this.side=l,this.shading=p,this.vertexColors=f,this.opacity=1,this.transparent=!1,this.blendSrc=G,this.blendDst=D,this.blendEquation=S,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.depthFunc=j,this.depthTest=!0,this.depthWrite=!0,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.alphaTest=0,this.premultipliedAlpha=!1,this.overdraw=0,this.visible=!0,this._needsUpdate=!0}function MaterialIdCount(){return wt++}function ShaderMaterial(e){Material.call(this),this.type="ShaderMaterial",this.defines={},this.uniforms={},this.vertexShader="void main() {\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",this.fragmentShader="void main() {\n\tgl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );\n}",this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.extensions={derivatives:!1,fragDepth:!1,drawBuffers:!1,shaderTextureLOD:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},this.index0AttributeName=void 0,void 0!==e&&(void 0!==e.attributes&&console.error("THREE.ShaderMaterial: attributes should now be defined in THREE.BufferGeometry instead."),this.setValues(e))}function MeshDepthMaterial(e){Material.call(this),this.type="MeshDepthMaterial",this.depthPacking=lt,this.skinning=!1,this.morphTargets=!1,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.setValues(e)}function Box3(e,t){this.min=void 0!==e?e:new Vector3(1/0,1/0,1/0),this.max=void 0!==t?t:new Vector3(-1/0,-1/0,-1/0)}function Sphere(e,t){this.center=void 0!==e?e:new Vector3,this.radius=void 0!==t?t:0}function Matrix3(){this.elements=new Float32Array([1,0,0,0,1,0,0,0,1]),arguments.length>0&&console.error("THREE.Matrix3: the constructor no longer reads arguments. use .set() instead.")}function Plane(e,t){this.normal=void 0!==e?e:new Vector3(1,0,0),this.constant=void 0!==t?t:0}function Frustum(e,t,r,i,n,a){this.planes=[void 0!==e?e:new Plane,void 0!==t?t:new Plane,void 0!==r?r:new Plane,void 0!==i?i:new Plane,void 0!==n?n:new Plane,void 0!==a?a:new Plane]}function WebGLShadowMap(e,t,r,i){function getDepthMaterial(t,r,i,n){var a=t.geometry,o=null,s=_,c=t.customDepthMaterial;if(i&&(s=M,c=t.customDistanceMaterial),c)o=c;else{var d=!1;r.morphTargets&&(a&&a.isBufferGeometry?d=a.morphAttributes&&a.morphAttributes.position&&a.morphAttributes.position.length>0:a&&a.isGeometry&&(d=a.morphTargets&&a.morphTargets.length>0));var p=t.isSkinnedMesh&&r.skinning,f=0;d&&(f|=y),p&&(f|=x),o=s[f]}if(e.localClippingEnabled&&!0===r.clipShadows&&0!==r.clippingPlanes.length){var m=o.uuid,g=r.uuid,v=w[m];void 0===v&&(v={},w[m]=v);var b=v[g];void 0===b&&(b=o.clone(),v[g]=b),o=b}o.visible=r.visible,o.wireframe=r.wireframe;var T=r.side;return D.renderSingleSided&&T==u&&(T=l),D.renderReverseSided&&(T===l?T=h:T===h&&(T=l)),o.side=T,o.clipShadows=r.clipShadows,o.clippingPlanes=r.clippingPlanes,o.wireframeLinewidth=r.wireframeLinewidth,o.linewidth=r.linewidth,i&&void 0!==o.uniforms.lightPos&&o.uniforms.lightPos.value.copy(n),o}function projectObject(e,t,r){if(!1!==e.visible){0!=(e.layers.mask&t.layers.mask)&&(e.isMesh||e.isLine||e.isPoints)&&(!e.castShadow||!1!==e.frustumCulled&&!0!==o.intersectsObject(e)||!0===e.material.visible&&(e.modelViewMatrix.multiplyMatrices(r.matrixWorldInverse,e.matrixWorld),v.push(e)));for(var i=e.children,n=0,a=i.length;n<a;n++)projectObject(i[n],t,r)}}var n=e.context,a=e.state,o=new Frustum,c=new Matrix4,d=t.shadows,p=new Vector2,f=new Vector2(i.maxTextureSize,i.maxTextureSize),m=new Vector3,g=new Vector3,v=[],y=1,x=2,b=1+(y|x),_=new Array(b),M=new Array(b),w={},T=[new Vector3(1,0,0),new Vector3(-1,0,0),new Vector3(0,0,1),new Vector3(0,0,-1),new Vector3(0,1,0),new Vector3(0,-1,0)],S=[new Vector3(0,1,0),new Vector3(0,1,0),new Vector3(0,1,0),new Vector3(0,1,0),new Vector3(0,0,1),new Vector3(0,0,-1)],E=[new Vector4,new Vector4,new Vector4,new Vector4,new Vector4,new Vector4],A=new MeshDepthMaterial;A.depthPacking=ht,A.clipping=!0;for(var L=Mt.distanceRGBA,P=yt.clone(L.uniforms),C=0;C!==b;++C){var R=0!=(C&y),B=0!=(C&x),I=A.clone();I.morphTargets=R,I.skinning=B,_[C]=I;var G=new ShaderMaterial({defines:{USE_SHADOWMAP:""},uniforms:P,vertexShader:L.vertexShader,fragmentShader:L.fragmentShader,morphTargets:R,skinning:B,clipping:!0});M[C]=G}var D=this;this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=s,this.renderReverseSided=!0,this.renderSingleSided=!0,this.render=function(t,i){if(!1!==D.enabled&&(!1!==D.autoUpdate||!1!==D.needsUpdate)&&0!==d.length){a.clearColor(1,1,1,1),a.disable(n.BLEND),a.setDepthTest(!0),a.setScissorTest(!1);for(var s,l,h=0,u=d.length;h<u;h++){var y=d[h],x=y.shadow;if(void 0!==x){var b=x.camera;if(p.copy(x.mapSize),p.min(f),y&&y.isPointLight){s=6,l=!0;var _=p.x,M=p.y;E[0].set(2*_,M,_,M),E[1].set(0,M,_,M),E[2].set(3*_,M,_,M),E[3].set(_,M,_,M),E[4].set(3*_,0,_,M),E[5].set(_,0,_,M),p.x*=4,p.y*=2}else s=1,l=!1;if(null===x.map){var w={minFilter:me,magFilter:me,format:Ue};x.map=new WebGLRenderTarget(p.x,p.y,w),b.updateProjectionMatrix()}x&&x.isSpotLightShadow&&x.update(y);var A=x.map,L=x.matrix;g.setFromMatrixPosition(y.matrixWorld),b.position.copy(g),e.setRenderTarget(A),e.clear();for(var P=0;P<s;P++){if(l){m.copy(b.position),m.add(T[P]),b.up.copy(S[P]),b.lookAt(m);var C=E[P];a.viewport(C)}else m.setFromMatrixPosition(y.target.matrixWorld),b.lookAt(m);b.updateMatrixWorld(),b.matrixWorldInverse.getInverse(b.matrixWorld),L.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),L.multiply(b.projectionMatrix),L.multiply(b.matrixWorldInverse),c.multiplyMatrices(b.projectionMatrix,b.matrixWorldInverse),o.setFromMatrix(c),v.length=0,projectObject(t,i,b);for(var R=0,B=v.length;R<B;R++){var I=v[R],G=r.update(I),U=I.material;if(U&&U.isMultiMaterial)for(var O=G.groups,F=U.materials,V=0,N=O.length;V<N;V++){var z=O[V],H=F[z.materialIndex];if(!0===H.visible){k=getDepthMaterial(I,H,l,g);e.renderBufferDirect(b,null,G,k,I,z)}}else{var k=getDepthMaterial(I,U,l,g);e.renderBufferDirect(b,null,G,k,I,null)}}}}else console.warn("THREE.WebGLShadowMap:",y,"has no shadow.")}var j=e.getClearColor(),W=e.getClearAlpha();e.setClearColor(j,W),D.needsUpdate=!1}}}function Ray(e,t){this.origin=void 0!==e?e:new Vector3,this.direction=void 0!==t?t:new Vector3}function Euler(e,t,r,i){this._x=e||0,this._y=t||0,this._z=r||0,this._order=i||Euler.DefaultOrder}function Layers(){this.mask=1}function Object3D(){Object.defineProperty(this,"id",{value:Object3DIdCount()}),this.uuid=ut.generateUUID(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=Object3D.DefaultUp.clone();var e=new Vector3,t=new Euler,r=new Quaternion,i=new Vector3(1,1,1);t.onChange(function onRotationChange(){r.setFromEuler(t,!1)}),r.onChange(function onQuaternionChange(){t.setFromQuaternion(r,void 0,!1)}),Object.defineProperties(this,{position:{enumerable:!0,value:e},rotation:{enumerable:!0,value:t},quaternion:{enumerable:!0,value:r},scale:{enumerable:!0,value:i},modelViewMatrix:{value:new Matrix4},normalMatrix:{value:new Matrix3}}),this.matrix=new Matrix4,this.matrixWorld=new Matrix4,this.matrixAutoUpdate=Object3D.DefaultMatrixAutoUpdate,this.matrixWorldNeedsUpdate=!1,this.layers=new Layers,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.userData={},this.onBeforeRender=function(){},this.onAfterRender=function(){}}function Object3DIdCount(){return Tt++}function Line3(e,t){this.start=void 0!==e?e:new Vector3,this.end=void 0!==t?t:new Vector3}function Triangle(e,t,r){this.a=void 0!==e?e:new Vector3,this.b=void 0!==t?t:new Vector3,this.c=void 0!==r?r:new Vector3}function Face3(e,t,r,i,n,a){this.a=e,this.b=t,this.c=r,this.normal=i&&i.isVector3?i:new Vector3,this.vertexNormals=Array.isArray(i)?i:[],this.color=n&&n.isColor?n:new Color,this.vertexColors=Array.isArray(n)?n:[],this.materialIndex=void 0!==a?a:0}function MeshBasicMaterial(e){Material.call(this),this.type="MeshBasicMaterial",this.color=new Color(16777215),this.map=null,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=Z,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.lights=!1,this.setValues(e)}function BufferAttribute(e,t,r){if(Array.isArray(e))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.uuid=ut.generateUUID(),this.array=e,this.itemSize=t,this.count=void 0!==e?e.length/t:0,this.normalized=!0===r,this.dynamic=!1,this.updateRange={offset:0,count:-1},this.version=0}function Uint16Attribute(e,t){return new BufferAttribute(new Uint16Array(e),t)}function Uint32Attribute(e,t){return new BufferAttribute(new Uint32Array(e),t)}function Float32Attribute(e,t){return new BufferAttribute(new Float32Array(e),t)}function Geometry(){Object.defineProperty(this,"id",{value:GeometryIdCount()}),this.uuid=ut.generateUUID(),this.name="",this.type="Geometry",this.vertices=[],this.colors=[],this.faces=[],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingBox=null,this.boundingSphere=null,this.elementsNeedUpdate=!1,this.verticesNeedUpdate=!1,this.uvsNeedUpdate=!1,this.normalsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.lineDistancesNeedUpdate=!1,this.groupsNeedUpdate=!1}function GeometryIdCount(){return St++}function DirectGeometry(){Object.defineProperty(this,"id",{value:GeometryIdCount()}),this.uuid=ut.generateUUID(),this.name="",this.type="DirectGeometry",this.indices=[],this.vertices=[],this.normals=[],this.colors=[],this.uvs=[],this.uvs2=[],this.groups=[],this.morphTargets={},this.skinWeights=[],this.skinIndices=[],this.boundingBox=null,this.boundingSphere=null,this.verticesNeedUpdate=!1,this.normalsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.uvsNeedUpdate=!1,this.groupsNeedUpdate=!1}function BufferGeometry(){Object.defineProperty(this,"id",{value:GeometryIdCount()}),this.uuid=ut.generateUUID(),this.name="",this.type="BufferGeometry",this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0}}function Mesh(e,t){Object3D.call(this),this.type="Mesh",this.geometry=void 0!==e?e:new BufferGeometry,this.material=void 0!==t?t:new MeshBasicMaterial({color:16777215*Math.random()}),this.drawMode=$e,this.updateMorphTargets()}function BoxBufferGeometry(e,t,r,i,n,a){function buildPlane(e,t,r,i,n,a,s,c,y,x,b){for(var _=a/y,M=s/x,w=a/2,T=s/2,S=c/2,E=y+1,A=x+1,L=0,P=0,C=new Vector3,R=0;R<A;R++)for(var B=R*M-T,I=0;I<E;I++){var G=I*_-w;C[e]=G*i,C[t]=B*n,C[r]=S,h[p]=C.x,h[p+1]=C.y,h[p+2]=C.z,C[e]=0,C[t]=0,C[r]=c>0?1:-1,u[p]=C.x,u[p+1]=C.y,u[p+2]=C.z,d[f]=I/y,d[f+1]=1-R/x,p+=3,f+=2,L+=1}for(R=0;R<x;R++)for(I=0;I<y;I++){var D=g+I+E*R,U=g+I+E*(R+1),O=g+(I+1)+E*(R+1),F=g+(I+1)+E*R;l[m]=D,l[m+1]=U,l[m+2]=F,l[m+3]=U,l[m+4]=O,l[m+5]=F,m+=6,P+=6}o.addGroup(v,P,b),v+=P,g+=L}BufferGeometry.call(this),this.type="BoxBufferGeometry",this.parameters={width:e,height:t,depth:r,widthSegments:i,heightSegments:n,depthSegments:a};var o=this,s=function calculateVertexCount(e,t,r){var i=0;return i+=(e+1)*(t+1)*2,i+=(e+1)*(r+1)*2,i+=(r+1)*(t+1)*2}(i=Math.floor(i)||1,n=Math.floor(n)||1,a=Math.floor(a)||1),c=function calculateIndexCount(e,t,r){var i=0;return i+=e*t*2,i+=e*r*2,6*(i+=r*t*2)}(i,n,a),l=new(c>65535?Uint32Array:Uint16Array)(c),h=new Float32Array(3*s),u=new Float32Array(3*s),d=new Float32Array(2*s),p=0,f=0,m=0,g=0,v=0;buildPlane("z","y","x",-1,-1,r,t,e,a,n,0),buildPlane("z","y","x",1,-1,r,t,-e,a,n,1),buildPlane("x","z","y",1,1,e,r,t,i,a,2),buildPlane("x","z","y",1,-1,e,r,-t,i,a,3),buildPlane("x","y","z",1,-1,e,t,r,i,n,4),buildPlane("x","y","z",-1,-1,e,t,-r,i,n,5),this.setIndex(new BufferAttribute(l,1)),this.addAttribute("position",new BufferAttribute(h,3)),this.addAttribute("normal",new BufferAttribute(u,3)),this.addAttribute("uv",new BufferAttribute(d,2))}function PlaneBufferGeometry(e,t,r,i){BufferGeometry.call(this),this.type="PlaneBufferGeometry",this.parameters={width:e,height:t,widthSegments:r,heightSegments:i};for(var n=e/2,a=t/2,o=Math.floor(r)||1,s=Math.floor(i)||1,c=o+1,l=s+1,h=e/o,u=t/s,d=new Float32Array(c*l*3),p=new Float32Array(c*l*3),f=new Float32Array(c*l*2),m=0,g=0,v=0;v<l;v++)for(var y=v*u-a,x=0;x<c;x++){var b=x*h-n;d[m]=b,d[m+1]=-y,p[m+2]=1,f[g]=x/o,f[g+1]=1-v/s,m+=3,g+=2}m=0;for(var _=new(d.length/3>65535?Uint32Array:Uint16Array)(o*s*6),v=0;v<s;v++)for(x=0;x<o;x++){var M=x+c*v,w=x+c*(v+1),T=x+1+c*(v+1),S=x+1+c*v;_[m]=M,_[m+1]=w,_[m+2]=S,_[m+3]=w,_[m+4]=T,_[m+5]=S,m+=6}this.setIndex(new BufferAttribute(_,1)),this.addAttribute("position",new BufferAttribute(d,3)),this.addAttribute("normal",new BufferAttribute(p,3)),this.addAttribute("uv",new BufferAttribute(f,2))}function Camera(){Object3D.call(this),this.type="Camera",this.matrixWorldInverse=new Matrix4,this.projectionMatrix=new Matrix4}function PerspectiveCamera(e,t,r,i){Camera.call(this),this.type="PerspectiveCamera",this.fov=void 0!==e?e:50,this.zoom=1,this.near=void 0!==r?r:.1,this.far=void 0!==i?i:2e3,this.focus=10,this.aspect=void 0!==t?t:1,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}function OrthographicCamera(e,t,r,i,n,a){Camera.call(this),this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=e,this.right=t,this.top=r,this.bottom=i,this.near=void 0!==n?n:.1,this.far=void 0!==a?a:2e3,this.updateProjectionMatrix()}function WebGLIndexedBufferRenderer(e,t,r){var i,n,a;return{setMode:function setMode(e){i=e},setIndex:function setIndex(r){r.array instanceof Uint32Array&&t.get("OES_element_index_uint")?(n=e.UNSIGNED_INT,a=4):(n=e.UNSIGNED_SHORT,a=2)},render:function render(t,o){e.drawElements(i,o,n,t*a),r.calls++,r.vertices+=o,i===e.TRIANGLES&&(r.faces+=o/3)},renderInstances:function renderInstances(o,s,c){var l=t.get("ANGLE_instanced_arrays");null!==l?(l.drawElementsInstancedANGLE(i,c,n,s*a,o.maxInstancedCount),r.calls++,r.vertices+=c*o.maxInstancedCount,i===e.TRIANGLES&&(r.faces+=o.maxInstancedCount*c/3)):console.error("THREE.WebGLBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.")}}}function WebGLBufferRenderer(e,t,r){var i;return{setMode:function setMode(e){i=e},render:function render(t,n){e.drawArrays(i,t,n),r.calls++,r.vertices+=n,i===e.TRIANGLES&&(r.faces+=n/3)},renderInstances:function renderInstances(n){var a=t.get("ANGLE_instanced_arrays");if(null!==a){var o=n.attributes.position,s=0;o&&o.isInterleavedBufferAttribute?(s=o.data.count,a.drawArraysInstancedANGLE(i,0,s,n.maxInstancedCount)):(s=o.count,a.drawArraysInstancedANGLE(i,0,s,n.maxInstancedCount)),r.calls++,r.vertices+=s*n.maxInstancedCount,i===e.TRIANGLES&&(r.faces+=n.maxInstancedCount*s/3)}else console.error("THREE.WebGLBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.")}}}function WebGLLights(){var e={};return{get:function(t){if(void 0!==e[t.id])return e[t.id];var r;switch(t.type){case"DirectionalLight":r={direction:new Vector3,color:new Color,shadow:!1,shadowBias:0,shadowRadius:1,shadowMapSize:new Vector2};break;case"SpotLight":r={position:new Vector3,direction:new Vector3,color:new Color,distance:0,coneCos:0,penumbraCos:0,decay:0,shadow:!1,shadowBias:0,shadowRadius:1,shadowMapSize:new Vector2};break;case"PointLight":r={position:new Vector3,color:new Color,distance:0,decay:0,shadow:!1,shadowBias:0,shadowRadius:1,shadowMapSize:new Vector2};break;case"HemisphereLight":r={direction:new Vector3,skyColor:new Color,groundColor:new Color}}return e[t.id]=r,r}}}function addLineNumbers(e){for(var t=e.split("\n"),r=0;r<t.length;r++)t[r]=r+1+": "+t[r];return t.join("\n")}function WebGLShader(e,t,r){var i=e.createShader(t);return e.shaderSource(i,r),e.compileShader(i),!1===e.getShaderParameter(i,e.COMPILE_STATUS)&&console.error("THREE.WebGLShader: Shader couldn't compile."),""!==e.getShaderInfoLog(i)&&console.warn("THREE.WebGLShader: gl.getShaderInfoLog()",t===e.VERTEX_SHADER?"vertex":"fragment",e.getShaderInfoLog(i),addLineNumbers(r)),i}function getEncodingComponents(e){switch(e){case rt:return["Linear","( value )"];case it:return["sRGB","( value )"];case at:return["RGBE","( value )"];case ot:return["RGBM","( value, 7.0 )"];case st:return["RGBM","( value, 16.0 )"];case ct:return["RGBD","( value, 256.0 )"];case nt:return["Gamma","( value, float( GAMMA_FACTOR ) )"];default:throw new Error("unsupported encoding: "+e)}}function getTexelDecodingFunction(e,t){var r=getEncodingComponents(t);return"vec4 "+e+"( vec4 value ) { return "+r[0]+"ToLinear"+r[1]+"; }"}function getTexelEncodingFunction(e,t){var r=getEncodingComponents(t);return"vec4 "+e+"( vec4 value ) { return LinearTo"+r[0]+r[1]+"; }"}function getToneMappingFunction(e,t){var r;switch(t){case $:r="Linear";break;case ee:r="Reinhard";break;case te:r="Uncharted2";break;case re:r="OptimizedCineon";break;default:throw new Error("unsupported toneMapping: "+t)}return"vec3 "+e+"( vec3 color ) { return "+r+"ToneMapping( color ); }"}function generateExtensions(e,t,r){return[(e=e||{}).derivatives||t.envMapCubeUV||t.bumpMap||t.normalMap||t.flatShading?"#extension GL_OES_standard_derivatives : enable":"",(e.fragDepth||t.logarithmicDepthBuffer)&&r.get("EXT_frag_depth")?"#extension GL_EXT_frag_depth : enable":"",e.drawBuffers&&r.get("WEBGL_draw_buffers")?"#extension GL_EXT_draw_buffers : require":"",(e.shaderTextureLOD||t.envMap)&&r.get("EXT_shader_texture_lod")?"#extension GL_EXT_shader_texture_lod : enable":""].filter(filterEmptyLine).join("\n")}function generateDefines(e){var t=[];for(var r in e){var i=e[r];!1!==i&&t.push("#define "+r+" "+i)}return t.join("\n")}function fetchAttributeLocations(e,t,r){for(var i={},n=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES),a=0;a<n;a++){var o=e.getActiveAttrib(t,a).name;i[o]=e.getAttribLocation(t,o)}return i}function filterEmptyLine(e){return""!==e}function replaceLightNums(e,t){return e.replace(/NUM_DIR_LIGHTS/g,t.numDirLights).replace(/NUM_SPOT_LIGHTS/g,t.numSpotLights).replace(/NUM_POINT_LIGHTS/g,t.numPointLights).replace(/NUM_HEMI_LIGHTS/g,t.numHemiLights)}function parseIncludes(e){var t=/#include +<([\w\d.]+)>/g;return e.replace(t,function replace(e,t){var r=xt[t];if(void 0===r)throw new Error("Can not resolve #include <"+t+">");return parseIncludes(r)})}function unrollLoops(e){var t=/for \( int i \= (\d+)\; i < (\d+)\; i \+\+ \) \{([\s\S]+?)(?=\})\}/g;return e.replace(t,function replace(e,t,r,i){for(var n="",a=parseInt(t);a<parseInt(r);a++)n+=i.replace(/\[ i \]/g,"[ "+a+" ]");return n})}function WebGLProgram(e,t,r,i){var n=e.context,a=r.extensions,o=r.defines,l=r.__webglShader.vertexShader,h=r.__webglShader.fragmentShader,u="SHADOWMAP_TYPE_BASIC";i.shadowMapType===s?u="SHADOWMAP_TYPE_PCF":i.shadowMapType===c&&(u="SHADOWMAP_TYPE_PCF_SOFT");var d="ENVMAP_TYPE_CUBE",p="ENVMAP_MODE_REFLECTION",f="ENVMAP_BLENDING_MULTIPLY";if(i.envMap){switch(r.envMap.mapping){case ie:case ne:d="ENVMAP_TYPE_CUBE";break;case ce:case le:d="ENVMAP_TYPE_CUBE_UV";break;case ae:case oe:d="ENVMAP_TYPE_EQUIREC";break;case se:d="ENVMAP_TYPE_SPHERE"}switch(r.envMap.mapping){case ne:case oe:p="ENVMAP_MODE_REFRACTION"}switch(r.combine){case Z:f="ENVMAP_BLENDING_MULTIPLY";break;case K:f="ENVMAP_BLENDING_MIX";break;case Q:f="ENVMAP_BLENDING_ADD"}}var m,g,v=e.gammaFactor>0?e.gammaFactor:1,y=generateExtensions(a,i,e.extensions),x=generateDefines(o),b=n.createProgram();r.isRawShaderMaterial?(m=[x,"\n"].filter(filterEmptyLine).join("\n"),g=[y,x,"\n"].filter(filterEmptyLine).join("\n")):(m=["precision "+i.precision+" float;","precision "+i.precision+" int;","#define SHADER_NAME "+r.__webglShader.name,x,i.supportsVertexTextures?"#define VERTEX_TEXTURES":"","#define GAMMA_FACTOR "+v,"#define MAX_BONES "+i.maxBones,i.map?"#define USE_MAP":"",i.envMap?"#define USE_ENVMAP":"",i.envMap?"#define "+p:"",i.lightMap?"#define USE_LIGHTMAP":"",i.aoMap?"#define USE_AOMAP":"",i.emissiveMap?"#define USE_EMISSIVEMAP":"",i.bumpMap?"#define USE_BUMPMAP":"",i.normalMap?"#define USE_NORMALMAP":"",i.displacementMap&&i.supportsVertexTextures?"#define USE_DISPLACEMENTMAP":"",i.specularMap?"#define USE_SPECULARMAP":"",i.roughnessMap?"#define USE_ROUGHNESSMAP":"",i.metalnessMap?"#define USE_METALNESSMAP":"",i.alphaMap?"#define USE_ALPHAMAP":"",i.vertexColors?"#define USE_COLOR":"",i.flatShading?"#define FLAT_SHADED":"",i.skinning?"#define USE_SKINNING":"",i.useVertexTexture?"#define BONE_TEXTURE":"",i.morphTargets?"#define USE_MORPHTARGETS":"",i.morphNormals&&!1===i.flatShading?"#define USE_MORPHNORMALS":"",i.doubleSided?"#define DOUBLE_SIDED":"",i.flipSided?"#define FLIP_SIDED":"","#define NUM_CLIPPING_PLANES "+i.numClippingPlanes,i.shadowMapEnabled?"#define USE_SHADOWMAP":"",i.shadowMapEnabled?"#define "+u:"",i.sizeAttenuation?"#define USE_SIZEATTENUATION":"",i.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",i.logarithmicDepthBuffer&&e.extensions.get("EXT_frag_depth")?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_COLOR","\tattribute vec3 color;","#endif","#ifdef USE_MORPHTARGETS","\tattribute vec3 morphTarget0;","\tattribute vec3 morphTarget1;","\tattribute vec3 morphTarget2;","\tattribute vec3 morphTarget3;","\t#ifdef USE_MORPHNORMALS","\t\tattribute vec3 morphNormal0;","\t\tattribute vec3 morphNormal1;","\t\tattribute vec3 morphNormal2;","\t\tattribute vec3 morphNormal3;","\t#else","\t\tattribute vec3 morphTarget4;","\t\tattribute vec3 morphTarget5;","\t\tattribute vec3 morphTarget6;","\t\tattribute vec3 morphTarget7;","\t#endif","#endif","#ifdef USE_SKINNING","\tattribute vec4 skinIndex;","\tattribute vec4 skinWeight;","#endif","\n"].filter(filterEmptyLine).join("\n"),g=[y,"precision "+i.precision+" float;","precision "+i.precision+" int;","#define SHADER_NAME "+r.__webglShader.name,x,i.alphaTest?"#define ALPHATEST "+i.alphaTest:"","#define GAMMA_FACTOR "+v,i.useFog&&i.fog?"#define USE_FOG":"",i.useFog&&i.fogExp?"#define FOG_EXP2":"",i.map?"#define USE_MAP":"",i.envMap?"#define USE_ENVMAP":"",i.envMap?"#define "+d:"",i.envMap?"#define "+p:"",i.envMap?"#define "+f:"",i.lightMap?"#define USE_LIGHTMAP":"",i.aoMap?"#define USE_AOMAP":"",i.emissiveMap?"#define USE_EMISSIVEMAP":"",i.bumpMap?"#define USE_BUMPMAP":"",i.normalMap?"#define USE_NORMALMAP":"",i.specularMap?"#define USE_SPECULARMAP":"",i.roughnessMap?"#define USE_ROUGHNESSMAP":"",i.metalnessMap?"#define USE_METALNESSMAP":"",i.alphaMap?"#define USE_ALPHAMAP":"",i.vertexColors?"#define USE_COLOR":"",i.flatShading?"#define FLAT_SHADED":"",i.doubleSided?"#define DOUBLE_SIDED":"",i.flipSided?"#define FLIP_SIDED":"","#define NUM_CLIPPING_PLANES "+i.numClippingPlanes,"#define UNION_CLIPPING_PLANES "+(i.numClippingPlanes-i.numClipIntersection),i.shadowMapEnabled?"#define USE_SHADOWMAP":"",i.shadowMapEnabled?"#define "+u:"",i.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",i.physicallyCorrectLights?"#define PHYSICALLY_CORRECT_LIGHTS":"",i.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",i.logarithmicDepthBuffer&&e.extensions.get("EXT_frag_depth")?"#define USE_LOGDEPTHBUF_EXT":"",i.envMap&&e.extensions.get("EXT_shader_texture_lod")?"#define TEXTURE_LOD_EXT":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;",i.toneMapping!==J?"#define TONE_MAPPING":"",i.toneMapping!==J?xt.tonemapping_pars_fragment:"",i.toneMapping!==J?getToneMappingFunction("toneMapping",i.toneMapping):"",i.outputEncoding||i.mapEncoding||i.envMapEncoding||i.emissiveMapEncoding?xt.encodings_pars_fragment:"",i.mapEncoding?getTexelDecodingFunction("mapTexelToLinear",i.mapEncoding):"",i.envMapEncoding?getTexelDecodingFunction("envMapTexelToLinear",i.envMapEncoding):"",i.emissiveMapEncoding?getTexelDecodingFunction("emissiveMapTexelToLinear",i.emissiveMapEncoding):"",i.outputEncoding?getTexelEncodingFunction("linearToOutputTexel",i.outputEncoding):"",i.depthPacking?"#define DEPTH_PACKING "+r.depthPacking:"","\n"].filter(filterEmptyLine).join("\n")),l=replaceLightNums(l=parseIncludes(l,i),i),h=replaceLightNums(h=parseIncludes(h,i),i),r.isShaderMaterial||(l=unrollLoops(l),h=unrollLoops(h));var _=m+l,M=g+h,w=WebGLShader(n,n.VERTEX_SHADER,_),T=WebGLShader(n,n.FRAGMENT_SHADER,M);n.attachShader(b,w),n.attachShader(b,T),void 0!==r.index0AttributeName?n.bindAttribLocation(b,0,r.index0AttributeName):!0===i.morphTargets&&n.bindAttribLocation(b,0,"position"),n.linkProgram(b);var S=n.getProgramInfoLog(b),E=n.getShaderInfoLog(w),A=n.getShaderInfoLog(T),L=!0,P=!0;!1===n.getProgramParameter(b,n.LINK_STATUS)?(L=!1,console.error("THREE.WebGLProgram: shader error: ",n.getError(),"gl.VALIDATE_STATUS",n.getProgramParameter(b,n.VALIDATE_STATUS),"gl.getProgramInfoLog",S,E,A)):""!==S?console.warn("THREE.WebGLProgram: gl.getProgramInfoLog()",S):""!==E&&""!==A||(P=!1),P&&(this.diagnostics={runnable:L,material:r,programLog:S,vertexShader:{log:E,prefix:m},fragmentShader:{log:A,prefix:g}}),n.deleteShader(w),n.deleteShader(T);var C;this.getUniforms=function(){return void 0===C&&(C=new WebGLUniforms(n,b,e)),C};var R;return this.getAttributes=function(){return void 0===R&&(R=fetchAttributeLocations(n,b)),R},this.destroy=function(){n.deleteProgram(b),this.program=void 0},Object.defineProperties(this,{uniforms:{get:function(){return console.warn("THREE.WebGLProgram: .uniforms is now .getUniforms()."),this.getUniforms()}},attributes:{get:function(){return console.warn("THREE.WebGLProgram: .attributes is now .getAttributes()."),this.getAttributes()}}}),this.id=Et++,this.code=t,this.usedTimes=1,this.program=b,this.vertexShader=w,this.fragmentShader=T,this}function WebGLPrograms(e,t){function allocateBones(e){if(t.floatVertexTextures&&e&&e.skeleton&&e.skeleton.useVertexTexture)return 1024;var r=t.maxVertexUniforms,i=Math.floor((r-20)/4);return void 0!==e&&e&&e.isSkinnedMesh&&(i=Math.min(e.skeleton.bones.length,i))<e.skeleton.bones.length&&console.warn("WebGLRenderer: too many bones - "+e.skeleton.bones.length+", this GPU supports just "+i+" (try OpenGL instead of ANGLE)"),i}function getTextureEncodingFromMap(e,t){var r;return e?e&&e.isTexture?r=e.encoding:e&&e.isWebGLRenderTarget&&(console.warn("THREE.WebGLPrograms.getTextureEncodingFromMap: don't use render targets as textures. Use their .texture property instead."),r=e.texture.encoding):r=rt,r===rt&&t&&(r=nt),r}var r=[],i={MeshDepthMaterial:"depth",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points"},n=["precision","supportsVertexTextures","map","mapEncoding","envMap","envMapMode","envMapEncoding","lightMap","aoMap","emissiveMap","emissiveMapEncoding","bumpMap","normalMap","displacementMap","specularMap","roughnessMap","metalnessMap","alphaMap","combine","vertexColors","fog","useFog","fogExp","flatShading","sizeAttenuation","logarithmicDepthBuffer","skinning","maxBones","useVertexTexture","morphTargets","morphNormals","maxMorphTargets","maxMorphNormals","premultipliedAlpha","numDirLights","numPointLights","numSpotLights","numHemiLights","shadowMapEnabled","shadowMapType","toneMapping","physicallyCorrectLights","alphaTest","doubleSided","flipSided","numClippingPlanes","numClipIntersection","depthPacking"];this.getParameters=function(r,n,a,o,s,c){var l=i[r.type],p=allocateBones(c),f=e.getPrecision();null!==r.precision&&(f=t.getMaxPrecision(r.precision))!==r.precision&&console.warn("THREE.WebGLProgram.getParameters:",r.precision,"not supported, using",f,"instead.");var m=e.getCurrentRenderTarget();return{shaderID:l,precision:f,supportsVertexTextures:t.vertexTextures,outputEncoding:getTextureEncodingFromMap(m?m.texture:null,e.gammaOutput),map:!!r.map,mapEncoding:getTextureEncodingFromMap(r.map,e.gammaInput),envMap:!!r.envMap,envMapMode:r.envMap&&r.envMap.mapping,envMapEncoding:getTextureEncodingFromMap(r.envMap,e.gammaInput),envMapCubeUV:!!r.envMap&&(r.envMap.mapping===ce||r.envMap.mapping===le),lightMap:!!r.lightMap,aoMap:!!r.aoMap,emissiveMap:!!r.emissiveMap,emissiveMapEncoding:getTextureEncodingFromMap(r.emissiveMap,e.gammaInput),bumpMap:!!r.bumpMap,normalMap:!!r.normalMap,displacementMap:!!r.displacementMap,roughnessMap:!!r.roughnessMap,metalnessMap:!!r.metalnessMap,specularMap:!!r.specularMap,alphaMap:!!r.alphaMap,combine:r.combine,vertexColors:r.vertexColors,fog:!!a,useFog:r.fog,fogExp:a&&a.isFogExp2,flatShading:r.shading===d,sizeAttenuation:r.sizeAttenuation,logarithmicDepthBuffer:t.logarithmicDepthBuffer,skinning:r.skinning,maxBones:p,useVertexTexture:t.floatVertexTextures&&c&&c.skeleton&&c.skeleton.useVertexTexture,morphTargets:r.morphTargets,morphNormals:r.morphNormals,maxMorphTargets:e.maxMorphTargets,maxMorphNormals:e.maxMorphNormals,numDirLights:n.directional.length,numPointLights:n.point.length,numSpotLights:n.spot.length,numHemiLights:n.hemi.length,numClippingPlanes:o,numClipIntersection:s,shadowMapEnabled:e.shadowMap.enabled&&c.receiveShadow&&n.shadows.length>0,shadowMapType:e.shadowMap.type,toneMapping:e.toneMapping,physicallyCorrectLights:e.physicallyCorrectLights,premultipliedAlpha:r.premultipliedAlpha,alphaTest:r.alphaTest,doubleSided:r.side===u,flipSided:r.side===h,depthPacking:void 0!==r.depthPacking&&r.depthPacking}},this.getProgramCode=function(e,t){var r=[];if(t.shaderID?r.push(t.shaderID):(r.push(e.fragmentShader),r.push(e.vertexShader)),void 0!==e.defines)for(var i in e.defines)r.push(i),r.push(e.defines[i]);for(var a=0;a<n.length;a++)r.push(t[n[a]]);return r.join()},this.acquireProgram=function(t,i,n){for(var a,o=0,s=r.length;o<s;o++){var c=r[o];if(c.code===n){++(a=c).usedTimes;break}}return void 0===a&&(a=new WebGLProgram(e,n,t,i),r.push(a)),a},this.releaseProgram=function(e){if(0==--e.usedTimes){var t=r.indexOf(e);r[t]=r[r.length-1],r.pop(),e.destroy()}},this.programs=r}function WebGLGeometries(e,t,r){function onGeometryDispose(e){var n=e.target,a=i[n.id];null!==a.index&&deleteAttribute(a.index),deleteAttributes(a.attributes),n.removeEventListener("dispose",onGeometryDispose),delete i[n.id];var o=t.get(n);o.wireframe&&deleteAttribute(o.wireframe),t.delete(n);var s=t.get(a);s.wireframe&&deleteAttribute(s.wireframe),t.delete(a),r.memory.geometries--}function getAttributeBuffer(e){return e.isInterleavedBufferAttribute?t.get(e.data).__webglBuffer:t.get(e).__webglBuffer}function deleteAttribute(t){var r=getAttributeBuffer(t);void 0!==r&&(e.deleteBuffer(r),removeAttributeBuffer(t))}function deleteAttributes(e){for(var t in e)deleteAttribute(e[t])}function removeAttributeBuffer(e){e.isInterleavedBufferAttribute?t.delete(e.data):t.delete(e)}var i={};return{get:function(e){var t=e.geometry;if(void 0!==i[t.id])return i[t.id];t.addEventListener("dispose",onGeometryDispose);var n;return t.isBufferGeometry?n=t:t.isGeometry&&(void 0===t._bufferGeometry&&(t._bufferGeometry=(new BufferGeometry).setFromObject(e)),n=t._bufferGeometry),i[t.id]=n,r.memory.geometries++,n}}}function WebGLObjects(e,t,r){function updateAttribute(e,r){var i=e.isInterleavedBufferAttribute?e.data:e,n=t.get(i);void 0===n.__webglBuffer?createBuffer(n,i,r):n.version!==i.version&&updateBuffer(n,i,r)}function createBuffer(t,r,i){t.__webglBuffer=e.createBuffer(),e.bindBuffer(i,t.__webglBuffer);var n=r.dynamic?e.DYNAMIC_DRAW:e.STATIC_DRAW;e.bufferData(i,r.array,n),t.version=r.version}function updateBuffer(t,r,i){e.bindBuffer(i,t.__webglBuffer),!1===r.dynamic?e.bufferData(i,r.array,e.STATIC_DRAW):-1===r.updateRange.count?e.bufferSubData(i,0,r.array):0===r.updateRange.count?console.error("THREE.WebGLObjects.updateBuffer: dynamic THREE.BufferAttribute marked as needsUpdate but updateRange.count is 0, ensure you are using set methods or updating manually."):(e.bufferSubData(i,r.updateRange.offset*r.array.BYTES_PER_ELEMENT,r.array.subarray(r.updateRange.offset,r.updateRange.offset+r.updateRange.count)),r.updateRange.count=0),t.version=r.version}var i=new WebGLGeometries(e,t,r);return{getAttributeBuffer:function getAttributeBuffer(e){return e.isInterleavedBufferAttribute?t.get(e.data).__webglBuffer:t.get(e).__webglBuffer},getWireframeAttribute:function getWireframeAttribute(r){var i=t.get(r);if(void 0!==i.wireframe)return i.wireframe;var n=[],a=r.index,o=r.attributes,s=o.position;if(null!==a)for(var c=0,l=(p=a.array).length;c<l;c+=3){var h=p[c+0],u=p[c+1],d=p[c+2];n.push(h,u,u,d,d,h)}else for(var p=o.position.array,c=0,l=p.length/3-1;c<l;c+=3){var h=c+0,u=c+1,d=c+2;n.push(h,u,u,d,d,h)}var f=new BufferAttribute(new(s.count>65535?Uint32Array:Uint16Array)(n),1);return updateAttribute(f,e.ELEMENT_ARRAY_BUFFER),i.wireframe=f,f},update:function update(t){var r=i.get(t);t.geometry.isGeometry&&r.updateFromObject(t);var n=r.index,a=r.attributes;null!==n&&updateAttribute(n,e.ELEMENT_ARRAY_BUFFER);for(var o in a)updateAttribute(a[o],e.ARRAY_BUFFER);var s=r.morphAttributes;for(var o in s)for(var c=s[o],l=0,h=c.length;l<h;l++)updateAttribute(c[l],e.ARRAY_BUFFER);return r}}}function WebGLTextures(e,t,r,i,n,a,o){function clampToMaxSize(e,t){if(e.width>t||e.height>t){var r=t/Math.max(e.width,e.height),i=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");return i.width=Math.floor(e.width*r),i.height=Math.floor(e.height*r),i.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,i.width,i.height),console.warn("THREE.WebGLRenderer: image is too big ("+e.width+"x"+e.height+"). Resized to "+i.width+"x"+i.height,e),i}return e}function isPowerOfTwo(e){return ut.isPowerOfTwo(e.width)&&ut.isPowerOfTwo(e.height)}function makePowerOfTwo(e){if(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement){var t=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");return t.width=ut.nearestPowerOfTwo(e.width),t.height=ut.nearestPowerOfTwo(e.height),t.getContext("2d").drawImage(e,0,0,t.width,t.height),console.warn("THREE.WebGLRenderer: image is not power of two ("+e.width+"x"+e.height+"). Resized to "+t.width+"x"+t.height,e),t}return e}function textureNeedsPowerOfTwo(e){return e.wrapS!==de||e.wrapT!==de||e.minFilter!==me&&e.minFilter!==ye}function filterFallback(t){return t===me||t===ge||t===ve?e.NEAREST:e.LINEAR}function onTextureDispose(e){var t=e.target;t.removeEventListener("dispose",onTextureDispose),deallocateTexture(t),s.textures--}function onRenderTargetDispose(e){var t=e.target;t.removeEventListener("dispose",onRenderTargetDispose),deallocateRenderTarget(t),s.textures--}function deallocateTexture(t){var r=i.get(t);if(t.image&&r.__image__webglTextureCube)e.deleteTexture(r.__image__webglTextureCube);else{if(void 0===r.__webglInit)return;e.deleteTexture(r.__webglTexture)}i.delete(t)}function deallocateRenderTarget(t){var r=i.get(t),n=i.get(t.texture);if(t){if(void 0!==n.__webglTexture&&e.deleteTexture(n.__webglTexture),t.depthTexture&&t.depthTexture.dispose(),t&&t.isWebGLRenderTargetCube)for(var a=0;a<6;a++)e.deleteFramebuffer(r.__webglFramebuffer[a]),r.__webglDepthbuffer&&e.deleteRenderbuffer(r.__webglDepthbuffer[a]);else e.deleteFramebuffer(r.__webglFramebuffer),r.__webglDepthbuffer&&e.deleteRenderbuffer(r.__webglDepthbuffer);i.delete(t.texture),i.delete(t)}}function setTexture2D(t,n){var a=i.get(t);if(t.version>0&&a.__version!==t.version){var o=t.image;if(void 0===o)console.warn("THREE.WebGLRenderer: Texture marked for update but image is undefined",t);else{if(!1!==o.complete)return void uploadTexture(a,t,n);console.warn("THREE.WebGLRenderer: Texture marked for update but image is incomplete",t)}}r.activeTexture(e.TEXTURE0+n),r.bindTexture(e.TEXTURE_2D,a.__webglTexture)}function setTextureParameters(r,o,s){var c;if(s?(e.texParameteri(r,e.TEXTURE_WRAP_S,a(o.wrapS)),e.texParameteri(r,e.TEXTURE_WRAP_T,a(o.wrapT)),e.texParameteri(r,e.TEXTURE_MAG_FILTER,a(o.magFilter)),e.texParameteri(r,e.TEXTURE_MIN_FILTER,a(o.minFilter))):(e.texParameteri(r,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(r,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),o.wrapS===de&&o.wrapT===de||console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.wrapS and Texture.wrapT should be set to THREE.ClampToEdgeWrapping.",o),e.texParameteri(r,e.TEXTURE_MAG_FILTER,filterFallback(o.magFilter)),e.texParameteri(r,e.TEXTURE_MIN_FILTER,filterFallback(o.minFilter)),o.minFilter!==me&&o.minFilter!==ye&&console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.minFilter should be set to THREE.NearestFilter or THREE.LinearFilter.",o)),c=t.get("EXT_texture_filter_anisotropic")){if(o.type===Le&&null===t.get("OES_texture_float_linear"))return;if(o.type===Pe&&null===t.get("OES_texture_half_float_linear"))return;(o.anisotropy>1||i.get(o).__currentAnisotropy)&&(e.texParameterf(r,c.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(o.anisotropy,n.getMaxAnisotropy())),i.get(o).__currentAnisotropy=o.anisotropy)}}function uploadTexture(t,i,o){void 0===t.__webglInit&&(t.__webglInit=!0,i.addEventListener("dispose",onTextureDispose),t.__webglTexture=e.createTexture(),s.textures++),r.activeTexture(e.TEXTURE0+o),r.bindTexture(e.TEXTURE_2D,t.__webglTexture),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,i.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,i.premultiplyAlpha),e.pixelStorei(e.UNPACK_ALIGNMENT,i.unpackAlignment);var l=clampToMaxSize(i.image,n.maxTextureSize);textureNeedsPowerOfTwo(i)&&!1===isPowerOfTwo(l)&&(l=makePowerOfTwo(l));var h=isPowerOfTwo(l),u=a(i.format),d=a(i.type);setTextureParameters(e.TEXTURE_2D,i,h);var p,f=i.mipmaps;if(i&&i.isDepthTexture){var m=e.DEPTH_COMPONENT;if(i.type===Le){if(!c)throw new Error("Float Depth Texture only supported in WebGL2.0");m=e.DEPTH_COMPONENT32F}else c&&(m=e.DEPTH_COMPONENT16);i.format===ze&&(m=e.DEPTH_STENCIL),r.texImage2D(e.TEXTURE_2D,0,m,l.width,l.height,0,u,d,null)}else if(i&&i.isDataTexture)if(f.length>0&&h){for(var g=0,v=f.length;g<v;g++)p=f[g],r.texImage2D(e.TEXTURE_2D,g,u,p.width,p.height,0,u,d,p.data);i.generateMipmaps=!1}else r.texImage2D(e.TEXTURE_2D,0,u,l.width,l.height,0,u,d,l.data);else if(i&&i.isCompressedTexture)for(var g=0,v=f.length;g<v;g++)p=f[g],i.format!==Ue&&i.format!==De?r.getCompressedTextureFormats().indexOf(u)>-1?r.compressedTexImage2D(e.TEXTURE_2D,g,u,p.width,p.height,0,p.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):r.texImage2D(e.TEXTURE_2D,g,u,p.width,p.height,0,u,d,p.data);else if(f.length>0&&h){for(var g=0,v=f.length;g<v;g++)p=f[g],r.texImage2D(e.TEXTURE_2D,g,u,u,d,p);i.generateMipmaps=!1}else r.texImage2D(e.TEXTURE_2D,0,u,u,d,l);i.generateMipmaps&&h&&e.generateMipmap(e.TEXTURE_2D),t.__version=i.version,i.onUpdate&&i.onUpdate(i)}function setupFrameBufferTexture(t,n,o,s){var c=a(n.texture.format),l=a(n.texture.type);r.texImage2D(s,0,c,n.width,n.height,0,c,l,null),e.bindFramebuffer(e.FRAMEBUFFER,t),e.framebufferTexture2D(e.FRAMEBUFFER,o,s,i.get(n.texture).__webglTexture,0),e.bindFramebuffer(e.FRAMEBUFFER,null)}function setupRenderBufferStorage(t,r){e.bindRenderbuffer(e.RENDERBUFFER,t),r.depthBuffer&&!r.stencilBuffer?(e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,r.width,r.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,t)):r.depthBuffer&&r.stencilBuffer?(e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_STENCIL,r.width,r.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.RENDERBUFFER,t)):e.renderbufferStorage(e.RENDERBUFFER,e.RGBA4,r.width,r.height),e.bindRenderbuffer(e.RENDERBUFFER,null)}function setupDepthTexture(t,r){if(r&&r.isWebGLRenderTargetCube)throw new Error("Depth Texture with cube render targets is not supported!");if(e.bindFramebuffer(e.FRAMEBUFFER,t),!r.depthTexture||!r.depthTexture.isDepthTexture)throw new Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");i.get(r.depthTexture).__webglTexture&&r.depthTexture.image.width===r.width&&r.depthTexture.image.height===r.height||(r.depthTexture.image.width=r.width,r.depthTexture.image.height=r.height,r.depthTexture.needsUpdate=!0),setTexture2D(r.depthTexture,0);var n=i.get(r.depthTexture).__webglTexture;if(r.depthTexture.format===Ne)e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,n,0);else{if(r.depthTexture.format!==ze)throw new Error("Unknown depthTexture format");e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.TEXTURE_2D,n,0)}}function setupDepthRenderbuffer(t){var r=i.get(t),n=t&&t.isWebGLRenderTargetCube;if(t.depthTexture){if(n)throw new Error("target.depthTexture not supported in Cube render targets");setupDepthTexture(r.__webglFramebuffer,t)}else if(n){r.__webglDepthbuffer=[];for(var a=0;a<6;a++)e.bindFramebuffer(e.FRAMEBUFFER,r.__webglFramebuffer[a]),r.__webglDepthbuffer[a]=e.createRenderbuffer(),setupRenderBufferStorage(r.__webglDepthbuffer[a],t)}else e.bindFramebuffer(e.FRAMEBUFFER,r.__webglFramebuffer),r.__webglDepthbuffer=e.createRenderbuffer(),setupRenderBufferStorage(r.__webglDepthbuffer,t);e.bindFramebuffer(e.FRAMEBUFFER,null)}var s=o.memory,c="undefined"!=typeof WebGL2RenderingContext&&e instanceof WebGL2RenderingContext;this.setTexture2D=setTexture2D,this.setTextureCube=function setTextureCube(t,o){var c=i.get(t);if(6===t.image.length)if(t.version>0&&c.__version!==t.version){c.__image__webglTextureCube||(t.addEventListener("dispose",onTextureDispose),c.__image__webglTextureCube=e.createTexture(),s.textures++),r.activeTexture(e.TEXTURE0+o),r.bindTexture(e.TEXTURE_CUBE_MAP,c.__image__webglTextureCube),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,t.flipY);for(var l=t&&t.isCompressedTexture,h=t.image[0]&&t.image[0].isDataTexture,u=[],d=0;d<6;d++)u[d]=l||h?h?t.image[d].image:t.image[d]:clampToMaxSize(t.image[d],n.maxCubemapSize);var p=isPowerOfTwo(u[0]),f=a(t.format),m=a(t.type);for(setTextureParameters(e.TEXTURE_CUBE_MAP,t,p),d=0;d<6;d++)if(l)for(var g,v=u[d].mipmaps,y=0,x=v.length;y<x;y++)g=v[y],t.format!==Ue&&t.format!==De?r.getCompressedTextureFormats().indexOf(f)>-1?r.compressedTexImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+d,y,f,g.width,g.height,0,g.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .setTextureCube()"):r.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+d,y,f,g.width,g.height,0,f,m,g.data);else h?r.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+d,0,f,u[d].width,u[d].height,0,f,m,u[d].data):r.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+d,0,f,f,m,u[d]);t.generateMipmaps&&p&&e.generateMipmap(e.TEXTURE_CUBE_MAP),c.__version=t.version,t.onUpdate&&t.onUpdate(t)}else r.activeTexture(e.TEXTURE0+o),r.bindTexture(e.TEXTURE_CUBE_MAP,c.__image__webglTextureCube)},this.setTextureCubeDynamic=function setTextureCubeDynamic(t,n){r.activeTexture(e.TEXTURE0+n),r.bindTexture(e.TEXTURE_CUBE_MAP,i.get(t).__webglTexture)},this.setupRenderTarget=function setupRenderTarget(t){var n=i.get(t),a=i.get(t.texture);t.addEventListener("dispose",onRenderTargetDispose),a.__webglTexture=e.createTexture(),s.textures++;var o=t&&t.isWebGLRenderTargetCube,c=isPowerOfTwo(t);if(o)for(n.__webglFramebuffer=[],l=0;l<6;l++)n.__webglFramebuffer[l]=e.createFramebuffer();else n.__webglFramebuffer=e.createFramebuffer();if(o){r.bindTexture(e.TEXTURE_CUBE_MAP,a.__webglTexture),setTextureParameters(e.TEXTURE_CUBE_MAP,t.texture,c);for(var l=0;l<6;l++)setupFrameBufferTexture(n.__webglFramebuffer[l],t,e.COLOR_ATTACHMENT0,e.TEXTURE_CUBE_MAP_POSITIVE_X+l);t.texture.generateMipmaps&&c&&e.generateMipmap(e.TEXTURE_CUBE_MAP),r.bindTexture(e.TEXTURE_CUBE_MAP,null)}else r.bindTexture(e.TEXTURE_2D,a.__webglTexture),setTextureParameters(e.TEXTURE_2D,t.texture,c),setupFrameBufferTexture(n.__webglFramebuffer,t,e.COLOR_ATTACHMENT0,e.TEXTURE_2D),t.texture.generateMipmaps&&c&&e.generateMipmap(e.TEXTURE_2D),r.bindTexture(e.TEXTURE_2D,null);t.depthBuffer&&setupDepthRenderbuffer(t)},this.updateRenderTargetMipmap=function updateRenderTargetMipmap(t){var n=t.texture;if(n.generateMipmaps&&isPowerOfTwo(t)&&n.minFilter!==me&&n.minFilter!==ye){var a=t&&t.isWebGLRenderTargetCube?e.TEXTURE_CUBE_MAP:e.TEXTURE_2D,o=i.get(n).__webglTexture;r.bindTexture(a,o),e.generateMipmap(a),r.bindTexture(a,null)}}}function WebGLProperties(){var e={};return{get:function(t){var r=t.uuid,i=e[r];return void 0===i&&(i={},e[r]=i),i},delete:function(t){delete e[t.uuid]},clear:function(){e={}}}}function WebGLState(e,t,r){function createTexture(t,r,i){var n=new Uint8Array(4),a=e.createTexture();e.bindTexture(t,a),e.texParameteri(t,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(t,e.TEXTURE_MAG_FILTER,e.NEAREST);for(var o=0;o<i;o++)e.texImage2D(r+o,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,n);return a}function enable(t){!0!==p[t]&&(e.enable(t),p[t]=!0)}function disable(t){!1!==p[t]&&(e.disable(t),p[t]=!1)}function setBlending(t,i,n,a,o,s,c,l){t!==y?enable(e.BLEND):disable(e.BLEND),t===m&&l===L||(t===b?l?(e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ONE,e.ONE,e.ONE)):(e.blendEquation(e.FUNC_ADD),e.blendFunc(e.SRC_ALPHA,e.ONE)):t===_?l?(e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ZERO,e.ZERO,e.ONE_MINUS_SRC_COLOR,e.ONE_MINUS_SRC_ALPHA)):(e.blendEquation(e.FUNC_ADD),e.blendFunc(e.ZERO,e.ONE_MINUS_SRC_COLOR)):t===M?l?(e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ZERO,e.SRC_COLOR,e.ZERO,e.SRC_ALPHA)):(e.blendEquation(e.FUNC_ADD),e.blendFunc(e.ZERO,e.SRC_COLOR)):l?(e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA)):(e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA)),m=t,L=l),t===w?(o=o||i,s=s||n,c=c||a,i===g&&o===S||(e.blendEquationSeparate(r(i),r(o)),g=i,S=o),n===v&&a===T&&s===E&&c===A||(e.blendFuncSeparate(r(n),r(a),r(s),r(c)),v=n,T=a,E=s,A=c)):(g=null,v=null,T=null,S=null,E=null,A=null)}function setDepthFunc(e){s.setFunc(e)}function setFlipSided(t){P!==t&&(t?e.frontFace(e.CW):e.frontFace(e.CCW),P=t)}function setCullFace(t){t!==i?(enable(e.CULL_FACE),t!==C&&(t===n?e.cullFace(e.BACK):t===a?e.cullFace(e.FRONT):e.cullFace(e.FRONT_AND_BACK))):disable(e.CULL_FACE),C=t}function activeTexture(t){void 0===t&&(t=e.TEXTURE0+D-1),U!==t&&(e.activeTexture(t),U=t)}function clearColor(e,t,r,i){o.setClear(e,t,r,i)}function clearDepth(e){s.setClear(e)}function clearStencil(e){c.setClear(e)}var o=new function ColorBuffer(){var t=!1,r=new Vector4,i=null,n=new Vector4;return{setMask:function(r){i===r||t||(e.colorMask(r,r,r,r),i=r)},setLocked:function(e){t=e},setClear:function(t,i,a,o){r.set(t,i,a,o),!1===n.equals(r)&&(e.clearColor(t,i,a,o),n.copy(r))},reset:function(){t=!1,i=null,n.set(0,0,0,1)}}},s=new function DepthBuffer(){var t=!1,r=null,i=null,n=null;return{setTest:function(t){t?enable(e.DEPTH_TEST):disable(e.DEPTH_TEST)},setMask:function(i){r===i||t||(e.depthMask(i),r=i)},setFunc:function(t){if(i!==t){if(t)switch(t){case z:e.depthFunc(e.NEVER);break;case H:e.depthFunc(e.ALWAYS);break;case k:e.depthFunc(e.LESS);break;case j:e.depthFunc(e.LEQUAL);break;case W:e.depthFunc(e.EQUAL);break;case X:e.depthFunc(e.GEQUAL);break;case Y:e.depthFunc(e.GREATER);break;case q:e.depthFunc(e.NOTEQUAL);break;default:e.depthFunc(e.LEQUAL)}else e.depthFunc(e.LEQUAL);i=t}},setLocked:function(e){t=e},setClear:function(t){n!==t&&(e.clearDepth(t),n=t)},reset:function(){t=!1,r=null,i=null,n=null}}},c=new function StencilBuffer(){var t=!1,r=null,i=null,n=null,a=null,o=null,s=null,c=null,l=null;return{setTest:function(t){t?enable(e.STENCIL_TEST):disable(e.STENCIL_TEST)},setMask:function(i){r===i||t||(e.stencilMask(i),r=i)},setFunc:function(t,r,o){i===t&&n===r&&a===o||(e.stencilFunc(t,r,o),i=t,n=r,a=o)},setOp:function(t,r,i){o===t&&s===r&&c===i||(e.stencilOp(t,r,i),o=t,s=r,c=i)},setLocked:function(e){t=e},setClear:function(t){l!==t&&(e.clearStencil(t),l=t)},reset:function(){t=!1,r=null,i=null,n=null,a=null,o=null,s=null,c=null,l=null}}},l=e.getParameter(e.MAX_VERTEX_ATTRIBS),h=new Uint8Array(l),u=new Uint8Array(l),d=new Uint8Array(l),p={},f=null,m=null,g=null,v=null,T=null,S=null,E=null,A=null,L=!1,P=null,C=null,R=null,B=null,I=null,G=null,D=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),U=null,O={},F=new Vector4,V=new Vector4,N={};return N[e.TEXTURE_2D]=createTexture(e.TEXTURE_2D,e.TEXTURE_2D,1),N[e.TEXTURE_CUBE_MAP]=createTexture(e.TEXTURE_CUBE_MAP,e.TEXTURE_CUBE_MAP_POSITIVE_X,6),{buffers:{color:o,depth:s,stencil:c},init:function init(){clearColor(0,0,0,1),clearDepth(1),clearStencil(0),enable(e.DEPTH_TEST),setDepthFunc(j),setFlipSided(!1),setCullFace(n),enable(e.CULL_FACE),enable(e.BLEND),setBlending(x)},initAttributes:function initAttributes(){for(var e=0,t=h.length;e<t;e++)h[e]=0},enableAttribute:function enableAttribute(r){h[r]=1,0===u[r]&&(e.enableVertexAttribArray(r),u[r]=1),0!==d[r]&&(t.get("ANGLE_instanced_arrays").vertexAttribDivisorANGLE(r,0),d[r]=0)},enableAttributeAndDivisor:function enableAttributeAndDivisor(t,r,i){h[t]=1,0===u[t]&&(e.enableVertexAttribArray(t),u[t]=1),d[t]!==r&&(i.vertexAttribDivisorANGLE(t,r),d[t]=r)},disableUnusedAttributes:function disableUnusedAttributes(){for(var t=0,r=u.length;t!==r;++t)u[t]!==h[t]&&(e.disableVertexAttribArray(t),u[t]=0)},enable:enable,disable:disable,getCompressedTextureFormats:function getCompressedTextureFormats(){if(null===f&&(f=[],t.get("WEBGL_compressed_texture_pvrtc")||t.get("WEBGL_compressed_texture_s3tc")||t.get("WEBGL_compressed_texture_etc1")))for(var r=e.getParameter(e.COMPRESSED_TEXTURE_FORMATS),i=0;i<r.length;i++)f.push(r[i]);return f},setBlending:setBlending,setColorWrite:function setColorWrite(e){o.setMask(e)},setDepthTest:function setDepthTest(e){s.setTest(e)},setDepthWrite:function setDepthWrite(e){s.setMask(e)},setDepthFunc:setDepthFunc,setStencilTest:function setStencilTest(e){c.setTest(e)},setStencilWrite:function setStencilWrite(e){c.setMask(e)},setStencilFunc:function setStencilFunc(e,t,r){c.setFunc(e,t,r)},setStencilOp:function setStencilOp(e,t,r){c.setOp(e,t,r)},setFlipSided:setFlipSided,setCullFace:setCullFace,setLineWidth:function setLineWidth(t){t!==R&&(e.lineWidth(t),R=t)},setPolygonOffset:function setPolygonOffset(t,r,i){t?(enable(e.POLYGON_OFFSET_FILL),B===r&&I===i||(e.polygonOffset(r,i),B=r,I=i)):disable(e.POLYGON_OFFSET_FILL)},getScissorTest:function getScissorTest(){return G},setScissorTest:function setScissorTest(t){G=t,t?enable(e.SCISSOR_TEST):disable(e.SCISSOR_TEST)},activeTexture:activeTexture,bindTexture:function bindTexture(t,r){null===U&&activeTexture();var i=O[U];void 0===i&&(i={type:void 0,texture:void 0},O[U]=i),i.type===t&&i.texture===r||(e.bindTexture(t,r||N[t]),i.type=t,i.texture=r)},compressedTexImage2D:function compressedTexImage2D(){try{e.compressedTexImage2D.apply(e,arguments)}catch(e){console.error(e)}},texImage2D:function texImage2D(){try{e.texImage2D.apply(e,arguments)}catch(e){console.error(e)}},clearColor:clearColor,clearDepth:clearDepth,clearStencil:clearStencil,scissor:function scissor(t){!1===F.equals(t)&&(e.scissor(t.x,t.y,t.z,t.w),F.copy(t))},viewport:function viewport(t){!1===V.equals(t)&&(e.viewport(t.x,t.y,t.z,t.w),V.copy(t))},reset:function reset(){for(var t=0;t<u.length;t++)1===u[t]&&(e.disableVertexAttribArray(t),u[t]=0);p={},f=null,U=null,O={},m=null,P=null,C=null,o.reset(),s.reset(),c.reset()}}}function WebGLCapabilities(e,t,r){function getMaxPrecision(t){if("highp"===t){if(e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.HIGH_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT).precision>0)return"highp";t="mediump"}return"mediump"===t&&e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.MEDIUM_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT).precision>0?"mediump":"lowp"}var i,n=void 0!==r.precision?r.precision:"highp",a=getMaxPrecision(n);a!==n&&(console.warn("THREE.WebGLRenderer:",n,"not supported, using",a,"instead."),n=a);var o=!0===r.logarithmicDepthBuffer&&!!t.get("EXT_frag_depth"),s=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),c=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),l=e.getParameter(e.MAX_TEXTURE_SIZE),h=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),u=e.getParameter(e.MAX_VERTEX_ATTRIBS),d=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),p=e.getParameter(e.MAX_VARYING_VECTORS),f=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),m=c>0,g=!!t.get("OES_texture_float");return{getMaxAnisotropy:function getMaxAnisotropy(){if(void 0!==i)return i;var r=t.get("EXT_texture_filter_anisotropic");return i=null!==r?e.getParameter(r.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0},getMaxPrecision:getMaxPrecision,precision:n,logarithmicDepthBuffer:o,maxTextures:s,maxVertexTextures:c,maxTextureSize:l,maxCubemapSize:h,maxAttributes:u,maxVertexUniforms:d,maxVaryings:p,maxFragmentUniforms:f,vertexTextures:m,floatFragmentTextures:g,floatVertexTextures:m&&g}}function WebGLExtensions(e){var t={};return{get:function(r){if(void 0!==t[r])return t[r];var i;switch(r){case"WEBGL_depth_texture":i=e.getExtension("WEBGL_depth_texture")||e.getExtension("MOZ_WEBGL_depth_texture")||e.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":i=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":i=e.getExtension("WEBGL_compressed_texture_s3tc")||e.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":i=e.getExtension("WEBGL_compressed_texture_pvrtc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;case"WEBGL_compressed_texture_etc1":i=e.getExtension("WEBGL_compressed_texture_etc1");break;default:i=e.getExtension(r)}return null===i&&console.warn("THREE.WebGLRenderer: "+r+" extension not supported."),t[r]=i,i}}}function WebGLClipping(){function resetGlobalState(){s.value!==t&&(s.value=t,s.needsUpdate=r>0),e.numPlanes=r,e.numIntersection=0}function projectPlanes(t,r,i,n){var c=null!==t?t.length:0,l=null;if(0!==c){if(l=s.value,!0!==n||null===l){var h=i+4*c,u=r.matrixWorldInverse;o.getNormalMatrix(u),(null===l||l.length<h)&&(l=new Float32Array(h));for(var d=0,p=i;d!==c;++d,p+=4)a.copy(t[d]).applyMatrix4(u,o),a.normal.toArray(l,p),l[p+3]=a.constant}s.value=l,s.needsUpdate=!0}return e.numPlanes=c,l}var e=this,t=null,r=0,i=!1,n=!1,a=new Plane,o=new Matrix3,s={value:null,needsUpdate:!1};this.uniform=s,this.numPlanes=0,this.numIntersection=0,this.init=function(e,n,a){var o=0!==e.length||n||0!==r||i;return i=n,t=projectPlanes(e,a,0),r=e.length,o},this.beginShadows=function(){n=!0,projectPlanes(null)},this.endShadows=function(){n=!1,resetGlobalState()},this.setState=function(e,a,o,c,l,h){if(!i||null===e||0===e.length||n&&!o)n?projectPlanes(null):resetGlobalState();else{var u=n?0:r,d=4*u,p=l.clippingState||null;s.value=p,p=projectPlanes(e,c,d,h);for(var f=0;f!==d;++f)p[f]=t[f];l.clippingState=p,this.numIntersection=a?this.numPlanes:0,this.numPlanes+=u}}}function WebGLRenderer(e){function getTargetPixelRatio(){return null===H?re:1}function glClearColor(e,t,r,i){!0===l&&(e*=i,t*=i,r*=i),at.clearColor(e,t,r,i)}function setDefaultGLState(){at.init(),at.scissor(Y.copy(ie).multiplyScalar(re)),at.viewport(Z.copy(ae).multiplyScalar(re)),glClearColor(Q.r,Q.g,Q.b,J)}function resetGLState(){z=null,X=null,W="",j=-1,at.reset()}function onContextLost(e){e.preventDefault(),resetGLState(),setDefaultGLState(),ot.clear()}function onMaterialDispose(e){var t=e.target;t.removeEventListener("dispose",onMaterialDispose),deallocateMaterial(t)}function deallocateMaterial(e){releaseMaterialProgramReference(e),ot.delete(e)}function releaseMaterialProgramReference(e){var t=ot.get(e).program;e.program=void 0,void 0!==t&&lt.releaseProgram(t)}function setupVertexAttributes(e,t,r,i){var n;if(r&&r.isInstancedBufferGeometry&&null===(n=it.get("ANGLE_instanced_arrays")))console.error("THREE.WebGLRenderer.setupVertexAttributes: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");else{void 0===i&&(i=0),at.initAttributes();var a=r.attributes,o=t.getAttributes(),s=e.defaultAttributeValues;for(var c in o){var l=o[c];if(l>=0){var h=a[c];if(void 0!==h){var u=Je.FLOAT,d=h.array,p=h.normalized;d instanceof Float32Array?u=Je.FLOAT:d instanceof Float64Array?console.warn("Unsupported data buffer format: Float64Array"):d instanceof Uint16Array?u=Je.UNSIGNED_SHORT:d instanceof Int16Array?u=Je.SHORT:d instanceof Uint32Array?u=Je.UNSIGNED_INT:d instanceof Int32Array?u=Je.INT:d instanceof Int8Array?u=Je.BYTE:d instanceof Uint8Array&&(u=Je.UNSIGNED_BYTE);var f=h.itemSize,m=ct.getAttributeBuffer(h);if(h.isInterleavedBufferAttribute){var g=h.data,v=g.stride,y=h.offset;g&&g.isInstancedInterleavedBuffer?(at.enableAttributeAndDivisor(l,g.meshPerAttribute,n),void 0===r.maxInstancedCount&&(r.maxInstancedCount=g.meshPerAttribute*g.count)):at.enableAttribute(l),Je.bindBuffer(Je.ARRAY_BUFFER,m),Je.vertexAttribPointer(l,f,u,p,v*g.array.BYTES_PER_ELEMENT,(i*v+y)*g.array.BYTES_PER_ELEMENT)}else h.isInstancedBufferAttribute?(at.enableAttributeAndDivisor(l,h.meshPerAttribute,n),void 0===r.maxInstancedCount&&(r.maxInstancedCount=h.meshPerAttribute*h.count)):at.enableAttribute(l),Je.bindBuffer(Je.ARRAY_BUFFER,m),Je.vertexAttribPointer(l,f,u,p,0,i*f*h.array.BYTES_PER_ELEMENT)}else if(void 0!==s){var x=s[c];if(void 0!==x)switch(x.length){case 2:Je.vertexAttrib2fv(l,x);break;case 3:Je.vertexAttrib3fv(l,x);break;case 4:Je.vertexAttrib4fv(l,x);break;default:Je.vertexAttrib1fv(l,x)}}}}at.disableUnusedAttributes()}}function absNumericalSort(e,t){return Math.abs(t[0])-Math.abs(e[0])}function painterSortStable(e,t){return e.object.renderOrder!==t.object.renderOrder?e.object.renderOrder-t.object.renderOrder:e.material.program&&t.material.program&&e.material.program!==t.material.program?e.material.program.id-t.material.program.id:e.material.id!==t.material.id?e.material.id-t.material.id:e.z!==t.z?e.z-t.z:e.id-t.id}function reversePainterSortStable(e,t){return e.object.renderOrder!==t.object.renderOrder?e.object.renderOrder-t.object.renderOrder:e.z!==t.z?t.z-e.z:e.id-t.id}function pushRenderItem(e,t,r,i,n){var a,o;r.transparent?(a=x,o=++b):(a=g,o=++v);var s=a[o];void 0!==s?(s.id=e.id,s.object=e,s.geometry=t,s.material=r,s.z=_e.z,s.group=n):(s={id:e.id,object:e,geometry:t,material:r,z:_e.z,group:n},a.push(s))}function isObjectViewable(e){var t=e.geometry;return null===t.boundingSphere&&t.computeBoundingSphere(),he.copy(t.boundingSphere).applyMatrix4(e.matrixWorld),isSphereViewable(he)}function isSpriteViewable(e){return he.center.set(0,0,0),he.radius=.7071067811865476,he.applyMatrix4(e.matrixWorld),isSphereViewable(he)}function isSphereViewable(e){if(!oe.intersectsSphere(e))return!1;var t=se.numPlanes;if(0===t)return!0;var r=T.clippingPlanes,i=e.center,n=-e.radius,a=0;do{if(r[a].distanceToPoint(i)<n)return!1}while(++a!==t);return!0}function projectObject(e,t){if(!1!==e.visible){if(0!=(e.layers.mask&t.layers.mask))if(e.isLight)m.push(e);else if(e.isSprite)!1!==e.frustumCulled&&!0!==isSpriteViewable(e)||M.push(e);else if(e.isLensFlare)w.push(e);else if(e.isImmediateRenderObject)!0===T.sortObjects&&(_e.setFromMatrixPosition(e.matrixWorld),_e.applyProjection(fe)),pushRenderItem(e,null,e.material,_e.z,null);else if((e.isMesh||e.isLine||e.isPoints)&&(e.isSkinnedMesh&&e.skeleton.update(),!1===e.frustumCulled||!0===isObjectViewable(e))){var r=e.material;if(!0===r.visible){!0===T.sortObjects&&(_e.setFromMatrixPosition(e.matrixWorld),_e.applyProjection(fe));var i=ct.update(e);if(r.isMultiMaterial)for(var n=i.groups,a=r.materials,o=0,s=n.length;o<s;o++){var c=n[o],l=a[c.materialIndex];!0===l.visible&&pushRenderItem(e,i,l,_e.z,c)}else pushRenderItem(e,i,r,_e.z,null)}}for(var h=e.children,o=0,s=h.length;o<s;o++)projectObject(h[o],t)}}function renderObjects(e,t,r,i){for(var n=0,a=e.length;n<a;n++){var o=e[n],s=o.object,c=o.geometry,l=void 0===i?o.material:i,h=o.group;if(s.modelViewMatrix.multiplyMatrices(r.matrixWorldInverse,s.matrixWorld),s.normalMatrix.getNormalMatrix(s.modelViewMatrix),s.onBeforeRender(T,t,r,c,l,h),s.isImmediateRenderObject){setMaterial(l);var u=setProgram(r,t.fog,l,s);W="",s.render(function(e){T.renderBufferImmediate(e,u,l)})}else T.renderBufferDirect(r,t.fog,c,l,s,h);s.onAfterRender(T,t,r,c,l,h)}}function initMaterial(e,t,r){var i=ot.get(e),n=lt.getParameters(e,Ve,t,se.numPlanes,se.numIntersection,r),a=lt.getProgramCode(e,n),o=i.program,s=!0;if(void 0===o)e.addEventListener("dispose",onMaterialDispose);else if(o.code!==a)releaseMaterialProgramReference(e);else{if(void 0!==n.shaderID)return;s=!1}if(s){if(n.shaderID){var c=Mt[n.shaderID];i.__webglShader={name:e.type,uniforms:yt.clone(c.uniforms),vertexShader:c.vertexShader,fragmentShader:c.fragmentShader}}else i.__webglShader={name:e.type,uniforms:e.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader};e.__webglShader=i.__webglShader,o=lt.acquireProgram(e,n,a),i.program=o,e.program=o}var l=o.getAttributes();if(e.morphTargets){e.numSupportedMorphTargets=0;for(h=0;h<T.maxMorphTargets;h++)l["morphTarget"+h]>=0&&e.numSupportedMorphTargets++}if(e.morphNormals){e.numSupportedMorphNormals=0;for(var h=0;h<T.maxMorphNormals;h++)l["morphNormal"+h]>=0&&e.numSupportedMorphNormals++}var u=i.__webglShader.uniforms;(e.isShaderMaterial||e.isRawShaderMaterial)&&!0!==e.clipping||(i.numClippingPlanes=se.numPlanes,i.numIntersection=se.numIntersection,u.clippingPlanes=se.uniform),i.fog=t,i.lightsHash=Ve.hash,e.lights&&(u.ambientLightColor.value=Ve.ambient,u.directionalLights.value=Ve.directional,u.spotLights.value=Ve.spot,u.pointLights.value=Ve.point,u.hemisphereLights.value=Ve.hemi,u.directionalShadowMap.value=Ve.directionalShadowMap,u.directionalShadowMatrix.value=Ve.directionalShadowMatrix,u.spotShadowMap.value=Ve.spotShadowMap,u.spotShadowMatrix.value=Ve.spotShadowMatrix,u.pointShadowMap.value=Ve.pointShadowMap,u.pointShadowMatrix.value=Ve.pointShadowMatrix);var d=i.program.getUniforms(),p=WebGLUniforms.seqWithValue(d.seq,u);i.uniformsList=p}function setMaterial(e){e.side===u?at.disable(Je.CULL_FACE):at.enable(Je.CULL_FACE),at.setFlipSided(e.side===h),!0===e.transparent?at.setBlending(e.blending,e.blendEquation,e.blendSrc,e.blendDst,e.blendEquationAlpha,e.blendSrcAlpha,e.blendDstAlpha,e.premultipliedAlpha):at.setBlending(y),at.setDepthFunc(e.depthFunc),at.setDepthTest(e.depthTest),at.setDepthWrite(e.depthWrite),at.setColorWrite(e.colorWrite),at.setPolygonOffset(e.polygonOffset,e.polygonOffsetFactor,e.polygonOffsetUnits)}function setProgram(e,t,r,i){K=0;var n=ot.get(r);if(ce&&(le||e!==X)){var a=e===X&&r.id===j;se.setState(r.clippingPlanes,r.clipIntersection,r.clipShadows,e,n,a)}!1===r.needsUpdate&&(void 0===n.program?r.needsUpdate=!0:r.fog&&n.fog!==t?r.needsUpdate=!0:r.lights&&n.lightsHash!==Ve.hash?r.needsUpdate=!0:void 0===n.numClippingPlanes||n.numClippingPlanes===se.numPlanes&&n.numIntersection===se.numIntersection||(r.needsUpdate=!0)),r.needsUpdate&&(initMaterial(r,t,i),r.needsUpdate=!1);var o=!1,s=!1,c=!1,l=n.program,h=l.getUniforms(),u=n.__webglShader.uniforms;if(l.id!==z&&(Je.useProgram(l.program),z=l.id,o=!0,s=!0,c=!0),r.id!==j&&(j=r.id,s=!0),o||e!==X){if(h.set(Je,e,"projectionMatrix"),nt.logarithmicDepthBuffer&&h.setValue(Je,"logDepthBufFC",2/(Math.log(e.far+1)/Math.LN2)),e!==X&&(X=e,s=!0,c=!0),r.isShaderMaterial||r.isMeshPhongMaterial||r.isMeshStandardMaterial||r.envMap){var d=h.map.cameraPosition;void 0!==d&&d.setValue(Je,_e.setFromMatrixPosition(e.matrixWorld))}(r.isMeshPhongMaterial||r.isMeshLambertMaterial||r.isMeshBasicMaterial||r.isMeshStandardMaterial||r.isShaderMaterial||r.skinning)&&h.setValue(Je,"viewMatrix",e.matrixWorldInverse),h.set(Je,T,"toneMappingExposure"),h.set(Je,T,"toneMappingWhitePoint")}if(r.skinning){h.setOptional(Je,i,"bindMatrix"),h.setOptional(Je,i,"bindMatrixInverse");var p=i.skeleton;p&&(nt.floatVertexTextures&&p.useVertexTexture?(h.set(Je,p,"boneTexture"),h.set(Je,p,"boneTextureWidth"),h.set(Je,p,"boneTextureHeight")):h.setOptional(Je,p,"boneMatrices"))}return s&&(r.lights&&markUniformsLightsNeedsUpdate(u,c),t&&r.fog&&refreshUniformsFog(u,t),(r.isMeshBasicMaterial||r.isMeshLambertMaterial||r.isMeshPhongMaterial||r.isMeshStandardMaterial||r.isMeshDepthMaterial)&&refreshUniformsCommon(u,r),r.isLineBasicMaterial?refreshUniformsLine(u,r):r.isLineDashedMaterial?(refreshUniformsLine(u,r),refreshUniformsDash(u,r)):r.isPointsMaterial?refreshUniformsPoints(u,r):r.isMeshLambertMaterial?refreshUniformsLambert(u,r):r.isMeshPhongMaterial?refreshUniformsPhong(u,r):r.isMeshPhysicalMaterial?refreshUniformsPhysical(u,r):r.isMeshStandardMaterial?refreshUniformsStandard(u,r):r.isMeshDepthMaterial?r.displacementMap&&(u.displacementMap.value=r.displacementMap,u.displacementScale.value=r.displacementScale,u.displacementBias.value=r.displacementBias):r.isMeshNormalMaterial&&(u.opacity.value=r.opacity),WebGLUniforms.upload(Je,n.uniformsList,u,T)),h.set(Je,i,"modelViewMatrix"),h.set(Je,i,"normalMatrix"),h.setValue(Je,"modelMatrix",i.matrixWorld),l}function refreshUniformsCommon(e,t){e.opacity.value=t.opacity,e.diffuse.value=t.color,t.emissive&&e.emissive.value.copy(t.emissive).multiplyScalar(t.emissiveIntensity),e.map.value=t.map,e.specularMap.value=t.specularMap,e.alphaMap.value=t.alphaMap,t.aoMap&&(e.aoMap.value=t.aoMap,e.aoMapIntensity.value=t.aoMapIntensity);var r;if(t.map?r=t.map:t.specularMap?r=t.specularMap:t.displacementMap?r=t.displacementMap:t.normalMap?r=t.normalMap:t.bumpMap?r=t.bumpMap:t.roughnessMap?r=t.roughnessMap:t.metalnessMap?r=t.metalnessMap:t.alphaMap?r=t.alphaMap:t.emissiveMap&&(r=t.emissiveMap),void 0!==r){r.isWebGLRenderTarget&&(r=r.texture);var i=r.offset,n=r.repeat;e.offsetRepeat.value.set(i.x,i.y,n.x,n.y)}e.envMap.value=t.envMap,e.flipEnvMap.value=t.envMap&&t.envMap.isCubeTexture?-1:1,e.reflectivity.value=t.reflectivity,e.refractionRatio.value=t.refractionRatio}function refreshUniformsLine(e,t){e.diffuse.value=t.color,e.opacity.value=t.opacity}function refreshUniformsDash(e,t){e.dashSize.value=t.dashSize,e.totalSize.value=t.dashSize+t.gapSize,e.scale.value=t.scale}function refreshUniformsPoints(e,t){if(e.diffuse.value=t.color,e.opacity.value=t.opacity,e.size.value=t.size*re,e.scale.value=.5*te,e.map.value=t.map,null!==t.map){var r=t.map.offset,i=t.map.repeat;e.offsetRepeat.value.set(r.x,r.y,i.x,i.y)}}function refreshUniformsFog(e,t){e.fogColor.value=t.color,t.isFog?(e.fogNear.value=t.near,e.fogFar.value=t.far):t.isFogExp2&&(e.fogDensity.value=t.density)}function refreshUniformsLambert(e,t){t.lightMap&&(e.lightMap.value=t.lightMap,e.lightMapIntensity.value=t.lightMapIntensity),t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap)}function refreshUniformsPhong(e,t){e.specular.value=t.specular,e.shininess.value=Math.max(t.shininess,1e-4),t.lightMap&&(e.lightMap.value=t.lightMap,e.lightMapIntensity.value=t.lightMapIntensity),t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap),t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale),t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale)),t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}function refreshUniformsStandard(e,t){e.roughness.value=t.roughness,e.metalness.value=t.metalness,t.roughnessMap&&(e.roughnessMap.value=t.roughnessMap),t.metalnessMap&&(e.metalnessMap.value=t.metalnessMap),t.lightMap&&(e.lightMap.value=t.lightMap,e.lightMapIntensity.value=t.lightMapIntensity),t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap),t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale),t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale)),t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias),t.envMap&&(e.envMapIntensity.value=t.envMapIntensity)}function refreshUniformsPhysical(e,t){e.clearCoat.value=t.clearCoat,e.clearCoatRoughness.value=t.clearCoatRoughness,refreshUniformsStandard(e,t)}function markUniformsLightsNeedsUpdate(e,t){e.ambientLightColor.needsUpdate=t,e.directionalLights.needsUpdate=t,e.pointLights.needsUpdate=t,e.spotLights.needsUpdate=t,e.hemisphereLights.needsUpdate=t}function setupShadows(e){for(var t=0,r=0,i=e.length;r<i;r++){var n=e[r];n.castShadow&&(Ve.shadows[t++]=n)}Ve.shadows.length=t}function setupLights(e,t){var r,i,n,a,o,s,c,l=0,h=0,u=0,d=t.matrixWorldInverse,p=0,f=0,m=0,g=0;for(r=0,i=e.length;r<i;r++)if(n=e[r],a=n.color,o=n.intensity,s=n.distance,c=n.shadow&&n.shadow.map?n.shadow.map.texture:null,n.isAmbientLight)l+=a.r*o,h+=a.g*o,u+=a.b*o;else if(n.isDirectionalLight)(v=ht.get(n)).color.copy(n.color).multiplyScalar(n.intensity),v.direction.setFromMatrixPosition(n.matrixWorld),_e.setFromMatrixPosition(n.target.matrixWorld),v.direction.sub(_e),v.direction.transformDirection(d),v.shadow=n.castShadow,n.castShadow&&(v.shadowBias=n.shadow.bias,v.shadowRadius=n.shadow.radius,v.shadowMapSize=n.shadow.mapSize),Ve.directionalShadowMap[p]=c,Ve.directionalShadowMatrix[p]=n.shadow.matrix,Ve.directional[p++]=v;else if(n.isSpotLight)(v=ht.get(n)).position.setFromMatrixPosition(n.matrixWorld),v.position.applyMatrix4(d),v.color.copy(a).multiplyScalar(o),v.distance=s,v.direction.setFromMatrixPosition(n.matrixWorld),_e.setFromMatrixPosition(n.target.matrixWorld),v.direction.sub(_e),v.direction.transformDirection(d),v.coneCos=Math.cos(n.angle),v.penumbraCos=Math.cos(n.angle*(1-n.penumbra)),v.decay=0===n.distance?0:n.decay,v.shadow=n.castShadow,n.castShadow&&(v.shadowBias=n.shadow.bias,v.shadowRadius=n.shadow.radius,v.shadowMapSize=n.shadow.mapSize),Ve.spotShadowMap[m]=c,Ve.spotShadowMatrix[m]=n.shadow.matrix,Ve.spot[m++]=v;else if(n.isPointLight)(v=ht.get(n)).position.setFromMatrixPosition(n.matrixWorld),v.position.applyMatrix4(d),v.color.copy(n.color).multiplyScalar(n.intensity),v.distance=n.distance,v.decay=0===n.distance?0:n.decay,v.shadow=n.castShadow,n.castShadow&&(v.shadowBias=n.shadow.bias,v.shadowRadius=n.shadow.radius,v.shadowMapSize=n.shadow.mapSize),Ve.pointShadowMap[f]=c,void 0===Ve.pointShadowMatrix[f]&&(Ve.pointShadowMatrix[f]=new Matrix4),_e.setFromMatrixPosition(n.matrixWorld).negate(),Ve.pointShadowMatrix[f].identity().setPosition(_e),Ve.point[f++]=v;else if(n.isHemisphereLight){var v=ht.get(n);v.direction.setFromMatrixPosition(n.matrixWorld),v.direction.transformDirection(d),v.direction.normalize(),v.skyColor.copy(n.color).multiplyScalar(o),v.groundColor.copy(n.groundColor).multiplyScalar(o),Ve.hemi[g++]=v}Ve.ambient[0]=l,Ve.ambient[1]=h,Ve.ambient[2]=u,Ve.directional.length=p,Ve.spot.length=m,Ve.point.length=f,Ve.hemi.length=g,Ve.hash=p+","+f+","+m+","+g+","+Ve.shadows.length}function paramThreeToGL(e){var t;if(e===ue)return Je.REPEAT;if(e===de)return Je.CLAMP_TO_EDGE;if(e===pe)return Je.MIRRORED_REPEAT;if(e===me)return Je.NEAREST;if(e===ge)return Je.NEAREST_MIPMAP_NEAREST;if(e===ve)return Je.NEAREST_MIPMAP_LINEAR;if(e===ye)return Je.LINEAR;if(e===xe)return Je.LINEAR_MIPMAP_NEAREST;if(e===be)return Je.LINEAR_MIPMAP_LINEAR;if(e===Me)return Je.UNSIGNED_BYTE;if(e===Ce)return Je.UNSIGNED_SHORT_4_4_4_4;if(e===Re)return Je.UNSIGNED_SHORT_5_5_5_1;if(e===Be)return Je.UNSIGNED_SHORT_5_6_5;if(e===we)return Je.BYTE;if(e===Te)return Je.SHORT;if(e===Se)return Je.UNSIGNED_SHORT;if(e===Ee)return Je.INT;if(e===Ae)return Je.UNSIGNED_INT;if(e===Le)return Je.FLOAT;if(e===Pe&&null!==(t=it.get("OES_texture_half_float")))return t.HALF_FLOAT_OES;if(e===Ge)return Je.ALPHA;if(e===De)return Je.RGB;if(e===Ue)return Je.RGBA;if(e===Oe)return Je.LUMINANCE;if(e===Fe)return Je.LUMINANCE_ALPHA;if(e===Ne)return Je.DEPTH_COMPONENT;if(e===ze)return Je.DEPTH_STENCIL;if(e===S)return Je.FUNC_ADD;if(e===E)return Je.FUNC_SUBTRACT;if(e===A)return Je.FUNC_REVERSE_SUBTRACT;if(e===C)return Je.ZERO;if(e===R)return Je.ONE;if(e===B)return Je.SRC_COLOR;if(e===I)return Je.ONE_MINUS_SRC_COLOR;if(e===G)return Je.SRC_ALPHA;if(e===D)return Je.ONE_MINUS_SRC_ALPHA;if(e===U)return Je.DST_ALPHA;if(e===O)return Je.ONE_MINUS_DST_ALPHA;if(e===F)return Je.DST_COLOR;if(e===V)return Je.ONE_MINUS_DST_COLOR;if(e===N)return Je.SRC_ALPHA_SATURATE;if((e===He||e===ke||e===je||e===We)&&null!==(t=it.get("WEBGL_compressed_texture_s3tc"))){if(e===He)return t.COMPRESSED_RGB_S3TC_DXT1_EXT;if(e===ke)return t.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(e===je)return t.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(e===We)return t.COMPRESSED_RGBA_S3TC_DXT5_EXT}if((e===Xe||e===Ye||e===qe||e===Ze)&&null!==(t=it.get("WEBGL_compressed_texture_pvrtc"))){if(e===Xe)return t.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(e===Ye)return t.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(e===qe)return t.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(e===Ze)return t.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(e===Ke&&null!==(t=it.get("WEBGL_compressed_texture_etc1")))return t.COMPRESSED_RGB_ETC1_WEBGL;if((e===L||e===P)&&null!==(t=it.get("EXT_blend_minmax"))){if(e===L)return t.MIN_EXT;if(e===P)return t.MAX_EXT}return e===Ie&&null!==(t=it.get("WEBGL_depth_texture"))?t.UNSIGNED_INT_24_8_WEBGL:0}console.log("THREE.WebGLRenderer",t);var r=void 0!==(e=e||{}).canvas?e.canvas:document.createElementNS("http://www.w3.org/1999/xhtml","canvas"),i=void 0!==e.context?e.context:null,n=void 0!==e.alpha&&e.alpha,a=void 0===e.depth||e.depth,s=void 0===e.stencil||e.stencil,c=void 0!==e.antialias&&e.antialias,l=void 0===e.premultipliedAlpha||e.premultipliedAlpha,p=void 0!==e.preserveDrawingBuffer&&e.preserveDrawingBuffer,m=[],g=[],v=-1,x=[],b=-1,_=new Float32Array(8),M=[],w=[];this.domElement=r,this.context=null,this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this.gammaFactor=2,this.gammaInput=!1,this.gammaOutput=!1,this.physicallyCorrectLights=!1,this.toneMapping=$,this.toneMappingExposure=1,this.toneMappingWhitePoint=1,this.maxMorphTargets=8,this.maxMorphNormals=4;var T=this,z=null,H=null,k=null,j=-1,W="",X=null,Y=new Vector4,q=null,Z=new Vector4,K=0,Q=new Color(0),J=0,ee=r.width,te=r.height,re=1,ie=new Vector4(0,0,ee,te),ne=!1,ae=new Vector4(0,0,ee,te),oe=new Frustum,se=new WebGLClipping,ce=!1,le=!1,he=new Sphere,fe=new Matrix4,_e=new Vector3,Ve={hash:"",ambient:[0,0,0],directional:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotShadowMap:[],spotShadowMatrix:[],point:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[],shadows:[]},Qe={calls:0,vertices:0,faces:0,points:0};this.info={render:Qe,memory:{geometries:0,textures:0},programs:null};var Je;try{var rt={alpha:n,depth:a,stencil:s,antialias:c,premultipliedAlpha:l,preserveDrawingBuffer:p};if(null===(Je=i||r.getContext("webgl",rt)||r.getContext("experimental-webgl",rt)))throw null!==r.getContext("webgl")?"Error creating WebGL context with your selected attributes.":"Error creating WebGL context.";void 0===Je.getShaderPrecisionFormat&&(Je.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}}),r.addEventListener("webglcontextlost",onContextLost,!1)}catch(e){console.error("THREE.WebGLRenderer: "+e)}var it=new WebGLExtensions(Je);it.get("WEBGL_depth_texture"),it.get("OES_texture_float"),it.get("OES_texture_float_linear"),it.get("OES_texture_half_float"),it.get("OES_texture_half_float_linear"),it.get("OES_standard_derivatives"),it.get("ANGLE_instanced_arrays"),it.get("OES_element_index_uint")&&(BufferGeometry.MaxIndex=4294967296);var nt=new WebGLCapabilities(Je,it,e),at=new WebGLState(Je,it,paramThreeToGL),ot=new WebGLProperties,st=new WebGLTextures(Je,it,at,ot,nt,paramThreeToGL,this.info),ct=new WebGLObjects(Je,ot,this.info),lt=new WebGLPrograms(this,nt),ht=new WebGLLights;this.info.programs=lt.programs;var ut=new WebGLBufferRenderer(Je,it,Qe),dt=new WebGLIndexedBufferRenderer(Je,it,Qe),pt=new OrthographicCamera(-1,1,1,-1,0,1),ft=new PerspectiveCamera,mt=new Mesh(new PlaneBufferGeometry(2,2),new MeshBasicMaterial({depthTest:!1,depthWrite:!1,fog:!1})),gt=Mt.cube,vt=new Mesh(new BoxBufferGeometry(5,5,5),new ShaderMaterial({uniforms:gt.uniforms,vertexShader:gt.vertexShader,fragmentShader:gt.fragmentShader,side:h,depthTest:!1,depthWrite:!1,fog:!1}));setDefaultGLState(),this.context=Je,this.capabilities=nt,this.extensions=it,this.properties=ot,this.state=at;var xt=new WebGLShadowMap(this,Ve,ct,nt);this.shadowMap=xt;var bt=new SpritePlugin(this,M),_t=new LensFlarePlugin(this,w);this.getContext=function(){return Je},this.getContextAttributes=function(){return Je.getContextAttributes()},this.forceContextLoss=function(){it.get("WEBGL_lose_context").loseContext()},this.getMaxAnisotropy=function(){return nt.getMaxAnisotropy()},this.getPrecision=function(){return nt.precision},this.getPixelRatio=function(){return re},this.setPixelRatio=function(e){void 0!==e&&(re=e,this.setSize(ae.z,ae.w,!1))},this.getSize=function(){return{width:ee,height:te}},this.setSize=function(e,t,i){ee=e,te=t,r.width=e*re,r.height=t*re,!1!==i&&(r.style.width=e+"px",r.style.height=t+"px"),this.setViewport(0,0,e,t)},this.setViewport=function(e,t,r,i){at.viewport(ae.set(e,t,r,i))},this.setScissor=function(e,t,r,i){at.scissor(ie.set(e,t,r,i))},this.setScissorTest=function(e){at.setScissorTest(ne=e)},this.getClearColor=function(){return Q},this.setClearColor=function(e,t){Q.set(e),J=void 0!==t?t:1,glClearColor(Q.r,Q.g,Q.b,J)},this.getClearAlpha=function(){return J},this.setClearAlpha=function(e){J=e,glClearColor(Q.r,Q.g,Q.b,J)},this.clear=function(e,t,r){var i=0;(void 0===e||e)&&(i|=Je.COLOR_BUFFER_BIT),(void 0===t||t)&&(i|=Je.DEPTH_BUFFER_BIT),(void 0===r||r)&&(i|=Je.STENCIL_BUFFER_BIT),Je.clear(i)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.clearTarget=function(e,t,r,i){this.setRenderTarget(e),this.clear(t,r,i)},this.resetGLState=resetGLState,this.dispose=function(){x=[],b=-1,g=[],v=-1,r.removeEventListener("webglcontextlost",onContextLost,!1)},this.renderBufferImmediate=function(e,t,r){at.initAttributes();var i=ot.get(e);e.hasPositions&&!i.position&&(i.position=Je.createBuffer()),e.hasNormals&&!i.normal&&(i.normal=Je.createBuffer()),e.hasUvs&&!i.uv&&(i.uv=Je.createBuffer()),e.hasColors&&!i.color&&(i.color=Je.createBuffer());var n=t.getAttributes();if(e.hasPositions&&(Je.bindBuffer(Je.ARRAY_BUFFER,i.position),Je.bufferData(Je.ARRAY_BUFFER,e.positionArray,Je.DYNAMIC_DRAW),at.enableAttribute(n.position),Je.vertexAttribPointer(n.position,3,Je.FLOAT,!1,0,0)),e.hasNormals){if(Je.bindBuffer(Je.ARRAY_BUFFER,i.normal),!r.isMeshPhongMaterial&&!r.isMeshStandardMaterial&&r.shading===d)for(var a=0,o=3*e.count;a<o;a+=9){var s=e.normalArray,c=(s[a+0]+s[a+3]+s[a+6])/3,l=(s[a+1]+s[a+4]+s[a+7])/3,h=(s[a+2]+s[a+5]+s[a+8])/3;s[a+0]=c,s[a+1]=l,s[a+2]=h,s[a+3]=c,s[a+4]=l,s[a+5]=h,s[a+6]=c,s[a+7]=l,s[a+8]=h}Je.bufferData(Je.ARRAY_BUFFER,e.normalArray,Je.DYNAMIC_DRAW),at.enableAttribute(n.normal),Je.vertexAttribPointer(n.normal,3,Je.FLOAT,!1,0,0)}e.hasUvs&&r.map&&(Je.bindBuffer(Je.ARRAY_BUFFER,i.uv),Je.bufferData(Je.ARRAY_BUFFER,e.uvArray,Je.DYNAMIC_DRAW),at.enableAttribute(n.uv),Je.vertexAttribPointer(n.uv,2,Je.FLOAT,!1,0,0)),e.hasColors&&r.vertexColors!==f&&(Je.bindBuffer(Je.ARRAY_BUFFER,i.color),Je.bufferData(Je.ARRAY_BUFFER,e.colorArray,Je.DYNAMIC_DRAW),at.enableAttribute(n.color),Je.vertexAttribPointer(n.color,3,Je.FLOAT,!1,0,0)),at.disableUnusedAttributes(),Je.drawArrays(Je.TRIANGLES,0,e.count),e.count=0},this.renderBufferDirect=function(e,t,r,i,n,a){setMaterial(i);var o=setProgram(e,t,i,n),s=!1,c=r.id+"_"+o.id+"_"+i.wireframe;c!==W&&(W=c,s=!0);var l=n.morphTargetInfluences;if(void 0!==l){for(var h=[],u=0,d=l.length;u<d;u++){f=l[u];h.push([f,u])}h.sort(absNumericalSort),h.length>8&&(h.length=8);for(var p=r.morphAttributes,u=0,d=h.length;u<d;u++){var f=h[u];if(_[u]=f[0],0!==f[0]){g=f[1];!0===i.morphTargets&&p.position&&r.addAttribute("morphTarget"+u,p.position[g]),!0===i.morphNormals&&p.normal&&r.addAttribute("morphNormal"+u,p.normal[g])}else!0===i.morphTargets&&r.removeAttribute("morphTarget"+u),!0===i.morphNormals&&r.removeAttribute("morphNormal"+u)}for(var u=h.length,m=_.length;u<m;u++)_[u]=0;o.getUniforms().setValue(Je,"morphTargetInfluences",_),s=!0}var g=r.index,v=r.attributes.position,y=1;!0===i.wireframe&&(g=ct.getWireframeAttribute(r),y=2);var x;null!==g?(x=dt).setIndex(g):x=ut,s&&(setupVertexAttributes(i,o,r),null!==g&&Je.bindBuffer(Je.ELEMENT_ARRAY_BUFFER,ct.getAttributeBuffer(g)));var b=0;null!==g?b=g.count:void 0!==v&&(b=v.count);var M=r.drawRange.start*y,w=r.drawRange.count*y,T=null!==a?a.start*y:0,S=null!==a?a.count*y:1/0,E=Math.max(M,T),A=Math.min(b,M+w,T+S)-1,L=Math.max(0,A-E+1);if(0!==L){if(n.isMesh)if(!0===i.wireframe)at.setLineWidth(i.wireframeLinewidth*getTargetPixelRatio()),x.setMode(Je.LINES);else switch(n.drawMode){case $e:x.setMode(Je.TRIANGLES);break;case et:x.setMode(Je.TRIANGLE_STRIP);break;case tt:x.setMode(Je.TRIANGLE_FAN)}else if(n.isLine){var P=i.linewidth;void 0===P&&(P=1),at.setLineWidth(P*getTargetPixelRatio()),n.isLineSegments?x.setMode(Je.LINES):x.setMode(Je.LINE_STRIP)}else n.isPoints&&x.setMode(Je.POINTS);r&&r.isInstancedBufferGeometry?r.maxInstancedCount>0&&x.renderInstances(r,E,L):x.render(E,L)}},this.render=function(e,t,r,i){if(void 0===t||!0===t.isCamera){W="",j=-1,X=null,!0===e.autoUpdate&&e.updateMatrixWorld(),null===t.parent&&t.updateMatrixWorld(),t.matrixWorldInverse.getInverse(t.matrixWorld),fe.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),oe.setFromMatrix(fe),m.length=0,v=-1,b=-1,M.length=0,w.length=0,le=this.localClippingEnabled,ce=se.init(this.clippingPlanes,le,t),projectObject(e,t),g.length=v+1,x.length=b+1,!0===T.sortObjects&&(g.sort(painterSortStable),x.sort(reversePainterSortStable)),ce&&se.beginShadows(),setupShadows(m),xt.render(e,t),setupLights(m,t),ce&&se.endShadows(),Qe.calls=0,Qe.vertices=0,Qe.faces=0,Qe.points=0,void 0===r&&(r=null),this.setRenderTarget(r);var n=e.background;if(null===n?glClearColor(Q.r,Q.g,Q.b,J):n&&n.isColor&&(glClearColor(n.r,n.g,n.b,1),i=!0),(this.autoClear||i)&&this.clear(this.autoClearColor,this.autoClearDepth,this.autoClearStencil),n&&n.isCubeTexture?(ft.projectionMatrix.copy(t.projectionMatrix),ft.matrixWorld.extractRotation(t.matrixWorld),ft.matrixWorldInverse.getInverse(ft.matrixWorld),vt.material.uniforms.tCube.value=n,vt.modelViewMatrix.multiplyMatrices(ft.matrixWorldInverse,vt.matrixWorld),ct.update(vt),T.renderBufferDirect(ft,null,vt.geometry,vt.material,vt,null)):n&&n.isTexture&&(mt.material.map=n,ct.update(mt),T.renderBufferDirect(pt,null,mt.geometry,mt.material,mt,null)),e.overrideMaterial){var a=e.overrideMaterial;renderObjects(g,e,t,a),renderObjects(x,e,t,a)}else at.setBlending(y),renderObjects(g,e,t),renderObjects(x,e,t);bt.render(e,t),_t.render(e,t,Z),r&&st.updateRenderTargetMipmap(r),at.setDepthTest(!0),at.setDepthWrite(!0),at.setColorWrite(!0)}else console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.")},this.setFaceCulling=function(e,t){at.setCullFace(e),at.setFlipSided(t===o)},this.allocTextureUnit=function allocTextureUnit(){var e=K;return e>=nt.maxTextures&&console.warn("WebGLRenderer: trying to use "+e+" texture units while this GPU supports only "+nt.maxTextures),K+=1,e},this.setTexture2D=function(){var e=!1;return function setTexture2D(t,r){t&&t.isWebGLRenderTarget&&(e||(console.warn("THREE.WebGLRenderer.setTexture2D: don't use render targets as textures. Use their .texture property instead."),e=!0),t=t.texture),st.setTexture2D(t,r)}}(),this.setTexture=function(){var e=!1;return function setTexture(t,r){e||(console.warn("THREE.WebGLRenderer: .setTexture is deprecated, use setTexture2D instead."),e=!0),st.setTexture2D(t,r)}}(),this.setTextureCube=function(){var e=!1;return function setTextureCube(t,r){t&&t.isWebGLRenderTargetCube&&(e||(console.warn("THREE.WebGLRenderer.setTextureCube: don't use cube render targets as textures. Use their .texture property instead."),e=!0),t=t.texture),t&&t.isCubeTexture||Array.isArray(t.image)&&6===t.image.length?st.setTextureCube(t,r):st.setTextureCubeDynamic(t,r)}}(),this.getCurrentRenderTarget=function(){return H},this.setRenderTarget=function(e){H=e,e&&void 0===ot.get(e).__webglFramebuffer&&st.setupRenderTarget(e);var t,r=e&&e.isWebGLRenderTargetCube;if(e){var i=ot.get(e);t=r?i.__webglFramebuffer[e.activeCubeFace]:i.__webglFramebuffer,Y.copy(e.scissor),q=e.scissorTest,Z.copy(e.viewport)}else t=null,Y.copy(ie).multiplyScalar(re),q=ne,Z.copy(ae).multiplyScalar(re);if(k!==t&&(Je.bindFramebuffer(Je.FRAMEBUFFER,t),k=t),at.scissor(Y),at.setScissorTest(q),at.viewport(Z),r){var n=ot.get(e.texture);Je.framebufferTexture2D(Je.FRAMEBUFFER,Je.COLOR_ATTACHMENT0,Je.TEXTURE_CUBE_MAP_POSITIVE_X+e.activeCubeFace,n.__webglTexture,e.activeMipMapLevel)}},this.readRenderTargetPixels=function(e,t,r,i,n,a){if(!1!==(e&&e.isWebGLRenderTarget)){var o=ot.get(e).__webglFramebuffer;if(o){var s=!1;o!==k&&(Je.bindFramebuffer(Je.FRAMEBUFFER,o),s=!0);try{var c=e.texture,l=c.format,h=c.type;if(l!==Ue&&paramThreeToGL(l)!==Je.getParameter(Je.IMPLEMENTATION_COLOR_READ_FORMAT))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in RGBA or implementation defined format.");if(!(h===Me||paramThreeToGL(h)===Je.getParameter(Je.IMPLEMENTATION_COLOR_READ_TYPE)||h===Le&&(it.get("OES_texture_float")||it.get("WEBGL_color_buffer_float"))||h===Pe&&it.get("EXT_color_buffer_half_float")))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in UnsignedByteType or implementation defined type.");Je.checkFramebufferStatus(Je.FRAMEBUFFER)===Je.FRAMEBUFFER_COMPLETE?t>=0&&t<=e.width-i&&r>=0&&r<=e.height-n&&Je.readPixels(t,r,i,n,paramThreeToGL(l),paramThreeToGL(h),a):console.error("THREE.WebGLRenderer.readRenderTargetPixels: readPixels from renderTarget failed. Framebuffer not complete.")}finally{s&&Je.bindFramebuffer(Je.FRAMEBUFFER,k)}}}else console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.")}}function FogExp2(e,t){this.name="",this.color=new Color(e),this.density=void 0!==t?t:25e-5}function Fog(e,t,r){this.name="",this.color=new Color(e),this.near=void 0!==t?t:1,this.far=void 0!==r?r:1e3}function Scene(){Object3D.call(this),this.type="Scene",this.background=null,this.fog=null,this.overrideMaterial=null,this.autoUpdate=!0}function LensFlare(e,t,r,i,n){Object3D.call(this),this.lensFlares=[],this.positionScreen=new Vector3,this.customUpdateCallback=void 0,void 0!==e&&this.add(e,t,r,i,n)}function SpriteMaterial(e){Material.call(this),this.type="SpriteMaterial",this.color=new Color(16777215),this.map=null,this.rotation=0,this.fog=!1,this.lights=!1,this.setValues(e)}function Sprite(e){Object3D.call(this),this.type="Sprite",this.material=void 0!==e?e:new SpriteMaterial}function LOD(){Object3D.call(this),this.type="LOD",Object.defineProperties(this,{levels:{enumerable:!0,value:[]}})}function DataTexture(e,t,r,i,n,a,o,s,c,l,h,u){Texture.call(this,null,a,o,s,c,l,i,n,h,u),this.image={data:e,width:t,height:r},this.magFilter=void 0!==c?c:me,this.minFilter=void 0!==l?l:me,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}function Skeleton(e,t,r){if(this.useVertexTexture=void 0===r||r,this.identityMatrix=new Matrix4,e=e||[],this.bones=e.slice(0),this.useVertexTexture){var i=Math.sqrt(4*this.bones.length);i=ut.nextPowerOfTwo(Math.ceil(i)),i=Math.max(i,4),this.boneTextureWidth=i,this.boneTextureHeight=i,this.boneMatrices=new Float32Array(this.boneTextureWidth*this.boneTextureHeight*4),this.boneTexture=new DataTexture(this.boneMatrices,this.boneTextureWidth,this.boneTextureHeight,Ue,Le)}else this.boneMatrices=new Float32Array(16*this.bones.length);if(void 0===t)this.calculateInverses();else if(this.bones.length===t.length)this.boneInverses=t.slice(0);else{console.warn("THREE.Skeleton bonInverses is the wrong length."),this.boneInverses=[];for(var n=0,a=this.bones.length;n<a;n++)this.boneInverses.push(new Matrix4)}}function Bone(e){Object3D.call(this),this.type="Bone",this.skin=e}function SkinnedMesh(e,t,r){Mesh.call(this,e,t),this.type="SkinnedMesh",this.bindMode="attached",this.bindMatrix=new Matrix4,this.bindMatrixInverse=new Matrix4;var i=[];if(this.geometry&&void 0!==this.geometry.bones){for(var n,a,o=0,s=this.geometry.bones.length;o<s;++o)a=this.geometry.bones[o],n=new Bone(this),i.push(n),n.name=a.name,n.position.fromArray(a.pos),n.quaternion.fromArray(a.rotq),void 0!==a.scl&&n.scale.fromArray(a.scl);for(var o=0,s=this.geometry.bones.length;o<s;++o)-1!==(a=this.geometry.bones[o]).parent&&null!==a.parent&&void 0!==i[a.parent]?i[a.parent].add(i[o]):this.add(i[o])}this.normalizeSkinWeights(),this.updateMatrixWorld(!0),this.bind(new Skeleton(i,void 0,r),this.matrixWorld)}function LineBasicMaterial(e){Material.call(this),this.type="LineBasicMaterial",this.color=new Color(16777215),this.linewidth=1,this.linecap="round",this.linejoin="round",this.lights=!1,this.setValues(e)}function Line(e,t,r){if(1===r)return console.warn("THREE.Line: parameter THREE.LinePieces no longer supported. Created THREE.LineSegments instead."),new LineSegments(e,t);Object3D.call(this),this.type="Line",this.geometry=void 0!==e?e:new BufferGeometry,this.material=void 0!==t?t:new LineBasicMaterial({color:16777215*Math.random()})}function LineSegments(e,t){Line.call(this,e,t),this.type="LineSegments"}function PointsMaterial(e){Material.call(this),this.type="PointsMaterial",this.color=new Color(16777215),this.map=null,this.size=1,this.sizeAttenuation=!0,this.lights=!1,this.setValues(e)}function Points(e,t){Object3D.call(this),this.type="Points",this.geometry=void 0!==e?e:new BufferGeometry,this.material=void 0!==t?t:new PointsMaterial({color:16777215*Math.random()})}function Group(){Object3D.call(this),this.type="Group"}function VideoTexture(e,t,r,i,n,a,o,s,c){function update(){requestAnimationFrame(update),e.readyState>=e.HAVE_CURRENT_DATA&&(l.needsUpdate=!0)}Texture.call(this,e,t,r,i,n,a,o,s,c),this.generateMipmaps=!1;var l=this;update()}function CompressedTexture(e,t,r,i,n,a,o,s,c,l,h,u){Texture.call(this,null,a,o,s,c,l,i,n,h,u),this.image={width:t,height:r},this.mipmaps=e,this.flipY=!1,this.generateMipmaps=!1}function CanvasTexture(e,t,r,i,n,a,o,s,c){Texture.call(this,e,t,r,i,n,a,o,s,c),this.needsUpdate=!0}function DepthTexture(e,t,r,i,n,a,o,s,c,l){if((l=void 0!==l?l:Ne)!==Ne&&l!==ze)throw new Error("DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat");Texture.call(this,null,i,n,a,o,s,l,r,c),this.image={width:e,height:t},this.type=void 0!==r?r:Se,this.magFilter=void 0!==o?o:me,this.minFilter=void 0!==s?s:me,this.flipY=!1,this.generateMipmaps=!1}function WireframeGeometry(e){function sortFunction(e,t){return e-t}BufferGeometry.call(this);var t=[0,0],r={},i=["a","b","c"];if(e&&e.isGeometry){for(var n=e.vertices,a=e.faces,o=0,s=new Uint32Array(6*a.length),c=0,l=a.length;c<l;c++)for(var h=a[c],u=0;u<3;u++)t[0]=h[i[u]],t[1]=h[i[(u+1)%3]],t.sort(sortFunction),void 0===r[_=t.toString()]&&(s[2*o]=t[0],s[2*o+1]=t[1],r[_]=!0,o++);for(var d=new Float32Array(2*o*3),c=0,l=o;c<l;c++)for(u=0;u<2;u++){var p=n[s[2*c+u]];d[(M=6*c+3*u)+0]=p.x,d[M+1]=p.y,d[M+2]=p.z}this.addAttribute("position",new BufferAttribute(d,3))}else if(e&&e.isBufferGeometry)if(null!==e.index){var f=e.index.array,n=e.attributes.position,m=e.groups,o=0;0===m.length&&e.addGroup(0,f.length);for(var s=new Uint32Array(2*f.length),g=0,v=m.length;g<v;++g)for(var y=m[g],x=y.start,c=x,b=x+y.count;c<b;c+=3)for(u=0;u<3;u++){t[0]=f[c+u],t[1]=f[c+(u+1)%3],t.sort(sortFunction);var _=t.toString();void 0===r[_]&&(s[2*o]=t[0],s[2*o+1]=t[1],r[_]=!0,o++)}for(var d=new Float32Array(2*o*3),c=0,l=o;c<l;c++)for(u=0;u<2;u++){var M=6*c+3*u,w=s[2*c+u];d[M+0]=n.getX(w),d[M+1]=n.getY(w),d[M+2]=n.getZ(w)}this.addAttribute("position",new BufferAttribute(d,3))}else{for(var T=(o=(n=e.attributes.position.array).length/3)/3,d=new Float32Array(2*o*3),c=0,l=T;c<l;c++)for(u=0;u<3;u++){var S=9*c+3*u;d[(M=18*c+6*u)+0]=n[S],d[M+1]=n[S+1],d[M+2]=n[S+2];w=9*c+(u+1)%3*3;d[M+3]=n[w],d[M+4]=n[w+1],d[M+5]=n[w+2]}this.addAttribute("position",new BufferAttribute(d,3))}}function ParametricBufferGeometry(e,t,r){BufferGeometry.call(this),this.type="ParametricBufferGeometry",this.parameters={func:e,slices:t,stacks:r};var i,n,a,o,s,c=[],l=[],h=t+1;for(i=0;i<=r;i++)for(s=i/r,n=0;n<=t;n++)a=e(o=n/t,s),c.push(a.x,a.y,a.z),l.push(o,s);var u,d,p,f,m=[];for(i=0;i<r;i++)for(n=0;n<t;n++)u=i*h+n,d=i*h+n+1,p=(i+1)*h+n+1,f=(i+1)*h+n,m.push(u,d,f),m.push(d,p,f);this.setIndex((m.length>65535?Uint32Attribute:Uint16Attribute)(m,1)),this.addAttribute("position",Float32Attribute(c,3)),this.addAttribute("uv",Float32Attribute(l,2)),this.computeVertexNormals()}function ParametricGeometry(e,t,r){Geometry.call(this),this.type="ParametricGeometry",this.parameters={func:e,slices:t,stacks:r},this.fromBufferGeometry(new ParametricBufferGeometry(e,t,r)),this.mergeVertices()}function PolyhedronBufferGeometry(e,t,r,i){function subdivideFace(e,t,r,i){var n,a,o=Math.pow(2,i),s=[];for(n=0;n<=o;n++){s[n]=[];var c=e.clone().lerp(r,n/o),l=t.clone().lerp(r,n/o),h=o-n;for(a=0;a<=h;a++)s[n][a]=0===a&&n===o?c:c.clone().lerp(l,a/h)}for(n=0;n<o;n++)for(a=0;a<2*(o-n)-1;a++){var u=Math.floor(a/2);a%2==0?(pushVertex(s[n][u+1]),pushVertex(s[n+1][u]),pushVertex(s[n][u])):(pushVertex(s[n][u+1]),pushVertex(s[n+1][u+1]),pushVertex(s[n+1][u]))}}function correctSeam(){for(var e=0;e<a.length;e+=6){var t=a[e+0],r=a[e+2],i=a[e+4],n=Math.max(t,r,i),o=Math.min(t,r,i);n>.9&&o<.1&&(t<.2&&(a[e+0]+=1),r<.2&&(a[e+2]+=1),i<.2&&(a[e+4]+=1))}}function pushVertex(e){n.push(e.x,e.y,e.z)}function getVertexByIndex(t,r){var i=3*t;r.x=e[i+0],r.y=e[i+1],r.z=e[i+2]}function correctUVs(){for(var e=new Vector3,t=new Vector3,r=new Vector3,i=new Vector3,o=new Vector2,s=new Vector2,c=new Vector2,l=0,h=0;l<n.length;l+=9,h+=6){e.set(n[l+0],n[l+1],n[l+2]),t.set(n[l+3],n[l+4],n[l+5]),r.set(n[l+6],n[l+7],n[l+8]),o.set(a[h+0],a[h+1]),s.set(a[h+2],a[h+3]),c.set(a[h+4],a[h+5]),i.copy(e).add(t).add(r).divideScalar(3);var u=azimuth(i);correctUV(o,h+0,e,u),correctUV(s,h+2,t,u),correctUV(c,h+4,r,u)}}function correctUV(e,t,r,i){i<0&&1===e.x&&(a[t]=e.x-1),0===r.x&&0===r.z&&(a[t]=i/2/Math.PI+.5)}function azimuth(e){return Math.atan2(e.z,-e.x)}function inclination(e){return Math.atan2(-e.y,Math.sqrt(e.x*e.x+e.z*e.z))}BufferGeometry.call(this),this.type="PolyhedronBufferGeometry",this.parameters={vertices:e,indices:t,radius:r,detail:i},r=r||1;var n=[],a=[];!function subdivide(e){for(var r=new Vector3,i=new Vector3,n=new Vector3,a=0;a<t.length;a+=3)getVertexByIndex(t[a+0],r),getVertexByIndex(t[a+1],i),getVertexByIndex(t[a+2],n),subdivideFace(r,i,n,e)}(i=i||0),function appplyRadius(e){for(var t=new Vector3,r=0;r<n.length;r+=3)t.x=n[r+0],t.y=n[r+1],t.z=n[r+2],t.normalize().multiplyScalar(e),n[r+0]=t.x,n[r+1]=t.y,n[r+2]=t.z}(r),function generateUVs(){for(var e=new Vector3,t=0;t<n.length;t+=3){e.x=n[t+0],e.y=n[t+1],e.z=n[t+2];var r=azimuth(e)/2/Math.PI+.5,i=inclination(e)/Math.PI+.5;a.push(r,1-i)}correctUVs(),correctSeam()}(),this.addAttribute("position",Float32Attribute(n,3)),this.addAttribute("normal",Float32Attribute(n.slice(),3)),this.addAttribute("uv",Float32Attribute(a,2)),this.normalizeNormals(),this.boundingSphere=new Sphere(new Vector3,r)}function TetrahedronBufferGeometry(e,t){var r=[1,1,1,-1,-1,1,-1,1,-1,1,-1,-1],i=[2,1,0,0,3,2,1,3,0,2,3,1];PolyhedronBufferGeometry.call(this,r,i,e,t),this.type="TetrahedronBufferGeometry",this.parameters={radius:e,detail:t}}function TetrahedronGeometry(e,t){Geometry.call(this),this.type="TetrahedronGeometry",this.parameters={radius:e,detail:t},this.fromBufferGeometry(new TetrahedronBufferGeometry(e,t)),this.mergeVertices()}function OctahedronBufferGeometry(e,t){var r=[1,0,0,-1,0,0,0,1,0,0,-1,0,0,0,1,0,0,-1],i=[0,2,4,0,4,3,0,3,5,0,5,2,1,2,5,1,5,3,1,3,4,1,4,2];PolyhedronBufferGeometry.call(this,r,i,e,t),this.type="OctahedronBufferGeometry",this.parameters={radius:e,detail:t}}function OctahedronGeometry(e,t){Geometry.call(this),this.type="OctahedronGeometry",this.parameters={radius:e,detail:t},this.fromBufferGeometry(new OctahedronBufferGeometry(e,t)),this.mergeVertices()}function IcosahedronBufferGeometry(e,t){var r=(1+Math.sqrt(5))/2,i=[-1,r,0,1,r,0,-1,-r,0,1,-r,0,0,-1,r,0,1,r,0,-1,-r,0,1,-r,r,0,-1,r,0,1,-r,0,-1,-r,0,1],n=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1];PolyhedronBufferGeometry.call(this,i,n,e,t),this.type="IcosahedronBufferGeometry",this.parameters={radius:e,detail:t}}function IcosahedronGeometry(e,t){Geometry.call(this),this.type="IcosahedronGeometry",this.parameters={radius:e,detail:t},this.fromBufferGeometry(new IcosahedronBufferGeometry(e,t)),this.mergeVertices()}function DodecahedronBufferGeometry(e,t){var r=(1+Math.sqrt(5))/2,i=1/r,n=[-1,-1,-1,-1,-1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,1,1,1,-1,1,1,1,0,-i,-r,0,-i,r,0,i,-r,0,i,r,-i,-r,0,-i,r,0,i,-r,0,i,r,0,-r,0,-i,r,0,-i,-r,0,i,r,0,i],a=[3,11,7,3,7,15,3,15,13,7,19,17,7,17,6,7,6,15,17,4,8,17,8,10,17,10,6,8,0,16,8,16,2,8,2,10,0,12,1,0,1,18,0,18,16,6,10,2,6,2,13,6,13,15,2,16,18,2,18,3,2,3,13,18,1,9,18,9,11,18,11,3,4,14,12,4,12,0,4,0,8,11,9,5,11,5,19,11,19,7,19,5,14,19,14,4,19,4,17,1,12,14,1,14,5,1,5,9];PolyhedronBufferGeometry.call(this,n,a,e,t),this.type="DodecahedronBufferGeometry",this.parameters={radius:e,detail:t}}function DodecahedronGeometry(e,t){Geometry.call(this),this.type="DodecahedronGeometry",this.parameters={radius:e,detail:t},this.fromBufferGeometry(new DodecahedronBufferGeometry(e,t)),this.mergeVertices()}function PolyhedronGeometry(e,t,r,i){Geometry.call(this),this.type="PolyhedronGeometry",this.parameters={vertices:e,indices:t,radius:r,detail:i},this.fromBufferGeometry(new PolyhedronBufferGeometry(e,t,r,i)),this.mergeVertices()}function TubeBufferGeometry(e,t,r,i,n){function generateSegment(n){var o=e.getPointAt(n/t),h=a.normals[n],p=a.binormals[n];for(s=0;s<=i;s++){var f=s/i*Math.PI*2,m=Math.sin(f),g=-Math.cos(f);l.x=g*h.x+m*p.x,l.y=g*h.y+m*p.y,l.z=g*h.z+m*p.z,l.normalize(),d.push(l.x,l.y,l.z),c.x=o.x+r*l.x,c.y=o.y+r*l.y,c.z=o.z+r*l.z,u.push(c.x,c.y,c.z)}}function generateIndices(){for(s=1;s<=t;s++)for(o=1;o<=i;o++){var e=(i+1)*(s-1)+(o-1),r=(i+1)*s+(o-1),n=(i+1)*s+o,a=(i+1)*(s-1)+o;f.push(e,r,a),f.push(r,n,a)}}function generateUVs(){for(o=0;o<=t;o++)for(s=0;s<=i;s++)h.x=o/t,h.y=s/i,p.push(h.x,h.y)}BufferGeometry.call(this),this.type="TubeBufferGeometry",this.parameters={path:e,tubularSegments:t,radius:r,radialSegments:i,closed:n},t=t||64,r=r||1,i=i||8,n=n||!1;var a=e.computeFrenetFrames(t,n);this.tangents=a.tangents,this.normals=a.normals,this.binormals=a.binormals;var o,s,c=new Vector3,l=new Vector3,h=new Vector2,u=[],d=[],p=[],f=[];!function generateBufferData(){for(o=0;o<t;o++)generateSegment(o);generateSegment(!1===n?t:0),generateUVs(),generateIndices()}(),this.setIndex((f.length>65535?Uint32Attribute:Uint16Attribute)(f,1)),this.addAttribute("position",Float32Attribute(u,3)),this.addAttribute("normal",Float32Attribute(d,3)),this.addAttribute("uv",Float32Attribute(p,2))}function TubeGeometry(e,t,r,i,n,a){Geometry.call(this),this.type="TubeGeometry",this.parameters={path:e,tubularSegments:t,radius:r,radialSegments:i,closed:n},void 0!==a&&console.warn("THREE.TubeGeometry: taper has been removed.");var o=new TubeBufferGeometry(e,t,r,i,n);this.tangents=o.tangents,this.normals=o.normals,this.binormals=o.binormals,this.fromBufferGeometry(o),this.mergeVertices()}function TorusKnotBufferGeometry(e,t,r,i,n,a){function calculatePositionOnCurve(e,t,r,i,n){var a=Math.cos(e),o=Math.sin(e),s=r/t*e,c=Math.cos(s);n.x=i*(2+c)*.5*a,n.y=i*(2+c)*o*.5,n.z=i*Math.sin(s)*.5}BufferGeometry.call(this),this.type="TorusKnotBufferGeometry",this.parameters={radius:e,tube:t,tubularSegments:r,radialSegments:i,p:n,q:a},e=e||100,t=t||40,r=Math.floor(r)||64,i=Math.floor(i)||8,n=n||2,a=a||3;var o,s,c=(i+1)*(r+1),l=i*r*2*3,h=new BufferAttribute(new(l>65535?Uint32Array:Uint16Array)(l),1),u=new BufferAttribute(new Float32Array(3*c),3),d=new BufferAttribute(new Float32Array(3*c),3),p=new BufferAttribute(new Float32Array(2*c),2),f=0,m=0,g=new Vector3,v=new Vector3,y=new Vector2,x=new Vector3,b=new Vector3,_=new Vector3,M=new Vector3,w=new Vector3;for(o=0;o<=r;++o){var T=o/r*n*Math.PI*2;for(calculatePositionOnCurve(T,n,a,e,x),calculatePositionOnCurve(T+.01,n,a,e,b),M.subVectors(b,x),w.addVectors(b,x),_.crossVectors(M,w),w.crossVectors(_,M),_.normalize(),w.normalize(),s=0;s<=i;++s){var S=s/i*Math.PI*2,E=-t*Math.cos(S),A=t*Math.sin(S);g.x=x.x+(E*w.x+A*_.x),g.y=x.y+(E*w.y+A*_.y),g.z=x.z+(E*w.z+A*_.z),u.setXYZ(f,g.x,g.y,g.z),v.subVectors(g,x).normalize(),d.setXYZ(f,v.x,v.y,v.z),y.x=o/r,y.y=s/i,p.setXY(f,y.x,y.y),f++}}for(s=1;s<=r;s++)for(o=1;o<=i;o++){var L=(i+1)*(s-1)+(o-1),P=(i+1)*s+(o-1),C=(i+1)*s+o,R=(i+1)*(s-1)+o;h.setX(m,L),m++,h.setX(m,P),m++,h.setX(m,R),m++,h.setX(m,P),m++,h.setX(m,C),m++,h.setX(m,R),m++}this.setIndex(h),this.addAttribute("position",u),this.addAttribute("normal",d),this.addAttribute("uv",p)}function TorusKnotGeometry(e,t,r,i,n,a,o){Geometry.call(this),this.type="TorusKnotGeometry",this.parameters={radius:e,tube:t,tubularSegments:r,radialSegments:i,p:n,q:a},void 0!==o&&console.warn("THREE.TorusKnotGeometry: heightScale has been deprecated. Use .scale( x, y, z ) instead."),this.fromBufferGeometry(new TorusKnotBufferGeometry(e,t,r,i,n,a)),this.mergeVertices()}function TorusBufferGeometry(e,t,r,i,n){BufferGeometry.call(this),this.type="TorusBufferGeometry",this.parameters={radius:e,tube:t,radialSegments:r,tubularSegments:i,arc:n},e=e||100,t=t||40,r=Math.floor(r)||8,i=Math.floor(i)||6,n=n||2*Math.PI;var a,o,s=(r+1)*(i+1),c=r*i*2*3,l=new(c>65535?Uint32Array:Uint16Array)(c),h=new Float32Array(3*s),u=new Float32Array(3*s),d=new Float32Array(2*s),p=0,f=0,m=0,g=new Vector3,v=new Vector3,y=new Vector3;for(a=0;a<=r;a++)for(o=0;o<=i;o++){var x=o/i*n,b=a/r*Math.PI*2;v.x=(e+t*Math.cos(b))*Math.cos(x),v.y=(e+t*Math.cos(b))*Math.sin(x),v.z=t*Math.sin(b),h[p]=v.x,h[p+1]=v.y,h[p+2]=v.z,g.x=e*Math.cos(x),g.y=e*Math.sin(x),y.subVectors(v,g).normalize(),u[p]=y.x,u[p+1]=y.y,u[p+2]=y.z,d[f]=o/i,d[f+1]=a/r,p+=3,f+=2}for(a=1;a<=r;a++)for(o=1;o<=i;o++){var _=(i+1)*a+o-1,M=(i+1)*(a-1)+o-1,w=(i+1)*(a-1)+o,T=(i+1)*a+o;l[m]=_,l[m+1]=M,l[m+2]=T,l[m+3]=M,l[m+4]=w,l[m+5]=T,m+=6}this.setIndex(new BufferAttribute(l,1)),this.addAttribute("position",new BufferAttribute(h,3)),this.addAttribute("normal",new BufferAttribute(u,3)),this.addAttribute("uv",new BufferAttribute(d,2))}function TorusGeometry(e,t,r,i,n){Geometry.call(this),this.type="TorusGeometry",this.parameters={radius:e,tube:t,radialSegments:r,tubularSegments:i,arc:n},this.fromBufferGeometry(new TorusBufferGeometry(e,t,r,i,n))}function ExtrudeGeometry(e,t){void 0!==e?(Geometry.call(this),this.type="ExtrudeGeometry",e=Array.isArray(e)?e:[e],this.addShapeList(e,t),this.computeFaceNormals()):e=[]}function TextGeometry(e,t){var r=(t=t||{}).font;if(!1===(r&&r.isFont))return console.error("THREE.TextGeometry: font parameter is not an instance of THREE.Font."),new Geometry;var i=r.generateShapes(e,t.size,t.curveSegments);t.amount=void 0!==t.height?t.height:50,void 0===t.bevelThickness&&(t.bevelThickness=10),void 0===t.bevelSize&&(t.bevelSize=8),void 0===t.bevelEnabled&&(t.bevelEnabled=!1),ExtrudeGeometry.call(this,i,t),this.type="TextGeometry"}function SphereBufferGeometry(e,t,r,i,n,a,o){BufferGeometry.call(this),this.type="SphereBufferGeometry",this.parameters={radius:e,widthSegments:t,heightSegments:r,phiStart:i,phiLength:n,thetaStart:a,thetaLength:o},e=e||50,t=Math.max(3,Math.floor(t)||8),r=Math.max(2,Math.floor(r)||6),i=void 0!==i?i:0,n=void 0!==n?n:2*Math.PI;for(var s=(a=void 0!==a?a:0)+(o=void 0!==o?o:Math.PI),c=(t+1)*(r+1),l=new BufferAttribute(new Float32Array(3*c),3),h=new BufferAttribute(new Float32Array(3*c),3),u=new BufferAttribute(new Float32Array(2*c),2),d=0,p=[],f=new Vector3,m=0;m<=r;m++){for(var g=[],v=m/r,y=0;y<=t;y++){var x=y/t,b=-e*Math.cos(i+x*n)*Math.sin(a+v*o),_=e*Math.cos(a+v*o),M=e*Math.sin(i+x*n)*Math.sin(a+v*o);f.set(b,_,M).normalize(),l.setXYZ(d,b,_,M),h.setXYZ(d,f.x,f.y,f.z),u.setXY(d,x,1-v),g.push(d),d++}p.push(g)}for(var w=[],m=0;m<r;m++)for(y=0;y<t;y++){var T=p[m][y+1],S=p[m][y],E=p[m+1][y],A=p[m+1][y+1];(0!==m||a>0)&&w.push(T,S,A),(m!==r-1||s<Math.PI)&&w.push(S,E,A)}this.setIndex(new(l.count>65535?Uint32Attribute:Uint16Attribute)(w,1)),this.addAttribute("position",l),this.addAttribute("normal",h),this.addAttribute("uv",u),this.boundingSphere=new Sphere(new Vector3,e)}function SphereGeometry(e,t,r,i,n,a,o){Geometry.call(this),this.type="SphereGeometry",this.parameters={radius:e,widthSegments:t,heightSegments:r,phiStart:i,phiLength:n,thetaStart:a,thetaLength:o},this.fromBufferGeometry(new SphereBufferGeometry(e,t,r,i,n,a,o))}function RingBufferGeometry(e,t,r,i,n,a){BufferGeometry.call(this),this.type="RingBufferGeometry",this.parameters={innerRadius:e,outerRadius:t,thetaSegments:r,phiSegments:i,thetaStart:n,thetaLength:a},e=e||20,t=t||50,n=void 0!==n?n:0,a=void 0!==a?a:2*Math.PI;var o,s,c,l=((r=void 0!==r?Math.max(3,r):8)+1)*((i=void 0!==i?Math.max(1,i):1)+1),h=r*i*2*3,u=new BufferAttribute(new(h>65535?Uint32Array:Uint16Array)(h),1),d=new BufferAttribute(new Float32Array(3*l),3),p=new BufferAttribute(new Float32Array(3*l),3),f=new BufferAttribute(new Float32Array(2*l),2),m=0,g=0,v=e,y=(t-e)/i,x=new Vector3,b=new Vector2;for(s=0;s<=i;s++){for(c=0;c<=r;c++)o=n+c/r*a,x.x=v*Math.cos(o),x.y=v*Math.sin(o),d.setXYZ(m,x.x,x.y,x.z),p.setXYZ(m,0,0,1),b.x=(x.x/t+1)/2,b.y=(x.y/t+1)/2,f.setXY(m,b.x,b.y),m++;v+=y}for(s=0;s<i;s++){var _=s*(r+1);for(c=0;c<r;c++){var M=o=c+_,w=o+r+1,T=o+r+2,S=o+1;u.setX(g,M),g++,u.setX(g,w),g++,u.setX(g,T),g++,u.setX(g,M),g++,u.setX(g,T),g++,u.setX(g,S),g++}}this.setIndex(u),this.addAttribute("position",d),this.addAttribute("normal",p),this.addAttribute("uv",f)}function RingGeometry(e,t,r,i,n,a){Geometry.call(this),this.type="RingGeometry",this.parameters={innerRadius:e,outerRadius:t,thetaSegments:r,phiSegments:i,thetaStart:n,thetaLength:a},this.fromBufferGeometry(new RingBufferGeometry(e,t,r,i,n,a))}function PlaneGeometry(e,t,r,i){Geometry.call(this),this.type="PlaneGeometry",this.parameters={width:e,height:t,widthSegments:r,heightSegments:i},this.fromBufferGeometry(new PlaneBufferGeometry(e,t,r,i))}function LatheBufferGeometry(e,t,r,i){BufferGeometry.call(this),this.type="LatheBufferGeometry",this.parameters={points:e,segments:t,phiStart:r,phiLength:i},t=Math.floor(t)||12,r=r||0,i=i||2*Math.PI,i=ut.clamp(i,0,2*Math.PI);var n,a,o,s=(t+1)*e.length,c=t*e.length*2*3,l=new BufferAttribute(new(c>65535?Uint32Array:Uint16Array)(c),1),h=new BufferAttribute(new Float32Array(3*s),3),u=new BufferAttribute(new Float32Array(2*s),2),d=0,p=0,f=1/t,m=new Vector3,g=new Vector2;for(a=0;a<=t;a++){var v=r+a*f*i,y=Math.sin(v),x=Math.cos(v);for(o=0;o<=e.length-1;o++)m.x=e[o].x*y,m.y=e[o].y,m.z=e[o].x*x,h.setXYZ(d,m.x,m.y,m.z),g.x=a/t,g.y=o/(e.length-1),u.setXY(d,g.x,g.y),d++}for(a=0;a<t;a++)for(o=0;o<e.length-1;o++){var b=n=o+a*e.length,_=n+e.length,M=n+e.length+1,w=n+1;l.setX(p,b),p++,l.setX(p,_),p++,l.setX(p,w),p++,l.setX(p,_),p++,l.setX(p,M),p++,l.setX(p,w),p++}if(this.setIndex(l),this.addAttribute("position",h),this.addAttribute("uv",u),this.computeVertexNormals(),i===2*Math.PI){var T=this.attributes.normal.array,S=new Vector3,E=new Vector3,A=new Vector3;for(n=t*e.length*3,a=0,o=0;a<e.length;a++,o+=3)S.x=T[o+0],S.y=T[o+1],S.z=T[o+2],E.x=T[n+o+0],E.y=T[n+o+1],E.z=T[n+o+2],A.addVectors(S,E).normalize(),T[o+0]=T[n+o+0]=A.x,T[o+1]=T[n+o+1]=A.y,T[o+2]=T[n+o+2]=A.z}}function LatheGeometry(e,t,r,i){Geometry.call(this),this.type="LatheGeometry",this.parameters={points:e,segments:t,phiStart:r,phiLength:i},this.fromBufferGeometry(new LatheBufferGeometry(e,t,r,i)),this.mergeVertices()}function ShapeGeometry(e,t){Geometry.call(this),this.type="ShapeGeometry",!1===Array.isArray(e)&&(e=[e]),this.addShapeList(e,t),this.computeFaceNormals()}function EdgesGeometry(e,t){BufferGeometry.call(this),t=void 0!==t?t:1;var r,i=Math.cos(ut.DEG2RAD*t),n=[0,0],a={},o=["a","b","c"];e&&e.isBufferGeometry?(r=new Geometry).fromBufferGeometry(e):r=e.clone(),r.mergeVertices(),r.computeFaceNormals();for(var s=r.vertices,c=r.faces,l=0,h=c.length;l<h;l++)for(var u=c[l],d=0;d<3;d++)n[0]=u[o[d]],n[1]=u[o[(d+1)%3]],n.sort(function sortFunction(e,t){return e-t}),void 0===a[f=n.toString()]?a[f]={vert1:n[0],vert2:n[1],face1:l,face2:void 0}:a[f].face2=l;var p=[];for(var f in a){var m=a[f];if(void 0===m.face2||c[m.face1].normal.dot(c[m.face2].normal)<=i){var g=s[m.vert1];p.push(g.x),p.push(g.y),p.push(g.z),g=s[m.vert2],p.push(g.x),p.push(g.y),p.push(g.z)}}this.addAttribute("position",new BufferAttribute(new Float32Array(p),3))}function CylinderBufferGeometry(e,t,r,i,n,a,o,s){function generateCap(r){var n,a,l,h=new Vector2,u=new Vector3,y=0,_=!0===r?e:t,M=!0===r?1:-1;for(a=g,n=1;n<=i;n++)p.setXYZ(g,0,x*M,0),f.setXYZ(g,0,M,0),h.x=.5,h.y=.5,m.setXY(g,h.x,h.y),g++;for(l=g,n=0;n<=i;n++){var w=n/i*s+o,T=Math.cos(w),S=Math.sin(w);u.x=_*S,u.y=x*M,u.z=_*T,p.setXYZ(g,u.x,u.y,u.z),f.setXYZ(g,0,M,0),h.x=.5*T+.5,h.y=.5*S*M+.5,m.setXY(g,h.x,h.y),g++}for(n=0;n<i;n++){var E=a+n,A=l+n;!0===r?(d.setX(v,A),v++,d.setX(v,A+1),v++,d.setX(v,E),v++):(d.setX(v,A+1),v++,d.setX(v,A),v++,d.setX(v,E),v++),y+=3}c.addGroup(b,y,!0===r?1:2),b+=y}BufferGeometry.call(this),this.type="CylinderBufferGeometry",this.parameters={radiusTop:e,radiusBottom:t,height:r,radialSegments:i,heightSegments:n,openEnded:a,thetaStart:o,thetaLength:s};var c=this;e=void 0!==e?e:20,t=void 0!==t?t:20,r=void 0!==r?r:100,i=Math.floor(i)||8,n=Math.floor(n)||1,a=void 0!==a&&a,o=void 0!==o?o:0,s=void 0!==s?s:2*Math.PI;var l=0;!1===a&&(e>0&&l++,t>0&&l++);var h=function calculateVertexCount(){var e=(i+1)*(n+1);return!1===a&&(e+=(i+1)*l+i*l),e}(),u=function calculateIndexCount(){var e=i*n*2*3;return!1===a&&(e+=i*l*3),e}(),d=new BufferAttribute(new(u>65535?Uint32Array:Uint16Array)(u),1),p=new BufferAttribute(new Float32Array(3*h),3),f=new BufferAttribute(new Float32Array(3*h),3),m=new BufferAttribute(new Float32Array(2*h),2),g=0,v=0,y=[],x=r/2,b=0;!function generateTorso(){var a,l,h=new Vector3,u=new Vector3,_=0,M=(t-e)/r;for(l=0;l<=n;l++){var w=[],T=l/n,S=T*(t-e)+e;for(a=0;a<=i;a++){var E=a/i,A=E*s+o,L=Math.sin(A),P=Math.cos(A);u.x=S*L,u.y=-T*r+x,u.z=S*P,p.setXYZ(g,u.x,u.y,u.z),h.set(L,M,P).normalize(),f.setXYZ(g,h.x,h.y,h.z),m.setXY(g,E,1-T),w.push(g),g++}y.push(w)}for(a=0;a<i;a++)for(l=0;l<n;l++){var C=y[l][a],R=y[l+1][a],B=y[l+1][a+1],I=y[l][a+1];d.setX(v,C),v++,d.setX(v,R),v++,d.setX(v,I),v++,d.setX(v,R),v++,d.setX(v,B),v++,d.setX(v,I),v++,_+=6}c.addGroup(b,_,0),b+=_}(),!1===a&&(e>0&&generateCap(!0),t>0&&generateCap(!1)),this.setIndex(d),this.addAttribute("position",p),this.addAttribute("normal",f),this.addAttribute("uv",m)}function CylinderGeometry(e,t,r,i,n,a,o,s){Geometry.call(this),this.type="CylinderGeometry",this.parameters={radiusTop:e,radiusBottom:t,height:r,radialSegments:i,heightSegments:n,openEnded:a,thetaStart:o,thetaLength:s},this.fromBufferGeometry(new CylinderBufferGeometry(e,t,r,i,n,a,o,s)),this.mergeVertices()}function ConeGeometry(e,t,r,i,n,a,o){CylinderGeometry.call(this,0,e,t,r,i,n,a,o),this.type="ConeGeometry",this.parameters={radius:e,height:t,radialSegments:r,heightSegments:i,openEnded:n,thetaStart:a,thetaLength:o}}function ConeBufferGeometry(e,t,r,i,n,a,o){CylinderBufferGeometry.call(this,0,e,t,r,i,n,a,o),this.type="ConeBufferGeometry",this.parameters={radius:e,height:t,radialSegments:r,heightSegments:i,openEnded:n,thetaStart:a,thetaLength:o}}function CircleBufferGeometry(e,t,r,i){BufferGeometry.call(this),this.type="CircleBufferGeometry",this.parameters={radius:e,segments:t,thetaStart:r,thetaLength:i},e=e||50,t=void 0!==t?Math.max(3,t):8,r=void 0!==r?r:0,i=void 0!==i?i:2*Math.PI;var n=t+2,a=new Float32Array(3*n),o=new Float32Array(3*n),s=new Float32Array(2*n);o[2]=1,s[0]=.5,s[1]=.5;for(var c=0,l=3,h=2;c<=t;c++,l+=3,h+=2){var u=r+c/t*i;a[l]=e*Math.cos(u),a[l+1]=e*Math.sin(u),o[l+2]=1,s[h]=(a[l]/e+1)/2,s[h+1]=(a[l+1]/e+1)/2}for(var d=[],l=1;l<=t;l++)d.push(l,l+1,0);this.setIndex(new BufferAttribute(new Uint16Array(d),1)),this.addAttribute("position",new BufferAttribute(a,3)),this.addAttribute("normal",new BufferAttribute(o,3)),this.addAttribute("uv",new BufferAttribute(s,2)),this.boundingSphere=new Sphere(new Vector3,e)}function CircleGeometry(e,t,r,i){Geometry.call(this),this.type="CircleGeometry",this.parameters={radius:e,segments:t,thetaStart:r,thetaLength:i},this.fromBufferGeometry(new CircleBufferGeometry(e,t,r,i))}function BoxGeometry(e,t,r,i,n,a){Geometry.call(this),this.type="BoxGeometry",this.parameters={width:e,height:t,depth:r,widthSegments:i,heightSegments:n,depthSegments:a},this.fromBufferGeometry(new BoxBufferGeometry(e,t,r,i,n,a)),this.mergeVertices()}function ShadowMaterial(){ShaderMaterial.call(this,{uniforms:yt.merge([_t.lights,{opacity:{value:1}}]),vertexShader:xt.shadow_vert,fragmentShader:xt.shadow_frag}),this.lights=!0,this.transparent=!0,Object.defineProperties(this,{opacity:{enumerable:!0,get:function(){return this.uniforms.opacity.value},set:function(e){this.uniforms.opacity.value=e}}})}function RawShaderMaterial(e){ShaderMaterial.call(this,e),this.type="RawShaderMaterial"}function MultiMaterial(e){this.uuid=ut.generateUUID(),this.type="MultiMaterial",this.materials=e instanceof Array?e:[],this.visible=!0}function MeshStandardMaterial(e){Material.call(this),this.defines={STANDARD:""},this.type="MeshStandardMaterial",this.color=new Color(16777215),this.roughness=.5,this.metalness=.5,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Color(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalScale=new Vector2(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.roughnessMap=null,this.metalnessMap=null,this.alphaMap=null,this.envMap=null,this.envMapIntensity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(e)}function MeshPhysicalMaterial(e){MeshStandardMaterial.call(this),this.defines={PHYSICAL:""},this.type="MeshPhysicalMaterial",this.reflectivity=.5,this.clearCoat=0,this.clearCoatRoughness=0,this.setValues(e)}function MeshPhongMaterial(e){Material.call(this),this.type="MeshPhongMaterial",this.color=new Color(16777215),this.specular=new Color(1118481),this.shininess=30,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Color(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalScale=new Vector2(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=Z,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(e)}function MeshNormalMaterial(e){Material.call(this,e),this.type="MeshNormalMaterial",this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.morphTargets=!1,this.setValues(e)}function MeshLambertMaterial(e){Material.call(this),this.type="MeshLambertMaterial",this.color=new Color(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Color(0),this.emissiveIntensity=1,this.emissiveMap=null,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=Z,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(e)}function LineDashedMaterial(e){Material.call(this),this.type="LineDashedMaterial",this.color=new Color(16777215),this.linewidth=1,this.scale=1,this.dashSize=3,this.gapSize=1,this.lights=!1,this.setValues(e)}function LoadingManager(e,t,r){var i=this,n=!1,a=0,o=0;this.onStart=void 0,this.onLoad=e,this.onProgress=t,this.onError=r,this.itemStart=function(e){o++,!1===n&&void 0!==i.onStart&&i.onStart(e,a,o),n=!0},this.itemEnd=function(e){a++,void 0!==i.onProgress&&i.onProgress(e,a,o),a===o&&(n=!1,void 0!==i.onLoad&&i.onLoad())},this.itemError=function(e){void 0!==i.onError&&i.onError(e)}}function XHRLoader(e){this.manager=void 0!==e?e:Rt}function CompressedTextureLoader(e){this.manager=void 0!==e?e:Rt,this._parser=null}function BinaryTextureLoader(e){this.manager=void 0!==e?e:Rt,this._parser=null}function ImageLoader(e){this.manager=void 0!==e?e:Rt}function CubeTextureLoader(e){this.manager=void 0!==e?e:Rt}function TextureLoader(e){this.manager=void 0!==e?e:Rt}function Light(e,t){Object3D.call(this),this.type="Light",this.color=new Color(e),this.intensity=void 0!==t?t:1,this.receiveShadow=void 0}function HemisphereLight(e,t,r){Light.call(this,e,r),this.type="HemisphereLight",this.castShadow=void 0,this.position.copy(Object3D.DefaultUp),this.updateMatrix(),this.groundColor=new Color(t)}function LightShadow(e){this.camera=e,this.bias=0,this.radius=1,this.mapSize=new Vector2(512,512),this.map=null,this.matrix=new Matrix4}function SpotLightShadow(){LightShadow.call(this,new PerspectiveCamera(50,1,.5,500))}function SpotLight(e,t,r,i,n,a){Light.call(this,e,t),this.type="SpotLight",this.position.copy(Object3D.DefaultUp),this.updateMatrix(),this.target=new Object3D,Object.defineProperty(this,"power",{get:function(){return this.intensity*Math.PI},set:function(e){this.intensity=e/Math.PI}}),this.distance=void 0!==r?r:0,this.angle=void 0!==i?i:Math.PI/3,this.penumbra=void 0!==n?n:0,this.decay=void 0!==a?a:1,this.shadow=new SpotLightShadow}function PointLight(e,t,r,i){Light.call(this,e,t),this.type="PointLight",Object.defineProperty(this,"power",{get:function(){return 4*this.intensity*Math.PI},set:function(e){this.intensity=e/(4*Math.PI)}}),this.distance=void 0!==r?r:0,this.decay=void 0!==i?i:1,this.shadow=new LightShadow(new PerspectiveCamera(90,1,.5,500))}function DirectionalLightShadow(e){LightShadow.call(this,new OrthographicCamera(-5,5,5,-5,.5,500))}function DirectionalLight(e,t){Light.call(this,e,t),this.type="DirectionalLight",this.position.copy(Object3D.DefaultUp),this.updateMatrix(),this.target=new Object3D,this.shadow=new DirectionalLightShadow}function AmbientLight(e,t){Light.call(this,e,t),this.type="AmbientLight",this.castShadow=void 0}function Interpolant(e,t,r,i){this.parameterPositions=e,this._cachedIndex=0,this.resultBuffer=void 0!==i?i:new t.constructor(r),this.sampleValues=t,this.valueSize=r}function CubicInterpolant(e,t,r,i){Interpolant.call(this,e,t,r,i),this._weightPrev=-0,this._offsetPrev=-0,this._weightNext=-0,this._offsetNext=-0}function LinearInterpolant(e,t,r,i){Interpolant.call(this,e,t,r,i)}function DiscreteInterpolant(e,t,r,i){Interpolant.call(this,e,t,r,i)}function KeyframeTrackConstructor(e,t,r,i){if(void 0===e)throw new Error("track name is undefined");if(void 0===t||0===t.length)throw new Error("no keyframes in track named "+e);this.name=e,this.times=It.convertArray(t,this.TimeBufferType),this.values=It.convertArray(r,this.ValueBufferType),this.setInterpolation(i||this.DefaultInterpolation),this.validate(),this.optimize()}function VectorKeyframeTrack(e,t,r,i){KeyframeTrackConstructor.call(this,e,t,r,i)}function QuaternionLinearInterpolant(e,t,r,i){Interpolant.call(this,e,t,r,i)}function QuaternionKeyframeTrack(e,t,r,i){KeyframeTrackConstructor.call(this,e,t,r,i)}function NumberKeyframeTrack(e,t,r,i){KeyframeTrackConstructor.call(this,e,t,r,i)}function StringKeyframeTrack(e,t,r,i){KeyframeTrackConstructor.call(this,e,t,r,i)}function BooleanKeyframeTrack(e,t,r){KeyframeTrackConstructor.call(this,e,t,r)}function ColorKeyframeTrack(e,t,r,i){KeyframeTrackConstructor.call(this,e,t,r,i)}function KeyframeTrack(e,t,r,i){KeyframeTrackConstructor.apply(this,arguments)}function AnimationClip(e,t,r){this.name=e,this.tracks=r,this.duration=void 0!==t?t:-1,this.uuid=ut.generateUUID(),this.duration<0&&this.resetDuration(),this.optimize()}function MaterialLoader(e){this.manager=void 0!==e?e:Rt,this.textures={}}function BufferGeometryLoader(e){this.manager=void 0!==e?e:Rt}function Loader(){this.onLoadStart=function(){},this.onLoadProgress=function(){},this.onLoadComplete=function(){}}function JSONLoader(e){"boolean"==typeof e&&(console.warn("THREE.JSONLoader: showStatus parameter has been removed from constructor."),e=void 0),this.manager=void 0!==e?e:Rt,this.withCredentials=!1}function ObjectLoader(e){this.manager=void 0!==e?e:Rt,this.texturePath=""}function Curve(){}function LineCurve(e,t){this.v1=e,this.v2=t}function CurvePath(){this.curves=[],this.autoClose=!1}function EllipseCurve(e,t,r,i,n,a,o,s){this.aX=e,this.aY=t,this.xRadius=r,this.yRadius=i,this.aStartAngle=n,this.aEndAngle=a,this.aClockwise=o,this.aRotation=s||0}function SplineCurve(e){this.points=void 0===e?[]:e}function CubicBezierCurve(e,t,r,i){this.v0=e,this.v1=t,this.v2=r,this.v3=i}function QuadraticBezierCurve(e,t,r){this.v0=e,this.v1=t,this.v2=r}function Shape(){Path.apply(this,arguments),this.holes=[]}function Path(e){CurvePath.call(this),this.currentPoint=new Vector2,e&&this.fromPoints(e)}function ShapePath(){this.subPaths=[],this.currentPath=null}function Font(e){this.data=e}function FontLoader(e){this.manager=void 0!==e?e:Rt}function getAudioContext(){return void 0===Ot&&(Ot=new(window.AudioContext||window.webkitAudioContext)),Ot}function AudioLoader(e){this.manager=void 0!==e?e:Rt}function StereoCamera(){this.type="StereoCamera",this.aspect=1,this.eyeSep=.064,this.cameraL=new PerspectiveCamera,this.cameraL.layers.enable(1),this.cameraL.matrixAutoUpdate=!1,this.cameraR=new PerspectiveCamera,this.cameraR.layers.enable(2),this.cameraR.matrixAutoUpdate=!1}function CubeCamera(e,t,r){Object3D.call(this),this.type="CubeCamera";var i=new PerspectiveCamera(90,1,e,t);i.up.set(0,-1,0),i.lookAt(new Vector3(1,0,0)),this.add(i);var n=new PerspectiveCamera(90,1,e,t);n.up.set(0,-1,0),n.lookAt(new Vector3(-1,0,0)),this.add(n);var a=new PerspectiveCamera(90,1,e,t);a.up.set(0,0,1),a.lookAt(new Vector3(0,1,0)),this.add(a);var o=new PerspectiveCamera(90,1,e,t);o.up.set(0,0,-1),o.lookAt(new Vector3(0,-1,0)),this.add(o);var s=new PerspectiveCamera(90,1,e,t);s.up.set(0,-1,0),s.lookAt(new Vector3(0,0,1)),this.add(s);var c=new PerspectiveCamera(90,1,e,t);c.up.set(0,-1,0),c.lookAt(new Vector3(0,0,-1)),this.add(c);var l={format:De,magFilter:ye,minFilter:ye};this.renderTarget=new WebGLRenderTargetCube(r,r,l),this.updateCubeMap=function(e,t){null===this.parent&&this.updateMatrixWorld();var r=this.renderTarget,l=r.texture.generateMipmaps;r.texture.generateMipmaps=!1,r.activeCubeFace=0,e.render(t,i,r),r.activeCubeFace=1,e.render(t,n,r),r.activeCubeFace=2,e.render(t,a,r),r.activeCubeFace=3,e.render(t,o,r),r.activeCubeFace=4,e.render(t,s,r),r.texture.generateMipmaps=l,r.activeCubeFace=5,e.render(t,c,r),e.setRenderTarget(null)}}function AudioListener(){Object3D.call(this),this.type="AudioListener",this.context=getAudioContext(),this.gain=this.context.createGain(),this.gain.connect(this.context.destination),this.filter=null}function Audio(e){Object3D.call(this),this.type="Audio",this.context=e.context,this.source=this.context.createBufferSource(),this.source.onended=this.onEnded.bind(this),this.gain=this.context.createGain(),this.gain.connect(e.getInput()),this.autoplay=!1,this.startTime=0,this.playbackRate=1,this.isPlaying=!1,this.hasPlaybackControl=!0,this.sourceType="empty",this.filters=[]}function PositionalAudio(e){Audio.call(this,e),this.panner=this.context.createPanner(),this.panner.connect(this.gain)}function AudioAnalyser(e,t){this.analyser=e.context.createAnalyser(),this.analyser.fftSize=void 0!==t?t:2048,this.data=new Uint8Array(this.analyser.frequencyBinCount),e.getOutput().connect(this.analyser)}function PropertyMixer(e,t,r){this.binding=e,this.valueSize=r;var i,n=Float64Array;switch(t){case"quaternion":i=this._slerp;break;case"string":case"bool":n=Array,i=this._select;break;default:i=this._lerp}this.buffer=new n(4*r),this._mixBufferRegion=i,this.cumulativeWeight=0,this.useCount=0,this.referenceCount=0}function PropertyBinding(e,t,r){this.path=t,this.parsedPath=r||PropertyBinding.parseTrackName(t),this.node=PropertyBinding.findNode(e,this.parsedPath.nodeName)||e,this.rootNode=e}function AnimationObjectGroup(e){this.uuid=ut.generateUUID(),this._objects=Array.prototype.slice.call(arguments),this.nCachedObjects_=0;var t={};this._indicesByUUID=t;for(var r=0,i=arguments.length;r!==i;++r)t[arguments[r].uuid]=r;this._paths=[],this._parsedPaths=[],this._bindings=[],this._bindingsIndicesByPath={};var n=this;this.stats={objects:{get total(){return n._objects.length},get inUse(){return this.total-n.nCachedObjects_}},get bindingsPerObject(){return n._bindings.length}}}function AnimationAction(e,t,r){this._mixer=e,this._clip=t,this._localRoot=r||null;for(var i=t.tracks,n=i.length,a=new Array(n),o={endingStart:Je,endingEnd:Je},s=0;s!==n;++s){var c=i[s].createInterpolant(null);a[s]=c,c.settings=o}this._interpolantSettings=o,this._interpolants=a,this._propertyBindings=new Array(n),this._cacheIndex=null,this._byClipCacheIndex=null,this._timeScaleInterpolant=null,this._weightInterpolant=null,this.loop=Qe,this._loopCount=-1,this._startTime=null,this.time=0,this.timeScale=1,this._effectiveTimeScale=1,this.weight=1,this._effectiveWeight=1,this.repetitions=1/0,this.paused=!1,this.enabled=!0,this.clampWhenFinished=!1,this.zeroSlopeAtStart=!0,this.zeroSlopeAtEnd=!0}function AnimationMixer(e){this._root=e,this._initMemoryManager(),this._accuIndex=0,this.time=0,this.timeScale=1}function Uniform(e){"string"==typeof e&&(console.warn("THREE.Uniform: Type parameter is no longer needed."),e=arguments[1]),this.value=e}function InstancedBufferGeometry(){BufferGeometry.call(this),this.type="InstancedBufferGeometry",this.maxInstancedCount=void 0}function InterleavedBufferAttribute(e,t,r,i){this.uuid=ut.generateUUID(),this.data=e,this.itemSize=t,this.offset=r,this.normalized=!0===i}function InterleavedBuffer(e,t){this.uuid=ut.generateUUID(),this.array=e,this.stride=t,this.count=void 0!==e?e.length/t:0,this.dynamic=!1,this.updateRange={offset:0,count:-1},this.version=0}function InstancedInterleavedBuffer(e,t,r){InterleavedBuffer.call(this,e,t),this.meshPerAttribute=r||1}function InstancedBufferAttribute(e,t,r){BufferAttribute.call(this,e,t),this.meshPerAttribute=r||1}function Raycaster(e,t,r,i){this.ray=new Ray(e,t),this.near=r||0,this.far=i||1/0,this.params={Mesh:{},Line:{},LOD:{},Points:{threshold:1},Sprite:{}},Object.defineProperties(this.params,{PointCloud:{get:function(){return console.warn("THREE.Raycaster: params.PointCloud has been renamed to params.Points."),this.Points}}})}function ascSort(e,t){return e.distance-t.distance}function intersectObject(e,t,r,i){if(!1!==e.visible&&(e.raycast(t,r),!0===i))for(var n=e.children,a=0,o=n.length;a<o;a++)intersectObject(n[a],t,r,!0)}function Clock(e){this.autoStart=void 0===e||e,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}function Spherical(e,t,r){return this.radius=void 0!==e?e:1,this.phi=void 0!==t?t:0,this.theta=void 0!==r?r:0,this}function MorphBlendMesh(e,t){Mesh.call(this,e,t),this.animationsMap={},this.animationsList=[];var r=this.geometry.morphTargets.length,i=r-1,n=r/1;this.createAnimation("__default",0,i,n),this.setAnimationWeight("__default",1)}function ImmediateRenderObject(e){Object3D.call(this),this.material=e,this.render=function(e){}}function VertexNormalsHelper(e,t,r,i){this.object=e,this.size=void 0!==t?t:1;var n=void 0!==r?r:16711680,a=void 0!==i?i:1,o=0,s=this.object.geometry;s&&s.isGeometry?o=3*s.faces.length:s&&s.isBufferGeometry&&(o=s.attributes.normal.count);var c=new BufferGeometry,l=new Float32Attribute(2*o*3,3);c.addAttribute("position",l),LineSegments.call(this,c,new LineBasicMaterial({color:n,linewidth:a})),this.matrixAutoUpdate=!1,this.update()}function SpotLightHelper(e){Object3D.call(this),this.light=e,this.light.updateMatrixWorld(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1;for(var t=new BufferGeometry,r=[0,0,0,0,0,1,0,0,0,1,0,1,0,0,0,-1,0,1,0,0,0,0,1,1,0,0,0,0,-1,1],i=0,n=1;i<32;i++,n++){var a=i/32*Math.PI*2,o=n/32*Math.PI*2;r.push(Math.cos(a),Math.sin(a),1,Math.cos(o),Math.sin(o),1)}t.addAttribute("position",new Float32Attribute(r,3));var s=new LineBasicMaterial({fog:!1});this.cone=new LineSegments(t,s),this.add(this.cone),this.update()}function SkeletonHelper(e){this.bones=this.getBoneList(e);for(var t=new Geometry,r=0;r<this.bones.length;r++){var i=this.bones[r];i.parent&&i.parent.isBone&&(t.vertices.push(new Vector3),t.vertices.push(new Vector3),t.colors.push(new Color(0,0,1)),t.colors.push(new Color(0,1,0)))}t.dynamic=!0;var n=new LineBasicMaterial({vertexColors:g,depthTest:!1,depthWrite:!1,transparent:!0});LineSegments.call(this,t,n),this.root=e,this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.update()}function PointLightHelper(e,t){this.light=e,this.light.updateMatrixWorld();var r=new SphereBufferGeometry(t,4,2),i=new MeshBasicMaterial({wireframe:!0,fog:!1});i.color.copy(this.light.color).multiplyScalar(this.light.intensity),Mesh.call(this,r,i),this.matrix=this.light.matrixWorld,this.matrixAutoUpdate=!1}function HemisphereLightHelper(e,t){Object3D.call(this),this.light=e,this.light.updateMatrixWorld(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.colors=[new Color,new Color];var r=new SphereGeometry(t,4,2);r.rotateX(-Math.PI/2);for(var i=0;i<8;i++)r.faces[i].color=this.colors[i<4?0:1];var n=new MeshBasicMaterial({vertexColors:m,wireframe:!0});this.lightSphere=new Mesh(r,n),this.add(this.lightSphere),this.update()}function GridHelper(e,t,r,i){t=t||1,r=new Color(void 0!==r?r:4473924),i=new Color(void 0!==i?i:8947848);for(var n=t/2,a=2*e/t,o=[],s=[],c=0,l=0,h=-e;c<=t;c++,h+=a){o.push(-e,0,h,e,0,h),o.push(h,0,-e,h,0,e);var u=c===n?r:i;u.toArray(s,l),l+=3,u.toArray(s,l),l+=3,u.toArray(s,l),l+=3,u.toArray(s,l),l+=3}var d=new BufferGeometry;d.addAttribute("position",new Float32Attribute(o,3)),d.addAttribute("color",new Float32Attribute(s,3));var p=new LineBasicMaterial({vertexColors:g});LineSegments.call(this,d,p)}function FaceNormalsHelper(e,t,r,i){this.object=e,this.size=void 0!==t?t:1;var n=void 0!==r?r:16776960,a=void 0!==i?i:1,o=0,s=this.object.geometry;s&&s.isGeometry?o=s.faces.length:console.warn("THREE.FaceNormalsHelper: only THREE.Geometry is supported. Use THREE.VertexNormalsHelper, instead.");var c=new BufferGeometry,l=new Float32Attribute(2*o*3,3);c.addAttribute("position",l),LineSegments.call(this,c,new LineBasicMaterial({color:n,linewidth:a})),this.matrixAutoUpdate=!1,this.update()}function DirectionalLightHelper(e,t){Object3D.call(this),this.light=e,this.light.updateMatrixWorld(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,void 0===t&&(t=1);var r=new BufferGeometry;r.addAttribute("position",new Float32Attribute([-t,t,0,t,t,0,t,-t,0,-t,-t,0,-t,t,0],3));var i=new LineBasicMaterial({fog:!1});this.add(new Line(r,i)),(r=new BufferGeometry).addAttribute("position",new Float32Attribute([0,0,0,0,0,1],3)),this.add(new Line(r,i)),this.update()}function CameraHelper(e){function addLine(e,t,r){addPoint(e,r),addPoint(t,r)}function addPoint(e,r){t.vertices.push(new Vector3),t.colors.push(new Color(r)),void 0===i[e]&&(i[e]=[]),i[e].push(t.vertices.length-1)}var t=new Geometry,r=new LineBasicMaterial({color:16777215,vertexColors:m}),i={};addLine("n1","n2",16755200),addLine("n2","n4",16755200),addLine("n4","n3",16755200),addLine("n3","n1",16755200),addLine("f1","f2",16755200),addLine("f2","f4",16755200),addLine("f4","f3",16755200),addLine("f3","f1",16755200),addLine("n1","f1",16755200),addLine("n2","f2",16755200),addLine("n3","f3",16755200),addLine("n4","f4",16755200),addLine("p","n1",16711680),addLine("p","n2",16711680),addLine("p","n3",16711680),addLine("p","n4",16711680),addLine("u1","u2",43775),addLine("u2","u3",43775),addLine("u3","u1",43775),addLine("c","t",16777215),addLine("p","c",3355443),addLine("cn1","cn2",3355443),addLine("cn3","cn4",3355443),addLine("cf1","cf2",3355443),addLine("cf3","cf4",3355443),LineSegments.call(this,t,r),this.camera=e,this.camera.updateProjectionMatrix&&this.camera.updateProjectionMatrix(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.pointMap=i,this.update()}function BoundingBoxHelper(e,t){var r=void 0!==t?t:8947848;this.object=e,this.box=new Box3,Mesh.call(this,new BoxGeometry(1,1,1),new MeshBasicMaterial({color:r,wireframe:!0}))}function BoxHelper(e,t){void 0===t&&(t=16776960);var r=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),i=new Float32Array(24),n=new BufferGeometry;n.setIndex(new BufferAttribute(r,1)),n.addAttribute("position",new BufferAttribute(i,3)),LineSegments.call(this,n,new LineBasicMaterial({color:t})),void 0!==e&&this.update(e)}function ArrowHelper(e,t,r,i,n,a){Object3D.call(this),void 0===i&&(i=16776960),void 0===r&&(r=1),void 0===n&&(n=.2*r),void 0===a&&(a=.2*n),this.position.copy(t),this.line=new Line(Ft,new LineBasicMaterial({color:i})),this.line.matrixAutoUpdate=!1,this.add(this.line),this.cone=new Mesh(Vt,new MeshBasicMaterial({color:i})),this.cone.matrixAutoUpdate=!1,this.add(this.cone),this.setDirection(e),this.setLength(r,n,a)}function AxisHelper(e){e=e||1;var t=new Float32Array([0,0,0,e,0,0,0,0,0,0,e,0,0,0,0,0,0,e]),r=new Float32Array([1,0,0,1,.6,0,0,1,0,.6,1,0,0,0,1,0,.6,1]),i=new BufferGeometry;i.addAttribute("position",new BufferAttribute(t,3)),i.addAttribute("color",new BufferAttribute(r,3));var n=new LineBasicMaterial({vertexColors:g});LineSegments.call(this,i,n)}function ClosedSplineCurve3(e){console.warn("THREE.ClosedSplineCurve3 has been deprecated. Please use THREE.CatmullRomCurve3."),Nt.call(this,e),this.type="catmullrom",this.closed=!0}function ArcCurve(e,t,r,i,n,a){EllipseCurve.call(this,e,t,r,r,i,n,a)}void 0===Number.EPSILON&&(Number.EPSILON=Math.pow(2,-52)),void 0===Math.sign&&(Math.sign=function(e){return e<0?-1:e>0?1:+e}),void 0===Function.prototype.name&&Object.defineProperty(Function.prototype,"name",{get:function(){return this.toString().match(/^\s*function\s*(\S*)\s*\(/)[1]}}),void 0===Object.assign&&(Object.assign=function(e){if(void 0===e||null===e)throw new TypeError("Cannot convert undefined or null to object");for(var t=Object(e),r=1;r<arguments.length;r++){var i=arguments[r];if(void 0!==i&&null!==i)for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(t[n]=i[n])}return t}),Object.assign(EventDispatcher.prototype,{addEventListener:function(e,t){void 0===this._listeners&&(this._listeners={});var r=this._listeners;void 0===r[e]&&(r[e]=[]),-1===r[e].indexOf(t)&&r[e].push(t)},hasEventListener:function(e,t){if(void 0===this._listeners)return!1;var r=this._listeners;return void 0!==r[e]&&-1!==r[e].indexOf(t)},removeEventListener:function(e,t){if(void 0!==this._listeners){var r=this._listeners[e];if(void 0!==r){var i=r.indexOf(t);-1!==i&&r.splice(i,1)}}},dispatchEvent:function(e){if(void 0!==this._listeners){var t=this._listeners[e.type];if(void 0!==t){e.target=this;var r=[],i=0,n=t.length;for(i=0;i<n;i++)r[i]=t[i];for(i=0;i<n;i++)r[i].call(this,e)}}}});var t="82",r={LEFT:0,MIDDLE:1,RIGHT:2},i=0,n=1,a=2,o=0,s=1,c=2,l=0,h=1,u=2,d=1,p=2,f=0,m=1,g=2,y=0,x=1,b=2,_=3,M=4,w=5,T={NoBlending:y,NormalBlending:x,AdditiveBlending:b,SubtractiveBlending:_,MultiplyBlending:M,CustomBlending:w},S=100,E=101,A=102,L=103,P=104,C=200,R=201,B=202,I=203,G=204,D=205,U=206,O=207,F=208,V=209,N=210,z=0,H=1,k=2,j=3,W=4,X=5,Y=6,q=7,Z=0,K=1,Q=2,J=0,$=1,ee=2,te=3,re=4,ie=301,ne=302,ae=303,oe=304,se=305,ce=306,le=307,he={UVMapping:300,CubeReflectionMapping:ie,CubeRefractionMapping:ne,EquirectangularReflectionMapping:ae,EquirectangularRefractionMapping:oe,SphericalReflectionMapping:se,CubeUVReflectionMapping:ce,CubeUVRefractionMapping:le},ue=1e3,de=1001,pe=1002,fe={RepeatWrapping:ue,ClampToEdgeWrapping:de,MirroredRepeatWrapping:pe},me=1003,ge=1004,ve=1005,ye=1006,xe=1007,be=1008,_e={NearestFilter:me,NearestMipMapNearestFilter:ge,NearestMipMapLinearFilter:ve,LinearFilter:ye,LinearMipMapNearestFilter:xe,LinearMipMapLinearFilter:be},Me=1009,we=1010,Te=1011,Se=1012,Ee=1013,Ae=1014,Le=1015,Pe=1016,Ce=1017,Re=1018,Be=1019,Ie=1020,Ge=1021,De=1022,Ue=1023,Oe=1024,Fe=1025,Ve=Ue,Ne=1026,ze=1027,He=2001,ke=2002,je=2003,We=2004,Xe=2100,Ye=2101,qe=2102,Ze=2103,Ke=2151,Qe=2201,Je=2400,$e=0,et=1,tt=2,rt=3e3,it=3001,nt=3007,at=3002,ot=3004,st=3005,ct=3006,lt=3200,ht=3201,ut={DEG2RAD:Math.PI/180,RAD2DEG:180/Math.PI,generateUUID:function(){var e,t="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),r=new Array(36),i=0;return function generateUUID(){for(var n=0;n<36;n++)8===n||13===n||18===n||23===n?r[n]="-":14===n?r[n]="4":(i<=2&&(i=33554432+16777216*Math.random()|0),e=15&i,i>>=4,r[n]=t[19===n?3&e|8:e]);return r.join("")}}(),clamp:function(e,t,r){return Math.max(t,Math.min(r,e))},euclideanModulo:function(e,t){return(e%t+t)%t},mapLinear:function(e,t,r,i,n){return i+(e-t)*(n-i)/(r-t)},lerp:function(e,t,r){return(1-r)*e+r*t},smoothstep:function(e,t,r){return e<=t?0:e>=r?1:(e=(e-t)/(r-t))*e*(3-2*e)},smootherstep:function(e,t,r){return e<=t?0:e>=r?1:(e=(e-t)/(r-t))*e*e*(e*(6*e-15)+10)},random16:function(){return console.warn("THREE.Math.random16() has been deprecated. Use Math.random() instead."),Math.random()},randInt:function(e,t){return e+Math.floor(Math.random()*(t-e+1))},randFloat:function(e,t){return e+Math.random()*(t-e)},randFloatSpread:function(e){return e*(.5-Math.random())},degToRad:function(e){return e*ut.DEG2RAD},radToDeg:function(e){return e*ut.RAD2DEG},isPowerOfTwo:function(e){return 0==(e&e-1)&&0!==e},nearestPowerOfTwo:function(e){return Math.pow(2,Math.round(Math.log(e)/Math.LN2))},nextPowerOfTwo:function(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e}};Vector2.prototype={constructor:Vector2,isVector2:!0,get width(){return this.x},set width(e){this.x=e},get height(){return this.y},set height(e){this.y=e},set:function(e,t){return this.x=e,this.y=t,this},setScalar:function(e){return this.x=e,this.y=e,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setComponent:function(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;default:throw new Error("index is out of range: "+e)}return this},getComponent:function(e){switch(e){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+e)}},clone:function(){return new this.constructor(this.x,this.y)},copy:function(e){return this.x=e.x,this.y=e.y,this},add:function(e,t){return void 0!==t?(console.warn("THREE.Vector2: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this)},addScalar:function(e){return this.x+=e,this.y+=e,this},addVectors:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this},addScaledVector:function(e,t){return this.x+=e.x*t,this.y+=e.y*t,this},sub:function(e,t){return void 0!==t?(console.warn("THREE.Vector2: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this)},subScalar:function(e){return this.x-=e,this.y-=e,this},subVectors:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this},multiply:function(e){return this.x*=e.x,this.y*=e.y,this},multiplyScalar:function(e){return isFinite(e)?(this.x*=e,this.y*=e):(this.x=0,this.y=0),this},divide:function(e){return this.x/=e.x,this.y/=e.y,this},divideScalar:function(e){return this.multiplyScalar(1/e)},min:function(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this},max:function(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this},clamp:function(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this},clampScalar:function(){var e,t;return function clampScalar(r,i){return void 0===e&&(e=new Vector2,t=new Vector2),e.set(r,r),t.set(i,i),this.clamp(e,t)}}(),clampLength:function(e,t){var r=this.length();return this.multiplyScalar(Math.max(e,Math.min(t,r))/r)},floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},roundToZero:function(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this},negate:function(){return this.x=-this.x,this.y=-this.y,this},dot:function(e){return this.x*e.x+this.y*e.y},lengthSq:function(){return this.x*this.x+this.y*this.y},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},lengthManhattan:function(){return Math.abs(this.x)+Math.abs(this.y)},normalize:function(){return this.divideScalar(this.length())},angle:function(){var e=Math.atan2(this.y,this.x);return e<0&&(e+=2*Math.PI),e},distanceTo:function(e){return Math.sqrt(this.distanceToSquared(e))},distanceToSquared:function(e){var t=this.x-e.x,r=this.y-e.y;return t*t+r*r},distanceToManhattan:function(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)},setLength:function(e){return this.multiplyScalar(e/this.length())},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this},lerpVectors:function(e,t,r){return this.subVectors(t,e).multiplyScalar(r).add(e)},equals:function(e){return e.x===this.x&&e.y===this.y},fromArray:function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e},fromAttribute:function(e,t,r){return void 0===r&&(r=0),t=t*e.itemSize+r,this.x=e.array[t],this.y=e.array[t+1],this},rotateAround:function(e,t){var r=Math.cos(t),i=Math.sin(t),n=this.x-e.x,a=this.y-e.y;return this.x=n*r-a*i+e.x,this.y=n*i+a*r+e.y,this}},Texture.DEFAULT_IMAGE=void 0,Texture.DEFAULT_MAPPING=300,Texture.prototype={constructor:Texture,isTexture:!0,set needsUpdate(e){!0===e&&this.version++},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.image=e.image,this.mipmaps=e.mipmaps.slice(0),this.mapping=e.mapping,this.wrapS=e.wrapS,this.wrapT=e.wrapT,this.magFilter=e.magFilter,this.minFilter=e.minFilter,this.anisotropy=e.anisotropy,this.format=e.format,this.type=e.type,this.offset.copy(e.offset),this.repeat.copy(e.repeat),this.generateMipmaps=e.generateMipmaps,this.premultiplyAlpha=e.premultiplyAlpha,this.flipY=e.flipY,this.unpackAlignment=e.unpackAlignment,this.encoding=e.encoding,this},toJSON:function(e){if(void 0!==e.textures[this.uuid])return e.textures[this.uuid];var t={metadata:{version:4.4,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,mapping:this.mapping,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],wrap:[this.wrapS,this.wrapT],minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY};if(void 0!==this.image){var r=this.image;void 0===r.uuid&&(r.uuid=ut.generateUUID()),void 0===e.images[r.uuid]&&(e.images[r.uuid]={uuid:r.uuid,url:function getDataURL(e){var t;return void 0!==e.toDataURL?t=e:((t=document.createElementNS("http://www.w3.org/1999/xhtml","canvas")).width=e.width,t.height=e.height,t.getContext("2d").drawImage(e,0,0,e.width,e.height)),t.width>2048||t.height>2048?t.toDataURL("image/jpeg",.6):t.toDataURL("image/png")}(r)}),t.image=r.uuid}return e.textures[this.uuid]=t,t},dispose:function(){this.dispatchEvent({type:"dispose"})},transformUv:function(e){if(300===this.mapping){if(e.multiply(this.repeat),e.add(this.offset),e.x<0||e.x>1)switch(this.wrapS){case ue:e.x=e.x-Math.floor(e.x);break;case de:e.x=e.x<0?0:1;break;case pe:1===Math.abs(Math.floor(e.x)%2)?e.x=Math.ceil(e.x)-e.x:e.x=e.x-Math.floor(e.x)}if(e.y<0||e.y>1)switch(this.wrapT){case ue:e.y=e.y-Math.floor(e.y);break;case de:e.y=e.y<0?0:1;break;case pe:1===Math.abs(Math.floor(e.y)%2)?e.y=Math.ceil(e.y)-e.y:e.y=e.y-Math.floor(e.y)}this.flipY&&(e.y=1-e.y)}}},Object.assign(Texture.prototype,EventDispatcher.prototype);var dt=0;Vector4.prototype={constructor:Vector4,isVector4:!0,set:function(e,t,r,i){return this.x=e,this.y=t,this.z=r,this.w=i,this},setScalar:function(e){return this.x=e,this.y=e,this.z=e,this.w=e,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setZ:function(e){return this.z=e,this},setW:function(e){return this.w=e,this},setComponent:function(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;case 3:this.w=t;break;default:throw new Error("index is out of range: "+e)}return this},getComponent:function(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+e)}},clone:function(){return new this.constructor(this.x,this.y,this.z,this.w)},copy:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=void 0!==e.w?e.w:1,this},add:function(e,t){return void 0!==t?(console.warn("THREE.Vector4: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this)},addScalar:function(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this},addVectors:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this},addScaledVector:function(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this.w+=e.w*t,this},sub:function(e,t){return void 0!==t?(console.warn("THREE.Vector4: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this)},subScalar:function(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this},subVectors:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this},multiplyScalar:function(e){return isFinite(e)?(this.x*=e,this.y*=e,this.z*=e,this.w*=e):(this.x=0,this.y=0,this.z=0,this.w=0),this},applyMatrix4:function(e){var t=this.x,r=this.y,i=this.z,n=this.w,a=e.elements;return this.x=a[0]*t+a[4]*r+a[8]*i+a[12]*n,this.y=a[1]*t+a[5]*r+a[9]*i+a[13]*n,this.z=a[2]*t+a[6]*r+a[10]*i+a[14]*n,this.w=a[3]*t+a[7]*r+a[11]*i+a[15]*n,this},divideScalar:function(e){return this.multiplyScalar(1/e)},setAxisAngleFromQuaternion:function(e){this.w=2*Math.acos(e.w);var t=Math.sqrt(1-e.w*e.w);return t<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=e.x/t,this.y=e.y/t,this.z=e.z/t),this},setAxisAngleFromRotationMatrix:function(e){var t,r,i,n,a=e.elements,o=a[0],s=a[4],c=a[8],l=a[1],h=a[5],u=a[9],d=a[2],p=a[6],f=a[10];if(Math.abs(s-l)<.01&&Math.abs(c-d)<.01&&Math.abs(u-p)<.01){if(Math.abs(s+l)<.1&&Math.abs(c+d)<.1&&Math.abs(u+p)<.1&&Math.abs(o+h+f-3)<.1)return this.set(1,0,0,0),this;t=Math.PI;var m=(o+1)/2,g=(h+1)/2,v=(f+1)/2,y=(s+l)/4,x=(c+d)/4,b=(u+p)/4;return m>g&&m>v?m<.01?(r=0,i=.707106781,n=.707106781):(i=y/(r=Math.sqrt(m)),n=x/r):g>v?g<.01?(r=.707106781,i=0,n=.707106781):(r=y/(i=Math.sqrt(g)),n=b/i):v<.01?(r=.707106781,i=.707106781,n=0):(r=x/(n=Math.sqrt(v)),i=b/n),this.set(r,i,n,t),this}var _=Math.sqrt((p-u)*(p-u)+(c-d)*(c-d)+(l-s)*(l-s));return Math.abs(_)<.001&&(_=1),this.x=(p-u)/_,this.y=(c-d)/_,this.z=(l-s)/_,this.w=Math.acos((o+h+f-1)/2),this},min:function(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this.w=Math.min(this.w,e.w),this},max:function(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this.w=Math.max(this.w,e.w),this},clamp:function(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this.w=Math.max(e.w,Math.min(t.w,this.w)),this},clampScalar:function(){var e,t;return function clampScalar(r,i){return void 0===e&&(e=new Vector4,t=new Vector4),e.set(r,r,r,r),t.set(i,i,i,i),this.clamp(e,t)}}(),floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this},roundToZero:function(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this.w=this.w<0?Math.ceil(this.w):Math.floor(this.w),this},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this},dot:function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},lengthManhattan:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)},normalize:function(){return this.divideScalar(this.length())},setLength:function(e){return this.multiplyScalar(e/this.length())},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this.w+=(e.w-this.w)*t,this},lerpVectors:function(e,t,r){return this.subVectors(t,e).multiplyScalar(r).add(e)},equals:function(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w},fromArray:function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e},fromAttribute:function(e,t,r){return void 0===r&&(r=0),t=t*e.itemSize+r,this.x=e.array[t],this.y=e.array[t+1],this.z=e.array[t+2],this.w=e.array[t+3],this}},Object.assign(WebGLRenderTarget.prototype,EventDispatcher.prototype,{isWebGLRenderTarget:!0,setSize:function(e,t){this.width===e&&this.height===t||(this.width=e,this.height=t,this.dispose()),this.viewport.set(0,0,e,t),this.scissor.set(0,0,e,t)},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.width=e.width,this.height=e.height,this.viewport.copy(e.viewport),this.texture=e.texture.clone(),this.depthBuffer=e.depthBuffer,this.stencilBuffer=e.stencilBuffer,this.depthTexture=e.depthTexture,this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),WebGLRenderTargetCube.prototype=Object.create(WebGLRenderTarget.prototype),WebGLRenderTargetCube.prototype.constructor=WebGLRenderTargetCube,WebGLRenderTargetCube.prototype.isWebGLRenderTargetCube=!0,Quaternion.prototype={constructor:Quaternion,get x(){return this._x},set x(e){this._x=e,this.onChangeCallback()},get y(){return this._y},set y(e){this._y=e,this.onChangeCallback()},get z(){return this._z},set z(e){this._z=e,this.onChangeCallback()},get w(){return this._w},set w(e){this._w=e,this.onChangeCallback()},set:function(e,t,r,i){return this._x=e,this._y=t,this._z=r,this._w=i,this.onChangeCallback(),this},clone:function(){return new this.constructor(this._x,this._y,this._z,this._w)},copy:function(e){return this._x=e.x,this._y=e.y,this._z=e.z,this._w=e.w,this.onChangeCallback(),this},setFromEuler:function(e,t){if(!1===(e&&e.isEuler))throw new Error("THREE.Quaternion: .setFromEuler() now expects an Euler rotation rather than a Vector3 and order.");var r=Math.cos(e._x/2),i=Math.cos(e._y/2),n=Math.cos(e._z/2),a=Math.sin(e._x/2),o=Math.sin(e._y/2),s=Math.sin(e._z/2),c=e.order;return"XYZ"===c?(this._x=a*i*n+r*o*s,this._y=r*o*n-a*i*s,this._z=r*i*s+a*o*n,this._w=r*i*n-a*o*s):"YXZ"===c?(this._x=a*i*n+r*o*s,this._y=r*o*n-a*i*s,this._z=r*i*s-a*o*n,this._w=r*i*n+a*o*s):"ZXY"===c?(this._x=a*i*n-r*o*s,this._y=r*o*n+a*i*s,this._z=r*i*s+a*o*n,this._w=r*i*n-a*o*s):"ZYX"===c?(this._x=a*i*n-r*o*s,this._y=r*o*n+a*i*s,this._z=r*i*s-a*o*n,this._w=r*i*n+a*o*s):"YZX"===c?(this._x=a*i*n+r*o*s,this._y=r*o*n+a*i*s,this._z=r*i*s-a*o*n,this._w=r*i*n-a*o*s):"XZY"===c&&(this._x=a*i*n-r*o*s,this._y=r*o*n-a*i*s,this._z=r*i*s+a*o*n,this._w=r*i*n+a*o*s),!1!==t&&this.onChangeCallback(),this},setFromAxisAngle:function(e,t){var r=t/2,i=Math.sin(r);return this._x=e.x*i,this._y=e.y*i,this._z=e.z*i,this._w=Math.cos(r),this.onChangeCallback(),this},setFromRotationMatrix:function(e){var t,r=e.elements,i=r[0],n=r[4],a=r[8],o=r[1],s=r[5],c=r[9],l=r[2],h=r[6],u=r[10],d=i+s+u;return d>0?(t=.5/Math.sqrt(d+1),this._w=.25/t,this._x=(h-c)*t,this._y=(a-l)*t,this._z=(o-n)*t):i>s&&i>u?(t=2*Math.sqrt(1+i-s-u),this._w=(h-c)/t,this._x=.25*t,this._y=(n+o)/t,this._z=(a+l)/t):s>u?(t=2*Math.sqrt(1+s-i-u),this._w=(a-l)/t,this._x=(n+o)/t,this._y=.25*t,this._z=(c+h)/t):(t=2*Math.sqrt(1+u-i-s),this._w=(o-n)/t,this._x=(a+l)/t,this._y=(c+h)/t,this._z=.25*t),this.onChangeCallback(),this},setFromUnitVectors:function(){var e,t;return function setFromUnitVectors(r,i){return void 0===e&&(e=new Vector3),(t=r.dot(i)+1)<1e-6?(t=0,Math.abs(r.x)>Math.abs(r.z)?e.set(-r.y,r.x,0):e.set(0,-r.z,r.y)):e.crossVectors(r,i),this._x=e.x,this._y=e.y,this._z=e.z,this._w=t,this.normalize()}}(),inverse:function(){return this.conjugate().normalize()},conjugate:function(){return this._x*=-1,this._y*=-1,this._z*=-1,this.onChangeCallback(),this},dot:function(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w},lengthSq:function(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w},length:function(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)},normalize:function(){var e=this.length();return 0===e?(this._x=0,this._y=0,this._z=0,this._w=1):(e=1/e,this._x=this._x*e,this._y=this._y*e,this._z=this._z*e,this._w=this._w*e),this.onChangeCallback(),this},multiply:function(e,t){return void 0!==t?(console.warn("THREE.Quaternion: .multiply() now only accepts one argument. Use .multiplyQuaternions( a, b ) instead."),this.multiplyQuaternions(e,t)):this.multiplyQuaternions(this,e)},premultiply:function(e){return this.multiplyQuaternions(e,this)},multiplyQuaternions:function(e,t){var r=e._x,i=e._y,n=e._z,a=e._w,o=t._x,s=t._y,c=t._z,l=t._w;return this._x=r*l+a*o+i*c-n*s,this._y=i*l+a*s+n*o-r*c,this._z=n*l+a*c+r*s-i*o,this._w=a*l-r*o-i*s-n*c,this.onChangeCallback(),this},slerp:function(e,t){if(0===t)return this;if(1===t)return this.copy(e);var r=this._x,i=this._y,n=this._z,a=this._w,o=a*e._w+r*e._x+i*e._y+n*e._z;if(o<0?(this._w=-e._w,this._x=-e._x,this._y=-e._y,this._z=-e._z,o=-o):this.copy(e),o>=1)return this._w=a,this._x=r,this._y=i,this._z=n,this;var s=Math.sqrt(1-o*o);if(Math.abs(s)<.001)return this._w=.5*(a+this._w),this._x=.5*(r+this._x),this._y=.5*(i+this._y),this._z=.5*(n+this._z),this;var c=Math.atan2(s,o),l=Math.sin((1-t)*c)/s,h=Math.sin(t*c)/s;return this._w=a*l+this._w*h,this._x=r*l+this._x*h,this._y=i*l+this._y*h,this._z=n*l+this._z*h,this.onChangeCallback(),this},equals:function(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._w===this._w},fromArray:function(e,t){return void 0===t&&(t=0),this._x=e[t],this._y=e[t+1],this._z=e[t+2],this._w=e[t+3],this.onChangeCallback(),this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,e},onChange:function(e){return this.onChangeCallback=e,this},onChangeCallback:function(){}},Object.assign(Quaternion,{slerp:function(e,t,r,i){return r.copy(e).slerp(t,i)},slerpFlat:function(e,t,r,i,n,a,o){var s=r[i+0],c=r[i+1],l=r[i+2],h=r[i+3],u=n[a+0],d=n[a+1],p=n[a+2],f=n[a+3];if(h!==f||s!==u||c!==d||l!==p){var m=1-o,g=s*u+c*d+l*p+h*f,v=g>=0?1:-1,y=1-g*g;if(y>Number.EPSILON){var x=Math.sqrt(y),b=Math.atan2(x,g*v);m=Math.sin(m*b)/x,o=Math.sin(o*b)/x}var _=o*v;if(s=s*m+u*_,c=c*m+d*_,l=l*m+p*_,h=h*m+f*_,m===1-o){var M=1/Math.sqrt(s*s+c*c+l*l+h*h);s*=M,c*=M,l*=M,h*=M}}e[t]=s,e[t+1]=c,e[t+2]=l,e[t+3]=h}}),Vector3.prototype={constructor:Vector3,isVector3:!0,set:function(e,t,r){return this.x=e,this.y=t,this.z=r,this},setScalar:function(e){return this.x=e,this.y=e,this.z=e,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setZ:function(e){return this.z=e,this},setComponent:function(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;default:throw new Error("index is out of range: "+e)}return this},getComponent:function(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}},clone:function(){return new this.constructor(this.x,this.y,this.z)},copy:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},add:function(e,t){return void 0!==t?(console.warn("THREE.Vector3: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this.z+=e.z,this)},addScalar:function(e){return this.x+=e,this.y+=e,this.z+=e,this},addVectors:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this},addScaledVector:function(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this},sub:function(e,t){return void 0!==t?(console.warn("THREE.Vector3: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this.z-=e.z,this)},subScalar:function(e){return this.x-=e,this.y-=e,this.z-=e,this},subVectors:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this},multiply:function(e,t){return void 0!==t?(console.warn("THREE.Vector3: .multiply() now only accepts one argument. Use .multiplyVectors( a, b ) instead."),this.multiplyVectors(e,t)):(this.x*=e.x,this.y*=e.y,this.z*=e.z,this)},multiplyScalar:function(e){return isFinite(e)?(this.x*=e,this.y*=e,this.z*=e):(this.x=0,this.y=0,this.z=0),this},multiplyVectors:function(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this},applyEuler:function(){var e;return function applyEuler(t){return!1===(t&&t.isEuler)&&console.error("THREE.Vector3: .applyEuler() now expects an Euler rotation rather than a Vector3 and order."),void 0===e&&(e=new Quaternion),this.applyQuaternion(e.setFromEuler(t))}}(),applyAxisAngle:function(){var e;return function applyAxisAngle(t,r){return void 0===e&&(e=new Quaternion),this.applyQuaternion(e.setFromAxisAngle(t,r))}}(),applyMatrix3:function(e){var t=this.x,r=this.y,i=this.z,n=e.elements;return this.x=n[0]*t+n[3]*r+n[6]*i,this.y=n[1]*t+n[4]*r+n[7]*i,this.z=n[2]*t+n[5]*r+n[8]*i,this},applyMatrix4:function(e){var t=this.x,r=this.y,i=this.z,n=e.elements;return this.x=n[0]*t+n[4]*r+n[8]*i+n[12],this.y=n[1]*t+n[5]*r+n[9]*i+n[13],this.z=n[2]*t+n[6]*r+n[10]*i+n[14],this},applyProjection:function(e){var t=this.x,r=this.y,i=this.z,n=e.elements,a=1/(n[3]*t+n[7]*r+n[11]*i+n[15]);return this.x=(n[0]*t+n[4]*r+n[8]*i+n[12])*a,this.y=(n[1]*t+n[5]*r+n[9]*i+n[13])*a,this.z=(n[2]*t+n[6]*r+n[10]*i+n[14])*a,this},applyQuaternion:function(e){var t=this.x,r=this.y,i=this.z,n=e.x,a=e.y,o=e.z,s=e.w,c=s*t+a*i-o*r,l=s*r+o*t-n*i,h=s*i+n*r-a*t,u=-n*t-a*r-o*i;return this.x=c*s+u*-n+l*-o-h*-a,this.y=l*s+u*-a+h*-n-c*-o,this.z=h*s+u*-o+c*-a-l*-n,this},project:function(){var e;return function project(t){return void 0===e&&(e=new Matrix4),e.multiplyMatrices(t.projectionMatrix,e.getInverse(t.matrixWorld)),this.applyProjection(e)}}(),unproject:function(){var e;return function unproject(t){return void 0===e&&(e=new Matrix4),e.multiplyMatrices(t.matrixWorld,e.getInverse(t.projectionMatrix)),this.applyProjection(e)}}(),transformDirection:function(e){var t=this.x,r=this.y,i=this.z,n=e.elements;return this.x=n[0]*t+n[4]*r+n[8]*i,this.y=n[1]*t+n[5]*r+n[9]*i,this.z=n[2]*t+n[6]*r+n[10]*i,this.normalize()},divide:function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this},divideScalar:function(e){return this.multiplyScalar(1/e)},min:function(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this},max:function(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this},clamp:function(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this},clampScalar:function(){var e,t;return function clampScalar(r,i){return void 0===e&&(e=new Vector3,t=new Vector3),e.set(r,r,r),t.set(i,i,i),this.clamp(e,t)}}(),clampLength:function(e,t){var r=this.length();return this.multiplyScalar(Math.max(e,Math.min(t,r))/r)},floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this},roundToZero:function(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},dot:function(e){return this.x*e.x+this.y*e.y+this.z*e.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},lengthManhattan:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)},normalize:function(){return this.divideScalar(this.length())},setLength:function(e){return this.multiplyScalar(e/this.length())},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this},lerpVectors:function(e,t,r){return this.subVectors(t,e).multiplyScalar(r).add(e)},cross:function(e,t){if(void 0!==t)return console.warn("THREE.Vector3: .cross() now only accepts one argument. Use .crossVectors( a, b ) instead."),this.crossVectors(e,t);var r=this.x,i=this.y,n=this.z;return this.x=i*e.z-n*e.y,this.y=n*e.x-r*e.z,this.z=r*e.y-i*e.x,this},crossVectors:function(e,t){var r=e.x,i=e.y,n=e.z,a=t.x,o=t.y,s=t.z;return this.x=i*s-n*o,this.y=n*a-r*s,this.z=r*o-i*a,this},projectOnVector:function(e){var t=e.dot(this)/e.lengthSq();return this.copy(e).multiplyScalar(t)},projectOnPlane:function(){var e;return function projectOnPlane(t){return void 0===e&&(e=new Vector3),e.copy(this).projectOnVector(t),this.sub(e)}}(),reflect:function(){var e;return function reflect(t){return void 0===e&&(e=new Vector3),this.sub(e.copy(t).multiplyScalar(2*this.dot(t)))}}(),angleTo:function(e){var t=this.dot(e)/Math.sqrt(this.lengthSq()*e.lengthSq());return Math.acos(ut.clamp(t,-1,1))},distanceTo:function(e){return Math.sqrt(this.distanceToSquared(e))},distanceToSquared:function(e){var t=this.x-e.x,r=this.y-e.y,i=this.z-e.z;return t*t+r*r+i*i},distanceToManhattan:function(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)+Math.abs(this.z-e.z)},setFromSpherical:function(e){var t=Math.sin(e.phi)*e.radius;return this.x=t*Math.sin(e.theta),this.y=Math.cos(e.phi)*e.radius,this.z=t*Math.cos(e.theta),this},setFromMatrixPosition:function(e){return this.setFromMatrixColumn(e,3)},setFromMatrixScale:function(e){var t=this.setFromMatrixColumn(e,0).length(),r=this.setFromMatrixColumn(e,1).length(),i=this.setFromMatrixColumn(e,2).length();return this.x=t,this.y=r,this.z=i,this},setFromMatrixColumn:function(e,t){if("number"==typeof e){console.warn("THREE.Vector3: setFromMatrixColumn now expects ( matrix, index ).");var r=e;e=t,t=r}return this.fromArray(e.elements,4*t)},equals:function(e){return e.x===this.x&&e.y===this.y&&e.z===this.z},fromArray:function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this.z=e[t+2],this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e},fromAttribute:function(e,t,r){return void 0===r&&(r=0),t=t*e.itemSize+r,this.x=e.array[t],this.y=e.array[t+1],this.z=e.array[t+2],this}},Matrix4.prototype={constructor:Matrix4,isMatrix4:!0,set:function(e,t,r,i,n,a,o,s,c,l,h,u,d,p,f,m){var g=this.elements;return g[0]=e,g[4]=t,g[8]=r,g[12]=i,g[1]=n,g[5]=a,g[9]=o,g[13]=s,g[2]=c,g[6]=l,g[10]=h,g[14]=u,g[3]=d,g[7]=p,g[11]=f,g[15]=m,this},identity:function(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this},clone:function(){return(new Matrix4).fromArray(this.elements)},copy:function(e){return this.elements.set(e.elements),this},copyPosition:function(e){var t=this.elements,r=e.elements;return t[12]=r[12],t[13]=r[13],t[14]=r[14],this},extractBasis:function(e,t,r){return e.setFromMatrixColumn(this,0),t.setFromMatrixColumn(this,1),r.setFromMatrixColumn(this,2),this},makeBasis:function(e,t,r){return this.set(e.x,t.x,r.x,0,e.y,t.y,r.y,0,e.z,t.z,r.z,0,0,0,0,1),this},extractRotation:function(){var e;return function extractRotation(t){void 0===e&&(e=new Vector3);var r=this.elements,i=t.elements,n=1/e.setFromMatrixColumn(t,0).length(),a=1/e.setFromMatrixColumn(t,1).length(),o=1/e.setFromMatrixColumn(t,2).length();return r[0]=i[0]*n,r[1]=i[1]*n,r[2]=i[2]*n,r[4]=i[4]*a,r[5]=i[5]*a,r[6]=i[6]*a,r[8]=i[8]*o,r[9]=i[9]*o,r[10]=i[10]*o,this}}(),makeRotationFromEuler:function(e){!1===(e&&e.isEuler)&&console.error("THREE.Matrix: .makeRotationFromEuler() now expects a Euler rotation rather than a Vector3 and order.");var t=this.elements,r=e.x,i=e.y,n=e.z,a=Math.cos(r),o=Math.sin(r),s=Math.cos(i),c=Math.sin(i),l=Math.cos(n),h=Math.sin(n);if("XYZ"===e.order){var u=a*l,d=a*h,p=o*l,f=o*h;t[0]=s*l,t[4]=-s*h,t[8]=c,t[1]=d+p*c,t[5]=u-f*c,t[9]=-o*s,t[2]=f-u*c,t[6]=p+d*c,t[10]=a*s}else if("YXZ"===e.order){var m=s*l,g=s*h,v=c*l,y=c*h;t[0]=m+y*o,t[4]=v*o-g,t[8]=a*c,t[1]=a*h,t[5]=a*l,t[9]=-o,t[2]=g*o-v,t[6]=y+m*o,t[10]=a*s}else if("ZXY"===e.order){var m=s*l,g=s*h,v=c*l,y=c*h;t[0]=m-y*o,t[4]=-a*h,t[8]=v+g*o,t[1]=g+v*o,t[5]=a*l,t[9]=y-m*o,t[2]=-a*c,t[6]=o,t[10]=a*s}else if("ZYX"===e.order){var u=a*l,d=a*h,p=o*l,f=o*h;t[0]=s*l,t[4]=p*c-d,t[8]=u*c+f,t[1]=s*h,t[5]=f*c+u,t[9]=d*c-p,t[2]=-c,t[6]=o*s,t[10]=a*s}else if("YZX"===e.order){var x=a*s,b=a*c,_=o*s,M=o*c;t[0]=s*l,t[4]=M-x*h,t[8]=_*h+b,t[1]=h,t[5]=a*l,t[9]=-o*l,t[2]=-c*l,t[6]=b*h+_,t[10]=x-M*h}else if("XZY"===e.order){var x=a*s,b=a*c,_=o*s,M=o*c;t[0]=s*l,t[4]=-h,t[8]=c*l,t[1]=x*h+M,t[5]=a*l,t[9]=b*h-_,t[2]=_*h-b,t[6]=o*l,t[10]=M*h+x}return t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this},makeRotationFromQuaternion:function(e){var t=this.elements,r=e.x,i=e.y,n=e.z,a=e.w,o=r+r,s=i+i,c=n+n,l=r*o,h=r*s,u=r*c,d=i*s,p=i*c,f=n*c,m=a*o,g=a*s,v=a*c;return t[0]=1-(d+f),t[4]=h-v,t[8]=u+g,t[1]=h+v,t[5]=1-(l+f),t[9]=p-m,t[2]=u-g,t[6]=p+m,t[10]=1-(l+d),t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this},lookAt:function(){var e,t,r;return function lookAt(i,n,a){void 0===e&&(e=new Vector3,t=new Vector3,r=new Vector3);var o=this.elements;return r.subVectors(i,n).normalize(),0===r.lengthSq()&&(r.z=1),e.crossVectors(a,r).normalize(),0===e.lengthSq()&&(r.z+=1e-4,e.crossVectors(a,r).normalize()),t.crossVectors(r,e),o[0]=e.x,o[4]=t.x,o[8]=r.x,o[1]=e.y,o[5]=t.y,o[9]=r.y,o[2]=e.z,o[6]=t.z,o[10]=r.z,this}}(),multiply:function(e,t){return void 0!==t?(console.warn("THREE.Matrix4: .multiply() now only accepts one argument. Use .multiplyMatrices( a, b ) instead."),this.multiplyMatrices(e,t)):this.multiplyMatrices(this,e)},premultiply:function(e){return this.multiplyMatrices(e,this)},multiplyMatrices:function(e,t){var r=e.elements,i=t.elements,n=this.elements,a=r[0],o=r[4],s=r[8],c=r[12],l=r[1],h=r[5],u=r[9],d=r[13],p=r[2],f=r[6],m=r[10],g=r[14],v=r[3],y=r[7],x=r[11],b=r[15],_=i[0],M=i[4],w=i[8],T=i[12],S=i[1],E=i[5],A=i[9],L=i[13],P=i[2],C=i[6],R=i[10],B=i[14],I=i[3],G=i[7],D=i[11],U=i[15];return n[0]=a*_+o*S+s*P+c*I,n[4]=a*M+o*E+s*C+c*G,n[8]=a*w+o*A+s*R+c*D,n[12]=a*T+o*L+s*B+c*U,n[1]=l*_+h*S+u*P+d*I,n[5]=l*M+h*E+u*C+d*G,n[9]=l*w+h*A+u*R+d*D,n[13]=l*T+h*L+u*B+d*U,n[2]=p*_+f*S+m*P+g*I,n[6]=p*M+f*E+m*C+g*G,n[10]=p*w+f*A+m*R+g*D,n[14]=p*T+f*L+m*B+g*U,n[3]=v*_+y*S+x*P+b*I,n[7]=v*M+y*E+x*C+b*G,n[11]=v*w+y*A+x*R+b*D,n[15]=v*T+y*L+x*B+b*U,this},multiplyToArray:function(e,t,r){var i=this.elements;return this.multiplyMatrices(e,t),r[0]=i[0],r[1]=i[1],r[2]=i[2],r[3]=i[3],r[4]=i[4],r[5]=i[5],r[6]=i[6],r[7]=i[7],r[8]=i[8],r[9]=i[9],r[10]=i[10],r[11]=i[11],r[12]=i[12],r[13]=i[13],r[14]=i[14],r[15]=i[15],this},multiplyScalar:function(e){var t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this},applyToVector3Array:function(){var e;return function applyToVector3Array(t,r,i){void 0===e&&(e=new Vector3),void 0===r&&(r=0),void 0===i&&(i=t.length);for(var n=0,a=r;n<i;n+=3,a+=3)e.fromArray(t,a),e.applyMatrix4(this),e.toArray(t,a);return t}}(),applyToBuffer:function(){var e;return function applyToBuffer(t,r,i){void 0===e&&(e=new Vector3),void 0===r&&(r=0),void 0===i&&(i=t.length/t.itemSize);for(var n=0,a=r;n<i;n++,a++)e.x=t.getX(a),e.y=t.getY(a),e.z=t.getZ(a),e.applyMatrix4(this),t.setXYZ(a,e.x,e.y,e.z);return t}}(),determinant:function(){var e=this.elements,t=e[0],r=e[4],i=e[8],n=e[12],a=e[1],o=e[5],s=e[9],c=e[13],l=e[2],h=e[6],u=e[10],d=e[14];return e[3]*(+n*s*h-i*c*h-n*o*u+r*c*u+i*o*d-r*s*d)+e[7]*(+t*s*d-t*c*u+n*a*u-i*a*d+i*c*l-n*s*l)+e[11]*(+t*c*h-t*o*d-n*a*h+r*a*d+n*o*l-r*c*l)+e[15]*(-i*o*l-t*s*h+t*o*u+i*a*h-r*a*u+r*s*l)},transpose:function(){var e,t=this.elements;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this},flattenToArrayOffset:function(e,t){return console.warn("THREE.Matrix3: .flattenToArrayOffset is deprecated - just use .toArray instead."),this.toArray(e,t)},getPosition:function(){var e;return function getPosition(){return void 0===e&&(e=new Vector3),console.warn("THREE.Matrix4: .getPosition() has been removed. Use Vector3.setFromMatrixPosition( matrix ) instead."),e.setFromMatrixColumn(this,3)}}(),setPosition:function(e){var t=this.elements;return t[12]=e.x,t[13]=e.y,t[14]=e.z,this},getInverse:function(e,t){var r=this.elements,i=e.elements,n=i[0],a=i[1],o=i[2],s=i[3],c=i[4],l=i[5],h=i[6],u=i[7],d=i[8],p=i[9],f=i[10],m=i[11],g=i[12],v=i[13],y=i[14],x=i[15],b=p*y*u-v*f*u+v*h*m-l*y*m-p*h*x+l*f*x,_=g*f*u-d*y*u-g*h*m+c*y*m+d*h*x-c*f*x,M=d*v*u-g*p*u+g*l*m-c*v*m-d*l*x+c*p*x,w=g*p*h-d*v*h-g*l*f+c*v*f+d*l*y-c*p*y,T=n*b+a*_+o*M+s*w;if(0===T){var S="THREE.Matrix4.getInverse(): can't invert matrix, determinant is 0";if(!0===t)throw new Error(S);return console.warn(S),this.identity()}var E=1/T;return r[0]=b*E,r[1]=(v*f*s-p*y*s-v*o*m+a*y*m+p*o*x-a*f*x)*E,r[2]=(l*y*s-v*h*s+v*o*u-a*y*u-l*o*x+a*h*x)*E,r[3]=(p*h*s-l*f*s-p*o*u+a*f*u+l*o*m-a*h*m)*E,r[4]=_*E,r[5]=(d*y*s-g*f*s+g*o*m-n*y*m-d*o*x+n*f*x)*E,r[6]=(g*h*s-c*y*s-g*o*u+n*y*u+c*o*x-n*h*x)*E,r[7]=(c*f*s-d*h*s+d*o*u-n*f*u-c*o*m+n*h*m)*E,r[8]=M*E,r[9]=(g*p*s-d*v*s-g*a*m+n*v*m+d*a*x-n*p*x)*E,r[10]=(c*v*s-g*l*s+g*a*u-n*v*u-c*a*x+n*l*x)*E,r[11]=(d*l*s-c*p*s-d*a*u+n*p*u+c*a*m-n*l*m)*E,r[12]=w*E,r[13]=(d*v*o-g*p*o+g*a*f-n*v*f-d*a*y+n*p*y)*E,r[14]=(g*l*o-c*v*o-g*a*h+n*v*h+c*a*y-n*l*y)*E,r[15]=(c*p*o-d*l*o+d*a*h-n*p*h-c*a*f+n*l*f)*E,this},scale:function(e){var t=this.elements,r=e.x,i=e.y,n=e.z;return t[0]*=r,t[4]*=i,t[8]*=n,t[1]*=r,t[5]*=i,t[9]*=n,t[2]*=r,t[6]*=i,t[10]*=n,t[3]*=r,t[7]*=i,t[11]*=n,this},getMaxScaleOnAxis:function(){var e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],r=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],i=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,r,i))},makeTranslation:function(e,t,r){return this.set(1,0,0,e,0,1,0,t,0,0,1,r,0,0,0,1),this},makeRotationX:function(e){var t=Math.cos(e),r=Math.sin(e);return this.set(1,0,0,0,0,t,-r,0,0,r,t,0,0,0,0,1),this},makeRotationY:function(e){var t=Math.cos(e),r=Math.sin(e);return this.set(t,0,r,0,0,1,0,0,-r,0,t,0,0,0,0,1),this},makeRotationZ:function(e){var t=Math.cos(e),r=Math.sin(e);return this.set(t,-r,0,0,r,t,0,0,0,0,1,0,0,0,0,1),this},makeRotationAxis:function(e,t){var r=Math.cos(t),i=Math.sin(t),n=1-r,a=e.x,o=e.y,s=e.z,c=n*a,l=n*o;return this.set(c*a+r,c*o-i*s,c*s+i*o,0,c*o+i*s,l*o+r,l*s-i*a,0,c*s-i*o,l*s+i*a,n*s*s+r,0,0,0,0,1),this},makeScale:function(e,t,r){return this.set(e,0,0,0,0,t,0,0,0,0,r,0,0,0,0,1),this},compose:function(e,t,r){return this.makeRotationFromQuaternion(t),this.scale(r),this.setPosition(e),this},decompose:function(){var e,t;return function decompose(r,i,n){void 0===e&&(e=new Vector3,t=new Matrix4);var a=this.elements,o=e.set(a[0],a[1],a[2]).length(),s=e.set(a[4],a[5],a[6]).length(),c=e.set(a[8],a[9],a[10]).length();this.determinant()<0&&(o=-o),r.x=a[12],r.y=a[13],r.z=a[14],t.elements.set(this.elements);var l=1/o,h=1/s,u=1/c;return t.elements[0]*=l,t.elements[1]*=l,t.elements[2]*=l,t.elements[4]*=h,t.elements[5]*=h,t.elements[6]*=h,t.elements[8]*=u,t.elements[9]*=u,t.elements[10]*=u,i.setFromRotationMatrix(t),n.x=o,n.y=s,n.z=c,this}}(),makeFrustum:function(e,t,r,i,n,a){var o=this.elements,s=2*n/(t-e),c=2*n/(i-r),l=(t+e)/(t-e),h=(i+r)/(i-r),u=-(a+n)/(a-n),d=-2*a*n/(a-n);return o[0]=s,o[4]=0,o[8]=l,o[12]=0,o[1]=0,o[5]=c,o[9]=h,o[13]=0,o[2]=0,o[6]=0,o[10]=u,o[14]=d,o[3]=0,o[7]=0,o[11]=-1,o[15]=0,this},makePerspective:function(e,t,r,i){var n=r*Math.tan(ut.DEG2RAD*e*.5),a=-n,o=a*t,s=n*t;return this.makeFrustum(o,s,a,n,r,i)},makeOrthographic:function(e,t,r,i,n,a){var o=this.elements,s=1/(t-e),c=1/(r-i),l=1/(a-n),h=(t+e)*s,u=(r+i)*c,d=(a+n)*l;return o[0]=2*s,o[4]=0,o[8]=0,o[12]=-h,o[1]=0,o[5]=2*c,o[9]=0,o[13]=-u,o[2]=0,o[6]=0,o[10]=-2*l,o[14]=-d,o[3]=0,o[7]=0,o[11]=0,o[15]=1,this},equals:function(e){for(var t=this.elements,r=e.elements,i=0;i<16;i++)if(t[i]!==r[i])return!1;return!0},fromArray:function(e,t){void 0===t&&(t=0);for(var r=0;r<16;r++)this.elements[r]=e[r+t];return this},toArray:function(e,t){void 0===e&&(e=[]),void 0===t&&(t=0);var r=this.elements;return e[t]=r[0],e[t+1]=r[1],e[t+2]=r[2],e[t+3]=r[3],e[t+4]=r[4],e[t+5]=r[5],e[t+6]=r[6],e[t+7]=r[7],e[t+8]=r[8],e[t+9]=r[9],e[t+10]=r[10],e[t+11]=r[11],e[t+12]=r[12],e[t+13]=r[13],e[t+14]=r[14],e[t+15]=r[15],e}},(CubeTexture.prototype=Object.create(Texture.prototype)).constructor=CubeTexture,CubeTexture.prototype.isCubeTexture=!0,Object.defineProperty(CubeTexture.prototype,"images",{get:function(){return this.image},set:function(e){this.image=e}});var pt=new Texture,ft=new CubeTexture,mt=[],gt=[];StructuredUniform.prototype.setValue=function(e,t){for(var r=this.seq,i=0,n=r.length;i!==n;++i){var a=r[i];a.setValue(e,t[a.id])}};var vt=/([\w\d_]+)(\])?(\[|\.)?/g;WebGLUniforms.prototype.setValue=function(e,t,r){var i=this.map[t];void 0!==i&&i.setValue(e,r,this.renderer)},WebGLUniforms.prototype.set=function(e,t,r){var i=this.map[r];void 0!==i&&i.setValue(e,t[r],this.renderer)},WebGLUniforms.prototype.setOptional=function(e,t,r){var i=t[r];void 0!==i&&this.setValue(e,r,i)},WebGLUniforms.upload=function(e,t,r,i){for(var n=0,a=t.length;n!==a;++n){var o=t[n],s=r[o.id];!1!==s.needsUpdate&&o.setValue(e,s.value,i)}},WebGLUniforms.seqWithValue=function(e,t){for(var r=[],i=0,n=e.length;i!==n;++i){var a=e[i];a.id in t&&r.push(a)}return r};var yt={merge:function(e){for(var t={},r=0;r<e.length;r++){var i=this.clone(e[r]);for(var n in i)t[n]=i[n]}return t},clone:function(e){var t={};for(var r in e){t[r]={};for(var i in e[r]){var n=e[r][i];n&&(n.isColor||n.isMatrix3||n.isMatrix4||n.isVector2||n.isVector3||n.isVector4||n.isTexture)?t[r][i]=n.clone():Array.isArray(n)?t[r][i]=n.slice():t[r][i]=n}}return t}},xt={alphamap_fragment:"#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, vUv ).g;\n#endif\n",alphamap_pars_fragment:"#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif\n",alphatest_fragment:"#ifdef ALPHATEST\n\tif ( diffuseColor.a < ALPHATEST ) discard;\n#endif\n",aomap_fragment:"#ifdef USE_AOMAP\n\tfloat ambientOcclusion = ( texture2D( aoMap, vUv2 ).r - 1.0 ) * aoMapIntensity + 1.0;\n\treflectedLight.indirectDiffuse *= ambientOcclusion;\n\t#if defined( USE_ENVMAP ) && defined( PHYSICAL )\n\t\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\t\treflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, material.specularRoughness );\n\t#endif\n#endif\n",aomap_pars_fragment:"#ifdef USE_AOMAP\n\tuniform sampler2D aoMap;\n\tuniform float aoMapIntensity;\n#endif",begin_vertex:"\nvec3 transformed = vec3( position );\n",beginnormal_vertex:"\nvec3 objectNormal = vec3( normal );\n",bsdfs:"bool testLightInRange( const in float lightDistance, const in float cutoffDistance ) {\n\treturn any( bvec2( cutoffDistance == 0.0, lightDistance < cutoffDistance ) );\n}\nfloat punctualLightIntensityToIrradianceFactor( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {\n\t\tif( decayExponent > 0.0 ) {\n#if defined ( PHYSICALLY_CORRECT_LIGHTS )\n\t\t\tfloat distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );\n\t\t\tfloat maxDistanceCutoffFactor = pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );\n\t\t\treturn distanceFalloff * maxDistanceCutoffFactor;\n#else\n\t\t\treturn pow( saturate( -lightDistance / cutoffDistance + 1.0 ), decayExponent );\n#endif\n\t\t}\n\t\treturn 1.0;\n}\nvec3 BRDF_Diffuse_Lambert( const in vec3 diffuseColor ) {\n\treturn RECIPROCAL_PI * diffuseColor;\n}\nvec3 F_Schlick( const in vec3 specularColor, const in float dotLH ) {\n\tfloat fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );\n\treturn ( 1.0 - specularColor ) * fresnel + specularColor;\n}\nfloat G_GGX_Smith( const in float alpha, const in float dotNL, const in float dotNV ) {\n\tfloat a2 = pow2( alpha );\n\tfloat gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\tfloat gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\treturn 1.0 / ( gl * gv );\n}\nfloat G_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {\n\tfloat a2 = pow2( alpha );\n\tfloat gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\tfloat gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\treturn 0.5 / max( gv + gl, EPSILON );\n}\nfloat D_GGX( const in float alpha, const in float dotNH ) {\n\tfloat a2 = pow2( alpha );\n\tfloat denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0;\n\treturn RECIPROCAL_PI * a2 / pow2( denom );\n}\nvec3 BRDF_Specular_GGX( const in IncidentLight incidentLight, const in GeometricContext geometry, const in vec3 specularColor, const in float roughness ) {\n\tfloat alpha = pow2( roughness );\n\tvec3 halfDir = normalize( incidentLight.direction + geometry.viewDir );\n\tfloat dotNL = saturate( dot( geometry.normal, incidentLight.direction ) );\n\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\tfloat dotNH = saturate( dot( geometry.normal, halfDir ) );\n\tfloat dotLH = saturate( dot( incidentLight.direction, halfDir ) );\n\tvec3 F = F_Schlick( specularColor, dotLH );\n\tfloat G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\tfloat D = D_GGX( alpha, dotNH );\n\treturn F * ( G * D );\n}\nvec3 BRDF_Specular_GGX_Environment( const in GeometricContext geometry, const in vec3 specularColor, const in float roughness ) {\n\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\tconst vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );\n\tconst vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );\n\tvec4 r = roughness * c0 + c1;\n\tfloat a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;\n\tvec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;\n\treturn specularColor * AB.x + AB.y;\n}\nfloat G_BlinnPhong_Implicit( ) {\n\treturn 0.25;\n}\nfloat D_BlinnPhong( const in float shininess, const in float dotNH ) {\n\treturn RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );\n}\nvec3 BRDF_Specular_BlinnPhong( const in IncidentLight incidentLight, const in GeometricContext geometry, const in vec3 specularColor, const in float shininess ) {\n\tvec3 halfDir = normalize( incidentLight.direction + geometry.viewDir );\n\tfloat dotNH = saturate( dot( geometry.normal, halfDir ) );\n\tfloat dotLH = saturate( dot( incidentLight.direction, halfDir ) );\n\tvec3 F = F_Schlick( specularColor, dotLH );\n\tfloat G = G_BlinnPhong_Implicit( );\n\tfloat D = D_BlinnPhong( shininess, dotNH );\n\treturn F * ( G * D );\n}\nfloat GGXRoughnessToBlinnExponent( const in float ggxRoughness ) {\n\treturn ( 2.0 / pow2( ggxRoughness + 0.0001 ) - 2.0 );\n}\nfloat BlinnExponentToGGXRoughness( const in float blinnExponent ) {\n\treturn sqrt( 2.0 / ( blinnExponent + 2.0 ) );\n}\n",bumpmap_pars_fragment:"#ifdef USE_BUMPMAP\n\tuniform sampler2D bumpMap;\n\tuniform float bumpScale;\n\tvec2 dHdxy_fwd() {\n\t\tvec2 dSTdx = dFdx( vUv );\n\t\tvec2 dSTdy = dFdy( vUv );\n\t\tfloat Hll = bumpScale * texture2D( bumpMap, vUv ).x;\n\t\tfloat dBx = bumpScale * texture2D( bumpMap, vUv + dSTdx ).x - Hll;\n\t\tfloat dBy = bumpScale * texture2D( bumpMap, vUv + dSTdy ).x - Hll;\n\t\treturn vec2( dBx, dBy );\n\t}\n\tvec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy ) {\n\t\tvec3 vSigmaX = dFdx( surf_pos );\n\t\tvec3 vSigmaY = dFdy( surf_pos );\n\t\tvec3 vN = surf_norm;\n\t\tvec3 R1 = cross( vSigmaY, vN );\n\t\tvec3 R2 = cross( vN, vSigmaX );\n\t\tfloat fDet = dot( vSigmaX, R1 );\n\t\tvec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );\n\t\treturn normalize( abs( fDet ) * surf_norm - vGrad );\n\t}\n#endif\n",clipping_planes_fragment:"#if NUM_CLIPPING_PLANES > 0\n\tfor ( int i = 0; i < UNION_CLIPPING_PLANES; ++ i ) {\n\t\tvec4 plane = clippingPlanes[ i ];\n\t\tif ( dot( vViewPosition, plane.xyz ) > plane.w ) discard;\n\t}\n\t\t\n\t#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n\t\tbool clipped = true;\n\t\tfor ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; ++ i ) {\n\t\t\tvec4 plane = clippingPlanes[ i ];\n\t\t\tclipped = ( dot( vViewPosition, plane.xyz ) > plane.w ) && clipped;\n\t\t}\n\t\tif ( clipped ) discard;\n\t\n\t#endif\n#endif\n",clipping_planes_pars_fragment:"#if NUM_CLIPPING_PLANES > 0\n\t#if ! defined( PHYSICAL ) && ! defined( PHONG )\n\t\tvarying vec3 vViewPosition;\n\t#endif\n\tuniform vec4 clippingPlanes[ NUM_CLIPPING_PLANES ];\n#endif\n",clipping_planes_pars_vertex:"#if NUM_CLIPPING_PLANES > 0 && ! defined( PHYSICAL ) && ! defined( PHONG )\n\tvarying vec3 vViewPosition;\n#endif\n",clipping_planes_vertex:"#if NUM_CLIPPING_PLANES > 0 && ! defined( PHYSICAL ) && ! defined( PHONG )\n\tvViewPosition = - mvPosition.xyz;\n#endif\n",color_fragment:"#ifdef USE_COLOR\n\tdiffuseColor.rgb *= vColor;\n#endif",color_pars_fragment:"#ifdef USE_COLOR\n\tvarying vec3 vColor;\n#endif\n",color_pars_vertex:"#ifdef USE_COLOR\n\tvarying vec3 vColor;\n#endif",color_vertex:"#ifdef USE_COLOR\n\tvColor.xyz = color.xyz;\n#endif",common:"#define PI 3.14159265359\n#define PI2 6.28318530718\n#define RECIPROCAL_PI 0.31830988618\n#define RECIPROCAL_PI2 0.15915494\n#define LOG2 1.442695\n#define EPSILON 1e-6\n#define saturate(a) clamp( a, 0.0, 1.0 )\n#define whiteCompliment(a) ( 1.0 - saturate( a ) )\nfloat pow2( const in float x ) { return x*x; }\nfloat pow3( const in float x ) { return x*x*x; }\nfloat pow4( const in float x ) { float x2 = x*x; return x2*x2; }\nfloat average( const in vec3 color ) { return dot( color, vec3( 0.3333 ) ); }\nhighp float rand( const in vec2 uv ) {\n\tconst highp float a = 12.9898, b = 78.233, c = 43758.5453;\n\thighp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );\n\treturn fract(sin(sn) * c);\n}\nstruct IncidentLight {\n\tvec3 color;\n\tvec3 direction;\n\tbool visible;\n};\nstruct ReflectedLight {\n\tvec3 directDiffuse;\n\tvec3 directSpecular;\n\tvec3 indirectDiffuse;\n\tvec3 indirectSpecular;\n};\nstruct GeometricContext {\n\tvec3 position;\n\tvec3 normal;\n\tvec3 viewDir;\n};\nvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n}\nvec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );\n}\nvec3 projectOnPlane(in vec3 point, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\tfloat distance = dot( planeNormal, point - pointOnPlane );\n\treturn - distance * planeNormal + point;\n}\nfloat sideOfPlane( in vec3 point, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\treturn sign( dot( point - pointOnPlane, planeNormal ) );\n}\nvec3 linePlaneIntersect( in vec3 pointOnLine, in vec3 lineDirection, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\treturn lineDirection * ( dot( planeNormal, pointOnPlane - pointOnLine ) / dot( planeNormal, lineDirection ) ) + pointOnLine;\n}\n",cube_uv_reflection_fragment:"#ifdef ENVMAP_TYPE_CUBE_UV\n#define cubeUV_textureSize (1024.0)\nint getFaceFromDirection(vec3 direction) {\n\tvec3 absDirection = abs(direction);\n\tint face = -1;\n\tif( absDirection.x > absDirection.z ) {\n\t\tif(absDirection.x > absDirection.y )\n\t\t\tface = direction.x > 0.0 ? 0 : 3;\n\t\telse\n\t\t\tface = direction.y > 0.0 ? 1 : 4;\n\t}\n\telse {\n\t\tif(absDirection.z > absDirection.y )\n\t\t\tface = direction.z > 0.0 ? 2 : 5;\n\t\telse\n\t\t\tface = direction.y > 0.0 ? 1 : 4;\n\t}\n\treturn face;\n}\n#define cubeUV_maxLods1  (log2(cubeUV_textureSize*0.25) - 1.0)\n#define cubeUV_rangeClamp (exp2((6.0 - 1.0) * 2.0))\nvec2 MipLevelInfo( vec3 vec, float roughnessLevel, float roughness ) {\n\tfloat scale = exp2(cubeUV_maxLods1 - roughnessLevel);\n\tfloat dxRoughness = dFdx(roughness);\n\tfloat dyRoughness = dFdy(roughness);\n\tvec3 dx = dFdx( vec * scale * dxRoughness );\n\tvec3 dy = dFdy( vec * scale * dyRoughness );\n\tfloat d = max( dot( dx, dx ), dot( dy, dy ) );\n\td = clamp(d, 1.0, cubeUV_rangeClamp);\n\tfloat mipLevel = 0.5 * log2(d);\n\treturn vec2(floor(mipLevel), fract(mipLevel));\n}\n#define cubeUV_maxLods2 (log2(cubeUV_textureSize*0.25) - 2.0)\n#define cubeUV_rcpTextureSize (1.0 / cubeUV_textureSize)\nvec2 getCubeUV(vec3 direction, float roughnessLevel, float mipLevel) {\n\tmipLevel = roughnessLevel > cubeUV_maxLods2 - 3.0 ? 0.0 : mipLevel;\n\tfloat a = 16.0 * cubeUV_rcpTextureSize;\n\tvec2 exp2_packed = exp2( vec2( roughnessLevel, mipLevel ) );\n\tvec2 rcp_exp2_packed = vec2( 1.0 ) / exp2_packed;\n\tfloat powScale = exp2_packed.x * exp2_packed.y;\n\tfloat scale = rcp_exp2_packed.x * rcp_exp2_packed.y * 0.25;\n\tfloat mipOffset = 0.75*(1.0 - rcp_exp2_packed.y) * rcp_exp2_packed.x;\n\tbool bRes = mipLevel == 0.0;\n\tscale =  bRes && (scale < a) ? a : scale;\n\tvec3 r;\n\tvec2 offset;\n\tint face = getFaceFromDirection(direction);\n\tfloat rcpPowScale = 1.0 / powScale;\n\tif( face == 0) {\n\t\tr = vec3(direction.x, -direction.z, direction.y);\n\t\toffset = vec2(0.0+mipOffset,0.75 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ?  a : offset.y;\n\t}\n\telse if( face == 1) {\n\t\tr = vec3(direction.y, direction.x, direction.z);\n\t\toffset = vec2(scale+mipOffset, 0.75 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ?  a : offset.y;\n\t}\n\telse if( face == 2) {\n\t\tr = vec3(direction.z, direction.x, direction.y);\n\t\toffset = vec2(2.0*scale+mipOffset, 0.75 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ?  a : offset.y;\n\t}\n\telse if( face == 3) {\n\t\tr = vec3(direction.x, direction.z, direction.y);\n\t\toffset = vec2(0.0+mipOffset,0.5 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ?  0.0 : offset.y;\n\t}\n\telse if( face == 4) {\n\t\tr = vec3(direction.y, direction.x, -direction.z);\n\t\toffset = vec2(scale+mipOffset, 0.5 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ?  0.0 : offset.y;\n\t}\n\telse {\n\t\tr = vec3(direction.z, -direction.x, direction.y);\n\t\toffset = vec2(2.0*scale+mipOffset, 0.5 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ?  0.0 : offset.y;\n\t}\n\tr = normalize(r);\n\tfloat texelOffset = 0.5 * cubeUV_rcpTextureSize;\n\tvec2 s = ( r.yz / abs( r.x ) + vec2( 1.0 ) ) * 0.5;\n\tvec2 base = offset + vec2( texelOffset );\n\treturn base + s * ( scale - 2.0 * texelOffset );\n}\n#define cubeUV_maxLods3 (log2(cubeUV_textureSize*0.25) - 3.0)\nvec4 textureCubeUV(vec3 reflectedDirection, float roughness ) {\n\tfloat roughnessVal = roughness* cubeUV_maxLods3;\n\tfloat r1 = floor(roughnessVal);\n\tfloat r2 = r1 + 1.0;\n\tfloat t = fract(roughnessVal);\n\tvec2 mipInfo = MipLevelInfo(reflectedDirection, r1, roughness);\n\tfloat s = mipInfo.y;\n\tfloat level0 = mipInfo.x;\n\tfloat level1 = level0 + 1.0;\n\tlevel1 = level1 > 5.0 ? 5.0 : level1;\n\tlevel0 += min( floor( s + 0.5 ), 5.0 );\n\tvec2 uv_10 = getCubeUV(reflectedDirection, r1, level0);\n\tvec4 color10 = envMapTexelToLinear(texture2D(envMap, uv_10));\n\tvec2 uv_20 = getCubeUV(reflectedDirection, r2, level0);\n\tvec4 color20 = envMapTexelToLinear(texture2D(envMap, uv_20));\n\tvec4 result = mix(color10, color20, t);\n\treturn vec4(result.rgb, 1.0);\n}\n#endif\n",defaultnormal_vertex:"#ifdef FLIP_SIDED\n\tobjectNormal = -objectNormal;\n#endif\nvec3 transformedNormal = normalMatrix * objectNormal;\n",displacementmap_pars_vertex:"#ifdef USE_DISPLACEMENTMAP\n\tuniform sampler2D displacementMap;\n\tuniform float displacementScale;\n\tuniform float displacementBias;\n#endif\n",displacementmap_vertex:"#ifdef USE_DISPLACEMENTMAP\n\ttransformed += normal * ( texture2D( displacementMap, uv ).x * displacementScale + displacementBias );\n#endif\n",emissivemap_fragment:"#ifdef USE_EMISSIVEMAP\n\tvec4 emissiveColor = texture2D( emissiveMap, vUv );\n\temissiveColor.rgb = emissiveMapTexelToLinear( emissiveColor ).rgb;\n\ttotalEmissiveRadiance *= emissiveColor.rgb;\n#endif\n",emissivemap_pars_fragment:"#ifdef USE_EMISSIVEMAP\n\tuniform sampler2D emissiveMap;\n#endif\n",encodings_fragment:"  gl_FragColor = linearToOutputTexel( gl_FragColor );\n",encodings_pars_fragment:"\nvec4 LinearToLinear( in vec4 value ) {\n  return value;\n}\nvec4 GammaToLinear( in vec4 value, in float gammaFactor ) {\n  return vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );\n}\nvec4 LinearToGamma( in vec4 value, in float gammaFactor ) {\n  return vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );\n}\nvec4 sRGBToLinear( in vec4 value ) {\n  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );\n}\nvec4 LinearTosRGB( in vec4 value ) {\n  return vec4( mix( pow( value.rgb, vec3( 0.41666 ) ) * 1.055 - vec3( 0.055 ), value.rgb * 12.92, vec3( lessThanEqual( value.rgb, vec3( 0.0031308 ) ) ) ), value.w );\n}\nvec4 RGBEToLinear( in vec4 value ) {\n  return vec4( value.rgb * exp2( value.a * 255.0 - 128.0 ), 1.0 );\n}\nvec4 LinearToRGBE( in vec4 value ) {\n  float maxComponent = max( max( value.r, value.g ), value.b );\n  float fExp = clamp( ceil( log2( maxComponent ) ), -128.0, 127.0 );\n  return vec4( value.rgb / exp2( fExp ), ( fExp + 128.0 ) / 255.0 );\n}\nvec4 RGBMToLinear( in vec4 value, in float maxRange ) {\n  return vec4( value.xyz * value.w * maxRange, 1.0 );\n}\nvec4 LinearToRGBM( in vec4 value, in float maxRange ) {\n  float maxRGB = max( value.x, max( value.g, value.b ) );\n  float M      = clamp( maxRGB / maxRange, 0.0, 1.0 );\n  M            = ceil( M * 255.0 ) / 255.0;\n  return vec4( value.rgb / ( M * maxRange ), M );\n}\nvec4 RGBDToLinear( in vec4 value, in float maxRange ) {\n    return vec4( value.rgb * ( ( maxRange / 255.0 ) / value.a ), 1.0 );\n}\nvec4 LinearToRGBD( in vec4 value, in float maxRange ) {\n    float maxRGB = max( value.x, max( value.g, value.b ) );\n    float D      = max( maxRange / maxRGB, 1.0 );\n    D            = min( floor( D ) / 255.0, 1.0 );\n    return vec4( value.rgb * ( D * ( 255.0 / maxRange ) ), D );\n}\nconst mat3 cLogLuvM = mat3( 0.2209, 0.3390, 0.4184, 0.1138, 0.6780, 0.7319, 0.0102, 0.1130, 0.2969 );\nvec4 LinearToLogLuv( in vec4 value )  {\n  vec3 Xp_Y_XYZp = value.rgb * cLogLuvM;\n  Xp_Y_XYZp = max(Xp_Y_XYZp, vec3(1e-6, 1e-6, 1e-6));\n  vec4 vResult;\n  vResult.xy = Xp_Y_XYZp.xy / Xp_Y_XYZp.z;\n  float Le = 2.0 * log2(Xp_Y_XYZp.y) + 127.0;\n  vResult.w = fract(Le);\n  vResult.z = (Le - (floor(vResult.w*255.0))/255.0)/255.0;\n  return vResult;\n}\nconst mat3 cLogLuvInverseM = mat3( 6.0014, -2.7008, -1.7996, -1.3320, 3.1029, -5.7721, 0.3008, -1.0882, 5.6268 );\nvec4 LogLuvToLinear( in vec4 value ) {\n  float Le = value.z * 255.0 + value.w;\n  vec3 Xp_Y_XYZp;\n  Xp_Y_XYZp.y = exp2((Le - 127.0) / 2.0);\n  Xp_Y_XYZp.z = Xp_Y_XYZp.y / value.y;\n  Xp_Y_XYZp.x = value.x * Xp_Y_XYZp.z;\n  vec3 vRGB = Xp_Y_XYZp.rgb * cLogLuvInverseM;\n  return vec4( max(vRGB, 0.0), 1.0 );\n}\n",envmap_fragment:"#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG )\n\t\tvec3 cameraToVertex = normalize( vWorldPosition - cameraPosition );\n\t\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvec3 reflectVec = reflect( cameraToVertex, worldNormal );\n\t\t#else\n\t\t\tvec3 reflectVec = refract( cameraToVertex, worldNormal, refractionRatio );\n\t\t#endif\n\t#else\n\t\tvec3 reflectVec = vReflect;\n\t#endif\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tvec4 envColor = textureCube( envMap, flipNormal * vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );\n\t#elif defined( ENVMAP_TYPE_EQUIREC )\n\t\tvec2 sampleUV;\n\t\tsampleUV.y = saturate( flipNormal * reflectVec.y * 0.5 + 0.5 );\n\t\tsampleUV.x = atan( flipNormal * reflectVec.z, flipNormal * reflectVec.x ) * RECIPROCAL_PI2 + 0.5;\n\t\tvec4 envColor = texture2D( envMap, sampleUV );\n\t#elif defined( ENVMAP_TYPE_SPHERE )\n\t\tvec3 reflectView = flipNormal * normalize( ( viewMatrix * vec4( reflectVec, 0.0 ) ).xyz + vec3( 0.0, 0.0, 1.0 ) );\n\t\tvec4 envColor = texture2D( envMap, reflectView.xy * 0.5 + 0.5 );\n\t#else\n\t\tvec4 envColor = vec4( 0.0 );\n\t#endif\n\tenvColor = envMapTexelToLinear( envColor );\n\t#ifdef ENVMAP_BLENDING_MULTIPLY\n\t\toutgoingLight = mix( outgoingLight, outgoingLight * envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_MIX )\n\t\toutgoingLight = mix( outgoingLight, envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_ADD )\n\t\toutgoingLight += envColor.xyz * specularStrength * reflectivity;\n\t#endif\n#endif\n",envmap_pars_fragment:"#if defined( USE_ENVMAP ) || defined( PHYSICAL )\n\tuniform float reflectivity;\n\tuniform float envMapIntenstiy;\n#endif\n#ifdef USE_ENVMAP\n\t#if ! defined( PHYSICAL ) && ( defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) )\n\t\tvarying vec3 vWorldPosition;\n\t#endif\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tuniform samplerCube envMap;\n\t#else\n\t\tuniform sampler2D envMap;\n\t#endif\n\tuniform float flipEnvMap;\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( PHYSICAL )\n\t\tuniform float refractionRatio;\n\t#else\n\t\tvarying vec3 vReflect;\n\t#endif\n#endif\n",envmap_pars_vertex:"#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG )\n\t\tvarying vec3 vWorldPosition;\n\t#else\n\t\tvarying vec3 vReflect;\n\t\tuniform float refractionRatio;\n\t#endif\n#endif\n",envmap_vertex:"#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG )\n\t\tvWorldPosition = worldPosition.xyz;\n\t#else\n\t\tvec3 cameraToVertex = normalize( worldPosition.xyz - cameraPosition );\n\t\tvec3 worldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvReflect = reflect( cameraToVertex, worldNormal );\n\t\t#else\n\t\t\tvReflect = refract( cameraToVertex, worldNormal, refractionRatio );\n\t\t#endif\n\t#endif\n#endif\n",fog_fragment:"#ifdef USE_FOG\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tfloat depth = gl_FragDepthEXT / gl_FragCoord.w;\n\t#else\n\t\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n\t#endif\n\t#ifdef FOG_EXP2\n\t\tfloat fogFactor = whiteCompliment( exp2( - fogDensity * fogDensity * depth * depth * LOG2 ) );\n\t#else\n\t\tfloat fogFactor = smoothstep( fogNear, fogFar, depth );\n\t#endif\n\tgl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n#endif\n",fog_pars_fragment:"#ifdef USE_FOG\n\tuniform vec3 fogColor;\n\t#ifdef FOG_EXP2\n\t\tuniform float fogDensity;\n\t#else\n\t\tuniform float fogNear;\n\t\tuniform float fogFar;\n\t#endif\n#endif",lightmap_fragment:"#ifdef USE_LIGHTMAP\n\treflectedLight.indirectDiffuse += PI * texture2D( lightMap, vUv2 ).xyz * lightMapIntensity;\n#endif\n",lightmap_pars_fragment:"#ifdef USE_LIGHTMAP\n\tuniform sampler2D lightMap;\n\tuniform float lightMapIntensity;\n#endif",lights_lambert_vertex:"vec3 diffuse = vec3( 1.0 );\nGeometricContext geometry;\ngeometry.position = mvPosition.xyz;\ngeometry.normal = normalize( transformedNormal );\ngeometry.viewDir = normalize( -mvPosition.xyz );\nGeometricContext backGeometry;\nbackGeometry.position = geometry.position;\nbackGeometry.normal = -geometry.normal;\nbackGeometry.viewDir = geometry.viewDir;\nvLightFront = vec3( 0.0 );\n#ifdef DOUBLE_SIDED\n\tvLightBack = vec3( 0.0 );\n#endif\nIncidentLight directLight;\nfloat dotNL;\nvec3 directLightColor_Diffuse;\n#if NUM_POINT_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tgetPointDirectLightIrradiance( pointLights[ i ], geometry, directLight );\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t#endif\n\t}\n#endif\n#if NUM_SPOT_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tgetSpotDirectLightIrradiance( spotLights[ i ], geometry, directLight );\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t#endif\n\t}\n#endif\n#if NUM_DIR_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tgetDirectionalDirectLightIrradiance( directionalLights[ i ], geometry, directLight );\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t#endif\n\t}\n#endif\n#if NUM_HEMI_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\t\tvLightFront += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += getHemisphereLightIrradiance( hemisphereLights[ i ], backGeometry );\n\t\t#endif\n\t}\n#endif\n",lights_pars:"uniform vec3 ambientLightColor;\nvec3 getAmbientLightIrradiance( const in vec3 ambientLightColor ) {\n\tvec3 irradiance = ambientLightColor;\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\treturn irradiance;\n}\n#if NUM_DIR_LIGHTS > 0\n\tstruct DirectionalLight {\n\t\tvec3 direction;\n\t\tvec3 color;\n\t\tint shadow;\n\t\tfloat shadowBias;\n\t\tfloat shadowRadius;\n\t\tvec2 shadowMapSize;\n\t};\n\tuniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];\n\tvoid getDirectionalDirectLightIrradiance( const in DirectionalLight directionalLight, const in GeometricContext geometry, out IncidentLight directLight ) {\n\t\tdirectLight.color = directionalLight.color;\n\t\tdirectLight.direction = directionalLight.direction;\n\t\tdirectLight.visible = true;\n\t}\n#endif\n#if NUM_POINT_LIGHTS > 0\n\tstruct PointLight {\n\t\tvec3 position;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t\tint shadow;\n\t\tfloat shadowBias;\n\t\tfloat shadowRadius;\n\t\tvec2 shadowMapSize;\n\t};\n\tuniform PointLight pointLights[ NUM_POINT_LIGHTS ];\n\tvoid getPointDirectLightIrradiance( const in PointLight pointLight, const in GeometricContext geometry, out IncidentLight directLight ) {\n\t\tvec3 lVector = pointLight.position - geometry.position;\n\t\tdirectLight.direction = normalize( lVector );\n\t\tfloat lightDistance = length( lVector );\n\t\tif ( testLightInRange( lightDistance, pointLight.distance ) ) {\n\t\t\tdirectLight.color = pointLight.color;\n\t\t\tdirectLight.color *= punctualLightIntensityToIrradianceFactor( lightDistance, pointLight.distance, pointLight.decay );\n\t\t\tdirectLight.visible = true;\n\t\t} else {\n\t\t\tdirectLight.color = vec3( 0.0 );\n\t\t\tdirectLight.visible = false;\n\t\t}\n\t}\n#endif\n#if NUM_SPOT_LIGHTS > 0\n\tstruct SpotLight {\n\t\tvec3 position;\n\t\tvec3 direction;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t\tfloat coneCos;\n\t\tfloat penumbraCos;\n\t\tint shadow;\n\t\tfloat shadowBias;\n\t\tfloat shadowRadius;\n\t\tvec2 shadowMapSize;\n\t};\n\tuniform SpotLight spotLights[ NUM_SPOT_LIGHTS ];\n\tvoid getSpotDirectLightIrradiance( const in SpotLight spotLight, const in GeometricContext geometry, out IncidentLight directLight  ) {\n\t\tvec3 lVector = spotLight.position - geometry.position;\n\t\tdirectLight.direction = normalize( lVector );\n\t\tfloat lightDistance = length( lVector );\n\t\tfloat angleCos = dot( directLight.direction, spotLight.direction );\n\t\tif ( all( bvec2( angleCos > spotLight.coneCos, testLightInRange( lightDistance, spotLight.distance ) ) ) ) {\n\t\t\tfloat spotEffect = smoothstep( spotLight.coneCos, spotLight.penumbraCos, angleCos );\n\t\t\tdirectLight.color = spotLight.color;\n\t\t\tdirectLight.color *= spotEffect * punctualLightIntensityToIrradianceFactor( lightDistance, spotLight.distance, spotLight.decay );\n\t\t\tdirectLight.visible = true;\n\t\t} else {\n\t\t\tdirectLight.color = vec3( 0.0 );\n\t\t\tdirectLight.visible = false;\n\t\t}\n\t}\n#endif\n#if NUM_HEMI_LIGHTS > 0\n\tstruct HemisphereLight {\n\t\tvec3 direction;\n\t\tvec3 skyColor;\n\t\tvec3 groundColor;\n\t};\n\tuniform HemisphereLight hemisphereLights[ NUM_HEMI_LIGHTS ];\n\tvec3 getHemisphereLightIrradiance( const in HemisphereLight hemiLight, const in GeometricContext geometry ) {\n\t\tfloat dotNL = dot( geometry.normal, hemiLight.direction );\n\t\tfloat hemiDiffuseWeight = 0.5 * dotNL + 0.5;\n\t\tvec3 irradiance = mix( hemiLight.groundColor, hemiLight.skyColor, hemiDiffuseWeight );\n\t\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\t\tirradiance *= PI;\n\t\t#endif\n\t\treturn irradiance;\n\t}\n#endif\n#if defined( USE_ENVMAP ) && defined( PHYSICAL )\n\tvec3 getLightProbeIndirectIrradiance( const in GeometricContext geometry, const in int maxMIPLevel ) {\n\t\t#include <normal_flip>\n\t\tvec3 worldNormal = inverseTransformDirection( geometry.normal, viewMatrix );\n\t\t#ifdef ENVMAP_TYPE_CUBE\n\t\t\tvec3 queryVec = flipNormal * vec3( flipEnvMap * worldNormal.x, worldNormal.yz );\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = textureCubeLodEXT( envMap, queryVec, float( maxMIPLevel ) );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = textureCube( envMap, queryVec, float( maxMIPLevel ) );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\t\tvec3 queryVec = flipNormal * vec3( flipEnvMap * worldNormal.x, worldNormal.yz );\n\t\t\tvec4 envMapColor = textureCubeUV( queryVec, 1.0 );\n\t\t#else\n\t\t\tvec4 envMapColor = vec4( 0.0 );\n\t\t#endif\n\t\treturn PI * envMapColor.rgb * envMapIntensity;\n\t}\n\tfloat getSpecularMIPLevel( const in float blinnShininessExponent, const in int maxMIPLevel ) {\n\t\tfloat maxMIPLevelScalar = float( maxMIPLevel );\n\t\tfloat desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( pow2( blinnShininessExponent ) + 1.0 );\n\t\treturn clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );\n\t}\n\tvec3 getLightProbeIndirectRadiance( const in GeometricContext geometry, const in float blinnShininessExponent, const in int maxMIPLevel ) {\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvec3 reflectVec = reflect( -geometry.viewDir, geometry.normal );\n\t\t#else\n\t\t\tvec3 reflectVec = refract( -geometry.viewDir, geometry.normal, refractionRatio );\n\t\t#endif\n\t\t#include <normal_flip>\n\t\treflectVec = inverseTransformDirection( reflectVec, viewMatrix );\n\t\tfloat specularMIPLevel = getSpecularMIPLevel( blinnShininessExponent, maxMIPLevel );\n\t\t#ifdef ENVMAP_TYPE_CUBE\n\t\t\tvec3 queryReflectVec = flipNormal * vec3( flipEnvMap * reflectVec.x, reflectVec.yz );\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = textureCubeLodEXT( envMap, queryReflectVec, specularMIPLevel );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = textureCube( envMap, queryReflectVec, specularMIPLevel );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\t\tvec3 queryReflectVec = flipNormal * vec3( flipEnvMap * reflectVec.x, reflectVec.yz );\n\t\t\tvec4 envMapColor = textureCubeUV(queryReflectVec, BlinnExponentToGGXRoughness(blinnShininessExponent));\n\t\t#elif defined( ENVMAP_TYPE_EQUIREC )\n\t\t\tvec2 sampleUV;\n\t\t\tsampleUV.y = saturate( flipNormal * reflectVec.y * 0.5 + 0.5 );\n\t\t\tsampleUV.x = atan( flipNormal * reflectVec.z, flipNormal * reflectVec.x ) * RECIPROCAL_PI2 + 0.5;\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = texture2DLodEXT( envMap, sampleUV, specularMIPLevel );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = texture2D( envMap, sampleUV, specularMIPLevel );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#elif defined( ENVMAP_TYPE_SPHERE )\n\t\t\tvec3 reflectView = flipNormal * normalize( ( viewMatrix * vec4( reflectVec, 0.0 ) ).xyz + vec3( 0.0,0.0,1.0 ) );\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = texture2DLodEXT( envMap, reflectView.xy * 0.5 + 0.5, specularMIPLevel );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = texture2D( envMap, reflectView.xy * 0.5 + 0.5, specularMIPLevel );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#endif\n\t\treturn envMapColor.rgb * envMapIntensity;\n\t}\n#endif\n",lights_phong_fragment:"BlinnPhongMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nmaterial.specularColor = specular;\nmaterial.specularShininess = shininess;\nmaterial.specularStrength = specularStrength;\n",lights_phong_pars_fragment:"varying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\nstruct BlinnPhongMaterial {\n\tvec3\tdiffuseColor;\n\tvec3\tspecularColor;\n\tfloat\tspecularShininess;\n\tfloat\tspecularStrength;\n};\nvoid RE_Direct_BlinnPhong( const in IncidentLight directLight, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometry.normal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\treflectedLight.directDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n\treflectedLight.directSpecular += irradiance * BRDF_Specular_BlinnPhong( directLight, geometry, material.specularColor, material.specularShininess ) * material.specularStrength;\n}\nvoid RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_BlinnPhong\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_BlinnPhong\n#define Material_LightProbeLOD( material )\t(0)\n",lights_physical_fragment:"PhysicalMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb * ( 1.0 - metalnessFactor );\nmaterial.specularRoughness = clamp( roughnessFactor, 0.04, 1.0 );\n#ifdef STANDARD\n\tmaterial.specularColor = mix( vec3( DEFAULT_SPECULAR_COEFFICIENT ), diffuseColor.rgb, metalnessFactor );\n#else\n\tmaterial.specularColor = mix( vec3( MAXIMUM_SPECULAR_COEFFICIENT * pow2( reflectivity ) ), diffuseColor.rgb, metalnessFactor );\n\tmaterial.clearCoat = saturate( clearCoat );\tmaterial.clearCoatRoughness = clamp( clearCoatRoughness, 0.04, 1.0 );\n#endif\n",lights_physical_pars_fragment:"struct PhysicalMaterial {\n\tvec3\tdiffuseColor;\n\tfloat\tspecularRoughness;\n\tvec3\tspecularColor;\n\t#ifndef STANDARD\n\t\tfloat clearCoat;\n\t\tfloat clearCoatRoughness;\n\t#endif\n};\n#define MAXIMUM_SPECULAR_COEFFICIENT 0.16\n#define DEFAULT_SPECULAR_COEFFICIENT 0.04\nfloat clearCoatDHRApprox( const in float roughness, const in float dotNL ) {\n\treturn DEFAULT_SPECULAR_COEFFICIENT + ( 1.0 - DEFAULT_SPECULAR_COEFFICIENT ) * ( pow( 1.0 - dotNL, 5.0 ) * pow( 1.0 - roughness, 2.0 ) );\n}\nvoid RE_Direct_Physical( const in IncidentLight directLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometry.normal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\t#ifndef STANDARD\n\t\tfloat clearCoatDHR = material.clearCoat * clearCoatDHRApprox( material.clearCoatRoughness, dotNL );\n\t#else\n\t\tfloat clearCoatDHR = 0.0;\n\t#endif\n\treflectedLight.directSpecular += ( 1.0 - clearCoatDHR ) * irradiance * BRDF_Specular_GGX( directLight, geometry, material.specularColor, material.specularRoughness );\n\treflectedLight.directDiffuse += ( 1.0 - clearCoatDHR ) * irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n\t#ifndef STANDARD\n\t\treflectedLight.directSpecular += irradiance * material.clearCoat * BRDF_Specular_GGX( directLight, geometry, vec3( DEFAULT_SPECULAR_COEFFICIENT ), material.clearCoatRoughness );\n\t#endif\n}\nvoid RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectSpecular_Physical( const in vec3 radiance, const in vec3 clearCoatRadiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\t#ifndef STANDARD\n\t\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\t\tfloat dotNL = dotNV;\n\t\tfloat clearCoatDHR = material.clearCoat * clearCoatDHRApprox( material.clearCoatRoughness, dotNL );\n\t#else\n\t\tfloat clearCoatDHR = 0.0;\n\t#endif\n\treflectedLight.indirectSpecular += ( 1.0 - clearCoatDHR ) * radiance * BRDF_Specular_GGX_Environment( geometry, material.specularColor, material.specularRoughness );\n\t#ifndef STANDARD\n\t\treflectedLight.indirectSpecular += clearCoatRadiance * material.clearCoat * BRDF_Specular_GGX_Environment( geometry, vec3( DEFAULT_SPECULAR_COEFFICIENT ), material.clearCoatRoughness );\n\t#endif\n}\n#define RE_Direct\t\t\t\tRE_Direct_Physical\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Physical\n#define RE_IndirectSpecular\t\tRE_IndirectSpecular_Physical\n#define Material_BlinnShininessExponent( material )   GGXRoughnessToBlinnExponent( material.specularRoughness )\n#define Material_ClearCoat_BlinnShininessExponent( material )   GGXRoughnessToBlinnExponent( material.clearCoatRoughness )\nfloat computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {\n\treturn saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );\n}\n",lights_template:"\nGeometricContext geometry;\ngeometry.position = - vViewPosition;\ngeometry.normal = normal;\ngeometry.viewDir = normalize( vViewPosition );\nIncidentLight directLight;\n#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )\n\tPointLight pointLight;\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tpointLight = pointLights[ i ];\n\t\tgetPointDirectLightIrradiance( pointLight, geometry, directLight );\n\t\t#ifdef USE_SHADOWMAP\n\t\tdirectLight.color *= all( bvec2( pointLight.shadow, directLight.visible ) ) ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n#endif\n#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )\n\tSpotLight spotLight;\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tspotLight = spotLights[ i ];\n\t\tgetSpotDirectLightIrradiance( spotLight, geometry, directLight );\n\t\t#ifdef USE_SHADOWMAP\n\t\tdirectLight.color *= all( bvec2( spotLight.shadow, directLight.visible ) ) ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n#endif\n#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )\n\tDirectionalLight directionalLight;\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tdirectionalLight = directionalLights[ i ];\n\t\tgetDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );\n\t\t#ifdef USE_SHADOWMAP\n\t\tdirectLight.color *= all( bvec2( directionalLight.shadow, directLight.visible ) ) ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n#endif\n#if defined( RE_IndirectDiffuse )\n\tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );\n\t#ifdef USE_LIGHTMAP\n\t\tvec3 lightMapIrradiance = texture2D( lightMap, vUv2 ).xyz * lightMapIntensity;\n\t\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\t\tlightMapIrradiance *= PI;\n\t\t#endif\n\t\tirradiance += lightMapIrradiance;\n\t#endif\n\t#if ( NUM_HEMI_LIGHTS > 0 )\n\t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\t\t\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );\n\t\t}\n\t#endif\n\t#if defined( USE_ENVMAP ) && defined( PHYSICAL ) && defined( ENVMAP_TYPE_CUBE_UV )\n\t \tirradiance += getLightProbeIndirectIrradiance( geometry, 8 );\n\t#endif\n\tRE_IndirectDiffuse( irradiance, geometry, material, reflectedLight );\n#endif\n#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )\n\tvec3 radiance = getLightProbeIndirectRadiance( geometry, Material_BlinnShininessExponent( material ), 8 );\n\t#ifndef STANDARD\n\t\tvec3 clearCoatRadiance = getLightProbeIndirectRadiance( geometry, Material_ClearCoat_BlinnShininessExponent( material ), 8 );\n\t#else\n\t\tvec3 clearCoatRadiance = vec3( 0.0 );\n\t#endif\n\t\t\n\tRE_IndirectSpecular( radiance, clearCoatRadiance, geometry, material, reflectedLight );\n#endif\n",logdepthbuf_fragment:"#if defined(USE_LOGDEPTHBUF) && defined(USE_LOGDEPTHBUF_EXT)\n\tgl_FragDepthEXT = log2(vFragDepth) * logDepthBufFC * 0.5;\n#endif",logdepthbuf_pars_fragment:"#ifdef USE_LOGDEPTHBUF\n\tuniform float logDepthBufFC;\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvarying float vFragDepth;\n\t#endif\n#endif\n",logdepthbuf_pars_vertex:"#ifdef USE_LOGDEPTHBUF\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvarying float vFragDepth;\n\t#endif\n\tuniform float logDepthBufFC;\n#endif",logdepthbuf_vertex:"#ifdef USE_LOGDEPTHBUF\n\tgl_Position.z = log2(max( EPSILON, gl_Position.w + 1.0 )) * logDepthBufFC;\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvFragDepth = 1.0 + gl_Position.w;\n\t#else\n\t\tgl_Position.z = (gl_Position.z - 1.0) * gl_Position.w;\n\t#endif\n#endif\n",map_fragment:"#ifdef USE_MAP\n\tvec4 texelColor = texture2D( map, vUv );\n\ttexelColor = mapTexelToLinear( texelColor );\n\tdiffuseColor *= texelColor;\n#endif\n",map_pars_fragment:"#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif\n",map_particle_fragment:"#ifdef USE_MAP\n\tvec4 mapTexel = texture2D( map, vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y ) * offsetRepeat.zw + offsetRepeat.xy );\n\tdiffuseColor *= mapTexelToLinear( mapTexel );\n#endif\n",map_particle_pars_fragment:"#ifdef USE_MAP\n\tuniform vec4 offsetRepeat;\n\tuniform sampler2D map;\n#endif\n",metalnessmap_fragment:"float metalnessFactor = metalness;\n#ifdef USE_METALNESSMAP\n\tvec4 texelMetalness = texture2D( metalnessMap, vUv );\n\tmetalnessFactor *= texelMetalness.r;\n#endif\n",metalnessmap_pars_fragment:"#ifdef USE_METALNESSMAP\n\tuniform sampler2D metalnessMap;\n#endif",morphnormal_vertex:"#ifdef USE_MORPHNORMALS\n\tobjectNormal += ( morphNormal0 - normal ) * morphTargetInfluences[ 0 ];\n\tobjectNormal += ( morphNormal1 - normal ) * morphTargetInfluences[ 1 ];\n\tobjectNormal += ( morphNormal2 - normal ) * morphTargetInfluences[ 2 ];\n\tobjectNormal += ( morphNormal3 - normal ) * morphTargetInfluences[ 3 ];\n#endif\n",morphtarget_pars_vertex:"#ifdef USE_MORPHTARGETS\n\t#ifndef USE_MORPHNORMALS\n\tuniform float morphTargetInfluences[ 8 ];\n\t#else\n\tuniform float morphTargetInfluences[ 4 ];\n\t#endif\n#endif",morphtarget_vertex:"#ifdef USE_MORPHTARGETS\n\ttransformed += ( morphTarget0 - position ) * morphTargetInfluences[ 0 ];\n\ttransformed += ( morphTarget1 - position ) * morphTargetInfluences[ 1 ];\n\ttransformed += ( morphTarget2 - position ) * morphTargetInfluences[ 2 ];\n\ttransformed += ( morphTarget3 - position ) * morphTargetInfluences[ 3 ];\n\t#ifndef USE_MORPHNORMALS\n\ttransformed += ( morphTarget4 - position ) * morphTargetInfluences[ 4 ];\n\ttransformed += ( morphTarget5 - position ) * morphTargetInfluences[ 5 ];\n\ttransformed += ( morphTarget6 - position ) * morphTargetInfluences[ 6 ];\n\ttransformed += ( morphTarget7 - position ) * morphTargetInfluences[ 7 ];\n\t#endif\n#endif\n",normal_flip:"#ifdef DOUBLE_SIDED\n\tfloat flipNormal = ( float( gl_FrontFacing ) * 2.0 - 1.0 );\n#else\n\tfloat flipNormal = 1.0;\n#endif\n",normal_fragment:"#ifdef FLAT_SHADED\n\tvec3 fdx = vec3( dFdx( vViewPosition.x ), dFdx( vViewPosition.y ), dFdx( vViewPosition.z ) );\n\tvec3 fdy = vec3( dFdy( vViewPosition.x ), dFdy( vViewPosition.y ), dFdy( vViewPosition.z ) );\n\tvec3 normal = normalize( cross( fdx, fdy ) );\n#else\n\tvec3 normal = normalize( vNormal ) * flipNormal;\n#endif\n#ifdef USE_NORMALMAP\n\tnormal = perturbNormal2Arb( -vViewPosition, normal );\n#elif defined( USE_BUMPMAP )\n\tnormal = perturbNormalArb( -vViewPosition, normal, dHdxy_fwd() );\n#endif\n",normalmap_pars_fragment:"#ifdef USE_NORMALMAP\n\tuniform sampler2D normalMap;\n\tuniform vec2 normalScale;\n\tvec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm ) {\n\t\tvec3 q0 = dFdx( eye_pos.xyz );\n\t\tvec3 q1 = dFdy( eye_pos.xyz );\n\t\tvec2 st0 = dFdx( vUv.st );\n\t\tvec2 st1 = dFdy( vUv.st );\n\t\tvec3 S = normalize( q0 * st1.t - q1 * st0.t );\n\t\tvec3 T = normalize( -q0 * st1.s + q1 * st0.s );\n\t\tvec3 N = normalize( surf_norm );\n\t\tvec3 mapN = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;\n\t\tmapN.xy = normalScale * mapN.xy;\n\t\tmat3 tsn = mat3( S, T, N );\n\t\treturn normalize( tsn * mapN );\n\t}\n#endif\n",packing:"vec3 packNormalToRGB( const in vec3 normal ) {\n  return normalize( normal ) * 0.5 + 0.5;\n}\nvec3 unpackRGBToNormal( const in vec3 rgb ) {\n  return 1.0 - 2.0 * rgb.xyz;\n}\nconst float PackUpscale = 256. / 255.;const float UnpackDownscale = 255. / 256.;\nconst vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );\nconst vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\nconst float ShiftRight8 = 1. / 256.;\nvec4 packDepthToRGBA( const in float v ) {\n\tvec4 r = vec4( fract( v * PackFactors ), v );\n\tr.yzw -= r.xyz * ShiftRight8;\treturn r * PackUpscale;\n}\nfloat unpackRGBAToDepth( const in vec4 v ) {\n\treturn dot( v, UnpackFactors );\n}\nfloat viewZToOrthographicDepth( const in float viewZ, const in float near, const in float far ) {\n  return ( viewZ + near ) / ( near - far );\n}\nfloat orthographicDepthToViewZ( const in float linearClipZ, const in float near, const in float far ) {\n  return linearClipZ * ( near - far ) - near;\n}\nfloat viewZToPerspectiveDepth( const in float viewZ, const in float near, const in float far ) {\n  return (( near + viewZ ) * far ) / (( far - near ) * viewZ );\n}\nfloat perspectiveDepthToViewZ( const in float invClipZ, const in float near, const in float far ) {\n  return ( near * far ) / ( ( far - near ) * invClipZ - far );\n}\n",premultiplied_alpha_fragment:"#ifdef PREMULTIPLIED_ALPHA\n\tgl_FragColor.rgb *= gl_FragColor.a;\n#endif\n",project_vertex:"#ifdef USE_SKINNING\n\tvec4 mvPosition = modelViewMatrix * skinned;\n#else\n\tvec4 mvPosition = modelViewMatrix * vec4( transformed, 1.0 );\n#endif\ngl_Position = projectionMatrix * mvPosition;\n",roughnessmap_fragment:"float roughnessFactor = roughness;\n#ifdef USE_ROUGHNESSMAP\n\tvec4 texelRoughness = texture2D( roughnessMap, vUv );\n\troughnessFactor *= texelRoughness.r;\n#endif\n",roughnessmap_pars_fragment:"#ifdef USE_ROUGHNESSMAP\n\tuniform sampler2D roughnessMap;\n#endif",shadowmap_pars_fragment:"#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHTS > 0\n\t\tuniform sampler2D directionalShadowMap[ NUM_DIR_LIGHTS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHTS ];\n\t#endif\n\t#if NUM_SPOT_LIGHTS > 0\n\t\tuniform sampler2D spotShadowMap[ NUM_SPOT_LIGHTS ];\n\t\tvarying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHTS ];\n\t#endif\n\t#if NUM_POINT_LIGHTS > 0\n\t\tuniform sampler2D pointShadowMap[ NUM_POINT_LIGHTS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHTS ];\n\t#endif\n\tfloat texture2DCompare( sampler2D depths, vec2 uv, float compare ) {\n\t\treturn step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );\n\t}\n\tfloat texture2DShadowLerp( sampler2D depths, vec2 size, vec2 uv, float compare ) {\n\t\tconst vec2 offset = vec2( 0.0, 1.0 );\n\t\tvec2 texelSize = vec2( 1.0 ) / size;\n\t\tvec2 centroidUV = floor( uv * size + 0.5 ) / size;\n\t\tfloat lb = texture2DCompare( depths, centroidUV + texelSize * offset.xx, compare );\n\t\tfloat lt = texture2DCompare( depths, centroidUV + texelSize * offset.xy, compare );\n\t\tfloat rb = texture2DCompare( depths, centroidUV + texelSize * offset.yx, compare );\n\t\tfloat rt = texture2DCompare( depths, centroidUV + texelSize * offset.yy, compare );\n\t\tvec2 f = fract( uv * size + 0.5 );\n\t\tfloat a = mix( lb, lt, f.y );\n\t\tfloat b = mix( rb, rt, f.y );\n\t\tfloat c = mix( a, b, f.x );\n\t\treturn c;\n\t}\n\tfloat getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord ) {\n\t\tshadowCoord.xyz /= shadowCoord.w;\n\t\tshadowCoord.z += shadowBias;\n\t\tbvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );\n\t\tbool inFrustum = all( inFrustumVec );\n\t\tbvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );\n\t\tbool frustumTest = all( frustumTestVec );\n\t\tif ( frustumTest ) {\n\t\t#if defined( SHADOWMAP_TYPE_PCF )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx0 = - texelSize.x * shadowRadius;\n\t\t\tfloat dy0 = - texelSize.y * shadowRadius;\n\t\t\tfloat dx1 = + texelSize.x * shadowRadius;\n\t\t\tfloat dy1 = + texelSize.y * shadowRadius;\n\t\t\treturn (\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_PCF_SOFT )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx0 = - texelSize.x * shadowRadius;\n\t\t\tfloat dy0 = - texelSize.y * shadowRadius;\n\t\t\tfloat dx1 = + texelSize.x * shadowRadius;\n\t\t\tfloat dy1 = + texelSize.y * shadowRadius;\n\t\t\treturn (\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy, shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#else\n\t\t\treturn texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#endif\n\t\t}\n\t\treturn 1.0;\n\t}\n\tvec2 cubeToUV( vec3 v, float texelSizeY ) {\n\t\tvec3 absV = abs( v );\n\t\tfloat scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );\n\t\tabsV *= scaleToCube;\n\t\tv *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );\n\t\tvec2 planar = v.xy;\n\t\tfloat almostATexel = 1.5 * texelSizeY;\n\t\tfloat almostOne = 1.0 - almostATexel;\n\t\tif ( absV.z >= almostOne ) {\n\t\t\tif ( v.z > 0.0 )\n\t\t\t\tplanar.x = 4.0 - v.x;\n\t\t} else if ( absV.x >= almostOne ) {\n\t\t\tfloat signX = sign( v.x );\n\t\t\tplanar.x = v.z * signX + 2.0 * signX;\n\t\t} else if ( absV.y >= almostOne ) {\n\t\t\tfloat signY = sign( v.y );\n\t\t\tplanar.x = v.x + 2.0 * signY + 2.0;\n\t\t\tplanar.y = v.z * signY - 2.0;\n\t\t}\n\t\treturn vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );\n\t}\n\tfloat getPointShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord ) {\n\t\tvec2 texelSize = vec2( 1.0 ) / ( shadowMapSize * vec2( 4.0, 2.0 ) );\n\t\tvec3 lightToPosition = shadowCoord.xyz;\n\t\tvec3 bd3D = normalize( lightToPosition );\n\t\tfloat dp = ( length( lightToPosition ) - shadowBias ) / 1000.0;\n\t\t#if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT )\n\t\t\tvec2 offset = vec2( - 1, 1 ) * shadowRadius * texelSize.y;\n\t\t\treturn (\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxx, texelSize.y ), dp )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#else\n\t\t\treturn texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp );\n\t\t#endif\n\t}\n#endif\n",shadowmap_pars_vertex:"#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHTS > 0\n\t\tuniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHTS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHTS ];\n\t#endif\n\t#if NUM_SPOT_LIGHTS > 0\n\t\tuniform mat4 spotShadowMatrix[ NUM_SPOT_LIGHTS ];\n\t\tvarying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHTS ];\n\t#endif\n\t#if NUM_POINT_LIGHTS > 0\n\t\tuniform mat4 pointShadowMatrix[ NUM_POINT_LIGHTS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHTS ];\n\t#endif\n#endif\n",shadowmap_vertex:"#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tvDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * worldPosition;\n\t}\n\t#endif\n\t#if NUM_SPOT_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tvSpotShadowCoord[ i ] = spotShadowMatrix[ i ] * worldPosition;\n\t}\n\t#endif\n\t#if NUM_POINT_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tvPointShadowCoord[ i ] = pointShadowMatrix[ i ] * worldPosition;\n\t}\n\t#endif\n#endif\n",shadowmask_pars_fragment:"float getShadowMask() {\n\tfloat shadow = 1.0;\n\t#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHTS > 0\n\tDirectionalLight directionalLight;\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tdirectionalLight = directionalLights[ i ];\n\t\tshadow *= bool( directionalLight.shadow ) ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t}\n\t#endif\n\t#if NUM_SPOT_LIGHTS > 0\n\tSpotLight spotLight;\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tspotLight = spotLights[ i ];\n\t\tshadow *= bool( spotLight.shadow ) ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;\n\t}\n\t#endif\n\t#if NUM_POINT_LIGHTS > 0\n\tPointLight pointLight;\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tpointLight = pointLights[ i ];\n\t\tshadow *= bool( pointLight.shadow ) ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ] ) : 1.0;\n\t}\n\t#endif\n\t#endif\n\treturn shadow;\n}\n",skinbase_vertex:"#ifdef USE_SKINNING\n\tmat4 boneMatX = getBoneMatrix( skinIndex.x );\n\tmat4 boneMatY = getBoneMatrix( skinIndex.y );\n\tmat4 boneMatZ = getBoneMatrix( skinIndex.z );\n\tmat4 boneMatW = getBoneMatrix( skinIndex.w );\n#endif",skinning_pars_vertex:"#ifdef USE_SKINNING\n\tuniform mat4 bindMatrix;\n\tuniform mat4 bindMatrixInverse;\n\t#ifdef BONE_TEXTURE\n\t\tuniform sampler2D boneTexture;\n\t\tuniform int boneTextureWidth;\n\t\tuniform int boneTextureHeight;\n\t\tmat4 getBoneMatrix( const in float i ) {\n\t\t\tfloat j = i * 4.0;\n\t\t\tfloat x = mod( j, float( boneTextureWidth ) );\n\t\t\tfloat y = floor( j / float( boneTextureWidth ) );\n\t\t\tfloat dx = 1.0 / float( boneTextureWidth );\n\t\t\tfloat dy = 1.0 / float( boneTextureHeight );\n\t\t\ty = dy * ( y + 0.5 );\n\t\t\tvec4 v1 = texture2D( boneTexture, vec2( dx * ( x + 0.5 ), y ) );\n\t\t\tvec4 v2 = texture2D( boneTexture, vec2( dx * ( x + 1.5 ), y ) );\n\t\t\tvec4 v3 = texture2D( boneTexture, vec2( dx * ( x + 2.5 ), y ) );\n\t\t\tvec4 v4 = texture2D( boneTexture, vec2( dx * ( x + 3.5 ), y ) );\n\t\t\tmat4 bone = mat4( v1, v2, v3, v4 );\n\t\t\treturn bone;\n\t\t}\n\t#else\n\t\tuniform mat4 boneMatrices[ MAX_BONES ];\n\t\tmat4 getBoneMatrix( const in float i ) {\n\t\t\tmat4 bone = boneMatrices[ int(i) ];\n\t\t\treturn bone;\n\t\t}\n\t#endif\n#endif\n",skinning_vertex:"#ifdef USE_SKINNING\n\tvec4 skinVertex = bindMatrix * vec4( transformed, 1.0 );\n\tvec4 skinned = vec4( 0.0 );\n\tskinned += boneMatX * skinVertex * skinWeight.x;\n\tskinned += boneMatY * skinVertex * skinWeight.y;\n\tskinned += boneMatZ * skinVertex * skinWeight.z;\n\tskinned += boneMatW * skinVertex * skinWeight.w;\n\tskinned  = bindMatrixInverse * skinned;\n#endif\n",skinnormal_vertex:"#ifdef USE_SKINNING\n\tmat4 skinMatrix = mat4( 0.0 );\n\tskinMatrix += skinWeight.x * boneMatX;\n\tskinMatrix += skinWeight.y * boneMatY;\n\tskinMatrix += skinWeight.z * boneMatZ;\n\tskinMatrix += skinWeight.w * boneMatW;\n\tskinMatrix  = bindMatrixInverse * skinMatrix * bindMatrix;\n\tobjectNormal = vec4( skinMatrix * vec4( objectNormal, 0.0 ) ).xyz;\n#endif\n",specularmap_fragment:"float specularStrength;\n#ifdef USE_SPECULARMAP\n\tvec4 texelSpecular = texture2D( specularMap, vUv );\n\tspecularStrength = texelSpecular.r;\n#else\n\tspecularStrength = 1.0;\n#endif",specularmap_pars_fragment:"#ifdef USE_SPECULARMAP\n\tuniform sampler2D specularMap;\n#endif",tonemapping_fragment:"#if defined( TONE_MAPPING )\n  gl_FragColor.rgb = toneMapping( gl_FragColor.rgb );\n#endif\n",tonemapping_pars_fragment:"#define saturate(a) clamp( a, 0.0, 1.0 )\nuniform float toneMappingExposure;\nuniform float toneMappingWhitePoint;\nvec3 LinearToneMapping( vec3 color ) {\n  return toneMappingExposure * color;\n}\nvec3 ReinhardToneMapping( vec3 color ) {\n  color *= toneMappingExposure;\n  return saturate( color / ( vec3( 1.0 ) + color ) );\n}\n#define Uncharted2Helper( x ) max( ( ( x * ( 0.15 * x + 0.10 * 0.50 ) + 0.20 * 0.02 ) / ( x * ( 0.15 * x + 0.50 ) + 0.20 * 0.30 ) ) - 0.02 / 0.30, vec3( 0.0 ) )\nvec3 Uncharted2ToneMapping( vec3 color ) {\n  color *= toneMappingExposure;\n  return saturate( Uncharted2Helper( color ) / Uncharted2Helper( vec3( toneMappingWhitePoint ) ) );\n}\nvec3 OptimizedCineonToneMapping( vec3 color ) {\n  color *= toneMappingExposure;\n  color = max( vec3( 0.0 ), color - 0.004 );\n  return pow( ( color * ( 6.2 * color + 0.5 ) ) / ( color * ( 6.2 * color + 1.7 ) + 0.06 ), vec3( 2.2 ) );\n}\n",uv_pars_fragment:"#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )\n\tvarying vec2 vUv;\n#endif",uv_pars_vertex:"#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )\n\tvarying vec2 vUv;\n\tuniform vec4 offsetRepeat;\n#endif\n",uv_vertex:"#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )\n\tvUv = uv * offsetRepeat.zw + offsetRepeat.xy;\n#endif",uv2_pars_fragment:"#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tvarying vec2 vUv2;\n#endif",uv2_pars_vertex:"#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tattribute vec2 uv2;\n\tvarying vec2 vUv2;\n#endif",uv2_vertex:"#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tvUv2 = uv2;\n#endif",worldpos_vertex:"#if defined( USE_ENVMAP ) || defined( PHONG ) || defined( PHYSICAL ) || defined( LAMBERT ) || defined ( USE_SHADOWMAP )\n\t#ifdef USE_SKINNING\n\t\tvec4 worldPosition = modelMatrix * skinned;\n\t#else\n\t\tvec4 worldPosition = modelMatrix * vec4( transformed, 1.0 );\n\t#endif\n#endif\n",cube_frag:"uniform samplerCube tCube;\nuniform float tFlip;\nuniform float opacity;\nvarying vec3 vWorldPosition;\n#include <common>\nvoid main() {\n\tgl_FragColor = textureCube( tCube, vec3( tFlip * vWorldPosition.x, vWorldPosition.yz ) );\n\tgl_FragColor.a *= opacity;\n}\n",cube_vert:"varying vec3 vWorldPosition;\n#include <common>\nvoid main() {\n\tvWorldPosition = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n}\n",depth_frag:"#if DEPTH_PACKING == 3200\n\tuniform float opacity;\n#endif\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#if DEPTH_PACKING == 3200\n\t\tdiffuseColor.a = opacity;\n\t#endif\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <logdepthbuf_fragment>\n\t#if DEPTH_PACKING == 3200\n\t\tgl_FragColor = vec4( vec3( gl_FragCoord.z ), opacity );\n\t#elif DEPTH_PACKING == 3201\n\t\tgl_FragColor = packDepthToRGBA( gl_FragCoord.z );\n\t#endif\n}\n",depth_vert:"#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <skinbase_vertex>\n\t#include <begin_vertex>\n\t#include <displacementmap_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n}\n",distanceRGBA_frag:"uniform vec3 lightPos;\nvarying vec4 vWorldPosition;\n#include <common>\n#include <packing>\n#include <clipping_planes_pars_fragment>\nvoid main () {\n\t#include <clipping_planes_fragment>\n\tgl_FragColor = packDepthToRGBA( length( vWorldPosition.xyz - lightPos.xyz ) / 1000.0 );\n}\n",distanceRGBA_vert:"varying vec4 vWorldPosition;\n#include <common>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <skinbase_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\tvWorldPosition = worldPosition;\n}\n",equirect_frag:"uniform sampler2D tEquirect;\nuniform float tFlip;\nvarying vec3 vWorldPosition;\n#include <common>\nvoid main() {\n\tvec3 direction = normalize( vWorldPosition );\n\tvec2 sampleUV;\n\tsampleUV.y = saturate( tFlip * direction.y * -0.5 + 0.5 );\n\tsampleUV.x = atan( direction.z, direction.x ) * RECIPROCAL_PI2 + 0.5;\n\tgl_FragColor = texture2D( tEquirect, sampleUV );\n}\n",equirect_vert:"varying vec3 vWorldPosition;\n#include <common>\nvoid main() {\n\tvWorldPosition = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n}\n",linedashed_frag:"uniform vec3 diffuse;\nuniform float opacity;\nuniform float dashSize;\nuniform float totalSize;\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tif ( mod( vLineDistance, totalSize ) > dashSize ) {\n\t\tdiscard;\n\t}\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <color_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <premultiplied_alpha_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n}\n",linedashed_vert:"uniform float scale;\nattribute float lineDistance;\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <color_vertex>\n\tvLineDistance = scale * lineDistance;\n\tvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n\tgl_Position = projectionMatrix * mvPosition;\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n}\n",meshbasic_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\tReflectedLight reflectedLight;\n\treflectedLight.directDiffuse = vec3( 0.0 );\n\treflectedLight.directSpecular = vec3( 0.0 );\n\treflectedLight.indirectDiffuse = diffuseColor.rgb;\n\treflectedLight.indirectSpecular = vec3( 0.0 );\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.indirectDiffuse;\n\t#include <normal_flip>\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <premultiplied_alpha_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n}\n",meshbasic_vert:"#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_ENVMAP\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <envmap_vertex>\n}\n",meshlambert_frag:"uniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\nvarying vec3 vLightFront;\n#ifdef DOUBLE_SIDED\n\tvarying vec3 vLightBack;\n#endif\n#include <common>\n#include <packing>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_pars_fragment>\n#include <bsdfs>\n#include <lights_pars>\n#include <fog_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\t#include <emissivemap_fragment>\n\treflectedLight.indirectDiffuse = getAmbientLightIrradiance( ambientLightColor );\n\t#include <lightmap_fragment>\n\treflectedLight.indirectDiffuse *= BRDF_Diffuse_Lambert( diffuseColor.rgb );\n\t#ifdef DOUBLE_SIDED\n\t\treflectedLight.directDiffuse = ( gl_FrontFacing ) ? vLightFront : vLightBack;\n\t#else\n\t\treflectedLight.directDiffuse = vLightFront;\n\t#endif\n\treflectedLight.directDiffuse *= BRDF_Diffuse_Lambert( diffuseColor.rgb ) * getShadowMask();\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\t#include <normal_flip>\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <premultiplied_alpha_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n}\n",meshlambert_vert:"#define LAMBERT\nvarying vec3 vLightFront;\n#ifdef DOUBLE_SIDED\n\tvarying vec3 vLightBack;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <bsdfs>\n#include <lights_pars>\n#include <color_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <lights_lambert_vertex>\n\t#include <shadowmap_vertex>\n}\n",meshphong_frag:"#define PHONG\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 specular;\nuniform float shininess;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_flip>\n\t#include <normal_fragment>\n\t#include <emissivemap_fragment>\n\t#include <lights_phong_fragment>\n\t#include <lights_template>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <premultiplied_alpha_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n}\n",meshphong_vert:"#define PHONG\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n#endif\n\t#include <begin_vertex>\n\t#include <displacementmap_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n}\n",meshphysical_frag:"#define PHYSICAL\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\n#ifndef STANDARD\n\tuniform float clearCoat;\n\tuniform float clearCoatRoughness;\n#endif\nuniform float envMapIntensity;\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <packing>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <cube_uv_reflection_fragment>\n#include <lights_pars>\n#include <lights_physical_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <roughnessmap_pars_fragment>\n#include <metalnessmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\t#include <roughnessmap_fragment>\n\t#include <metalnessmap_fragment>\n\t#include <normal_flip>\n\t#include <normal_fragment>\n\t#include <emissivemap_fragment>\n\t#include <lights_physical_fragment>\n\t#include <lights_template>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <premultiplied_alpha_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n}\n",meshphysical_vert:"#define PHYSICAL\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n#endif\n\t#include <begin_vertex>\n\t#include <displacementmap_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n}\n",normal_frag:"uniform float opacity;\nvarying vec3 vNormal;\n#include <common>\n#include <packing>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tgl_FragColor = vec4( packNormalToRGB( vNormal ), opacity );\n\t#include <logdepthbuf_fragment>\n}\n",normal_vert:"varying vec3 vNormal;\n#include <common>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\tvNormal = normalize( normalMatrix * normal );\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n}\n",points_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <color_pars_fragment>\n#include <map_particle_pars_fragment>\n#include <fog_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_particle_fragment>\n\t#include <color_fragment>\n\t#include <alphatest_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <premultiplied_alpha_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n}\n",points_vert:"uniform float size;\nuniform float scale;\n#include <common>\n#include <color_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <color_vertex>\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\t#ifdef USE_SIZEATTENUATION\n\t\tgl_PointSize = size * ( scale / - mvPosition.z );\n\t#else\n\t\tgl_PointSize = size;\n\t#endif\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n}\n",shadow_frag:"uniform float opacity;\n#include <common>\n#include <packing>\n#include <bsdfs>\n#include <lights_pars>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\nvoid main() {\n\tgl_FragColor = vec4( 0.0, 0.0, 0.0, opacity * ( 1.0  - getShadowMask() ) );\n}\n",shadow_vert:"#include <shadowmap_pars_vertex>\nvoid main() {\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n}\n"};Color.prototype={constructor:Color,isColor:!0,r:1,g:1,b:1,set:function(e){return e&&e.isColor?this.copy(e):"number"==typeof e?this.setHex(e):"string"==typeof e&&this.setStyle(e),this},setScalar:function(e){return this.r=e,this.g=e,this.b=e,this},setHex:function(e){return e=Math.floor(e),this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(255&e)/255,this},setRGB:function(e,t,r){return this.r=e,this.g=t,this.b=r,this},setHSL:function(){function hue2rgb(e,t,r){return r<0&&(r+=1),r>1&&(r-=1),r<1/6?e+6*(t-e)*r:r<.5?t:r<2/3?e+6*(t-e)*(2/3-r):e}return function setHSL(e,t,r){if(e=ut.euclideanModulo(e,1),t=ut.clamp(t,0,1),r=ut.clamp(r,0,1),0===t)this.r=this.g=this.b=r;else{var i=r<=.5?r*(1+t):r+t-r*t,n=2*r-i;this.r=hue2rgb(n,i,e+1/3),this.g=hue2rgb(n,i,e),this.b=hue2rgb(n,i,e-1/3)}return this}}(),setStyle:function(e){function handleAlpha(t){void 0!==t&&parseFloat(t)<1&&console.warn("THREE.Color: Alpha component of "+e+" will be ignored.")}var t;if(t=/^((?:rgb|hsl)a?)\(\s*([^\)]*)\)/.exec(e)){var r,i=t[1],n=t[2];switch(i){case"rgb":case"rgba":if(r=/^(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(,\s*([0-9]*\.?[0-9]+)\s*)?$/.exec(n))return this.r=Math.min(255,parseInt(r[1],10))/255,this.g=Math.min(255,parseInt(r[2],10))/255,this.b=Math.min(255,parseInt(r[3],10))/255,handleAlpha(r[5]),this;if(r=/^(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(,\s*([0-9]*\.?[0-9]+)\s*)?$/.exec(n))return this.r=Math.min(100,parseInt(r[1],10))/100,this.g=Math.min(100,parseInt(r[2],10))/100,this.b=Math.min(100,parseInt(r[3],10))/100,handleAlpha(r[5]),this;break;case"hsl":case"hsla":if(r=/^([0-9]*\.?[0-9]+)\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(,\s*([0-9]*\.?[0-9]+)\s*)?$/.exec(n)){var a=parseFloat(r[1])/360,o=parseInt(r[2],10)/100,s=parseInt(r[3],10)/100;return handleAlpha(r[5]),this.setHSL(a,o,s)}}}else if(t=/^\#([A-Fa-f0-9]+)$/.exec(e)){var c=(l=t[1]).length;if(3===c)return this.r=parseInt(l.charAt(0)+l.charAt(0),16)/255,this.g=parseInt(l.charAt(1)+l.charAt(1),16)/255,this.b=parseInt(l.charAt(2)+l.charAt(2),16)/255,this;if(6===c)return this.r=parseInt(l.charAt(0)+l.charAt(1),16)/255,this.g=parseInt(l.charAt(2)+l.charAt(3),16)/255,this.b=parseInt(l.charAt(4)+l.charAt(5),16)/255,this}if(e&&e.length>0){var l=bt[e];void 0!==l?this.setHex(l):console.warn("THREE.Color: Unknown color "+e)}return this},clone:function(){return new this.constructor(this.r,this.g,this.b)},copy:function(e){return this.r=e.r,this.g=e.g,this.b=e.b,this},copyGammaToLinear:function(e,t){return void 0===t&&(t=2),this.r=Math.pow(e.r,t),this.g=Math.pow(e.g,t),this.b=Math.pow(e.b,t),this},copyLinearToGamma:function(e,t){void 0===t&&(t=2);var r=t>0?1/t:1;return this.r=Math.pow(e.r,r),this.g=Math.pow(e.g,r),this.b=Math.pow(e.b,r),this},convertGammaToLinear:function(){var e=this.r,t=this.g,r=this.b;return this.r=e*e,this.g=t*t,this.b=r*r,this},convertLinearToGamma:function(){return this.r=Math.sqrt(this.r),this.g=Math.sqrt(this.g),this.b=Math.sqrt(this.b),this},getHex:function(){return 255*this.r<<16^255*this.g<<8^255*this.b<<0},getHexString:function(){return("000000"+this.getHex().toString(16)).slice(-6)},getHSL:function(e){var t,r,i=e||{h:0,s:0,l:0},n=this.r,a=this.g,o=this.b,s=Math.max(n,a,o),c=Math.min(n,a,o),l=(c+s)/2;if(c===s)t=0,r=0;else{var h=s-c;switch(r=l<=.5?h/(s+c):h/(2-s-c),s){case n:t=(a-o)/h+(a<o?6:0);break;case a:t=(o-n)/h+2;break;case o:t=(n-a)/h+4}t/=6}return i.h=t,i.s=r,i.l=l,i},getStyle:function(){return"rgb("+(255*this.r|0)+","+(255*this.g|0)+","+(255*this.b|0)+")"},offsetHSL:function(e,t,r){var i=this.getHSL();return i.h+=e,i.s+=t,i.l+=r,this.setHSL(i.h,i.s,i.l),this},add:function(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this},addColors:function(e,t){return this.r=e.r+t.r,this.g=e.g+t.g,this.b=e.b+t.b,this},addScalar:function(e){return this.r+=e,this.g+=e,this.b+=e,this},sub:function(e){return this.r=Math.max(0,this.r-e.r),this.g=Math.max(0,this.g-e.g),this.b=Math.max(0,this.b-e.b),this},multiply:function(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this},multiplyScalar:function(e){return this.r*=e,this.g*=e,this.b*=e,this},lerp:function(e,t){return this.r+=(e.r-this.r)*t,this.g+=(e.g-this.g)*t,this.b+=(e.b-this.b)*t,this},equals:function(e){return e.r===this.r&&e.g===this.g&&e.b===this.b},fromArray:function(e,t){return void 0===t&&(t=0),this.r=e[t],this.g=e[t+1],this.b=e[t+2],this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e},toJSON:function(){return this.getHex()}};var bt={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},_t={common:{diffuse:{value:new Color(15658734)},opacity:{value:1},map:{value:null},offsetRepeat:{value:new Vector4(0,0,1,1)},specularMap:{value:null},alphaMap:{value:null},envMap:{value:null},flipEnvMap:{value:-1},reflectivity:{value:1},refractionRatio:{value:.98}},aomap:{aoMap:{value:null},aoMapIntensity:{value:1}},lightmap:{lightMap:{value:null},lightMapIntensity:{value:1}},emissivemap:{emissiveMap:{value:null}},bumpmap:{bumpMap:{value:null},bumpScale:{value:1}},normalmap:{normalMap:{value:null},normalScale:{value:new Vector2(1,1)}},displacementmap:{displacementMap:{value:null},displacementScale:{value:1},displacementBias:{value:0}},roughnessmap:{roughnessMap:{value:null}},metalnessmap:{metalnessMap:{value:null}},fog:{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new Color(16777215)}},lights:{ambientLightColor:{value:[]},directionalLights:{value:[],properties:{direction:{},color:{},shadow:{},shadowBias:{},shadowRadius:{},shadowMapSize:{}}},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotLights:{value:[],properties:{color:{},position:{},direction:{},distance:{},coneCos:{},penumbraCos:{},decay:{},shadow:{},shadowBias:{},shadowRadius:{},shadowMapSize:{}}},spotShadowMap:{value:[]},spotShadowMatrix:{value:[]},pointLights:{value:[],properties:{color:{},position:{},decay:{},distance:{},shadow:{},shadowBias:{},shadowRadius:{},shadowMapSize:{}}},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},hemisphereLights:{value:[],properties:{direction:{},skyColor:{},groundColor:{}}}},points:{diffuse:{value:new Color(15658734)},opacity:{value:1},size:{value:1},scale:{value:1},map:{value:null},offsetRepeat:{value:new Vector4(0,0,1,1)}}},Mt={basic:{uniforms:yt.merge([_t.common,_t.aomap,_t.fog]),vertexShader:xt.meshbasic_vert,fragmentShader:xt.meshbasic_frag},lambert:{uniforms:yt.merge([_t.common,_t.aomap,_t.lightmap,_t.emissivemap,_t.fog,_t.lights,{emissive:{value:new Color(0)}}]),vertexShader:xt.meshlambert_vert,fragmentShader:xt.meshlambert_frag},phong:{uniforms:yt.merge([_t.common,_t.aomap,_t.lightmap,_t.emissivemap,_t.bumpmap,_t.normalmap,_t.displacementmap,_t.fog,_t.lights,{emissive:{value:new Color(0)},specular:{value:new Color(1118481)},shininess:{value:30}}]),vertexShader:xt.meshphong_vert,fragmentShader:xt.meshphong_frag},standard:{uniforms:yt.merge([_t.common,_t.aomap,_t.lightmap,_t.emissivemap,_t.bumpmap,_t.normalmap,_t.displacementmap,_t.roughnessmap,_t.metalnessmap,_t.fog,_t.lights,{emissive:{value:new Color(0)},roughness:{value:.5},metalness:{value:0},envMapIntensity:{value:1}}]),vertexShader:xt.meshphysical_vert,fragmentShader:xt.meshphysical_frag},points:{uniforms:yt.merge([_t.points,_t.fog]),vertexShader:xt.points_vert,fragmentShader:xt.points_frag},dashed:{uniforms:yt.merge([_t.common,_t.fog,{scale:{value:1},dashSize:{value:1},totalSize:{value:2}}]),vertexShader:xt.linedashed_vert,fragmentShader:xt.linedashed_frag},depth:{uniforms:yt.merge([_t.common,_t.displacementmap]),vertexShader:xt.depth_vert,fragmentShader:xt.depth_frag},normal:{uniforms:{opacity:{value:1}},vertexShader:xt.normal_vert,fragmentShader:xt.normal_frag},cube:{uniforms:{tCube:{value:null},tFlip:{value:-1},opacity:{value:1}},vertexShader:xt.cube_vert,fragmentShader:xt.cube_frag},equirect:{uniforms:{tEquirect:{value:null},tFlip:{value:-1}},vertexShader:xt.equirect_vert,fragmentShader:xt.equirect_frag},distanceRGBA:{uniforms:{lightPos:{value:new Vector3}},vertexShader:xt.distanceRGBA_vert,fragmentShader:xt.distanceRGBA_frag}};Mt.physical={uniforms:yt.merge([Mt.standard.uniforms,{clearCoat:{value:0},clearCoatRoughness:{value:0}}]),vertexShader:xt.meshphysical_vert,fragmentShader:xt.meshphysical_frag},Box2.prototype={constructor:Box2,set:function(e,t){return this.min.copy(e),this.max.copy(t),this},setFromPoints:function(e){this.makeEmpty();for(var t=0,r=e.length;t<r;t++)this.expandByPoint(e[t]);return this},setFromCenterAndSize:function(){var e=new Vector2;return function setFromCenterAndSize(t,r){var i=e.copy(r).multiplyScalar(.5);return this.min.copy(t).sub(i),this.max.copy(t).add(i),this}}(),clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.min.copy(e.min),this.max.copy(e.max),this},makeEmpty:function(){return this.min.x=this.min.y=1/0,this.max.x=this.max.y=-1/0,this},isEmpty:function(){return this.max.x<this.min.x||this.max.y<this.min.y},getCenter:function(e){var t=e||new Vector2;return this.isEmpty()?t.set(0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)},getSize:function(e){var t=e||new Vector2;return this.isEmpty()?t.set(0,0):t.subVectors(this.max,this.min)},expandByPoint:function(e){return this.min.min(e),this.max.max(e),this},expandByVector:function(e){return this.min.sub(e),this.max.add(e),this},expandByScalar:function(e){return this.min.addScalar(-e),this.max.addScalar(e),this},containsPoint:function(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y)},containsBox:function(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y},getParameter:function(e,t){return(t||new Vector2).set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y))},intersectsBox:function(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y)},clampPoint:function(e,t){return(t||new Vector2).copy(e).clamp(this.min,this.max)},distanceToPoint:function(){var e=new Vector2;return function distanceToPoint(t){return e.copy(t).clamp(this.min,this.max).sub(t).length()}}(),intersect:function(e){return this.min.max(e.min),this.max.min(e.max),this},union:function(e){return this.min.min(e.min),this.max.max(e.max),this},translate:function(e){return this.min.add(e),this.max.add(e),this},equals:function(e){return e.min.equals(this.min)&&e.max.equals(this.max)}},Material.prototype={constructor:Material,isMaterial:!0,get needsUpdate(){return this._needsUpdate},set needsUpdate(e){!0===e&&this.update(),this._needsUpdate=e},setValues:function(e){if(void 0!==e)for(var t in e){var r=e[t];if(void 0!==r){var i=this[t];void 0!==i?i&&i.isColor?i.set(r):i&&i.isVector3&&r&&r.isVector3?i.copy(r):this[t]="overdraw"===t?Number(r):r:console.warn("THREE."+this.type+": '"+t+"' is not a property of this material.")}else console.warn("THREE.Material: '"+t+"' parameter is undefined.")}},toJSON:function(e){function extractFromCache(e){var t=[];for(var r in e){var i=e[r];delete i.metadata,t.push(i)}return t}var t=void 0===e;t&&(e={textures:{},images:{}});var r={metadata:{version:4.4,type:"Material",generator:"Material.toJSON"}};if(r.uuid=this.uuid,r.type=this.type,""!==this.name&&(r.name=this.name),this.color&&this.color.isColor&&(r.color=this.color.getHex()),void 0!==this.roughness&&(r.roughness=this.roughness),void 0!==this.metalness&&(r.metalness=this.metalness),this.emissive&&this.emissive.isColor&&(r.emissive=this.emissive.getHex()),this.specular&&this.specular.isColor&&(r.specular=this.specular.getHex()),void 0!==this.shininess&&(r.shininess=this.shininess),this.map&&this.map.isTexture&&(r.map=this.map.toJSON(e).uuid),this.alphaMap&&this.alphaMap.isTexture&&(r.alphaMap=this.alphaMap.toJSON(e).uuid),this.lightMap&&this.lightMap.isTexture&&(r.lightMap=this.lightMap.toJSON(e).uuid),this.bumpMap&&this.bumpMap.isTexture&&(r.bumpMap=this.bumpMap.toJSON(e).uuid,r.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(r.normalMap=this.normalMap.toJSON(e).uuid,r.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(r.displacementMap=this.displacementMap.toJSON(e).uuid,r.displacementScale=this.displacementScale,r.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(r.roughnessMap=this.roughnessMap.toJSON(e).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(r.metalnessMap=this.metalnessMap.toJSON(e).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(r.emissiveMap=this.emissiveMap.toJSON(e).uuid),this.specularMap&&this.specularMap.isTexture&&(r.specularMap=this.specularMap.toJSON(e).uuid),this.envMap&&this.envMap.isTexture&&(r.envMap=this.envMap.toJSON(e).uuid,r.reflectivity=this.reflectivity),void 0!==this.size&&(r.size=this.size),void 0!==this.sizeAttenuation&&(r.sizeAttenuation=this.sizeAttenuation),this.blending!==x&&(r.blending=this.blending),this.shading!==p&&(r.shading=this.shading),this.side!==l&&(r.side=this.side),this.vertexColors!==f&&(r.vertexColors=this.vertexColors),this.opacity<1&&(r.opacity=this.opacity),!0===this.transparent&&(r.transparent=this.transparent),r.depthFunc=this.depthFunc,r.depthTest=this.depthTest,r.depthWrite=this.depthWrite,this.alphaTest>0&&(r.alphaTest=this.alphaTest),!0===this.premultipliedAlpha&&(r.premultipliedAlpha=this.premultipliedAlpha),!0===this.wireframe&&(r.wireframe=this.wireframe),this.wireframeLinewidth>1&&(r.wireframeLinewidth=this.wireframeLinewidth),"round"!==this.wireframeLinecap&&(r.wireframeLinecap=this.wireframeLinecap),"round"!==this.wireframeLinejoin&&(r.wireframeLinejoin=this.wireframeLinejoin),r.skinning=this.skinning,r.morphTargets=this.morphTargets,t){var i=extractFromCache(e.textures),n=extractFromCache(e.images);i.length>0&&(r.textures=i),n.length>0&&(r.images=n)}return r},clone:function(){return(new this.constructor).copy(this)},copy:function(e){this.name=e.name,this.fog=e.fog,this.lights=e.lights,this.blending=e.blending,this.side=e.side,this.shading=e.shading,this.vertexColors=e.vertexColors,this.opacity=e.opacity,this.transparent=e.transparent,this.blendSrc=e.blendSrc,this.blendDst=e.blendDst,this.blendEquation=e.blendEquation,this.blendSrcAlpha=e.blendSrcAlpha,this.blendDstAlpha=e.blendDstAlpha,this.blendEquationAlpha=e.blendEquationAlpha,this.depthFunc=e.depthFunc,this.depthTest=e.depthTest,this.depthWrite=e.depthWrite,this.colorWrite=e.colorWrite,this.precision=e.precision,this.polygonOffset=e.polygonOffset,this.polygonOffsetFactor=e.polygonOffsetFactor,this.polygonOffsetUnits=e.polygonOffsetUnits,this.alphaTest=e.alphaTest,this.premultipliedAlpha=e.premultipliedAlpha,this.overdraw=e.overdraw,this.visible=e.visible,this.clipShadows=e.clipShadows,this.clipIntersection=e.clipIntersection;var t=e.clippingPlanes,r=null;if(null!==t){var i=t.length;r=new Array(i);for(var n=0;n!==i;++n)r[n]=t[n].clone()}return this.clippingPlanes=r,this},update:function(){this.dispatchEvent({type:"update"})},dispose:function(){this.dispatchEvent({type:"dispose"})}},Object.assign(Material.prototype,EventDispatcher.prototype);var wt=0;ShaderMaterial.prototype=Object.create(Material.prototype),ShaderMaterial.prototype.constructor=ShaderMaterial,ShaderMaterial.prototype.isShaderMaterial=!0,ShaderMaterial.prototype.copy=function(e){return Material.prototype.copy.call(this,e),this.fragmentShader=e.fragmentShader,this.vertexShader=e.vertexShader,this.uniforms=yt.clone(e.uniforms),this.defines=e.defines,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.lights=e.lights,this.clipping=e.clipping,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this.extensions=e.extensions,this},ShaderMaterial.prototype.toJSON=function(e){var t=Material.prototype.toJSON.call(this,e);return t.uniforms=this.uniforms,t.vertexShader=this.vertexShader,t.fragmentShader=this.fragmentShader,t},MeshDepthMaterial.prototype=Object.create(Material.prototype),MeshDepthMaterial.prototype.constructor=MeshDepthMaterial,MeshDepthMaterial.prototype.isMeshDepthMaterial=!0,MeshDepthMaterial.prototype.copy=function(e){return Material.prototype.copy.call(this,e),this.depthPacking=e.depthPacking,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this},Box3.prototype={constructor:Box3,isBox3:!0,set:function(e,t){return this.min.copy(e),this.max.copy(t),this},setFromArray:function(e){for(var t=1/0,r=1/0,i=1/0,n=-1/0,a=-1/0,o=-1/0,s=0,c=e.length;s<c;s+=3){var l=e[s],h=e[s+1],u=e[s+2];l<t&&(t=l),h<r&&(r=h),u<i&&(i=u),l>n&&(n=l),h>a&&(a=h),u>o&&(o=u)}this.min.set(t,r,i),this.max.set(n,a,o)},setFromPoints:function(e){this.makeEmpty();for(var t=0,r=e.length;t<r;t++)this.expandByPoint(e[t]);return this},setFromCenterAndSize:function(){var e=new Vector3;return function setFromCenterAndSize(t,r){var i=e.copy(r).multiplyScalar(.5);return this.min.copy(t).sub(i),this.max.copy(t).add(i),this}}(),setFromObject:function(){var e=new Vector3;return function setFromObject(t){var r=this;return t.updateMatrixWorld(!0),this.makeEmpty(),t.traverse(function(t){var i=t.geometry;if(void 0!==i)if(i&&i.isGeometry)for(var n=i.vertices,a=0,o=n.length;a<o;a++)e.copy(n[a]),e.applyMatrix4(t.matrixWorld),r.expandByPoint(e);else if(i&&i.isBufferGeometry){var s=i.attributes.position;if(void 0!==s){var c,l,h;s&&s.isInterleavedBufferAttribute?(c=s.data.array,l=s.offset,h=s.data.stride):(c=s.array,l=0,h=3);for(var a=l,o=c.length;a<o;a+=h)e.fromArray(c,a),e.applyMatrix4(t.matrixWorld),r.expandByPoint(e)}}}),this}}(),clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.min.copy(e.min),this.max.copy(e.max),this},makeEmpty:function(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this},isEmpty:function(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z},getCenter:function(e){var t=e||new Vector3;return this.isEmpty()?t.set(0,0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)},getSize:function(e){var t=e||new Vector3;return this.isEmpty()?t.set(0,0,0):t.subVectors(this.max,this.min)},expandByPoint:function(e){return this.min.min(e),this.max.max(e),this},expandByVector:function(e){return this.min.sub(e),this.max.add(e),this},expandByScalar:function(e){return this.min.addScalar(-e),this.max.addScalar(e),this},containsPoint:function(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y||e.z<this.min.z||e.z>this.max.z)},containsBox:function(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z},getParameter:function(e,t){return(t||new Vector3).set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y),(e.z-this.min.z)/(this.max.z-this.min.z))},intersectsBox:function(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y||e.max.z<this.min.z||e.min.z>this.max.z)},intersectsSphere:function(){var e;return function intersectsSphere(t){return void 0===e&&(e=new Vector3),this.clampPoint(t.center,e),e.distanceToSquared(t.center)<=t.radius*t.radius}}(),intersectsPlane:function(e){var t,r;return e.normal.x>0?(t=e.normal.x*this.min.x,r=e.normal.x*this.max.x):(t=e.normal.x*this.max.x,r=e.normal.x*this.min.x),e.normal.y>0?(t+=e.normal.y*this.min.y,r+=e.normal.y*this.max.y):(t+=e.normal.y*this.max.y,r+=e.normal.y*this.min.y),e.normal.z>0?(t+=e.normal.z*this.min.z,r+=e.normal.z*this.max.z):(t+=e.normal.z*this.max.z,r+=e.normal.z*this.min.z),t<=e.constant&&r>=e.constant},clampPoint:function(e,t){return(t||new Vector3).copy(e).clamp(this.min,this.max)},distanceToPoint:function(){var e=new Vector3;return function distanceToPoint(t){return e.copy(t).clamp(this.min,this.max).sub(t).length()}}(),getBoundingSphere:function(){var e=new Vector3;return function getBoundingSphere(t){var r=t||new Sphere;return this.getCenter(r.center),r.radius=.5*this.getSize(e).length(),r}}(),intersect:function(e){return this.min.max(e.min),this.max.min(e.max),this.isEmpty()&&this.makeEmpty(),this},union:function(e){return this.min.min(e.min),this.max.max(e.max),this},applyMatrix4:function(){var e=[new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3];return function applyMatrix4(t){return this.isEmpty()?this:(e[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(t),e[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(t),e[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(t),e[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(t),e[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(t),e[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(t),e[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(t),e[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(t),this.setFromPoints(e),this)}}(),translate:function(e){return this.min.add(e),this.max.add(e),this},equals:function(e){return e.min.equals(this.min)&&e.max.equals(this.max)}},Sphere.prototype={constructor:Sphere,set:function(e,t){return this.center.copy(e),this.radius=t,this},setFromPoints:function(){var e=new Box3;return function setFromPoints(t,r){var i=this.center;void 0!==r?i.copy(r):e.setFromPoints(t).getCenter(i);for(var n=0,a=0,o=t.length;a<o;a++)n=Math.max(n,i.distanceToSquared(t[a]));return this.radius=Math.sqrt(n),this}}(),clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.center.copy(e.center),this.radius=e.radius,this},empty:function(){return this.radius<=0},containsPoint:function(e){return e.distanceToSquared(this.center)<=this.radius*this.radius},distanceToPoint:function(e){return e.distanceTo(this.center)-this.radius},intersectsSphere:function(e){var t=this.radius+e.radius;return e.center.distanceToSquared(this.center)<=t*t},intersectsBox:function(e){return e.intersectsSphere(this)},intersectsPlane:function(e){return Math.abs(this.center.dot(e.normal)-e.constant)<=this.radius},clampPoint:function(e,t){var r=this.center.distanceToSquared(e),i=t||new Vector3;return i.copy(e),r>this.radius*this.radius&&(i.sub(this.center).normalize(),i.multiplyScalar(this.radius).add(this.center)),i},getBoundingBox:function(e){var t=e||new Box3;return t.set(this.center,this.center),t.expandByScalar(this.radius),t},applyMatrix4:function(e){return this.center.applyMatrix4(e),this.radius=this.radius*e.getMaxScaleOnAxis(),this},translate:function(e){return this.center.add(e),this},equals:function(e){return e.center.equals(this.center)&&e.radius===this.radius}},Matrix3.prototype={constructor:Matrix3,isMatrix3:!0,set:function(e,t,r,i,n,a,o,s,c){var l=this.elements;return l[0]=e,l[1]=i,l[2]=o,l[3]=t,l[4]=n,l[5]=s,l[6]=r,l[7]=a,l[8]=c,this},identity:function(){return this.set(1,0,0,0,1,0,0,0,1),this},clone:function(){return(new this.constructor).fromArray(this.elements)},copy:function(e){var t=e.elements;return this.set(t[0],t[3],t[6],t[1],t[4],t[7],t[2],t[5],t[8]),this},setFromMatrix4:function(e){var t=e.elements;return this.set(t[0],t[4],t[8],t[1],t[5],t[9],t[2],t[6],t[10]),this},applyToVector3Array:function(){var e;return function applyToVector3Array(t,r,i){void 0===e&&(e=new Vector3),void 0===r&&(r=0),void 0===i&&(i=t.length);for(var n=0,a=r;n<i;n+=3,a+=3)e.fromArray(t,a),e.applyMatrix3(this),e.toArray(t,a);return t}}(),applyToBuffer:function(){var e;return function applyToBuffer(t,r,i){void 0===e&&(e=new Vector3),void 0===r&&(r=0),void 0===i&&(i=t.length/t.itemSize);for(var n=0,a=r;n<i;n++,a++)e.x=t.getX(a),e.y=t.getY(a),e.z=t.getZ(a),e.applyMatrix3(this),t.setXYZ(a,e.x,e.y,e.z);return t}}(),multiplyScalar:function(e){var t=this.elements;return t[0]*=e,t[3]*=e,t[6]*=e,t[1]*=e,t[4]*=e,t[7]*=e,t[2]*=e,t[5]*=e,t[8]*=e,this},determinant:function(){var e=this.elements,t=e[0],r=e[1],i=e[2],n=e[3],a=e[4],o=e[5],s=e[6],c=e[7],l=e[8];return t*a*l-t*o*c-r*n*l+r*o*s+i*n*c-i*a*s},getInverse:function(e,t){e&&e.isMatrix4&&console.error("THREE.Matrix3.getInverse no longer takes a Matrix4 argument.");var r=e.elements,i=this.elements,n=r[0],a=r[1],o=r[2],s=r[3],c=r[4],l=r[5],h=r[6],u=r[7],d=r[8],p=d*c-l*u,f=l*h-d*s,m=u*s-c*h,g=n*p+a*f+o*m;if(0===g){var v="THREE.Matrix3.getInverse(): can't invert matrix, determinant is 0";if(!0===t)throw new Error(v);return console.warn(v),this.identity()}var y=1/g;return i[0]=p*y,i[1]=(o*u-d*a)*y,i[2]=(l*a-o*c)*y,i[3]=f*y,i[4]=(d*n-o*h)*y,i[5]=(o*s-l*n)*y,i[6]=m*y,i[7]=(a*h-u*n)*y,i[8]=(c*n-a*s)*y,this},transpose:function(){var e,t=this.elements;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this},flattenToArrayOffset:function(e,t){return console.warn("THREE.Matrix3: .flattenToArrayOffset is deprecated - just use .toArray instead."),this.toArray(e,t)},getNormalMatrix:function(e){return this.setFromMatrix4(e).getInverse(this).transpose()},transposeIntoArray:function(e){var t=this.elements;return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],this},fromArray:function(e,t){void 0===t&&(t=0);for(var r=0;r<9;r++)this.elements[r]=e[r+t];return this},toArray:function(e,t){void 0===e&&(e=[]),void 0===t&&(t=0);var r=this.elements;return e[t]=r[0],e[t+1]=r[1],e[t+2]=r[2],e[t+3]=r[3],e[t+4]=r[4],e[t+5]=r[5],e[t+6]=r[6],e[t+7]=r[7],e[t+8]=r[8],e}},Plane.prototype={constructor:Plane,set:function(e,t){return this.normal.copy(e),this.constant=t,this},setComponents:function(e,t,r,i){return this.normal.set(e,t,r),this.constant=i,this},setFromNormalAndCoplanarPoint:function(e,t){return this.normal.copy(e),this.constant=-t.dot(this.normal),this},setFromCoplanarPoints:function(){var e=new Vector3,t=new Vector3;return function setFromCoplanarPoints(r,i,n){var a=e.subVectors(n,i).cross(t.subVectors(r,i)).normalize();return this.setFromNormalAndCoplanarPoint(a,r),this}}(),clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.normal.copy(e.normal),this.constant=e.constant,this},normalize:function(){var e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this},negate:function(){return this.constant*=-1,this.normal.negate(),this},distanceToPoint:function(e){return this.normal.dot(e)+this.constant},distanceToSphere:function(e){return this.distanceToPoint(e.center)-e.radius},projectPoint:function(e,t){return this.orthoPoint(e,t).sub(e).negate()},orthoPoint:function(e,t){var r=this.distanceToPoint(e);return(t||new Vector3).copy(this.normal).multiplyScalar(r)},intersectLine:function(){var e=new Vector3;return function intersectLine(t,r){var i=r||new Vector3,n=t.delta(e),a=this.normal.dot(n);if(0!==a){var o=-(t.start.dot(this.normal)+this.constant)/a;if(!(o<0||o>1))return i.copy(n).multiplyScalar(o).add(t.start)}else if(0===this.distanceToPoint(t.start))return i.copy(t.start)}}(),intersectsLine:function(e){var t=this.distanceToPoint(e.start),r=this.distanceToPoint(e.end);return t<0&&r>0||r<0&&t>0},intersectsBox:function(e){return e.intersectsPlane(this)},intersectsSphere:function(e){return e.intersectsPlane(this)},coplanarPoint:function(e){return(e||new Vector3).copy(this.normal).multiplyScalar(-this.constant)},applyMatrix4:function(){var e=new Vector3,t=new Matrix3;return function applyMatrix4(r,i){var n=this.coplanarPoint(e).applyMatrix4(r),a=i||t.getNormalMatrix(r),o=this.normal.applyMatrix3(a).normalize();return this.constant=-n.dot(o),this}}(),translate:function(e){return this.constant=this.constant-e.dot(this.normal),this},equals:function(e){return e.normal.equals(this.normal)&&e.constant===this.constant}},Frustum.prototype={constructor:Frustum,set:function(e,t,r,i,n,a){var o=this.planes;return o[0].copy(e),o[1].copy(t),o[2].copy(r),o[3].copy(i),o[4].copy(n),o[5].copy(a),this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){for(var t=this.planes,r=0;r<6;r++)t[r].copy(e.planes[r]);return this},setFromMatrix:function(e){var t=this.planes,r=e.elements,i=r[0],n=r[1],a=r[2],o=r[3],s=r[4],c=r[5],l=r[6],h=r[7],u=r[8],d=r[9],p=r[10],f=r[11],m=r[12],g=r[13],v=r[14],y=r[15];return t[0].setComponents(o-i,h-s,f-u,y-m).normalize(),t[1].setComponents(o+i,h+s,f+u,y+m).normalize(),t[2].setComponents(o+n,h+c,f+d,y+g).normalize(),t[3].setComponents(o-n,h-c,f-d,y-g).normalize(),t[4].setComponents(o-a,h-l,f-p,y-v).normalize(),t[5].setComponents(o+a,h+l,f+p,y+v).normalize(),this},intersectsObject:function(){var e=new Sphere;return function intersectsObject(t){var r=t.geometry;return null===r.boundingSphere&&r.computeBoundingSphere(),e.copy(r.boundingSphere).applyMatrix4(t.matrixWorld),this.intersectsSphere(e)}}(),intersectsSprite:function(){var e=new Sphere;return function intersectsSprite(t){return e.center.set(0,0,0),e.radius=.7071067811865476,e.applyMatrix4(t.matrixWorld),this.intersectsSphere(e)}}(),intersectsSphere:function(e){for(var t=this.planes,r=e.center,i=-e.radius,n=0;n<6;n++)if(t[n].distanceToPoint(r)<i)return!1;return!0},intersectsBox:function(){var e=new Vector3,t=new Vector3;return function intersectsBox(r){for(var i=this.planes,n=0;n<6;n++){var a=i[n];e.x=a.normal.x>0?r.min.x:r.max.x,t.x=a.normal.x>0?r.max.x:r.min.x,e.y=a.normal.y>0?r.min.y:r.max.y,t.y=a.normal.y>0?r.max.y:r.min.y,e.z=a.normal.z>0?r.min.z:r.max.z,t.z=a.normal.z>0?r.max.z:r.min.z;var o=a.distanceToPoint(e),s=a.distanceToPoint(t);if(o<0&&s<0)return!1}return!0}}(),containsPoint:function(e){for(var t=this.planes,r=0;r<6;r++)if(t[r].distanceToPoint(e)<0)return!1;return!0}},Ray.prototype={constructor:Ray,set:function(e,t){return this.origin.copy(e),this.direction.copy(t),this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.origin.copy(e.origin),this.direction.copy(e.direction),this},at:function(e,t){return(t||new Vector3).copy(this.direction).multiplyScalar(e).add(this.origin)},lookAt:function(e){return this.direction.copy(e).sub(this.origin).normalize(),this},recast:function(){var e=new Vector3;return function recast(t){return this.origin.copy(this.at(t,e)),this}}(),closestPointToPoint:function(e,t){var r=t||new Vector3;r.subVectors(e,this.origin);var i=r.dot(this.direction);return i<0?r.copy(this.origin):r.copy(this.direction).multiplyScalar(i).add(this.origin)},distanceToPoint:function(e){return Math.sqrt(this.distanceSqToPoint(e))},distanceSqToPoint:function(){var e=new Vector3;return function distanceSqToPoint(t){var r=e.subVectors(t,this.origin).dot(this.direction);return r<0?this.origin.distanceToSquared(t):(e.copy(this.direction).multiplyScalar(r).add(this.origin),e.distanceToSquared(t))}}(),distanceSqToSegment:function(){var e=new Vector3,t=new Vector3,r=new Vector3;return function distanceSqToSegment(i,n,a,o){e.copy(i).add(n).multiplyScalar(.5),t.copy(n).sub(i).normalize(),r.copy(this.origin).sub(e);var s,c,l,h,u=.5*i.distanceTo(n),d=-this.direction.dot(t),p=r.dot(this.direction),f=-r.dot(t),m=r.lengthSq(),g=Math.abs(1-d*d);if(g>0)if(s=d*f-p,c=d*p-f,h=u*g,s>=0)if(c>=-h)if(c<=h){var v=1/g;l=(s*=v)*(s+d*(c*=v)+2*p)+c*(d*s+c+2*f)+m}else c=u,l=-(s=Math.max(0,-(d*c+p)))*s+c*(c+2*f)+m;else c=-u,l=-(s=Math.max(0,-(d*c+p)))*s+c*(c+2*f)+m;else c<=-h?l=-(s=Math.max(0,-(-d*u+p)))*s+(c=s>0?-u:Math.min(Math.max(-u,-f),u))*(c+2*f)+m:c<=h?(s=0,l=(c=Math.min(Math.max(-u,-f),u))*(c+2*f)+m):l=-(s=Math.max(0,-(d*u+p)))*s+(c=s>0?u:Math.min(Math.max(-u,-f),u))*(c+2*f)+m;else c=d>0?-u:u,l=-(s=Math.max(0,-(d*c+p)))*s+c*(c+2*f)+m;return a&&a.copy(this.direction).multiplyScalar(s).add(this.origin),o&&o.copy(t).multiplyScalar(c).add(e),l}}(),intersectSphere:function(){var e=new Vector3;return function intersectSphere(t,r){e.subVectors(t.center,this.origin);var i=e.dot(this.direction),n=e.dot(e)-i*i,a=t.radius*t.radius;if(n>a)return null;var o=Math.sqrt(a-n),s=i-o,c=i+o;return s<0&&c<0?null:s<0?this.at(c,r):this.at(s,r)}}(),intersectsSphere:function(e){return this.distanceToPoint(e.center)<=e.radius},distanceToPlane:function(e){var t=e.normal.dot(this.direction);if(0===t)return 0===e.distanceToPoint(this.origin)?0:null;var r=-(this.origin.dot(e.normal)+e.constant)/t;return r>=0?r:null},intersectPlane:function(e,t){var r=this.distanceToPlane(e);return null===r?null:this.at(r,t)},intersectsPlane:function(e){var t=e.distanceToPoint(this.origin);return 0===t||e.normal.dot(this.direction)*t<0},intersectBox:function(e,t){var r,i,n,a,o,s,c=1/this.direction.x,l=1/this.direction.y,h=1/this.direction.z,u=this.origin;return c>=0?(r=(e.min.x-u.x)*c,i=(e.max.x-u.x)*c):(r=(e.max.x-u.x)*c,i=(e.min.x-u.x)*c),l>=0?(n=(e.min.y-u.y)*l,a=(e.max.y-u.y)*l):(n=(e.max.y-u.y)*l,a=(e.min.y-u.y)*l),r>a||n>i?null:((n>r||r!==r)&&(r=n),(a<i||i!==i)&&(i=a),h>=0?(o=(e.min.z-u.z)*h,s=(e.max.z-u.z)*h):(o=(e.max.z-u.z)*h,s=(e.min.z-u.z)*h),r>s||o>i?null:((o>r||r!==r)&&(r=o),(s<i||i!==i)&&(i=s),i<0?null:this.at(r>=0?r:i,t)))},intersectsBox:function(){var e=new Vector3;return function intersectsBox(t){return null!==this.intersectBox(t,e)}}(),intersectTriangle:function(){var e=new Vector3,t=new Vector3,r=new Vector3,i=new Vector3;return function intersectTriangle(n,a,o,s,c){t.subVectors(a,n),r.subVectors(o,n),i.crossVectors(t,r);var l,h=this.direction.dot(i);if(h>0){if(s)return null;l=1}else{if(!(h<0))return null;l=-1,h=-h}e.subVectors(this.origin,n);var u=l*this.direction.dot(r.crossVectors(e,r));if(u<0)return null;var d=l*this.direction.dot(t.cross(e));if(d<0)return null;if(u+d>h)return null;var p=-l*e.dot(i);return p<0?null:this.at(p/h,c)}}(),applyMatrix4:function(e){return this.direction.add(this.origin).applyMatrix4(e),this.origin.applyMatrix4(e),this.direction.sub(this.origin),this.direction.normalize(),this},equals:function(e){return e.origin.equals(this.origin)&&e.direction.equals(this.direction)}},Euler.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"],Euler.DefaultOrder="XYZ",Euler.prototype={constructor:Euler,isEuler:!0,get x(){return this._x},set x(e){this._x=e,this.onChangeCallback()},get y(){return this._y},set y(e){this._y=e,this.onChangeCallback()},get z(){return this._z},set z(e){this._z=e,this.onChangeCallback()},get order(){return this._order},set order(e){this._order=e,this.onChangeCallback()},set:function(e,t,r,i){return this._x=e,this._y=t,this._z=r,this._order=i||this._order,this.onChangeCallback(),this},clone:function(){return new this.constructor(this._x,this._y,this._z,this._order)},copy:function(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._order=e._order,this.onChangeCallback(),this},setFromRotationMatrix:function(e,t,r){var i=ut.clamp,n=e.elements,a=n[0],o=n[4],s=n[8],c=n[1],l=n[5],h=n[9],u=n[2],d=n[6],p=n[10];return"XYZ"===(t=t||this._order)?(this._y=Math.asin(i(s,-1,1)),Math.abs(s)<.99999?(this._x=Math.atan2(-h,p),this._z=Math.atan2(-o,a)):(this._x=Math.atan2(d,l),this._z=0)):"YXZ"===t?(this._x=Math.asin(-i(h,-1,1)),Math.abs(h)<.99999?(this._y=Math.atan2(s,p),this._z=Math.atan2(c,l)):(this._y=Math.atan2(-u,a),this._z=0)):"ZXY"===t?(this._x=Math.asin(i(d,-1,1)),Math.abs(d)<.99999?(this._y=Math.atan2(-u,p),this._z=Math.atan2(-o,l)):(this._y=0,this._z=Math.atan2(c,a))):"ZYX"===t?(this._y=Math.asin(-i(u,-1,1)),Math.abs(u)<.99999?(this._x=Math.atan2(d,p),this._z=Math.atan2(c,a)):(this._x=0,this._z=Math.atan2(-o,l))):"YZX"===t?(this._z=Math.asin(i(c,-1,1)),Math.abs(c)<.99999?(this._x=Math.atan2(-h,l),this._y=Math.atan2(-u,a)):(this._x=0,this._y=Math.atan2(s,p))):"XZY"===t?(this._z=Math.asin(-i(o,-1,1)),Math.abs(o)<.99999?(this._x=Math.atan2(d,l),this._y=Math.atan2(s,a)):(this._x=Math.atan2(-h,p),this._y=0)):console.warn("THREE.Euler: .setFromRotationMatrix() given unsupported order: "+t),this._order=t,!1!==r&&this.onChangeCallback(),this},setFromQuaternion:function(){var e;return function setFromQuaternion(t,r,i){return void 0===e&&(e=new Matrix4),e.makeRotationFromQuaternion(t),this.setFromRotationMatrix(e,r,i)}}(),setFromVector3:function(e,t){return this.set(e.x,e.y,e.z,t||this._order)},reorder:function(){var e=new Quaternion;return function reorder(t){return e.setFromEuler(this),this.setFromQuaternion(e,t)}}(),equals:function(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._order===this._order},fromArray:function(e){return this._x=e[0],this._y=e[1],this._z=e[2],void 0!==e[3]&&(this._order=e[3]),this.onChangeCallback(),this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._order,e},toVector3:function(e){return e?e.set(this._x,this._y,this._z):new Vector3(this._x,this._y,this._z)},onChange:function(e){return this.onChangeCallback=e,this},onChangeCallback:function(){}},Layers.prototype={constructor:Layers,set:function(e){this.mask=1<<e},enable:function(e){this.mask|=1<<e},toggle:function(e){this.mask^=1<<e},disable:function(e){this.mask&=~(1<<e)},test:function(e){return 0!=(this.mask&e.mask)}},Object3D.DefaultUp=new Vector3(0,1,0),Object3D.DefaultMatrixAutoUpdate=!0,Object.assign(Object3D.prototype,EventDispatcher.prototype,{isObject3D:!0,applyMatrix:function(e){this.matrix.multiplyMatrices(e,this.matrix),this.matrix.decompose(this.position,this.quaternion,this.scale)},setRotationFromAxisAngle:function(e,t){this.quaternion.setFromAxisAngle(e,t)},setRotationFromEuler:function(e){this.quaternion.setFromEuler(e,!0)},setRotationFromMatrix:function(e){this.quaternion.setFromRotationMatrix(e)},setRotationFromQuaternion:function(e){this.quaternion.copy(e)},rotateOnAxis:function(){var e=new Quaternion;return function rotateOnAxis(t,r){return e.setFromAxisAngle(t,r),this.quaternion.multiply(e),this}}(),rotateX:function(){var e=new Vector3(1,0,0);return function rotateX(t){return this.rotateOnAxis(e,t)}}(),rotateY:function(){var e=new Vector3(0,1,0);return function rotateY(t){return this.rotateOnAxis(e,t)}}(),rotateZ:function(){var e=new Vector3(0,0,1);return function rotateZ(t){return this.rotateOnAxis(e,t)}}(),translateOnAxis:function(){var e=new Vector3;return function translateOnAxis(t,r){return e.copy(t).applyQuaternion(this.quaternion),this.position.add(e.multiplyScalar(r)),this}}(),translateX:function(){var e=new Vector3(1,0,0);return function translateX(t){return this.translateOnAxis(e,t)}}(),translateY:function(){var e=new Vector3(0,1,0);return function translateY(t){return this.translateOnAxis(e,t)}}(),translateZ:function(){var e=new Vector3(0,0,1);return function translateZ(t){return this.translateOnAxis(e,t)}}(),localToWorld:function(e){return e.applyMatrix4(this.matrixWorld)},worldToLocal:function(){var e=new Matrix4;return function worldToLocal(t){return t.applyMatrix4(e.getInverse(this.matrixWorld))}}(),lookAt:function(){var e=new Matrix4;return function lookAt(t){e.lookAt(t,this.position,this.up),this.quaternion.setFromRotationMatrix(e)}}(),add:function(e){if(arguments.length>1){for(var t=0;t<arguments.length;t++)this.add(arguments[t]);return this}return e===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",e),this):(e&&e.isObject3D?(null!==e.parent&&e.parent.remove(e),e.parent=this,e.dispatchEvent({type:"added"}),this.children.push(e)):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",e),this)},remove:function(e){if(arguments.length>1)for(var t=0;t<arguments.length;t++)this.remove(arguments[t]);var r=this.children.indexOf(e);-1!==r&&(e.parent=null,e.dispatchEvent({type:"removed"}),this.children.splice(r,1))},getObjectById:function(e){return this.getObjectByProperty("id",e)},getObjectByName:function(e){return this.getObjectByProperty("name",e)},getObjectByProperty:function(e,t){if(this[e]===t)return this;for(var r=0,i=this.children.length;r<i;r++){var n=this.children[r].getObjectByProperty(e,t);if(void 0!==n)return n}},getWorldPosition:function(e){var t=e||new Vector3;return this.updateMatrixWorld(!0),t.setFromMatrixPosition(this.matrixWorld)},getWorldQuaternion:function(){var e=new Vector3,t=new Vector3;return function getWorldQuaternion(r){var i=r||new Quaternion;return this.updateMatrixWorld(!0),this.matrixWorld.decompose(e,i,t),i}}(),getWorldRotation:function(){var e=new Quaternion;return function getWorldRotation(t){var r=t||new Euler;return this.getWorldQuaternion(e),r.setFromQuaternion(e,this.rotation.order,!1)}}(),getWorldScale:function(){var e=new Vector3,t=new Quaternion;return function getWorldScale(r){var i=r||new Vector3;return this.updateMatrixWorld(!0),this.matrixWorld.decompose(e,t,i),i}}(),getWorldDirection:function(){var e=new Quaternion;return function getWorldDirection(t){var r=t||new Vector3;return this.getWorldQuaternion(e),r.set(0,0,1).applyQuaternion(e)}}(),raycast:function(){},traverse:function(e){e(this);for(var t=this.children,r=0,i=t.length;r<i;r++)t[r].traverse(e)},traverseVisible:function(e){if(!1!==this.visible){e(this);for(var t=this.children,r=0,i=t.length;r<i;r++)t[r].traverseVisible(e)}},traverseAncestors:function(e){var t=this.parent;null!==t&&(e(t),t.traverseAncestors(e))},updateMatrix:function(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0},updateMatrixWorld:function(e){!0===this.matrixAutoUpdate&&this.updateMatrix(),!0!==this.matrixWorldNeedsUpdate&&!0!==e||(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,e=!0);for(var t=this.children,r=0,i=t.length;r<i;r++)t[r].updateMatrixWorld(e)},toJSON:function(e){function extractFromCache(e){var t=[];for(var r in e){var i=e[r];delete i.metadata,t.push(i)}return t}var t=void 0===e||""===e,r={};t&&(e={geometries:{},materials:{},textures:{},images:{}},r.metadata={version:4.4,type:"Object",generator:"Object3D.toJSON"});var i={};if(i.uuid=this.uuid,i.type=this.type,""!==this.name&&(i.name=this.name),"{}"!==JSON.stringify(this.userData)&&(i.userData=this.userData),!0===this.castShadow&&(i.castShadow=!0),!0===this.receiveShadow&&(i.receiveShadow=!0),!1===this.visible&&(i.visible=!1),i.matrix=this.matrix.toArray(),void 0!==this.geometry&&(void 0===e.geometries[this.geometry.uuid]&&(e.geometries[this.geometry.uuid]=this.geometry.toJSON(e)),i.geometry=this.geometry.uuid),void 0!==this.material&&(void 0===e.materials[this.material.uuid]&&(e.materials[this.material.uuid]=this.material.toJSON(e)),i.material=this.material.uuid),this.children.length>0){i.children=[];for(var n=0;n<this.children.length;n++)i.children.push(this.children[n].toJSON(e).object)}if(t){var a=extractFromCache(e.geometries),o=extractFromCache(e.materials),s=extractFromCache(e.textures),c=extractFromCache(e.images);a.length>0&&(r.geometries=a),o.length>0&&(r.materials=o),s.length>0&&(r.textures=s),c.length>0&&(r.images=c)}return r.object=i,r},clone:function(e){return(new this.constructor).copy(this,e)},copy:function(e,t){if(void 0===t&&(t=!0),this.name=e.name,this.up.copy(e.up),this.position.copy(e.position),this.quaternion.copy(e.quaternion),this.scale.copy(e.scale),this.matrix.copy(e.matrix),this.matrixWorld.copy(e.matrixWorld),this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrixWorldNeedsUpdate=e.matrixWorldNeedsUpdate,this.visible=e.visible,this.castShadow=e.castShadow,this.receiveShadow=e.receiveShadow,this.frustumCulled=e.frustumCulled,this.renderOrder=e.renderOrder,this.userData=JSON.parse(JSON.stringify(e.userData)),!0===t)for(var r=0;r<e.children.length;r++){var i=e.children[r];this.add(i.clone())}return this}});var Tt=0;Line3.prototype={constructor:Line3,set:function(e,t){return this.start.copy(e),this.end.copy(t),this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.start.copy(e.start),this.end.copy(e.end),this},getCenter:function(e){return(e||new Vector3).addVectors(this.start,this.end).multiplyScalar(.5)},delta:function(e){return(e||new Vector3).subVectors(this.end,this.start)},distanceSq:function(){return this.start.distanceToSquared(this.end)},distance:function(){return this.start.distanceTo(this.end)},at:function(e,t){var r=t||new Vector3;return this.delta(r).multiplyScalar(e).add(this.start)},closestPointToPointParameter:function(){var e=new Vector3,t=new Vector3;return function closestPointToPointParameter(r,i){e.subVectors(r,this.start),t.subVectors(this.end,this.start);var n=t.dot(t),a=t.dot(e)/n;return i&&(a=ut.clamp(a,0,1)),a}}(),closestPointToPoint:function(e,t,r){var i=this.closestPointToPointParameter(e,t),n=r||new Vector3;return this.delta(n).multiplyScalar(i).add(this.start)},applyMatrix4:function(e){return this.start.applyMatrix4(e),this.end.applyMatrix4(e),this},equals:function(e){return e.start.equals(this.start)&&e.end.equals(this.end)}},Triangle.normal=function(){var e=new Vector3;return function normal(t,r,i,n){var a=n||new Vector3;a.subVectors(i,r),e.subVectors(t,r),a.cross(e);var o=a.lengthSq();return o>0?a.multiplyScalar(1/Math.sqrt(o)):a.set(0,0,0)}}(),Triangle.barycoordFromPoint=function(){var e=new Vector3,t=new Vector3,r=new Vector3;return function barycoordFromPoint(i,n,a,o,s){e.subVectors(o,n),t.subVectors(a,n),r.subVectors(i,n);var c=e.dot(e),l=e.dot(t),h=e.dot(r),u=t.dot(t),d=t.dot(r),p=c*u-l*l,f=s||new Vector3;if(0===p)return f.set(-2,-1,-1);var m=1/p,g=(u*h-l*d)*m,v=(c*d-l*h)*m;return f.set(1-g-v,v,g)}}(),Triangle.containsPoint=function(){var e=new Vector3;return function containsPoint(t,r,i,n){var a=Triangle.barycoordFromPoint(t,r,i,n,e);return a.x>=0&&a.y>=0&&a.x+a.y<=1}}(),Triangle.prototype={constructor:Triangle,set:function(e,t,r){return this.a.copy(e),this.b.copy(t),this.c.copy(r),this},setFromPointsAndIndices:function(e,t,r,i){return this.a.copy(e[t]),this.b.copy(e[r]),this.c.copy(e[i]),this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.a.copy(e.a),this.b.copy(e.b),this.c.copy(e.c),this},area:function(){var e=new Vector3,t=new Vector3;return function area(){return e.subVectors(this.c,this.b),t.subVectors(this.a,this.b),.5*e.cross(t).length()}}(),midpoint:function(e){return(e||new Vector3).addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)},normal:function(e){return Triangle.normal(this.a,this.b,this.c,e)},plane:function(e){return(e||new Plane).setFromCoplanarPoints(this.a,this.b,this.c)},barycoordFromPoint:function(e,t){return Triangle.barycoordFromPoint(e,this.a,this.b,this.c,t)},containsPoint:function(e){return Triangle.containsPoint(e,this.a,this.b,this.c)},closestPointToPoint:function(){var e,t,r,i;return function closestPointToPoint(n,a){void 0===e&&(e=new Plane,t=[new Line3,new Line3,new Line3],r=new Vector3,i=new Vector3);var o=a||new Vector3,s=1/0;if(e.setFromCoplanarPoints(this.a,this.b,this.c),e.projectPoint(n,r),!0===this.containsPoint(r))o.copy(r);else{t[0].set(this.a,this.b),t[1].set(this.b,this.c),t[2].set(this.c,this.a);for(var c=0;c<t.length;c++){t[c].closestPointToPoint(r,!0,i);var l=r.distanceToSquared(i);l<s&&(s=l,o.copy(i))}}return o}}(),equals:function(e){return e.a.equals(this.a)&&e.b.equals(this.b)&&e.c.equals(this.c)}},Face3.prototype={constructor:Face3,clone:function(){return(new this.constructor).copy(this)},copy:function(e){this.a=e.a,this.b=e.b,this.c=e.c,this.normal.copy(e.normal),this.color.copy(e.color),this.materialIndex=e.materialIndex;for(var t=0,r=e.vertexNormals.length;t<r;t++)this.vertexNormals[t]=e.vertexNormals[t].clone();for(var t=0,r=e.vertexColors.length;t<r;t++)this.vertexColors[t]=e.vertexColors[t].clone();return this}},MeshBasicMaterial.prototype=Object.create(Material.prototype),MeshBasicMaterial.prototype.constructor=MeshBasicMaterial,MeshBasicMaterial.prototype.isMeshBasicMaterial=!0,MeshBasicMaterial.prototype.copy=function(e){return Material.prototype.copy.call(this,e),this.color.copy(e.color),this.map=e.map,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this},BufferAttribute.prototype={constructor:BufferAttribute,isBufferAttribute:!0,set needsUpdate(e){!0===e&&this.version++},setArray:function(e){if(Array.isArray(e))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.count=void 0!==e?e.length/this.itemSize:0,this.array=e},setDynamic:function(e){return this.dynamic=e,this},copy:function(e){return this.array=new e.array.constructor(e.array),this.itemSize=e.itemSize,this.count=e.count,this.normalized=e.normalized,this.dynamic=e.dynamic,this},copyAt:function(e,t,r){e*=this.itemSize,r*=t.itemSize;for(var i=0,n=this.itemSize;i<n;i++)this.array[e+i]=t.array[r+i];return this},copyArray:function(e){return this.array.set(e),this},copyColorsArray:function(e){for(var t=this.array,r=0,i=0,n=e.length;i<n;i++){var a=e[i];void 0===a&&(console.warn("THREE.BufferAttribute.copyColorsArray(): color is undefined",i),a=new Color),t[r++]=a.r,t[r++]=a.g,t[r++]=a.b}return this},copyIndicesArray:function(e){for(var t=this.array,r=0,i=0,n=e.length;i<n;i++){var a=e[i];t[r++]=a.a,t[r++]=a.b,t[r++]=a.c}return this},copyVector2sArray:function(e){for(var t=this.array,r=0,i=0,n=e.length;i<n;i++){var a=e[i];void 0===a&&(console.warn("THREE.BufferAttribute.copyVector2sArray(): vector is undefined",i),a=new Vector2),t[r++]=a.x,t[r++]=a.y}return this},copyVector3sArray:function(e){for(var t=this.array,r=0,i=0,n=e.length;i<n;i++){var a=e[i];void 0===a&&(console.warn("THREE.BufferAttribute.copyVector3sArray(): vector is undefined",i),a=new Vector3),t[r++]=a.x,t[r++]=a.y,t[r++]=a.z}return this},copyVector4sArray:function(e){for(var t=this.array,r=0,i=0,n=e.length;i<n;i++){var a=e[i];void 0===a&&(console.warn("THREE.BufferAttribute.copyVector4sArray(): vector is undefined",i),a=new Vector4),t[r++]=a.x,t[r++]=a.y,t[r++]=a.z,t[r++]=a.w}return this},set:function(e,t){return void 0===t&&(t=0),this.array.set(e,t),this},getX:function(e){return this.array[e*this.itemSize]},setX:function(e,t){return this.array[e*this.itemSize]=t,this},getY:function(e){return this.array[e*this.itemSize+1]},setY:function(e,t){return this.array[e*this.itemSize+1]=t,this},getZ:function(e){return this.array[e*this.itemSize+2]},setZ:function(e,t){return this.array[e*this.itemSize+2]=t,this},getW:function(e){return this.array[e*this.itemSize+3]},setW:function(e,t){return this.array[e*this.itemSize+3]=t,this},setXY:function(e,t,r){return e*=this.itemSize,this.array[e+0]=t,this.array[e+1]=r,this},setXYZ:function(e,t,r,i){return e*=this.itemSize,this.array[e+0]=t,this.array[e+1]=r,this.array[e+2]=i,this},setXYZW:function(e,t,r,i,n){return e*=this.itemSize,this.array[e+0]=t,this.array[e+1]=r,this.array[e+2]=i,this.array[e+3]=n,this},clone:function(){return(new this.constructor).copy(this)}},Object.assign(Geometry.prototype,EventDispatcher.prototype,{isGeometry:!0,applyMatrix:function(e){for(var t=(new Matrix3).getNormalMatrix(e),r=0,i=this.vertices.length;r<i;r++)this.vertices[r].applyMatrix4(e);for(var r=0,i=this.faces.length;r<i;r++){var n=this.faces[r];n.normal.applyMatrix3(t).normalize();for(var a=0,o=n.vertexNormals.length;a<o;a++)n.vertexNormals[a].applyMatrix3(t).normalize()}return null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this.verticesNeedUpdate=!0,this.normalsNeedUpdate=!0,this},rotateX:function(){var e;return function rotateX(t){return void 0===e&&(e=new Matrix4),e.makeRotationX(t),this.applyMatrix(e),this}}(),rotateY:function(){var e;return function rotateY(t){return void 0===e&&(e=new Matrix4),e.makeRotationY(t),this.applyMatrix(e),this}}(),rotateZ:function(){var e;return function rotateZ(t){return void 0===e&&(e=new Matrix4),e.makeRotationZ(t),this.applyMatrix(e),this}}(),translate:function(){var e;return function translate(t,r,i){return void 0===e&&(e=new Matrix4),e.makeTranslation(t,r,i),this.applyMatrix(e),this}}(),scale:function(){var e;return function scale(t,r,i){return void 0===e&&(e=new Matrix4),e.makeScale(t,r,i),this.applyMatrix(e),this}}(),lookAt:function(){var e;return function lookAt(t){void 0===e&&(e=new Object3D),e.lookAt(t),e.updateMatrix(),this.applyMatrix(e.matrix)}}(),fromBufferGeometry:function(e){function addFace(e,r,i,n){var d=new Face3(e,r,i,void 0!==a?[l[e].clone(),l[r].clone(),l[i].clone()]:[],void 0!==o?[t.colors[e].clone(),t.colors[r].clone(),t.colors[i].clone()]:[],n);t.faces.push(d),void 0!==s&&t.faceVertexUvs[0].push([h[e].clone(),h[r].clone(),h[i].clone()]),void 0!==c&&t.faceVertexUvs[1].push([u[e].clone(),u[r].clone(),u[i].clone()])}var t=this,r=null!==e.index?e.index.array:void 0,i=e.attributes,n=i.position.array,a=void 0!==i.normal?i.normal.array:void 0,o=void 0!==i.color?i.color.array:void 0,s=void 0!==i.uv?i.uv.array:void 0,c=void 0!==i.uv2?i.uv2.array:void 0;void 0!==c&&(this.faceVertexUvs[1]=[]);for(var l=[],h=[],u=[],d=0,p=0;d<n.length;d+=3,p+=2)t.vertices.push(new Vector3(n[d],n[d+1],n[d+2])),void 0!==a&&l.push(new Vector3(a[d],a[d+1],a[d+2])),void 0!==o&&t.colors.push(new Color(o[d],o[d+1],o[d+2])),void 0!==s&&h.push(new Vector2(s[p],s[p+1])),void 0!==c&&u.push(new Vector2(c[p],c[p+1]));if(void 0!==r){var f=e.groups;if(f.length>0)for(d=0;d<f.length;d++)for(var m=f[d],g=m.start,p=g,v=g+m.count;p<v;p+=3)addFace(r[p],r[p+1],r[p+2],m.materialIndex);else for(d=0;d<r.length;d+=3)addFace(r[d],r[d+1],r[d+2])}else for(d=0;d<n.length/3;d+=3)addFace(d,d+1,d+2);return this.computeFaceNormals(),null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),this},center:function(){this.computeBoundingBox();var e=this.boundingBox.getCenter().negate();return this.translate(e.x,e.y,e.z),e},normalize:function(){this.computeBoundingSphere();var e=this.boundingSphere.center,t=this.boundingSphere.radius,r=0===t?1:1/t,i=new Matrix4;return i.set(r,0,0,-r*e.x,0,r,0,-r*e.y,0,0,r,-r*e.z,0,0,0,1),this.applyMatrix(i),this},computeFaceNormals:function(){for(var e=new Vector3,t=new Vector3,r=0,i=this.faces.length;r<i;r++){var n=this.faces[r],a=this.vertices[n.a],o=this.vertices[n.b],s=this.vertices[n.c];e.subVectors(s,o),t.subVectors(a,o),e.cross(t),e.normalize(),n.normal.copy(e)}},computeVertexNormals:function(e){void 0===e&&(e=!0);var t,r,i,n,a,o;for(o=new Array(this.vertices.length),t=0,r=this.vertices.length;t<r;t++)o[t]=new Vector3;if(e){var s,c,l,h=new Vector3,u=new Vector3;for(i=0,n=this.faces.length;i<n;i++)a=this.faces[i],s=this.vertices[a.a],c=this.vertices[a.b],l=this.vertices[a.c],h.subVectors(l,c),u.subVectors(s,c),h.cross(u),o[a.a].add(h),o[a.b].add(h),o[a.c].add(h)}else for(this.computeFaceNormals(),i=0,n=this.faces.length;i<n;i++)o[(a=this.faces[i]).a].add(a.normal),o[a.b].add(a.normal),o[a.c].add(a.normal);for(t=0,r=this.vertices.length;t<r;t++)o[t].normalize();for(i=0,n=this.faces.length;i<n;i++){var d=(a=this.faces[i]).vertexNormals;3===d.length?(d[0].copy(o[a.a]),d[1].copy(o[a.b]),d[2].copy(o[a.c])):(d[0]=o[a.a].clone(),d[1]=o[a.b].clone(),d[2]=o[a.c].clone())}this.faces.length>0&&(this.normalsNeedUpdate=!0)},computeFlatVertexNormals:function(){var e,t,r;for(this.computeFaceNormals(),e=0,t=this.faces.length;e<t;e++){var i=(r=this.faces[e]).vertexNormals;3===i.length?(i[0].copy(r.normal),i[1].copy(r.normal),i[2].copy(r.normal)):(i[0]=r.normal.clone(),i[1]=r.normal.clone(),i[2]=r.normal.clone())}this.faces.length>0&&(this.normalsNeedUpdate=!0)},computeMorphNormals:function(){var e,t,r,i,n;for(r=0,i=this.faces.length;r<i;r++)for((n=this.faces[r]).__originalFaceNormal?n.__originalFaceNormal.copy(n.normal):n.__originalFaceNormal=n.normal.clone(),n.__originalVertexNormals||(n.__originalVertexNormals=[]),e=0,t=n.vertexNormals.length;e<t;e++)n.__originalVertexNormals[e]?n.__originalVertexNormals[e].copy(n.vertexNormals[e]):n.__originalVertexNormals[e]=n.vertexNormals[e].clone();var a=new Geometry;for(a.faces=this.faces,e=0,t=this.morphTargets.length;e<t;e++){if(!this.morphNormals[e]){this.morphNormals[e]={},this.morphNormals[e].faceNormals=[],this.morphNormals[e].vertexNormals=[];var o=this.morphNormals[e].faceNormals,s=this.morphNormals[e].vertexNormals;for(r=0,i=this.faces.length;r<i;r++)l=new Vector3,h={a:new Vector3,b:new Vector3,c:new Vector3},o.push(l),s.push(h)}var c=this.morphNormals[e];a.vertices=this.morphTargets[e].vertices,a.computeFaceNormals(),a.computeVertexNormals();var l,h;for(r=0,i=this.faces.length;r<i;r++)n=this.faces[r],l=c.faceNormals[r],h=c.vertexNormals[r],l.copy(n.normal),h.a.copy(n.vertexNormals[0]),h.b.copy(n.vertexNormals[1]),h.c.copy(n.vertexNormals[2])}for(r=0,i=this.faces.length;r<i;r++)(n=this.faces[r]).normal=n.__originalFaceNormal,n.vertexNormals=n.__originalVertexNormals},computeTangents:function(){console.warn("THREE.Geometry: .computeTangents() has been removed.")},computeLineDistances:function(){for(var e=0,t=this.vertices,r=0,i=t.length;r<i;r++)r>0&&(e+=t[r].distanceTo(t[r-1])),this.lineDistances[r]=e},computeBoundingBox:function(){null===this.boundingBox&&(this.boundingBox=new Box3),this.boundingBox.setFromPoints(this.vertices)},computeBoundingSphere:function(){null===this.boundingSphere&&(this.boundingSphere=new Sphere),this.boundingSphere.setFromPoints(this.vertices)},merge:function(e,t,r){if(!1!==(e&&e.isGeometry)){var i,n=this.vertices.length,a=this.vertices,o=e.vertices,s=this.faces,c=e.faces,l=this.faceVertexUvs[0],h=e.faceVertexUvs[0],u=this.colors,d=e.colors;void 0===r&&(r=0),void 0!==t&&(i=(new Matrix3).getNormalMatrix(t));for(var p=0,f=o.length;p<f;p++){var m=o[p].clone();void 0!==t&&m.applyMatrix4(t),a.push(m)}for(var p=0,f=d.length;p<f;p++)u.push(d[p].clone());for(p=0,f=c.length;p<f;p++){var g,v,y,x=c[p],b=x.vertexNormals,_=x.vertexColors;(g=new Face3(x.a+n,x.b+n,x.c+n)).normal.copy(x.normal),void 0!==i&&g.normal.applyMatrix3(i).normalize();for(var M=0,w=b.length;M<w;M++)v=b[M].clone(),void 0!==i&&v.applyMatrix3(i).normalize(),g.vertexNormals.push(v);g.color.copy(x.color);for(var M=0,w=_.length;M<w;M++)y=_[M],g.vertexColors.push(y.clone());g.materialIndex=x.materialIndex+r,s.push(g)}for(p=0,f=h.length;p<f;p++){var T=h[p],S=[];if(void 0!==T){for(var M=0,w=T.length;M<w;M++)S.push(T[M].clone());l.push(S)}}}else console.error("THREE.Geometry.merge(): geometry not an instance of THREE.Geometry.",e)},mergeMesh:function(e){!1!==(e&&e.isMesh)?(e.matrixAutoUpdate&&e.updateMatrix(),this.merge(e.geometry,e.matrix)):console.error("THREE.Geometry.mergeMesh(): mesh not an instance of THREE.Mesh.",e)},mergeVertices:function(){var e,t,r,i,n,a,o,s,c={},l=[],h=[],u=Math.pow(10,4);for(r=0,i=this.vertices.length;r<i;r++)e=this.vertices[r],void 0===c[t=Math.round(e.x*u)+"_"+Math.round(e.y*u)+"_"+Math.round(e.z*u)]?(c[t]=r,l.push(this.vertices[r]),h[r]=l.length-1):h[r]=h[c[t]];var d=[];for(r=0,i=this.faces.length;r<i;r++){(n=this.faces[r]).a=h[n.a],n.b=h[n.b],n.c=h[n.c],a=[n.a,n.b,n.c];for(var p=0;p<3;p++)if(a[p]===a[(p+1)%3]){p,d.push(r);break}}for(r=d.length-1;r>=0;r--){var f=d[r];for(this.faces.splice(f,1),o=0,s=this.faceVertexUvs.length;o<s;o++)this.faceVertexUvs[o].splice(f,1)}var m=this.vertices.length-l.length;return this.vertices=l,m},sortFacesByMaterialIndex:function(){for(var e=this.faces,t=e.length,r=0;r<t;r++)e[r]._id=r;e.sort(function materialIndexSort(e,t){return e.materialIndex-t.materialIndex});var i,n,a=this.faceVertexUvs[0],o=this.faceVertexUvs[1];a&&a.length===t&&(i=[]),o&&o.length===t&&(n=[]);for(r=0;r<t;r++){var s=e[r]._id;i&&i.push(a[s]),n&&n.push(o[s])}i&&(this.faceVertexUvs[0]=i),n&&(this.faceVertexUvs[1]=n)},toJSON:function(){function setBit(e,t,r){return r?e|1<<t:e&~(1<<t)}function getNormalIndex(e){var t=e.x.toString()+e.y.toString()+e.z.toString();return void 0!==c[t]?c[t]:(c[t]=s.length/3,s.push(e.x,e.y,e.z),c[t])}function getColorIndex(e){var t=e.r.toString()+e.g.toString()+e.b.toString();return void 0!==h[t]?h[t]:(h[t]=l.length,l.push(e.getHex()),h[t])}function getUvIndex(e){var t=e.x.toString()+e.y.toString();return void 0!==d[t]?d[t]:(d[t]=u.length/2,u.push(e.x,e.y),d[t])}var e={metadata:{version:4.4,type:"Geometry",generator:"Geometry.toJSON"}};if(e.uuid=this.uuid,e.type=this.type,""!==this.name&&(e.name=this.name),void 0!==this.parameters){var t=this.parameters;for(var r in t)void 0!==t[r]&&(e[r]=t[r]);return e}for(var i=[],n=0;n<this.vertices.length;n++){var a=this.vertices[n];i.push(a.x,a.y,a.z)}for(var o=[],s=[],c={},l=[],h={},u=[],d={},n=0;n<this.faces.length;n++){var p=this.faces[n],f=void 0!==this.faceVertexUvs[0][n],m=p.normal.length()>0,g=p.vertexNormals.length>0,v=1!==p.color.r||1!==p.color.g||1!==p.color.b,y=p.vertexColors.length>0,x=0;if(x=setBit(x,0,0),x=setBit(x,1,!0),x=setBit(x,2,!1),x=setBit(x,3,f),x=setBit(x,4,m),x=setBit(x,5,g),x=setBit(x,6,v),x=setBit(x,7,y),o.push(x),o.push(p.a,p.b,p.c),o.push(p.materialIndex),f){var b=this.faceVertexUvs[0][n];o.push(getUvIndex(b[0]),getUvIndex(b[1]),getUvIndex(b[2]))}if(m&&o.push(getNormalIndex(p.normal)),g){var _=p.vertexNormals;o.push(getNormalIndex(_[0]),getNormalIndex(_[1]),getNormalIndex(_[2]))}if(v&&o.push(getColorIndex(p.color)),y){var M=p.vertexColors;o.push(getColorIndex(M[0]),getColorIndex(M[1]),getColorIndex(M[2]))}}return e.data={},e.data.vertices=i,e.data.normals=s,l.length>0&&(e.data.colors=l),u.length>0&&(e.data.uvs=[u]),e.data.faces=o,e},clone:function(){return(new Geometry).copy(this)},copy:function(e){this.vertices=[],this.faces=[],this.faceVertexUvs=[[]],this.colors=[];for(var t=e.vertices,r=0,i=t.length;r<i;r++)this.vertices.push(t[r].clone());for(var n=e.colors,r=0,i=n.length;r<i;r++)this.colors.push(n[r].clone());for(var a=e.faces,r=0,i=a.length;r<i;r++)this.faces.push(a[r].clone());for(var r=0,i=e.faceVertexUvs.length;r<i;r++){var o=e.faceVertexUvs[r];void 0===this.faceVertexUvs[r]&&(this.faceVertexUvs[r]=[]);for(var s=0,c=o.length;s<c;s++){for(var l=o[s],h=[],u=0,d=l.length;u<d;u++){var p=l[u];h.push(p.clone())}this.faceVertexUvs[r].push(h)}}return this},dispose:function(){this.dispatchEvent({type:"dispose"})}});var St=0;Object.assign(DirectGeometry.prototype,EventDispatcher.prototype,{computeBoundingBox:Geometry.prototype.computeBoundingBox,computeBoundingSphere:Geometry.prototype.computeBoundingSphere,computeFaceNormals:function(){console.warn("THREE.DirectGeometry: computeFaceNormals() is not a method of this type of geometry.")},computeVertexNormals:function(){console.warn("THREE.DirectGeometry: computeVertexNormals() is not a method of this type of geometry.")},computeGroups:function(e){for(var t,r,i=[],n=e.faces,a=0;a<n.length;a++){var o=n[a];o.materialIndex!==r&&(r=o.materialIndex,void 0!==t&&(t.count=3*a-t.start,i.push(t)),t={start:3*a,materialIndex:r})}void 0!==t&&(t.count=3*a-t.start,i.push(t)),this.groups=i},fromGeometry:function(e){var t,r=e.faces,i=e.vertices,n=e.faceVertexUvs,a=n[0]&&n[0].length>0,o=n[1]&&n[1].length>0,s=e.morphTargets,c=s.length;if(c>0){t=[];for(g=0;g<c;g++)t[g]=[];this.morphTargets.position=t}var l,h=e.morphNormals,u=h.length;if(u>0){l=[];for(g=0;g<u;g++)l[g]=[];this.morphTargets.normal=l}for(var d=e.skinIndices,p=e.skinWeights,f=d.length===i.length,m=p.length===i.length,g=0;g<r.length;g++){var v=r[g];this.vertices.push(i[v.a],i[v.b],i[v.c]);var y=v.vertexNormals;if(3===y.length)this.normals.push(y[0],y[1],y[2]);else{var x=v.normal;this.normals.push(x,x,x)}var b=v.vertexColors;if(3===b.length)this.colors.push(b[0],b[1],b[2]);else{var _=v.color;this.colors.push(_,_,_)}if(!0===a&&(void 0!==(M=n[0][g])?this.uvs.push(M[0],M[1],M[2]):(console.warn("THREE.DirectGeometry.fromGeometry(): Undefined vertexUv ",g),this.uvs.push(new Vector2,new Vector2,new Vector2))),!0===o){var M=n[1][g];void 0!==M?this.uvs2.push(M[0],M[1],M[2]):(console.warn("THREE.DirectGeometry.fromGeometry(): Undefined vertexUv2 ",g),this.uvs2.push(new Vector2,new Vector2,new Vector2))}for(T=0;T<c;T++){var w=s[T].vertices;t[T].push(w[v.a],w[v.b],w[v.c])}for(var T=0;T<u;T++){var S=h[T].vertexNormals[g];l[T].push(S.a,S.b,S.c)}f&&this.skinIndices.push(d[v.a],d[v.b],d[v.c]),m&&this.skinWeights.push(p[v.a],p[v.b],p[v.c])}return this.computeGroups(e),this.verticesNeedUpdate=e.verticesNeedUpdate,this.normalsNeedUpdate=e.normalsNeedUpdate,this.colorsNeedUpdate=e.colorsNeedUpdate,this.uvsNeedUpdate=e.uvsNeedUpdate,this.groupsNeedUpdate=e.groupsNeedUpdate,this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),Object.assign(BufferGeometry.prototype,EventDispatcher.prototype,{isBufferGeometry:!0,getIndex:function(){return this.index},setIndex:function(e){this.index=e},addAttribute:function(e,t){return!1===(t&&t.isBufferAttribute)&&!1===(t&&t.isInterleavedBufferAttribute)?(console.warn("THREE.BufferGeometry: .addAttribute() now expects ( name, attribute )."),void this.addAttribute(e,new BufferAttribute(arguments[1],arguments[2]))):"index"===e?(console.warn("THREE.BufferGeometry.addAttribute: Use .setIndex() for index attribute."),void this.setIndex(t)):(this.attributes[e]=t,this)},getAttribute:function(e){return this.attributes[e]},removeAttribute:function(e){return delete this.attributes[e],this},addGroup:function(e,t,r){this.groups.push({start:e,count:t,materialIndex:void 0!==r?r:0})},clearGroups:function(){this.groups=[]},setDrawRange:function(e,t){this.drawRange.start=e,this.drawRange.count=t},applyMatrix:function(e){var t=this.attributes.position;void 0!==t&&(e.applyToVector3Array(t.array),t.needsUpdate=!0);var r=this.attributes.normal;return void 0!==r&&((new Matrix3).getNormalMatrix(e).applyToVector3Array(r.array),r.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this},rotateX:function(){var e;return function rotateX(t){return void 0===e&&(e=new Matrix4),e.makeRotationX(t),this.applyMatrix(e),this}}(),rotateY:function(){var e;return function rotateY(t){return void 0===e&&(e=new Matrix4),e.makeRotationY(t),this.applyMatrix(e),this}}(),rotateZ:function(){var e;return function rotateZ(t){return void 0===e&&(e=new Matrix4),e.makeRotationZ(t),this.applyMatrix(e),this}}(),translate:function(){var e;return function translate(t,r,i){return void 0===e&&(e=new Matrix4),e.makeTranslation(t,r,i),this.applyMatrix(e),this}}(),scale:function(){var e;return function scale(t,r,i){return void 0===e&&(e=new Matrix4),e.makeScale(t,r,i),this.applyMatrix(e),this}}(),lookAt:function(){var e;return function lookAt(t){void 0===e&&(e=new Object3D),e.lookAt(t),e.updateMatrix(),this.applyMatrix(e.matrix)}}(),center:function(){this.computeBoundingBox();var e=this.boundingBox.getCenter().negate();return this.translate(e.x,e.y,e.z),e},setFromObject:function(e){var t=e.geometry;if(e&&e.isPoints||e&&e.isLine){var r=new Float32Attribute(3*t.vertices.length,3),i=new Float32Attribute(3*t.colors.length,3);if(this.addAttribute("position",r.copyVector3sArray(t.vertices)),this.addAttribute("color",i.copyColorsArray(t.colors)),t.lineDistances&&t.lineDistances.length===t.vertices.length){var n=new Float32Attribute(t.lineDistances.length,1);this.addAttribute("lineDistance",n.copyArray(t.lineDistances))}null!==t.boundingSphere&&(this.boundingSphere=t.boundingSphere.clone()),null!==t.boundingBox&&(this.boundingBox=t.boundingBox.clone())}else e&&e.isMesh&&t&&t.isGeometry&&this.fromGeometry(t);return this},updateFromObject:function(e){var t=e.geometry;if(e&&e.isMesh){var r=t.__directGeometry;if(!0===t.elementsNeedUpdate&&(r=void 0,t.elementsNeedUpdate=!1),void 0===r)return this.fromGeometry(t);r.verticesNeedUpdate=t.verticesNeedUpdate,r.normalsNeedUpdate=t.normalsNeedUpdate,r.colorsNeedUpdate=t.colorsNeedUpdate,r.uvsNeedUpdate=t.uvsNeedUpdate,r.groupsNeedUpdate=t.groupsNeedUpdate,t.verticesNeedUpdate=!1,t.normalsNeedUpdate=!1,t.colorsNeedUpdate=!1,t.uvsNeedUpdate=!1,t.groupsNeedUpdate=!1,t=r}var i;return!0===t.verticesNeedUpdate&&(void 0!==(i=this.attributes.position)&&(i.copyVector3sArray(t.vertices),i.needsUpdate=!0),t.verticesNeedUpdate=!1),!0===t.normalsNeedUpdate&&(void 0!==(i=this.attributes.normal)&&(i.copyVector3sArray(t.normals),i.needsUpdate=!0),t.normalsNeedUpdate=!1),!0===t.colorsNeedUpdate&&(void 0!==(i=this.attributes.color)&&(i.copyColorsArray(t.colors),i.needsUpdate=!0),t.colorsNeedUpdate=!1),t.uvsNeedUpdate&&(void 0!==(i=this.attributes.uv)&&(i.copyVector2sArray(t.uvs),i.needsUpdate=!0),t.uvsNeedUpdate=!1),t.lineDistancesNeedUpdate&&(void 0!==(i=this.attributes.lineDistance)&&(i.copyArray(t.lineDistances),i.needsUpdate=!0),t.lineDistancesNeedUpdate=!1),t.groupsNeedUpdate&&(t.computeGroups(e.geometry),this.groups=t.groups,t.groupsNeedUpdate=!1),this},fromGeometry:function(e){return e.__directGeometry=(new DirectGeometry).fromGeometry(e),this.fromDirectGeometry(e.__directGeometry)},fromDirectGeometry:function(e){var t=new Float32Array(3*e.vertices.length);if(this.addAttribute("position",new BufferAttribute(t,3).copyVector3sArray(e.vertices)),e.normals.length>0){var r=new Float32Array(3*e.normals.length);this.addAttribute("normal",new BufferAttribute(r,3).copyVector3sArray(e.normals))}if(e.colors.length>0){var i=new Float32Array(3*e.colors.length);this.addAttribute("color",new BufferAttribute(i,3).copyColorsArray(e.colors))}if(e.uvs.length>0){var n=new Float32Array(2*e.uvs.length);this.addAttribute("uv",new BufferAttribute(n,2).copyVector2sArray(e.uvs))}if(e.uvs2.length>0){var a=new Float32Array(2*e.uvs2.length);this.addAttribute("uv2",new BufferAttribute(a,2).copyVector2sArray(e.uvs2))}if(e.indices.length>0){var o=new(e.vertices.length>65535?Uint32Array:Uint16Array)(3*e.indices.length);this.setIndex(new BufferAttribute(o,1).copyIndicesArray(e.indices))}this.groups=e.groups;for(var s in e.morphTargets){for(var c=[],l=e.morphTargets[s],h=0,u=l.length;h<u;h++){var d=l[h],p=new Float32Attribute(3*d.length,3);c.push(p.copyVector3sArray(d))}this.morphAttributes[s]=c}if(e.skinIndices.length>0){var f=new Float32Attribute(4*e.skinIndices.length,4);this.addAttribute("skinIndex",f.copyVector4sArray(e.skinIndices))}if(e.skinWeights.length>0){var m=new Float32Attribute(4*e.skinWeights.length,4);this.addAttribute("skinWeight",m.copyVector4sArray(e.skinWeights))}return null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),this},computeBoundingBox:function(){null===this.boundingBox&&(this.boundingBox=new Box3);var e=this.attributes.position.array;void 0!==e?this.boundingBox.setFromArray(e):this.boundingBox.makeEmpty(),(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&console.error('THREE.BufferGeometry.computeBoundingBox: Computed min/max have NaN values. The "position" attribute is likely to have NaN values.',this)},computeBoundingSphere:function(){var e=new Box3,t=new Vector3;return function computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new Sphere);var r=this.attributes.position;if(r){var i=r.array,n=this.boundingSphere.center;e.setFromArray(i),e.getCenter(n);for(var a=0,o=0,s=i.length;o<s;o+=3)t.fromArray(i,o),a=Math.max(a,n.distanceToSquared(t));this.boundingSphere.radius=Math.sqrt(a),isNaN(this.boundingSphere.radius)&&console.error('THREE.BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}}}(),computeFaceNormals:function(){},computeVertexNormals:function(){var e=this.index,t=this.attributes,r=this.groups;if(t.position){var i=t.position.array;if(void 0===t.normal)this.addAttribute("normal",new BufferAttribute(new Float32Array(i.length),3));else for(var n=t.normal.array,a=0,o=n.length;a<o;a++)n[a]=0;var s,c,l,h=t.normal.array,u=new Vector3,d=new Vector3,p=new Vector3,f=new Vector3,m=new Vector3;if(e){var g=e.array;0===r.length&&this.addGroup(0,g.length);for(var v=0,y=r.length;v<y;++v)for(var x=r[v],b=x.start,a=b,o=b+x.count;a<o;a+=3)s=3*g[a+0],c=3*g[a+1],l=3*g[a+2],u.fromArray(i,s),d.fromArray(i,c),p.fromArray(i,l),f.subVectors(p,d),m.subVectors(u,d),f.cross(m),h[s]+=f.x,h[s+1]+=f.y,h[s+2]+=f.z,h[c]+=f.x,h[c+1]+=f.y,h[c+2]+=f.z,h[l]+=f.x,h[l+1]+=f.y,h[l+2]+=f.z}else for(var a=0,o=i.length;a<o;a+=9)u.fromArray(i,a),d.fromArray(i,a+3),p.fromArray(i,a+6),f.subVectors(p,d),m.subVectors(u,d),f.cross(m),h[a]=f.x,h[a+1]=f.y,h[a+2]=f.z,h[a+3]=f.x,h[a+4]=f.y,h[a+5]=f.z,h[a+6]=f.x,h[a+7]=f.y,h[a+8]=f.z;this.normalizeNormals(),t.normal.needsUpdate=!0}},merge:function(e,t){if(!1!==(e&&e.isBufferGeometry)){void 0===t&&(t=0);var r=this.attributes;for(var i in r)if(void 0!==e.attributes[i])for(var n=r[i].array,a=e.attributes[i],o=a.array,s=0,c=a.itemSize*t;s<o.length;s++,c++)n[c]=o[s];return this}console.error("THREE.BufferGeometry.merge(): geometry not an instance of THREE.BufferGeometry.",e)},normalizeNormals:function(){for(var e,t,r,i,n=this.attributes.normal.array,a=0,o=n.length;a<o;a+=3)e=n[a],t=n[a+1],r=n[a+2],i=1/Math.sqrt(e*e+t*t+r*r),n[a]*=i,n[a+1]*=i,n[a+2]*=i},toNonIndexed:function(){if(null===this.index)return console.warn("THREE.BufferGeometry.toNonIndexed(): Geometry is already non-indexed."),this;var e=new BufferGeometry,t=this.index.array,r=this.attributes;for(var i in r){for(var n=r[i],a=n.array,o=n.itemSize,s=new a.constructor(t.length*o),c=0,l=0,h=0,u=t.length;h<u;h++){c=t[h]*o;for(var d=0;d<o;d++)s[l++]=a[c++]}e.addAttribute(i,new BufferAttribute(s,o))}return e},toJSON:function(){var e={metadata:{version:4.4,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(e.uuid=this.uuid,e.type=this.type,""!==this.name&&(e.name=this.name),void 0!==this.parameters){var t=this.parameters;for(var r in t)void 0!==t[r]&&(e[r]=t[r]);return e}e.data={attributes:{}};var i=this.index;if(null!==i){o=Array.prototype.slice.call(i.array);e.data.index={type:i.array.constructor.name,array:o}}var n=this.attributes;for(var r in n){var a=n[r],o=Array.prototype.slice.call(a.array);e.data.attributes[r]={itemSize:a.itemSize,type:a.array.constructor.name,array:o,normalized:a.normalized}}var s=this.groups;s.length>0&&(e.data.groups=JSON.parse(JSON.stringify(s)));var c=this.boundingSphere;return null!==c&&(e.data.boundingSphere={center:c.center.toArray(),radius:c.radius}),e},clone:function(){return(new BufferGeometry).copy(this)},copy:function(e){var t=e.index;null!==t&&this.setIndex(t.clone());var r=e.attributes;for(var i in r){var n=r[i];this.addAttribute(i,n.clone())}for(var a=e.groups,o=0,s=a.length;o<s;o++){var c=a[o];this.addGroup(c.start,c.count,c.materialIndex)}return this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),BufferGeometry.MaxIndex=65535,Mesh.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:Mesh,isMesh:!0,setDrawMode:function(e){this.drawMode=e},copy:function(e){return Object3D.prototype.copy.call(this,e),this.drawMode=e.drawMode,this},updateMorphTargets:function(){var e=this.geometry.morphTargets;if(void 0!==e&&e.length>0){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(var t=0,r=e.length;t<r;t++)this.morphTargetInfluences.push(0),this.morphTargetDictionary[e[t].name]=t}},raycast:function(){function uvIntersection(e,t,r,i,n,a,o){return Triangle.barycoordFromPoint(e,t,r,i,f),n.multiplyScalar(f.x),a.multiplyScalar(f.y),o.multiplyScalar(f.z),n.add(a).add(o),n.clone()}function checkIntersection(e,t,r,i,n,a,o){var s=e.material;if(null===(s.side===h?r.intersectTriangle(a,n,i,!0,o):r.intersectTriangle(i,n,a,s.side!==u,o)))return null;g.copy(o),g.applyMatrix4(e.matrixWorld);var c=t.ray.origin.distanceTo(g);return c<t.near||c>t.far?null:{distance:c,point:g.clone(),object:e}}function checkBufferGeometryIntersection(e,t,r,o,s,c,h,u){i.fromArray(o,3*c),n.fromArray(o,3*h),a.fromArray(o,3*u);var f=checkIntersection(e,t,r,i,n,a,m);return f&&(s&&(l.fromArray(s,2*c),d.fromArray(s,2*h),p.fromArray(s,2*u),f.uv=uvIntersection(m,i,n,a,l,d,p)),f.face=new Face3(c,h,u,Triangle.normal(i,n,a)),f.faceIndex=c),f}var e=new Matrix4,t=new Ray,r=new Sphere,i=new Vector3,n=new Vector3,a=new Vector3,o=new Vector3,s=new Vector3,c=new Vector3,l=new Vector2,d=new Vector2,p=new Vector2,f=new Vector3,m=new Vector3,g=new Vector3;return function raycast(h,u){var f=this.geometry,g=this.material,v=this.matrixWorld;if(void 0!==g&&(null===f.boundingSphere&&f.computeBoundingSphere(),r.copy(f.boundingSphere),r.applyMatrix4(v),!1!==h.ray.intersectsSphere(r)&&(e.getInverse(v),t.copy(h.ray).applyMatrix4(e),null===f.boundingBox||!1!==t.intersectsBox(f.boundingBox)))){var y,x;if(f&&f.isBufferGeometry){var b,_,M,w=f.index,T=f.attributes,S=T.position.array;if(void 0!==T.uv&&(y=T.uv.array),null!==w)for(var E=w.array,A=0,L=E.length;A<L;A+=3)b=E[A],_=E[A+1],M=E[A+2],(x=checkBufferGeometryIntersection(this,h,t,S,y,b,_,M))&&(x.faceIndex=Math.floor(A/3),u.push(x));else for(var A=0,L=S.length;A<L;A+=9)(x=checkBufferGeometryIntersection(this,h,t,S,y,b=A/3,_=b+1,M=b+2))&&(x.index=b,u.push(x))}else if(f&&f.isGeometry){var P,C,R,B=g&&g.isMultiMaterial,I=!0===B?g.materials:null,G=f.vertices,D=f.faces,U=f.faceVertexUvs[0];U.length>0&&(y=U);for(var O=0,F=D.length;O<F;O++){var V=D[O],N=!0===B?I[V.materialIndex]:g;if(void 0!==N){if(P=G[V.a],C=G[V.b],R=G[V.c],!0===N.morphTargets){var z=f.morphTargets,H=this.morphTargetInfluences;i.set(0,0,0),n.set(0,0,0),a.set(0,0,0);for(var k=0,j=z.length;k<j;k++){var W=H[k];if(0!==W){var X=z[k].vertices;i.addScaledVector(o.subVectors(X[V.a],P),W),n.addScaledVector(s.subVectors(X[V.b],C),W),a.addScaledVector(c.subVectors(X[V.c],R),W)}}i.add(P),n.add(C),a.add(R),P=i,C=n,R=a}if(x=checkIntersection(this,h,t,P,C,R,m)){if(y){var Y=y[O];l.copy(Y[0]),d.copy(Y[1]),p.copy(Y[2]),x.uv=uvIntersection(m,P,C,R,l,d,p)}x.face=V,x.faceIndex=O,u.push(x)}}}}}}}(),clone:function(){return new this.constructor(this.geometry,this.material).copy(this)}}),BoxBufferGeometry.prototype=Object.create(BufferGeometry.prototype),BoxBufferGeometry.prototype.constructor=BoxBufferGeometry,PlaneBufferGeometry.prototype=Object.create(BufferGeometry.prototype),PlaneBufferGeometry.prototype.constructor=PlaneBufferGeometry,Camera.prototype=Object.create(Object3D.prototype),Camera.prototype.constructor=Camera,Camera.prototype.isCamera=!0,Camera.prototype.getWorldDirection=function(){var e=new Quaternion;return function getWorldDirection(t){var r=t||new Vector3;return this.getWorldQuaternion(e),r.set(0,0,-1).applyQuaternion(e)}}(),Camera.prototype.lookAt=function(){var e=new Matrix4;return function lookAt(t){e.lookAt(this.position,t,this.up),this.quaternion.setFromRotationMatrix(e)}}(),Camera.prototype.clone=function(){return(new this.constructor).copy(this)},Camera.prototype.copy=function(e){return Object3D.prototype.copy.call(this,e),this.matrixWorldInverse.copy(e.matrixWorldInverse),this.projectionMatrix.copy(e.projectionMatrix),this},PerspectiveCamera.prototype=Object.assign(Object.create(Camera.prototype),{constructor:PerspectiveCamera,isPerspectiveCamera:!0,copy:function(e){return Camera.prototype.copy.call(this,e),this.fov=e.fov,this.zoom=e.zoom,this.near=e.near,this.far=e.far,this.focus=e.focus,this.aspect=e.aspect,this.view=null===e.view?null:Object.assign({},e.view),this.filmGauge=e.filmGauge,this.filmOffset=e.filmOffset,this},setFocalLength:function(e){var t=.5*this.getFilmHeight()/e;this.fov=2*ut.RAD2DEG*Math.atan(t),this.updateProjectionMatrix()},getFocalLength:function(){var e=Math.tan(.5*ut.DEG2RAD*this.fov);return.5*this.getFilmHeight()/e},getEffectiveFOV:function(){return 2*ut.RAD2DEG*Math.atan(Math.tan(.5*ut.DEG2RAD*this.fov)/this.zoom)},getFilmWidth:function(){return this.filmGauge*Math.min(this.aspect,1)},getFilmHeight:function(){return this.filmGauge/Math.max(this.aspect,1)},setViewOffset:function(e,t,r,i,n,a){this.aspect=e/t,this.view={fullWidth:e,fullHeight:t,offsetX:r,offsetY:i,width:n,height:a},this.updateProjectionMatrix()},clearViewOffset:function(){this.view=null,this.updateProjectionMatrix()},updateProjectionMatrix:function(){var e=this.near,t=e*Math.tan(.5*ut.DEG2RAD*this.fov)/this.zoom,r=2*t,i=this.aspect*r,n=-.5*i,a=this.view;if(null!==a){var o=a.fullWidth,s=a.fullHeight;n+=a.offsetX*i/o,t-=a.offsetY*r/s,i*=a.width/o,r*=a.height/s}var c=this.filmOffset;0!==c&&(n+=e*c/this.getFilmWidth()),this.projectionMatrix.makeFrustum(n,n+i,t-r,t,e,this.far)},toJSON:function(e){var t=Object3D.prototype.toJSON.call(this,e);return t.object.fov=this.fov,t.object.zoom=this.zoom,t.object.near=this.near,t.object.far=this.far,t.object.focus=this.focus,t.object.aspect=this.aspect,null!==this.view&&(t.object.view=Object.assign({},this.view)),t.object.filmGauge=this.filmGauge,t.object.filmOffset=this.filmOffset,t}}),OrthographicCamera.prototype=Object.assign(Object.create(Camera.prototype),{constructor:OrthographicCamera,isOrthographicCamera:!0,copy:function(e){return Camera.prototype.copy.call(this,e),this.left=e.left,this.right=e.right,this.top=e.top,this.bottom=e.bottom,this.near=e.near,this.far=e.far,this.zoom=e.zoom,this.view=null===e.view?null:Object.assign({},e.view),this},setViewOffset:function(e,t,r,i,n,a){this.view={fullWidth:e,fullHeight:t,offsetX:r,offsetY:i,width:n,height:a},this.updateProjectionMatrix()},clearViewOffset:function(){this.view=null,this.updateProjectionMatrix()},updateProjectionMatrix:function(){var e=(this.right-this.left)/(2*this.zoom),t=(this.top-this.bottom)/(2*this.zoom),r=(this.right+this.left)/2,i=(this.top+this.bottom)/2,n=r-e,a=r+e,o=i+t,s=i-t;if(null!==this.view){var c=this.zoom/(this.view.width/this.view.fullWidth),l=this.zoom/(this.view.height/this.view.fullHeight),h=(this.right-this.left)/this.view.width,u=(this.top-this.bottom)/this.view.height;a=(n+=h*(this.view.offsetX/c))+h*(this.view.width/c),s=(o-=u*(this.view.offsetY/l))-u*(this.view.height/l)}this.projectionMatrix.makeOrthographic(n,a,o,s,this.near,this.far)},toJSON:function(e){var t=Object3D.prototype.toJSON.call(this,e);return t.object.zoom=this.zoom,t.object.left=this.left,t.object.right=this.right,t.object.top=this.top,t.object.bottom=this.bottom,t.object.near=this.near,t.object.far=this.far,null!==this.view&&(t.object.view=Object.assign({},this.view)),t}});var Et=0;FogExp2.prototype.isFogExp2=!0,FogExp2.prototype.clone=function(){return new FogExp2(this.color.getHex(),this.density)},FogExp2.prototype.toJSON=function(e){return{type:"FogExp2",color:this.color.getHex(),density:this.density}},Fog.prototype.isFog=!0,Fog.prototype.clone=function(){return new Fog(this.color.getHex(),this.near,this.far)},Fog.prototype.toJSON=function(e){return{type:"Fog",color:this.color.getHex(),near:this.near,far:this.far}},(Scene.prototype=Object.create(Object3D.prototype)).constructor=Scene,Scene.prototype.copy=function(e,t){return Object3D.prototype.copy.call(this,e,t),null!==e.background&&(this.background=e.background.clone()),null!==e.fog&&(this.fog=e.fog.clone()),null!==e.overrideMaterial&&(this.overrideMaterial=e.overrideMaterial.clone()),this.autoUpdate=e.autoUpdate,this.matrixAutoUpdate=e.matrixAutoUpdate,this},Scene.prototype.toJSON=function(e){var t=Object3D.prototype.toJSON.call(this,e);return null!==this.background&&(t.object.background=this.background.toJSON(e)),null!==this.fog&&(t.object.fog=this.fog.toJSON()),t},LensFlare.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:LensFlare,isLensFlare:!0,copy:function(e){Object3D.prototype.copy.call(this,e),this.positionScreen.copy(e.positionScreen),this.customUpdateCallback=e.customUpdateCallback;for(var t=0,r=e.lensFlares.length;t<r;t++)this.lensFlares.push(e.lensFlares[t]);return this},add:function(e,t,r,i,n,a){void 0===t&&(t=-1),void 0===r&&(r=0),void 0===a&&(a=1),void 0===n&&(n=new Color(16777215)),void 0===i&&(i=x),r=Math.min(r,Math.max(0,r)),this.lensFlares.push({texture:e,size:t,distance:r,x:0,y:0,z:0,scale:1,rotation:0,opacity:a,color:n,blending:i})},updateLensFlares:function(){var e,t,r=this.lensFlares.length,i=2*-this.positionScreen.x,n=2*-this.positionScreen.y;for(e=0;e<r;e++)(t=this.lensFlares[e]).x=this.positionScreen.x+i*t.distance,t.y=this.positionScreen.y+n*t.distance,t.wantedRotation=t.x*Math.PI*.25,t.rotation+=.25*(t.wantedRotation-t.rotation)}}),SpriteMaterial.prototype=Object.create(Material.prototype),SpriteMaterial.prototype.constructor=SpriteMaterial,SpriteMaterial.prototype.copy=function(e){return Material.prototype.copy.call(this,e),this.color.copy(e.color),this.map=e.map,this.rotation=e.rotation,this},Sprite.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:Sprite,isSprite:!0,raycast:function(){var e=new Vector3;return function raycast(t,r){e.setFromMatrixPosition(this.matrixWorld);var i=t.ray.distanceSqToPoint(e);i>this.scale.x*this.scale.y/4||r.push({distance:Math.sqrt(i),point:this.position,face:null,object:this})}}(),clone:function(){return new this.constructor(this.material).copy(this)}}),LOD.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:LOD,copy:function(e){Object3D.prototype.copy.call(this,e,!1);for(var t=e.levels,r=0,i=t.length;r<i;r++){var n=t[r];this.addLevel(n.object.clone(),n.distance)}return this},addLevel:function(e,t){void 0===t&&(t=0),t=Math.abs(t);for(var r=this.levels,i=0;i<r.length&&!(t<r[i].distance);i++);r.splice(i,0,{distance:t,object:e}),this.add(e)},getObjectForDistance:function(e){for(var t=this.levels,r=1,i=t.length;r<i&&!(e<t[r].distance);r++);return t[r-1].object},raycast:function(){var e=new Vector3;return function raycast(t,r){e.setFromMatrixPosition(this.matrixWorld);var i=t.ray.origin.distanceTo(e);this.getObjectForDistance(i).raycast(t,r)}}(),update:function(){var e=new Vector3,t=new Vector3;return function update(r){var i=this.levels;if(i.length>1){e.setFromMatrixPosition(r.matrixWorld),t.setFromMatrixPosition(this.matrixWorld);var n=e.distanceTo(t);i[0].object.visible=!0;for(var a=1,o=i.length;a<o&&n>=i[a].distance;a++)i[a-1].object.visible=!1,i[a].object.visible=!0;for(;a<o;a++)i[a].object.visible=!1}}}(),toJSON:function(e){var t=Object3D.prototype.toJSON.call(this,e);t.object.levels=[];for(var r=this.levels,i=0,n=r.length;i<n;i++){var a=r[i];t.object.levels.push({object:a.object.uuid,distance:a.distance})}return t}}),DataTexture.prototype=Object.create(Texture.prototype),DataTexture.prototype.constructor=DataTexture,DataTexture.prototype.isDataTexture=!0,Object.assign(Skeleton.prototype,{calculateInverses:function(){this.boneInverses=[];for(var e=0,t=this.bones.length;e<t;e++){var r=new Matrix4;this.bones[e]&&r.getInverse(this.bones[e].matrixWorld),this.boneInverses.push(r)}},pose:function(){for(var e,t=0,r=this.bones.length;t<r;t++)(e=this.bones[t])&&e.matrixWorld.getInverse(this.boneInverses[t]);for(var t=0,r=this.bones.length;t<r;t++)(e=this.bones[t])&&(e.parent&&e.parent.isBone?(e.matrix.getInverse(e.parent.matrixWorld),e.matrix.multiply(e.matrixWorld)):e.matrix.copy(e.matrixWorld),e.matrix.decompose(e.position,e.quaternion,e.scale))},update:function(){var e=new Matrix4;return function update(){for(var t=0,r=this.bones.length;t<r;t++){var i=this.bones[t]?this.bones[t].matrixWorld:this.identityMatrix;e.multiplyMatrices(i,this.boneInverses[t]),e.toArray(this.boneMatrices,16*t)}this.useVertexTexture&&(this.boneTexture.needsUpdate=!0)}}(),clone:function(){return new Skeleton(this.bones,this.boneInverses,this.useVertexTexture)}}),Bone.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:Bone,isBone:!0,copy:function(e){return Object3D.prototype.copy.call(this,e),this.skin=e.skin,this}}),SkinnedMesh.prototype=Object.assign(Object.create(Mesh.prototype),{constructor:SkinnedMesh,isSkinnedMesh:!0,bind:function(e,t){this.skeleton=e,void 0===t&&(this.updateMatrixWorld(!0),this.skeleton.calculateInverses(),t=this.matrixWorld),this.bindMatrix.copy(t),this.bindMatrixInverse.getInverse(t)},pose:function(){this.skeleton.pose()},normalizeSkinWeights:function(){if(this.geometry&&this.geometry.isGeometry)for(i=0;i<this.geometry.skinWeights.length;i++){var e=this.geometry.skinWeights[i];(n=1/e.lengthManhattan())!==1/0?e.multiplyScalar(n):e.set(1,0,0,0)}else if(this.geometry&&this.geometry.isBufferGeometry)for(var t=new Vector4,r=this.geometry.attributes.skinWeight,i=0;i<r.count;i++){t.x=r.getX(i),t.y=r.getY(i),t.z=r.getZ(i),t.w=r.getW(i);var n=1/t.lengthManhattan();n!==1/0?t.multiplyScalar(n):t.set(1,0,0,0),r.setXYZW(i,t.x,t.y,t.z,t.w)}},updateMatrixWorld:function(e){Mesh.prototype.updateMatrixWorld.call(this,!0),"attached"===this.bindMode?this.bindMatrixInverse.getInverse(this.matrixWorld):"detached"===this.bindMode?this.bindMatrixInverse.getInverse(this.bindMatrix):console.warn("THREE.SkinnedMesh unrecognized bindMode: "+this.bindMode)},clone:function(){return new this.constructor(this.geometry,this.material,this.skeleton.useVertexTexture).copy(this)}}),LineBasicMaterial.prototype=Object.create(Material.prototype),LineBasicMaterial.prototype.constructor=LineBasicMaterial,LineBasicMaterial.prototype.isLineBasicMaterial=!0,LineBasicMaterial.prototype.copy=function(e){return Material.prototype.copy.call(this,e),this.color.copy(e.color),this.linewidth=e.linewidth,this.linecap=e.linecap,this.linejoin=e.linejoin,this},Line.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:Line,isLine:!0,raycast:function(){var e=new Matrix4,t=new Ray,r=new Sphere;return function raycast(i,n){var a=i.linePrecision,o=a*a,s=this.geometry,c=this.matrixWorld;if(null===s.boundingSphere&&s.computeBoundingSphere(),r.copy(s.boundingSphere),r.applyMatrix4(c),!1!==i.ray.intersectsSphere(r)){e.getInverse(c),t.copy(i.ray).applyMatrix4(e);var l=new Vector3,h=new Vector3,u=new Vector3,d=new Vector3,p=this&&this.isLineSegments?2:1;if(s&&s.isBufferGeometry){var f=s.index,m=s.attributes.position.array;if(null!==f)for(var g=f.array,v=0,y=g.length-1;v<y;v+=p){var x=g[v],b=g[v+1];l.fromArray(m,3*x),h.fromArray(m,3*b),(w=t.distanceSqToSegment(l,h,d,u))>o||(d.applyMatrix4(this.matrixWorld),(T=i.ray.origin.distanceTo(d))<i.near||T>i.far||n.push({distance:T,point:u.clone().applyMatrix4(this.matrixWorld),index:v,face:null,faceIndex:null,object:this}))}else for(var v=0,y=m.length/3-1;v<y;v+=p)l.fromArray(m,3*v),h.fromArray(m,3*v+3),(w=t.distanceSqToSegment(l,h,d,u))>o||(d.applyMatrix4(this.matrixWorld),(T=i.ray.origin.distanceTo(d))<i.near||T>i.far||n.push({distance:T,point:u.clone().applyMatrix4(this.matrixWorld),index:v,face:null,faceIndex:null,object:this}))}else if(s&&s.isGeometry)for(var _=s.vertices,M=_.length,v=0;v<M-1;v+=p){var w=t.distanceSqToSegment(_[v],_[v+1],d,u);if(!(w>o)){d.applyMatrix4(this.matrixWorld);var T=i.ray.origin.distanceTo(d);T<i.near||T>i.far||n.push({distance:T,point:u.clone().applyMatrix4(this.matrixWorld),index:v,face:null,faceIndex:null,object:this})}}}}}(),clone:function(){return new this.constructor(this.geometry,this.material).copy(this)}}),LineSegments.prototype=Object.assign(Object.create(Line.prototype),{constructor:LineSegments,isLineSegments:!0}),PointsMaterial.prototype=Object.create(Material.prototype),PointsMaterial.prototype.constructor=PointsMaterial,PointsMaterial.prototype.isPointsMaterial=!0,PointsMaterial.prototype.copy=function(e){return Material.prototype.copy.call(this,e),this.color.copy(e.color),this.map=e.map,this.size=e.size,this.sizeAttenuation=e.sizeAttenuation,this},Points.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:Points,isPoints:!0,raycast:function(){var e=new Matrix4,t=new Ray,r=new Sphere;return function raycast(i,n){function testPoint(e,r){var o=t.distanceSqToPoint(e);if(o<h){var c=t.closestPointToPoint(e);c.applyMatrix4(s);var l=i.ray.origin.distanceTo(c);if(l<i.near||l>i.far)return;n.push({distance:l,distanceToRay:Math.sqrt(o),point:c.clone(),index:r,face:null,object:a})}}var a=this,o=this.geometry,s=this.matrixWorld,c=i.params.Points.threshold;if(null===o.boundingSphere&&o.computeBoundingSphere(),r.copy(o.boundingSphere),r.applyMatrix4(s),!1!==i.ray.intersectsSphere(r)){e.getInverse(s),t.copy(i.ray).applyMatrix4(e);var l=c/((this.scale.x+this.scale.y+this.scale.z)/3),h=l*l,u=new Vector3;if(o&&o.isBufferGeometry){var d=o.index,p=o.attributes.position.array;if(null!==d)for(var f=d.array,m=0,g=f.length;m<g;m++){var v=f[m];u.fromArray(p,3*v),testPoint(u,v)}else for(var m=0,y=p.length/3;m<y;m++)u.fromArray(p,3*m),testPoint(u,m)}else for(var x=o.vertices,m=0,y=x.length;m<y;m++)testPoint(x[m],m)}}}(),clone:function(){return new this.constructor(this.geometry,this.material).copy(this)}}),Group.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:Group}),(VideoTexture.prototype=Object.create(Texture.prototype)).constructor=VideoTexture,(CompressedTexture.prototype=Object.create(Texture.prototype)).constructor=CompressedTexture,CompressedTexture.prototype.isCompressedTexture=!0,(CanvasTexture.prototype=Object.create(Texture.prototype)).constructor=CanvasTexture,(DepthTexture.prototype=Object.create(Texture.prototype)).constructor=DepthTexture,DepthTexture.prototype.isDepthTexture=!0,WireframeGeometry.prototype=Object.create(BufferGeometry.prototype),WireframeGeometry.prototype.constructor=WireframeGeometry,ParametricBufferGeometry.prototype=Object.create(BufferGeometry.prototype),ParametricBufferGeometry.prototype.constructor=ParametricBufferGeometry,(ParametricGeometry.prototype=Object.create(Geometry.prototype)).constructor=ParametricGeometry,PolyhedronBufferGeometry.prototype=Object.create(BufferGeometry.prototype),PolyhedronBufferGeometry.prototype.constructor=PolyhedronBufferGeometry,TetrahedronBufferGeometry.prototype=Object.create(PolyhedronBufferGeometry.prototype),TetrahedronBufferGeometry.prototype.constructor=TetrahedronBufferGeometry,(TetrahedronGeometry.prototype=Object.create(Geometry.prototype)).constructor=TetrahedronGeometry,OctahedronBufferGeometry.prototype=Object.create(PolyhedronBufferGeometry.prototype),OctahedronBufferGeometry.prototype.constructor=OctahedronBufferGeometry,(OctahedronGeometry.prototype=Object.create(Geometry.prototype)).constructor=OctahedronGeometry,IcosahedronBufferGeometry.prototype=Object.create(PolyhedronBufferGeometry.prototype),IcosahedronBufferGeometry.prototype.constructor=IcosahedronBufferGeometry,(IcosahedronGeometry.prototype=Object.create(Geometry.prototype)).constructor=IcosahedronGeometry,DodecahedronBufferGeometry.prototype=Object.create(PolyhedronBufferGeometry.prototype),DodecahedronBufferGeometry.prototype.constructor=DodecahedronBufferGeometry,(DodecahedronGeometry.prototype=Object.create(Geometry.prototype)).constructor=DodecahedronGeometry,(PolyhedronGeometry.prototype=Object.create(Geometry.prototype)).constructor=PolyhedronGeometry,TubeBufferGeometry.prototype=Object.create(BufferGeometry.prototype),TubeBufferGeometry.prototype.constructor=TubeBufferGeometry,(TubeGeometry.prototype=Object.create(Geometry.prototype)).constructor=TubeGeometry,TorusKnotBufferGeometry.prototype=Object.create(BufferGeometry.prototype),TorusKnotBufferGeometry.prototype.constructor=TorusKnotBufferGeometry,(TorusKnotGeometry.prototype=Object.create(Geometry.prototype)).constructor=TorusKnotGeometry,TorusBufferGeometry.prototype=Object.create(BufferGeometry.prototype),TorusBufferGeometry.prototype.constructor=TorusBufferGeometry,(TorusGeometry.prototype=Object.create(Geometry.prototype)).constructor=TorusGeometry;var At={area:function(e){for(var t=e.length,r=0,i=t-1,n=0;n<t;i=n++)r+=e[i].x*e[n].y-e[n].x*e[i].y;return.5*r},triangulate:function(){function snip(e,t,r,i,n,a){var o,s,c,l,h,u,d,p,f;if(s=e[a[t]].x,c=e[a[t]].y,l=e[a[r]].x,h=e[a[r]].y,u=e[a[i]].x,d=e[a[i]].y,(l-s)*(d-c)-(h-c)*(u-s)<=0)return!1;var m,g,v,y,x,b,_,M,w,T,S,E,A,L,P;for(m=u-l,g=d-h,v=s-u,y=c-d,x=l-s,b=h-c,o=0;o<n;o++)if(p=e[a[o]].x,f=e[a[o]].y,!(p===s&&f===c||p===l&&f===h||p===u&&f===d)&&(_=p-s,M=f-c,w=p-l,T=f-h,S=p-u,E=f-d,P=m*T-g*w,A=x*M-b*_,L=v*E-y*S,P>=-Number.EPSILON&&L>=-Number.EPSILON&&A>=-Number.EPSILON))return!1;return!0}return function triangulate(e,t){var r=e.length;if(r<3)return null;var i,n,a,o=[],s=[],c=[];if(At.area(e)>0)for(n=0;n<r;n++)s[n]=n;else for(n=0;n<r;n++)s[n]=r-1-n;var l=r,h=2*l;for(n=l-1;l>2;){if(h--<=0)return console.warn("THREE.ShapeUtils: Unable to triangulate polygon! in triangulate()"),t?c:o;if(i=n,l<=i&&(i=0),n=i+1,l<=n&&(n=0),a=n+1,l<=a&&(a=0),snip(e,i,n,a,l,s)){var u,d,p,f,m;for(u=s[i],d=s[n],p=s[a],o.push([e[u],e[d],e[p]]),c.push([s[i],s[n],s[a]]),f=n,m=n+1;m<l;f++,m++)s[f]=s[m];h=2*--l}}return t?c:o}}(),triangulateShape:function(e,t){function removeDupEndPts(e){var t=e.length;t>2&&e[t-1].equals(e[0])&&e.pop()}function point_in_segment_2D_colin(e,t,r){return e.x!==t.x?e.x<t.x?e.x<=r.x&&r.x<=t.x:t.x<=r.x&&r.x<=e.x:e.y<t.y?e.y<=r.y&&r.y<=t.y:t.y<=r.y&&r.y<=e.y}function intersect_segments_2D(e,t,r,i,n){var a=t.x-e.x,o=t.y-e.y,s=i.x-r.x,c=i.y-r.y,l=e.x-r.x,h=e.y-r.y,u=o*s-a*c,d=o*l-a*h;if(Math.abs(u)>Number.EPSILON){var p;if(u>0){if(d<0||d>u)return[];if((p=c*l-s*h)<0||p>u)return[]}else{if(d>0||d<u)return[];if((p=c*l-s*h)>0||p<u)return[]}if(0===p)return!n||0!==d&&d!==u?[e]:[];if(p===u)return!n||0!==d&&d!==u?[t]:[];if(0===d)return[r];if(d===u)return[i];var f=p/u;return[{x:e.x+f*a,y:e.y+f*o}]}if(0!==d||c*l!=s*h)return[];var m=0===a&&0===o,g=0===s&&0===c;if(m&&g)return e.x!==r.x||e.y!==r.y?[]:[e];if(m)return point_in_segment_2D_colin(r,i,e)?[e]:[];if(g)return point_in_segment_2D_colin(e,t,r)?[r]:[];var v,y,x,b,_,M,w,T;return 0!==a?(e.x<t.x?(v=e,x=e.x,y=t,b=t.x):(v=t,x=t.x,y=e,b=e.x),r.x<i.x?(_=r,w=r.x,M=i,T=i.x):(_=i,w=i.x,M=r,T=r.x)):(e.y<t.y?(v=e,x=e.y,y=t,b=t.y):(v=t,x=t.y,y=e,b=e.y),r.y<i.y?(_=r,w=r.y,M=i,T=i.y):(_=i,w=i.y,M=r,T=r.y)),x<=w?b<w?[]:b===w?n?[]:[_]:b<=T?[_,y]:[_,M]:x>T?[]:x===T?n?[]:[v]:b<=T?[v,y]:[v,M]}function isPointInsideAngle(e,t,r,i){var n=t.x-e.x,a=t.y-e.y,o=r.x-e.x,s=r.y-e.y,c=i.x-e.x,l=i.y-e.y,h=n*s-a*o,u=n*l-a*c;if(Math.abs(h)>Number.EPSILON){var d=c*s-l*o;return h>0?u>=0&&d>=0:u>=0||d>=0}return u>0}removeDupEndPts(e),t.forEach(removeDupEndPts);for(var r,i,n,a,o,s,c={},l=e.concat(),h=0,u=t.length;h<u;h++)Array.prototype.push.apply(l,t[h]);for(r=0,i=l.length;r<i;r++)void 0!==c[o=l[r].x+":"+l[r].y]&&console.warn("THREE.ShapeUtils: Duplicate point",o,r),c[o]=r;var d=function removeHoles(e,t){for(var r,i,n,a,o,s,c,l,h,u,d,p=e.concat(),f=[],m=[],g=0,v=t.length;g<v;g++)f.push(g);for(var y=0,x=2*f.length;f.length>0;){if(--x<0){console.log("Infinite Loop! Holes left:"+f.length+", Probably Hole outside Shape!");break}for(n=y;n<p.length;n++){for(a=p[n],i=-1,g=0;g<f.length;g++)if(s=f[g],c=a.x+":"+a.y+":"+s,void 0===m[c]){r=t[s];for(var b=0;b<r.length;b++)if(o=r[b],function isCutLineInsideAngles(e,t){var i=p.length-1,n=e-1;n<0&&(n=i);var a=e+1;a>i&&(a=0);var o=isPointInsideAngle(p[e],p[n],p[a],r[t]);if(!o)return!1;var s=r.length-1,c=t-1;c<0&&(c=s);var l=t+1;return l>s&&(l=0),!!(o=isPointInsideAngle(r[t],r[c],r[l],p[e]))}(n,b)&&!function intersectsShapeEdge(e,t){var r,i;for(r=0;r<p.length;r++)if(i=r+1,i%=p.length,intersect_segments_2D(e,t,p[r],p[i],!0).length>0)return!0;return!1}(a,o)&&!function intersectsHoleEdge(e,r){var i,n,a,o;for(i=0;i<f.length;i++)for(n=t[f[i]],a=0;a<n.length;a++)if(o=a+1,o%=n.length,intersect_segments_2D(e,r,n[a],n[o],!0).length>0)return!0;return!1}(a,o)){i=b,f.splice(g,1),l=p.slice(0,n+1),h=p.slice(n),u=r.slice(i),d=r.slice(0,i+1),p=l.concat(u).concat(d).concat(h),y=n;break}if(i>=0)break;m[c]=!0}if(i>=0)break}}return p}(e,t),p=At.triangulate(d,!1);for(r=0,i=p.length;r<i;r++)for(a=p[r],n=0;n<3;n++)void 0!==(s=c[o=a[n].x+":"+a[n].y])&&(a[n]=s);return p.concat()},isClockWise:function(e){return At.area(e)<0},b2:function(){function b2p0(e,t){var r=1-e;return r*r*t}function b2p1(e,t){return 2*(1-e)*e*t}function b2p2(e,t){return e*e*t}return function b2(e,t,r,i){return b2p0(e,t)+b2p1(e,r)+b2p2(e,i)}}(),b3:function(){function b3p0(e,t){var r=1-e;return r*r*r*t}function b3p1(e,t){var r=1-e;return 3*r*r*e*t}function b3p2(e,t){return 3*(1-e)*e*e*t}function b3p3(e,t){return e*e*e*t}return function b3(e,t,r,i,n){return b3p0(e,t)+b3p1(e,r)+b3p2(e,i)+b3p3(e,n)}}()};ExtrudeGeometry.prototype=Object.create(Geometry.prototype),ExtrudeGeometry.prototype.constructor=ExtrudeGeometry,ExtrudeGeometry.prototype.addShapeList=function(e,t){for(var r=e.length,i=0;i<r;i++){var n=e[i];this.addShape(n,t)}},ExtrudeGeometry.prototype.addShape=function(e,t){function scalePt2(e,t,r){return t||console.error("THREE.ExtrudeGeometry: vec does not exist"),t.clone().multiplyScalar(r).add(e)}function getBevelVec(e,t,r){var i,n,a=1,o=e.x-t.x,s=e.y-t.y,c=r.x-e.x,l=r.y-e.y,h=o*o+s*s,u=o*l-s*c;if(Math.abs(u)>Number.EPSILON){var d=Math.sqrt(h),p=Math.sqrt(c*c+l*l),f=t.x-s/d,m=t.y+o/d,g=((r.x-l/p-f)*l-(r.y+c/p-m)*c)/(o*l-s*c),v=(i=f+o*g-e.x)*i+(n=m+s*g-e.y)*n;if(v<=2)return new Vector2(i,n);a=Math.sqrt(v/2)}else{var y=!1;o>Number.EPSILON?c>Number.EPSILON&&(y=!0):o<-Number.EPSILON?c<-Number.EPSILON&&(y=!0):Math.sign(s)===Math.sign(l)&&(y=!0),y?(i=-s,n=o,a=Math.sqrt(h)):(i=o,n=s,a=Math.sqrt(h/2))}return new Vector2(i/a,n/a)}function sidewalls(e,t){var r,i;for(F=e.length;--F>=0;){r=F,(i=F-1)<0&&(i=e.length-1);var n=0,a=p+2*h;for(n=0;n<a;n++){var o=D*n,s=D*(n+1);f4(t+r+o,t+i+o,t+i+s,t+r+s,e,n,a,r,i)}}}function v(e,t,r){_.vertices.push(new Vector3(e,t,r))}function f3(e,t,r){e+=M,t+=M,r+=M,_.faces.push(new Face3(e,t,r,null,null,0));var i=g.generateTopUV(_,e,t,r);_.faceVertexUvs[0].push(i)}function f4(e,t,r,i,n,a,o,s,c){e+=M,t+=M,r+=M,i+=M,_.faces.push(new Face3(e,t,i,null,null,1)),_.faces.push(new Face3(t,r,i,null,null,1));var l=g.generateSideWallUV(_,e,t,r,i);_.faceVertexUvs[0].push([l[0],l[1],l[3]]),_.faceVertexUvs[0].push([l[1],l[2],l[3]])}var r,i,n,a,o,s=void 0!==t.amount?t.amount:100,c=void 0!==t.bevelThickness?t.bevelThickness:6,l=void 0!==t.bevelSize?t.bevelSize:c-2,h=void 0!==t.bevelSegments?t.bevelSegments:3,u=void 0===t.bevelEnabled||t.bevelEnabled,d=void 0!==t.curveSegments?t.curveSegments:12,p=void 0!==t.steps?t.steps:1,f=t.extrudePath,m=!1,g=void 0!==t.UVGenerator?t.UVGenerator:ExtrudeGeometry.WorldUVGenerator;f&&(r=f.getSpacedPoints(p),m=!0,u=!1,i=void 0!==t.frames?t.frames:f.computeFrenetFrames(p,!1),n=new Vector3,a=new Vector3,o=new Vector3),u||(h=0,c=0,l=0);var y,x,b,_=this,M=this.vertices.length,w=e.extractPoints(d),T=w.shape,S=w.holes,E=!At.isClockWise(T);if(E){for(T=T.reverse(),x=0,b=S.length;x<b;x++)y=S[x],At.isClockWise(y)&&(S[x]=y.reverse());E=!1}var A=At.triangulateShape(T,S),L=T;for(x=0,b=S.length;x<b;x++)y=S[x],T=T.concat(y);for(var P,C,R,B,I,G,D=T.length,U=A.length,O=[],F=0,V=L.length,N=V-1,z=F+1;F<V;F++,N++,z++)N===V&&(N=0),z===V&&(z=0),O[F]=getBevelVec(L[F],L[N],L[z]);var H,k=[],j=O.concat();for(x=0,b=S.length;x<b;x++){for(y=S[x],H=[],F=0,N=(V=y.length)-1,z=F+1;F<V;F++,N++,z++)N===V&&(N=0),z===V&&(z=0),H[F]=getBevelVec(y[F],y[N],y[z]);k.push(H),j=j.concat(H)}for(P=0;P<h;P++){for(R=P/h,B=c*Math.cos(R*Math.PI/2),C=l*Math.sin(R*Math.PI/2),F=0,V=L.length;F<V;F++)v((I=scalePt2(L[F],O[F],C)).x,I.y,-B);for(x=0,b=S.length;x<b;x++)for(y=S[x],H=k[x],F=0,V=y.length;F<V;F++)v((I=scalePt2(y[F],H[F],C)).x,I.y,-B)}for(C=l,F=0;F<D;F++)I=u?scalePt2(T[F],j[F],C):T[F],m?(a.copy(i.normals[0]).multiplyScalar(I.x),n.copy(i.binormals[0]).multiplyScalar(I.y),o.copy(r[0]).add(a).add(n),v(o.x,o.y,o.z)):v(I.x,I.y,0);var W;for(W=1;W<=p;W++)for(F=0;F<D;F++)I=u?scalePt2(T[F],j[F],C):T[F],m?(a.copy(i.normals[W]).multiplyScalar(I.x),n.copy(i.binormals[W]).multiplyScalar(I.y),o.copy(r[W]).add(a).add(n),v(o.x,o.y,o.z)):v(I.x,I.y,s/p*W);for(P=h-1;P>=0;P--){for(R=P/h,B=c*Math.cos(R*Math.PI/2),C=l*Math.sin(R*Math.PI/2),F=0,V=L.length;F<V;F++)v((I=scalePt2(L[F],O[F],C)).x,I.y,s+B);for(x=0,b=S.length;x<b;x++)for(y=S[x],H=k[x],F=0,V=y.length;F<V;F++)I=scalePt2(y[F],H[F],C),m?v(I.x,I.y+r[p-1].y,r[p-1].x+B):v(I.x,I.y,s+B)}!function buildLidFaces(){if(u){var e=0,t=D*e;for(F=0;F<U;F++)f3((G=A[F])[2]+t,G[1]+t,G[0]+t);for(t=D*(e=p+2*h),F=0;F<U;F++)f3((G=A[F])[0]+t,G[1]+t,G[2]+t)}else{for(F=0;F<U;F++)f3((G=A[F])[2],G[1],G[0]);for(F=0;F<U;F++)f3((G=A[F])[0]+D*p,G[1]+D*p,G[2]+D*p)}}(),function buildSideFaces(){var e=0;for(sidewalls(L,e),e+=L.length,x=0,b=S.length;x<b;x++)sidewalls(y=S[x],e),e+=y.length}()},ExtrudeGeometry.WorldUVGenerator={generateTopUV:function(e,t,r,i){var n=e.vertices,a=n[t],o=n[r],s=n[i];return[new Vector2(a.x,a.y),new Vector2(o.x,o.y),new Vector2(s.x,s.y)]},generateSideWallUV:function(e,t,r,i,n){var a=e.vertices,o=a[t],s=a[r],c=a[i],l=a[n];return Math.abs(o.y-s.y)<.01?[new Vector2(o.x,1-o.z),new Vector2(s.x,1-s.z),new Vector2(c.x,1-c.z),new Vector2(l.x,1-l.z)]:[new Vector2(o.y,1-o.z),new Vector2(s.y,1-s.z),new Vector2(c.y,1-c.z),new Vector2(l.y,1-l.z)]}},(TextGeometry.prototype=Object.create(ExtrudeGeometry.prototype)).constructor=TextGeometry,SphereBufferGeometry.prototype=Object.create(BufferGeometry.prototype),SphereBufferGeometry.prototype.constructor=SphereBufferGeometry,SphereGeometry.prototype=Object.create(Geometry.prototype),SphereGeometry.prototype.constructor=SphereGeometry,RingBufferGeometry.prototype=Object.create(BufferGeometry.prototype),RingBufferGeometry.prototype.constructor=RingBufferGeometry,(RingGeometry.prototype=Object.create(Geometry.prototype)).constructor=RingGeometry,(PlaneGeometry.prototype=Object.create(Geometry.prototype)).constructor=PlaneGeometry,LatheBufferGeometry.prototype=Object.create(BufferGeometry.prototype),LatheBufferGeometry.prototype.constructor=LatheBufferGeometry,(LatheGeometry.prototype=Object.create(Geometry.prototype)).constructor=LatheGeometry,(ShapeGeometry.prototype=Object.create(Geometry.prototype)).constructor=ShapeGeometry,ShapeGeometry.prototype.addShapeList=function(e,t){for(var r=0,i=e.length;r<i;r++)this.addShape(e[r],t);return this},ShapeGeometry.prototype.addShape=function(e,t){void 0===t&&(t={});var r,i,n,a=void 0!==t.curveSegments?t.curveSegments:12,o=t.material,s=void 0===t.UVGenerator?ExtrudeGeometry.WorldUVGenerator:t.UVGenerator,c=this.vertices.length,l=e.extractPoints(a),h=l.shape,u=l.holes,d=!At.isClockWise(h);if(d){for(h=h.reverse(),r=0,i=u.length;r<i;r++)n=u[r],At.isClockWise(n)&&(u[r]=n.reverse());d=!1}var p=At.triangulateShape(h,u);for(r=0,i=u.length;r<i;r++)n=u[r],h=h.concat(n);var f,m,g=h.length,v=p.length;for(r=0;r<g;r++)f=h[r],this.vertices.push(new Vector3(f.x,f.y,0));for(r=0;r<v;r++){var y=(m=p[r])[0]+c,x=m[1]+c,b=m[2]+c;this.faces.push(new Face3(y,x,b,null,null,o)),this.faceVertexUvs[0].push(s.generateTopUV(this,y,x,b))}},EdgesGeometry.prototype=Object.create(BufferGeometry.prototype),EdgesGeometry.prototype.constructor=EdgesGeometry,CylinderBufferGeometry.prototype=Object.create(BufferGeometry.prototype),CylinderBufferGeometry.prototype.constructor=CylinderBufferGeometry,CylinderGeometry.prototype=Object.create(Geometry.prototype),CylinderGeometry.prototype.constructor=CylinderGeometry,(ConeGeometry.prototype=Object.create(CylinderGeometry.prototype)).constructor=ConeGeometry,(ConeBufferGeometry.prototype=Object.create(CylinderBufferGeometry.prototype)).constructor=ConeBufferGeometry,CircleBufferGeometry.prototype=Object.create(BufferGeometry.prototype),CircleBufferGeometry.prototype.constructor=CircleBufferGeometry,(CircleGeometry.prototype=Object.create(Geometry.prototype)).constructor=CircleGeometry,BoxGeometry.prototype=Object.create(Geometry.prototype),BoxGeometry.prototype.constructor=BoxGeometry;var Lt=Object.freeze({WireframeGeometry:WireframeGeometry,ParametricGeometry:ParametricGeometry,ParametricBufferGeometry:ParametricBufferGeometry,TetrahedronGeometry:TetrahedronGeometry,TetrahedronBufferGeometry:TetrahedronBufferGeometry,OctahedronGeometry:OctahedronGeometry,OctahedronBufferGeometry:OctahedronBufferGeometry,IcosahedronGeometry:IcosahedronGeometry,IcosahedronBufferGeometry:IcosahedronBufferGeometry,DodecahedronGeometry:DodecahedronGeometry,DodecahedronBufferGeometry:DodecahedronBufferGeometry,PolyhedronGeometry:PolyhedronGeometry,PolyhedronBufferGeometry:PolyhedronBufferGeometry,TubeGeometry:TubeGeometry,TubeBufferGeometry:TubeBufferGeometry,TorusKnotGeometry:TorusKnotGeometry,TorusKnotBufferGeometry:TorusKnotBufferGeometry,TorusGeometry:TorusGeometry,TorusBufferGeometry:TorusBufferGeometry,TextGeometry:TextGeometry,SphereBufferGeometry:SphereBufferGeometry,SphereGeometry:SphereGeometry,RingGeometry:RingGeometry,RingBufferGeometry:RingBufferGeometry,PlaneBufferGeometry:PlaneBufferGeometry,PlaneGeometry:PlaneGeometry,LatheGeometry:LatheGeometry,LatheBufferGeometry:LatheBufferGeometry,ShapeGeometry:ShapeGeometry,ExtrudeGeometry:ExtrudeGeometry,EdgesGeometry:EdgesGeometry,ConeGeometry:ConeGeometry,ConeBufferGeometry:ConeBufferGeometry,CylinderGeometry:CylinderGeometry,CylinderBufferGeometry:CylinderBufferGeometry,CircleBufferGeometry:CircleBufferGeometry,CircleGeometry:CircleGeometry,BoxBufferGeometry:BoxBufferGeometry,BoxGeometry:BoxGeometry});(ShadowMaterial.prototype=Object.create(ShaderMaterial.prototype)).constructor=ShadowMaterial,ShadowMaterial.prototype.isShadowMaterial=!0,(RawShaderMaterial.prototype=Object.create(ShaderMaterial.prototype)).constructor=RawShaderMaterial,RawShaderMaterial.prototype.isRawShaderMaterial=!0,MultiMaterial.prototype={constructor:MultiMaterial,isMultiMaterial:!0,toJSON:function(e){for(var t={metadata:{version:4.2,type:"material",generator:"MaterialExporter"},uuid:this.uuid,type:this.type,materials:[]},r=this.materials,i=0,n=r.length;i<n;i++){var a=r[i].toJSON(e);delete a.metadata,t.materials.push(a)}return t.visible=this.visible,t},clone:function(){for(var e=new this.constructor,t=0;t<this.materials.length;t++)e.materials.push(this.materials[t].clone());return e.visible=this.visible,e}},MeshStandardMaterial.prototype=Object.create(Material.prototype),MeshStandardMaterial.prototype.constructor=MeshStandardMaterial,MeshStandardMaterial.prototype.isMeshStandardMaterial=!0,MeshStandardMaterial.prototype.copy=function(e){return Material.prototype.copy.call(this,e),this.defines={STANDARD:""},this.color.copy(e.color),this.roughness=e.roughness,this.metalness=e.metalness,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.roughnessMap=e.roughnessMap,this.metalnessMap=e.metalnessMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapIntensity=e.envMapIntensity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this},(MeshPhysicalMaterial.prototype=Object.create(MeshStandardMaterial.prototype)).constructor=MeshPhysicalMaterial,MeshPhysicalMaterial.prototype.isMeshPhysicalMaterial=!0,MeshPhysicalMaterial.prototype.copy=function(e){return MeshStandardMaterial.prototype.copy.call(this,e),this.defines={PHYSICAL:""},this.reflectivity=e.reflectivity,this.clearCoat=e.clearCoat,this.clearCoatRoughness=e.clearCoatRoughness,this},(MeshPhongMaterial.prototype=Object.create(Material.prototype)).constructor=MeshPhongMaterial,MeshPhongMaterial.prototype.isMeshPhongMaterial=!0,MeshPhongMaterial.prototype.copy=function(e){return Material.prototype.copy.call(this,e),this.color.copy(e.color),this.specular.copy(e.specular),this.shininess=e.shininess,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this},(MeshNormalMaterial.prototype=Object.create(Material.prototype)).constructor=MeshNormalMaterial,MeshNormalMaterial.prototype.isMeshNormalMaterial=!0,MeshNormalMaterial.prototype.copy=function(e){return Material.prototype.copy.call(this,e),this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this},(MeshLambertMaterial.prototype=Object.create(Material.prototype)).constructor=MeshLambertMaterial,MeshLambertMaterial.prototype.isMeshLambertMaterial=!0,MeshLambertMaterial.prototype.copy=function(e){return Material.prototype.copy.call(this,e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this},(LineDashedMaterial.prototype=Object.create(Material.prototype)).constructor=LineDashedMaterial,LineDashedMaterial.prototype.isLineDashedMaterial=!0,LineDashedMaterial.prototype.copy=function(e){return Material.prototype.copy.call(this,e),this.color.copy(e.color),this.linewidth=e.linewidth,this.scale=e.scale,this.dashSize=e.dashSize,this.gapSize=e.gapSize,this};var Pt=Object.freeze({ShadowMaterial:ShadowMaterial,SpriteMaterial:SpriteMaterial,RawShaderMaterial:RawShaderMaterial,ShaderMaterial:ShaderMaterial,PointsMaterial:PointsMaterial,MultiMaterial:MultiMaterial,MeshPhysicalMaterial:MeshPhysicalMaterial,MeshStandardMaterial:MeshStandardMaterial,MeshPhongMaterial:MeshPhongMaterial,MeshNormalMaterial:MeshNormalMaterial,MeshLambertMaterial:MeshLambertMaterial,MeshDepthMaterial:MeshDepthMaterial,MeshBasicMaterial:MeshBasicMaterial,LineDashedMaterial:LineDashedMaterial,LineBasicMaterial:LineBasicMaterial,Material:Material}),Ct={enabled:!1,files:{},add:function(e,t){!1!==this.enabled&&(this.files[e]=t)},get:function(e){if(!1!==this.enabled)return this.files[e]},remove:function(e){delete this.files[e]},clear:function(){this.files={}}},Rt=new LoadingManager;Object.assign(XHRLoader.prototype,{load:function(e,t,r,i){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e);var n=this,a=Ct.get(e);if(void 0!==a)return n.manager.itemStart(e),setTimeout(function(){t&&t(a),n.manager.itemEnd(e)},0),a;var o=/^data:(.*?)(;base64)?,(.*)$/,s=e.match(o);if(s){var c=s[1],l=!!s[2],h=s[3];h=window.decodeURIComponent(h),l&&(h=window.atob(h));try{var u,d=(this.responseType||"").toLowerCase();switch(d){case"arraybuffer":case"blob":u=new ArrayBuffer(h.length);for(var p=new Uint8Array(u),f=0;f<h.length;f++)p[f]=h.charCodeAt(f);"blob"===d&&(u=new Blob([u],{type:c}));break;case"document":var m=new DOMParser;u=m.parseFromString(h,c);break;case"json":u=JSON.parse(h);break;default:u=h}window.setTimeout(function(){t&&t(u),n.manager.itemEnd(e)},0)}catch(t){window.setTimeout(function(){i&&i(t),n.manager.itemError(e)},0)}}else{var g=new XMLHttpRequest;g.open("GET",e,!0),g.addEventListener("load",function(r){var a=r.target.response;Ct.add(e,a),200===this.status?(t&&t(a),n.manager.itemEnd(e)):0===this.status?(console.warn("THREE.XHRLoader: HTTP Status 0 received."),t&&t(a),n.manager.itemEnd(e)):(i&&i(r),n.manager.itemError(e))},!1),void 0!==r&&g.addEventListener("progress",function(e){r(e)},!1),g.addEventListener("error",function(t){i&&i(t),n.manager.itemError(e)},!1),void 0!==this.responseType&&(g.responseType=this.responseType),void 0!==this.withCredentials&&(g.withCredentials=this.withCredentials),g.overrideMimeType&&g.overrideMimeType("text/plain"),g.send(null)}return n.manager.itemStart(e),g},setPath:function(e){return this.path=e,this},setResponseType:function(e){return this.responseType=e,this},setWithCredentials:function(e){return this.withCredentials=e,this}}),Object.assign(CompressedTextureLoader.prototype,{load:function(e,t,r,i){var n=this,a=[],o=new CompressedTexture;o.image=a;var s=new XHRLoader(this.manager);if(s.setPath(this.path),s.setResponseType("arraybuffer"),Array.isArray(e))for(var c=0,l=0,h=e.length;l<h;++l)!function loadTexture(l){s.load(e[l],function(e){var r=n._parser(e,!0);a[l]={width:r.width,height:r.height,format:r.format,mipmaps:r.mipmaps},6===(c+=1)&&(1===r.mipmapCount&&(o.minFilter=ye),o.format=r.format,o.needsUpdate=!0,t&&t(o))},r,i)}(l);else s.load(e,function(e){var r=n._parser(e,!0);if(r.isCubemap)for(var i=r.mipmaps.length/r.mipmapCount,s=0;s<i;s++){a[s]={mipmaps:[]};for(var c=0;c<r.mipmapCount;c++)a[s].mipmaps.push(r.mipmaps[s*r.mipmapCount+c]),a[s].format=r.format,a[s].width=r.width,a[s].height=r.height}else o.image.width=r.width,o.image.height=r.height,o.mipmaps=r.mipmaps;1===r.mipmapCount&&(o.minFilter=ye),o.format=r.format,o.needsUpdate=!0,t&&t(o)},r,i);return o},setPath:function(e){return this.path=e,this}});var Bt=BinaryTextureLoader;Object.assign(BinaryTextureLoader.prototype,{load:function(e,t,r,i){var n=this,a=new DataTexture,o=new XHRLoader(this.manager);return o.setResponseType("arraybuffer"),o.load(e,function(e){var r=n._parser(e);r&&(void 0!==r.image?a.image=r.image:void 0!==r.data&&(a.image.width=r.width,a.image.height=r.height,a.image.data=r.data),a.wrapS=void 0!==r.wrapS?r.wrapS:de,a.wrapT=void 0!==r.wrapT?r.wrapT:de,a.magFilter=void 0!==r.magFilter?r.magFilter:ye,a.minFilter=void 0!==r.minFilter?r.minFilter:be,a.anisotropy=void 0!==r.anisotropy?r.anisotropy:1,void 0!==r.format&&(a.format=r.format),void 0!==r.type&&(a.type=r.type),void 0!==r.mipmaps&&(a.mipmaps=r.mipmaps),1===r.mipmapCount&&(a.minFilter=ye),a.needsUpdate=!0,t&&t(a,r))},r,i),a}}),Object.assign(ImageLoader.prototype,{load:function(e,t,r,i){var n=this,a=document.createElementNS("http://www.w3.org/1999/xhtml","img");if(a.onload=function(){a.onload=null,URL.revokeObjectURL(a.src),t&&t(a),n.manager.itemEnd(e)},a.onerror=i,0===e.indexOf("data:"))a.src=e;else{var o=new XHRLoader;o.setPath(this.path),o.setResponseType("blob"),o.setWithCredentials(this.withCredentials),o.load(e,function(e){a.src=URL.createObjectURL(e)},r,i)}return n.manager.itemStart(e),a},setCrossOrigin:function(e){return this.crossOrigin=e,this},setWithCredentials:function(e){return this.withCredentials=e,this},setPath:function(e){return this.path=e,this}}),Object.assign(CubeTextureLoader.prototype,{load:function(e,t,r,i){var n=new CubeTexture,a=new ImageLoader(this.manager);a.setCrossOrigin(this.crossOrigin),a.setPath(this.path);for(var o=0,s=0;s<e.length;++s)!function loadTexture(r){a.load(e[r],function(e){n.images[r]=e,6==++o&&(n.needsUpdate=!0,t&&t(n))},void 0,i)}(s);return n},setCrossOrigin:function(e){return this.crossOrigin=e,this},setPath:function(e){return this.path=e,this}}),Object.assign(TextureLoader.prototype,{load:function(e,t,r,i){var n=new Texture,a=new ImageLoader(this.manager);return a.setCrossOrigin(this.crossOrigin),a.setWithCredentials(this.withCredentials),a.setPath(this.path),a.load(e,function(r){var i=e.search(/\.(jpg|jpeg)$/)>0||0===e.search(/^data\:image\/jpeg/);n.format=i?De:Ue,n.image=r,n.needsUpdate=!0,void 0!==t&&t(n)},r,i),n},setCrossOrigin:function(e){return this.crossOrigin=e,this},setWithCredentials:function(e){return this.withCredentials=e,this},setPath:function(e){return this.path=e,this}}),Light.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:Light,isLight:!0,copy:function(e){return Object3D.prototype.copy.call(this,e),this.color.copy(e.color),this.intensity=e.intensity,this},toJSON:function(e){var t=Object3D.prototype.toJSON.call(this,e);return t.object.color=this.color.getHex(),t.object.intensity=this.intensity,void 0!==this.groundColor&&(t.object.groundColor=this.groundColor.getHex()),void 0!==this.distance&&(t.object.distance=this.distance),void 0!==this.angle&&(t.object.angle=this.angle),void 0!==this.decay&&(t.object.decay=this.decay),void 0!==this.penumbra&&(t.object.penumbra=this.penumbra),void 0!==this.shadow&&(t.object.shadow=this.shadow.toJSON()),t}}),HemisphereLight.prototype=Object.assign(Object.create(Light.prototype),{constructor:HemisphereLight,isHemisphereLight:!0,copy:function(e){return Light.prototype.copy.call(this,e),this.groundColor.copy(e.groundColor),this}}),Object.assign(LightShadow.prototype,{copy:function(e){return this.camera=e.camera.clone(),this.bias=e.bias,this.radius=e.radius,this.mapSize.copy(e.mapSize),this},clone:function(){return(new this.constructor).copy(this)},toJSON:function(){var e={};return 0!==this.bias&&(e.bias=this.bias),1!==this.radius&&(e.radius=this.radius),512===this.mapSize.x&&512===this.mapSize.y||(e.mapSize=this.mapSize.toArray()),e.camera=this.camera.toJSON(!1).object,delete e.camera.matrix,e}}),SpotLightShadow.prototype=Object.assign(Object.create(LightShadow.prototype),{constructor:SpotLightShadow,isSpotLightShadow:!0,update:function(e){var t=2*ut.RAD2DEG*e.angle,r=this.mapSize.width/this.mapSize.height,i=e.distance||500,n=this.camera;t===n.fov&&r===n.aspect&&i===n.far||(n.fov=t,n.aspect=r,n.far=i,n.updateProjectionMatrix())}}),SpotLight.prototype=Object.assign(Object.create(Light.prototype),{constructor:SpotLight,isSpotLight:!0,copy:function(e){return Light.prototype.copy.call(this,e),this.distance=e.distance,this.angle=e.angle,this.penumbra=e.penumbra,this.decay=e.decay,this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}}),PointLight.prototype=Object.assign(Object.create(Light.prototype),{constructor:PointLight,isPointLight:!0,copy:function(e){return Light.prototype.copy.call(this,e),this.distance=e.distance,this.decay=e.decay,this.shadow=e.shadow.clone(),this}}),DirectionalLightShadow.prototype=Object.assign(Object.create(LightShadow.prototype),{constructor:DirectionalLightShadow}),DirectionalLight.prototype=Object.assign(Object.create(Light.prototype),{constructor:DirectionalLight,isDirectionalLight:!0,copy:function(e){return Light.prototype.copy.call(this,e),this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}}),AmbientLight.prototype=Object.assign(Object.create(Light.prototype),{constructor:AmbientLight,isAmbientLight:!0});var It={arraySlice:function(e,t,r){return It.isTypedArray(e)?new e.constructor(e.subarray(t,r)):e.slice(t,r)},convertArray:function(e,t,r){return!e||!r&&e.constructor===t?e:"number"==typeof t.BYTES_PER_ELEMENT?new t(e):Array.prototype.slice.call(e)},isTypedArray:function(e){return ArrayBuffer.isView(e)&&!(e instanceof DataView)},getKeyframeOrder:function(e){for(var t=e.length,r=new Array(t),i=0;i!==t;++i)r[i]=i;return r.sort(function compareTime(t,r){return e[t]-e[r]}),r},sortedArray:function(e,t,r){for(var i=e.length,n=new e.constructor(i),a=0,o=0;o!==i;++a)for(var s=r[a]*t,c=0;c!==t;++c)n[o++]=e[s+c];return n},flattenJSON:function(e,t,r,i){for(var n=1,a=e[0];void 0!==a&&void 0===a[i];)a=e[n++];if(void 0!==a){var o=a[i];if(void 0!==o)if(Array.isArray(o))do{void 0!==(o=a[i])&&(t.push(a.time),r.push.apply(r,o)),a=e[n++]}while(void 0!==a);else if(void 0!==o.toArray)do{void 0!==(o=a[i])&&(t.push(a.time),o.toArray(r,r.length)),a=e[n++]}while(void 0!==a);else do{void 0!==(o=a[i])&&(t.push(a.time),r.push(o)),a=e[n++]}while(void 0!==a)}}};Interpolant.prototype={constructor:Interpolant,evaluate:function(e){var t=this.parameterPositions,r=this._cachedIndex,i=t[r],n=t[r-1];e:{t:{var a;r:{i:if(!(e<i)){for(s=r+2;;){if(void 0===i){if(e<n)break i;return r=t.length,this._cachedIndex=r,this.afterEnd_(r-1,e,n)}if(r===s)break;if(n=i,i=t[++r],e<i)break t}a=t.length;break r}{if(e>=n)break e;var o=t[1];e<o&&(r=2,n=o);for(var s=r-2;;){if(void 0===n)return this._cachedIndex=0,this.beforeStart_(0,e,i);if(r===s)break;if(i=n,n=t[--r-1],e>=n)break t}a=r,r=0}}for(;r<a;){var c=r+a>>>1;e<t[c]?a=c:r=c+1}if(i=t[r],void 0===(n=t[r-1]))return this._cachedIndex=0,this.beforeStart_(0,e,i);if(void 0===i)return r=t.length,this._cachedIndex=r,this.afterEnd_(r-1,n,e)}this._cachedIndex=r,this.intervalChanged_(r,n,i)}return this.interpolate_(r,n,e,i)},settings:null,DefaultSettings_:{},getSettings_:function(){return this.settings||this.DefaultSettings_},copySampleValue_:function(e){for(var t=this.resultBuffer,r=this.sampleValues,i=this.valueSize,n=e*i,a=0;a!==i;++a)t[a]=r[n+a];return t},interpolate_:function(e,t,r,i){throw new Error("call to abstract method")},intervalChanged_:function(e,t,r){}},Object.assign(Interpolant.prototype,{beforeStart_:Interpolant.prototype.copySampleValue_,afterEnd_:Interpolant.prototype.copySampleValue_}),CubicInterpolant.prototype=Object.assign(Object.create(Interpolant.prototype),{constructor:CubicInterpolant,DefaultSettings_:{endingStart:Je,endingEnd:Je},intervalChanged_:function(e,t,r){var i=this.parameterPositions,n=e-2,a=e+1,o=i[n],s=i[a];if(void 0===o)switch(this.getSettings_().endingStart){case 2401:n=e,o=2*t-r;break;case 2402:o=t+i[n=i.length-2]-i[n+1];break;default:n=e,o=r}if(void 0===s)switch(this.getSettings_().endingEnd){case 2401:a=e,s=2*r-t;break;case 2402:a=1,s=r+i[1]-i[0];break;default:a=e-1,s=t}var c=.5*(r-t),l=this.valueSize;this._weightPrev=c/(t-o),this._weightNext=c/(s-r),this._offsetPrev=n*l,this._offsetNext=a*l},interpolate_:function(e,t,r,i){for(var n=this.resultBuffer,a=this.sampleValues,o=this.valueSize,s=e*o,c=s-o,l=this._offsetPrev,h=this._offsetNext,u=this._weightPrev,d=this._weightNext,p=(r-t)/(i-t),f=p*p,m=f*p,g=-u*m+2*u*f-u*p,v=(1+u)*m+(-1.5-2*u)*f+(-.5+u)*p+1,y=(-1-d)*m+(1.5+d)*f+.5*p,x=d*m-d*f,b=0;b!==o;++b)n[b]=g*a[l+b]+v*a[c+b]+y*a[s+b]+x*a[h+b];return n}}),LinearInterpolant.prototype=Object.assign(Object.create(Interpolant.prototype),{constructor:LinearInterpolant,interpolate_:function(e,t,r,i){for(var n=this.resultBuffer,a=this.sampleValues,o=this.valueSize,s=e*o,c=s-o,l=(r-t)/(i-t),h=1-l,u=0;u!==o;++u)n[u]=a[c+u]*h+a[s+u]*l;return n}}),DiscreteInterpolant.prototype=Object.assign(Object.create(Interpolant.prototype),{constructor:DiscreteInterpolant,interpolate_:function(e,t,r,i){return this.copySampleValue_(e-1)}});var Gt;Gt={TimeBufferType:Float32Array,ValueBufferType:Float32Array,DefaultInterpolation:2301,InterpolantFactoryMethodDiscrete:function(e){return new DiscreteInterpolant(this.times,this.values,this.getValueSize(),e)},InterpolantFactoryMethodLinear:function(e){return new LinearInterpolant(this.times,this.values,this.getValueSize(),e)},InterpolantFactoryMethodSmooth:function(e){return new CubicInterpolant(this.times,this.values,this.getValueSize(),e)},setInterpolation:function(e){var t;switch(e){case 2300:t=this.InterpolantFactoryMethodDiscrete;break;case 2301:t=this.InterpolantFactoryMethodLinear;break;case 2302:t=this.InterpolantFactoryMethodSmooth}if(void 0!==t)this.createInterpolant=t;else{var r="unsupported interpolation for "+this.ValueTypeName+" keyframe track named "+this.name;if(void 0===this.createInterpolant){if(e===this.DefaultInterpolation)throw new Error(r);this.setInterpolation(this.DefaultInterpolation)}console.warn(r)}},getInterpolation:function(){switch(this.createInterpolant){case this.InterpolantFactoryMethodDiscrete:return 2300;case this.InterpolantFactoryMethodLinear:return 2301;case this.InterpolantFactoryMethodSmooth:return 2302}},getValueSize:function(){return this.values.length/this.times.length},shift:function(e){if(0!==e)for(var t=this.times,r=0,i=t.length;r!==i;++r)t[r]+=e;return this},scale:function(e){if(1!==e)for(var t=this.times,r=0,i=t.length;r!==i;++r)t[r]*=e;return this},trim:function(e,t){for(var r=this.times,i=r.length,n=0,a=i-1;n!==i&&r[n]<e;)++n;for(;-1!==a&&r[a]>t;)--a;if(++a,0!==n||a!==i){n>=a&&(a=Math.max(a,1),n=a-1);var o=this.getValueSize();this.times=It.arraySlice(r,n,a),this.values=It.arraySlice(this.values,n*o,a*o)}return this},validate:function(){var e=!0,t=this.getValueSize();t-Math.floor(t)!=0&&(console.error("invalid value size in track",this),e=!1);var r=this.times,i=this.values,n=r.length;0===n&&(console.error("track is empty",this),e=!1);for(var a=null,o=0;o!==n;o++){var s=r[o];if("number"==typeof s&&isNaN(s)){console.error("time is not a valid number",this,o,s),e=!1;break}if(null!==a&&a>s){console.error("out of order keys",this,o,s,a),e=!1;break}a=s}if(void 0!==i&&It.isTypedArray(i))for(var o=0,c=i.length;o!==c;++o){var l=i[o];if(isNaN(l)){console.error("value is not a valid number",this,o,l),e=!1;break}}return e},optimize:function(){for(var e=this.times,t=this.values,r=this.getValueSize(),i=2302===this.getInterpolation(),n=1,a=e.length-1,o=1;o<a;++o){var s=!1,c=e[o];if(c!==e[o+1]&&(1!==o||c!==c[0]))if(i)s=!0;else for(var l=o*r,h=l-r,u=l+r,d=0;d!==r;++d){var p=t[l+d];if(p!==t[h+d]||p!==t[u+d]){s=!0;break}}if(s){if(o!==n){e[n]=e[o];for(var f=o*r,m=n*r,d=0;d!==r;++d)t[m+d]=t[f+d]}++n}}if(a>0){e[n]=e[a];for(var f=a*r,m=n*r,d=0;d!==r;++d)t[m+d]=t[f+d];++n}return n!==e.length&&(this.times=It.arraySlice(e,0,n),this.values=It.arraySlice(t,0,n*r)),this}},VectorKeyframeTrack.prototype=Object.assign(Object.create(Gt),{constructor:VectorKeyframeTrack,ValueTypeName:"vector"}),QuaternionLinearInterpolant.prototype=Object.assign(Object.create(Interpolant.prototype),{constructor:QuaternionLinearInterpolant,interpolate_:function(e,t,r,i){for(var n=this.resultBuffer,a=this.sampleValues,o=this.valueSize,s=e*o,c=(r-t)/(i-t),l=s+o;s!==l;s+=4)Quaternion.slerpFlat(n,0,a,s-o,a,s,c);return n}}),QuaternionKeyframeTrack.prototype=Object.assign(Object.create(Gt),{constructor:QuaternionKeyframeTrack,ValueTypeName:"quaternion",DefaultInterpolation:2301,InterpolantFactoryMethodLinear:function(e){return new QuaternionLinearInterpolant(this.times,this.values,this.getValueSize(),e)},InterpolantFactoryMethodSmooth:void 0}),NumberKeyframeTrack.prototype=Object.assign(Object.create(Gt),{constructor:NumberKeyframeTrack,ValueTypeName:"number"}),StringKeyframeTrack.prototype=Object.assign(Object.create(Gt),{constructor:StringKeyframeTrack,ValueTypeName:"string",ValueBufferType:Array,DefaultInterpolation:2300,InterpolantFactoryMethodLinear:void 0,InterpolantFactoryMethodSmooth:void 0}),BooleanKeyframeTrack.prototype=Object.assign(Object.create(Gt),{constructor:BooleanKeyframeTrack,ValueTypeName:"bool",ValueBufferType:Array,DefaultInterpolation:2300,InterpolantFactoryMethodLinear:void 0,InterpolantFactoryMethodSmooth:void 0}),ColorKeyframeTrack.prototype=Object.assign(Object.create(Gt),{constructor:ColorKeyframeTrack,ValueTypeName:"color"}),KeyframeTrack.prototype=Gt,Gt.constructor=KeyframeTrack,Object.assign(KeyframeTrack,{parse:function(e){if(void 0===e.type)throw new Error("track type undefined, can not parse");var t=KeyframeTrack._getTrackTypeForValueTypeName(e.type);if(void 0===e.times){var r=[],i=[];It.flattenJSON(e.keys,r,i,"value"),e.times=r,e.values=i}return void 0!==t.parse?t.parse(e):new t(e.name,e.times,e.values,e.interpolation)},toJSON:function(e){var t,r=e.constructor;if(void 0!==r.toJSON)t=r.toJSON(e);else{t={name:e.name,times:It.convertArray(e.times,Array),values:It.convertArray(e.values,Array)};var i=e.getInterpolation();i!==e.DefaultInterpolation&&(t.interpolation=i)}return t.type=e.ValueTypeName,t},_getTrackTypeForValueTypeName:function(e){switch(e.toLowerCase()){case"scalar":case"double":case"float":case"number":case"integer":return NumberKeyframeTrack;case"vector":case"vector2":case"vector3":case"vector4":return VectorKeyframeTrack;case"color":return ColorKeyframeTrack;case"quaternion":return QuaternionKeyframeTrack;case"bool":case"boolean":return BooleanKeyframeTrack;case"string":return StringKeyframeTrack}throw new Error("Unsupported typeName: "+e)}}),AnimationClip.prototype={constructor:AnimationClip,resetDuration:function(){for(var e=0,t=0,r=this.tracks.length;t!==r;++t){var i=this.tracks[t];e=Math.max(e,i.times[i.times.length-1])}this.duration=e},trim:function(){for(var e=0;e<this.tracks.length;e++)this.tracks[e].trim(0,this.duration);return this},optimize:function(){for(var e=0;e<this.tracks.length;e++)this.tracks[e].optimize();return this}},Object.assign(AnimationClip,{parse:function(e){for(var t=[],r=e.tracks,i=1/(e.fps||1),n=0,a=r.length;n!==a;++n)t.push(KeyframeTrack.parse(r[n]).scale(i));return new AnimationClip(e.name,e.duration,t)},toJSON:function(e){for(var t=[],r=e.tracks,i={name:e.name,duration:e.duration,tracks:t},n=0,a=r.length;n!==a;++n)t.push(KeyframeTrack.toJSON(r[n]));return i},CreateFromMorphTargetSequence:function(e,t,r,i){for(var n=t.length,a=[],o=0;o<n;o++){var s=[],c=[];s.push((o+n-1)%n,o,(o+1)%n),c.push(0,1,0);var l=It.getKeyframeOrder(s);s=It.sortedArray(s,1,l),c=It.sortedArray(c,1,l),i||0!==s[0]||(s.push(n),c.push(c[0])),a.push(new NumberKeyframeTrack(".morphTargetInfluences["+t[o].name+"]",s,c).scale(1/r))}return new AnimationClip(e,-1,a)},findByName:function(e,t){var r=e;if(!Array.isArray(e)){var i=e;r=i.geometry&&i.geometry.animations||i.animations}for(var n=0;n<r.length;n++)if(r[n].name===t)return r[n];return null},CreateClipsFromMorphTargetSequences:function(e,t,r){for(var i={},n=/^([\w-]*?)([\d]+)$/,a=0,o=e.length;a<o;a++){var s=e[a],c=s.name.match(n);if(c&&c.length>1){var l=i[u=c[1]];l||(i[u]=l=[]),l.push(s)}}var h=[];for(var u in i)h.push(AnimationClip.CreateFromMorphTargetSequence(u,i[u],t,r));return h},parseAnimation:function(e,t){if(!e)return console.error("  no animation in JSONLoader data"),null;for(var r=function(e,t,r,i,n){if(0!==r.length){var a=[],o=[];It.flattenJSON(r,a,o,i),0!==a.length&&n.push(new e(t,a,o))}},i=[],n=e.name||"default",a=e.length||-1,o=e.fps||30,s=e.hierarchy||[],c=0;c<s.length;c++){var l=s[c].keys;if(l&&0!==l.length)if(l[0].morphTargets){for(var h={},u=0;u<l.length;u++)if(l[u].morphTargets)for(m=0;m<l[u].morphTargets.length;m++)h[l[u].morphTargets[m]]=-1;for(var d in h){for(var p=[],f=[],m=0;m!==l[u].morphTargets.length;++m){var g=l[u];p.push(g.time),f.push(g.morphTarget===d?1:0)}i.push(new NumberKeyframeTrack(".morphTargetInfluence["+d+"]",p,f))}a=h.length*(o||1)}else{var v=".bones["+t[c].name+"]";r(VectorKeyframeTrack,v+".position",l,"pos",i),r(QuaternionKeyframeTrack,v+".quaternion",l,"rot",i),r(VectorKeyframeTrack,v+".scale",l,"scl",i)}}return 0===i.length?null:new AnimationClip(n,a,i)}}),Object.assign(MaterialLoader.prototype,{load:function(e,t,r,i){var n=this;new XHRLoader(n.manager).load(e,function(e){t(n.parse(JSON.parse(e)))},r,i)},setTextures:function(e){this.textures=e},parse:function(e){function getTexture(e){return void 0===t[e]&&console.warn("THREE.MaterialLoader: Undefined texture",e),t[e]}var t=this.textures,r=new Pt[e.type];if(void 0!==e.uuid&&(r.uuid=e.uuid),void 0!==e.name&&(r.name=e.name),void 0!==e.color&&r.color.setHex(e.color),void 0!==e.roughness&&(r.roughness=e.roughness),void 0!==e.metalness&&(r.metalness=e.metalness),void 0!==e.emissive&&r.emissive.setHex(e.emissive),void 0!==e.specular&&r.specular.setHex(e.specular),void 0!==e.shininess&&(r.shininess=e.shininess),void 0!==e.uniforms&&(r.uniforms=e.uniforms),void 0!==e.vertexShader&&(r.vertexShader=e.vertexShader),void 0!==e.fragmentShader&&(r.fragmentShader=e.fragmentShader),void 0!==e.vertexColors&&(r.vertexColors=e.vertexColors),void 0!==e.fog&&(r.fog=e.fog),void 0!==e.shading&&(r.shading=e.shading),void 0!==e.blending&&(r.blending=e.blending),void 0!==e.side&&(r.side=e.side),void 0!==e.opacity&&(r.opacity=e.opacity),void 0!==e.transparent&&(r.transparent=e.transparent),void 0!==e.alphaTest&&(r.alphaTest=e.alphaTest),void 0!==e.depthTest&&(r.depthTest=e.depthTest),void 0!==e.depthWrite&&(r.depthWrite=e.depthWrite),void 0!==e.colorWrite&&(r.colorWrite=e.colorWrite),void 0!==e.wireframe&&(r.wireframe=e.wireframe),void 0!==e.wireframeLinewidth&&(r.wireframeLinewidth=e.wireframeLinewidth),void 0!==e.wireframeLinecap&&(r.wireframeLinecap=e.wireframeLinecap),void 0!==e.wireframeLinejoin&&(r.wireframeLinejoin=e.wireframeLinejoin),void 0!==e.skinning&&(r.skinning=e.skinning),void 0!==e.morphTargets&&(r.morphTargets=e.morphTargets),void 0!==e.size&&(r.size=e.size),void 0!==e.sizeAttenuation&&(r.sizeAttenuation=e.sizeAttenuation),void 0!==e.map&&(r.map=getTexture(e.map)),void 0!==e.alphaMap&&(r.alphaMap=getTexture(e.alphaMap),r.transparent=!0),void 0!==e.bumpMap&&(r.bumpMap=getTexture(e.bumpMap)),void 0!==e.bumpScale&&(r.bumpScale=e.bumpScale),void 0!==e.normalMap&&(r.normalMap=getTexture(e.normalMap)),void 0!==e.normalScale){var i=e.normalScale;!1===Array.isArray(i)&&(i=[i,i]),r.normalScale=(new Vector2).fromArray(i)}if(void 0!==e.displacementMap&&(r.displacementMap=getTexture(e.displacementMap)),void 0!==e.displacementScale&&(r.displacementScale=e.displacementScale),void 0!==e.displacementBias&&(r.displacementBias=e.displacementBias),void 0!==e.roughnessMap&&(r.roughnessMap=getTexture(e.roughnessMap)),void 0!==e.metalnessMap&&(r.metalnessMap=getTexture(e.metalnessMap)),void 0!==e.emissiveMap&&(r.emissiveMap=getTexture(e.emissiveMap)),void 0!==e.emissiveIntensity&&(r.emissiveIntensity=e.emissiveIntensity),void 0!==e.specularMap&&(r.specularMap=getTexture(e.specularMap)),void 0!==e.envMap&&(r.envMap=getTexture(e.envMap)),void 0!==e.reflectivity&&(r.reflectivity=e.reflectivity),void 0!==e.lightMap&&(r.lightMap=getTexture(e.lightMap)),void 0!==e.lightMapIntensity&&(r.lightMapIntensity=e.lightMapIntensity),void 0!==e.aoMap&&(r.aoMap=getTexture(e.aoMap)),void 0!==e.aoMapIntensity&&(r.aoMapIntensity=e.aoMapIntensity),void 0!==e.materials)for(var n=0,a=e.materials.length;n<a;n++)r.materials.push(this.parse(e.materials[n]));return r}}),Object.assign(BufferGeometryLoader.prototype,{load:function(e,t,r,i){var n=this;new XHRLoader(n.manager).load(e,function(e){t(n.parse(JSON.parse(e)))},r,i)},parse:function(e){var t=new BufferGeometry,r=e.data.index,i={Int8Array:Int8Array,Uint8Array:Uint8Array,Uint8ClampedArray:Uint8ClampedArray,Int16Array:Int16Array,Uint16Array:Uint16Array,Int32Array:Int32Array,Uint32Array:Uint32Array,Float32Array:Float32Array,Float64Array:Float64Array};if(void 0!==r){s=new i[r.type](r.array);t.setIndex(new BufferAttribute(s,1))}var n=e.data.attributes;for(var a in n){var o=n[a],s=new i[o.type](o.array);t.addAttribute(a,new BufferAttribute(s,o.itemSize,o.normalized))}var c=e.data.groups||e.data.drawcalls||e.data.offsets;if(void 0!==c)for(var l=0,h=c.length;l!==h;++l){var u=c[l];t.addGroup(u.start,u.count,u.materialIndex)}var d=e.data.boundingSphere;if(void 0!==d){var p=new Vector3;void 0!==d.center&&p.fromArray(d.center),t.boundingSphere=new Sphere(p,d.radius)}return t}}),Loader.prototype={constructor:Loader,crossOrigin:void 0,extractUrlBase:function(e){var t=e.split("/");return 1===t.length?"./":(t.pop(),t.join("/")+"/")},initMaterials:function(e,t,r){for(var i=[],n=0;n<e.length;++n)i[n]=this.createMaterial(e[n],t,r);return i},createMaterial:function(){var e,t,r;return function createMaterial(i,n,a){function loadTexture(e,r,i,s,c){var l,h=n+e,u=Loader.Handlers.get(h);null!==u?l=u.load(h):(t.setCrossOrigin(a),l=t.load(h)),void 0!==r&&(l.repeat.fromArray(r),1!==r[0]&&(l.wrapS=ue),1!==r[1]&&(l.wrapT=ue)),void 0!==i&&l.offset.fromArray(i),void 0!==s&&("repeat"===s[0]&&(l.wrapS=ue),"mirror"===s[0]&&(l.wrapS=pe),"repeat"===s[1]&&(l.wrapT=ue),"mirror"===s[1]&&(l.wrapT=pe)),void 0!==c&&(l.anisotropy=c);var d=ut.generateUUID();return o[d]=l,d}void 0===e&&(e=new Color),void 0===t&&(t=new TextureLoader),void 0===r&&(r=new MaterialLoader);var o={},s={uuid:ut.generateUUID(),type:"MeshLambertMaterial"};for(var c in i){var l=i[c];switch(c){case"DbgColor":case"DbgIndex":case"opticalDensity":case"illumination":break;case"DbgName":s.name=l;break;case"blending":s.blending=T[l];break;case"colorAmbient":case"mapAmbient":console.warn("THREE.Loader.createMaterial:",c,"is no longer supported.");break;case"colorDiffuse":s.color=e.fromArray(l).getHex();break;case"colorSpecular":s.specular=e.fromArray(l).getHex();break;case"colorEmissive":s.emissive=e.fromArray(l).getHex();break;case"specularCoef":s.shininess=l;break;case"shading":"basic"===l.toLowerCase()&&(s.type="MeshBasicMaterial"),"phong"===l.toLowerCase()&&(s.type="MeshPhongMaterial"),"standard"===l.toLowerCase()&&(s.type="MeshStandardMaterial");break;case"mapDiffuse":s.map=loadTexture(l,i.mapDiffuseRepeat,i.mapDiffuseOffset,i.mapDiffuseWrap,i.mapDiffuseAnisotropy);break;case"mapDiffuseRepeat":case"mapDiffuseOffset":case"mapDiffuseWrap":case"mapDiffuseAnisotropy":break;case"mapEmissive":s.emissiveMap=loadTexture(l,i.mapEmissiveRepeat,i.mapEmissiveOffset,i.mapEmissiveWrap,i.mapEmissiveAnisotropy);break;case"mapEmissiveRepeat":case"mapEmissiveOffset":case"mapEmissiveWrap":case"mapEmissiveAnisotropy":break;case"mapLight":s.lightMap=loadTexture(l,i.mapLightRepeat,i.mapLightOffset,i.mapLightWrap,i.mapLightAnisotropy);break;case"mapLightRepeat":case"mapLightOffset":case"mapLightWrap":case"mapLightAnisotropy":break;case"mapAO":s.aoMap=loadTexture(l,i.mapAORepeat,i.mapAOOffset,i.mapAOWrap,i.mapAOAnisotropy);break;case"mapAORepeat":case"mapAOOffset":case"mapAOWrap":case"mapAOAnisotropy":break;case"mapBump":s.bumpMap=loadTexture(l,i.mapBumpRepeat,i.mapBumpOffset,i.mapBumpWrap,i.mapBumpAnisotropy);break;case"mapBumpScale":s.bumpScale=l;break;case"mapBumpRepeat":case"mapBumpOffset":case"mapBumpWrap":case"mapBumpAnisotropy":break;case"mapNormal":s.normalMap=loadTexture(l,i.mapNormalRepeat,i.mapNormalOffset,i.mapNormalWrap,i.mapNormalAnisotropy);break;case"mapNormalFactor":s.normalScale=[l,l];break;case"mapNormalRepeat":case"mapNormalOffset":case"mapNormalWrap":case"mapNormalAnisotropy":break;case"mapSpecular":s.specularMap=loadTexture(l,i.mapSpecularRepeat,i.mapSpecularOffset,i.mapSpecularWrap,i.mapSpecularAnisotropy);break;case"mapSpecularRepeat":case"mapSpecularOffset":case"mapSpecularWrap":case"mapSpecularAnisotropy":break;case"mapMetalness":s.metalnessMap=loadTexture(l,i.mapMetalnessRepeat,i.mapMetalnessOffset,i.mapMetalnessWrap,i.mapMetalnessAnisotropy);break;case"mapMetalnessRepeat":case"mapMetalnessOffset":case"mapMetalnessWrap":case"mapMetalnessAnisotropy":break;case"mapRoughness":s.roughnessMap=loadTexture(l,i.mapRoughnessRepeat,i.mapRoughnessOffset,i.mapRoughnessWrap,i.mapRoughnessAnisotropy);break;case"mapRoughnessRepeat":case"mapRoughnessOffset":case"mapRoughnessWrap":case"mapRoughnessAnisotropy":break;case"mapAlpha":s.alphaMap=loadTexture(l,i.mapAlphaRepeat,i.mapAlphaOffset,i.mapAlphaWrap,i.mapAlphaAnisotropy);break;case"mapAlphaRepeat":case"mapAlphaOffset":case"mapAlphaWrap":case"mapAlphaAnisotropy":break;case"flipSided":s.side=h;break;case"doubleSided":s.side=u;break;case"transparency":console.warn("THREE.Loader.createMaterial: transparency has been renamed to opacity"),s.opacity=l;break;case"depthTest":case"depthWrite":case"colorWrite":case"opacity":case"reflectivity":case"transparent":case"visible":case"wireframe":s[c]=l;break;case"vertexColors":!0===l&&(s.vertexColors=g),"face"===l&&(s.vertexColors=m);break;default:console.error("THREE.Loader.createMaterial: Unsupported",c,l)}}return"MeshBasicMaterial"===s.type&&delete s.emissive,"MeshPhongMaterial"!==s.type&&delete s.specular,s.opacity<1&&(s.transparent=!0),r.setTextures(o),r.parse(s)}}()},Loader.Handlers={handlers:[],add:function(e,t){this.handlers.push(e,t)},get:function(e){for(var t=this.handlers,r=0,i=t.length;r<i;r+=2){var n=t[r],a=t[r+1];if(n.test(e))return a}return null}},Object.assign(JSONLoader.prototype,{load:function(e,t,r,i){var n=this,a=this.texturePath&&"string"==typeof this.texturePath?this.texturePath:Loader.prototype.extractUrlBase(e),o=new XHRLoader(this.manager);o.setWithCredentials(this.withCredentials),o.load(e,function(r){var i=JSON.parse(r),o=i.metadata;if(void 0!==o){var s=o.type;if(void 0!==s){if("object"===s.toLowerCase())return void console.error("THREE.JSONLoader: "+e+" should be loaded with THREE.ObjectLoader instead.");if("scene"===s.toLowerCase())return void console.error("THREE.JSONLoader: "+e+" should be loaded with THREE.SceneLoader instead.")}}var c=n.parse(i,a);t(c.geometry,c.materials)},r,i)},setTexturePath:function(e){this.texturePath=e},parse:function(e,t){var r=new Geometry,i=void 0!==e.scale?1/e.scale:1;if(function parseModel(t){function isBitSet(e,t){return e&1<<t}var i,n,a,o,s,c,l,h,u,d,p,f,m,g,v,y,x,b,_,M,w,T,S,E,A,L=e.faces,P=e.vertices,C=e.normals,R=e.colors,B=0;if(void 0!==e.uvs){for(i=0;i<e.uvs.length;i++)e.uvs[i].length&&B++;for(i=0;i<B;i++)r.faceVertexUvs[i]=[]}for(o=0,s=P.length;o<s;)(b=new Vector3).x=P[o++]*t,b.y=P[o++]*t,b.z=P[o++]*t,r.vertices.push(b);for(o=0,s=L.length;o<s;)if(d=L[o++],p=isBitSet(d,0),f=isBitSet(d,1),m=isBitSet(d,3),g=isBitSet(d,4),v=isBitSet(d,5),y=isBitSet(d,6),x=isBitSet(d,7),p){if(M=new Face3,M.a=L[o],M.b=L[o+1],M.c=L[o+3],w=new Face3,w.a=L[o+1],w.b=L[o+2],w.c=L[o+3],o+=4,f&&(u=L[o++],M.materialIndex=u,w.materialIndex=u),a=r.faces.length,m)for(i=0;i<B;i++)for(E=e.uvs[i],r.faceVertexUvs[i][a]=[],r.faceVertexUvs[i][a+1]=[],n=0;n<4;n++)A=new Vector2(E[2*(h=L[o++])],E[2*h+1]),2!==n&&r.faceVertexUvs[i][a].push(A),0!==n&&r.faceVertexUvs[i][a+1].push(A);if(g&&(l=3*L[o++],M.normal.set(C[l++],C[l++],C[l]),w.normal.copy(M.normal)),v)for(i=0;i<4;i++)l=3*L[o++],S=new Vector3(C[l++],C[l++],C[l]),2!==i&&M.vertexNormals.push(S),0!==i&&w.vertexNormals.push(S);if(y&&(T=R[c=L[o++]],M.color.setHex(T),w.color.setHex(T)),x)for(i=0;i<4;i++)T=R[c=L[o++]],2!==i&&M.vertexColors.push(new Color(T)),0!==i&&w.vertexColors.push(new Color(T));r.faces.push(M),r.faces.push(w)}else{if(_=new Face3,_.a=L[o++],_.b=L[o++],_.c=L[o++],f&&(u=L[o++],_.materialIndex=u),a=r.faces.length,m)for(i=0;i<B;i++)for(E=e.uvs[i],r.faceVertexUvs[i][a]=[],n=0;n<3;n++)A=new Vector2(E[2*(h=L[o++])],E[2*h+1]),r.faceVertexUvs[i][a].push(A);if(g&&(l=3*L[o++],_.normal.set(C[l++],C[l++],C[l])),v)for(i=0;i<3;i++)l=3*L[o++],S=new Vector3(C[l++],C[l++],C[l]),_.vertexNormals.push(S);if(y&&(c=L[o++],_.color.setHex(R[c])),x)for(i=0;i<3;i++)c=L[o++],_.vertexColors.push(new Color(R[c]));r.faces.push(_)}}(i),function parseSkin(){var t=void 0!==e.influencesPerVertex?e.influencesPerVertex:2;if(e.skinWeights)for(var i=0,n=e.skinWeights.length;i<n;i+=t){var a=e.skinWeights[i],o=t>1?e.skinWeights[i+1]:0,s=t>2?e.skinWeights[i+2]:0,c=t>3?e.skinWeights[i+3]:0;r.skinWeights.push(new Vector4(a,o,s,c))}if(e.skinIndices)for(var i=0,n=e.skinIndices.length;i<n;i+=t){var l=e.skinIndices[i],h=t>1?e.skinIndices[i+1]:0,u=t>2?e.skinIndices[i+2]:0,d=t>3?e.skinIndices[i+3]:0;r.skinIndices.push(new Vector4(l,h,u,d))}r.bones=e.bones,r.bones&&r.bones.length>0&&(r.skinWeights.length!==r.skinIndices.length||r.skinIndices.length!==r.vertices.length)&&console.warn("When skinning, number of vertices ("+r.vertices.length+"), skinIndices ("+r.skinIndices.length+"), and skinWeights ("+r.skinWeights.length+") should match.")}(),function parseMorphing(t){if(void 0!==e.morphTargets)for(var i=0,n=e.morphTargets.length;i<n;i++){r.morphTargets[i]={},r.morphTargets[i].name=e.morphTargets[i].name,r.morphTargets[i].vertices=[];for(var a=r.morphTargets[i].vertices,o=e.morphTargets[i].vertices,s=0,c=o.length;s<c;s+=3){var l=new Vector3;l.x=o[s]*t,l.y=o[s+1]*t,l.z=o[s+2]*t,a.push(l)}}if(void 0!==e.morphColors&&e.morphColors.length>0){console.warn('THREE.JSONLoader: "morphColors" no longer supported. Using them as face colors.');for(var h=r.faces,u=e.morphColors[0].colors,i=0,n=h.length;i<n;i++)h[i].color.fromArray(u,3*i)}}(i),function parseAnimations(){var t=[],i=[];void 0!==e.animation&&i.push(e.animation),void 0!==e.animations&&(e.animations.length?i=i.concat(e.animations):i.push(e.animations));for(var n=0;n<i.length;n++){var a=AnimationClip.parseAnimation(i[n],r.bones);a&&t.push(a)}if(r.morphTargets){var o=AnimationClip.CreateClipsFromMorphTargetSequences(r.morphTargets,10);t=t.concat(o)}t.length>0&&(r.animations=t)}(),r.computeFaceNormals(),r.computeBoundingSphere(),void 0===e.materials||0===e.materials.length)return{geometry:r};var n=Loader.prototype.initMaterials(e.materials,t,this.crossOrigin);return{geometry:r,materials:n}}}),Object.assign(ObjectLoader.prototype,{load:function(e,t,r,i){""===this.texturePath&&(this.texturePath=e.substring(0,e.lastIndexOf("/")+1));var n=this;new XHRLoader(n.manager).load(e,function(e){n.parse(JSON.parse(e),t)},r,i)},setTexturePath:function(e){this.texturePath=e},setCrossOrigin:function(e){this.crossOrigin=e},parse:function(e,t){var r=this.parseGeometries(e.geometries),i=this.parseImages(e.images,function(){void 0!==t&&t(o)}),n=this.parseTextures(e.textures,i),a=this.parseMaterials(e.materials,n),o=this.parseObject(e.object,r,a);return e.animations&&(o.animations=this.parseAnimations(e.animations)),void 0!==e.images&&0!==e.images.length||void 0!==t&&t(o),o},parseGeometries:function(e){var t={};if(void 0!==e)for(var r=new JSONLoader,i=new BufferGeometryLoader,n=0,a=e.length;n<a;n++){var o,s=e[n];switch(s.type){case"PlaneGeometry":case"PlaneBufferGeometry":o=new Lt[s.type](s.width,s.height,s.widthSegments,s.heightSegments);break;case"BoxGeometry":case"BoxBufferGeometry":case"CubeGeometry":o=new Lt[s.type](s.width,s.height,s.depth,s.widthSegments,s.heightSegments,s.depthSegments);break;case"CircleGeometry":case"CircleBufferGeometry":o=new Lt[s.type](s.radius,s.segments,s.thetaStart,s.thetaLength);break;case"CylinderGeometry":case"CylinderBufferGeometry":o=new Lt[s.type](s.radiusTop,s.radiusBottom,s.height,s.radialSegments,s.heightSegments,s.openEnded,s.thetaStart,s.thetaLength);break;case"ConeGeometry":case"ConeBufferGeometry":o=new Lt[s.type](s.radius,s.height,s.radialSegments,s.heightSegments,s.openEnded,s.thetaStart,s.thetaLength);break;case"SphereGeometry":case"SphereBufferGeometry":o=new Lt[s.type](s.radius,s.widthSegments,s.heightSegments,s.phiStart,s.phiLength,s.thetaStart,s.thetaLength);break;case"DodecahedronGeometry":case"IcosahedronGeometry":case"OctahedronGeometry":case"TetrahedronGeometry":o=new Lt[s.type](s.radius,s.detail);break;case"RingGeometry":case"RingBufferGeometry":o=new Lt[s.type](s.innerRadius,s.outerRadius,s.thetaSegments,s.phiSegments,s.thetaStart,s.thetaLength);break;case"TorusGeometry":case"TorusBufferGeometry":o=new Lt[s.type](s.radius,s.tube,s.radialSegments,s.tubularSegments,s.arc);break;case"TorusKnotGeometry":case"TorusKnotBufferGeometry":o=new Lt[s.type](s.radius,s.tube,s.tubularSegments,s.radialSegments,s.p,s.q);break;case"LatheGeometry":case"LatheBufferGeometry":o=new Lt[s.type](s.points,s.segments,s.phiStart,s.phiLength);break;case"BufferGeometry":o=i.parse(s);break;case"Geometry":o=r.parse(s.data,this.texturePath).geometry;break;default:console.warn('THREE.ObjectLoader: Unsupported geometry type "'+s.type+'"');continue}o.uuid=s.uuid,void 0!==s.name&&(o.name=s.name),t[s.uuid]=o}return t},parseMaterials:function(e,t){var r={};if(void 0!==e){var i=new MaterialLoader;i.setTextures(t);for(var n=0,a=e.length;n<a;n++){var o=i.parse(e[n]);r[o.uuid]=o}}return r},parseAnimations:function(e){for(var t=[],r=0;r<e.length;r++){var i=AnimationClip.parse(e[r]);t.push(i)}return t},parseImages:function(e,t){var r=this,i={};if(void 0!==e&&e.length>0){var n=new ImageLoader(new LoadingManager(t));n.setCrossOrigin(this.crossOrigin);for(var a=0,o=e.length;a<o;a++){var s=e[a],c=/^(\/\/)|([a-z]+:(\/\/)?)/i.test(s.url)?s.url:r.texturePath+s.url;i[s.uuid]=function loadImage(e){return r.manager.itemStart(e),n.load(e,function(){r.manager.itemEnd(e)},void 0,function(){r.manager.itemError(e)})}(c)}}return i},parseTextures:function(e,t){function parseConstant(e,t){return"number"==typeof e?e:(console.warn("THREE.ObjectLoader.parseTexture: Constant should be in numeric form.",e),t[e])}var r={};if(void 0!==e)for(var i=0,n=e.length;i<n;i++){var a=e[i];void 0===a.image&&console.warn('THREE.ObjectLoader: No "image" specified for',a.uuid),void 0===t[a.image]&&console.warn("THREE.ObjectLoader: Undefined image",a.image);var o=new Texture(t[a.image]);o.needsUpdate=!0,o.uuid=a.uuid,void 0!==a.name&&(o.name=a.name),void 0!==a.mapping&&(o.mapping=parseConstant(a.mapping,he)),void 0!==a.offset&&o.offset.fromArray(a.offset),void 0!==a.repeat&&o.repeat.fromArray(a.repeat),void 0!==a.wrap&&(o.wrapS=parseConstant(a.wrap[0],fe),o.wrapT=parseConstant(a.wrap[1],fe)),void 0!==a.minFilter&&(o.minFilter=parseConstant(a.minFilter,_e)),void 0!==a.magFilter&&(o.magFilter=parseConstant(a.magFilter,_e)),void 0!==a.anisotropy&&(o.anisotropy=a.anisotropy),void 0!==a.flipY&&(o.flipY=a.flipY),r[a.uuid]=o}return r},parseObject:function(){var e=new Matrix4;return function parseObject(t,r,i){function getGeometry(e){return void 0===r[e]&&console.warn("THREE.ObjectLoader: Undefined geometry",e),r[e]}function getMaterial(e){if(void 0!==e)return void 0===i[e]&&console.warn("THREE.ObjectLoader: Undefined material",e),i[e]}var n;switch(t.type){case"Scene":n=new Scene,void 0!==t.background&&Number.isInteger(t.background)&&(n.background=new Color(t.background)),void 0!==t.fog&&("Fog"===t.fog.type?n.fog=new Fog(t.fog.color,t.fog.near,t.fog.far):"FogExp2"===t.fog.type&&(n.fog=new FogExp2(t.fog.color,t.fog.density)));break;case"PerspectiveCamera":n=new PerspectiveCamera(t.fov,t.aspect,t.near,t.far),void 0!==t.focus&&(n.focus=t.focus),void 0!==t.zoom&&(n.zoom=t.zoom),void 0!==t.filmGauge&&(n.filmGauge=t.filmGauge),void 0!==t.filmOffset&&(n.filmOffset=t.filmOffset),void 0!==t.view&&(n.view=Object.assign({},t.view));break;case"OrthographicCamera":n=new OrthographicCamera(t.left,t.right,t.top,t.bottom,t.near,t.far);break;case"AmbientLight":n=new AmbientLight(t.color,t.intensity);break;case"DirectionalLight":n=new DirectionalLight(t.color,t.intensity);break;case"PointLight":n=new PointLight(t.color,t.intensity,t.distance,t.decay);break;case"SpotLight":n=new SpotLight(t.color,t.intensity,t.distance,t.angle,t.penumbra,t.decay);break;case"HemisphereLight":n=new HemisphereLight(t.color,t.groundColor,t.intensity);break;case"Mesh":var a=getGeometry(t.geometry),o=getMaterial(t.material);n=a.bones&&a.bones.length>0?new SkinnedMesh(a,o):new Mesh(a,o);break;case"LOD":n=new LOD;break;case"Line":n=new Line(getGeometry(t.geometry),getMaterial(t.material),t.mode);break;case"LineSegments":n=new LineSegments(getGeometry(t.geometry),getMaterial(t.material));break;case"PointCloud":case"Points":n=new Points(getGeometry(t.geometry),getMaterial(t.material));break;case"Sprite":n=new Sprite(getMaterial(t.material));break;case"Group":n=new Group;break;default:n=new Object3D}if(n.uuid=t.uuid,void 0!==t.name&&(n.name=t.name),void 0!==t.matrix?(e.fromArray(t.matrix),e.decompose(n.position,n.quaternion,n.scale)):(void 0!==t.position&&n.position.fromArray(t.position),void 0!==t.rotation&&n.rotation.fromArray(t.rotation),void 0!==t.quaternion&&n.quaternion.fromArray(t.quaternion),void 0!==t.scale&&n.scale.fromArray(t.scale)),void 0!==t.castShadow&&(n.castShadow=t.castShadow),void 0!==t.receiveShadow&&(n.receiveShadow=t.receiveShadow),t.shadow&&(void 0!==t.shadow.bias&&(n.shadow.bias=t.shadow.bias),void 0!==t.shadow.radius&&(n.shadow.radius=t.shadow.radius),void 0!==t.shadow.mapSize&&n.shadow.mapSize.fromArray(t.shadow.mapSize),void 0!==t.shadow.camera&&(n.shadow.camera=this.parseObject(t.shadow.camera))),void 0!==t.visible&&(n.visible=t.visible),void 0!==t.userData&&(n.userData=t.userData),void 0!==t.children)for(var s in t.children)n.add(this.parseObject(t.children[s],r,i));if("LOD"===t.type)for(var c=t.levels,l=0;l<c.length;l++){var h=c[l];void 0!==(s=n.getObjectByProperty("uuid",h.object))&&n.addLevel(s,h.distance)}return n}}()}),Curve.prototype={constructor:Curve,getPoint:function(e){return console.warn("THREE.Curve: Warning, getPoint() not implemented!"),null},getPointAt:function(e){var t=this.getUtoTmapping(e);return this.getPoint(t)},getPoints:function(e){e||(e=5);for(var t=[],r=0;r<=e;r++)t.push(this.getPoint(r/e));return t},getSpacedPoints:function(e){e||(e=5);for(var t=[],r=0;r<=e;r++)t.push(this.getPointAt(r/e));return t},getLength:function(){var e=this.getLengths();return e[e.length-1]},getLengths:function(e){if(e||(e=this.__arcLengthDivisions?this.__arcLengthDivisions:200),this.cacheArcLengths&&this.cacheArcLengths.length===e+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;var t,r,i=[],n=this.getPoint(0),a=0;for(i.push(0),r=1;r<=e;r++)a+=(t=this.getPoint(r/e)).distanceTo(n),i.push(a),n=t;return this.cacheArcLengths=i,i},updateArcLengths:function(){this.needsUpdate=!0,this.getLengths()},getUtoTmapping:function(e,t){var r,i=this.getLengths(),n=0,a=i.length;r=t||e*i[a-1];for(var o,s=0,c=a-1;s<=c;)if(n=Math.floor(s+(c-s)/2),(o=i[n]-r)<0)s=n+1;else{if(!(o>0)){c=n;break}c=n-1}if(n=c,i[n]===r)return h=n/(a-1);var l=i[n],h=(n+(r-l)/(i[n+1]-l))/(a-1);return h},getTangent:function(e){var t=e-1e-4,r=e+1e-4;t<0&&(t=0),r>1&&(r=1);var i=this.getPoint(t);return this.getPoint(r).clone().sub(i).normalize()},getTangentAt:function(e){var t=this.getUtoTmapping(e);return this.getTangent(t)},computeFrenetFrames:function(e,t){var r,i,n,a=new Vector3,o=[],s=[],c=[],l=new Vector3,h=new Matrix4;for(r=0;r<=e;r++)i=r/e,o[r]=this.getTangentAt(i),o[r].normalize();s[0]=new Vector3,c[0]=new Vector3;var u=Number.MAX_VALUE,d=Math.abs(o[0].x),p=Math.abs(o[0].y),f=Math.abs(o[0].z);for(d<=u&&(u=d,a.set(1,0,0)),p<=u&&(u=p,a.set(0,1,0)),f<=u&&a.set(0,0,1),l.crossVectors(o[0],a).normalize(),s[0].crossVectors(o[0],l),c[0].crossVectors(o[0],s[0]),r=1;r<=e;r++)s[r]=s[r-1].clone(),c[r]=c[r-1].clone(),l.crossVectors(o[r-1],o[r]),l.length()>Number.EPSILON&&(l.normalize(),n=Math.acos(ut.clamp(o[r-1].dot(o[r]),-1,1)),s[r].applyMatrix4(h.makeRotationAxis(l,n))),c[r].crossVectors(o[r],s[r]);if(!0===t)for(n=Math.acos(ut.clamp(s[0].dot(s[e]),-1,1)),n/=e,o[0].dot(l.crossVectors(s[0],s[e]))>0&&(n=-n),r=1;r<=e;r++)s[r].applyMatrix4(h.makeRotationAxis(o[r],n*r)),c[r].crossVectors(o[r],s[r]);return{tangents:o,normals:s,binormals:c}}},Curve.create=function(e,t){return e.prototype=Object.create(Curve.prototype),e.prototype.constructor=e,e.prototype.getPoint=t,e},(LineCurve.prototype=Object.create(Curve.prototype)).constructor=LineCurve,LineCurve.prototype.isLineCurve=!0,LineCurve.prototype.getPoint=function(e){if(1===e)return this.v2.clone();var t=this.v2.clone().sub(this.v1);return t.multiplyScalar(e).add(this.v1),t},LineCurve.prototype.getPointAt=function(e){return this.getPoint(e)},LineCurve.prototype.getTangent=function(e){return this.v2.clone().sub(this.v1).normalize()},CurvePath.prototype=Object.assign(Object.create(Curve.prototype),{constructor:CurvePath,add:function(e){this.curves.push(e)},closePath:function(){var e=this.curves[0].getPoint(0),t=this.curves[this.curves.length-1].getPoint(1);e.equals(t)||this.curves.push(new LineCurve(t,e))},getPoint:function(e){for(var t=e*this.getLength(),r=this.getCurveLengths(),i=0;i<r.length;){if(r[i]>=t){var n=r[i]-t,a=this.curves[i],o=a.getLength(),s=0===o?0:1-n/o;return a.getPointAt(s)}i++}return null},getLength:function(){var e=this.getCurveLengths();return e[e.length-1]},updateArcLengths:function(){this.needsUpdate=!0,this.cacheLengths=null,this.getLengths()},getCurveLengths:function(){if(this.cacheLengths&&this.cacheLengths.length===this.curves.length)return this.cacheLengths;for(var e=[],t=0,r=0,i=this.curves.length;r<i;r++)t+=this.curves[r].getLength(),e.push(t);return this.cacheLengths=e,e},getSpacedPoints:function(e){e||(e=40);for(var t=[],r=0;r<=e;r++)t.push(this.getPoint(r/e));return this.autoClose&&t.push(t[0]),t},getPoints:function(e){e=e||12;for(var t,r=[],i=0,n=this.curves;i<n.length;i++)for(var a=n[i],o=a&&a.isEllipseCurve?2*e:a&&a.isLineCurve?1:a&&a.isSplineCurve?e*a.points.length:e,s=a.getPoints(o),c=0;c<s.length;c++){var l=s[c];t&&t.equals(l)||(r.push(l),t=l)}return this.autoClose&&r.length>1&&!r[r.length-1].equals(r[0])&&r.push(r[0]),r},createPointsGeometry:function(e){var t=this.getPoints(e);return this.createGeometry(t)},createSpacedPointsGeometry:function(e){var t=this.getSpacedPoints(e);return this.createGeometry(t)},createGeometry:function(e){for(var t=new Geometry,r=0,i=e.length;r<i;r++){var n=e[r];t.vertices.push(new Vector3(n.x,n.y,n.z||0))}return t}}),EllipseCurve.prototype=Object.create(Curve.prototype),EllipseCurve.prototype.constructor=EllipseCurve,EllipseCurve.prototype.isEllipseCurve=!0,EllipseCurve.prototype.getPoint=function(e){for(var t=2*Math.PI,r=this.aEndAngle-this.aStartAngle,i=Math.abs(r)<Number.EPSILON;r<0;)r+=t;for(;r>t;)r-=t;r<Number.EPSILON&&(r=i?0:t),!0!==this.aClockwise||i||(r===t?r=-t:r-=t);var n=this.aStartAngle+e*r,a=this.aX+this.xRadius*Math.cos(n),o=this.aY+this.yRadius*Math.sin(n);if(0!==this.aRotation){var s=Math.cos(this.aRotation),c=Math.sin(this.aRotation),l=a-this.aX,h=o-this.aY;a=l*s-h*c+this.aX,o=l*c+h*s+this.aY}return new Vector2(a,o)};var Dt={tangentQuadraticBezier:function(e,t,r,i){return 2*(1-e)*(r-t)+2*e*(i-r)},tangentCubicBezier:function(e,t,r,i,n){return-3*t*(1-e)*(1-e)+3*r*(1-e)*(1-e)-6*e*r*(1-e)+6*e*i*(1-e)-3*e*e*i+3*e*e*n},tangentSpline:function(e,t,r,i,n){return 6*e*e-6*e+(3*e*e-4*e+1)+(-6*e*e+6*e)+(3*e*e-2*e)},interpolate:function(e,t,r,i,n){var a=.5*(r-e),o=.5*(i-t),s=n*n;return(2*t-2*r+a+o)*(n*s)+(-3*t+3*r-2*a-o)*s+a*n+t}};(SplineCurve.prototype=Object.create(Curve.prototype)).constructor=SplineCurve,SplineCurve.prototype.isSplineCurve=!0,SplineCurve.prototype.getPoint=function(e){var t=this.points,r=(t.length-1)*e,i=Math.floor(r),n=r-i,a=t[0===i?i:i-1],o=t[i],s=t[i>t.length-2?t.length-1:i+1],c=t[i>t.length-3?t.length-1:i+2],l=Dt.interpolate;return new Vector2(l(a.x,o.x,s.x,c.x,n),l(a.y,o.y,s.y,c.y,n))},(CubicBezierCurve.prototype=Object.create(Curve.prototype)).constructor=CubicBezierCurve,CubicBezierCurve.prototype.getPoint=function(e){var t=At.b3;return new Vector2(t(e,this.v0.x,this.v1.x,this.v2.x,this.v3.x),t(e,this.v0.y,this.v1.y,this.v2.y,this.v3.y))},CubicBezierCurve.prototype.getTangent=function(e){var t=Dt.tangentCubicBezier;return new Vector2(t(e,this.v0.x,this.v1.x,this.v2.x,this.v3.x),t(e,this.v0.y,this.v1.y,this.v2.y,this.v3.y)).normalize()},(QuadraticBezierCurve.prototype=Object.create(Curve.prototype)).constructor=QuadraticBezierCurve,QuadraticBezierCurve.prototype.getPoint=function(e){var t=At.b2;return new Vector2(t(e,this.v0.x,this.v1.x,this.v2.x),t(e,this.v0.y,this.v1.y,this.v2.y))},QuadraticBezierCurve.prototype.getTangent=function(e){var t=Dt.tangentQuadraticBezier;return new Vector2(t(e,this.v0.x,this.v1.x,this.v2.x),t(e,this.v0.y,this.v1.y,this.v2.y)).normalize()};var Ut=Object.assign(Object.create(CurvePath.prototype),{fromPoints:function(e){this.moveTo(e[0].x,e[0].y);for(var t=1,r=e.length;t<r;t++)this.lineTo(e[t].x,e[t].y)},moveTo:function(e,t){this.currentPoint.set(e,t)},lineTo:function(e,t){var r=new LineCurve(this.currentPoint.clone(),new Vector2(e,t));this.curves.push(r),this.currentPoint.set(e,t)},quadraticCurveTo:function(e,t,r,i){var n=new QuadraticBezierCurve(this.currentPoint.clone(),new Vector2(e,t),new Vector2(r,i));this.curves.push(n),this.currentPoint.set(r,i)},bezierCurveTo:function(e,t,r,i,n,a){var o=new CubicBezierCurve(this.currentPoint.clone(),new Vector2(e,t),new Vector2(r,i),new Vector2(n,a));this.curves.push(o),this.currentPoint.set(n,a)},splineThru:function(e){var t=new SplineCurve([this.currentPoint.clone()].concat(e));this.curves.push(t),this.currentPoint.copy(e[e.length-1])},arc:function(e,t,r,i,n,a){var o=this.currentPoint.x,s=this.currentPoint.y;this.absarc(e+o,t+s,r,i,n,a)},absarc:function(e,t,r,i,n,a){this.absellipse(e,t,r,r,i,n,a)},ellipse:function(e,t,r,i,n,a,o,s){var c=this.currentPoint.x,l=this.currentPoint.y;this.absellipse(e+c,t+l,r,i,n,a,o,s)},absellipse:function(e,t,r,i,n,a,o,s){var c=new EllipseCurve(e,t,r,i,n,a,o,s);if(this.curves.length>0){var l=c.getPoint(0);l.equals(this.currentPoint)||this.lineTo(l.x,l.y)}this.curves.push(c);var h=c.getPoint(1);this.currentPoint.copy(h)}});Shape.prototype=Object.assign(Object.create(Ut),{constructor:Shape,getPointsHoles:function(e){for(var t=[],r=0,i=this.holes.length;r<i;r++)t[r]=this.holes[r].getPoints(e);return t},extractAllPoints:function(e){return{shape:this.getPoints(e),holes:this.getPointsHoles(e)}},extractPoints:function(e){return this.extractAllPoints(e)}}),Path.prototype=Ut,Ut.constructor=Path,ShapePath.prototype={moveTo:function(e,t){this.currentPath=new Path,this.subPaths.push(this.currentPath),this.currentPath.moveTo(e,t)},lineTo:function(e,t){this.currentPath.lineTo(e,t)},quadraticCurveTo:function(e,t,r,i){this.currentPath.quadraticCurveTo(e,t,r,i)},bezierCurveTo:function(e,t,r,i,n,a){this.currentPath.bezierCurveTo(e,t,r,i,n,a)},splineThru:function(e){this.currentPath.splineThru(e)},toShapes:function(e,t){function toShapesNoHoles(e){for(var t=[],r=0,i=e.length;r<i;r++){var n=e[r],a=new Shape;a.curves=n.curves,t.push(a)}return t}var r=At.isClockWise,i=this.subPaths;if(0===i.length)return[];if(!0===t)return toShapesNoHoles(i);var n,a,o,s=[];if(1===i.length)return a=i[0],o=new Shape,o.curves=a.curves,s.push(o),s;var c=!r(i[0].getPoints());c=e?!c:c;var l,h=[],u=[],d=[],p=0;u[p]=void 0,d[p]=[];for(var f=0,m=i.length;f<m;f++)n=r(l=(a=i[f]).getPoints()),(n=e?!n:n)?(!c&&u[p]&&p++,u[p]={s:new Shape,p:l},u[p].s.curves=a.curves,c&&p++,d[p]=[]):d[p].push({h:a,p:l[0]});if(!u[0])return toShapesNoHoles(i);if(u.length>1){for(var g=!1,v=[],y=0,x=u.length;y<x;y++)h[y]=[];for(var y=0,x=u.length;y<x;y++)for(var b=d[y],_=0;_<b.length;_++){for(var M=b[_],w=!0,T=0;T<u.length;T++)(function isPointInsidePolygon(e,t){for(var r=t.length,i=!1,n=r-1,a=0;a<r;n=a++){var o=t[n],s=t[a],c=s.x-o.x,l=s.y-o.y;if(Math.abs(l)>Number.EPSILON){if(l<0&&(o=t[a],c=-c,s=t[n],l=-l),e.y<o.y||e.y>s.y)continue;if(e.y===o.y){if(e.x===o.x)return!0}else{var h=l*(e.x-o.x)-c*(e.y-o.y);if(0===h)return!0;if(h<0)continue;i=!i}}else{if(e.y!==o.y)continue;if(s.x<=e.x&&e.x<=o.x||o.x<=e.x&&e.x<=s.x)return!0}}return i})(M.p,u[T].p)&&(y!==T&&v.push({froms:y,tos:T,hole:_}),w?(w=!1,h[T].push(M)):g=!0);w&&h[y].push(M)}v.length>0&&(g||(d=h))}for(var S,f=0,E=u.length;f<E;f++){o=u[f].s,s.push(o);for(var A=0,L=(S=d[f]).length;A<L;A++)o.holes.push(S[A].h)}return s}},Object.assign(Font.prototype,{isFont:!0,generateShapes:function(e,t,r){function createPath(e,t,n){var a=i.glyphs[e]||i.glyphs["?"];if(a){var o,s,c,l,h,u,d,p,f,m,g,v=new ShapePath,y=[],x=At.b2,b=At.b3;if(a.o)for(var _=a._cachedOutline||(a._cachedOutline=a.o.split(" ")),M=0,w=_.length;M<w;)switch(_[M++]){case"m":o=_[M++]*t+n,s=_[M++]*t,v.moveTo(o,s);break;case"l":o=_[M++]*t+n,s=_[M++]*t,v.lineTo(o,s);break;case"q":if(c=_[M++]*t+n,l=_[M++]*t,d=_[M++]*t+n,p=_[M++]*t,v.quadraticCurveTo(d,p,c,l),g=y[y.length-1]){h=g.x,u=g.y;for(T=1;T<=r;T++)x(S=T/r,h,d,c),x(S,u,p,l)}break;case"b":if(c=_[M++]*t+n,l=_[M++]*t,d=_[M++]*t+n,p=_[M++]*t,f=_[M++]*t+n,m=_[M++]*t,v.bezierCurveTo(d,p,f,m,c,l),g=y[y.length-1]){h=g.x,u=g.y;for(var T=1;T<=r;T++){var S=T/r;b(S,h,d,f,c),b(S,u,p,m,l)}}}return{offset:a.ha*t,path:v}}}void 0===t&&(t=100),void 0===r&&(r=4);for(var i=this.data,n=function createPaths(e){for(var r=String(e).split(""),n=t/i.resolution,a=0,o=[],s=0;s<r.length;s++){var c=createPath(r[s],n,a);a+=c.offset,o.push(c.path)}return o}(e),a=[],o=0,s=n.length;o<s;o++)Array.prototype.push.apply(a,n[o].toShapes());return a}}),Object.assign(FontLoader.prototype,{load:function(e,t,r,i){var n=this;new XHRLoader(this.manager).load(e,function(e){var r;try{r=JSON.parse(e)}catch(t){console.warn("THREE.FontLoader: typeface.js support is being deprecated. Use typeface.json instead."),r=JSON.parse(e.substring(65,e.length-2))}var i=n.parse(r);t&&t(i)},r,i)},parse:function(e){return new Font(e)}});var Ot;Object.assign(AudioLoader.prototype,{load:function(e,t,r,i){var n=new XHRLoader(this.manager);n.setResponseType("arraybuffer"),n.load(e,function(e){getAudioContext().decodeAudioData(e,function(e){t(e)})},r,i)}}),Object.assign(StereoCamera.prototype,{update:function(){var e,t,r,i,n,a,o,s=new Matrix4,c=new Matrix4;return function update(l){if(e!==this||t!==l.focus||r!==l.fov||i!==l.aspect*this.aspect||n!==l.near||a!==l.far||o!==l.zoom){e=this,t=l.focus,r=l.fov,i=l.aspect*this.aspect,n=l.near,a=l.far,o=l.zoom;var h,u,d=l.projectionMatrix.clone(),p=this.eyeSep/2,f=p*n/t,m=n*Math.tan(ut.DEG2RAD*r*.5)/o;c.elements[12]=-p,s.elements[12]=p,h=-m*i+f,u=m*i+f,d.elements[0]=2*n/(u-h),d.elements[8]=(u+h)/(u-h),this.cameraL.projectionMatrix.copy(d),h=-m*i-f,u=m*i-f,d.elements[0]=2*n/(u-h),d.elements[8]=(u+h)/(u-h),this.cameraR.projectionMatrix.copy(d)}this.cameraL.matrixWorld.copy(l.matrixWorld).multiply(c),this.cameraR.matrixWorld.copy(l.matrixWorld).multiply(s)}}()}),(CubeCamera.prototype=Object.create(Object3D.prototype)).constructor=CubeCamera,AudioListener.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:AudioListener,getInput:function(){return this.gain},removeFilter:function(){null!==this.filter&&(this.gain.disconnect(this.filter),this.filter.disconnect(this.context.destination),this.gain.connect(this.context.destination),this.filter=null)},getFilter:function(){return this.filter},setFilter:function(e){null!==this.filter?(this.gain.disconnect(this.filter),this.filter.disconnect(this.context.destination)):this.gain.disconnect(this.context.destination),this.filter=e,this.gain.connect(this.filter),this.filter.connect(this.context.destination)},getMasterVolume:function(){return this.gain.gain.value},setMasterVolume:function(e){this.gain.gain.value=e},updateMatrixWorld:function(){var e=new Vector3,t=new Quaternion,r=new Vector3,i=new Vector3;return function updateMatrixWorld(n){Object3D.prototype.updateMatrixWorld.call(this,n);var a=this.context.listener,o=this.up;this.matrixWorld.decompose(e,t,r),i.set(0,0,-1).applyQuaternion(t),a.setPosition(e.x,e.y,e.z),a.setOrientation(i.x,i.y,i.z,o.x,o.y,o.z)}}()}),Audio.prototype=Object.assign(Object.create(Object3D.prototype),{constructor:Audio,getOutput:function(){return this.gain},setNodeSource:function(e){return this.hasPlaybackControl=!1,this.sourceType="audioNode",this.source=e,this.connect(),this},setBuffer:function(e){return this.source.buffer=e,this.sourceType="buffer",this.autoplay&&this.play(),this},play:function(){if(!0!==this.isPlaying){if(!1!==this.hasPlaybackControl){var e=this.context.createBufferSource();return e.buffer=this.source.buffer,e.loop=this.source.loop,e.onended=this.source.onended,e.start(0,this.startTime),e.playbackRate.value=this.playbackRate,this.isPlaying=!0,this.source=e,this.connect()}console.warn("THREE.Audio: this Audio has no playback control.")}else console.warn("THREE.Audio: Audio is already playing.")},pause:function(){if(!1!==this.hasPlaybackControl)return this.source.stop(),this.startTime=this.context.currentTime,this.isPlaying=!1,this;console.warn("THREE.Audio: this Audio has no playback control.")},stop:function(){if(!1!==this.hasPlaybackControl)return this.source.stop(),this.startTime=0,this.isPlaying=!1,this;console.warn("THREE.Audio: this Audio has no playback control.")},connect:function(){if(this.filters.length>0){this.source.connect(this.filters[0]);for(var e=1,t=this.filters.length;e<t;e++)this.filters[e-1].connect(this.filters[e]);this.filters[this.filters.length-1].connect(this.getOutput())}else this.source.connect(this.getOutput());return this},disconnect:function(){if(this.filters.length>0){this.source.disconnect(this.filters[0]);for(var e=1,t=this.filters.length;e<t;e++)this.filters[e-1].disconnect(this.filters[e]);this.filters[this.filters.length-1].disconnect(this.getOutput())}else this.source.disconnect(this.getOutput());return this},getFilters:function(){return this.filters},setFilters:function(e){return e||(e=[]),!0===this.isPlaying?(this.disconnect(),this.filters=e,this.connect()):this.filters=e,this},getFilter:function(){return this.getFilters()[0]},setFilter:function(e){return this.setFilters(e?[e]:[])},setPlaybackRate:function(e){if(!1!==this.hasPlaybackControl)return this.playbackRate=e,!0===this.isPlaying&&(this.source.playbackRate.value=this.playbackRate),this;console.warn("THREE.Audio: this Audio has no playback control.")},getPlaybackRate:function(){return this.playbackRate},onEnded:function(){this.isPlaying=!1},getLoop:function(){return!1===this.hasPlaybackControl?(console.warn("THREE.Audio: this Audio has no playback control."),!1):this.source.loop},setLoop:function(e){!1!==this.hasPlaybackControl?this.source.loop=e:console.warn("THREE.Audio: this Audio has no playback control.")},getVolume:function(){return this.gain.gain.value},setVolume:function(e){return this.gain.gain.value=e,this}}),PositionalAudio.prototype=Object.assign(Object.create(Audio.prototype),{constructor:PositionalAudio,getOutput:function(){return this.panner},getRefDistance:function(){return this.panner.refDistance},setRefDistance:function(e){this.panner.refDistance=e},getRolloffFactor:function(){return this.panner.rolloffFactor},setRolloffFactor:function(e){this.panner.rolloffFactor=e},getDistanceModel:function(){return this.panner.distanceModel},setDistanceModel:function(e){this.panner.distanceModel=e},getMaxDistance:function(){return this.panner.maxDistance},setMaxDistance:function(e){this.panner.maxDistance=e},updateMatrixWorld:function(){var e=new Vector3;return function updateMatrixWorld(t){Object3D.prototype.updateMatrixWorld.call(this,t),e.setFromMatrixPosition(this.matrixWorld),this.panner.setPosition(e.x,e.y,e.z)}}()}),Object.assign(AudioAnalyser.prototype,{getFrequencyData:function(){return this.analyser.getByteFrequencyData(this.data),this.data},getAverageFrequency:function(){for(var e=0,t=this.getFrequencyData(),r=0;r<t.length;r++)e+=t[r];return e/t.length}}),PropertyMixer.prototype={constructor:PropertyMixer,accumulate:function(e,t){var r=this.buffer,i=this.valueSize,n=e*i+i,a=this.cumulativeWeight;if(0===a){for(var o=0;o!==i;++o)r[n+o]=r[o];a=t}else{var s=t/(a+=t);this._mixBufferRegion(r,n,0,s,i)}this.cumulativeWeight=a},apply:function(e){var t=this.valueSize,r=this.buffer,i=e*t+t,n=this.cumulativeWeight,a=this.binding;if(this.cumulativeWeight=0,n<1){var o=3*t;this._mixBufferRegion(r,i,o,1-n,t)}for(var s=t,c=t+t;s!==c;++s)if(r[s]!==r[s+t]){a.setValue(r,i);break}},saveOriginalState:function(){var e=this.binding,t=this.buffer,r=this.valueSize,i=3*r;e.getValue(t,i);for(var n=r,a=i;n!==a;++n)t[n]=t[i+n%r];this.cumulativeWeight=0},restoreOriginalState:function(){var e=3*this.valueSize;this.binding.setValue(this.buffer,e)},_select:function(e,t,r,i,n){if(i>=.5)for(var a=0;a!==n;++a)e[t+a]=e[r+a]},_slerp:function(e,t,r,i,n){Quaternion.slerpFlat(e,t,e,t,e,r,i)},_lerp:function(e,t,r,i,n){for(var a=1-i,o=0;o!==n;++o){var s=t+o;e[s]=e[s]*a+e[r+o]*i}}},PropertyBinding.prototype={constructor:PropertyBinding,getValue:function getValue_unbound(e,t){this.bind(),this.getValue(e,t)},setValue:function getValue_unbound(e,t){this.bind(),this.setValue(e,t)},bind:function(){var e=this.node,t=this.parsedPath,r=t.objectName,i=t.propertyName,n=t.propertyIndex;if(e||(e=PropertyBinding.findNode(this.rootNode,t.nodeName)||this.rootNode,this.node=e),this.getValue=this._getValue_unavailable,this.setValue=this._setValue_unavailable,e){if(r){var a=t.objectIndex;switch(r){case"materials":if(!e.material)return void console.error("  can not bind to material as node does not have a material",this);if(!e.material.materials)return void console.error("  can not bind to material.materials as node.material does not have a materials array",this);e=e.material.materials;break;case"bones":if(!e.skeleton)return void console.error("  can not bind to bones as node does not have a skeleton",this);e=e.skeleton.bones;for(l=0;l<e.length;l++)if(e[l].name===a){a=l;break}break;default:if(void 0===e[r])return void console.error("  can not bind to objectName of node, undefined",this);e=e[r]}if(void 0!==a){if(void 0===e[a])return void console.error("  trying to bind to objectIndex of objectName, but is undefined:",this,e);e=e[a]}}var o=e[i];if(void 0!==o){var s=this.Versioning.None;void 0!==e.needsUpdate?(s=this.Versioning.NeedsUpdate,this.targetObject=e):void 0!==e.matrixWorldNeedsUpdate&&(s=this.Versioning.MatrixWorldNeedsUpdate,this.targetObject=e);var c=this.BindingType.Direct;if(void 0!==n){if("morphTargetInfluences"===i){if(!e.geometry)return void console.error("  can not bind to morphTargetInfluences becasuse node does not have a geometry",this);if(!e.geometry.morphTargets)return void console.error("  can not bind to morphTargetInfluences becasuse node does not have a geometry.morphTargets",this);for(var l=0;l<this.node.geometry.morphTargets.length;l++)if(e.geometry.morphTargets[l].name===n){n=l;break}}c=this.BindingType.ArrayElement,this.resolvedProperty=o,this.propertyIndex=n}else void 0!==o.fromArray&&void 0!==o.toArray?(c=this.BindingType.HasFromToArray,this.resolvedProperty=o):void 0!==o.length?(c=this.BindingType.EntireArray,this.resolvedProperty=o):this.propertyName=i;this.getValue=this.GetterByBindingType[c],this.setValue=this.SetterByBindingTypeAndVersioning[c][s]}else{var h=t.nodeName;console.error("  trying to update property for track: "+h+"."+i+" but it wasn't found.",e)}}else console.error("  trying to update node for track: "+this.path+" but it wasn't found.")},unbind:function(){this.node=null,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}},Object.assign(PropertyBinding.prototype,{_getValue_unavailable:function(){},_setValue_unavailable:function(){},_getValue_unbound:PropertyBinding.prototype.getValue,_setValue_unbound:PropertyBinding.prototype.setValue,BindingType:{Direct:0,EntireArray:1,ArrayElement:2,HasFromToArray:3},Versioning:{None:0,NeedsUpdate:1,MatrixWorldNeedsUpdate:2},GetterByBindingType:[function getValue_direct(e,t){e[t]=this.node[this.propertyName]},function getValue_array(e,t){for(var r=this.resolvedProperty,i=0,n=r.length;i!==n;++i)e[t++]=r[i]},function getValue_arrayElement(e,t){e[t]=this.resolvedProperty[this.propertyIndex]},function getValue_toArray(e,t){this.resolvedProperty.toArray(e,t)}],SetterByBindingTypeAndVersioning:[[function setValue_direct(e,t){this.node[this.propertyName]=e[t]},function setValue_direct_setNeedsUpdate(e,t){this.node[this.propertyName]=e[t],this.targetObject.needsUpdate=!0},function setValue_direct_setMatrixWorldNeedsUpdate(e,t){this.node[this.propertyName]=e[t],this.targetObject.matrixWorldNeedsUpdate=!0}],[function setValue_array(e,t){for(var r=this.resolvedProperty,i=0,n=r.length;i!==n;++i)r[i]=e[t++]},function setValue_array_setNeedsUpdate(e,t){for(var r=this.resolvedProperty,i=0,n=r.length;i!==n;++i)r[i]=e[t++];this.targetObject.needsUpdate=!0},function setValue_array_setMatrixWorldNeedsUpdate(e,t){for(var r=this.resolvedProperty,i=0,n=r.length;i!==n;++i)r[i]=e[t++];this.targetObject.matrixWorldNeedsUpdate=!0}],[function setValue_arrayElement(e,t){this.resolvedProperty[this.propertyIndex]=e[t]},function setValue_arrayElement_setNeedsUpdate(e,t){this.resolvedProperty[this.propertyIndex]=e[t],this.targetObject.needsUpdate=!0},function setValue_arrayElement_setMatrixWorldNeedsUpdate(e,t){this.resolvedProperty[this.propertyIndex]=e[t],this.targetObject.matrixWorldNeedsUpdate=!0}],[function setValue_fromArray(e,t){this.resolvedProperty.fromArray(e,t)},function setValue_fromArray_setNeedsUpdate(e,t){this.resolvedProperty.fromArray(e,t),this.targetObject.needsUpdate=!0},function setValue_fromArray_setMatrixWorldNeedsUpdate(e,t){this.resolvedProperty.fromArray(e,t),this.targetObject.matrixWorldNeedsUpdate=!0}]]}),PropertyBinding.Composite=function(e,t,r){var i=r||PropertyBinding.parseTrackName(t);this._targetGroup=e,this._bindings=e.subscribe_(t,i)},PropertyBinding.Composite.prototype={constructor:PropertyBinding.Composite,getValue:function(e,t){this.bind();var r=this._targetGroup.nCachedObjects_,i=this._bindings[r];void 0!==i&&i.getValue(e,t)},setValue:function(e,t){for(var r=this._bindings,i=this._targetGroup.nCachedObjects_,n=r.length;i!==n;++i)r[i].setValue(e,t)},bind:function(){for(var e=this._bindings,t=this._targetGroup.nCachedObjects_,r=e.length;t!==r;++t)e[t].bind()},unbind:function(){for(var e=this._bindings,t=this._targetGroup.nCachedObjects_,r=e.length;t!==r;++t)e[t].unbind()}},PropertyBinding.create=function(e,t,r){return e&&e.isAnimationObjectGroup?new PropertyBinding.Composite(e,t,r):new PropertyBinding(e,t,r)},PropertyBinding.parseTrackName=function(e){var t=/^((?:\w+[\/:])*)(\w+)?(?:\.(\w+)(?:\[(.+)\])?)?\.(\w+)(?:\[(.+)\])?$/.exec(e);if(!t)throw new Error("cannot parse trackName at all: "+e);var r={nodeName:t[2],objectName:t[3],objectIndex:t[4],propertyName:t[5],propertyIndex:t[6]};if(null===r.propertyName||0===r.propertyName.length)throw new Error("can not parse propertyName from trackName: "+e);return r},PropertyBinding.findNode=function(e,t){if(!t||""===t||"root"===t||"."===t||-1===t||t===e.name||t===e.uuid)return e;if(e.skeleton){var r=function(e){for(var r=0;r<e.bones.length;r++){var i=e.bones[r];if(i.name===t)return i}return null}(e.skeleton);if(r)return r}if(e.children){var i=function(e){for(var r=0;r<e.length;r++){var n=e[r];if(n.name===t||n.uuid===t)return n;var a=i(n.children);if(a)return a}return null},n=i(e.children);if(n)return n}return null},AnimationObjectGroup.prototype={constructor:AnimationObjectGroup,isAnimationObjectGroup:!0,add:function(e){for(var t=this._objects,r=t.length,i=this.nCachedObjects_,n=this._indicesByUUID,a=this._paths,o=this._parsedPaths,s=this._bindings,c=s.length,l=0,h=arguments.length;l!==h;++l){var u=arguments[l],d=u.uuid,p=n[d];if(void 0===p){p=r++,n[d]=p,t.push(u);for(var f=0,m=c;f!==m;++f)s[f].push(new PropertyBinding(u,a[f],o[f]))}else if(p<i){var g=t[p],v=--i,y=t[v];n[y.uuid]=p,t[p]=y,n[d]=v,t[v]=u;for(var f=0,m=c;f!==m;++f){var x=s[f],b=x[v],_=x[p];x[p]=b,void 0===_&&(_=new PropertyBinding(u,a[f],o[f])),x[v]=_}}else t[p]!==g&&console.error("Different objects with the same UUID detected. Clean the caches or recreate your infrastructure when reloading scenes...")}this.nCachedObjects_=i},remove:function(e){for(var t=this._objects,r=this.nCachedObjects_,i=this._indicesByUUID,n=this._bindings,a=n.length,o=0,s=arguments.length;o!==s;++o){var c=arguments[o],l=c.uuid,h=i[l];if(void 0!==h&&h>=r){var u=r++,d=t[u];i[d.uuid]=h,t[h]=d,i[l]=u,t[u]=c;for(var p=0,f=a;p!==f;++p){var m=n[p],g=m[u],v=m[h];m[h]=g,m[u]=v}}}this.nCachedObjects_=r},uncache:function(e){for(var t=this._objects,r=t.length,i=this.nCachedObjects_,n=this._indicesByUUID,a=this._bindings,o=a.length,s=0,c=arguments.length;s!==c;++s){var l=arguments[s].uuid,h=n[l];if(void 0!==h)if(delete n[l],h<i){var u=--i,d=t[u],p=t[y=--r];n[d.uuid]=h,t[h]=d,n[p.uuid]=u,t[u]=p,t.pop();for(var f=0,m=o;f!==m;++f){var g=(x=a[f])[u],v=x[y];x[h]=g,x[u]=v,x.pop()}}else{var y=--r;n[(p=t[y]).uuid]=h,t[h]=p,t.pop();for(var f=0,m=o;f!==m;++f){var x=a[f];x[h]=x[y],x.pop()}}}this.nCachedObjects_=i},subscribe_:function(e,t){var r=this._bindingsIndicesByPath,i=r[e],n=this._bindings;if(void 0!==i)return n[i];var a=this._paths,o=this._parsedPaths,s=this._objects,c=s.length,l=this.nCachedObjects_,h=new Array(c);i=n.length,r[e]=i,a.push(e),o.push(t),n.push(h);for(var u=l,d=s.length;u!==d;++u){var p=s[u];h[u]=new PropertyBinding(p,e,t)}return h},unsubscribe_:function(e){var t=this._bindingsIndicesByPath,r=t[e];if(void 0!==r){var i=this._paths,n=this._parsedPaths,a=this._bindings,o=a.length-1,s=a[o];t[e[o]]=r,a[r]=s,a.pop(),n[r]=n[o],n.pop(),i[r]=i[o],i.pop()}}},AnimationAction.prototype={constructor:AnimationAction,play:function(){return this._mixer._activateAction(this),this},stop:function(){return this._mixer._deactivateAction(this),this.reset()},reset:function(){return this.paused=!1,this.enabled=!0,this.time=0,this._loopCount=-1,this._startTime=null,this.stopFading().stopWarping()},isRunning:function(){return this.enabled&&!this.paused&&0!==this.timeScale&&null===this._startTime&&this._mixer._isActiveAction(this)},isScheduled:function(){return this._mixer._isActiveAction(this)},startAt:function(e){return this._startTime=e,this},setLoop:function(e,t){return this.loop=e,this.repetitions=t,this},setEffectiveWeight:function(e){return this.weight=e,this._effectiveWeight=this.enabled?e:0,this.stopFading()},getEffectiveWeight:function(){return this._effectiveWeight},fadeIn:function(e){return this._scheduleFading(e,0,1)},fadeOut:function(e){return this._scheduleFading(e,1,0)},crossFadeFrom:function(e,t,r){if(e.fadeOut(t),this.fadeIn(t),r){var i=this._clip.duration,n=e._clip.duration,a=n/i,o=i/n;e.warp(1,a,t),this.warp(o,1,t)}return this},crossFadeTo:function(e,t,r){return e.crossFadeFrom(this,t,r)},stopFading:function(){var e=this._weightInterpolant;return null!==e&&(this._weightInterpolant=null,this._mixer._takeBackControlInterpolant(e)),this},setEffectiveTimeScale:function(e){return this.timeScale=e,this._effectiveTimeScale=this.paused?0:e,this.stopWarping()},getEffectiveTimeScale:function(){return this._effectiveTimeScale},setDuration:function(e){return this.timeScale=this._clip.duration/e,this.stopWarping()},syncWith:function(e){return this.time=e.time,this.timeScale=e.timeScale,this.stopWarping()},halt:function(e){return this.warp(this._effectiveTimeScale,0,e)},warp:function(e,t,r){var i=this._mixer,n=i.time,a=this._timeScaleInterpolant,o=this.timeScale;null===a&&(a=i._lendControlInterpolant(),this._timeScaleInterpolant=a);var s=a.parameterPositions,c=a.sampleValues;return s[0]=n,s[1]=n+r,c[0]=e/o,c[1]=t/o,this},stopWarping:function(){var e=this._timeScaleInterpolant;return null!==e&&(this._timeScaleInterpolant=null,this._mixer._takeBackControlInterpolant(e)),this},getMixer:function(){return this._mixer},getClip:function(){return this._clip},getRoot:function(){return this._localRoot||this._mixer._root},_update:function(e,t,r,i){var n=this._startTime;if(null!==n){var a=(e-n)*r;if(a<0||0===r)return;this._startTime=null,t=r*a}t*=this._updateTimeScale(e);var o=this._updateTime(t),s=this._updateWeight(e);if(s>0)for(var c=this._interpolants,l=this._propertyBindings,h=0,u=c.length;h!==u;++h)c[h].evaluate(o),l[h].accumulate(i,s)},_updateWeight:function(e){var t=0;if(this.enabled){t=this.weight;var r=this._weightInterpolant;if(null!==r){var i=r.evaluate(e)[0];t*=i,e>r.parameterPositions[1]&&(this.stopFading(),0===i&&(this.enabled=!1))}}return this._effectiveWeight=t,t},_updateTimeScale:function(e){var t=0;if(!this.paused){t=this.timeScale;var r=this._timeScaleInterpolant;null!==r&&(t*=r.evaluate(e)[0],e>r.parameterPositions[1]&&(this.stopWarping(),0===t?this.paused=!0:this.timeScale=t))}return this._effectiveTimeScale=t,t},_updateTime:function(e){var t=this.time+e;if(0===e)return t;var r=this._clip.duration,i=this.loop,n=this._loopCount;if(2200===i){-1===n&&(this.loopCount=0,this._setEndings(!0,!0,!1));e:{if(t>=r)t=r;else{if(!(t<0))break e;t=0}this.clampWhenFinished?this.paused=!0:this.enabled=!1,this._mixer.dispatchEvent({type:"finished",action:this,direction:e<0?-1:1})}}else{var a=2202===i;if(-1===n&&(e>=0?(n=0,this._setEndings(!0,0===this.repetitions,a)):this._setEndings(0===this.repetitions,!0,a)),t>=r||t<0){var o=Math.floor(t/r);t-=r*o,n+=Math.abs(o);var s=this.repetitions-n;if(s<0)this.clampWhenFinished?this.paused=!0:this.enabled=!1,t=e>0?r:0,this._mixer.dispatchEvent({type:"finished",action:this,direction:e>0?1:-1});else{if(0===s){var c=e<0;this._setEndings(c,!c,a)}else this._setEndings(!1,!1,a);this._loopCount=n,this._mixer.dispatchEvent({type:"loop",action:this,loopDelta:o})}}if(a&&1==(1&n))return this.time=t,r-t}return this.time=t,t},_setEndings:function(e,t,r){var i=this._interpolantSettings;r?(i.endingStart=2401,i.endingEnd=2401):(i.endingStart=e?this.zeroSlopeAtStart?2401:Je:2402,i.endingEnd=t?this.zeroSlopeAtEnd?2401:Je:2402)},_scheduleFading:function(e,t,r){var i=this._mixer,n=i.time,a=this._weightInterpolant;null===a&&(a=i._lendControlInterpolant(),this._weightInterpolant=a);var o=a.parameterPositions,s=a.sampleValues;return o[0]=n,s[0]=t,o[1]=n+e,s[1]=r,this}},Object.assign(AnimationMixer.prototype,EventDispatcher.prototype,{clipAction:function(e,t){var r=t||this._root,i=r.uuid,n="string"==typeof e?AnimationClip.findByName(r,e):e,a=null!==n?n.uuid:e,o=this._actionsByClip[a],s=null;if(void 0!==o){var c=o.actionByRoot[i];if(void 0!==c)return c;s=o.knownActions[0],null===n&&(n=s._clip)}if(null===n)return null;var l=new AnimationAction(this,n,t);return this._bindAction(l,s),this._addInactiveAction(l,a,i),l},existingAction:function(e,t){var r=t||this._root,i=r.uuid,n="string"==typeof e?AnimationClip.findByName(r,e):e,a=n?n.uuid:e,o=this._actionsByClip[a];return void 0!==o?o.actionByRoot[i]||null:null},stopAllAction:function(){var e=this._actions,t=this._nActiveActions,r=this._bindings,i=this._nActiveBindings;this._nActiveActions=0,this._nActiveBindings=0;for(n=0;n!==t;++n)e[n].reset();for(var n=0;n!==i;++n)r[n].useCount=0;return this},update:function(e){e*=this.timeScale;for(var t=this._actions,r=this._nActiveActions,i=this.time+=e,n=Math.sign(e),a=this._accuIndex^=1,o=0;o!==r;++o){var s=t[o];s.enabled&&s._update(i,e,n,a)}for(var c=this._bindings,l=this._nActiveBindings,o=0;o!==l;++o)c[o].apply(a);return this},getRoot:function(){return this._root},uncacheClip:function(e){var t=this._actions,r=e.uuid,i=this._actionsByClip,n=i[r];if(void 0!==n){for(var a=n.knownActions,o=0,s=a.length;o!==s;++o){var c=a[o];this._deactivateAction(c);var l=c._cacheIndex,h=t[t.length-1];c._cacheIndex=null,c._byClipCacheIndex=null,h._cacheIndex=l,t[l]=h,t.pop(),this._removeInactiveBindingsForAction(c)}delete i[r]}},uncacheRoot:function(e){var t=e.uuid,r=this._actionsByClip;for(var i in r){var n=r[i].actionByRoot[t];void 0!==n&&(this._deactivateAction(n),this._removeInactiveAction(n))}var a=this._bindingsByRootAndName[t];if(void 0!==a)for(var o in a){var s=a[o];s.restoreOriginalState(),this._removeInactiveBinding(s)}},uncacheAction:function(e,t){var r=this.existingAction(e,t);null!==r&&(this._deactivateAction(r),this._removeInactiveAction(r))}}),Object.assign(AnimationMixer.prototype,{_bindAction:function(e,t){var r=e._localRoot||this._root,i=e._clip.tracks,n=i.length,a=e._propertyBindings,o=e._interpolants,s=r.uuid,c=this._bindingsByRootAndName,l=c[s];void 0===l&&(l={},c[s]=l);for(var h=0;h!==n;++h){var u=i[h],d=u.name,p=l[d];if(void 0!==p)a[h]=p;else{if(void 0!==(p=a[h])){null===p._cacheIndex&&(++p.referenceCount,this._addInactiveBinding(p,s,d));continue}var f=t&&t._propertyBindings[h].binding.parsedPath;++(p=new PropertyMixer(PropertyBinding.create(r,d,f),u.ValueTypeName,u.getValueSize())).referenceCount,this._addInactiveBinding(p,s,d),a[h]=p}o[h].resultBuffer=p.buffer}},_activateAction:function(e){if(!this._isActiveAction(e)){if(null===e._cacheIndex){var t=(e._localRoot||this._root).uuid,r=e._clip.uuid,i=this._actionsByClip[r];this._bindAction(e,i&&i.knownActions[0]),this._addInactiveAction(e,r,t)}for(var n=e._propertyBindings,a=0,o=n.length;a!==o;++a){var s=n[a];0==s.useCount++&&(this._lendBinding(s),s.saveOriginalState())}this._lendAction(e)}},_deactivateAction:function(e){if(this._isActiveAction(e)){for(var t=e._propertyBindings,r=0,i=t.length;r!==i;++r){var n=t[r];0==--n.useCount&&(n.restoreOriginalState(),this._takeBackBinding(n))}this._takeBackAction(e)}},_initMemoryManager:function(){this._actions=[],this._nActiveActions=0,this._actionsByClip={},this._bindings=[],this._nActiveBindings=0,this._bindingsByRootAndName={},this._controlInterpolants=[],this._nActiveControlInterpolants=0;var e=this;this.stats={actions:{get total(){return e._actions.length},get inUse(){return e._nActiveActions}},bindings:{get total(){return e._bindings.length},get inUse(){return e._nActiveBindings}},controlInterpolants:{get total(){return e._controlInterpolants.length},get inUse(){return e._nActiveControlInterpolants}}}},_isActiveAction:function(e){var t=e._cacheIndex;return null!==t&&t<this._nActiveActions},_addInactiveAction:function(e,t,r){var i=this._actions,n=this._actionsByClip,a=n[t];if(void 0===a)a={knownActions:[e],actionByRoot:{}},e._byClipCacheIndex=0,n[t]=a;else{var o=a.knownActions;e._byClipCacheIndex=o.length,o.push(e)}e._cacheIndex=i.length,i.push(e),a.actionByRoot[r]=e},_removeInactiveAction:function(e){var t=this._actions,r=t[t.length-1],i=e._cacheIndex;r._cacheIndex=i,t[i]=r,t.pop(),e._cacheIndex=null;var n=e._clip.uuid,a=this._actionsByClip,o=a[n],s=o.knownActions,c=s[s.length-1],l=e._byClipCacheIndex;c._byClipCacheIndex=l,s[l]=c,s.pop(),e._byClipCacheIndex=null,delete o.actionByRoot[(t._localRoot||this._root).uuid],0===s.length&&delete a[n],this._removeInactiveBindingsForAction(e)},_removeInactiveBindingsForAction:function(e){for(var t=e._propertyBindings,r=0,i=t.length;r!==i;++r){var n=t[r];0==--n.referenceCount&&this._removeInactiveBinding(n)}},_lendAction:function(e){var t=this._actions,r=e._cacheIndex,i=this._nActiveActions++,n=t[i];e._cacheIndex=i,t[i]=e,n._cacheIndex=r,t[r]=n},_takeBackAction:function(e){var t=this._actions,r=e._cacheIndex,i=--this._nActiveActions,n=t[i];e._cacheIndex=i,t[i]=e,n._cacheIndex=r,t[r]=n},_addInactiveBinding:function(e,t,r){var i=this._bindingsByRootAndName,n=i[t],a=this._bindings;void 0===n&&(n={},i[t]=n),n[r]=e,e._cacheIndex=a.length,a.push(e)},_removeInactiveBinding:function(e){var t=this._bindings,r=e.binding,i=r.rootNode.uuid,n=r.path,a=this._bindingsByRootAndName,o=a[i],s=t[t.length-1],c=e._cacheIndex;s._cacheIndex=c,t[c]=s,t.pop(),delete o[n];e:{for(var l in o)break e;delete a[i]}},_lendBinding:function(e){var t=this._bindings,r=e._cacheIndex,i=this._nActiveBindings++,n=t[i];e._cacheIndex=i,t[i]=e,n._cacheIndex=r,t[r]=n},_takeBackBinding:function(e){var t=this._bindings,r=e._cacheIndex,i=--this._nActiveBindings,n=t[i];e._cacheIndex=i,t[i]=e,n._cacheIndex=r,t[r]=n},_lendControlInterpolant:function(){var e=this._controlInterpolants,t=this._nActiveControlInterpolants++,r=e[t];return void 0===r&&((r=new LinearInterpolant(new Float32Array(2),new Float32Array(2),1,this._controlInterpolantsResultBuffer)).__cacheIndex=t,e[t]=r),r},_takeBackControlInterpolant:function(e){var t=this._controlInterpolants,r=e.__cacheIndex,i=--this._nActiveControlInterpolants,n=t[i];e.__cacheIndex=i,t[i]=e,n.__cacheIndex=r,t[r]=n},_controlInterpolantsResultBuffer:new Float32Array(1)}),(InstancedBufferGeometry.prototype=Object.create(BufferGeometry.prototype)).constructor=InstancedBufferGeometry,InstancedBufferGeometry.prototype.isInstancedBufferGeometry=!0,InstancedBufferGeometry.prototype.addGroup=function(e,t,r){this.groups.push({start:e,count:t,materialIndex:r})},InstancedBufferGeometry.prototype.copy=function(e){var t=e.index;null!==t&&this.setIndex(t.clone());var r=e.attributes;for(var i in r){var n=r[i];this.addAttribute(i,n.clone())}for(var a=e.groups,o=0,s=a.length;o<s;o++){var c=a[o];this.addGroup(c.start,c.count,c.materialIndex)}return this},InterleavedBufferAttribute.prototype={constructor:InterleavedBufferAttribute,isInterleavedBufferAttribute:!0,get count(){return this.data.count},get array(){return this.data.array},setX:function(e,t){return this.data.array[e*this.data.stride+this.offset]=t,this},setY:function(e,t){return this.data.array[e*this.data.stride+this.offset+1]=t,this},setZ:function(e,t){return this.data.array[e*this.data.stride+this.offset+2]=t,this},setW:function(e,t){return this.data.array[e*this.data.stride+this.offset+3]=t,this},getX:function(e){return this.data.array[e*this.data.stride+this.offset]},getY:function(e){return this.data.array[e*this.data.stride+this.offset+1]},getZ:function(e){return this.data.array[e*this.data.stride+this.offset+2]},getW:function(e){return this.data.array[e*this.data.stride+this.offset+3]},setXY:function(e,t,r){return e=e*this.data.stride+this.offset,this.data.array[e+0]=t,this.data.array[e+1]=r,this},setXYZ:function(e,t,r,i){return e=e*this.data.stride+this.offset,this.data.array[e+0]=t,this.data.array[e+1]=r,this.data.array[e+2]=i,this},setXYZW:function(e,t,r,i,n){return e=e*this.data.stride+this.offset,this.data.array[e+0]=t,this.data.array[e+1]=r,this.data.array[e+2]=i,this.data.array[e+3]=n,this}},InterleavedBuffer.prototype={constructor:InterleavedBuffer,isInterleavedBuffer:!0,set needsUpdate(e){!0===e&&this.version++},setArray:function(e){if(Array.isArray(e))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.count=void 0!==e?e.length/this.stride:0,this.array=e},setDynamic:function(e){return this.dynamic=e,this},copy:function(e){return this.array=new e.array.constructor(e.array),this.count=e.count,this.stride=e.stride,this.dynamic=e.dynamic,this},copyAt:function(e,t,r){e*=this.stride,r*=t.stride;for(var i=0,n=this.stride;i<n;i++)this.array[e+i]=t.array[r+i];return this},set:function(e,t){return void 0===t&&(t=0),this.array.set(e,t),this},clone:function(){return(new this.constructor).copy(this)}},(InstancedInterleavedBuffer.prototype=Object.create(InterleavedBuffer.prototype)).constructor=InstancedInterleavedBuffer,InstancedInterleavedBuffer.prototype.isInstancedInterleavedBuffer=!0,InstancedInterleavedBuffer.prototype.copy=function(e){return InterleavedBuffer.prototype.copy.call(this,e),this.meshPerAttribute=e.meshPerAttribute,this},(InstancedBufferAttribute.prototype=Object.create(BufferAttribute.prototype)).constructor=InstancedBufferAttribute,InstancedBufferAttribute.prototype.isInstancedBufferAttribute=!0,InstancedBufferAttribute.prototype.copy=function(e){return BufferAttribute.prototype.copy.call(this,e),this.meshPerAttribute=e.meshPerAttribute,this},Raycaster.prototype={constructor:Raycaster,linePrecision:1,set:function(e,t){this.ray.set(e,t)},setFromCamera:function(e,t){t&&t.isPerspectiveCamera?(this.ray.origin.setFromMatrixPosition(t.matrixWorld),this.ray.direction.set(e.x,e.y,.5).unproject(t).sub(this.ray.origin).normalize()):t&&t.isOrthographicCamera?(this.ray.origin.set(e.x,e.y,(t.near+t.far)/(t.near-t.far)).unproject(t),this.ray.direction.set(0,0,-1).transformDirection(t.matrixWorld)):console.error("THREE.Raycaster: Unsupported camera type.")},intersectObject:function(e,t){var r=[];return intersectObject(e,this,r,t),r.sort(ascSort),r},intersectObjects:function(e,t){var r=[];if(!1===Array.isArray(e))return console.warn("THREE.Raycaster.intersectObjects: objects is not an Array."),r;for(var i=0,n=e.length;i<n;i++)intersectObject(e[i],this,r,t);return r.sort(ascSort),r}},Clock.prototype={constructor:Clock,start:function(){this.startTime=(performance||Date).now(),this.oldTime=this.startTime,this.elapsedTime=0,this.running=!0},stop:function(){this.getElapsedTime(),this.running=!1},getElapsedTime:function(){return this.getDelta(),this.elapsedTime},getDelta:function(){var e=0;if(this.autoStart&&!this.running&&this.start(),this.running){var t=(performance||Date).now();e=(t-this.oldTime)/1e3,this.oldTime=t,this.elapsedTime+=e}return e}},Spherical.prototype={constructor:Spherical,set:function(e,t,r){return this.radius=e,this.phi=t,this.theta=r,this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.radius=e.radius,this.phi=e.phi,this.theta=e.theta,this},makeSafe:function(){return this.phi=Math.max(1e-6,Math.min(Math.PI-1e-6,this.phi)),this},setFromVector3:function(e){return this.radius=e.length(),0===this.radius?(this.theta=0,this.phi=0):(this.theta=Math.atan2(e.x,e.z),this.phi=Math.acos(ut.clamp(e.y/this.radius,-1,1))),this}},(MorphBlendMesh.prototype=Object.create(Mesh.prototype)).constructor=MorphBlendMesh,MorphBlendMesh.prototype.createAnimation=function(e,t,r,i){var n={start:t,end:r,length:r-t+1,fps:i,duration:(r-t)/i,lastFrame:0,currentFrame:0,active:!1,time:0,direction:1,weight:1,directionBackwards:!1,mirroredLoop:!1};this.animationsMap[e]=n,this.animationsList.push(n)},MorphBlendMesh.prototype.autoCreateAnimations=function(e){for(var t,r=/([a-z]+)_?(\d+)/i,i={},n=this.geometry,a=0,o=n.morphTargets.length;a<o;a++){var s=n.morphTargets[a].name.match(r);s&&s.length>1&&(i[c=s[1]]||(i[c]={start:1/0,end:-1/0}),a<(l=i[c]).start&&(l.start=a),a>l.end&&(l.end=a),t||(t=c))}for(var c in i){var l=i[c];this.createAnimation(c,l.start,l.end,e)}this.firstAnimation=t},MorphBlendMesh.prototype.setAnimationDirectionForward=function(e){var t=this.animationsMap[e];t&&(t.direction=1,t.directionBackwards=!1)},MorphBlendMesh.prototype.setAnimationDirectionBackward=function(e){var t=this.animationsMap[e];t&&(t.direction=-1,t.directionBackwards=!0)},MorphBlendMesh.prototype.setAnimationFPS=function(e,t){var r=this.animationsMap[e];r&&(r.fps=t,r.duration=(r.end-r.start)/r.fps)},MorphBlendMesh.prototype.setAnimationDuration=function(e,t){var r=this.animationsMap[e];r&&(r.duration=t,r.fps=(r.end-r.start)/r.duration)},MorphBlendMesh.prototype.setAnimationWeight=function(e,t){var r=this.animationsMap[e];r&&(r.weight=t)},MorphBlendMesh.prototype.setAnimationTime=function(e,t){var r=this.animationsMap[e];r&&(r.time=t)},MorphBlendMesh.prototype.getAnimationTime=function(e){var t=0,r=this.animationsMap[e];return r&&(t=r.time),t},MorphBlendMesh.prototype.getAnimationDuration=function(e){var t=-1,r=this.animationsMap[e];return r&&(t=r.duration),t},MorphBlendMesh.prototype.playAnimation=function(e){var t=this.animationsMap[e];t?(t.time=0,t.active=!0):console.warn("THREE.MorphBlendMesh: animation["+e+"] undefined in .playAnimation()")},MorphBlendMesh.prototype.stopAnimation=function(e){var t=this.animationsMap[e];t&&(t.active=!1)},MorphBlendMesh.prototype.update=function(e){for(var t=0,r=this.animationsList.length;t<r;t++){var i=this.animationsList[t];if(i.active){var n=i.duration/i.length;i.time+=i.direction*e,i.mirroredLoop?(i.time>i.duration||i.time<0)&&(i.direction*=-1,i.time>i.duration&&(i.time=i.duration,i.directionBackwards=!0),i.time<0&&(i.time=0,i.directionBackwards=!1)):(i.time=i.time%i.duration,i.time<0&&(i.time+=i.duration));var a=i.start+ut.clamp(Math.floor(i.time/n),0,i.length-1),o=i.weight;a!==i.currentFrame&&(this.morphTargetInfluences[i.lastFrame]=0,this.morphTargetInfluences[i.currentFrame]=1*o,this.morphTargetInfluences[a]=0,i.lastFrame=i.currentFrame,i.currentFrame=a);var s=i.time%n/n;i.directionBackwards&&(s=1-s),i.currentFrame!==i.lastFrame?(this.morphTargetInfluences[i.currentFrame]=s*o,this.morphTargetInfluences[i.lastFrame]=(1-s)*o):this.morphTargetInfluences[i.currentFrame]=o}}},(ImmediateRenderObject.prototype=Object.create(Object3D.prototype)).constructor=ImmediateRenderObject,ImmediateRenderObject.prototype.isImmediateRenderObject=!0,(VertexNormalsHelper.prototype=Object.create(LineSegments.prototype)).constructor=VertexNormalsHelper,VertexNormalsHelper.prototype.update=function(){var e=new Vector3,t=new Vector3,r=new Matrix3;return function update(){var i=["a","b","c"];this.object.updateMatrixWorld(!0),r.getNormalMatrix(this.object.matrixWorld);var n=this.object.matrixWorld,a=this.geometry.attributes.position,o=this.object.geometry;if(o&&o.isGeometry)for(var s=o.vertices,c=o.faces,l=0,h=0,u=c.length;h<u;h++)for(var d=c[h],p=0,f=d.vertexNormals.length;p<f;p++){var m=s[d[i[p]]],g=d.vertexNormals[p];e.copy(m).applyMatrix4(n),t.copy(g).applyMatrix3(r).normalize().multiplyScalar(this.size).add(e),a.setXYZ(l,e.x,e.y,e.z),l+=1,a.setXYZ(l,t.x,t.y,t.z),l+=1}else if(o&&o.isBufferGeometry)for(var v=o.attributes.position,y=o.attributes.normal,l=0,p=0,f=v.count;p<f;p++)e.set(v.getX(p),v.getY(p),v.getZ(p)).applyMatrix4(n),t.set(y.getX(p),y.getY(p),y.getZ(p)),t.applyMatrix3(r).normalize().multiplyScalar(this.size).add(e),a.setXYZ(l,e.x,e.y,e.z),l+=1,a.setXYZ(l,t.x,t.y,t.z),l+=1;return a.needsUpdate=!0,this}}(),(SpotLightHelper.prototype=Object.create(Object3D.prototype)).constructor=SpotLightHelper,SpotLightHelper.prototype.dispose=function(){this.cone.geometry.dispose(),this.cone.material.dispose()},SpotLightHelper.prototype.update=function(){var e=new Vector3,t=new Vector3;return function update(){var r=this.light.distance?this.light.distance:1e3,i=r*Math.tan(this.light.angle);this.cone.scale.set(i,i,r),e.setFromMatrixPosition(this.light.matrixWorld),t.setFromMatrixPosition(this.light.target.matrixWorld),this.cone.lookAt(t.sub(e)),this.cone.material.color.copy(this.light.color).multiplyScalar(this.light.intensity)}}(),(SkeletonHelper.prototype=Object.create(LineSegments.prototype)).constructor=SkeletonHelper,SkeletonHelper.prototype.getBoneList=function(e){var t=[];e&&e.isBone&&t.push(e);for(var r=0;r<e.children.length;r++)t.push.apply(t,this.getBoneList(e.children[r]));return t},SkeletonHelper.prototype.update=function(){for(var e=this.geometry,t=(new Matrix4).getInverse(this.root.matrixWorld),r=new Matrix4,i=0,n=0;n<this.bones.length;n++){var a=this.bones[n];a.parent&&a.parent.isBone&&(r.multiplyMatrices(t,a.matrixWorld),e.vertices[i].setFromMatrixPosition(r),r.multiplyMatrices(t,a.parent.matrixWorld),e.vertices[i+1].setFromMatrixPosition(r),i+=2)}e.verticesNeedUpdate=!0,e.computeBoundingSphere()},(PointLightHelper.prototype=Object.create(Mesh.prototype)).constructor=PointLightHelper,PointLightHelper.prototype.dispose=function(){this.geometry.dispose(),this.material.dispose()},PointLightHelper.prototype.update=function(){this.material.color.copy(this.light.color).multiplyScalar(this.light.intensity)},(HemisphereLightHelper.prototype=Object.create(Object3D.prototype)).constructor=HemisphereLightHelper,HemisphereLightHelper.prototype.dispose=function(){this.lightSphere.geometry.dispose(),this.lightSphere.material.dispose()},HemisphereLightHelper.prototype.update=function(){var e=new Vector3;return function update(){this.colors[0].copy(this.light.color).multiplyScalar(this.light.intensity),this.colors[1].copy(this.light.groundColor).multiplyScalar(this.light.intensity),this.lightSphere.lookAt(e.setFromMatrixPosition(this.light.matrixWorld).negate()),this.lightSphere.geometry.colorsNeedUpdate=!0}}(),(GridHelper.prototype=Object.create(LineSegments.prototype)).constructor=GridHelper,GridHelper.prototype.setColors=function(){console.error("THREE.GridHelper: setColors() has been deprecated, pass them in the constructor instead.")},(FaceNormalsHelper.prototype=Object.create(LineSegments.prototype)).constructor=FaceNormalsHelper,FaceNormalsHelper.prototype.update=function(){var e=new Vector3,t=new Vector3,r=new Matrix3;return function update(){this.object.updateMatrixWorld(!0),r.getNormalMatrix(this.object.matrixWorld);for(var i=this.object.matrixWorld,n=this.geometry.attributes.position,a=this.object.geometry,o=a.vertices,s=a.faces,c=0,l=0,h=s.length;l<h;l++){var u=s[l],d=u.normal;e.copy(o[u.a]).add(o[u.b]).add(o[u.c]).divideScalar(3).applyMatrix4(i),t.copy(d).applyMatrix3(r).normalize().multiplyScalar(this.size).add(e),n.setXYZ(c,e.x,e.y,e.z),c+=1,n.setXYZ(c,t.x,t.y,t.z),c+=1}return n.needsUpdate=!0,this}}(),(DirectionalLightHelper.prototype=Object.create(Object3D.prototype)).constructor=DirectionalLightHelper,DirectionalLightHelper.prototype.dispose=function(){var e=this.children[0],t=this.children[1];e.geometry.dispose(),e.material.dispose(),t.geometry.dispose(),t.material.dispose()},DirectionalLightHelper.prototype.update=function(){var e=new Vector3,t=new Vector3,r=new Vector3;return function update(){e.setFromMatrixPosition(this.light.matrixWorld),t.setFromMatrixPosition(this.light.target.matrixWorld),r.subVectors(t,e);var i=this.children[0],n=this.children[1];i.lookAt(r),i.material.color.copy(this.light.color).multiplyScalar(this.light.intensity),n.lookAt(r),n.scale.z=r.length()}}(),(CameraHelper.prototype=Object.create(LineSegments.prototype)).constructor=CameraHelper,CameraHelper.prototype.update=function(){function setPoint(n,a,o,s){r.set(a,o,s).unproject(i);var c=t[n];if(void 0!==c)for(var l=0,h=c.length;l<h;l++)e.vertices[c[l]].copy(r)}var e,t,r=new Vector3,i=new Camera;return function update(){e=this.geometry,t=this.pointMap;i.projectionMatrix.copy(this.camera.projectionMatrix),setPoint("c",0,0,-1),setPoint("t",0,0,1),setPoint("n1",-1,-1,-1),setPoint("n2",1,-1,-1),setPoint("n3",-1,1,-1),setPoint("n4",1,1,-1),setPoint("f1",-1,-1,1),setPoint("f2",1,-1,1),setPoint("f3",-1,1,1),setPoint("f4",1,1,1),setPoint("u1",.7,1.1,-1),setPoint("u2",-.7,1.1,-1),setPoint("u3",0,2,-1),setPoint("cf1",-1,0,1),setPoint("cf2",1,0,1),setPoint("cf3",0,-1,1),setPoint("cf4",0,1,1),setPoint("cn1",-1,0,-1),setPoint("cn2",1,0,-1),setPoint("cn3",0,-1,-1),setPoint("cn4",0,1,-1),e.verticesNeedUpdate=!0}}(),(BoundingBoxHelper.prototype=Object.create(Mesh.prototype)).constructor=BoundingBoxHelper,BoundingBoxHelper.prototype.update=function(){this.box.setFromObject(this.object),this.box.getSize(this.scale),this.box.getCenter(this.position)},(BoxHelper.prototype=Object.create(LineSegments.prototype)).constructor=BoxHelper,BoxHelper.prototype.update=function(){var e=new Box3;return function update(t){if(t&&t.isBox3?e.copy(t):e.setFromObject(t),!e.isEmpty()){var r=e.min,i=e.max,n=this.geometry.attributes.position,a=n.array;a[0]=i.x,a[1]=i.y,a[2]=i.z,a[3]=r.x,a[4]=i.y,a[5]=i.z,a[6]=r.x,a[7]=r.y,a[8]=i.z,a[9]=i.x,a[10]=r.y,a[11]=i.z,a[12]=i.x,a[13]=i.y,a[14]=r.z,a[15]=r.x,a[16]=i.y,a[17]=r.z,a[18]=r.x,a[19]=r.y,a[20]=r.z,a[21]=i.x,a[22]=r.y,a[23]=r.z,n.needsUpdate=!0,this.geometry.computeBoundingSphere()}}}();var Ft=new BufferGeometry;Ft.addAttribute("position",new Float32Attribute([0,0,0,0,1,0],3));var Vt=new CylinderBufferGeometry(0,.5,1,5,1);Vt.translate(0,-.5,0),(ArrowHelper.prototype=Object.create(Object3D.prototype)).constructor=ArrowHelper,ArrowHelper.prototype.setDirection=function(){var e,t=new Vector3;return function setDirection(r){r.y>.99999?this.quaternion.set(0,0,0,1):r.y<-.99999?this.quaternion.set(1,0,0,0):(t.set(r.z,0,-r.x).normalize(),e=Math.acos(r.y),this.quaternion.setFromAxisAngle(t,e))}}(),ArrowHelper.prototype.setLength=function(e,t,r){void 0===t&&(t=.2*e),void 0===r&&(r=.2*t),this.line.scale.set(1,Math.max(0,e-t),1),this.line.updateMatrix(),this.cone.scale.set(r,t,r),this.cone.position.y=e,this.cone.updateMatrix()},ArrowHelper.prototype.setColor=function(e){this.line.material.color.copy(e),this.cone.material.color.copy(e)},(AxisHelper.prototype=Object.create(LineSegments.prototype)).constructor=AxisHelper;var Nt=function(){function CubicPoly(){}var e=new Vector3,t=new CubicPoly,r=new CubicPoly,i=new CubicPoly;return CubicPoly.prototype.init=function(e,t,r,i){this.c0=e,this.c1=r,this.c2=-3*e+3*t-2*r-i,this.c3=2*e-2*t+r+i},CubicPoly.prototype.initNonuniformCatmullRom=function(e,t,r,i,n,a,o){var s=(t-e)/n-(r-e)/(n+a)+(r-t)/a,c=(r-t)/a-(i-t)/(a+o)+(i-r)/o;s*=a,c*=a,this.init(t,r,s,c)},CubicPoly.prototype.initCatmullRom=function(e,t,r,i,n){this.init(t,r,n*(r-e),n*(i-t))},CubicPoly.prototype.calc=function(e){var t=e*e,r=t*e;return this.c0+this.c1*e+this.c2*t+this.c3*r},Curve.create(function(e){this.points=e||[],this.closed=!1},function(n){var a,o,s,c,l=this.points;(c=l.length)<2&&console.log("duh, you need at least 2 points"),s=(a=(c-(this.closed?0:1))*n)-(o=Math.floor(a)),this.closed?o+=o>0?0:(Math.floor(Math.abs(o)/l.length)+1)*l.length:0===s&&o===c-1&&(o=c-2,s=1);var h,u,d,p;if(this.closed||o>0?h=l[(o-1)%c]:(e.subVectors(l[0],l[1]).add(l[0]),h=e),u=l[o%c],d=l[(o+1)%c],this.closed||o+2<c?p=l[(o+2)%c]:(e.subVectors(l[c-1],l[c-2]).add(l[c-1]),p=e),void 0===this.type||"centripetal"===this.type||"chordal"===this.type){var f="chordal"===this.type?.5:.25,m=Math.pow(h.distanceToSquared(u),f),g=Math.pow(u.distanceToSquared(d),f),v=Math.pow(d.distanceToSquared(p),f);g<1e-4&&(g=1),m<1e-4&&(m=g),v<1e-4&&(v=g),t.initNonuniformCatmullRom(h.x,u.x,d.x,p.x,m,g,v),r.initNonuniformCatmullRom(h.y,u.y,d.y,p.y,m,g,v),i.initNonuniformCatmullRom(h.z,u.z,d.z,p.z,m,g,v)}else if("catmullrom"===this.type){var y=void 0!==this.tension?this.tension:.5;t.initCatmullRom(h.x,u.x,d.x,p.x,y),r.initCatmullRom(h.y,u.y,d.y,p.y,y),i.initCatmullRom(h.z,u.z,d.z,p.z,y)}return new Vector3(t.calc(s),r.calc(s),i.calc(s))})}();ClosedSplineCurve3.prototype=Object.create(Nt.prototype);var zt=Curve.create(function(e){console.warn("THREE.SplineCurve3 will be deprecated. Please use THREE.CatmullRomCurve3"),this.points=void 0===e?[]:e},function(e){var t=this.points,r=(t.length-1)*e,i=Math.floor(r),n=r-i,a=t[0==i?i:i-1],o=t[i],s=t[i>t.length-2?t.length-1:i+1],c=t[i>t.length-3?t.length-1:i+2],l=Dt.interpolate;return new Vector3(l(a.x,o.x,s.x,c.x,n),l(a.y,o.y,s.y,c.y,n),l(a.z,o.z,s.z,c.z,n))}),Ht=Curve.create(function(e,t,r,i){this.v0=e,this.v1=t,this.v2=r,this.v3=i},function(e){var t=At.b3;return new Vector3(t(e,this.v0.x,this.v1.x,this.v2.x,this.v3.x),t(e,this.v0.y,this.v1.y,this.v2.y,this.v3.y),t(e,this.v0.z,this.v1.z,this.v2.z,this.v3.z))}),kt=Curve.create(function(e,t,r){this.v0=e,this.v1=t,this.v2=r},function(e){var t=At.b2;return new Vector3(t(e,this.v0.x,this.v1.x,this.v2.x),t(e,this.v0.y,this.v1.y,this.v2.y),t(e,this.v0.z,this.v1.z,this.v2.z))}),jt=Curve.create(function(e,t){this.v1=e,this.v2=t},function(e){if(1===e)return this.v2.clone();var t=new Vector3;return t.subVectors(this.v2,this.v1),t.multiplyScalar(e),t.add(this.v1),t});(ArcCurve.prototype=Object.create(EllipseCurve.prototype)).constructor=ArcCurve;var Wt={createMultiMaterialObject:function(e,t){for(var r=new Group,i=0,n=t.length;i<n;i++)r.add(new Mesh(e,t[i]));return r},detach:function(e,t,r){e.applyMatrix(t.matrixWorld),t.remove(e),r.add(e)},attach:function(e,t,r){var i=new Matrix4;i.getInverse(r.matrixWorld),e.applyMatrix(i),t.remove(e),r.add(e)}};Object.assign(Box2.prototype,{center:function(e){return console.warn("THREE.Box2: .center() has been renamed to .getCenter()."),this.getCenter(e)},empty:function(){return console.warn("THREE.Box2: .empty() has been renamed to .isEmpty()."),this.isEmpty()},isIntersectionBox:function(e){return console.warn("THREE.Box2: .isIntersectionBox() has been renamed to .intersectsBox()."),this.intersectsBox(e)},size:function(e){return console.warn("THREE.Box2: .size() has been renamed to .getSize()."),this.getSize(e)}}),Object.assign(Box3.prototype,{center:function(e){return console.warn("THREE.Box3: .center() has been renamed to .getCenter()."),this.getCenter(e)},empty:function(){return console.warn("THREE.Box3: .empty() has been renamed to .isEmpty()."),this.isEmpty()},isIntersectionBox:function(e){return console.warn("THREE.Box3: .isIntersectionBox() has been renamed to .intersectsBox()."),this.intersectsBox(e)},isIntersectionSphere:function(e){return console.warn("THREE.Box3: .isIntersectionSphere() has been renamed to .intersectsSphere()."),this.intersectsSphere(e)},size:function(e){return console.warn("THREE.Box3: .size() has been renamed to .getSize()."),this.getSize(e)}}),Object.assign(Line3.prototype,{center:function(e){return console.warn("THREE.Line3: .center() has been renamed to .getCenter()."),this.getCenter(e)}}),Object.assign(Matrix3.prototype,{multiplyVector3:function(e){return console.warn("THREE.Matrix3: .multiplyVector3() has been removed. Use vector.applyMatrix3( matrix ) instead."),e.applyMatrix3(this)},multiplyVector3Array:function(e){return console.warn("THREE.Matrix3: .multiplyVector3Array() has been renamed. Use matrix.applyToVector3Array( array ) instead."),this.applyToVector3Array(e)}}),Object.assign(Matrix4.prototype,{extractPosition:function(e){return console.warn("THREE.Matrix4: .extractPosition() has been renamed to .copyPosition()."),this.copyPosition(e)},setRotationFromQuaternion:function(e){return console.warn("THREE.Matrix4: .setRotationFromQuaternion() has been renamed to .makeRotationFromQuaternion()."),this.makeRotationFromQuaternion(e)},multiplyVector3:function(e){return console.warn("THREE.Matrix4: .multiplyVector3() has been removed. Use vector.applyMatrix4( matrix ) or vector.applyProjection( matrix ) instead."),e.applyProjection(this)},multiplyVector4:function(e){return console.warn("THREE.Matrix4: .multiplyVector4() has been removed. Use vector.applyMatrix4( matrix ) instead."),e.applyMatrix4(this)},multiplyVector3Array:function(e){return console.warn("THREE.Matrix4: .multiplyVector3Array() has been renamed. Use matrix.applyToVector3Array( array ) instead."),this.applyToVector3Array(e)},rotateAxis:function(e){console.warn("THREE.Matrix4: .rotateAxis() has been removed. Use Vector3.transformDirection( matrix ) instead."),e.transformDirection(this)},crossVector:function(e){return console.warn("THREE.Matrix4: .crossVector() has been removed. Use vector.applyMatrix4( matrix ) instead."),e.applyMatrix4(this)},translate:function(e){console.error("THREE.Matrix4: .translate() has been removed.")},rotateX:function(e){console.error("THREE.Matrix4: .rotateX() has been removed.")},rotateY:function(e){console.error("THREE.Matrix4: .rotateY() has been removed.")},rotateZ:function(e){console.error("THREE.Matrix4: .rotateZ() has been removed.")},rotateByAxis:function(e,t){console.error("THREE.Matrix4: .rotateByAxis() has been removed.")}}),Object.assign(Plane.prototype,{isIntersectionLine:function(e){return console.warn("THREE.Plane: .isIntersectionLine() has been renamed to .intersectsLine()."),this.intersectsLine(e)}}),Object.assign(Quaternion.prototype,{multiplyVector3:function(e){return console.warn("THREE.Quaternion: .multiplyVector3() has been removed. Use is now vector.applyQuaternion( quaternion ) instead."),e.applyQuaternion(this)}}),Object.assign(Ray.prototype,{isIntersectionBox:function(e){return console.warn("THREE.Ray: .isIntersectionBox() has been renamed to .intersectsBox()."),this.intersectsBox(e)},isIntersectionPlane:function(e){return console.warn("THREE.Ray: .isIntersectionPlane() has been renamed to .intersectsPlane()."),this.intersectsPlane(e)},isIntersectionSphere:function(e){return console.warn("THREE.Ray: .isIntersectionSphere() has been renamed to .intersectsSphere()."),this.intersectsSphere(e)}}),Object.assign(Shape.prototype,{extrude:function(e){return console.warn("THREE.Shape: .extrude() has been removed. Use ExtrudeGeometry() instead."),new ExtrudeGeometry(this,e)},makeGeometry:function(e){return console.warn("THREE.Shape: .makeGeometry() has been removed. Use ShapeGeometry() instead."),new ShapeGeometry(this,e)}}),Object.assign(Vector3.prototype,{setEulerFromRotationMatrix:function(){console.error("THREE.Vector3: .setEulerFromRotationMatrix() has been removed. Use Euler.setFromRotationMatrix() instead.")},setEulerFromQuaternion:function(){console.error("THREE.Vector3: .setEulerFromQuaternion() has been removed. Use Euler.setFromQuaternion() instead.")},getPositionFromMatrix:function(e){return console.warn("THREE.Vector3: .getPositionFromMatrix() has been renamed to .setFromMatrixPosition()."),this.setFromMatrixPosition(e)},getScaleFromMatrix:function(e){return console.warn("THREE.Vector3: .getScaleFromMatrix() has been renamed to .setFromMatrixScale()."),this.setFromMatrixScale(e)},getColumnFromMatrix:function(e,t){return console.warn("THREE.Vector3: .getColumnFromMatrix() has been renamed to .setFromMatrixColumn()."),this.setFromMatrixColumn(t,e)}}),Object.assign(Object3D.prototype,{getChildByName:function(e){return console.warn("THREE.Object3D: .getChildByName() has been renamed to .getObjectByName()."),this.getObjectByName(e)},renderDepth:function(e){console.warn("THREE.Object3D: .renderDepth has been removed. Use .renderOrder, instead.")},translate:function(e,t){return console.warn("THREE.Object3D: .translate() has been removed. Use .translateOnAxis( axis, distance ) instead."),this.translateOnAxis(t,e)}}),Object.defineProperties(Object3D.prototype,{eulerOrder:{get:function(){return console.warn("THREE.Object3D: .eulerOrder is now .rotation.order."),this.rotation.order},set:function(e){console.warn("THREE.Object3D: .eulerOrder is now .rotation.order."),this.rotation.order=e}},useQuaternion:{get:function(){console.warn("THREE.Object3D: .useQuaternion has been removed. The library now uses quaternions by default.")},set:function(e){console.warn("THREE.Object3D: .useQuaternion has been removed. The library now uses quaternions by default.")}}}),Object.defineProperties(LOD.prototype,{objects:{get:function(){return console.warn("THREE.LOD: .objects has been renamed to .levels."),this.levels}}}),PerspectiveCamera.prototype.setLens=function(e,t){console.warn("THREE.PerspectiveCamera.setLens is deprecated. Use .setFocalLength and .filmGauge for a photographic setup."),void 0!==t&&(this.filmGauge=t),this.setFocalLength(e)},Object.defineProperties(Light.prototype,{onlyShadow:{set:function(e){console.warn("THREE.Light: .onlyShadow has been removed.")}},shadowCameraFov:{set:function(e){console.warn("THREE.Light: .shadowCameraFov is now .shadow.camera.fov."),this.shadow.camera.fov=e}},shadowCameraLeft:{set:function(e){console.warn("THREE.Light: .shadowCameraLeft is now .shadow.camera.left."),this.shadow.camera.left=e}},shadowCameraRight:{set:function(e){console.warn("THREE.Light: .shadowCameraRight is now .shadow.camera.right."),this.shadow.camera.right=e}},shadowCameraTop:{set:function(e){console.warn("THREE.Light: .shadowCameraTop is now .shadow.camera.top."),this.shadow.camera.top=e}},shadowCameraBottom:{set:function(e){console.warn("THREE.Light: .shadowCameraBottom is now .shadow.camera.bottom."),this.shadow.camera.bottom=e}},shadowCameraNear:{set:function(e){console.warn("THREE.Light: .shadowCameraNear is now .shadow.camera.near."),this.shadow.camera.near=e}},shadowCameraFar:{set:function(e){console.warn("THREE.Light: .shadowCameraFar is now .shadow.camera.far."),this.shadow.camera.far=e}},shadowCameraVisible:{set:function(e){console.warn("THREE.Light: .shadowCameraVisible has been removed. Use new THREE.CameraHelper( light.shadow.camera ) instead.")}},shadowBias:{set:function(e){console.warn("THREE.Light: .shadowBias is now .shadow.bias."),this.shadow.bias=e}},shadowDarkness:{set:function(e){console.warn("THREE.Light: .shadowDarkness has been removed.")}},shadowMapWidth:{set:function(e){console.warn("THREE.Light: .shadowMapWidth is now .shadow.mapSize.width."),this.shadow.mapSize.width=e}},shadowMapHeight:{set:function(e){console.warn("THREE.Light: .shadowMapHeight is now .shadow.mapSize.height."),this.shadow.mapSize.height=e}}}),Object.defineProperties(BufferAttribute.prototype,{length:{get:function(){return console.warn("THREE.BufferAttribute: .length has been deprecated. Please use .count."),this.array.length}}}),Object.assign(BufferGeometry.prototype,{addIndex:function(e){console.warn("THREE.BufferGeometry: .addIndex() has been renamed to .setIndex()."),this.setIndex(e)},addDrawCall:function(e,t,r){void 0!==r&&console.warn("THREE.BufferGeometry: .addDrawCall() no longer supports indexOffset."),console.warn("THREE.BufferGeometry: .addDrawCall() is now .addGroup()."),this.addGroup(e,t)},clearDrawCalls:function(){console.warn("THREE.BufferGeometry: .clearDrawCalls() is now .clearGroups()."),this.clearGroups()},computeTangents:function(){console.warn("THREE.BufferGeometry: .computeTangents() has been removed.")},computeOffsets:function(){console.warn("THREE.BufferGeometry: .computeOffsets() has been removed.")}}),Object.defineProperties(BufferGeometry.prototype,{drawcalls:{get:function(){return console.error("THREE.BufferGeometry: .drawcalls has been renamed to .groups."),this.groups}},offsets:{get:function(){return console.warn("THREE.BufferGeometry: .offsets has been renamed to .groups."),this.groups}}}),Object.defineProperties(Material.prototype,{wrapAround:{get:function(){console.warn("THREE."+this.type+": .wrapAround has been removed.")},set:function(e){console.warn("THREE."+this.type+": .wrapAround has been removed.")}},wrapRGB:{get:function(){return console.warn("THREE."+this.type+": .wrapRGB has been removed."),new Color}}}),Object.defineProperties(MeshPhongMaterial.prototype,{metal:{get:function(){return console.warn("THREE.MeshPhongMaterial: .metal has been removed. Use THREE.MeshStandardMaterial instead."),!1},set:function(e){console.warn("THREE.MeshPhongMaterial: .metal has been removed. Use THREE.MeshStandardMaterial instead")}}}),Object.defineProperties(ShaderMaterial.prototype,{derivatives:{get:function(){return console.warn("THREE.ShaderMaterial: .derivatives has been moved to .extensions.derivatives."),this.extensions.derivatives},set:function(e){console.warn("THREE. ShaderMaterial: .derivatives has been moved to .extensions.derivatives."),this.extensions.derivatives=e}}}),EventDispatcher.prototype=Object.assign(Object.create({constructor:EventDispatcher,apply:function(e){console.warn("THREE.EventDispatcher: .apply is deprecated, just inherit or Object.assign the prototype to mix-in."),Object.assign(e,this)}}),EventDispatcher.prototype),Object.defineProperties(Uniform.prototype,{dynamic:{set:function(e){console.warn("THREE.Uniform: .dynamic has been removed. Use object.onBeforeRender() instead.")}},onUpdate:{value:function(){return console.warn("THREE.Uniform: .onUpdate() has been removed. Use object.onBeforeRender() instead."),this}}}),Object.assign(WebGLRenderer.prototype,{supportsFloatTextures:function(){return console.warn("THREE.WebGLRenderer: .supportsFloatTextures() is now .extensions.get( 'OES_texture_float' )."),this.extensions.get("OES_texture_float")},supportsHalfFloatTextures:function(){return console.warn("THREE.WebGLRenderer: .supportsHalfFloatTextures() is now .extensions.get( 'OES_texture_half_float' )."),this.extensions.get("OES_texture_half_float")},supportsStandardDerivatives:function(){return console.warn("THREE.WebGLRenderer: .supportsStandardDerivatives() is now .extensions.get( 'OES_standard_derivatives' )."),this.extensions.get("OES_standard_derivatives")},supportsCompressedTextureS3TC:function(){return console.warn("THREE.WebGLRenderer: .supportsCompressedTextureS3TC() is now .extensions.get( 'WEBGL_compressed_texture_s3tc' )."),this.extensions.get("WEBGL_compressed_texture_s3tc")},supportsCompressedTexturePVRTC:function(){return console.warn("THREE.WebGLRenderer: .supportsCompressedTexturePVRTC() is now .extensions.get( 'WEBGL_compressed_texture_pvrtc' )."),this.extensions.get("WEBGL_compressed_texture_pvrtc")},supportsBlendMinMax:function(){return console.warn("THREE.WebGLRenderer: .supportsBlendMinMax() is now .extensions.get( 'EXT_blend_minmax' )."),this.extensions.get("EXT_blend_minmax")},supportsVertexTextures:function(){return this.capabilities.vertexTextures},supportsInstancedArrays:function(){return console.warn("THREE.WebGLRenderer: .supportsInstancedArrays() is now .extensions.get( 'ANGLE_instanced_arrays' )."),this.extensions.get("ANGLE_instanced_arrays")},enableScissorTest:function(e){console.warn("THREE.WebGLRenderer: .enableScissorTest() is now .setScissorTest()."),this.setScissorTest(e)},initMaterial:function(){console.warn("THREE.WebGLRenderer: .initMaterial() has been removed.")},addPrePlugin:function(){console.warn("THREE.WebGLRenderer: .addPrePlugin() has been removed.")},addPostPlugin:function(){console.warn("THREE.WebGLRenderer: .addPostPlugin() has been removed.")},updateShadowMap:function(){console.warn("THREE.WebGLRenderer: .updateShadowMap() has been removed.")}}),Object.defineProperties(WebGLRenderer.prototype,{shadowMapEnabled:{get:function(){return this.shadowMap.enabled},set:function(e){console.warn("THREE.WebGLRenderer: .shadowMapEnabled is now .shadowMap.enabled."),this.shadowMap.enabled=e}},shadowMapType:{get:function(){return this.shadowMap.type},set:function(e){console.warn("THREE.WebGLRenderer: .shadowMapType is now .shadowMap.type."),this.shadowMap.type=e}},shadowMapCullFace:{get:function(){return this.shadowMap.cullFace},set:function(e){console.warn("THREE.WebGLRenderer: .shadowMapCullFace is now .shadowMap.cullFace."),this.shadowMap.cullFace=e}}}),Object.defineProperties(WebGLShadowMap.prototype,{cullFace:{get:function(){return this.renderReverseSided?a:n},set:function(e){var t=e!==n;console.warn("WebGLRenderer: .shadowMap.cullFace is deprecated. Set .shadowMap.renderReverseSided to "+t+"."),this.renderReverseSided=t}}}),Object.defineProperties(WebGLRenderTarget.prototype,{wrapS:{get:function(){return console.warn("THREE.WebGLRenderTarget: .wrapS is now .texture.wrapS."),this.texture.wrapS},set:function(e){console.warn("THREE.WebGLRenderTarget: .wrapS is now .texture.wrapS."),this.texture.wrapS=e}},wrapT:{get:function(){return console.warn("THREE.WebGLRenderTarget: .wrapT is now .texture.wrapT."),this.texture.wrapT},set:function(e){console.warn("THREE.WebGLRenderTarget: .wrapT is now .texture.wrapT."),this.texture.wrapT=e}},magFilter:{get:function(){return console.warn("THREE.WebGLRenderTarget: .magFilter is now .texture.magFilter."),this.texture.magFilter},set:function(e){console.warn("THREE.WebGLRenderTarget: .magFilter is now .texture.magFilter."),this.texture.magFilter=e}},minFilter:{get:function(){return console.warn("THREE.WebGLRenderTarget: .minFilter is now .texture.minFilter."),this.texture.minFilter},set:function(e){console.warn("THREE.WebGLRenderTarget: .minFilter is now .texture.minFilter."),this.texture.minFilter=e}},anisotropy:{get:function(){return console.warn("THREE.WebGLRenderTarget: .anisotropy is now .texture.anisotropy."),this.texture.anisotropy},set:function(e){console.warn("THREE.WebGLRenderTarget: .anisotropy is now .texture.anisotropy."),this.texture.anisotropy=e}},offset:{get:function(){return console.warn("THREE.WebGLRenderTarget: .offset is now .texture.offset."),this.texture.offset},set:function(e){console.warn("THREE.WebGLRenderTarget: .offset is now .texture.offset."),this.texture.offset=e}},repeat:{get:function(){return console.warn("THREE.WebGLRenderTarget: .repeat is now .texture.repeat."),this.texture.repeat},set:function(e){console.warn("THREE.WebGLRenderTarget: .repeat is now .texture.repeat."),this.texture.repeat=e}},format:{get:function(){return console.warn("THREE.WebGLRenderTarget: .format is now .texture.format."),this.texture.format},set:function(e){console.warn("THREE.WebGLRenderTarget: .format is now .texture.format."),this.texture.format=e}},type:{get:function(){return console.warn("THREE.WebGLRenderTarget: .type is now .texture.type."),this.texture.type},set:function(e){console.warn("THREE.WebGLRenderTarget: .type is now .texture.type."),this.texture.type=e}},generateMipmaps:{get:function(){return console.warn("THREE.WebGLRenderTarget: .generateMipmaps is now .texture.generateMipmaps."),this.texture.generateMipmaps},set:function(e){console.warn("THREE.WebGLRenderTarget: .generateMipmaps is now .texture.generateMipmaps."),this.texture.generateMipmaps=e}}}),Object.assign(Audio.prototype,{load:function(e){console.warn("THREE.Audio: .load has been deprecated. Please use THREE.AudioLoader.");var t=this;return(new AudioLoader).load(e,function(e){t.setBuffer(e)}),this}}),Object.assign(AudioAnalyser.prototype,{getData:function(e){return console.warn("THREE.AudioAnalyser: .getData() is now .getFrequencyData()."),this.getFrequencyData()}});var Xt={merge:function(e,t,r){console.warn("THREE.GeometryUtils: .merge() has been moved to Geometry. Use geometry.merge( geometry2, matrix, materialIndexOffset ) instead.");var i;t.isMesh&&(t.matrixAutoUpdate&&t.updateMatrix(),i=t.matrix,t=t.geometry),e.merge(t,i,r)},center:function(e){return console.warn("THREE.GeometryUtils: .center() has been moved to Geometry. Use geometry.center() instead."),e.center()}},Yt={crossOrigin:void 0,loadTexture:function(e,t,r,i){console.warn("THREE.ImageUtils.loadTexture has been deprecated. Use THREE.TextureLoader() instead.");var n=new TextureLoader;n.setCrossOrigin(this.crossOrigin);var a=n.load(e,r,void 0,i);return t&&(a.mapping=t),a},loadTextureCube:function(e,t,r,i){console.warn("THREE.ImageUtils.loadTextureCube has been deprecated. Use THREE.CubeTextureLoader() instead.");var n=new CubeTextureLoader;n.setCrossOrigin(this.crossOrigin);var a=n.load(e,r,void 0,i);return t&&(a.mapping=t),a},loadCompressedTexture:function(){console.error("THREE.ImageUtils.loadCompressedTexture has been removed. Use THREE.DDSLoader instead.")},loadCompressedTextureCube:function(){console.error("THREE.ImageUtils.loadCompressedTextureCube has been removed. Use THREE.DDSLoader instead.")}};e.WebGLRenderTargetCube=WebGLRenderTargetCube,e.WebGLRenderTarget=WebGLRenderTarget,e.WebGLRenderer=WebGLRenderer,e.ShaderLib=Mt,e.UniformsLib=_t,e.UniformsUtils=yt,e.ShaderChunk=xt,e.FogExp2=FogExp2,e.Fog=Fog,e.Scene=Scene,e.LensFlare=LensFlare,e.Sprite=Sprite,e.LOD=LOD,e.SkinnedMesh=SkinnedMesh,e.Skeleton=Skeleton,e.Bone=Bone,e.Mesh=Mesh,e.LineSegments=LineSegments,e.Line=Line,e.Points=Points,e.Group=Group,e.VideoTexture=VideoTexture,e.DataTexture=DataTexture,e.CompressedTexture=CompressedTexture,e.CubeTexture=CubeTexture,e.CanvasTexture=CanvasTexture,e.DepthTexture=DepthTexture,e.TextureIdCount=TextureIdCount,e.Texture=Texture,e.MaterialIdCount=MaterialIdCount,e.CompressedTextureLoader=CompressedTextureLoader,e.BinaryTextureLoader=BinaryTextureLoader,e.DataTextureLoader=Bt,e.CubeTextureLoader=CubeTextureLoader,e.TextureLoader=TextureLoader,e.ObjectLoader=ObjectLoader,e.MaterialLoader=MaterialLoader,e.BufferGeometryLoader=BufferGeometryLoader,e.DefaultLoadingManager=Rt,e.LoadingManager=LoadingManager,e.JSONLoader=JSONLoader,e.ImageLoader=ImageLoader,e.FontLoader=FontLoader,e.XHRLoader=XHRLoader,e.Loader=Loader,e.Cache=Ct,e.AudioLoader=AudioLoader,e.SpotLightShadow=SpotLightShadow,e.SpotLight=SpotLight,e.PointLight=PointLight,e.HemisphereLight=HemisphereLight,e.DirectionalLightShadow=DirectionalLightShadow,e.DirectionalLight=DirectionalLight,e.AmbientLight=AmbientLight,e.LightShadow=LightShadow,e.Light=Light,e.StereoCamera=StereoCamera,e.PerspectiveCamera=PerspectiveCamera,e.OrthographicCamera=OrthographicCamera,e.CubeCamera=CubeCamera,e.Camera=Camera,e.AudioListener=AudioListener,e.PositionalAudio=PositionalAudio,e.getAudioContext=getAudioContext,e.AudioAnalyser=AudioAnalyser,e.Audio=Audio,e.VectorKeyframeTrack=VectorKeyframeTrack,e.StringKeyframeTrack=StringKeyframeTrack,e.QuaternionKeyframeTrack=QuaternionKeyframeTrack,e.NumberKeyframeTrack=NumberKeyframeTrack,e.ColorKeyframeTrack=ColorKeyframeTrack,e.BooleanKeyframeTrack=BooleanKeyframeTrack,e.PropertyMixer=PropertyMixer,e.PropertyBinding=PropertyBinding,e.KeyframeTrack=KeyframeTrack,e.AnimationUtils=It,e.AnimationObjectGroup=AnimationObjectGroup,e.AnimationMixer=AnimationMixer,e.AnimationClip=AnimationClip,e.Uniform=Uniform,e.InstancedBufferGeometry=InstancedBufferGeometry,e.BufferGeometry=BufferGeometry,e.GeometryIdCount=GeometryIdCount,e.Geometry=Geometry,e.InterleavedBufferAttribute=InterleavedBufferAttribute,e.InstancedInterleavedBuffer=InstancedInterleavedBuffer,e.InterleavedBuffer=InterleavedBuffer,e.InstancedBufferAttribute=InstancedBufferAttribute,e.DynamicBufferAttribute=function DynamicBufferAttribute(e,t){return console.warn("THREE.DynamicBufferAttribute has been removed. Use new THREE.BufferAttribute().setDynamic( true ) instead."),new BufferAttribute(e,t).setDynamic(!0)},e.Float64Attribute=function Float64Attribute(e,t){return new BufferAttribute(new Float64Array(e),t)},e.Float32Attribute=Float32Attribute,e.Uint32Attribute=Uint32Attribute,e.Int32Attribute=function Int32Attribute(e,t){return new BufferAttribute(new Int32Array(e),t)},e.Uint16Attribute=Uint16Attribute,e.Int16Attribute=function Int16Attribute(e,t){return new BufferAttribute(new Int16Array(e),t)},e.Uint8ClampedAttribute=function Uint8ClampedAttribute(e,t){return new BufferAttribute(new Uint8ClampedArray(e),t)},e.Uint8Attribute=function Uint8Attribute(e,t){return new BufferAttribute(new Uint8Array(e),t)},e.Int8Attribute=function Int8Attribute(e,t){return new BufferAttribute(new Int8Array(e),t)},e.BufferAttribute=BufferAttribute,e.Face3=Face3,e.Object3DIdCount=Object3DIdCount,e.Object3D=Object3D,e.Raycaster=Raycaster,e.Layers=Layers,e.EventDispatcher=EventDispatcher,e.Clock=Clock,e.QuaternionLinearInterpolant=QuaternionLinearInterpolant,e.LinearInterpolant=LinearInterpolant,e.DiscreteInterpolant=DiscreteInterpolant,e.CubicInterpolant=CubicInterpolant,e.Interpolant=Interpolant,e.Triangle=Triangle,e.Spline=function Spline(e){function interpolate(e,t,r,i,n,a,o){var s=.5*(r-e),c=.5*(i-t);return(2*(t-r)+s+c)*o+(-3*(t-r)-2*s-c)*a+s*n+t}this.points=e;var t,r,i,n,a,o,s,c,l,h=[],u={x:0,y:0,z:0};this.initFromArray=function(e){this.points=[];for(var t=0;t<e.length;t++)this.points[t]={x:e[t][0],y:e[t][1],z:e[t][2]}},this.getPoint=function(e){return t=(this.points.length-1)*e,r=Math.floor(t),i=t-r,h[0]=0===r?r:r-1,h[1]=r,h[2]=r>this.points.length-2?this.points.length-1:r+1,h[3]=r>this.points.length-3?this.points.length-1:r+2,o=this.points[h[0]],s=this.points[h[1]],c=this.points[h[2]],l=this.points[h[3]],n=i*i,a=i*n,u.x=interpolate(o.x,s.x,c.x,l.x,i,n,a),u.y=interpolate(o.y,s.y,c.y,l.y,i,n,a),u.z=interpolate(o.z,s.z,c.z,l.z,i,n,a),u},this.getControlPointsArray=function(){var e,t,r=this.points.length,i=[];for(e=0;e<r;e++)t=this.points[e],i[e]=[t.x,t.y,t.z];return i},this.getLength=function(e){var t,r,i,n,a=0,o=0,s=0,c=new Vector3,l=new Vector3,h=[],u=0;for(h[0]=0,e||(e=100),i=this.points.length*e,c.copy(this.points[0]),t=1;t<i;t++)r=t/i,n=this.getPoint(r),l.copy(n),u+=l.distanceTo(c),c.copy(n),a=(this.points.length-1)*r,(o=Math.floor(a))!==s&&(h[o]=u,s=o);return h[h.length]=u,{chunks:h,total:u}},this.reparametrizeByArcLength=function(e){var t,r,i,n,a,o,s,c,l=[],h=new Vector3,u=this.getLength();for(l.push(h.copy(this.points[0]).clone()),t=1;t<this.points.length;t++){for(o=u.chunks[t]-u.chunks[t-1],s=Math.ceil(e*o/u.total),n=(t-1)/(this.points.length-1),a=t/(this.points.length-1),r=1;r<s-1;r++)i=n+r*(1/s)*(a-n),c=this.getPoint(i),l.push(h.copy(c).clone());l.push(h.copy(this.points[t]).clone())}this.points=l}},e.Math=ut,e.Spherical=Spherical,e.Plane=Plane,e.Frustum=Frustum,e.Sphere=Sphere,e.Ray=Ray,e.Matrix4=Matrix4,e.Matrix3=Matrix3,e.Box3=Box3,e.Box2=Box2,e.Line3=Line3,e.Euler=Euler,e.Vector4=Vector4,e.Vector3=Vector3,e.Vector2=Vector2,e.Quaternion=Quaternion,e.ColorKeywords=bt,e.Color=Color,e.MorphBlendMesh=MorphBlendMesh,e.ImmediateRenderObject=ImmediateRenderObject,e.VertexNormalsHelper=VertexNormalsHelper,e.SpotLightHelper=SpotLightHelper,e.SkeletonHelper=SkeletonHelper,e.PointLightHelper=PointLightHelper,e.HemisphereLightHelper=HemisphereLightHelper,e.GridHelper=GridHelper,e.FaceNormalsHelper=FaceNormalsHelper,e.DirectionalLightHelper=DirectionalLightHelper,e.CameraHelper=CameraHelper,e.BoundingBoxHelper=BoundingBoxHelper,e.BoxHelper=BoxHelper,e.ArrowHelper=ArrowHelper,e.AxisHelper=AxisHelper,e.ClosedSplineCurve3=ClosedSplineCurve3,e.CatmullRomCurve3=Nt,e.SplineCurve3=zt,e.CubicBezierCurve3=Ht,e.QuadraticBezierCurve3=kt,e.LineCurve3=jt,e.ArcCurve=ArcCurve,e.EllipseCurve=EllipseCurve,e.SplineCurve=SplineCurve,e.CubicBezierCurve=CubicBezierCurve,e.QuadraticBezierCurve=QuadraticBezierCurve,e.LineCurve=LineCurve,e.Shape=Shape,e.ShapePath=ShapePath,e.Path=Path,e.Font=Font,e.CurvePath=CurvePath,e.Curve=Curve,e.ShapeUtils=At,e.SceneUtils=Wt,e.CurveUtils=Dt,e.WireframeGeometry=WireframeGeometry,e.ParametricGeometry=ParametricGeometry,e.ParametricBufferGeometry=ParametricBufferGeometry,e.TetrahedronGeometry=TetrahedronGeometry,e.TetrahedronBufferGeometry=TetrahedronBufferGeometry,e.OctahedronGeometry=OctahedronGeometry,e.OctahedronBufferGeometry=OctahedronBufferGeometry,e.IcosahedronGeometry=IcosahedronGeometry,e.IcosahedronBufferGeometry=IcosahedronBufferGeometry,e.DodecahedronGeometry=DodecahedronGeometry,e.DodecahedronBufferGeometry=DodecahedronBufferGeometry,e.PolyhedronGeometry=PolyhedronGeometry,e.PolyhedronBufferGeometry=PolyhedronBufferGeometry,e.TubeGeometry=TubeGeometry,e.TubeBufferGeometry=TubeBufferGeometry,e.TorusKnotGeometry=TorusKnotGeometry,e.TorusKnotBufferGeometry=TorusKnotBufferGeometry,e.TorusGeometry=TorusGeometry,e.TorusBufferGeometry=TorusBufferGeometry,e.TextGeometry=TextGeometry,e.SphereBufferGeometry=SphereBufferGeometry,e.SphereGeometry=SphereGeometry,e.RingGeometry=RingGeometry,e.RingBufferGeometry=RingBufferGeometry,e.PlaneBufferGeometry=PlaneBufferGeometry,e.PlaneGeometry=PlaneGeometry,e.LatheGeometry=LatheGeometry,e.LatheBufferGeometry=LatheBufferGeometry,e.ShapeGeometry=ShapeGeometry,e.ExtrudeGeometry=ExtrudeGeometry,e.EdgesGeometry=EdgesGeometry,e.ConeGeometry=ConeGeometry,e.ConeBufferGeometry=ConeBufferGeometry,e.CylinderGeometry=CylinderGeometry,e.CylinderBufferGeometry=CylinderBufferGeometry,e.CircleBufferGeometry=CircleBufferGeometry,e.CircleGeometry=CircleGeometry,e.BoxBufferGeometry=BoxBufferGeometry,e.BoxGeometry=BoxGeometry,e.ShadowMaterial=ShadowMaterial,e.SpriteMaterial=SpriteMaterial,e.RawShaderMaterial=RawShaderMaterial,e.ShaderMaterial=ShaderMaterial,e.PointsMaterial=PointsMaterial,e.MultiMaterial=MultiMaterial,e.MeshPhysicalMaterial=MeshPhysicalMaterial,e.MeshStandardMaterial=MeshStandardMaterial,e.MeshPhongMaterial=MeshPhongMaterial,e.MeshNormalMaterial=MeshNormalMaterial,e.MeshLambertMaterial=MeshLambertMaterial,e.MeshDepthMaterial=MeshDepthMaterial,e.MeshBasicMaterial=MeshBasicMaterial,e.LineDashedMaterial=LineDashedMaterial,e.LineBasicMaterial=LineBasicMaterial,e.Material=Material,e.REVISION=t,e.MOUSE=r,e.CullFaceNone=i,e.CullFaceBack=n,e.CullFaceFront=a,e.CullFaceFrontBack=3,e.FrontFaceDirectionCW=o,e.FrontFaceDirectionCCW=1,e.BasicShadowMap=0,e.PCFShadowMap=s,e.PCFSoftShadowMap=c,e.FrontSide=l,e.BackSide=h,e.DoubleSide=u,e.FlatShading=d,e.SmoothShading=p,e.NoColors=f,e.FaceColors=m,e.VertexColors=g,e.NoBlending=y,e.NormalBlending=x,e.AdditiveBlending=b,e.SubtractiveBlending=_,e.MultiplyBlending=M,e.CustomBlending=w,e.BlendingMode=T,e.AddEquation=S,e.SubtractEquation=E,e.ReverseSubtractEquation=A,e.MinEquation=L,e.MaxEquation=P,e.ZeroFactor=C,e.OneFactor=R,e.SrcColorFactor=B,e.OneMinusSrcColorFactor=I,e.SrcAlphaFactor=G,e.OneMinusSrcAlphaFactor=D,e.DstAlphaFactor=U,e.OneMinusDstAlphaFactor=O,e.DstColorFactor=F,e.OneMinusDstColorFactor=V,e.SrcAlphaSaturateFactor=N,e.NeverDepth=z,e.AlwaysDepth=H,e.LessDepth=k,e.LessEqualDepth=j,e.EqualDepth=W,e.GreaterEqualDepth=X,e.GreaterDepth=Y,e.NotEqualDepth=q,e.MultiplyOperation=Z,e.MixOperation=K,e.AddOperation=Q,e.NoToneMapping=J,e.LinearToneMapping=$,e.ReinhardToneMapping=ee,e.Uncharted2ToneMapping=te,e.CineonToneMapping=re,e.UVMapping=300,e.CubeReflectionMapping=ie,e.CubeRefractionMapping=ne,e.EquirectangularReflectionMapping=ae,e.EquirectangularRefractionMapping=oe,e.SphericalReflectionMapping=se,e.CubeUVReflectionMapping=ce,e.CubeUVRefractionMapping=le,e.TextureMapping=he,e.RepeatWrapping=ue,e.ClampToEdgeWrapping=de,e.MirroredRepeatWrapping=pe,e.TextureWrapping=fe,e.NearestFilter=me,e.NearestMipMapNearestFilter=ge,e.NearestMipMapLinearFilter=ve,e.LinearFilter=ye,e.LinearMipMapNearestFilter=xe,e.LinearMipMapLinearFilter=be,e.TextureFilter=_e,e.UnsignedByteType=Me,e.ByteType=we,e.ShortType=Te,e.UnsignedShortType=Se,e.IntType=Ee,e.UnsignedIntType=Ae,e.FloatType=Le,e.HalfFloatType=Pe,e.UnsignedShort4444Type=Ce,e.UnsignedShort5551Type=Re,e.UnsignedShort565Type=Be,e.UnsignedInt248Type=Ie,e.AlphaFormat=Ge,e.RGBFormat=De,e.RGBAFormat=Ue,e.LuminanceFormat=Oe,e.LuminanceAlphaFormat=Fe,e.RGBEFormat=Ve,e.DepthFormat=Ne,e.DepthStencilFormat=ze,e.RGB_S3TC_DXT1_Format=He,e.RGBA_S3TC_DXT1_Format=ke,e.RGBA_S3TC_DXT3_Format=je,e.RGBA_S3TC_DXT5_Format=We,e.RGB_PVRTC_4BPPV1_Format=Xe,e.RGB_PVRTC_2BPPV1_Format=Ye,e.RGBA_PVRTC_4BPPV1_Format=qe,e.RGBA_PVRTC_2BPPV1_Format=Ze,e.RGB_ETC1_Format=Ke,e.LoopOnce=2200,e.LoopRepeat=Qe,e.LoopPingPong=2202,e.InterpolateDiscrete=2300,e.InterpolateLinear=2301,e.InterpolateSmooth=2302,e.ZeroCurvatureEnding=Je,e.ZeroSlopeEnding=2401,e.WrapAroundEnding=2402,e.TrianglesDrawMode=$e,e.TriangleStripDrawMode=et,e.TriangleFanDrawMode=tt,e.LinearEncoding=rt,e.sRGBEncoding=it,e.GammaEncoding=nt,e.RGBEEncoding=at,e.LogLuvEncoding=3003,e.RGBM7Encoding=ot,e.RGBM16Encoding=st,e.RGBDEncoding=ct,e.BasicDepthPacking=lt,e.RGBADepthPacking=ht,e.CubeGeometry=BoxGeometry,e.Face4=function Face4(e,t,r,i,n,a,o){return console.warn("THREE.Face4 has been removed. A THREE.Face3 will be created instead."),new Face3(e,t,r,n,a,o)},e.LineStrip=0,e.LinePieces=1,e.MeshFaceMaterial=MultiMaterial,e.PointCloud=function PointCloud(e,t){return console.warn("THREE.PointCloud has been renamed to THREE.Points."),new Points(e,t)},e.Particle=Sprite,e.ParticleSystem=function ParticleSystem(e,t){return console.warn("THREE.ParticleSystem has been renamed to THREE.Points."),new Points(e,t)},e.PointCloudMaterial=function PointCloudMaterial(e){return console.warn("THREE.PointCloudMaterial has been renamed to THREE.PointsMaterial."),new PointsMaterial(e)},e.ParticleBasicMaterial=function ParticleBasicMaterial(e){return console.warn("THREE.ParticleBasicMaterial has been renamed to THREE.PointsMaterial."),new PointsMaterial(e)},e.ParticleSystemMaterial=function ParticleSystemMaterial(e){return console.warn("THREE.ParticleSystemMaterial has been renamed to THREE.PointsMaterial."),new PointsMaterial(e)},e.Vertex=function Vertex(e,t,r){return console.warn("THREE.Vertex has been removed. Use THREE.Vector3 instead."),new Vector3(e,t,r)},e.EdgesHelper=function EdgesHelper(e,t){return console.warn("THREE.EdgesHelper has been removed. Use THREE.EdgesGeometry instead."),new LineSegments(new EdgesGeometry(e.geometry),new LineBasicMaterial({color:void 0!==t?t:16777215}))},e.WireframeHelper=function WireframeHelper(e,t){return console.warn("THREE.WireframeHelper has been removed. Use THREE.WireframeGeometry instead."),new LineSegments(new WireframeGeometry(e.geometry),new LineBasicMaterial({color:void 0!==t?t:16777215}))},e.GeometryUtils=Xt,e.ImageUtils=Yt,e.Projector=function Projector(){console.error("THREE.Projector has been moved to /examples/js/renderers/Projector.js."),this.projectVector=function(e,t){console.warn("THREE.Projector: .projectVector() is now vector.project()."),e.project(t)},this.unprojectVector=function(e,t){console.warn("THREE.Projector: .unprojectVector() is now vector.unproject()."),e.unproject(t)},this.pickingRay=function(e,t){console.error("THREE.Projector: .pickingRay() is now raycaster.setFromCamera().")}},e.CanvasRenderer=function CanvasRenderer(){console.error("THREE.CanvasRenderer has been moved to /examples/js/renderers/CanvasRenderer.js"),this.domElement=document.createElementNS("http://www.w3.org/1999/xhtml","canvas"),this.clear=function(){},this.render=function(){},this.setClearColor=function(){},this.setSize=function(){}},Object.defineProperty(e,"__esModule",{value:!0}),Object.defineProperty(e,"AudioContext",{get:function(){return e.getAudioContext()}})});
	THREE.OrbitControls=function(e,t){function getAutoRotationAngle(){return 2*Math.PI/60/60*o.autoRotateSpeed}function getZoomScale(){return Math.pow(.95,o.zoomSpeed)}function rotateLeft(e){l.theta-=e}function rotateUp(e){l.phi-=e}function dollyIn(e){o.object instanceof THREE.PerspectiveCamera?d/=e:o.object instanceof THREE.OrthographicCamera?(o.object.zoom=Math.max(o.minZoom,Math.min(o.maxZoom,o.object.zoom*e)),o.object.updateProjectionMatrix(),m=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),o.enableZoom=!1)}function dollyOut(e){o.object instanceof THREE.PerspectiveCamera?d*=e:o.object instanceof THREE.OrthographicCamera?(o.object.zoom=Math.max(o.minZoom,Math.min(o.maxZoom,o.object.zoom/e)),o.object.updateProjectionMatrix(),m=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),o.enableZoom=!1)}function handleMouseDownRotate(e){E.set(e.clientX,e.clientY)}function handleMouseDownDolly(e){v.set(e.clientX,e.clientY)}function handleMouseDownPan(e){T.set(e.clientX,e.clientY)}function handleMouseMoveRotate(e){p.set(e.clientX,e.clientY),b.subVectors(p,E);var t=o.domElement===document?o.domElement.body:o.domElement;rotateLeft(2*Math.PI*b.x/t.clientWidth*o.rotateSpeed),rotateUp(2*Math.PI*b.y/t.clientHeight*o.rotateSpeed),E.copy(p),o.update()}function handleMouseMoveDolly(e){R.set(e.clientX,e.clientY),M.subVectors(R,v),M.y>0?dollyIn(getZoomScale()):M.y<0&&dollyOut(getZoomScale()),v.copy(R),o.update()}function handleMouseMovePan(e){f.set(e.clientX,e.clientY),g.subVectors(f,T),w(g.x,g.y),T.copy(f),o.update()}function handleMouseUp(e){}function handleMouseWheel(e){e.deltaY<0?dollyOut(getZoomScale()):e.deltaY>0&&dollyIn(getZoomScale()),o.update()}function handleKeyDown(e){switch(e.keyCode){case o.keys.UP:w(0,o.keyPanSpeed),o.update();break;case o.keys.BOTTOM:w(0,-o.keyPanSpeed),o.update();break;case o.keys.LEFT:w(o.keyPanSpeed,0),o.update();break;case o.keys.RIGHT:w(-o.keyPanSpeed,0),o.update()}}function handleTouchStartRotate(e){E.set(e.touches[0].pageX,e.touches[0].pageY)}function handleTouchStartDolly(e){var t=e.touches[0].pageX-e.touches[1].pageX,o=e.touches[0].pageY-e.touches[1].pageY,n=Math.sqrt(t*t+o*o);v.set(0,n)}function handleTouchStartPan(e){T.set(e.touches[0].pageX,e.touches[0].pageY)}function handleTouchMoveRotate(e){p.set(e.touches[0].pageX,e.touches[0].pageY),b.subVectors(p,E);var t=o.domElement===document?o.domElement.body:o.domElement;rotateLeft(2*Math.PI*b.x/t.clientWidth*o.rotateSpeed),rotateUp(2*Math.PI*b.y/t.clientHeight*o.rotateSpeed),E.copy(p),o.update()}function handleTouchMoveDolly(e){var t=e.touches[0].pageX-e.touches[1].pageX,n=e.touches[0].pageY-e.touches[1].pageY,a=Math.sqrt(t*t+n*n);R.set(0,a),M.subVectors(R,v),M.y>0?dollyOut(getZoomScale()):M.y<0&&dollyIn(getZoomScale()),v.copy(R),o.update()}function handleTouchMovePan(e){f.set(e.touches[0].pageX,e.touches[0].pageY),g.subVectors(f,T),w(g.x,g.y),T.copy(f),o.update()}function handleTouchEnd(e){}function onMouseDown(e){if(!1!==o.enabled){if(e.preventDefault(),e.button===o.mouseButtons.ORBIT){if(!1===o.enableRotate)return;handleMouseDownRotate(e),s=r.ROTATE}else if(e.button===o.mouseButtons.ZOOM){if(!1===o.enableZoom)return;handleMouseDownDolly(e),s=r.DOLLY}else if(e.button===o.mouseButtons.PAN){if(!1===o.enablePan)return;handleMouseDownPan(e),s=r.PAN}s!==r.NONE&&(document.addEventListener("mousemove",onMouseMove,!1),document.addEventListener("mouseup",onMouseUp,!1),o.dispatchEvent(a))}}function onMouseMove(e){if(!1!==o.enabled)if(e.preventDefault(),s===r.ROTATE){if(!1===o.enableRotate)return;handleMouseMoveRotate(e)}else if(s===r.DOLLY){if(!1===o.enableZoom)return;handleMouseMoveDolly(e)}else if(s===r.PAN){if(!1===o.enablePan)return;handleMouseMovePan(e)}}function onMouseUp(e){!1!==o.enabled&&(handleMouseUp(e),document.removeEventListener("mousemove",onMouseMove,!1),document.removeEventListener("mouseup",onMouseUp,!1),o.dispatchEvent(i),s=r.NONE)}function onMouseWheel(e){!1===o.enabled||!1===o.enableZoom||s!==r.NONE&&s!==r.ROTATE||(e.preventDefault(),e.stopPropagation(),handleMouseWheel(e),o.dispatchEvent(a),o.dispatchEvent(i))}function onKeyDown(e){!1!==o.enabled&&!1!==o.enableKeys&&!1!==o.enablePan&&handleKeyDown(e)}function onTouchStart(e){if(!1!==o.enabled){switch(e.touches.length){case 1:if(!1===o.enableRotate)return;handleTouchStartRotate(e),s=r.TOUCH_ROTATE;break;case 2:if(!1===o.enableZoom)return;handleTouchStartDolly(e),s=r.TOUCH_DOLLY;break;case 3:if(!1===o.enablePan)return;handleTouchStartPan(e),s=r.TOUCH_PAN;break;default:s=r.NONE}s!==r.NONE&&o.dispatchEvent(a)}}function onTouchMove(e){if(!1!==o.enabled)switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case 1:if(!1===o.enableRotate)return;if(s!==r.TOUCH_ROTATE)return;handleTouchMoveRotate(e);break;case 2:if(!1===o.enableZoom)return;if(s!==r.TOUCH_DOLLY)return;handleTouchMoveDolly(e);break;case 3:if(!1===o.enablePan)return;if(s!==r.TOUCH_PAN)return;handleTouchMovePan(e);break;default:s=r.NONE}}function onTouchEnd(e){!1!==o.enabled&&(handleTouchEnd(e),o.dispatchEvent(i),s=r.NONE)}function onContextMenu(e){e.preventDefault()}this.object=e,this.domElement=void 0!==t?t:document,this.enabled=!0,this.target=new THREE.Vector3,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.25,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.enableKeys=!0,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.mouseButtons={ORBIT:THREE.MOUSE.LEFT,ZOOM:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this.getPolarAngle=function(){return u.phi},this.getAzimuthalAngle=function(){return u.theta},this.reset=function(){o.target.copy(o.target0),o.object.position.copy(o.position0),o.object.zoom=o.zoom0,o.object.updateProjectionMatrix(),o.dispatchEvent(n),o.update(),s=r.NONE},this.update=function(){var t=new THREE.Vector3,a=(new THREE.Quaternion).setFromUnitVectors(e.up,new THREE.Vector3(0,1,0)),i=a.clone().inverse(),E=new THREE.Vector3,p=new THREE.Quaternion;return function update(){var e=o.object.position;return t.copy(e).sub(o.target),t.applyQuaternion(a),u.setFromVector3(t),o.autoRotate&&s===r.NONE&&rotateLeft(getAutoRotationAngle()),u.theta+=l.theta,u.phi+=l.phi,u.theta=Math.max(o.minAzimuthAngle,Math.min(o.maxAzimuthAngle,u.theta)),u.phi=Math.max(o.minPolarAngle,Math.min(o.maxPolarAngle,u.phi)),u.makeSafe(),u.radius*=d,u.radius=Math.max(o.minDistance,Math.min(o.maxDistance,u.radius)),o.target.add(h),t.setFromSpherical(u),t.applyQuaternion(i),e.copy(o.target).add(t),o.object.lookAt(o.target),!0===o.enableDamping?(l.theta*=1-o.dampingFactor,l.phi*=1-o.dampingFactor):l.set(0,0,0),d=1,h.set(0,0,0),!!(m||E.distanceToSquared(o.object.position)>c||8*(1-p.dot(o.object.quaternion))>c)&&(o.dispatchEvent(n),E.copy(o.object.position),p.copy(o.object.quaternion),m=!1,!0)}}(),this.dispose=function(){o.domElement.removeEventListener("contextmenu",onContextMenu,!1),o.domElement.removeEventListener("mousedown",onMouseDown,!1),o.domElement.removeEventListener("wheel",onMouseWheel,!1),o.domElement.removeEventListener("touchstart",onTouchStart,!1),o.domElement.removeEventListener("touchend",onTouchEnd,!1),o.domElement.removeEventListener("touchmove",onTouchMove,!1),document.removeEventListener("mousemove",onMouseMove,!1),document.removeEventListener("mouseup",onMouseUp,!1),window.removeEventListener("keydown",onKeyDown,!1)};var o=this,n={type:"change"},a={type:"start"},i={type:"end"},r={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5},s=r.NONE,c=1e-6,u=new THREE.Spherical,l=new THREE.Spherical,d=1,h=new THREE.Vector3,m=!1,E=new THREE.Vector2,p=new THREE.Vector2,b=new THREE.Vector2,T=new THREE.Vector2,f=new THREE.Vector2,g=new THREE.Vector2,v=new THREE.Vector2,R=new THREE.Vector2,M=new THREE.Vector2,y=function(){var e=new THREE.Vector3;return function panLeft(t,o){e.setFromMatrixColumn(o,0),e.multiplyScalar(-t),h.add(e)}}(),O=function(){var e=new THREE.Vector3;return function panUp(t,o){e.setFromMatrixColumn(o,1),e.multiplyScalar(t),h.add(e)}}(),w=function(){var e=new THREE.Vector3;return function pan(t,n){var a=o.domElement===document?o.domElement.body:o.domElement;if(o.object instanceof THREE.PerspectiveCamera){var i=o.object.position;e.copy(i).sub(o.target);var r=e.length();r*=Math.tan(o.object.fov/2*Math.PI/180),y(2*t*r/a.clientHeight,o.object.matrix),O(2*n*r/a.clientHeight,o.object.matrix)}else o.object instanceof THREE.OrthographicCamera?(y(t*(o.object.right-o.object.left)/o.object.zoom/a.clientWidth,o.object.matrix),O(n*(o.object.top-o.object.bottom)/o.object.zoom/a.clientHeight,o.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),o.enablePan=!1)}}();o.domElement.addEventListener("contextmenu",onContextMenu,!1),o.domElement.addEventListener("mousedown",onMouseDown,!1),o.domElement.addEventListener("wheel",onMouseWheel,!1),o.domElement.addEventListener("touchstart",onTouchStart,!1),o.domElement.addEventListener("touchend",onTouchEnd,!1),o.domElement.addEventListener("touchmove",onTouchMove,!1),window.addEventListener("keydown",onKeyDown,!1),this.update()},THREE.OrbitControls.prototype=Object.create(THREE.EventDispatcher.prototype),THREE.OrbitControls.prototype.constructor=THREE.OrbitControls,Object.defineProperties(THREE.OrbitControls.prototype,{center:{get:function(){return console.warn("THREE.OrbitControls: .center has been renamed to .target"),this.target}},noZoom:{get:function(){return console.warn("THREE.OrbitControls: .noZoom has been deprecated. Use .enableZoom instead."),!this.enableZoom},set:function(e){console.warn("THREE.OrbitControls: .noZoom has been deprecated. Use .enableZoom instead."),this.enableZoom=!e}},noRotate:{get:function(){return console.warn("THREE.OrbitControls: .noRotate has been deprecated. Use .enableRotate instead."),!this.enableRotate},set:function(e){console.warn("THREE.OrbitControls: .noRotate has been deprecated. Use .enableRotate instead."),this.enableRotate=!e}},noPan:{get:function(){return console.warn("THREE.OrbitControls: .noPan has been deprecated. Use .enablePan instead."),!this.enablePan},set:function(e){console.warn("THREE.OrbitControls: .noPan has been deprecated. Use .enablePan instead."),this.enablePan=!e}},noKeys:{get:function(){return console.warn("THREE.OrbitControls: .noKeys has been deprecated. Use .enableKeys instead."),!this.enableKeys},set:function(e){console.warn("THREE.OrbitControls: .noKeys has been deprecated. Use .enableKeys instead."),this.enableKeys=!e}},staticMoving:{get:function(){return console.warn("THREE.OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead."),!this.enableDamping},set:function(e){console.warn("THREE.OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead."),this.enableDamping=!e}},dynamicDampingFactor:{get:function(){return console.warn("THREE.OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.dampingFactor},set:function(e){console.warn("THREE.OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.dampingFactor=e}}});
	/* Chart interface logic for Duet Web Control
	 *
	 * written by Christian Hammacher (c) 2016-2017
	 *
	 * licensed under the terms of the GPL v3
	 * see http://www.gnu.org/licenses/gpl-3.0.html
	 */


	var tempChart;
	var tempChartOptions = 	{
		// This array should hold maxHeaters + maxTempSensors + 1 (for the chamber heater) items
		colors: ["#0000FF", "#FF0000", "#00DD00", "#FFA000", "#FF00FF", "#337AB7", "#000000", "#E0E000",							// Heater colors
				"#00DCDC",																											// Chamber color (deprecated)
				"#AEAEAE", "#BC0000", "#00CB00", "#0000DC", "#FEABEF", "#A0A000", "#DDDD00", "#00BDBD", "#CCBBAA", "#AA00AA"],		// Temp sensor colors
		grid: {
			borderWidth: 0
		},
		xaxis: {
			show: false
			/*labelWidth: 0,
			labelHeight: 0,
			tickSize: 30000,
			tickFormatter: function() { return ""; },
			reserveSpace: false*/
		},
		yaxis: {
			min: 0,
			max: 280
		}
	};
	var tempChartPadding = 15;

	var maxTemperatureSamples = 1000;
	var maxLayerTime = 0;


	var printChart;
	var printChartOptions =	{
		colors: ["#EDC240"],
		grid: {
			borderWidth: 0,
			hoverable: true,
			clickable: true
		},
		pan: {
			interactive: true
		},
		series: {
			lines: {
				show: true
			},
			points: {
				show: true
			}
		},
		xaxis: {
			min: 1,
			tickDecimals: 0,
		},
		yaxis: {
			min: 0,
			max: 30,
			ticks: 5,
			tickDecimals: 0,
			tickFormatter: function(val) {
				if (!val) {
					return "";
				} else {
					return formatTime(val);
				}
			}
		},
		zoom: {
			interactive: true
		}
	};

	var refreshTempChart = false, refreshPrintChart = false;
	var recordedTemperatures, layerData;


	/* Temperature chart */

	function recordHeadTemperatures(bedTemp, chamberTemp, headTemps) {
		var timeNow = (new Date()).getTime();

		// Add temperatures for each configured head
		// Also cut off the last one if there are too many temperature samples
		for(var i = 0; i < maxHeaters + 1; i++) {
			if (i > 0 && i < headTemps.length + 1) {
				recordedTemperatures[i].push([timeNow, headTemps[i - 1]]);
			} else {
				recordedTemperatures[i].push([]);
			}

			if (recordedTemperatures[i].length > maxTemperatureSamples) {
				recordedTemperatures[i].shift();
			}
		}

		// Set bed temperature (if any)
		if (bedHeater != -1) {
			recordedTemperatures[bedHeater][recordedTemperatures[bedHeater].length - 1] = [timeNow, bedTemp];
		}

		// Set chamber temperature (if any)
		if (chamberHeater != -1) {
			recordedTemperatures[chamberHeater][recordedTemperatures[chamberHeater].length - 1] = [timeNow, chamberTemp];
		}
	}

	function recordCurrentTemperatures(temps) {
		var timeNow = (new Date()).getTime();

		// Add temperatures for each heater
		// Also cut off the last one if there are too many temperature samples
		for(var heater = 0; heater < maxHeaters; heater++) {
			if (heater < temps.length && heatersInUse[heater]) {
				recordedTemperatures[heater].push([timeNow, temps[heater]]);
			} else {
				recordedTemperatures[heater].push([]);
			}

			if (recordedTemperatures[heater].length > maxTemperatureSamples) {
				recordedTemperatures[heater].shift();
			}
		}
	}

	function recordExtraTemperatures(temps) {
		var timeNow = (new Date()).getTime();

		// Add dashed series for each temperature sensor
		for(var i = 0; i < maxTempSensors; i++)
		{
			if (i < temps.length) {
				recordedTemperatures[maxHeaters + 1 + i].data.push([timeNow, temps[i].temp]);
			} else {
				recordedTemperatures[maxHeaters + 1 + i].data.push([]);
			}

			if (recordedTemperatures[maxHeaters + 1 + i].data.length > maxTemperatureSamples) {
				recordedTemperatures[maxHeaters + 1 + i].data.shift();
			}
		}
	}

	function drawTemperatureChart() {
		// Only draw the chart if it's possible
		if ($("#chart_temp").width() === 0) {
			refreshTempChart = true;
			return;
		}

		// Check if we need to recreate the chart
		var recreateChart = false;
		if (tempLimit != tempChartOptions.yaxis.max) {
			tempChartOptions.yaxis.max = tempLimit;
			recreateChart = true;
		}

		// Draw it
		if (tempChart == undefined || recreateChart) {
			tempChart = $.plot("#chart_temp", recordedTemperatures, tempChartOptions);
		} else {
			tempChart.setData(recordedTemperatures);
			tempChart.setupGrid();
			tempChart.draw();
		}

		refreshTempChart = false;
	}

	function setExtraTemperatureVisibility(sensor, visible) {
		// Update visibility
		recordedTemperatures[maxHeaters + 1 + sensor].dashes.show = visible;
		recordedTemperatures[maxHeaters + 1 + sensor].lines.show = visible;

		// Save state in localStorage
		var extraSensorVisibility = JSON.parse(localStorage.getItem("extraSensorVisibility"));
		extraSensorVisibility[sensor] = visible;
		localStorage.setItem("extraSensorVisibility", JSON.stringify(extraSensorVisibility));
	}


	/* Print statistics chart */

	function addLayerData(lastLayerTime, updateGui) {
		layerData.push([layerData.length + 1, lastLayerTime]);
		if (lastLayerTime > maxLayerTime) {
			maxLayerTime = lastLayerTime;
		}

		if (updateGui) {
			$("#td_last_layertime").html(formatTime(lastLayerTime)).addClass("layer-done-animation");
			setTimeout(function() {
				$("#td_last_layertime").removeClass("layer-done-animation");
			}, 2000);

			drawPrintChart();
		}
	}

	function drawPrintChart() {
		// Only draw the chart if it's possible
		if ($("#chart_print").width() === 0) {
			refreshPrintChart = true;
			return;
		}

		// Find absolute maximum values for the X axis
		var maxX = 25, maxPanX = 25;
		if (layerData.length < 21) {
			maxX = maxPanX = 20;
		} else if (layerData.length < 25) {
			maxX = maxPanX = layerData.length;
		} else {
			maxPanX = layerData.length;
		}
		printChartOptions.xaxis.max = maxX;
		printChartOptions.xaxis.panRange = [1, maxPanX];
		printChartOptions.xaxis.zoomRange = [25, maxPanX];

		// Find max visible value for Y axis
		var maxY = 30;
		if (layerData.length > 1) {
			var firstLayerToCheck = (layerData.length > 26) ? layerData.length - 25 : 1;
			for(var i = firstLayerToCheck; i < layerData.length; i++) {
				var layerVal = layerData[i][1] * 1.1;
				if (maxY < layerVal) {
					maxY = layerVal;
				}
			}
		}
		printChartOptions.yaxis.max = maxY;
		printChartOptions.yaxis.panRange = [0, (maxLayerTime < maxY) ? maxY : maxLayerTime];
		printChartOptions.yaxis.zoomRange = [30, (maxLayerTime < maxY) ? maxY : maxLayerTime];

		// Update chart and pan to the right
		printChart = $.plot("#chart_print", [layerData], printChartOptions);
		printChart.pan({ left: 99999 });
		refreshPrintChart = false;

		// Add hover events to chart
		$("#chart_print").unbind("plothover").bind("plothover", function (event, pos, item) {
			if (item) {
				var layer = item.datapoint[0];
				if (layer == 0) {
					layer = 1;
				}

				$("#layer_tooltip").html(T("Layer {0}: {1}", layer, formatTime(item.datapoint[1])))
					.css({top: item.pageY + 5, left: item.pageX + 5})
					.fadeIn(200);
			} else {
				$("#layer_tooltip").hide();
			}
		});
	}


	/* Common functions */

	function resizeCharts() {
		var contentHeight = $("#table_tools").height();
		if (!$("#div_heaters").hasClass("hidden")) {
			contentHeight = $("#table_heaters").height();
		} else if (!$("#div_extra").hasClass("hidden")) {
			contentHeight = $("#table_extra").height();
		}

		var statusHeight = 0;
		$("#div_status table").each(function() {
			statusHeight += $(this).outerHeight();
		});

		var max = (contentHeight > statusHeight) ? contentHeight : statusHeight;
		max -= tempChartPadding;

		if (max > 0) {
			$("#chart_temp").css("height", max);
		}

		if (refreshTempChart) {
			drawTemperatureChart();
		}
		if (refreshPrintChart) {
			drawPrintChart();
		}
	}

	$(".panel-chart").resize(function() {
		resizeCharts();
	});

	function resetChartData() {
		// Make sure the visibility state can be saved in localStorage
		var extraSensorVisibility = localStorage.getItem("extraSensorVisibility");
		if (extraSensorVisibility == null) {
			extraSensorVisibility = [];
			for(var i = 0; i < maxTempSensors; i++) {
				// Don't show any extra temperatures in the chart by default
				extraSensorVisibility.push(false);
			}
			localStorage.setItem("extraSensorVisibility", JSON.stringify(extraSensorVisibility));
		} else {
			extraSensorVisibility = JSON.parse(extraSensorVisibility);
		}

		// Reset data of the temperature chart
		recordedTemperatures = [];
		for(var i = 0; i < maxHeaters + 1; i++) {
			recordedTemperatures.push([]);
		}

		for(var i = 0; i < maxTempSensors; i++) {
			recordedTemperatures.push({
				dashes: { show: extraSensorVisibility[i] },
				lines: { show: extraSensorVisibility[i] },
				data: []
			});

			$("#table_extra tr input[type='checkbox']").eq(i).prop("checked", extraSensorVisibility[i]);
		}

		// Reset data of the layer chart
		layerData = [];
		maxLayerTime = 0;
	}
	/* Communication routines between RepRapFirmware and Duet Web Control
	 *
	 * written by Christian Hammacher (c) 2016-2017
	 *
	 * licensed under the terms of the GPL v3
	 * see http://www.gnu.org/licenses/gpl-3.0.html
	 */


	var ajaxPrefix = "";					// Host to use for AJAX requests + "?" char or empty if running on a webserver
	var defaultPassword = "reprap";			// Default password that is used when a new connection is established
	var sessionPassword = defaultPassword	// The actual password of the board
	var sessionTimeout = 8000;				// Time in ms before RepRapFirmware kills our session
	var boardType;							// Which electronics board is this?

	var isConnected = false;				// Are we connected?
	var justConnected = false;				// Have we just connected?

	var reconnectingAfterHalt = false;		// Have we just reconnected after a firmware halt?
	var resetConfirmationShown = false;		// Have we shown a prompt to send a reset code yet?

	var updateTaskLive = false;				// Are status responses being polled?
	var stopUpdating = false;				// This will be true if status updates should be no longer polled
	var extendedStatusCounter = 0;			// Counts the number of regular status updates so extended ones are polled from time to time
	var lastStatusResponse;					// Contains the last available status response (rr_status)

	var configResponse;						// Contains the last rr_config response (if any)
	var configFile;							// This is a cached copy of the machine's config.g file

	var ajaxRequests = [];					// List of all outstanding AJAX requests
	var lastSentGCode;						// The last sent G-code

	var vendor = undefined;					// For OEM functionality


	/* AJAX Events */

	$(document).ajaxSend(function(event, jqxhr, settings) {
		ajaxRequests.push(jqxhr);
	});

	$(document).ajaxComplete(function(event, jqxhr, settings) {
		ajaxRequests = $.grep(ajaxRequests, function(item) { item != jqxhr; });
	});

	$(document).ajaxError(function(event, jqxhr, xhrsettings, thrownError) {
		if (thrownError == "abort") {
			// Ignore this error if this request was cancelled intentionally
			return;
		}

		if (isConnected) {
			// Resend this request if it timed out. This may be necessary for DuetWiFi
			// Also check for empty responses, although not every browser reports an
			// error in this case. However if we get one, treat it as a timeout.
			var response = jqxhr.responseText || jqxhr.responseJSON;
			if (thrownError == "timeout" || (thrownError == "" && response == undefined)) {
				if (!xhrsettings.hasOwnProperty('retryCount')) {
					xhrsettings.retryCount = 1;
				} else {
					xhrsettings.retryCount++;
				}

				if (xhrsettings.retryCount <= settings.maxRetries) {
					$.ajax(xhrsettings);
					return;
				}
			}

			// Disconenct and report an error if we exceeded the maximum number of retries
			var msg = T("An AJAX error has been reported, so the current session has been terminated.<br/><br/>Please check if your printer is still on and try to connect again.");
			if (thrownError != undefined && thrownError != "") {
				msg += "<br/><br/>" + T("Error reason: {0}", T(thrownError.toString()));
			}
			showMessage("danger", T("Communication Error"), msg, 0);

			disconnect(false);

			// Try to log the faulty response to console
			if (response != undefined) {
				console.log("Error! The following JSON response could not be parsed:");
				console.log(response);
			}
		}
	});


	/* Connect / Disconnect */

	$("body").on("click", ".btn-connect", function() {
		if (!$(this).hasClass("disabled")) {
			if (!isConnected) {
				// Attempt to connect with the last-known password first
				connect(sessionPassword, true);
			} else {
				disconnect(true);
			}
		}
	});

	function connect(password, regularConnect) {
		if (regularConnect) {
			// Close all notifications before we connect...
			$.notifyClose();

			// If we are running on localhost, ask for a destination
			if (document.location.host == "" && ajaxPrefix == "") {
				showHostPrompt();
				return;
			}
		}

		$(".btn-connect").removeClass("btn-info").addClass("btn-warning disabled").find("span:not(.glyphicon)").text(T("Connecting..."));
		$(".btn-connect span.glyphicon").removeClass("glyphicon-log-in").addClass("glyphicon-transfer");
		$.ajax(ajaxPrefix + "rr_connect?password=" + password + "&time=" + encodeURIComponent(timeToStr(new Date())), {
			dataType: "json",
			error: function() {
				showMessage("danger", T("Error"), T("Could not establish a connection to the Duet firmware! Please check your settings and try again.") + "<div class=\"visible-xs visible-sm\"><br/><center><button id=\"btn_quick_connect\" class=\"btn btn-info btn-connect\"><span class=\"glyphicon glyphicon-log-in\"></span> Connect</button></center>", 0);

				$(".btn-connect").removeClass("btn-warning disabled").addClass("btn-info").find("span:not(.glyphicon)").text(T("Connect"));
				$(".btn-connect span.glyphicon").removeClass("glyphicon-transfer").addClass("glyphicon-log-in");

				disconnect(false);
			},
			success: function(response) {
				if (response.err == 2) {		// Looks like the firmware ran out of HTTP sessions
					showMessage("danger", T("Error"), T("Could not connect to Duet, because there are no more HTTP sessions available."), 0);
					$(".btn-connect").removeClass("btn-warning disabled").addClass("btn-info").find("span:not(.glyphicon)").text(T("Connect"));
					$(".btn-connect span.glyphicon").removeClass("glyphicon-transfer").addClass("glyphicon-log-in");
				}
				else if (regularConnect)
				{
					if (response.err == 0) {	// No password authentication required
						sessionPassword = password;
						postConnect(response);
					} else {					// We can connect, but we need a password first
						showPasswordPrompt();
					}
				}
				else {
					if (response.err == 0) {	// Connect successful
						sessionPassword = password;
						postConnect(response);
					} else {
						showMessage("danger", T("Error"), T("Invalid password!"), 0);
						$(".btn-connect").removeClass("btn-warning disabled").addClass("btn-info").find("span:not(.glyphicon)").text(T("Connect"));
						$(".btn-connect span.glyphicon").removeClass("glyphicon-transfer").addClass("glyphicon-log-in");
					}
				}
			}
		});
	}

	function postConnect(response) {
		if (response.hasOwnProperty("sessionTimeout")) {
			sessionTimeout = response.sessionTimeout;
			$.ajaxSetup({ timeout: sessionTimeout / (settings.maxRetries + 1) });
		}
		if (response.hasOwnProperty("boardType")) {
			setBoardType(response.boardType);
		}

		log("success", "<strong>" + T("Connection established!") + "</strong>");

		isConnected = justConnected = true;
		extendedStatusCounter = settings.extendedStatusInterval; // ask for extended status response on first poll

		getOemFeatures();
		updateFilaments();

		startUpdates();
		if (currentPage == "settings") {
			getConfigResponse();
		}

		$(".btn-connect").removeClass("btn-warning disabled").addClass("btn-success").find("span:not(.glyphicon)").text(T("Disconnect"));
		$(".btn-connect span.glyphicon").removeClass("glyphicon-transfer").addClass("glyphicon-log-out");

		enableControls();
		validateAddTool();
	}

	function disconnect(sendDisconnect) {
		if (isConnected) {
			log("danger", "<strong>" + T("Disconnected.") + "</strong>");
		}
		isConnected = false;
		ajaxPrefix = "";

		$(".btn-connect").removeClass("btn-success").addClass("btn-info").find("span:not(.glyphicon)").text(T("Connect"));
		$(".btn-connect span.glyphicon").removeClass("glyphicon-log-out").addClass("glyphicon-log-in");

		if (sendDisconnect) {
			$.ajax(ajaxPrefix + "rr_disconnect", { dataType: "json", global: false });
		}

		ajaxRequests.forEach(function(request) {
			request.abort();
		});
		ajaxRequests = [];
		updateTaskLive = false;

		resetGuiData();
		resetGui();
		updateGui();

		disableControls();
		validateAddTool();
		setToolMapping([]);
	}


	/* Status updates */

	function startUpdates() {
		stopUpdating = false;
		if (!updateTaskLive) {
			retryCount = 0;
			updateStatus();
		}
	}

	function stopUpdates() {
		stopUpdating = updateTaskLive;
	}

	function updateStatus() {
		if (stopUpdating) {
			updateTaskLive = false;
			return;
		}
		updateTaskLive = true;

		var machinePropsVisible = (currentPage == "settings") && $("#page_machine").hasClass("active");
		var ajaxRequest = "rr_status";
		if (extendedStatusCounter >= settings.extendedStatusInterval || machinePropsVisible && (!isPrinting || extendedStatusCounter > 1)) {
			extendedStatusCounter = 0;
			ajaxRequest += "?type=2";
		} else if (isPrinting) {
			ajaxRequest += "?type=3";
		} else {
			ajaxRequest += "?type=1";
		}
		extendedStatusCounter++;

		$.ajax(ajaxPrefix + ajaxRequest, {
			dataType: "json",
			success: function(status) {
				// Don't process this one if we're no longer connected
				if (!isConnected) {
					return;
				}
				var needGuiUpdate = false;

				/*** Extended status response ***/

				// Cold Extrusion + Retraction Temperatures
				if (status.hasOwnProperty("coldExtrudeTemp")) {
					coldExtrudeTemp = status.coldExtrudeTemp;
				}
				if (status.hasOwnProperty("coldRetractTemp")) {
					coldRetractTemp = status.coldRetractTemp;
				}

				// Temperature limit
				if (status.hasOwnProperty("tempLimit")) {
					tempLimit = status.tempLimit;
				}

				// Endstops
				if (status.hasOwnProperty("endstops")) {
					for(var i = 0; i <= maxDrives; i++) {
						var displayText;
						if ((status.endstops & (1 << i)) != 0) {
							displayText = T("Yes");
						} else {
							displayText = T("No");
						}

						$("#tr_drive_" + i + " > td:nth-child(2)").text(displayText);
					}
				}

				// Printer Geometry
				if (status.hasOwnProperty("geometry")) {
					setGeometry(status.geometry);
				}

				// Number of volumes
				if (status.hasOwnProperty("volumes")) {
					setVolumes(status.volumes);
				}

				// Bitmap of mounted volumes
				if (status.hasOwnProperty("mountedVolumes")) {
					setMountedVolumes(status.mountedVolumes);
				}

				// Machine Name
				if (status.hasOwnProperty("name")) {
					setMachineName("Printivo");
				}

				// Probe Parameters (maybe hide probe info for type 0 someday?)
				if (status.hasOwnProperty("probe")) {
					probeTriggerValue = status.probe.threshold;
					probeSlowDownValue = probeTriggerValue * 0.9;	// see Platform::Stopped in dc42/ch firmware forks

					var probeType;
					switch (status.probe.type) {
						case 0:
							probeType = T("Z Switch (0)");
							break;
						case 1:
							probeType = T("Unmodulated (1)");
							break;
						case 2:
							probeType = T("Modulated (2)");
							break;
						case 3:
							probeType = T("Alternative (3)");
							break;
						case 4:
							probeType = T("E0 Switch (4)");
							break;
						case 5:
							probeType = T("Digital Switch (5)");
							break;
						case 6:
							probeType = T("E1 Switch (6)");
							break;
						case 7:
							probeType = T("Alternative (7)");
							break;
						default:
							probeType = T("Unknown ({0})", status.probe.type);
							break;
					}
					$("#dd_probe_type").text(probeType);
					$("#dd_probe_height").text(T("{0} mm", status.probe.height));
					$("#dd_probe_value").text(probeTriggerValue);
				}

				// Tool Mapping
				if (status.hasOwnProperty("tools")) {
					needGuiUpdate |= setToolMapping(status.tools);
				}

				// Input voltage
				if (status.hasOwnProperty("vin")) {
					$(".vin").removeClass("hidden");
					$("#td_vin").html(T("{0} V", status.vin.cur.toFixed(1)));
					$("#td_vin").prop("title", T("Minimum: {0} °C Maximum: {1} °C", status.vin.min.toFixed(1), status.vin.max.toFixed(1)));
				}

				/*** Default status response ***/

				// Status
				var printing = false, paused = false;
				switch (status.status) {
					case 'F':	// Flashing new firmware
						setStatusLabel("Updating", "success");
						break;

					case 'H':	// Halted
						setStatusLabel("Halted", "danger");
						break;

					case 'D':	// Pausing / Decelerating
						setStatusLabel("Pausing", "warning");
						printing = true;
						paused = true;
						break;

					case 'S':	// Paused / Stopped
						setStatusLabel("Paused", "info");
						printing = true;
						paused = true;
						break;

					case 'R':	// Resuming
						setStatusLabel("Resuming", "warning");
						printing = true;
						paused = true;
						break;

					case 'P':	// Printing
						setStatusLabel("Printing", "success");
						printing = true;
						break;

					case 'B':	// Busy
						setStatusLabel("Busy", "warning");
						break;

					case 'T':	// Changing tool
						printing = isPrinting;
						setStatusLabel("Changing Tool", "primary");
						break;

					case 'I':	// Idle
						setStatusLabel("Idle", "default");
						break;
				}
				setPrintStatus(printing);
				setPauseStatus(paused);

				// Update file lists of the visible page after the first status response
				if (justConnected) {
					if (currentPage == "files") {
						updateGCodeFiles();
					} else if (currentPage == "control" || currentPage == "macros") {
						updateMacroFiles();
					} else if (currentPage == "filaments") {
						updateFilaments();
					} else if (currentPage == "settings" && $("#page_sysedit").is(".active")) {
						updateSysFiles();
					}

					justConnected = false;
				}

				// Set homed axes
				if (lastStatusResponse == undefined || !arraysEqual(status.coords.axesHomed, lastStatusResponse.coords.axesHomed)) {
					setAxesHomed(status.coords.axesHomed);
				}

				// Update extruder drives
				if (status.coords.extr.length != numExtruderDrives) {
					numExtruderDrives = status.coords.extr.length;
					needGuiUpdate = true;
				}

				for(var i = 1; i <= numExtruderDrives; i++) {
					$("#td_extr_" + i).html(status.coords.extr[i - 1].toFixed(1));
				}
				if (numExtruderDrives > 0) {
					$("#td_extr_total").html(status.coords.extr.reduce(function(a, b) { return a + b; }));
				} else {
					$("#td_extr_total").html(T("n/a"));
				}

				// XYZ+UVW coordinates
				if (geometry == "delta" && !status.coords.axesHomed[0]) {
					$("#td_x, #td_y, #td_z").html(T("n/a"));
					$("#btn_msgbox_x").text("X = " + T("n/a"));
					$("#btn_msgbox_y").text("Y = " + T("n/a"));
					$("#btn_msgbox_z").text("Z = " + T("n/a"));
				} else {
					$("#td_x").text(status.coords.xyz[0].toFixed(1));
					$("#td_y").text(status.coords.xyz[1].toFixed(1));
					$("#td_z").text(status.coords.xyz[2].toFixed(2));
					$("#btn_msgbox_x").text("X = " + status.coords.xyz[0].toFixed(1));
					$("#btn_msgbox_y").text("Y = " + status.coords.xyz[1].toFixed(1));
					$("#btn_msgbox_z").text("Z = " + status.coords.xyz[2].toFixed(2));
				}

				if (status.coords.xyz.length != numAxes)
				{
					numAxes = status.coords.xyz.length;
					needGuiUpdate = true;
				}
				if (numAxes > 3) {
					$("#td_u").text(numAxes > 3 ? status.coords.xyz[3].toFixed(1) : "n/a");
					$("#td_v").text(numAxes > 4 ? status.coords.xyz[4].toFixed(1) : "n/a");
					$("#td_w").text(numAxes > 5 ? status.coords.xyz[5].toFixed(1) : "n/a");
					$("#td_a").text(numAxes > 6 ? status.coords.xyz[6].toFixed(1) : "n/a");
					$("#td_b").text(numAxes > 7 ? status.coords.xyz[7].toFixed(1) : "n/a");
					$("#td_c").text(numAxes > 8 ? status.coords.xyz[8].toFixed(1) : "n/a");
				}

				// Current Tool
				if (lastStatusResponse != undefined && lastStatusResponse.currentTool != status.currentTool) {
					setCurrentTool(status.currentTool);
				}

				// Manage Tool selection on Settings -> Tools page
				if (lastStatusResponse != undefined && lastStatusResponse.currentTool != status.currentTool) {
					var btn = $("div.panel-body[data-tool='" + lastStatusResponse.currentTool + "'] > button.btn-select-tool");
					btn.attr("title", T("Select this tool"));
					btn.find("span:last-child").text(T("Select"));
					btn.find("span.glyphicon").removeClass("glyphicon-remove").addClass("glyphicon-pencil");

					btn = $("div.panel-body[data-tool='" + status.currentTool + "'] > button.btn-select-tool");
					btn.attr("title", T("Select this tool"));
					btn.find("span.glyphicon").removeClass("glyphicon-remove").addClass("glyphicon-pencil");
					btn.find("span:last-child").text(T("Deselect"));
				}

				// Output
				if (status.hasOwnProperty("output")) {
					if (status.output.hasOwnProperty("beepDuration") && status.output.hasOwnProperty("beepFrequency")) {
						beep(status.output.beepFrequency, status.output.beepDuration);
					}
					if (status.output.hasOwnProperty("message")) {
						showMessage("info", T("Message from Duet firmware"), status.output.message, settings.autoCloseUserMessages ? settings.notificationTimeout : 0);
					}
					if (status.output.hasOwnProperty("msgBox")) {
						updateMessageBox(status.output.msgBox);
					} else {
						closeMessageBox();
					}
				} else {
					closeMessageBox();
				}

				// ATX Power
				if (lastStatusResponse == undefined || status.params.atxPower != lastStatusResponse.params.atxPower) {
					setATXPower(status.params.atxPower);
				}

				// Fan Control
				if (!fanSliderActive) {
					var selectedFan = getFanSelection();
					var fanValues = (status.params.fanPercent.constructor === Array) ? status.params.fanPercent : [status.params.fanPercent];
					for(var i = 0; i < Math.min(maxFans, fanValues.length); i++) {
						// Check if the prior fan value must be enforced
						var fanValue = fanValues[i] / 100.0;
						if (overriddenFanValues[i] != undefined && overriddenFanValues[i] != fanValue) {
							fanValue = overriddenFanValues[i];
							sendGCode("M106 P" + i + " S" + fanValue);
						}

						// Update slider values
						if (i == selectedFan && (lastStatusResponse == undefined || $(".fan-slider").children("input").slider("getValue") != fanValue * 100.0)) {
							$(".fan-slider").children("input").slider("setValue", fanValue * 100.0);
						}
					}

					if (numFans != fanValues.length) {
						numFans = fanValues.length;

						var fanVisible = [settings.showFan1, settings.showFan2, settings.showFan3];
						for(var i = 0; i < maxFans; i++) {
							setFanVisibility(i, fanVisible[i] && i < numFans);
						}
					}
				}

				// Speed Factor
				if (!speedSliderActive && (lastStatusResponse == undefined || $("#slider_speed").slider("getValue") != status.params.speedFactor)) {
					$("#slider_speed").slider("setValue", status.params.speedFactor);
				}
				if (!extrSliderActive) {
					for(var i = 0; i < status.params.extrFactors.length; i++) {
						var extrSlider = $("#slider_extr_" + (i + 1));
						if (lastStatusResponse == undefined || extrSlider.slider("getValue") != status.params.extrFactors) {
							extrSlider.slider("setValue", status.params.extrFactors[i]);
						}
					}
				}

				// Babystepping
				if (status.params.hasOwnProperty("babystep")) {
					$(".babystepping button").toggleClass("disabled", settings.babysteppingZ <= 0);
					$("#span_babystepping").text(T("{0} mm", status.params.babystep));
				} else {
					// Don't enable babystepping controls if the firmware doesn't support it
					$(".babystepping button").addClass("disabled");
				}

				// Fetch the last G-Code response from the server if there is anything new and we're not flashing new firmware
				if (lastStatusResponse == undefined || (status.status != 'F' && lastStatusResponse.seq != status.seq)) {
					$.ajax(ajaxPrefix + "rr_reply", {
						dataType: "html",
						success: function(response) {
							response = response.trim();

							// Deal with firmware responses that can be parsed
							if (!isPrinting && response != "") {
								// Is this a bed compensation report?
								if (response.indexOf("Bed equation fits points ") == 0) {
									var points = response.substr("Bed equation fits points ".length);
									points = JSON.parse("[" + points.split("] [").join("],[") + "]");
									showBedCompensation(points);
								}

								// Has grid-based probing finished?
								if (response.indexOf(" points probed, mean error ") != -1) {
									getHeightmap();
								}

								// If an error is reported and we're trying to mount a volume, don't wait for it any longer
								if (mountRequested && (response.indexOf("Cannot initialise") != -1 || response.indexOf("Can't mount") != -1)) {
									mountRequested = false;
									changeGCodeVolume(currentGCodeVolume);
								}
							}
							if (lastSentGCode == "M561") {
								// We should not isplay the probe points if they are no longer valid
								clearBedPoints();
							}

							// Is this a response that should be logged?
							if ((response != "") || (lastSentGCode != "" && (settings.logSuccess || currentPage == "console"))) {
								// What kind of reply are we dealing with?
								var style = "success", content = response;
								if (response.match("^Warning: ") != null) {
									style = "warning";
									content = content.replace(/Warning:/g, "<strong>Warning:</strong>");
								} else if (response.match("^Error: ") != null) {
									style = "danger";
									content = content.replace(/Error:/g, "<strong>Error:</strong>");
								} else if (response != "") {
									style = "info";
								}

								// Prepare line breaks for HTML
								lastSentGCode = lastSentGCode.trim().replace(/\n/g, "<br/>");
								content = content.replace(/\n/g, "<br/>");

								// Log this message in the G-Code console
								var prefix = (lastSentGCode != "") ? "<strong>" + lastSentGCode + "</strong><br/>" : "";
								log(style, prefix + content);

								// If the console isn't visible, show a notification too
								if (currentPage != "console") {
									if (response == "" && lastSentGCode != "") {
										showMessage(style, "", "<strong>" + lastSentGCode + "</strong>");
									} else {
										showMessage(style, lastSentGCode, content);
									}
								}

								// Close the scanner modal dialog if an error occurred
								if (style == "danger")
								{
									$("#modal_scanner").modal("hide");
								}
							}

							// Reset info about the last sent G-Code again
							lastSentGCode = "";
						}
					});
				}

				// Sensors
				setProbeValue(status.sensors.probeValue, status.sensors.probeSecondary);
				$("#td_fanrpm").html(status.sensors.fanRPM);

				// Heated bed
				var bedTemp = undefined;
				if (status.temps.hasOwnProperty("bed")) {
					var configuredBedHeater = (status.temps.bed.hasOwnProperty("heater")) ? status.temps.bed.heater : 0;
					if (bedHeater != configuredBedHeater) {
						bedHeater = configuredBedHeater;
						needGuiUpdate = true;
						setHeatersInUse();
					}

					bedTemp = status.temps.bed.current;
					setTemperatureInput("bed", status.temps.bed.active, true, true);

					if (!status.temps.hasOwnProperty("current")) {
						setCurrentTemperature("bed", status.temps.bed.current);
						setHeaterState("bed", status.temps.bed.state, status.currentTool);
					}
				} else if (bedHeater != -1) {
					bedHeater = -1;
					needGuiUpdate = true;
				}

				// Chamber
				var chamberTemp = undefined;
				if (status.temps.hasOwnProperty("chamber")) {
					var configuredChamberHeater = (status.temps.chamber.hasOwnProperty("heater")) ? status.temps.chamber.heater : maxHeaters;
					if (chamberHeater != configuredChamberHeater)
					{
						chamberHeater = configuredChamberHeater;
						needGuiUpdate = true;
						setHeatersInUse();
					}

					chamberTemp = status.temps.chamber.current;
					setTemperatureInput("chamber", status.temps.chamber.active, true, true);

					if (!status.temps.hasOwnProperty("current")) {
						setCurrentTemperature("chamber", chamberTemp);
						setHeaterState("chamber", status.temps.chamber.state, status.currentTool);
					}
				} else if (chamberHeater != -1) {
					chamberHeater = -1;
					needGuiUpdate = true;
				}

				// Heater temperatures and states
				if (status.temps.hasOwnProperty("current") && status.temps.hasOwnProperty("state")) {
					// Set current temperatures and states
					for(var heater = 0; heater < status.temps.current.length; heater++) {
						if (heater == bedHeater) {
							setCurrentTemperature("bed", status.temps.current[heater]);
							setHeaterState("bed", status.temps.state[heater], status.currentTool);
						}
						if (heater == chamberHeater) {
							setCurrentTemperature("chamber", status.temps.current[heater]);
							setHeaterState("chamber", status.temps.state[heater], status.currentTool);
						}
						setCurrentTemperature(heater, status.temps.current[heater]);
						setHeaterState(heater, status.temps.state[heater], status.currentTool);
					}

					// Keep the temperature chart up-to-date
					recordCurrentTemperatures(status.temps.current);
				} else {
					// Heads - deprecated
					if (status.temps.heads.current.length != numHeads) {
						numHeads = status.temps.heads.current.length;
						needGuiUpdate = true;
					}

					for(var i = 0; i < status.temps.heads.current.length; i++) {
						setCurrentTemperature(i + 1, status.temps.heads.current[i]);
						setTemperatureInput(i + 1, status.temps.heads.active[i], true, !status.temps.hasOwnProperty("tools"));
						setTemperatureInput(i + 1, status.temps.heads.standby[i], false, !status.temps.hasOwnProperty("tools"));
						setHeaterState(i + 1, status.temps.heads.state[i], status.currentTool);
					}

					// Keep the temperature chart up-to-date
					recordHeadTemperatures(bedTemp, chamberTemp, status.temps.heads.current);
				}

				// Tool temperatures
				var currentToolTemps = undefined;
				if (status.temps.hasOwnProperty("tools") && toolMapping.length == status.temps.tools.active.length) {
					for(var i = 0; i < status.temps.tools.active.length; i++) {
						var toolNumber = toolMapping[i].number;
						for(var heaterIndex = 0; heaterIndex < status.temps.tools.active[i].length; heaterIndex++) {
							var heater = toolMapping[i].heaters[heaterIndex];
							setToolTemperatureInput(toolNumber, heater, status.temps.tools.active[i][heaterIndex], true);
							setToolTemperatureInput(toolNumber, heater, status.temps.tools.standby[i][heaterIndex], false);
						}
					}
				}

				// Extra temperatures
				if (status.temps.hasOwnProperty("extra")) {
					if (status.temps.extra.length != numTempSensors) {
						numTempSensors = status.temps.extra.length;
						needGuiUpdate = true;
					}

					for(var i = 0; i < status.temps.extra.length; i++) {
						if (lastStatusResponse == undefined || status.temps.extra.length != lastStatusResponse.temps.extra.length || status.temps.extra[i].name != lastStatusResponse.temps.extra[i].name) {
							var name = status.temps.extra[i].name;
							if (name == "") { name = T("Sensor " + (i + 1)); }
							$("#table_extra tr").eq(i + 1).children("th").text(name);
						}
						$("#table_extra tr").eq(i + 1).children("td:last-child").text(T("{0} °C", status.temps.extra[i].temp.toFixed(1)));
					}
					recordExtraTemperatures(status.temps.extra);
				}

				// Scanner extension
				if (status.hasOwnProperty("scanner")) {
					// Toggle visibility of scanner controls
					if (lastStatusResponse == undefined || !lastStatusResponse.hasOwnProperty("scanner")) {
						$(".scan-control").removeClass("hidden");
						$("#main_content").resize();
					}

					// Enable scan controls only if the scanner is ready
					var enableScanControls = (status.scanner.status == "I");
					if (vendor == "diabase") {
						status.coords.axesHomed.forEach(function(isHomed) {
							enableScanControls &= (isHomed > 0);
						});
					}
					$("#btn_calibrate_scanner, #btn_start_scan, #btn_shutdown_scanner").toggleClass("disabled", !enableScanControls);

					// Update scan dialogs
					updateScannerDialogs(status.scanner);

					// Reload scans as soon as a 3D scan has finished
					var lastStatus = (lastStatusResponse == undefined || lastStatusResponse.hasOwnProperty("scanner"))
										? "?" : lastStatusResponse.scanner.status;
					if (status.scanner.status == "I" && (lastStatus == "S" || lastStatus == "P" || lastStatus == "U")) {
						updateScanFiles();
					}
				} else if (lastStatusResponse != undefined && lastStatusResponse.hasOwnProperty("scanner")) {
					if (currentPage == "scanner") {
						showPage("control");
					}
					$(".scan-control").addClass("hidden");

					if ($("#modal_scanner").hasClass("in")) {
						$("#modal_scanner").modal("hide");
					}
					if ($("#modal_scanner_calibration").hasClass("in")) {
						$("#modal_scanner_calibration").modal("hide");
					}
				}

				/*** Print status response ***/

				if (status.hasOwnProperty("fractionPrinted") && fileInfo != undefined) {
					var printJustFinished = false;
					if (!printHasFinished) {
						var progress = 100, progressText = [];

						// Get the current layer progress text
						if (fileInfo.height > 0 && fileInfo.layerHeight > 0) {
							var numLayers;
							if (status.firstLayerHeight > 0) {
								numLayers = ((fileInfo.height - status.firstLayerHeight) / fileInfo.layerHeight) + 1;
							} else {
								numLayers = (fileInfo.height / fileInfo.layerHeight);
							}
							numLayers = numLayers.toFixed();
							progressText.push(T("Layer: {0} of {1}", status.currentLayer, numLayers));
						}

						// Try to calculate the progress by checking the filament usage
						if (fileInfo.filament.length > 0) {
							var totalFileFilament = (fileInfo.filament.reduce(function(a, b) { return a + b; })).toFixed(1);
							var totalRawFilament = (status.extrRaw.reduce(function(a, b) { return a + b; })).toFixed(1);
							progress = ((totalRawFilament / totalFileFilament) * 100.0).toFixed(1);

							var remainingFilament = (totalFileFilament - totalRawFilament);
							if (progress < 0) {
								progress = 0;
							} else if (progress > 100) {
								progress = 100;
								totalRawFilament = totalFileFilament;
								remainingFilament = 0;
								printJustFinished = printHasFinished = true;
							}
							progressText.push(T("Filament Usage: {0}mm of {1}mm", totalRawFilament, totalFileFilament));

							// TODO: Make this optional
							progressText[progressText.length - 1] += " " + T("({0}mm remaining)", remainingFilament.toFixed(1));

						}
						// Otherwise by comparing the current Z position to the total height
						else if (fileInfo.height > 0) {
							progress = ((status.coords.xyz[2] / fileInfo.height) * 100.0).toFixed(1);
							if (progress < 0) {
								progress = 0;
							} else if (progress > 100) {
								progress = 100;
								printJustFinished = printHasFinished = true;
							}
						}
						// Use the file-based progress as a fallback option
						else {
							progress = status.fractionPrinted;
							if (progress < 0) {
								progress = 100;
								printJustFinished = printHasFinished = true;
							}
						}

						setProgress(progress, T("Printing {0}, {1}% Complete", fileInfo.fileName, progress),
								(progressText.length > 0) ? progressText.reduce(function(a, b) { return a + ", " + b; }) : "");
					}

					// Print Chart
					if (status.currentLayer > 1) {
						var realPrintTime = (status.printDuration - status.warmUpDuration - status.firstLayerDuration);
						if (layerData.length == 0) {
							if (status.currentLayer > 2) {						// add avg values on reconnect
								addLayerData(status.firstLayerDuration, false);
								realPrintTime -= status.currentLayerTime;
								for(var layer=2; layer<status.currentLayer; layer++) {
									addLayerData(realPrintTime / (status.currentLayer - 1), false);
								}
								drawPrintChart();
							} else {											// else only the first layer is complete
								addLayerData(status.firstLayerDuration, true);
							}

							if (status.currentLayer == 2) {
								lastLayerPrintDuration = 0;
							} else {
								lastLayerPrintDuration = realPrintTime;
							}
						} else if (printJustFinished || status.currentLayer - 1 > layerData.length) {
							addLayerData(realPrintTime - lastLayerPrintDuration, true);
							lastLayerPrintDuration = realPrintTime;
						}
					}

					// Warm-Up Time
					if (status.warmUpDuration > 0) {
						if (status.warmUpDuration < 0.5) {
							$("#td_warmup_time").html(T("none"));
						} else {
							$("#td_warmup_time").html(formatTime(status.warmUpDuration));
						}
					} else if (!printHasFinished) {
						$("#td_warmup_time").html(T("n/a"));
					}

					// Current Layer Time
					if (!printHasFinished) {
						if (status.currentLayerTime > 0 || status.currentLayer > 1) {
							currentLayerTime = status.currentLayerTime;
							$("#td_layertime").html(formatTime(status.currentLayerTime));
						} else if (status.firstLayerDuration > 0) {
							currentLayerTime = status.firstLayerDuration;
							$("#td_layertime").html(formatTime(status.firstLayerDuration));
						} else {
							$("#td_layertime").html(T("n/a"));
						}
					} else {
						$("#td_layertime").html(T("n/a"));
					}

					// Print Duration
					if (status.printDuration > 0) {
						$("#td_print_duration").html(formatTime(status.printDuration));
					} else if (!printHasFinished) {
						$("#td_print_duration").html(T("n/a"));
					}

					// First Layer Height (maybe we need to update the layer height info)
					if (status.firstLayerHeight > 0 && $("#dd_layer_height").html().indexOf("/") == -1)
					{
						$("#dd_layer_height").html(T("{0} mm", status.firstLayerHeight) + " / " + $("#dd_layer_height").html());
					}

					// Print Estimations
					if (printHasFinished) {
						["filament", "layer", "file"].forEach(function(id) {
							if ($("#tl_" + id).html() != T("n/a")) {
								$("#tl_" + id).html("00s");
								$("#et_" + id).html((new Date()).toLocaleTimeString());
							}
						});
					} else {
						if (fileInfo.filament.length > 0) {
							setTimeLeft("filament", status.timesLeft.filament);
						} else {
							setTimeLeft("filament", undefined);
						}
						setTimeLeft("file", status.timesLeft.file);
						if (fileInfo.height > 0) {
							setTimeLeft("layer", status.timesLeft.layer);
						} else {
							setTimeLeft("layer", undefined);
						}
					}
				}

				// Update the GUI when we have processed the whole status response
				if (needGuiUpdate) {
					updateGui();
					setCurrentTool(status.currentTool);
				}
				drawTemperatureChart();

				// Set timer for next status update
				if (status.status == 'F') {
					isConnected = updateTaskLive = false;

					// Ideally each update path should have its own status char, OTOH this should be sufficient for the moment
					if (uploadDWCFile != undefined && uploadDWSFile == undefined && uploadFirmwareFile == undefined) {
						log("info", "<strong>" + T("Updating Duet Web Control...") + "</strong>");
						showUpdateMessage(2);

						// Ask for page reload if DWC has been updated (wireless Duets, DWC on WiFi chip)
						setTimeout(function() {
							connect(sessionPassword, false);

							if (sessionPassword != defaultPassword) {
								connect(sessionPassword, false);

								showConfirmationDialog(T("Reload Page?"), T("You have just updated Duet Web Control. Would you like to reload the page now?"), function() {
									location.reload();
								});
							} else {
								location.reload();
							}
						}, settings.dwcReconnectDelay);
					} else if (uploadDWSFile != undefined && uploadDWCFile == undefined && uploadFirmwareFile == undefined) {
						log("info", "<strong>" + T("Updating Duet WiFi Server...") + "</strong>");
						showUpdateMessage(1);
						setTimeout(function() {
							connect(sessionPassword, false);
						}, settings.dwsReconnectDelay);
					} else if (uploadFirmwareFile != undefined && uploadDWCFile == undefined && uploadDWSFile == undefined) {
						log("info", "<strong>" + T("Updating Firmware...") + "</strong>");
						showUpdateMessage(0);
						setTimeout(function() {
							connect(sessionPassword, false);
						}, settings.updateReconnectDelay);
					} else if (uploadFirmwareFile != undefined || uploadDWCFile != undefined || uploadDWSFile != undefined) {
						log("info", "<strong>" + T("Updating Firmware...") + "</strong>");

						var duration = 0;
						if (uploadDWCFile != undefined) { duration += settings.dwcReconnectDelay; }
						if (uploadDWSFile != undefined) { duration += settings.dwsReconnectDelay; }
						if (uploadFirmwareFile != undefined) { duration += settings.updateReconnectDelay; }
						showUpdateMessage(3, duration);

						// Ask for page reload if DWC has been updated (wireless Duets, DWC on WiFi chip)
						setTimeout(function() {
							if (uploadDWCFile != undefined) {
								if (sessionPassword != defaultPassword) {
									connect(sessionPassword, false);

									showConfirmationDialog(T("Reload Page?"), T("You have just updated Duet Web Control. Would you like to reload the page now?"), function() {
										location.reload();
									});
								} else {
									location.reload();
								}
							} else {
								connect(sessionPassword, false);
							}
						}, duration);
					} else {
						log("info", "<strong>" + T("Updating Firmware...") + "</strong>");
						disconnect(false);

						showMessage("warning", T("Updating Firmware..."), T("The connection has been closed because a firmware update is in progress. Please reconnect when it has finished."), 0, false);
					}
				} else if (status.status == 'H') {
					if (!reconnectingAfterHalt) {
						reconnectAfterHalt();
					} else {
						if (!resetConfirmationShown) {
							showConfirmationDialog(T("Perform firmware reset?"), T("The firmware still reports to be halted after an emergency stop. Would you like to reset your board now?"), function() {
								sendGCode("M999");
								reconnectAfterHalt();
							});
							resetConfirmationShown = true;
						}
					}
				} else {
					reconnectingAfterHalt = resetConfirmationShown = false;
					retryCount = 0;
					setTimeout(updateStatus, settings.updateInterval);
				}

				// Save the last status response
				lastStatusResponse = status;
			}
		});
	}

	function reconnectAfterHalt() {
		isConnected = updateTaskLive = false;
		showHaltMessage();
		setTimeout(function() {
			reconnectingAfterHalt = true;
			connect(sessionPassword, false);
		}, settings.haltedReconnectDelay);
	}

	function requestFileInfo() {
		$.ajax(ajaxPrefix + "rr_fileinfo", {
			dataType: "json",
			success: function(response) {
				if (isConnected && response.err == 2) {
					// The firmware is still busy parsing the file, so try again until it's ready
					setTimeout(function() {
						if (isConnected) {
							requestFileInfo();
						}
					}, 250);
				} else if (response.err == 0) {
					// File info is valid, use it
					fileInfo = response;

					$("#span_progress_left").html(T("Printing {0}", response.fileName));

					$("#dd_size").html(formatSize(response.size));
					$("#dd_height").html((response.height > 0) ? T("{0} mm", response.height) : T("n/a"));
					var layerHeight = (response.layerHeight > 0) ? T("{0} mm", response.layerHeight) : T("n/a");
					if (response.firstLayerHeight > 0) {
						$("#dd_layer_height").html(T("{0} mm", response.firstLayerHeight) + " / " + layerHeight);
					} else {
						$("#dd_layer_height").html(layerHeight);
					}

					if (response.filament.length == 0) {
						$("#dd_filament").html(T("n/a"));
					} else {
						var filament = T("{0} mm", response.filament.reduce(function(a, b) { return T("{0} mm", a) + ", " + b; }));
						$("#dd_filament").html(filament);
					}

					$("#dd_generatedby").html((response.generatedBy == "") ? T("n/a") : response.generatedBy);

					$("#td_print_duration").html(formatTime(response.printDuration));
				}
			}
		});
	}

	function getConfigResponse() {
		$.ajax(ajaxPrefix + "rr_config", {
			dataType: "json",
			success: function(response) {
				configResponse = response;

				$("#firmware_name").text(response.firmwareName);

				if (response.hasOwnProperty("firmwareElectronics")) {
					$("#tr_firmware_electronics").removeClass("hidden");
					$("#firmware_electronics").text(response.firmwareElectronics);
				}

				if (response.hasOwnProperty("dwsVersion")) {
					$("#dws_version").text(response.dwsVersion);
				}

				$("#firmware_version").text(response.firmwareVersion + " (" + response.firmwareDate + ")");

				for(var drive = 0; drive < response.accelerations.length; drive++) {
					if (drive < response.axisMins.length) {
						$("#tr_drive_" + drive + " > td:nth-child(3)").text(T("{0} mm", response.axisMins[drive]));
					}
					if (drive < response.axisMaxes.length) {
						$("#tr_drive_" + drive + " > td:nth-child(4)").text(T("{0} mm", response.axisMaxes[drive]));
					}
					$("#tr_drive_" + drive + " > td:nth-child(5)").text(T("{0} mm/s", response.minFeedrates[drive]));
					$("#tr_drive_" + drive + " > td:nth-child(6)").text(T("{0} mm/s", response.maxFeedrates[drive]));
					$("#tr_drive_" + drive + " > td:nth-child(7)").text(T("{0} mm/s²", response.accelerations[drive]));
					if (response.hasOwnProperty("currents")) {
						$("#tr_drive_" + drive + " > td:nth-child(8)").text(T("{0} mA", response.currents[drive]));
					}
				}
				if (response.hasOwnProperty("idleCurrentFactor")) {
					$("#dd_idle_current").text(response.idleCurrentFactor.toFixed(0) + "%");
				}
				if (response.hasOwnProperty("idleTimeout")) {
					var idleTimeoutText = (response.idleTimeout == 0) ? T("never") : formatTime(response.idleTimeout);
					$("#dd_idle_timeout").text(idleTimeoutText);
				}
			}
		});
	}

	// Send G-Code directly to the firmware
	function sendGCode(gcode, fromInput) {
		if (gcode == "") {
			return;
		}
		lastSentGCode = gcode;

		// Although rr_gcode gives us a JSON response, it doesn't provide any useful values for DWC.
		// We only need to worry about an AJAX error event, which is handled by the global AJAX error callback.
		$.ajax(ajaxPrefix + "rr_gcode?gcode=" + encodeURIComponent(gcode), {
			dataType: "json"
		});
	}


	// For OEM functionality
	function getOemFeatures() {
		$.ajax(ajaxPrefix + "rr_download?name=0:/sys/oem.json", {
			dataType: "json",
			global: false,
			success: function(response) {
				if (response != "" && response.hasOwnProperty("vendor")) {
					vendor = response.vendor;

					// Diabase Engineering
					if (vendor == "diabase") {
						$(".diabase").removeClass("hidden");
					}
				}
			}
		});
	}

	function resetOem() {
		$(".diabase").addClass("hidden");
	}
	/* File management logic for Duet Web Control
	 *
	 * written by Christian Hammacher (c) 2016-2017
	 *
	 * licensed under the terms of the GPL v2
	 * see http://www.gnu.org/licenses/gpl-2.0.html
	 */


	var numVolumes, mountedVolumes, mountRequested;

	var scansLoaded;

	var currentGCodeVolume, changingGCodeVolume;
	var currentGCodeDirectory, knownGCodeFiles, gcodeUpdateIndex, gcodeLastDirectory;
	var cachedFileInfo;

	var currentMacroDirectory, macroLastDirectoryRow, macroLastDirectoryItem, macrosLoaded;
	var filamentsLoaded, filamentsExist;
	var sysLoaded;

	var multiFileOperations, doingFileTask;
	var downloadNotification, zipFile;


	/* G-Code file info caching */

	function loadFileCache() {
		var cacheInfo = localStorage.getItem("cachedFileInfo");
		if (cacheInfo == null) {
			cachedFileInfo = {};
		} else {
			cachedFileInfo = JSON.parse(cacheInfo);
		}
	}

	function saveFileCache() {
		localStorage.setItem("cachedFileInfo", JSON.stringify(cachedFileInfo));
	}

	function getFileInfo(directory, filename, callback) {
		var path = directory + "/" + filename;
		var fileInfo = cachedFileInfo[path];
		if (fileInfo == undefined) {
			$.ajax(ajaxPrefix + "rr_fileinfo?name=" + encodeURIComponent(directory + "/" + filename), {
				dataType: "json",
				dir: directory,
				file: filename,
				cb: callback,
				success: function(response) {
					// Add response to cache list
					cachedFileInfo[this.dir + "/" + this.file] = response;

					// We've got it
					this.cb(this.dir, this.file, response);
				}
			});
		} else {
			// Fileinfo was queried before
			callback(directory, filename, fileInfo);
		}
	}

	function clearFileCache(filename) {
		if (filename == undefined) {
			cachedFileInfo = {};
			saveFileCache();
		} else {
			cachedFileInfo[filename] = undefined;
		}
	}

	function clearFileCacheDirectory(directory) {
		for(var path in cachedFileInfo) {
			// Delete cached file info from paths starting with the directory, but skip sub-directories
			if (path.indexOf(directory + "/") == 0 && path.substring(directory.length + 1).indexOf("/") == -1) {
				cachedFileInfo[path] = undefined;
			}
		}
	}


	/* Scans */

	$('a[href="#page_scanner"]').on('shown.bs.tab', function() {
		if (!scansLoaded) {
			updateScanFiles();
		}
	});

	$(".span-refresh-scans").click(function() {
		updateScanFiles();
		$(".span-refresh-scans").addClass("hidden");
	});

	$("#btn_calibrate_scanner").click(function() {
		if ($(this).hasClass("disabled")) {
			// Don't proceed if the button is disabled
			return;
		}

		showConfirmationDialog(T("Calibrate Scanner"), T("Before you can calibrate the 3D scanner you need to place the object in the back-right corner. Do you want to continue?"), function() {
			// Send calibration G-code to the firmware
			sendGCode("M754");
		});
	});

	$("#btn_start_scan").click(function() {
		if (!$(this).hasClass("disabled")) {
			if (vendor == "diabase") {
				// Properietary implemenation with extra steps
				$("#modal_start_scan").modal("show");
			} else {
				// Basic open-source variant
				showTextInput(T("Start new 3D scan"), T("Please enter a name for the new scan:"), function(name) {
					if (filenameValid(name)) {
						// Let the firmware do the communication to the board
						sendGCode("M752 S360 P" + name);
					} else {
						showMessage("danger", T("Error"), T("The specified filename is invalid. It may not contain quotes, colons or (back)slashes."));
					}
				}, undefined, function() {
					showMessage("danger", T("Error"), T("The filename for a new scan must not be empty!"));
				});
			}
		}
	});

	function addScanFile(filename, size, lastModified) {
		$("#page_scanner h1").addClass("hidden");
		$("#table_scan_files").removeClass("hidden");

		var row =	'<tr data-file="' + filename + '">';
		row +=		'<td><button class="btn btn-info btn-download-file btn-sm" title="' + T("Download this file") + '"><span class="glyphicon glyphicon-download-alt"></span></button></td>';
		row +=		'<td><button class="btn btn-danger btn-delete-file btn-sm" title="' + T("Delete this file") + '"><span class="glyphicon glyphicon-trash"></span></button></td>';
		row +=		'<td><a href="#" class="btn-download-file"><span class="glyphicon glyphicon-file"></span>' + filename + '</a></td>';
		row +=		'<td>' + formatSize(size) + '</td>';
		row +=		'<td>' + ((lastModified == undefined) ? T("unknown") : lastModified.toLocaleString()) + '</td>';
		row +=		'</tr>';
		$("#table_scan_files > tbody").append(row);
	}

	function updateScanFiles() {
		// Don't load anything if the scanner mode is disabled
		if ($(".scan-control").hasClass("hidden")) {
			return;
		}

		// Clear the file list
		scansLoaded = false;
		$("#table_scan_files > tbody").children().remove();
		$("#table_scan_files").addClass("hidden");
		$("#page_scanner h1").removeClass("hidden");
		if (isConnected) {
			$(".span-refresh-scans").addClass("hidden");

			// Is the macro volume mounted?
			if ((mountedVolumes & (1 << 0)) == 0) {
				$("#page_scanner h1").text(T("The current volume is not mounted"));
				return;
			}

			$("#page_scanner h1").text(T("loading"));
		} else {
			$("#page_scanner h1").text(T("Connect to your Duet to display scanned files"));
			return;
		}

		// Don't request updates while loading the file list
		stopUpdates();

		// Request filelist for /scans
		$.ajax(ajaxPrefix + "rr_filelist?dir=0:/scans", {
			dataType: "json",
			success: function(response) {
				if (isConnected) {
					if (response.hasOwnProperty("err")) {
						// don't proceed if the firmware has reported an error
						$("#page_scanner h1").text(T("Failed to retrieve files of this directory"));
					} else {
						var files = response.files.sort(function (a, b) {
							return a.name.toLowerCase().localeCompare(b.name.toLowerCase());
						});

						for(var i = 0; i < files.length; i++) {
							if (files[i].type != 'd') {
								var lastModified = files[i].hasOwnProperty("date") ? strToTime(files[i].date) : undefined;
								addScanFile(files[i].name, files[i].size, lastModified);
							}
						}

						if (files.length == 0) {
							$("#page_scanner h1").text(T("No scans found"));
						}
						scansLoaded = true;
					}

					startUpdates();
					scanUpdateFinished();
				}
			}
		});
	}

	function scanUpdateFinished() {
		if (isConnected) {
			$(".span-refresh-scans").toggleClass("hidden", currentPage != "scanner");
			startUpdates();
		} else {
			$(".span-refresh-scans").addClass("hidden");
		}
	}

	$("body").on("click", ".btn-download-file", function(e) {
		var filename = $(this).closest("tr").data("file");
		var filepath = getFilePath() + "/" + filename;

		// Should use a button link instead, but for some reason it isn't properly displayed with latest Bootstrap 3.3.7
		var elem = $('<a target="_blank" href="' + ajaxPrefix + 'rr_download?name=' + encodeURIComponent(filepath) + '" download="' + filename + '"></a>');
		elem.appendTo("body");
		elem[0].click();
		elem.remove();

		e.preventDefault();
	});

	$("body").on("click", ".btn-delete-file", function(e) {
		var row = $(this).closest("tr");
		var file = row.data("file");
		showConfirmationDialog(T("Delete File"), T("Are you sure you want to delete <strong>{0}</strong>?", file), function() {
			deletePath(file, row);
		});

		e.preventDefault();
	});


	/* G-Code Files */

	// Volume support

	function setVolumes(count) {
		if (count == numVolumes) {
			// Don't do anything unless the number has changed
			return;
		}

		$("#td_volume").toggleClass("hidden", count <= 1);
		$("#ul_volumes").children().remove();
		for(var i = 0; i < count; i++) {
			var isMounted = (mountedVolumes & (1 << i)) != 0;

			var item = 	'<li><a href="#" data-volume="' + i + '">';
			if (isMounted) {
				item +=	'<span class="glyphicon glyphicon-ok text-success"></span> ';
			} else {
				item +=	'<span class="glyphicon glyphicon-remove text-danger"></span> ';
			}
			item +=		'<span class="content">' + T("SD Card {0} ({1})", i, isMounted ? T("mounted") : T("not mounted")) + '</span>';
			item +=		'</a></li>';
			$("#ul_volumes").append(item);
		}

		numVolumes = count;
	}

	function setMountedVolumes(bitmap) {
		if (bitmap == mountedVolumes) {
			// Don't do anything unless the bitmap has changed
			return;
		}
		var oldBitmap = mountedVolumes;
		mountedVolumes = bitmap;

		if ((bitmap & (1 << 0)) != (oldBitmap & (1 << 0))) {
			// Update scanner
			updateScanFiles();

			// Update macros
			updateMacroFiles();

			// Update system files
			updateSysFiles();
		}

		for(var i = 0; i < numVolumes; i++) {
			// Update UI
			var item = $("[data-volume=" + i + "]");
			if ((bitmap & (1 << i)) != 0) {
				item.find("span.glyphicon").removeClass("glyphicon-remove text-danger").addClass("glyphicon-ok text-success");
				item.find("span.content").text(T("SD Card {0} ({1})", i, T("mounted")));
			} else {
				item.find("span.glyphicon").removeClass("glyphicon-ok text-success").addClass("glyphicon-remove text-danger");
				item.find("span.content").text(T("SD Card {0} ({1})", i, T("not mounted")));
			}

			// Check if the requested volume has been mounted
			if (mountRequested && (bitmap & (1 << i)) != (oldBitmap & (1 << i))) {
				mountRequested = false;
				changeGCodeVolume(i);
				return;
			}
		}

		// Is the current G-code volume still mounted?
		if ((bitmap & (1 << currentGCodeVolume)) == 0) {
			// No - find the first one that is mounted
			for(var i = 0; i < numVolumes; i++) {
				if ((bitmap & (1 << i)) != 0) {
					changeGCodeVolume(i);
					return;
				}
			}

			// No volume is mounted at all
			clearGCodeFiles();
		} else {
			// Has the current G-code volume been mounted again?
			if ((oldBitmap & (1 << currentGCodeVolume)) == 0) {
				// Yes - try to reload the files
				gcodeUpdateIndex = -1;
				if (currentPage == "files") {
					updateGCodeFiles();
				}
			}
		}
	}

	function changeGCodeVolume(volume) {
		currentGCodeVolume = volume;
		$("#btn_volume").removeClass("disabled");
		$("#btn_volume > span.content").text(T("SD Card {0}", volume));

		setGCodeDirectory((volume == 0) ? "0:/gcodes" : volume + ":");
		gcodeUpdateIndex = -1;
		updateGCodeFiles();
	}

	$("#ul_volumes").on("click", "a", function(e) {
		var volume = $(this).data("volume");
		if ((mountedVolumes & (1 << volume)) == 0) {
			// Volume is not mounted, try to mount it
			$("#btn_volume").addClass("disabled").children("span.content").text(T("Mounting..."));
			sendGCode("M21 P" + volume);
			mountRequested = true;
		} else {
			// Volume is mounted, change it
			changeGCodeVolume(volume);
		}

		e.preventDefault();
	});


	// File list implementation

	$(".span-refresh-files").click(function() {
		clearFileCacheDirectory(currentGCodeDirectory);
		gcodeUpdateIndex = -1;
		updateGCodeFiles();
		$(".span-refresh-files").addClass("hidden");
	});

	$("body").on("click", "#ol_gcode_directory a", function(e) {
		setGCodeDirectory($(this).data("directory"));
		gcodeUpdateIndex = -1;
		updateGCodeFiles();
		e.preventDefault();
	});

	$("#btn_new_gcode_directory").click(function() {
		showTextInput(T("New directory"), T("Please enter a name:"), function(value) {
			if (filenameValid(value)) {
				$.ajax(ajaxPrefix + "rr_mkdir?dir=" + encodeURIComponent(currentGCodeDirectory + "/" + value), {
					dataType: "json",
					success: function(response) {
						if (response.err == 0) {
							gcodeUpdateIndex = -1;
							updateGCodeFiles();
						} else {
							showMessage("warning", T("Error"), T("Could not create this directory!"));
						}
					}
				});
			} else {
				showMessage("danger", T("Error"), T("The specified filename is invalid. It may not contain quotes, colons or (back)slashes."));
			}
		});
	});

	function setGCodeDirectory(directory) {
		currentGCodeDirectory = directory;
		var basePath = (currentGCodeVolume == 0) ? "0:/gcodes" : currentGCodeVolume + ":";
		var baseCaption = (currentGCodeVolume == 0) ? T("G-Codes Directory") : T("Root Directory");

		$("#ol_gcode_directory > li.content:not(:first-child)").remove();
		if (directory == basePath) {
			$("#ol_gcode_directory > li.content").replaceWith('<li class="active content"><span class="glyphicon glyphicon-folder-open"></span> ' + baseCaption + '</li>');
			$("#ol_gcode_directory > li:last-child").html('<span class="glyphicon glyphicon-level-up"></span> ' + T("Go Up"));
		} else {
			var listContent = '<li class="content"><a href="#" data-directory="' + basePath + '"><span class="glyphicon glyphicon-folder-open"></span> ' + baseCaption + '</a></li>';
			var directoryItems = directory.split("/"), directoryPath = basePath;
			for(var i = (currentGCodeVolume == 0) ? 2 : 1; i < directoryItems.length - 1; i++) {
				directoryPath += "/" + directoryItems[i];
				listContent += '<li class="active content"><a href="#" data-directory="' + directoryPath + '">' + directoryItems[i] + '</a></li>';
			}
			listContent += '<li class="active content">' + directoryItems[directoryItems.length -1] + '</li>';
			$("#ol_gcode_directory > li.content").replaceWith(listContent);
			$("#ol_gcode_directory > li:last-child").html('<a href="#" data-directory="' + directoryPath + '"><span class="glyphicon glyphicon-level-up"></span> ' + T("Go Up") + '</a>');
		}
	}

	function clearGCodeDirectory() {
		var baseCaption = (currentGCodeVolume == 0) ? T("G-Codes Directory") : T("Root Directory");
		$("#ol_gcode_directory > li.content:not(:first-child)").remove();
		$("#ol_gcode_directory > li.content").replaceWith('<li class="active content"><span class="glyphicon glyphicon-folder-open"></span> ' + baseCaption + '</li>');
	}

	function addGCodeFile(filename, size, lastModified) {
		$("#page_files h1").addClass("hidden");
		$("#table_gcode_files").removeClass("hidden");

		var title = (lastModified == undefined) ? "" : (' title="' + T("Last modified on {0}", lastModified.toLocaleString()) + '"');
		var lastModifiedValue = (lastModified == undefined) ? 0 : lastModified.getTime();
		var row =	'<tr draggable="true" data-file="' + filename + '"' + title + ' data-size="' + size + '" data-last-modified="' + lastModifiedValue + '">';
		row +=		'<td><input type="checkbox"></td>';
		row +=		'<td><span class="glyphicon glyphicon-asterisk"></span> ' + filename + '</td>';
		row +=		'<td class="hidden-xs">' + formatSize(size) + '</td>';
		row +=		'<td class="object-height">' + T("loading") + '</td>';
		row +=		'<td class="layer-height">' + T("loading") + '</td>';
		row +=		'<td class="hidden-xs filament-usage">' + T("loading") + '</td>';
		row +=		'<td class="hidden-xs hidden-sm generated-by">' + T("loading") + '</td>';
		row +=		'</tr>';
		return $(row).appendTo("#table_gcode_files > tbody");
	}

	function addGCodeDirectory(name) {
		$("#page_files h1").addClass("hidden");
		$("#table_gcode_files").removeClass("hidden");

		var row =	'<tr draggable="true" data-directory="' + name + '">';
		row +=		'<td><input type="checkbox"></td>';
		row +=		'<td colspan="6"><a href="#" class="a-gcode-directory"><span class="glyphicon glyphicon-folder-open"></span> ' + name + '</a></td>';
		row +=		'</tr>';

		var rowElem = $(row);
		rowElem[0].addEventListener("dragstart", fileDragStart, false);
		rowElem[0].addEventListener("dragend", fileDragEnd, false);

		if (gcodeLastDirectory == undefined) {
			var firstRow = $("#table_gcode_files > tbody > tr:first-child");
			if (firstRow.length == 0) {
				$("#table_gcode_files > tbody").append(rowElem);
			} else {
				rowElem.insertBefore(firstRow);
			}
		} else {
			rowElem.insertAfter(gcodeLastDirectory);
		}
		gcodeLastDirectory = rowElem;
	}

	function setGCodeFileItem(row, height, firstLayerHeight, layerHeight, filamentUsage, generatedBy) {
		// Make entry interactive and link the missing data attributes to it
		var linkCell = row.children().eq(1);
		linkCell.find("span").removeClass("glyphicon-asterisk").addClass("glyphicon-file");
		linkCell.html('<a href="#" class="a-gcode-file">' + linkCell.html() + '</a>');
		row.data("height", height);
		row.data("first-layer-height", firstLayerHeight);
		row.data("layer-height", layerHeight);
		row.data("filament-usage", filamentUsage);
		row.data("generated-by", generatedBy);

		// Add drag&drop handlers
		row[0].addEventListener("dragstart", fileDragStart, false);
		row[0].addEventListener("dragend", fileDragEnd, false);

		// Set object height
		row.find(".object-height").text((height > 0) ? T("{0} mm", height) : T("n/a"));

		// Set layer height
		if (layerHeight > 0) {
			var lhText = (firstLayerHeight == undefined) ? (T("{0} mm", layerHeight)) : (firstLayerHeight + " / " + T("{0} mm", layerHeight));
			row.find(".layer-height").text(lhText);
		} else {
			row.find(".layer-height").text(T("n/a"));
		}

		// Set filament usage
		if (filamentUsage.length > 0) {
			var totalUsage = filamentUsage.reduce(function(a, b) { return a + b; }).toFixed(1) + " mm";
			if (filamentUsage.length == 1) {
				row.find(".filament-usage").text(totalUsage);
			} else {
				var individualUsage = T("{0} mm", filamentUsage.reduce(function(a, b) { return T("{0} mm", a) + ", " + b; }));
				var filaUsage = "<abbr class=\"filament-usage\" title=\"" + individualUsage + "\">" + totalUsage + "</abbr>";
				row.find(".filament-usage").html(filaUsage);
			}
		} else {
			row.find(".filament-usage").text(T("n/a"));
		}

		// Set slicer
		row.find(".generated-by").text((generatedBy != "") ? generatedBy : T("n/a"));
	}

	function clearGCodeFiles() {
		gcodeLastDirectory = undefined;

		$("#table_gcode_files > thead input[type='checkbox']:first-child").prop("checked", false);
		$("#table_gcode_files > tbody").children().remove();
		$("#table_gcode_files").addClass("hidden");
		$("#page_files h1").removeClass("hidden");
		if (isConnected) {
			if ((mountedVolumes & (1 << currentGCodeVolume)) == 0) {
				$("#page_files h1").text(T("The current volume is not mounted"));
			} else {
				$("#page_files h1").text(T("loading"));
			}
		} else {
			$("#page_files h1").text(T("Connect to your Duet to display G-Code files"));
		}
	}

	function updateGCodeFiles() {
		if (!isConnected) {
			gcodeUpdateIndex = -1;
			gcodeUpdateFinished();

			clearGCodeDirectory();
			clearGCodeFiles();
			return;
		}

		if (gcodeUpdateIndex == -1) {
			// Is the current volume mounted?
			if ((mountedVolumes & (1 << currentGCodeVolume)) == 0) {
				// No - stop here
				clearGCodeFiles();
				return;
			}

			// Yes - fetch the filelist for the current directory and proceed
			stopUpdates();
			gcodeUpdateIndex = 0;
			gcodeLastDirectory = undefined;
			clearGCodeFiles();

			$.ajax(ajaxPrefix + "rr_filelist?dir=" + encodeURIComponent(currentGCodeDirectory), {
				dataType: "json",
				success: function(response) {
					if (isConnected) {
						if (response.hasOwnProperty("err")) {
							// don't proceed if the firmware has reported an error
							$("#page_files h1").text(T("Failed to retrieve files of this directory"));

							gcodeUpdateIndex = -1;
							gcodeUpdateFinished();
						} else {
							// otherwise add each file and directory
							knownGCodeFiles = response.files;
							for(var i = 0; i < knownGCodeFiles.length; i++) {
								if (knownGCodeFiles[i].type == 'd') {
									addGCodeDirectory(knownGCodeFiles[i].name);
								} else {
									var lastModified = knownGCodeFiles[i].hasOwnProperty("date") ? strToTime(knownGCodeFiles[i].date) : undefined;
									addGCodeFile(knownGCodeFiles[i].name, knownGCodeFiles[i].size, lastModified);
								}
							}

							if (knownGCodeFiles.length == 0) {
								$("#page_files h1").text(T("No Files or Directories found"));
								gcodeUpdateFinished();
							} else {
								$("#table_gcode_files").css("cursor", "wait");
								updateGCodeFiles();
							}
						}
					}
				}
			});
		} else if (gcodeUpdateIndex < knownGCodeFiles.length) {
			if (knownGCodeFiles[gcodeUpdateIndex].type == 'd') {
				gcodeUpdateIndex++;
				if (gcodeUpdateIndex >= knownGCodeFiles.length) {
					gcodeUpdateFinished();
				} else {
					updateGCodeFiles();
				}
			} else {
				getFileInfo(currentGCodeDirectory, knownGCodeFiles[gcodeUpdateIndex].name, function(dir, filename, fileinfo) {
					if (!isConnected || dir != currentGCodeDirectory) {
						return;
					}
					gcodeUpdateIndex++;

					var row = $('#table_gcode_files > tbody > tr[data-file="' + filename + '"]');
					if (fileinfo.err == 0) {
						setGCodeFileItem(row, fileinfo.height, fileinfo.firstLayerHeight, fileinfo.layerHeight, fileinfo.filament, fileinfo.generatedBy);
					} else {
						setGCodeFileItem(row, 0, 0, [], "");
					}

					if (currentPage == "files") {
						saveFileCache();
						if (gcodeUpdateIndex >= knownGCodeFiles.length) {
							gcodeUpdateFinished();
						} else {
							updateGCodeFiles();
						}
					} else {
						// Although wired Duets can handle fileinfo requests in parallel, DuetWiFiServer cannot do that yet
						startUpdates();
					}
				});
			}
		}
	}

	function gcodeUpdateFinished() {
		var table = $("#table_gcode_files").css("cursor", "");
		sortTable(table);

		if (isConnected) {
			$(".span-refresh-files").toggleClass("hidden", currentPage != "files");
			startUpdates();
		} else {
			$(".span-refresh-files").addClass("hidden");
		}
	}

	$("body").on("click", ".a-gcode-directory", function(e) {
		setGCodeDirectory(currentGCodeDirectory + "/" + $(this).closest("tr").data("directory"));
		gcodeUpdateIndex = -1;
		updateGCodeFiles();
		e.preventDefault();
	});

	$("body").on("click", ".a-gcode-file", function(e) {
		var file = $(this).closest("tr").data("file");
		showConfirmationDialog(T("Start Print"), T("Do you want to print <strong>{0}</strong>?", file), function() {
			waitingForPrintStart = true;
			if (currentGCodeVolume != 0) {
				sendGCode("M32 " + currentGCodeDirectory + "/" + file);
			} else if (currentGCodeDirectory == "0:/gcodes") {
				sendGCode("M32 " + file);
			} else {
				sendGCode("M32 " + currentGCodeDirectory.substring(10) + "/" + file);
			}
		});
		e.preventDefault();
	});


	/* Macros */

	$(".span-refresh-macros").click(function() {
		updateMacroFiles();
		$(".span-refresh-macros").addClass("hidden");
	});

	$("body").on("click", "#ol_macro_directory a", function(e) {
		setMacroDirectory($(this).data("directory"));
		updateMacroFiles();
		e.preventDefault();
	});

	function clearMacroDirectory() {
		$("#ol_macro_directory").children(":not(:last-child)").remove();
		$("#ol_macro_directory").prepend('<li class="active"><span class="glyphicon glyphicon-folder-open"></span> ' + T("Macros Directory") + '</li>');
	}

	function setMacroDirectory(directory) {
		currentMacroDirectory = directory;

		$("#ol_macro_directory").children(":not(:last-child)").remove();
		if (directory == "0:/macros") {
			$("#ol_macro_directory").prepend('<li class="active"><span class="glyphicon glyphicon-folder-open"></span> ' + T("Macros Directory") + '</li>');
			$("#ol_macro_directory li:last-child").html('<span class="glyphicon glyphicon-level-up"></span> ' + T("Go Up"));
		} else {
			var listContent = '<li><a href="#" data-directory="0:/macros"><span class="glyphicon glyphicon-folder-open"></span> ' + T("Macros Directory") + '</a></li>';
			var directoryItems = directory.split("/"), directoryPath = "0:/macros";
			for(var i = 2; i < directoryItems.length - 1; i++) {
				directoryPath += "/" + directoryItems[i];
				listContent += '<li class="active"><a href="#" data-directory="' + directoryPath + '">' + directoryItems[i] + '</a></li>';
			}
			listContent += '<li class="active">' + directoryItems[directoryItems.length -1] + '</li>';
			$("#ol_macro_directory").prepend(listContent);
			$("#ol_macro_directory li:last-child").html('<a href="#" data-directory="' + directoryPath + '"><span class="glyphicon glyphicon-level-up"></span> ' + T("Go Up") + '</a>');
		}
	}

	$("#a_new_macro_directory").click(function(e) {
		showTextInput(T("New directory"), T("Please enter a name:"), function(value) {
			if (filenameValid(value)) {
				$.ajax(ajaxPrefix + "rr_mkdir?dir=" + currentMacroDirectory + "/" + value, {
					dataType: "json",
					success: function(response) {
						if (response.err == 0) {
							updateMacroFiles();
						} else {
							showMessage("warning", T("Error"), T("Could not create this directory!"));
						}
					}
				});
			} else {
				showMessage("danger", T("Error"), T("The specified filename is invalid. It may not contain quotes, colons or (back)slashes."));
			}
		});
		e.preventDefault();
	});

	$("#a_new_macro_file").click(function(e) {
		showTextInput(T("New macro"), T("Please enter a filename:"), function(file) {
			if (filenameValid(file)) {
				showEditDialog(currentMacroDirectory + "/" + file, "", function(value) {
					uploadTextFile(currentMacroDirectory + "/" + file, value, updateMacroFiles);
				});
			} else {
				showMessage("danger", T("Error"), T("The specified filename is invalid. It may not contain quotes, colons or (back)slashes."));
			}
		});
		e.preventDefault();
	});

	function stripMacroFilename(filename) {
		var label = filename;

		// Remove G-code file ending from name
		var match = filename.match(/(.*)\.(g|gc|gcode)$/i);
		if (match != null) {
			label = match[1];
		}

		// Users may want to index their macros, so remove starting numbers
		match = label.match(/^\d+_(.*)/);
		if (match != null) {
			label = match[1];
		}

		return label;
	}

	function addMacroFile(filename, size, lastModified) {
		// Control Page
		if (currentMacroDirectory == "0:/macros") {
			var macroButton =	'<div class="btn-group">';
			macroButton +=		'<button class="btn btn-default btn-macro btn-sm" data-macro="0:/macros/' + filename + '">' +  stripMacroFilename(filename) + '</button>';
			macroButton +=		'</div>';

			$("#panel_macro_buttons h4").addClass("hidden");
			$("#panel_macro_buttons .btn-group-vertical").append(macroButton);
		}

		// Macro Page
		$("#page_macros h1").addClass("hidden");
		$("#table_macro_files").removeClass("hidden");

		var lastModifiedValue = (lastModified == undefined) ? 0 : lastModified.getTime();
		var row =	'<tr draggable="true" data-file="' + filename + '" data-size="' + size + '" data-last-modified="' + lastModifiedValue + '">';
		row +=		'<td><input type="checkbox"></td>';
		row +=		'<td><a href="#" class="a-macro-file"><span class="glyphicon glyphicon-file"></span> ' + filename + '</a></td>';
		row +=		'<td>' + formatSize(size) + '</td>';
		row +=		'<td>' + ((lastModified == undefined) ? T("unknown") : lastModified.toLocaleString()) + '</td>';
		row +=		'</tr>\n';

		var rowElem = $(row);
		rowElem[0].addEventListener("dragstart", fileDragStart, false);
		rowElem[0].addEventListener("dragend", fileDragEnd, false);
		rowElem.appendTo("#table_macro_files > tbody");
	}

	function addMacroDirectory(name) {
		// Control Page
		if (currentMacroDirectory == "0:/macros") {
			$("#panel_macro_buttons h4").addClass("hidden");

			var button =	'<div class="btn-group">';
			button +=		'<button class="btn btn-info btn-macro btn-sm" data-directory="0:/macros/' + name + '" data-toggle="dropdown">' + name + ' <span class="caret"></span></button>';
			button +=		'<ul class="dropdown-menu"></ul>';
			button +=		'</div>';

			var buttonElem = $(button);
			if (macroLastDirectoryItem == undefined) {
				var firstButton = $("#panel_macro_buttons .btn-group-vertical > div:first-child");
				if (firstButton.length == 0) {
					$("#panel_macro_buttons .btn-group-vertical").append(buttonElem);
				} else {
					buttonElem.insertBefore(firstButton);
				}
			} else {
				buttonElem.insertAfter(macroLastDirectoryItem);
			}
			macroLastDirectoryItem = buttonElem;
		}

		// Macro Page
		$("#page_macros h1").addClass("hidden");
		$("#table_macro_files").removeClass("hidden");

		var row =	'<tr draggable="true" data-directory="' + name + '">';
		row +=		'<td><input type="checkbox"></td>';
		row +=		'<td colspan="3"><a href="#" class="a-macro-directory"><span class="glyphicon glyphicon-folder-open"></span> ' + name + '</a></td>';
		row +=		'<td class="hidden"></td>';
		row +=		'<td class="hidden"></td>';
		row +=		'</tr>\n';

		var rowElem = $(row);
		rowElem[0].addEventListener("dragstart", fileDragStart, false);
		rowElem[0].addEventListener("dragend", fileDragEnd, false);

		if (macroLastDirectoryRow == undefined) {
			var firstRow = $("#table_macro_files > tbody > tr:first-child");
			if (firstRow.length == 0) {
				$("#table_macro_files > tbody").append(rowElem);
			} else {
				rowElem.insertBefore(firstRow);
			}
		} else {
			rowElem.insertAfter(macroLastDirectoryRow);
		}
		macroLastDirectoryRow = rowElem;
	}

	function updateMacroFiles() {
		clearMacroFiles();
		if (!isConnected) {
			$(".span-refresh-macros").addClass("hidden");
			return;
		}

		// Is the macro volume mounted?
		if ((mountedVolumes & (1 << 0)) == 0) {
			// No - stop here
			clearMacroFiles();
			return;
		}

		// Yes - fetch the filelist for the current directory and proceed
		stopUpdates();

		$.ajax(ajaxPrefix + "rr_filelist?dir=" + encodeURIComponent(currentMacroDirectory), {
			dataType: "json",
			success: function(response) {
				if (isConnected) {
					if (response.hasOwnProperty("err")) {
						// don't proceed if the firmware has reported an error
						$("#page_macros h1").text(T("Failed to retrieve files of this directory"));
						if (currentMacroDirectory == "0:/macros") {
							$("#panel_macro_buttons h4").text(T("Failed to retrieve files of this directory"));
						}
					} else {
						// Sort the macros by name when we get the response, because we
						// may need to use the sorted array on the Control page
						var files = response.files.sort(function (a, b) {
							return a.name.toLowerCase().localeCompare(b.name.toLowerCase());
						});

						for(var i = 0; i < files.length; i++) {
							if (files[i].type == 'd') {
								addMacroDirectory(files[i].name);
							} else {
								var lastModified = files[i].hasOwnProperty("date") ? strToTime(files[i].date) : undefined;
								addMacroFile(files[i].name, files[i].size, lastModified);
							}
						}

						if (files.length == 0) {
							$("#page_macros h1").text(T("No Macro Files found"));
						} else {
							sortTable($("#table_macro_files"));
						}

						if (currentPage == "macros") {
							$(".span-refresh-macros").removeClass("hidden");
						}
						macrosLoaded = true;
					}

					startUpdates();
				}
			}
		});
	}

	function clearMacroFiles() {
		// Control Page
		if (currentMacroDirectory == "0:/macros") {
			macroLastDirectoryItem = undefined;

			$("#panel_macro_buttons .btn-group-vertical").children().remove();
			if (!isConnected) {
				$("#panel_macro_buttons h4").text(T("Connect to your Duet to display Macro files"));
			} else if ((mountedVolumes & (1 << 0)) == 0) {
				$("#panel_macro_buttons h4").text(T("The first volume is not mounted"));
			} else {
				$("#panel_macro_buttons h4").text(T("Go to the Macros page to define your own actions"));
			}
			$("#panel_macro_buttons h4").removeClass("hidden");
		}

		// Macros Page
		macrosLoaded = false;
		macroLastDirectoryRow = undefined;

		$("#table_macro_files > thead input[type='checkbox']:first-child").prop("checked", false);
		$("#table_macro_files > tbody").children().remove();
		$("#table_macro_files").addClass("hidden");
		$("#page_macros h1").removeClass("hidden");
		if (isConnected) {
			if ((mountedVolumes & (1 << 0)) == 0) {
				$("#page_macros h1").text(T("The first volume is not mounted"));
			} else {
				$("#page_macros h1").text(T("loading"));
			}
		} else {
			$("#page_macros h1").text(T("Connect to your Duet to display Macro files"));
		}
	}

	$("body").on("click", ".btn-macro", function(e) {
		var directory = $(this).data("directory");
		if (directory != undefined) {
			var dropdown = $(this).parent().children("ul");
			dropdown.css("width", $(this).outerWidth());
			loadMacroDropdown(directory, dropdown);
			dropdown.dropdown();
		} else {
			sendGCode("M98 P" + $(this).data("macro"));
		}
		e.preventDefault();
	});

	function loadMacroDropdown(directory, dropdown) {
		$.ajax(ajaxPrefix + "rr_filelist?dir=" + encodeURIComponent(directory), {
			dataType: "json",
			directory: directory,
			dropdown: dropdown,
			success: function(response) {
				if (response.hasOwnProperty("err")) {
					dropdown.html('<li><a href="#" class="disabled" style="color:#777;">' + T("Failed to retrieve files of this directory") + '</a></li>');
				} else if (response.files.length == 0) {
					dropdown.html('<li><a href="#" class="disabled" style="color:#777;">' + T("No files found!") + '</a></li>');
				} else {
					dropdown.html('<li><a href="#" class="disabled" style="color:#777;">' + directory + '</a></li><li class="divider"></li>');
					var files = response.files.sort(function (a, b) {
						return a.name.toLowerCase().localeCompare(b.name.toLowerCase());
					});

					files.forEach(function(file) {
						if (file.type == 'd') {
							var item = $('<li class="bg-info"><a href="#" data-directory="' + directory + '/' + file.name + '">' + file.name + ' <span class="caret"></span></a></li>');
							item.find("a").click(function(e) {
								loadMacroDropdown($(this).data("directory"), $(this).closest("ul"));
								e.stopPropagation();
								e.preventDefault();
							});
							dropdown.append(item);
						} else {
							var item = $('<li><a href="#" data-macro="' + directory + '/' + file.name + '">' + stripMacroFilename(file.name) + '</a></li>');
							item.find("a").click(function(e) {
								sendGCode("M98 P" + $(this).data("macro"));
								e.preventDefault();
							});
							dropdown.append(item);
						}
					});
				}
			}
		});
	}

	$("body").on("click", ".a-macro-directory", function(e) {
		setMacroDirectory(currentMacroDirectory + "/" + $(this).closest("tr").data("directory"));
		updateMacroFiles();
		e.preventDefault();
	});

	$("body").on("click", ".a-macro-file", function(e) {
		var file = $(this).closest("tr").data("file");
		showConfirmationDialog(T("Run Macro"), T("Do you want to run <strong>{0}</strong>?", file), function() {
			sendGCode("M98 P" + currentMacroDirectory + "/" + file);
		});
		e.preventDefault();
	});


	/* Filaments */

	$(".span-refresh-filaments").click(function() {
		updateFilaments();
		$(".span-refresh-filaments").addClass("hidden");
	});

	$("#btn_new_filament").click(function() {
		showTextInput(T("New filament"), T("Please enter a name:"), function(value) {
			if (filenameValid(value)) {
				if (filamentsExist) {
					$.ajax(ajaxPrefix + "rr_mkdir?dir=" + encodeURIComponent("0:/filaments/" + value), {
						dataType: "json",
						success: function(response) {
							if (response.err == 0) {
								uploadTextFile("0:/filaments/" + value + "/load.g", "", undefined, false);
								uploadTextFile("0:/filaments/" + value + "/unload.g", "", undefined, false);
								updateFilaments();
							} else {
								showMessage("warning", T("Error"), T("Could not create this directory!"));
							}
						}
					});
				} else {
					$.ajax(ajaxPrefix + "rr_mkdir?dir=0:/filaments", {
						dataType: "json",
						success: function(response) {
							if (response.err == 0) {
								$.ajax(ajaxPrefix + "rr_mkdir?dir=" + encodeURIComponent("0:/filaments/" + value), {
									dataType: "json",
									success: function(response) {
										if (response.err == 0) {
											uploadTextFile("0:/filaments/" + value + "/load.g", "", undefined, false);
											uploadTextFile("0:/filaments/" + value + "/unload.g", "", undefined, false);
											updateFilaments();
										} else {
											showMessage("warning", T("Error"), T("Could not create this directory!"));
										}
									}
								});
							}
						}
					});
				}
			} else {
				showMessage("danger", T("Error"), T("The specified filename is invalid. It may not contain quotes, colons or (back)slashes."));
			}
		});
	});

	function updateFilaments() {
		clearFilaments();
		if (!isConnected) {
			$(".span-refresh-filaments").addClass("hidden");
			return;
		}

		// Is the macro volume mounted?
		if ((mountedVolumes & (1 << 0)) == 0) {
			// No - stop here
			clearFilaments();
			return;
		}

		// Yes - fetch the filelist for the current directory and proceed
		stopUpdates();

		$.ajax(ajaxPrefix + "rr_filelist?dir=0:/filaments", {
			dataType: "json",
			success: function(response) {
				if (isConnected) {
					if (response.hasOwnProperty("err")) {
						// don't proceed if the firmware has reported an error
						filamentsExist = false;
						$("#page_filaments h1").text(T("Failed to retrieve Filaments"));
					} else {
						var files = response.files, filamentsAdded = 0;
						for(var i = 0; i < files.length; i++) {
							if (files[i].type == 'd') {
								var dateCreated = files[i].hasOwnProperty("date") ? strToTime(files[i].date) : undefined;
								addFilament(files[i].name, dateCreated);
								filamentsAdded++;
							}
						}

						if (filamentsAdded == 0) {
							$("#page_filaments h1").text(T("No Filaments found"));
						} else {
							sortTable($("#table_filaments"));
						}

						if (currentPage == "filaments") {
							$(".span-refresh-filaments").removeClass("hidden");
						}
						filamentsLoaded = true;
						filamentsExist = true;
					}

					startUpdates();
				}
			}
		});
	}

	function addFilament(name, dateCreated) {
		$("#page_filaments h1").addClass("hidden");
		$("#table_filaments").removeClass("hidden");

		var dateCreatedValue = (dateCreated == undefined) ? 0 : dateCreated.getTime();
		var row =	'<tr data-filament="' + name + '" data-date-created="' + dateCreatedValue + '">';
		row +=		'<td><input type="checkbox"></td>';
		row +=		'<td><a href="#" class="a-filament"><span class="glyphicon glyphicon-cd"></span> ' + name + '</a></td>';
		row +=		'<td>' + ((dateCreated == undefined) ? T("unknown") : dateCreated.toLocaleString()) + '</td>';
		row +=		'</tr>';
		$("#table_filaments > tbody").append(row);
	}

	function clearFilaments() {
		filamentsLoaded = false;
		filamentsExist = false;

		$("#table_filaments > thead input[type='checkbox']:first-child").prop("checked", false);
		$("#table_filaments > tbody").children().remove();
		$("#table_filaments").addClass("hidden");
		$("#page_filaments h1").removeClass("hidden");
		if (isConnected) {
			if ((mountedVolumes & (1 << 0)) == 0) {
				$("#page_filaments h1").text(T("The first volume is not mounted"));
			} else {
				$("#page_filaments h1").text(T("loading"));
			}
		} else {
			$("#page_filaments h1").text(T("Connect to your Duet to display Filaments"));
		}
	}

	$("#table_filaments > tbody").on("click", ".a-filament", function(e) {
		e.preventDefault();
	});


	/* System Editor */

	$('a[href="#page_sysedit"]').on('shown.bs.tab', function() {
		if (!sysLoaded) {
			updateSysFiles();
		}
	});

	$("#a_new_sys_file").click(function() {
		showTextInput(T("New File"), T("Please enter a filename:"), function(file) {
			if (filenameValid(file)) {
				showEditDialog("0:/sys/" + file, "", function(value) {
					uploadTextFile("0:/sys/" + file, value, updateSysFiles);
				});
			} else {
				showMessage("danger", T("Error"), T("The specified filename is invalid. It may not contain quotes, colons or (back)slashes."));
			}
		});
	});

	$("#a_refresh_sys").click(function(e) {
		updateSysFiles();
		e.preventDefault();
	});

	function addSysFile(filename, size, lastModified) {
		$("#page_sysedit h1").addClass("hidden");
		$("#table_sys_files").removeClass("hidden");

		var lastModifiedValue = (lastModified == undefined) ? 0 : lastModified.getTime();
		var row =	'<tr data-file="' + filename + '" data-size="' + size + '" data-last-modified="' + lastModifiedValue + '">';
		row +=		'<td><input type="checkbox"></td>';
		row +=		'<td><a href="#"><span class="glyphicon glyphicon-file"></span> ' + filename + '</a></td>';
		row +=		'<td>' + formatSize(size) + '</td>';
		row +=		'<td>' + ((lastModified == undefined) ? T("unknown") : lastModified.toLocaleString()) + '</td>';
		row +=		'</tr>';
		$("#table_sys_files > tbody").append(row);
	}

	function updateSysFiles() {
		// Clear the file list
		sysLoaded = false;
		$("#table_sys_files > tbody").children().remove();
		$("#table_sys_files").addClass("hidden");
		$("#page_sysedit h1").removeClass("hidden");
		if (isConnected) {
			$("#a_refresh_sys").addClass("hidden");

			// Is the macro volume mounted?
			if ((mountedVolumes & (1 << 0)) == 0) {
				$("#page_sysedit h1").text(T("The current volume is not mounted"));
				return;
			}

			$("#page_sysedit h1").text(T("loading"));
		} else {
			$("#page_sysedit h1").text(T("Connect to your Duet to display System files"));
			return;
		}

		// Don't request updates while loading the file list
		stopUpdates();

		// Request filelist for /sys
		$.ajax(ajaxPrefix + "rr_filelist?dir=0:/sys", {
			dataType: "json",
			success: function(response) {
				if (isConnected) {
					if (response.hasOwnProperty("err")) {
						// don't proceed if the firmware has reported an error
						$("#page_sysedit h1").text(T("Failed to retrieve files of this directory"));
					} else {
						var files = response.files, filesAdded = 0;
						for(var i = 0; i < files.length; i++) {
							if (files[i].type != 'd') {
								var lastModified = files[i].hasOwnProperty("date") ? strToTime(files[i].date) : undefined;
								addSysFile(files[i].name, files[i].size, lastModified);
								filesAdded++;
							}
						}

						if (filesAdded == 0) {
							$("#page_sysedit h1").text(T("No System Files found"));
						} else {
							sortTable($("#table_sys_files"));
						}

						$("#a_refresh_sys").removeClass("hidden");
						sysLoaded = true;
					}

					startUpdates();
				}
			}
		});
	}

	$("#table_sys_files").on("click", "tbody a", function(e) {
		var row = $(this).closest("tr");
		var file = row.data("file");
		if (file.match("\.g$") != null) {
			// Edit .g files
			editFile(getFilePath() + "/" + file, true, row.data("size"));
		} else if (file.match("\.csv$") != null) {
			// Treat .csv files as heightmaps or open them in the editor if their header doesn't match
			getHeightmap(getFilePath() + "/" + file);
		} else {
			// Download every other file
			var elem = $('<a target="_blank" href="' + ajaxPrefix + 'rr_download?name=' + encodeURIComponent(getFilePath() + "/" + file) + '" download="' + file + '"></a>');
			elem.appendTo("body");
			elem[0].click();
			elem.remove();
		}
		e.preventDefault();
	});


	/* Drag & Drop */

	var draggingObjects, dragImage;

	function fileDragStart(e) {
		// Work out which elements shall be dragged
		draggingObjects = $(this);
		if ($(this).find("input[type='checkbox']").prop("checked")) {
			draggingObjects = $(this).closest("tbody").find("input[type='checkbox']:checked").parents("tr");
		}

		// Set an alternative drag image
		if (typeof e.dataTransfer.setDragImage === "function") {
			dragImage = draggingObjects.closest("table").clone();
			dragImage.children("thead").remove();

			if (draggingObjects.length == 1) {
				var file = draggingObjects.data("file");
				if (file != undefined) {
					dragImage.find('tr[data-file!="' + file + '"]').remove();
				} else {
					var directory = draggingObjects.data("directory");
					dragImage.find('tr[data-directory!="' + directory + '"]').remove();
				}
			} else {
				dragImage.find("input[type='checkbox']:not(:checked)").parents("tr").remove();
			}

			$(document.body).css("overflow", "none");
			dragImage.css({
				"top": (e.pageY - e.offsetY) + "px",
				"left": (e.pageX - e.offsetX) + "px",
				"opacity": 0.5,
				"position": "absolute",
				"pointerEvents": "none",
				"width": draggingObjects.closest("table").width()
			}).appendTo(document.body);

			e.dataTransfer.setDragImage(dragImage[0], e.offsetX, e.offsetY);
			setTimeout(function() {
				dragImage.remove();
				$(document.body).css("overflow", "");
			});
		}

		dobjs = draggingObjects;
		ev = e;
	}

	function fileDragEnd(e) {
		draggingObjects = undefined;
	}

	$(".table-files").on("dragover", "tr", function(e) {
		var row = $(e.target).closest("tr");
		if (draggingObjects != undefined && row != undefined) {
			var dir = row.data("directory");
			if (dir != undefined) {
				for(var i = 0; i < draggingObjects.length; i++) {
					if (dir == draggingObjects.eq(i).data("directory")) {
						return;
					}
				}

				e.stopPropagation();
				e.preventDefault();
			}
		}
	});

	$(".table-files").on("drop", "tr", function(e) {
		if (draggingObjects == undefined) {
			return;
		}

		var directory = $(e.target).closest("tr").data("directory");
		for(var i = 0; i < draggingObjects.length; i++) {
			var sourcePath = draggingObjects.eq(i).data("file");
			if (sourcePath == undefined) {
				sourcePath = draggingObjects.eq(i).data("directory");
			}

			var targetPath;
			if (currentPage == "files") {
				targetPath = currentGCodeDirectory + "/" + directory + "/" + sourcePath;
				sourcePath = currentGCodeDirectory + "/" + sourcePath;

				clearFileCache(sourcePath);
				clearFileCache(targetPath);
			} else {
				targetPath = currentMacroDirectory + "/" + directory + "/" + sourcePath;
				sourcePath = currentMacroDirectory + "/" + sourcePath;
			}

			moveFile(sourcePath, targetPath, undefined, undefined, draggingObjects.eq(i));
		}

		e.stopPropagation();
		e.preventDefault();
	});

	$("#ol_gcode_directory, #ol_macro_directory").on("dragover", "a", function(e) {
		if (draggingObjects != undefined) {
			e.stopPropagation();
			e.preventDefault();
		}
	});

	$("#ol_gcode_directory, #ol_macro_directory").on("drop", "a", function(e) {
		if (draggingObjects == undefined) {
			return;
		}

		var directory = $(e.target).data("directory");
		for(var i = 0; i < draggingObjects.length; i++) {
			var sourcePath = draggingObjects.eq(i).data("file");
			if (sourcePath == undefined) {
				sourcePath = draggingObjects.eq(i).data("directory");
			}

			var targetPath;
			if (currentPage == "files") {
				targetPath = directory + "/" + sourcePath;
				sourcePath = currentGCodeDirectory + "/" + sourcePath;

				clearFileCache(sourcePath);
				clearFileCache(targetPath);
			} else {
				targetPath = directory + "/" + sourcePath;
				sourcePath = currentMacroDirectory + "/" + sourcePath;
			}

			moveFile(sourcePath, targetPath, undefined, undefined, draggingObjects.eq(i));
		}
	});


	/* List Item Events */

	$(".table-files > thead input[type='checkbox']:first-child").change(function(e) {
		$(this).closest("table").find("tbody > tr > td:first-child > input[type='checkbox']").prop("checked", $(this).prop("checked")).trigger("change");
	});

	$(".table-files").on("change", "td:first-child > input[type='checkbox']", function() {
		$(this).closest("tr").toggleClass("info", $(this).prop("checked"));
	});

	$(".table-files").on("click", "tr", function(e) {
		if ($(e.target).is("td")) {
			var row = $(e.target).closest("tr");
			var checkbox = row.find('input[type="checkbox"]');
			if (checkbox.length > 0) {
				// Toggle state of checkbox if available
				checkbox.prop("checked", !checkbox.prop("checked")).trigger("change");
			}
		}
	});

	$(".table-files").on("contextmenu", "tr", function(e) {
		if ($(e.target).closest("tbody").length > 0) {
			showContextMenu($(e.target).closest("tr"), e.clientX, e.clientY);
			e.stopPropagation();
		}
		e.preventDefault();
	});

	$(".table-files").on("dblclick", "tr", function(e) {
		if ($(e.target).is("td")) {
			var row = $(e.target).closest("tr");
			var link = row.find("a");
			if (link.length > 0) {
				// Simulate click on link when the row is double-clicked
				link.trigger("click");
			}
		}
	});


	/* Table Headers */

	$(".table-files > thead a").click(function(e) {
		// Determine in which way the column needs to be sorted
		var span = $(this).closest("th").children("span");
		var sortAscending = !span.hasClass("glyphicon-sort-by-alphabet");
		$(this).closest("tr").find("span").removeClass("glyphicon").removeClass("glyphicon-sort-by-alphabet").removeClass("glyphicon glyphicon-sort-by-alphabet-alt");
		if (sortAscending) {
			span.addClass("glyphicon").addClass("glyphicon-sort-by-alphabet");
		} else {
			span.addClass("glyphicon").addClass("glyphicon glyphicon-sort-by-alphabet-alt");
		}

		// Do the actual sorting
		sortTable($(this).closest("table"));

		$(this).blur();
		e.preventDefault();
	});

	function sortTable(table) {
		var sortingSpan = table.children("thead").find("span.glyphicon");
		var attribute = sortingSpan.parent().children("a").data("attribute");
		var ascending = sortingSpan.hasClass("glyphicon-sort-by-alphabet");

		var rows = table.children("tbody").children().detach();
		if (table.prop("id") == "table_filaments") {
			sortTableArray(rows, attribute, ascending);
		} else {
			var directories = rows.filter("[data-directory]");
			var files = rows.filter("[data-file]");

			sortTableArray(directories, (attribute == "filename") ? "directory" : attribute, ascending);
			sortTableArray(files, (attribute == "filename") ? "file" : attribute, ascending);

			rows = [];
			$.each(directories, function() { rows.push(this); });
			$.each(files, function() { rows.push(this); });
		}

		var body = table.children("tbody");
		$.each(rows, function() {
			$(this).appendTo(body);
		});
	}

	function sortTableArray(array, attribute, ascending) {
		array.sort(function(a, b) {
			var aVal = $(a).data(attribute), bVal = $(b).data(attribute);
			if (aVal == undefined && bVal == undefined) {
				return 0;
			}
			if (aVal == undefined && bVal != undefined) {
				return (ascending) ? -1 : 1;
			}
			if (aVal != undefined && bVal == undefined) {
				return (ascending) ? 1 : -1;
			}

			var result = (ascending) ? (aVal - bVal) : (bVal - aVal);
			if (isNaN(result)) {
				aVal = aVal.toString();
				bVal = bVal.toString();
				if (ascending) {
					return aVal.toLowerCase().localeCompare(bVal.toLowerCase());
				}
				return bVal.toLowerCase().localeCompare(aVal.toLowerCase());
			}
			return result;
		});
	}


	/* Context Menu */

	var contextMenuShown = false, contextMenuTargets;

	function hideContextMenu() {
		if (contextMenuShown) {
			$("#ul_file_contextmenu").hide();

			contextMenuTargets.closest("tbody").children("tr").removeClass("info");
			contextMenuTargets.closest("tbody").find("input[type='checkbox']:checked").parents("tr").addClass("info");
			contextMenuShown = false;
		}
	}

	function showContextMenu(target, x, y) {
		// Context menu isn't available on the Scans page (yet)
		if (currentPage == "scanner") {
			return;
		}

		// Hide context menu if it is already shown
		if (contextMenuShown) {
			hideContextMenu();
		}

		// Apply color to selected items
		contextMenuTargets = target;
		if (target.find("input[type='checkbox']").prop("checked")) {
			contextMenuTargets = target.closest("tbody").find("input[type='checkbox']:checked").parents("tr");
		} else {
			target.closest("tbody").children("tr").removeClass("info");
		}
		contextMenuTargets.addClass("info");

		// Decide which actions can be shown
		var contextMenu = $("#ul_file_contextmenu");
		contextMenu.children().removeClass("hidden");
		if (contextMenuTargets.length > 1) { contextMenu.children(".single").addClass("hidden"); }
		if (contextMenuTargets.length < 2) { contextMenu.children(".multi").addClass("hidden"); }
		if (contextMenuTargets.filter("[data-directory], [data-filament]").length > 0) { contextMenu.children(".file").addClass("hidden"); }
		if (contextMenuTargets.filter("[data-file]").length > 0) { contextMenu.children(".directory").addClass("hidden"); }
		if (contextMenuTargets.filter("[data-file$='.csv']").length == 0) { $("#a_context_view_heightmap").closest("li").addClass("hidden"); }
		if (currentPage != "files") { contextMenu.children(".gcode-action").addClass("hidden"); }
		if (currentPage != "macros") { contextMenu.children(".macro-action").addClass("hidden"); }
		if (currentPage != "filaments") { contextMenu.children(".filament-action").addClass("hidden"); }

		// Take care of the divider visibility
		var items = $("#ul_file_contextmenu").children();
		var isPrecededByAction = false;
		for(var i = 0; i < items.length; i++) {
			var item = items.eq(i);
			if (item.hasClass("divider")) {
				item.toggleClass("hidden", !isPrecededByAction);
				isPrecededByAction = false;
			} else {
				isPrecededByAction |= !item.hasClass("hidden");
			}
		}

		// Show it
		contextMenu.css({
			left: getMenuPosition(x, "width", "scrollLeft"),
			top: getMenuPosition(y, "height", "scrollTop")
		}).show();
		contextMenuShown = true;
	}

	function getMenuPosition(mouse, direction, scrollDir) {
		var win = $(window)[direction](),
			scroll = $(window)[scrollDir](),
			menu = $(settings.menuSelector)[direction](),
			position = mouse + scroll;

		// opening menu would pass the side of the page
		if (mouse + menu > win && menu < mouse) {
			position -= menu;
		}

		return position;
	}

	$("body").click(hideContextMenu).contextmenu(hideContextMenu);


	/* Context Menu Actions */

	$("#a_context_print").click(function(e) {
		var file = contextMenuTargets.data("file");
		waitingForPrintStart = true;
		if (currentGCodeVolume != 0) {
			sendGCode("M32 " + currentGCodeDirectory + "/" + file);
		} else if (currentGCodeDirectory == "0:/gcodes") {
			sendGCode("M32 " + file);
		} else {
			sendGCode("M32 " + currentGCodeDirectory.substring(10) + "/" + file);
		}
		e.preventDefault();
	});

	$("#a_context_run").click(function(e) {
		var file = contextMenuTargets.data("file");
		sendGCode("M98 P" + currentMacroDirectory + "/" + file);
		e.preventDefault();
	});

	$("#a_context_edit_load").click(function(e) {
		var filament = contextMenuTargets.data("filament");
		editFile("0:/filaments/" + filament + "/load.g", false);
		e.preventDefault();
	});

	$("#a_context_edit_unload").click(function(e) {
		var filament = contextMenuTargets.data("filament");
		editFile("0:/filaments/" + filament + "/unload.g", false);
		e.preventDefault();
	});

	$("#a_context_view_heightmap").click(function(e) {
		getHeightmap(getFilePath() + "/" + contextMenuTargets.data("file"));
		e.preventDefault();
	});

	$("#a_context_download_file").click(function(e) {
		var filename = contextMenuTargets.data("file");
		var filepath = getFilePath() + "/" + filename;

		// Should use a button link instead, but for some reason it isn't properly displayed with latest Bootstrap 3.3.7
		var elem = $('<a target="_blank" href="' + ajaxPrefix + 'rr_download?name=' + encodeURIComponent(filepath) + '" download="' + filename + '"></a>');
		elem.appendTo("body");
		elem[0].click();
		elem.remove();

		e.preventDefault();
	});

	$("#a_context_download_zip").click(function(e) {
		if (doingFileTask) {
			showMessage("warning", T("Download as ZIP"), T("Please wait until the pending operations have finished before you download more files"));
		} else {
			downloadNotification = showDownloadMessage();
			zipFile = new JSZip();

			var fileIndex = 1;
			$.each(contextMenuTargets, function() {
				var row = $(this);
				multiFileOperations.push({
					action: "download_zip",
					filename: row.data("file"),
					path: getFilePath() + "/" + row.data("file"),
					progress: fileIndex / contextMenuTargets.length * 100
				});
				fileIndex++;
			});
			doFileTask();
		}
		e.preventDefault();
	});

	$("#a_context_edit").click(function(e) {
		editFile(getFilePath() + "/" + contextMenuTargets.data("file"), true, contextMenuTargets.data("size"));
		e.preventDefault();
	});

	$("#a_context_rename").click(function(e) {
		var oldFileName = contextMenuTargets.data("file");
		if (oldFileName == undefined) {
			oldFileName = contextMenuTargets.data("directory");
		}
		if (oldFileName == undefined) {
			oldFileName = contextMenuTargets.data("filament");
		}

		showTextInput(T("Rename File or Directory"), T("Please enter a new name:"), function(newFileName) {
			// Try to move that file
			var filePath = getFilePath();
			$.ajax(ajaxPrefix + "rr_move?old=" + encodeURIComponent(filePath + "/" + oldFileName) + "&new=" + encodeURIComponent(filePath + "/" + newFileName), {
				dataType: "json",
				success: function(response) {
					if (response.err == 0) {
						if (currentPage == "scans") {
							updateScanFiles();
						} else if (currentPage == "files") {
							clearFileCache(filePath + "/" + oldFileName);

							gcodeUpdateIndex = -1;
							updateGCodeFiles();
						} else if (currentPage == "macros") {
							updateMacroFiles();
						} else if (currentPage == "filaments") {
							updateFilaments();
						} else {
							updateSysFiles();
						}
					}
					// else an error is reported via rr_reply
				}
			});
		}, oldFileName);
		e.preventDefault();
	});

	$("#a_context_delete").click(function(e) {
		if (contextMenuTargets.length == 1) {
			var file = contextMenuTargets.data("file");
			if (file != undefined) {
				// Delete single file
				showConfirmationDialog(T("Delete File"), T("Are you sure you want to delete <strong>{0}</strong>?", file), function() {
					deletePath(file, contextMenuTargets);
				});
			} else {
				// Delete single directory
				var directory = contextMenuTargets.data("directory");
				if (directory != undefined) {
					deletePath(directory, contextMenuTargets);
				} else {
					// Delete single filament
					var filament = contextMenuTargets.data("filament");
					showConfirmationDialog(T("Delete Filament"), T("Are you sure you want to delete <strong>{0}</strong>?", filament), function() {
						deleteFilament(filament, contextMenuTargets);
					});
				}
			}
		} else {
			// Delete multiple items
			showConfirmationDialog(T("Delete multiple Items"), T("Are you sure you want to delete the selected items?"), function() {
				$.each(contextMenuTargets, function() {
					var row = $(this);

					var file = row.data("file");
					if (file != undefined) {
						deletePath(file, row);
					} else {
						var directory = row.data("directory");
						if (directory != undefined) {
							deletePath(directory, row);
						} else {
							var filament = row.data("filament");
							deleteFilament(filament, row);
						}
					}
				});
			});
		}
		e.preventDefault();
	});


	/* Common functions */

	function deleteFilament(filament, elementToRemove) {
		multiFileOperations.push({
			action: "delete",
			elementToRemove: elementToRemove,
			filament: filament,
			type: "filament"
		});
		doFileTask();
	}

	function deletePath(filename, elementToRemove, type) {
		multiFileOperations.push({
			action: "delete",
			elementToRemove: elementToRemove,
			path: getFilePath() + "/" + filename,
			type: type
		});
		doFileTask();
	}

	function doFileTask() {
		if (doingFileTask || !isConnected) {
			return;
		}

		doingFileTask = (multiFileOperations.length > 0);
		if (doingFileTask) {
			var task = multiFileOperations.shift();
			if (task.action == "delete") {
				if (task.type == "filament") {
					$.ajax(ajaxPrefix + "rr_filelist?dir=" + encodeURIComponent("0:/filaments/" + task.filament), {
						dataType: "json",
						success: function(response) {
							if (isConnected) {
								if (response.hasOwnProperty("err")) {
									showMessage("warning", T("Warning"), T("Could not delete filament {0}", task.filament));
								} else {
									for(var i = 0; i < response.files.length; i++) {
										$.ajax(ajaxPrefix + "rr_delete?name=" + encodeURIComponent("0:/filaments/" + task.filament + "/" + response.files[i].name));
									}

									$.ajax(ajaxPrefix + "rr_delete?name=" + encodeURIComponent("0:/filaments/" + task.filament), {
										dataType: "json",
										success: function(response) {
											if (response.err == 0) {
												task.elementToRemove.remove();
												updateFilesConditionally();
											}
										}
									});
								}
							}
						}
					});
				} else {
					$.ajax(ajaxPrefix + "rr_delete?name=" + encodeURIComponent(task.path), {
						dataType: "json",
						success: function(response) {
							if (response.err == 0) {
								task.elementToRemove.remove()
								updateFilesConditionally();
							} else if (task.type == "file") {
								showMessage("warning", T("Deletion failed"), T("<strong>Warning:</strong> Could not delete file <strong>{0}</strong>!", file));
							} else if (task.type == "directory") {
								showMessage("warning", T("Deletion failed"), T("<strong>Warning:</strong> Could not delete directory <strong>{0}</strong>!<br/><br/>Perhaps it isn't empty?", directory));
							} else {

							}

							doingFileTask = false;
							doFileTask();
						}
					});
				}
			} else if (task.action == "move") {
				if (task.from == undefined || task.from.toUpperCase() == task.to.toUpperCase()) {
					// No need to rename the file or directory
					if (task.onSuccess != undefined) {
						task.onSuccess();
					}

					doingFileTask = false;
					doFileTask();
				} else {
					// File names are different, so attempt to move the old path to the new one
					$.ajax(ajaxPrefix + "rr_move?old=" + encodeURIComponent(task.from) + "&new=" + encodeURIComponent(task.to), {
						dataType: "json",
						success: function(response) {
							if (response.err == 0) {
								// If that succeeds, return to the callback
								if (task.onSuccess != undefined) {
									task.onSuccess();
								}

								// Check if we need to remove an element
								if (task.elementToRemove != undefined) {
									task.elementToRemove.remove();
									updateFilesConditionally();
								}
							} else {
								// Could not rename the file, so delete it first. Once done, call this method again
								$.ajax(ajaxPrefix + "rr_delete?name=" + encodeURIComponent(task.to), {
									dataType: "json",
									success: function(response) {
										if (response.err == 0) {
											// File delete succeeded, attempt to rename the file once again
											moveFile(task.from, task.to, task.onSuccess, task.onError);
										} else if (task.onError != undefined) {
											// Didn't work? Should never happen
											task.onError();
										}
									}
								});
							}

							doingFileTask = false;
							doFileTask();
						}
					});
				}
			} else if (task.action == "download_zip") {
				// JQuery cannot retrieve binary data, use plain JS instead
				var xhr = new XMLHttpRequest();
				xhr.onreadystatechange = function() {
					if (isConnected && zipFile != undefined) {
						if (this.readyState == 4) {
							if (this.status == 200) {
								// Add incoming file blob
								zipFile.file(task.filename, this.response);
								downloadNotification.update("progress", task.progress);

								// See if we're done
								if (multiFileOperations.length == 0 || multiFileOperations[0].action != "download_zip") {
									if (JSZip.support.blob) {
										// Download as blob
										zipFile.generateAsync({ type: "blob" }).then(function (blob) {
											downloadNotification.close();
											downloadNotification = undefined;
											zipFile = undefined;

											saveAs(blob, "download.zip");
										});
									} else {
										// Download via data URI
										zipFile.generateAsync({ type: "base64" }).then(function (base64) {
											downloadNotification.close();
											downloadNotification = undefined;
											zipFile = undefined;

											window.location = "data:application/zip;base64," + base64;
										});
									}
								}
							}

							doingFileTask = false;
							doFileTask();
						}
					}
				}
				xhr.open('GET', ajaxPrefix + "rr_download?name=" + encodeURIComponent(task.path));
				xhr.responseType = 'arraybuffer';
				xhr.send();
			}
		}
	}

	var editFileNotification = undefined;
	function editFile(file, mustExist, size) {
		if (size != undefined && size > 1000000) {
			editFileNotification = showMessage("info", T("Downloading File"), T("This file is quite big. It may take a while before it is fully loaded..."), 0);
		}
		if (mustExist == undefined) { mustExist = true; }

		$.ajax(ajaxPrefix + "rr_download?name=" + encodeURIComponent(file), {
			dataType: "text",
			global: mustExist,
			error: mustExist ? undefined : function(jqXHR, textStatus, errorThrown) {
				if (editFileNotification != undefined) {
					editFileNotification.close();
					editFileNotification = undefined;
				}

				showEditDialog(file, "", function(value) {
					uploadTextFile(file, value, function() {
						if (currentPage == "files") {
							updateGCodeFiles();
						} else if (currentPage == "macros") {
							updateMacroFiles();
						} else if (currentPage == "settings") {
							updateSysFiles();
						}
					});
				});
			},
			success: function(response) {
				if (editFileNotification != undefined) {
					editFileNotification.close();
					editFileNotification = undefined;
				}

				showEditDialog(file, response, function(value) {
					uploadTextFile(file, value, function() {
						if (currentPage == "files") {
							updateGCodeFiles();
						} else if (currentPage == "macros") {
							updateMacroFiles();
						} else if (currentPage == "settings") {
							updateSysFiles();
						}
					});
				});
			},
			timeout: 0
		});
	}

	function filenameValid(name) {
		if (name.indexOf('"') != -1 || name.indexOf("'") != -1) {
			// Don't allow quotes in filenames
			return false;
		}

		if (name.indexOf("/") != -1 || name.indexOf("\"") != -1) {
			// Don't allow (back)slashes either
			return false;
		}

		if (name.indexOf(":") != -1) {
			// Colons should be avoided too
			return false;
		}

		return true;
	}

	function getFilePath() {
		if (currentPage == "scanner") {
			return "0:/scans";
		}

		if (currentPage == "files") {
			return currentGCodeDirectory;
		}

		if (currentPage == "macros") {
			return currentMacroDirectory;
		}

		if (currentPage == "filaments") {
			return "0:/filaments";
		}

		return "0:/sys";
	}

	function moveFile(from, to, onSuccess, onError, elementToRemove) {
		multiFileOperations.push({
			action: "move",
			from: from,
			to: to,
			onSuccess: onSuccess,
			onError: onError,
			elementToRemove: elementToRemove
		});
		doFileTask();
	}

	function resetFiles() {
		setVolumes(1);
		setMountedVolumes(1);
		mountRequested = false;

		//updateScanFiles();

		knownGCodeFiles = [];
		gcodeUpdateIndex = -1;
		currentGCodeVolume = 0;
		currentGCodeDirectory = "0:/gcodes";
		//updateGCodeFiles();

		currentMacroDirectory = "0:/macros";
		//updateMacroFiles();

		//updateFilaments();

		//updateSysFiles();

		multiFileOperations = [];
		doingFileTask = false;

		downloadNotification = undefined;
		targetZipName = undefined;
		zipFile = undefined;
	}

	function updateFilesConditionally() {
		if (currentPage == "scanner") {
			if ($("#table_scan_files > tbody").children().length == 0) {
				updateScanFiles();
			}
		} else if (currentPage == "files") {
			if ($("#table_gcode_files > tbody").children().length == 0) {
				gcodeUpdateIndex = -1;
				updateGCodeFiles();
			}
		} else if (currentPage == "macros") {
			if ($("#table_macro_files > tbody").children().length == 0) {
				updateMacroFiles();
			}
		} else if (currentPage == "settings") {
			if ($("#table_sys_files > tbody").children().length == 0) {
				updateSysFiles();
			}
		}
	}
	/* Internationalization routines for Duet Web Control
	 *
	 * written by Christian Hammacher (c) 2016-2017
	 *
	 * licensed under the terms of the GPL v3
	 * see http://www.gnu.org/licenses/gpl-3.0.html
	 */


	var showTranslationWarning = false;		// Set this to "true" if you want to look for missing translation entries

	var translationData;


	// Called to look up English strings and to translate them into the configured language.
	// Variable arguments may be passed like T("Hello {0}, are you doing {1}?", "user", "well")
	function T(text) {
		var entry = text;
		if (translationData != undefined) {
			// Generate a regex to check with
			text = text.replace(/{(\d+)}/g, "{\\d+}").replace("(", "\\(").replace(")", "\\)");
			text = text.replace("?", "[?]").replace(".", "[.]");
			var regex = new RegExp("^" + text + "$");

			// Get the translation node and see if we can find an entry
			var root = translationData.getElementsByTagName(settings.language).item(settings.language);
			if (root != null) {
				for(var i = 0; i < root.children.length; i++) {
					if (regex.test(root.children[i].attributes["t"].value)) {
						entry = root.children[i].textContent;
						break;
					}
				}

				// Log translation text if we couldn't find a suitable text
				if (showTranslationWarning && entry == text) {
					console.log("WARNING: Could not translate '" + entry + "'");
				}
			}
		}

		// Format it with the given arguments
		var args = arguments;
		return entry.replace(/{(\d+)}/g, function(match, number) {
			number = parseInt(number) + 1;
			return typeof args[number] != 'undefined' ? args[number] : match;
		});
	}

	// May be called only once on page load to translate the page
	function translatePage() {
		if (translationData != undefined) {
			var root = translationData.getElementsByTagName(settings.language).item(settings.language);
			if (root != null) {
				// Translate HTML attributes
				translateEntries(root, $("p, span, th, td, strong, dt, button, li.dropdown-header"), "textContent");
				translateEntries(root, $("h1, h4, label, a, #main_content ol > li:first-child, ol.breadcrumb-directory > li:last-child"), "textContent");
				translateEntries(root, $("input[type='text']"), "placeholder");
				translateEntries(root, $("a, abbr, button, label, li, #chart_temp, input, td"), "title");
				translateEntries(root, $("img"), "alt");

				// This doesn't work with data attributes though
				$("button[data-content]").each(function() {
					$(this).attr("data-content", T($(this).attr("data-content")));
				});

				// Update SD Card button caption
				$("#btn_volume > span.content").text(T("SD Card {0}", currentGCodeVolume));

				// Set new language on Settings page
				$("#btn_language").data("language", settings.language).children("span:first-child").text(root.attributes["name"].value);
				$("html").attr("lang", settings.language);
			}
		}
	}

	function translateEntries(root, entries, key) {
		var doNodeCheck = (key == "textContent");
		$.each(entries, function() {
			// If this node has no children, we can safely use it
			if (!doNodeCheck || this.childNodes.length < 2) {
				translateEntry(root, this, key);
				// Otherwise we need to check for non-empty text nodes
			} else {
				for(var i = 0; i < this.childNodes.length; i++) {
					var val = this.childNodes[i][key];
					if (this.childNodes[i].nodeType == 3 && val != undefined && this.childNodes[i].childNodes.length == 0 && val.trim().length > 0) {
						translateEntry(root, this.childNodes[i], key);
					}
				}
			}
		});
	}

	function translateEntry(root, item, key) {
		if (item != undefined) {
			var originalText = item[key];
			if (originalText != undefined && originalText.trim() != "") {
				var text = originalText.trim();
				for(var i=0; i<root.children.length; i++) {
					var entry = root.children[i].attributes["t"].value;
					if (entry.indexOf("{") == -1 && entry == text) {
						item[key] = item[key].replace(text, root.children[i].textContent);
						return;
					}
				}

				// Log translation text if we couldn't find a suitable text
				if (showTranslationWarning) {
					console.log("WARNING: Could not translate static '" + text + "'");
				}
			}
		}
	}
	/* Main interface logic for Duet Web Control
	 *
	 * written by Christian Hammacher (c) 2016-2017
	 *
	 * licensed under the terms of the GPL v3
	 * see http://www.gnu.org/licenses/gpl-3.0.html
	 */


	var machineName = "Duet Web Control";

	var maxAxes = 9, maxExtruders = 6, maxDrives = 9, maxHeaters = 8, maxTempSensors = 10, maxFans = 3;
	var axisNames = ["X", "Y", "Z", "U", "V", "W", "A", "B", "C"];
	var probeSlowDownColor = "#FFFFE0", probeTriggerColor = "#FFF0F0";

	var webcamUpdating = false;

	var fileInfo, currentLayerTime, lastLayerPrintDuration;

	var geometry, probeSlowDownValue, probeTriggerValue;
	var numAxes, numExtruderDrives, numVolumes, numFans;
	var bedHeater = 0, chamberHeater = -1, numTempSensors, toolMapping = undefined;
	var numHeads;	// deprecated - do not use any more
	var coldExtrudeTemp, coldRetractTemp, tempLimit;

	var isPrinting, isPaused, printHasFinished;

	var currentPage = "control", waitingForPrintStart;


	function resetGuiData() {
		setBoardType("unknown");
		setPauseStatus(false);
		setPrintStatus(false);
		setGeometry("cartesian");

		justConnected = isUploading = updateTaskLive = false;
		resetConfirmationShown = false;
		stopUpdating = true;
		fileInfo = lastStatusResponse = configResponse = configFile = undefined;

		lastSentGCode = "";

		probeSlowDownValue = probeTriggerValue = undefined;
		bedHeater = 0;
		chamberHeater = -1;
		numTempSensors = 0;

		numHeads = 2;			// only 2 are visible on load
		numAxes = 3;			// only 3 are visible on load
		numExtruderDrives = 2;	// only 2 are visible on load
		numFans = undefined;

		coldExtrudeTemp = 160;
		coldRetractTemp = 90;
		tempLimit = 280;

		resetChartData();
		lastLayerPrintDuration = 0;

		setToolMapping([]);

		resetFiles();
		resetOem();

		waitingForPrintStart = fanSliderActive = speedSliderActive = extrSliderActive = false;
	}

	$(document).ready(function() {
		$('[data-min]').each(function() { $(this).attr("min", $(this).data("min")).attr("step", "any"); });
		$('[data-max]').each(function() { $(this).attr("max", $(this).data("max")).attr("step", "any"); });
		$('[data-toggle="popover"]').popover();

		disableControls();
		resetGuiData();
		updateGui();

		loadSettings();
		loadFileCache();

		// Check if this browser is supported and display a message if it is not
		var userAgent = navigator.userAgent.toLowerCase();
		var browserSupported = true;
		browserSupported &= (String.prototype.startsWith != undefined);
		browserSupported &= (userAgent.indexOf("webkit") != -1 || userAgent.indexOf("gecko") != -1);
		if (!browserSupported) {
			showMessage("warning", T("Unsupported browser"), "<strong>" + T("Warning") + ":</strong> " + T("Your browser is not officially supported. To achieve the best experience it is recommended to use either Mozilla Firefox, Google Chrome or Opera."), 0, true);
		}
	});

	function pageLoadComplete() {
		$("#span_copyright").html($("#span_copyright").html().replace("Christian Hammacher", '<a href="https://github.com/chrishamm/DuetWebControl" target="_blank">Christian Hammacher</a>'));
		log("info", "<strong>" + T("Page Load complete!") + "</strong>");

		if (settings.autoConnect) {
			// Users may want to connect automatically once the page has loaded
			connect(sessionPassword, true);
		}
	}

	function updateGui() {
		// Visibility of the Extra temperatures panel
		if (numTempSensors == 0) {
			$(".extra-temps").addClass("hidden");
			if (!$("#div_extra").hasClass("hidden")) {
				$("#div_extra").addClass("hidden");
				$("#div_tools").removeClass("hidden");
			}
		} else {
			$(".extra-temps").removeClass("hidden");
			for(var i = 0; i < maxTempSensors; i++) {
				$("#table_extra tr").eq(i + 1).toggleClass("hidden", i >= numTempSensors);
			}
		}

		// Tool entries in the Tools list
		$("#table_tools > tbody > tr[data-tool]").remove();
		if (isConnected) {
			var generatedHTML = "", toolIndex = 0;
			toolMapping.forEach(function(tool) {
				var toolName = tool.name;
				if (toolName == "") {
					toolName = T("Tool {0}", tool.number);
				}

				if (tool.heaters.length == 0) {
					var row = '<tr data-tool="' + tool.number + '">';
					row +=		'<th><a href="#"><span>' + toolName + '</span>';
					if (tool.hasOwnProperty("filament")) {
						row +=		'<span class="caret"></span>';
						if (tool.filament != "") {
							row +=	'</a><span class="text-muted">T' + tool.number + ' - ' + tool.filament + '</span>';
						} else {
							row +=	'</a><span class="text-muted">T' + tool.number + '</span>';
						}
					} else {
						row +=		'</a><span class="text-muted">T' + tool.number + '</span>';
					}
					row +=		'</th>';
					row +=		'<td colspan="4"></td>';
					row +=	'</tr>';
					generatedHTML += row;
				} else {
					var heaterIndex = 0;
					tool.heaters.forEach(function(heater) {
						var heaterName = T("Heater {0}", heater);
						var heaterState, currentTemp, activeTemp, standbyTemp;
						if (lastStatusResponse != undefined) {
							if (lastStatusResponse.temps.hasOwnProperty("current") && lastStatusResponse.temps.hasOwnProperty("state")) {
								heaterState = getHeaterStateText(lastStatusResponse.temps.state[heater]);
								currentTemp = T("{0} °C", lastStatusResponse.temps.current[heater].toFixed(1));
							} else {
								if (heater == bedHeater && lastStatusResponse.temps.hasOwnProperty("bed")) {
									heaterState = getHeaterStateText(lastStatusResponse.temps.bed.state);
									currentTemp = T("{0} °C", lastStatusResponse.temps.bed.current.toFixed(1));
								} else if (heater == chamberHeater && lastStatusResponse.temps.hasOwnProperty("chamber")) {
									heaterState = getHeaterStateText(lastStatusResponse.temps.chamber.state);
									currentTemp = T("{0} °C", lastStatusResponse.temps.chamber.current.toFixed(1));
								} else if (heater < lastStatusResponse.temps.heads.state.length + 1) {
									heaterState = getHeaterStateText(lastStatusResponse.temps.heads.state[heater - 1]);
									currentTemp = T("{0} °C", lastStatusResponse.temps.heads.current[heater - 1].toFixed(1));
								} else {
									heaterState = currentTemp = T("n/a");
								}
							}

							if (toolIndex < lastStatusResponse.temps.tools.length) {
								activeTemp = lastStatusResponse.temps.tools.active[toolIndex][heaterIndex];
								standbyTemp = lastStatusResponse.temps.tools.standby[toolIndex][heaterIndex];
							} else {
								activeTemp = standbyTemp = 0;
							}
						} else {
							heaterState = currentTemp = T("n/a");
							activeTemp = standbyTemp = 0;
						}

						var row = '<tr data-tool="' + tool.number + '" data-heater="' + heater + '">';
						row +=		'<th><a href="#"><span>' + toolName + '</span>';
						if (tool.hasOwnProperty("filament")) {
							row +=		'<span class="caret"></span>';
							if (tool.filament != "") {
								row +=	'</a><span class="text-muted">T' + tool.number + ' - ' + tool.filament + '</span>';
							} else {
								row +=	'</a><span class="text-muted">T' + tool.number + '</span>';
							}
						} else {
							row +=		'</a><span class="text-muted">T' + tool.number + '</span>';
						}
						row +=		'</th>';
						row +=		'<th><a href="#" class="heater-' + heater + '">' + heaterName + '</a><span class="text-muted heater-state">' + heaterState + '</span></th>';
						row +=		'<td class="current">' + currentTemp + '</td>';
						row +=		'<td class="input-td"><div class="input-group input-group-sm">';
						row +=			'<input type="number" class="form-control" value="' + activeTemp + '" data-type="active" disabled>';
						row +=			'<div class="input-group-btn div-head-temp hidden-sm">';
						row +=				'<button type="button" class="btn btn-default dropdown-toggle btn-active-temp disabled" data-toggle="dropdown" aria-expanded="false"><span class="caret"></span></button>';
						row +=				'<ul class="dropdown-menu dropdown-menu-right ul-active-temp" role="menu"></ul>';
						row +=			'</div>';
						row +=		'</div></td>';
						row +=		'<td class="input-td"><div class="input-group input-group-sm">';
						row +=			'<input type="number" class="form-control standby-input" value="' + standbyTemp + '" data-type="standby" disabled>';
						row +=			'<div class="input-group-btn div-head-temp hidden-sm">';
						row +=				'<button type="button" class="btn btn-default dropdown-toggle btn-standby-temp disabled" data-toggle="dropdown" aria-expanded="false"><span class="caret"></span></button>';
						row +=				'<ul class="dropdown-menu dropdown-menu-right ul-standby-temp" role="menu"></ul>';
						row +=			'</div>';
						row +=		'</div></td>';
						row +=	'</tr>';
						generatedHTML += row;
						heaterIndex++;
					});
				}
				toolIndex++;
			});

			// Generate DOM element and remove redundant tool captions
			var toolRows = $(generatedHTML);
			var firstToolRow = undefined;
			toolRows.each(function() {
				if (firstToolRow == undefined) {
					firstToolRow = $(this);
				} else {
					if (firstToolRow.data("tool") == $(this).data("tool")) {
						$(this).children().first().remove();

						var firstTh = firstToolRow.children().first();
						firstTh.prop("rowspan", firstTh.prop("rowspan") + 1);
					} else {
						firstToolRow = $(this);
					}
				}
			});
			updateFixedToolTemps(toolRows);
			toolRows.prependTo("#table_tools > tbody");
		} else {
			var toolRows = $(initialTools);
			updateFixedToolTemps(toolRows);
			toolRows.prependTo("#table_tools > tbody");
		}

		// Bed heater
		$("tr[data-heater='bed']").toggleClass("hidden", bedHeater == -1);
		if (bedHeater != -1) {
			var heaterName = T("Heater {0}", bedHeater);
			$("#table_tools tr[data-heater='bed'] > th:nth-child(2) > a").text(heaterName);
			$("#table_tools tr[data-heater='bed'] > th:nth-child(2) > a, #table_heaters tr[data-heater='bed'] > th:first-child > a").removeClass().addClass("heater-" + bedHeater);
		}

		// Chamber heater
		$("tr[data-heater='chamber']").toggleClass("hidden", chamberHeater == -1);
		if (chamberHeater != -1) {
			var heaterName = T("Heater {0}", chamberHeater);
			$("#table_tools tr[data-heater='chamber'] > th:nth-child(2) > a").text(heaterName);
			$("#table_tools tr[data-heater='chamber'] > th:nth-child(2) > a, #table_heaters tr[data-heater='chamber'] > th:first-child > a").removeClass().addClass("heater-" + chamberHeater);
		}

		// Visibility of heater temperatures (deprecated)
		for(var i = 1; i < maxHeaters; i++) {
			var hideHeater = (i > 2 && !isConnected) || (getToolsByHeater(i).length == 0 && isConnected);
			$("#table_heaters tr[data-heater='" + i + "']").toggleClass("hidden", hideHeater);
		}

		// Visibility of additional axis control buttons
		$("#panel_extra_axes").toggleClass("hidden", numAxes <= 3);
		for(var i = 4; i <= maxAxes; i++) {
			var row = $("#table_move_axes > tbody > tr").eq(i - 4);
			if (i > numAxes) {
				row.addClass("hidden");
			} else {
				row.removeClass("hidden");
				if (i == numAxes) {
					row.find("div.btn-group").css("padding-bottom", "0px");
				} else {
					row.find("div.btn-group").removeAttr("style");
				}
			}

			$("#mobile_extra_home_buttons > div.btn-group").eq(i - 4).toggleClass("hidden", i > numAxes);
		}

		// Visibility of additional axis positions
		$("#th_z, #td_z").css("border-right", numAxes < 4 ? "1px" : "0px");
		$("#th_u, #td_u").toggleClass("hidden", numAxes < 4).css("border-right", numAxes < 5 ? "1px" : "0px");
		$("#th_v, #td_v").toggleClass("hidden", numAxes < 5).css("border-right", numAxes < 6 ? "1px" : "0px");
		$("#th_w, #td_w").toggleClass("hidden", numAxes < 6).css("border-right", numAxes < 7 ? "1px" : "0px");
		$("#th_a, #td_a").toggleClass("hidden", numAxes < 7).css("border-right", numAxes < 8 ? "1px" : "0px");
		$("#th_b, #td_b").toggleClass("hidden", numAxes < 8).css("border-right", numAxes < 9 ? "1px" : "0px");
		$("#th_c, #td_c").toggleClass("hidden", numAxes < 9).css("border-right", numAxes < 10 ? "1px" : "0px");

		// Visibility of extruder drive columns
		for(var i = 1; i <= maxExtruders; i++) {
			if (i <= numExtruderDrives) {
				$(".extr-" + i).removeClass("hidden");
				$("#slider_extr_" + i).slider("relayout");
			} else {
				$(".extr-" + i).addClass("hidden");
			}

			$("th.extr-" + i + ", td.extr-" + i).css("border-right", (i < numExtruderDrives) ? "" : "0px");
		}

		// Rearrange extruder drive cells if neccessary. Only show totalusage on md desktop if more than three extruders are in use
		if (numExtruderDrives <= 3) {
			$("#col_extr_totals, #td_extr_total").addClass("hidden-md");
			for(var i = 1; i <= 3; i++) {
				$("th.extr-" + i).removeClass("hidden-md").html(T("Drive " + i));
				$("#td_extr_" + i).removeClass("hidden-md");
			}
		} else {
			$("#col_extr_totals, #td_extr_total").removeClass("hidden-md");
			for(var i = 1; i <= maxExtruders; i++) {
				$("th.extr-" + i).addClass("hidden-md").html(T("D" + i));
				$("#td_extr_" + i).addClass("hidden-md");
			}
		}

		// Do some rearrangement if we have less than four extruders and less than five axes
		if (numExtruderDrives <= 3 && numAxes <= 4) {
			$("#table_heaters .div-head-temp").removeClass("hidden-sm");
			$("#control_all_tools, #control_all_heaters").removeClass("hidden-sm");
			$("#div_tools_heaters").removeClass("col-sm-5").addClass("col-sm-6");
			$("#div_temp_chart").removeClass("col-lg-3").addClass("col-lg-5");
			$("#div_status").removeClass("col-sm-7 col-lg-5").addClass("col-sm-6 col-lg-3");
		} else {
			$("#table_heaters .div-head-temp").addClass("hidden-sm");
			$("#control_all_tools, #control_all_heaters").addClass("hidden-sm");
			$("#div_tools_heaters").removeClass("col-sm-6").addClass("col-sm-5");
			$("#div_temp_chart").removeClass("col-lg-5").addClass("col-lg-3");
			$("#div_status").removeClass("col-sm-6 col-lg-3").addClass("col-sm-7 col-lg-5");
		}

		// Charts
		resizeCharts();
		drawTemperatureChart();
		drawPrintChart();

		// Tool list on Settings page
		$("#page_tools").children(":not(:first-child)").remove();
		for(var i = 0; i < toolMapping.length; i++) {
			if (toolMapping[i].name != "") {
				title = toolMapping[i].name + " (T" + toolMapping[i].number + ")";
			} else {
				title = T("Tool {0}", toolMapping[i].number);
			}

			var heaters;
			if (toolMapping[i].heaters.length == 0) {
				heaters = T("none");
			} else {
				heaters = toolMapping[i].heaters.reduce(function(a, b) { return a + ", " + b; });
			}

			var drives;
			if (toolMapping[i].drives.length == 0) {
				drives = T("none");
			} else {
				drives = toolMapping[i].drives.reduce(function(a, b) { return a + ", " + b; });
			}

			var div =	'<div class="col-xs-6 col-sm-6 col-md-3 col-lg-3"><div class="panel panel-default">';
			div +=		'<div class="panel-heading"><span>' + title + '</span></div>';
			div +=		'<div data-tool="' + toolMapping[i].number + '" class="panel-body"><dl>';
			if (toolMapping[i].hasOwnProperty("filament")) {
				var filament = (toolMapping[i].filament == "") ? T("none") : toolMapping[i].filament;
				div +=	'<dt>' + T("Filament:") + '</dt><dd class="filament">' + filament + '</dd>';
			}
			div +=		'<dt>' + T("Heaters:") + '</dt><dd>' + heaters + '</dd>';
			div +=		'<dt>' + T("Drives:") + '</dt><dd>' + drives + '</dd>';
			div +=		'</dl><div class="row"><div class="col-md-12 text-center">';
			if (lastStatusResponse != undefined && lastStatusResponse.currentTool == toolMapping[i].number) {
				div +=		'<button class="btn btn-success btn-select-tool" title="' + T("Deselect this tool") + '">';
				div +=		'<span class="glyphicon glyphicon-remove"></span> <span>' + T("Deselect") + '</span></button>';
			} else {
				div +=		'<button class="btn btn-success btn-select-tool" title="' + T("Select this tool") + '">';
				div +=		'<span class="glyphicon glyphicon-pencil"></span> <span>' + T("Select") + '</span></button>';
			}
			div +=		' <button class="btn btn-danger btn-remove-tool" title="' + T("Remove this tool") + '">';
			div +=		'<span class="glyphicon glyphicon-trash"></span> ' + T("Remove") + '</button>';
			div +=		'</div></div></div></div></div>';
			$("#page_tools").append(div);
		}
		validateAddTool();
	}

	function resetGui() {
		// Charts
		drawTemperatureChart();
		drawPrintChart();

		// Navbar
		setMachineName("Printivo");
		setStatusLabel("Disconnected", "default");

		// Heater Temperatures
		$("#div_tools_heaters span.heater-state").text("");
		setCurrentTemperature("bed",  undefined);
		setTemperatureInput("bed", 0, true, false);
		setCurrentTemperature("chamber",  undefined);
		setTemperatureInput("chamber", 0, true, false);
		for(var i = 1; i < maxHeaters; i++) {
			setCurrentTemperature(i, undefined);
			setTemperatureInput(i, 0, true, false);
			setTemperatureInput(i, 0, false, false);
		}

		// Status fields
		$("#td_x, #td_y, #td_z").text(T("n/a"));
		for(var i = 1; i <= numExtruderDrives; i++) {
			$("#td_extr_" + i).text(T("n/a"));
		}
		$("#td_extr_total").text(T("n/a"));
		setProbeValue(-1, undefined);
		$("#td_fanrpm, #td_cputemp").text(T("n/a"));
		$(".vin").addClass("hidden");

		// Control page
		clearBedPoints();
		setAxesHomed([1, 1, 1]);
		setATXPower(false);
		$('#slider_fan_control').slider("setValue", 35);

		// Hide Scanner page
		$(".scan-control").addClass("hidden");
		$("#main_content").resize();
		if (currentPage == "scanner") {
			showPage("control");
		}

		// Print Status
		$(".row-progress").addClass("hidden");
		setProgress(100, "", "");
		$("#div_print_another").addClass("hidden");
		$("#override_fan, #auto_sleep").prop("checked", false);
		$("#span_babystepping, #page_x dd, #panel_print_info table td, #table_estimations td").html(T("n/a"));

		// Fan Sliders
		setFanVisibility(0, settings.showFan1);
		setFanVisibility(1, settings.showFan2);
		setFanVisibility(2, settings.showFan3);
		numFans = undefined;						// let the next status response callback hide fans that are not available
		$('#slider_fan_print').slider("setValue", 35);

		$('#slider_speed').slider("setValue", 100);
		for(var extr = 1; extr <= maxExtruders; extr++) {
			$("#slider_extr_" + extr).slider("setValue", 100);
		}

		// G-Code Console is not cleared automatically

		// G-Code Files
		updateGCodeFiles();

		// Macro Files
		updateMacroFiles();

		// Filaments
		updateFilaments();

		// Settings
		$("#tr_firmware_electronics").addClass("hidden");
		$("#firmware_name, #firmware_electronics, #firmware_version, #dws_version").html(T("n/a"));
		$("#page_machine td:not(:first-child), #page_machine dd").html(T("n/a"));

		updateSysFiles();

		// Modal dialogs
		closeMessageBox();
		$(".modal").modal("hide");

		// Upload prompt
		$("#input_file_upload").val("");
	}

	function updateWebcam(externalTrigger) {
		if (externalTrigger && webcamUpdating) {
			// When the settings are applied, make sure this only runs once
			return;
		}

		if (settings.webcamURL == "") {
			webcamUpdating = false;
		} else if (settings.webcamEmbedded) {
			webcamUpdating = false;
			$("#ifm_webcam").attr("src", settings.webcamURL);
		} else if (settings.webcamInterval == 0) {
			webcamUpdating = false;
			$("#img_webcam").attr("src", settings.webcamURL);
		} else {
			var newURL = settings.webcamURL;
			if (settings.webcamFix) {
				newURL += "_" + Math.random();
			} else {
				if (newURL.indexOf("?") == -1) {
					newURL += "?dummy=" + Math.random();
				} else {
					newURL += "&dummy=" + Math.random();
				}
			}
			$("#img_webcam").attr("src", newURL);

			webcamUpdating = true;
			setTimeout(function() {
				updateWebcam(false);
			}, settings.webcamInterval);
		}
	}


	/* Dynamic GUI Events */

	$("body").on("focus", "input[type='number']", function() {
		var input = $(this);
		setTimeout(function() {
			input.select();
		}, 10);
	});

	$("#div_tools_heaters").on("click", ".bed-temp", function(e) {
		if ($(this).closest("tr").data("heater") == "bed") {
			sendGCode("M140 S" + $(this).data("temp"));		// Set bed temperature
		} else {
			sendGCode("M141 S" + $(this).data("temp"));		// Set chamber temperature
		}
		e.preventDefault();
	});

	$("#div_tools_heaters div.panel-heading div.dropdown").on("click", ".heater-temp", function(e) {
		if (toolMapping != undefined) {
			var inputElement = $(this).closest("div.input-group").find("input");
			var activeOrStandby = (inputElement.data("type") == "active") ? "S" : "R";
			var temperature = $(this).data("temp");

			var gcode = "";
			for(var i = 0; i < toolMapping.length; i++) {
				var temps = [];
				toolMapping[i].heaters.forEach(function() { temps.push(temperature); });
				if (temps.length > 0) {
					var tempString = temps.reduce(function(a, b) { return a + ":" + b; });
					gcode += "G10 P" + toolMapping[i].number + " " + activeOrStandby + tempString + "\n";
				}
			}
			sendGCode(gcode);
		}

		e.preventDefault();
	});

	$("#page_settings").on("click", ".btn-select-tool", function(e) {
		var tool = $(this).closest("div.panel-body").data("tool");
		if (lastStatusResponse != undefined && lastStatusResponse.currentTool == tool) {
			changeTool(-1);
		} else {
			changeTool(tool);
		}
		e.preventDefault();
	});

	$("#page_settings").on("click", ".btn-remove-tool", function(e) {
		var tool = $(this).closest("div.panel-body").data("tool");
		showConfirmationDialog(T("Delete Tool"), T("Are you sure you wish to remove tool {0}?", tool), function() {
			sendGCode("M563 P" + tool + " D-1 H-1");
			extendedStatusCounter = settings.extendedStatusInterval;
		});
		e.preventDefault();
	});

	$("#table_extra input[type='checkbox']").change(function() {
		setExtraTemperatureVisibility($(this).closest("tr").data("sensor"), $(this).prop("checked"));
	});

	$("#table_heaters").on("click", ".heater-temp", function(e) {
		var inputElement = $(this).closest("div.input-group").find("input");
		var activeOrStandby = (inputElement.data("type") == "active") ? "S" : "R";
		var temperature = $(this).data("temp");
		var gcode = "";
		var heater = inputElement.closest("tr").data("heater");
		var currentTool = (lastStatusResponse == undefined) ? -1 : lastStatusResponse.currentTool;

		// 1. Is the active tool mapped to this heater?
		if (currentTool >= 0 && $.inArray(heater, getTool(currentTool).heaters) != -1) {
			// Yes - generate only one G10 code for it
			var type = inputElement.data("type");
			var temps = [];
			getTool(currentTool).heaters.forEach(function(h) {
				if (h == heater) {
					temps.push(temperature);
				} else {
					temps.push($("#table_heaters > tbody > tr[data-heater='" + h + "'] > td > input[data-type='" + type + "']").val());
				}
			});

			gcode = "G10 P" + currentTool + " " + activeOrStandby + temps.reduce(function(a, b) { return a + ":" + b; });
		} else {
			// 2. Is there a tool that is only mapped to this heater?
			var toolFound = false;
			getToolsByHeater(heater).forEach(function(tool) {
				var toolHeaters = getTool(tool).heaters;
				if (!toolFound && toolHeaters.length == 1) {
					// Yes - generate only one G10 code for this tool
					gcode = "G10 P" + tool + " " + activeOrStandby + temperature;
					toolFound = true;
				}
			});

			// 3. Is there at least one tool that is assigned to this heater at all?
			if (!toolFound) {
				var tools = getToolsByHeater(heater);
				if (tools.length > 0) {
					// Yes - use the first one to set the target temperature(s)
					var type = inputElement.data("type");
					var temps = [];
					getTool(tools[0]).heaters.forEach(function(h) {
						if (h == heater) {
							temps.push(temperature);
						} else {
							temps.push($("#table_heaters > tbody > tr[data-heater='" + h + "'] > td > input[data-type='" + type + "']").val());
						}
					});

					gcode = "G10 P" + tools[0] + " " + activeOrStandby + temps.reduce(function(a, b) { return a + ":" + b; });
				}
			}
		}

		sendGCode(gcode);
		e.preventDefault();
	});

	$("#table_tools").on("click", ".heater-temp", function(e) {
		var tool = $(this).closest("tr").data("tool");
		var heater = $(this).closest("tr").data("heater");
		var type = $(this).closest("div.input-group").find("input").data("type");
		var temperature = $(this).data("temp");

		var temps = [];
		getTool(tool).heaters.forEach(function(h) {
			if (h == heater) {
				temps.push(temperature);
			} else {
				var cell = $("#table_tools > tbody > tr[data-tool='" + tool + "'][data-heater='" + h + "'] > td");
				temps.push(cell.find("div > input[data-type='" + type + "']").val());
			}
		});

		var gcode = "G10 P" + tool  + " " + (type == "active" ? "S" : "R");
		gcode += temps.reduce(function(a, b) { return a + ":" + b; });
		sendGCode(gcode);

		$(this).select();
		e.preventDefault();
	});

	$("#table_tools").on("click", "tr > th:nth-child(2) > a", cbHeaterClick);

	$("#table_tools").on("keydown", "tr > td > div > input", function(e) {
		// Ignore bed and chamber heaters. They're handled by a static event callback
		var heater = $(this).closest("tr").data("heater");
		if (heater == "bed" || heater == "chamber") {
			return;
		}

		// Has the user pressed enter or tab (on Android)?
		var enterKeyPressed = (e.which == 13);
		enterKeyPressed |= (e.which == 9 && windowIsXsSm());
		if (isConnected && enterKeyPressed) {
			var tool = $(this).closest("tr").data("tool");
			var type = $(this).data("type");

			var temps = [];
			getTool(tool).heaters.forEach(function(h) {
				var cell = $("#table_tools > tbody > tr[data-tool='" + tool + "'][data-heater='" + h + "'] > td");
				temps.push(cell.find("div > input[data-type='" + type + "']").val());
			});

			var gcode = "G10 P" + tool  + " " + (type == "active" ? "S" : "R");
			gcode += temps.reduce(function(a, b) { return a + ":" + b; });
			sendGCode(gcode);

			$(this).select();
			e.preventDefault();
		}
	});

	$("#table_tools").on("click", "tr > th:first-child > a", function(e) {
		// Ignore bed and chamber heaters. They're handled by a static event callback
		var heater = $(this).closest("tr").data("heater");
		if (heater == "bed" || heater == "chamber") {
			return;
		}

		// Ignore this if we're not connected
		if (!isConnected) {
			e.preventDefault();
			return;
		}

		// Get the associated tool and check if it allows the filament to be changed
		var currentTool = (lastStatusResponse == undefined) ? -1 : lastStatusResponse.currentTool;
		var tool = $(this).closest("tr").data("tool");
		if (getTool(tool).hasOwnProperty("filament")) {
			// Show popover for tools that are assigned to exactly one extruder and let the user decide what to do
			var popover = $(this).parent().children("div.popover");
			if (popover.length > 0) {
				$(this).popover("hide");
				$(this).blur();
			} else {
				if (lastPopover != undefined) {
					$(lastPopover).popover("hide");
					lastPopover = undefined;
				}
				var toolObj = getTool(tool);

				// make popover content
				var content = '';
				if (tool == currentTool) {
					content += '<a href="#" class="tool" data-tool="-1"><span class="glyphicon glyphicon-pause"></span> ' + T("Deselect Tool") + '</a>';
				} else {
					content += '<a href="#" class="tool" data-tool="' + tool + '"><span class="glyphicon glyphicon-play"></span> ' + T("Select Tool") + '</a>';
				}
				content += "<hr>";
				if (toolObj != undefined && toolObj.filament == "") {
					content += '<a href="#" class="load-filament"><span class="glyphicon glyphicon glyphicon-arrow-down"></span> Load Filament</a>';
				} else {
					content += '<a href="#" class="change-filament"><span class="glyphicon glyphicon-transfer"></span> Change Filament</a>';
					content += '<br/><a href="#" class="unload-filament"><span class="glyphicon glyphicon-arrow-up"></span> Unload Filament</a>';
				}

				// show it
				$(this).popover({
					content: content,
					html: true,
					trigger: "manual",
					placement: "bottom",
				}).popover("show");
			}
		} else {
			// Either activate or deactivate tool
			if (tool == currentTool) {
				changeTool(-1);
			} else {
				changeTool(tool);
			}

			$(this).blur();
		}
		e.preventDefault();
	});

	$("body").on("click", ".load-filament", function(e) {
		showFilamentDialog($(this).closest("tr").data("tool"), false);
		e.preventDefault();
	});

	$("body").on("click", ".change-filament", function(e) {
		showFilamentDialog($(this).closest("tr").data("tool"), true);
		e.preventDefault();
	});

	$("body").on("click", ".unload-filament", function(e) {
		var tool = $(this).closest("tr").data("tool"), gcode = "";
		if (lastStatusResponse != undefined && lastStatusResponse.currentTool != tool) {
			gcode = "T" + tool + "\n";
		}
		gcode += "M702";
		sendGCode(gcode);

		e.preventDefault();
	});

	$("body").on("click", ".tool", function(e) {
		changeTool($(this).data("tool"));
		e.preventDefault();
	});

	$("body").on("click", ".filament-usage", function(e) {
		if (windowIsXsSm()) {
			// Display filament usage for small devices on click
			showMessage("info", T("Filament usage"), $(this).attr("title"));
		}
		e.preventDefault();
	});

	$("body").on("click", "[data-gcode]", function(e) {
		if (isConnected && !$(this).hasClass("disabled")) {
			// If this G-Code isn't performed by a button, treat it as a manual input
			sendGCode($(this).data("gcode"), !($(this).is(".btn")));
		}
		e.preventDefault();
	});

	var lastPopover = undefined;
	$("body").on("shown.bs.popover", function(e) {
		lastPopover = $(".popover");
	});

	$("body").on("blur", "#div_tools_heaters tr > th > a", function() {
		if (lastPopover != undefined) {
			lastPopover.popover("hide");
		}
	});

	$("body").on("hidden.bs.popover", function(e) {
		if (lastPopover != undefined) {
			$(lastPopover).popover("destroy");
			lastPopover = undefined;
		}
	});


	/* Static GUI Events */

	$(".a-tools, .a-heaters, .a-extra").click(function(e) {
		var showTools = $(this).hasClass("a-tools");
		var showHeaters = $(this).hasClass("a-heaters");
		var showExtra = $(this).hasClass("a-extra");
		$("#div_tools").toggleClass("hidden", !showTools);
		$("#div_heaters").toggleClass("hidden", !showHeaters);
		$("#div_extra").toggleClass("hidden", !showExtra);
		resizeCharts();
		e.preventDefault();
	});

	$(".heaters-off").click(function(e) {
		if (isConnected) {
			var gcode = "";

			// Turn off nozzle heaters
			if (toolMapping != undefined) {
				for(var i = 0; i < toolMapping.length; i++) {
					var temps = [];
					toolMapping[i].heaters.forEach(function() { temps.push("-273.15"); });
					if (temps.length > 0) {
						var tempString = temps.reduce(function(a, b) { return a + ":" + b; });
						gcode += "G10 P" + toolMapping[i].number + " R" + tempString + " S" + tempString + "\n";
					}
				}
			}

			// Turn off bed
			if (bedHeater != -1) {
				gcode += "M140 S-273.15\n";
			}

			// Turn off chamber
			if (chamberHeater != -1) {
				gcode += "M141 S-273.15\n";
			}

			sendGCode(gcode);
		}
		e.preventDefault();
	});

	$("#a_webcam").click(function(e) {
		var panelContent= $("#panel_webcam > div.panel-body");
		if (panelContent.hasClass("hidden")) {
			$("#span_webcam").removeClass("glyphicon-menu-up").addClass("glyphicon-menu-down");
			panelContent.removeClass("hidden");
		} else {
			$("#span_webcam").removeClass("glyphicon-menu-down").addClass("glyphicon-menu-up");
			panelContent.addClass("hidden");
		}
		$(this).blur();
		e.preventDefault();
	});

	$("#img_webcam").click(function(){
		updateWebcam(true);
	});

	$("#btn_baby_down").click(function() {
		if (isConnected) {
			sendGCode("M290 S" + (-settings.babysteppingZ));
		}
	});

	$("#btn_baby_up").click(function() {
		if (isConnected) {
			sendGCode("M290 S" + (settings.babysteppingZ));
		}
	});

	$("#btn_cancel").click(function() {
		sendGCode("M0 H1");	// Stop / Cancel Print, but leave all the heaters on
		$(this).addClass("disabled");
	});

	$(".btn-emergency-stop").click(function() {
		if (settings.confirmStop) {
			showConfirmationDialog(T("Emergency STOP"), T("This will turn off everything and perform a software reset.<br/><br/>Are you REALLY sure you want to do this?"), function() {
				sendGCode("M112\nM999");
			});
		} else {
			sendGCode("M112\nM999");
		}
	});

	$("#btn_clear_log").click(function(e) {
		$("#console_log").html("");
		log("info", "<strong>" + T("Message Log cleared!") + "</strong>");
		e.preventDefault();
	});

	$("#btn_extrude").click(function(e) {
		var feedrate = $("#panel_extrude input[name=feedrate]:checked").val() * 60;
		var amount = $("#panel_extrude input[name=feed]:checked").val();
		var drive = $('input[name="extruder"]:checked').val();

		if (drive != "mix" && lastStatusResponse != undefined && !$("#div_extrude").hasClass("hidden")) {
			var amounts = [];
			var toolDrives = getTool(lastStatusResponse.currentTool).drives;
			for(var i = 0; i < toolDrives.length; i++) {
				if (drive == "all" || drive == toolDrives[i]) {
					amounts.push(amount);
				} else {
					amounts.push("0");
				}
			}
			amount = amounts.join(":");
		}

		sendGCode("M120\nM83\nG1 E" + amount + " F" + feedrate + "\nM121");
	});

	$("#btn_retract").click(function(e) {
		var feedrate = $("#panel_extrude input[name=feedrate]:checked").val() * 60;
		var amount = -$("#panel_extrude input[name=feed]:checked").val();
		var drive = $('input[name="extruder"]:checked').val();

		if (drive != "mix" && lastStatusResponse != undefined && !$("#div_extrude").hasClass("hidden")) {
			var amounts = [];
			var toolDrives = getTool(lastStatusResponse.currentTool).drives;
			for(var i = 0; i < toolDrives.length; i++) {
				if (drive == "all" || drive == toolDrives[i]) {
					amounts.push(amount);
				} else {
					amounts.push("0");
				}
			}
			amount = amounts.join(":");
		}

		sendGCode("M120\nM83\nG1 E" + amount + " F" + feedrate + "\nM121");
	});

	$(".btn-hide-info").click(function() {
		if ($(this).hasClass("active")) {
			$("#row_info").addClass("hidden-xs hidden-sm");
			$("#main_content").addClass("content-collapsed-padding");
			setTimeout(function() {
				$(".btn-hide-info").removeClass("active");
			}, 100);
		} else {
			$("#row_info").removeClass("hidden-xs hidden-sm");
			$("#main_content").removeClass("content-collapsed-padding");
			setTimeout(function() {
				$(".btn-hide-info").addClass("active");
			}, 100);
		}
		$(this).blur();
	});

	$(".btn-home-x").resize(function() {
		if (geometry != "delta") {
			var width = $(this).parent().width();
			if (width > 0) {
				$("#btn_homeall").css("min-width", width);
			}
		}
	}).resize();

	$("#mobile_home_buttons button, #btn_homeall, #mobile_extra_home_buttons, .table-move a, " +
		"#div_x_controls button[data-x], #div_y_controls button[data-y], #div_z_controls button[data-z]").click(function(e) {
		if ($(this).data("home") != undefined) {
			if ($(this).data("home") == "all") {
				sendGCode("G28");
			} else {
				sendGCode("G28 " + $(this).data("home"));
			}
		} else {
			var moveString = "M120\nG91\nG1";
			if ($(this).data("x") != undefined) {
				moveString += " X" + $(this).data("x");
			}
			if ($(this).data("y") != undefined) {
				moveString += " Y" + $(this).data("y");
			}
			if ($(this).data("z") != undefined) {
				moveString += " Z" + $(this).data("z");
			}
			if ($(this).data("u") != undefined) {
				moveString += " U" + $(this).data("u");
			}
			if ($(this).data("v") != undefined) {
				moveString += " V" + $(this).data("v");
			}
			if ($(this).data("w") != undefined) {
				moveString += " W" + $(this).data("w");
			}
			if ($(this).data("a") != undefined) {
				moveString += " A" + $(this).data("a");
			}
			if ($(this).data("b") != undefined) {
				moveString += " B" + $(this).data("b");
			}
			if ($(this).data("c") != undefined) {
				moveString += " C" + $(this).data("c");
			}
			moveString += " F" + settings.moveFeedrate + "\nM121";
			sendGCode(moveString);
		}
		e.preventDefault();
	});



	/*
		$("#pressure_status").click(function(e) {
			var moveString = "M120\nG91\nG1";
			if ($(this).data("p") != undefined) {
				moveString += " X" + $(this).data("x");
			}
			sendGCode(moveString);
		}
		e.preventDefault();
		});
*/



	$("#btn_pause").click(function() {
		if (isPaused) {
			sendGCode("M24");	// Resume
		} else if (isPrinting) {
			sendGCode("M25");	// Pause
		}
		$(this).addClass("disabled");
	});

	$("#btn_print_another").click(function() {
		if (isConnected) {
			sendGCode("M32 " + $(this).data("file"));
			$("#div_print_another").addClass("hidden");
		}
	});

	$(".gcode-input").submit(function(e) {
		if (isConnected) {
			var gcode = $(this).find("input").val();
			if (settings.uppercaseGCode) {
				var gcodeToSend = "", inString = false;
				for(var i = 0; i < gcode.length; i++) {
					var chr = gcode[i];
					if (inString) {
						if (i < gcode.length - 1 && chr == '\\' && gcode[i + 1] == '"') {
							gcodeToSend += '\\"';
							i++;
						} else {
							if (chr == '"') {
								inString = false;
							}
							gcodeToSend += chr;
						}
					} else {
						if (chr == '"') {
							inString = true;
						}
						gcodeToSend += chr.toUpperCase();
					}
				}
				gcode = gcodeToSend;
			}
			sendGCode(gcode, true);
			$(this).find("input").select();
		}
		e.preventDefault();
	});

	// Make the auto-complete dropdown items look nice.
	// This should be replaced by proper CSS someday, but
	// for now we only check which elements may float around.
	$(".div-gcodes").bind("shown.bs.dropdown", function() {
		var maxWidth = 0;
		$(this).find("ul > li > a").each(function() {
			var rowWidth = 0;
			$(this).find("span").each(function() {
				rowWidth += $(this).width();
			});

			if (rowWidth > maxWidth) {
				maxWidth = rowWidth;
			}
		});

		if (maxWidth > 0) {
			$(this).find("ul > li > a").each(function() {
				var rowWidth = 0;
				$(this).find("span").each(function() {
					rowWidth += $(this).width();
				});

				if (rowWidth < maxWidth) {
					$(this).addClass("gcode-float");
				}
			});
		}
	});

	$("#table_heaters > tbody > tr > td > div > input," +
	  "#table_tools > tbody > tr[data-heater='bed'] > td > div > input," +
	  "#table_tools > tbody > tr[data-heater='chamber'] > td > div > input").keydown(function(e) {
		var enterKeyPressed = (e.which == 13);
		enterKeyPressed |= (e.which == 9 && windowIsXsSm()); // need this for Android
		if (isConnected && enterKeyPressed) {
			var heater = $(this).closest("tr").data("heater");
			var temperature = $(this).val();
			var gcode = "";

			// 1. Are we dealing with a bed or chamber heater?
			if (heater == "bed") {
				gcode = "M140 S" + temperature;
			} else if (heater == "chamber") {
				gcode = "M141 S" + temperature;
			} else {
				// 2. Is the active tool mapped to this heater?
				var activeOrStandby = ($(this).data("type") == "active") ? "S" : "R";
				var currentTool = (lastStatusResponse == undefined) ? -1 : lastStatusResponse.currentTool;
				if (currentTool >= 0 && $.inArray(heater, getTool(currentTool).heaters) != -1) {
					// Yes - generate only one G10 code for it
					var type = $(this).data("type");
					var temps = [];
					getTool(currentTool).heaters.forEach(function(h) {
						if (h == heater) {
							temps.push(temperature);
						} else {
							temps.push($("#table_heaters > tbody > tr[data-heater='" + h + "'] > td > input[data-type='" + type + "']").val());
						}
					});

					gcode = "G10 P" + currentTool + " " + activeOrStandby + temps.reduce(function(a, b) { return a + ":" + b; });
				} else {
					// 3. Is there a tool that is only mapped to this heater?
					var toolFound = false;
					getToolsByHeater(heater).forEach(function(tool) {
						var toolHeaters = getTool(tool).heaters;
						if (!toolFound && toolHeaters.length == 1) {
							// Yes - generate only one G10 code for this tool
							gcode = "G10 P" + tool + " " + activeOrStandby + temperature;
							toolFound = true;
						}
					});

					// 4. Is there at least one tool that is assigned to this heater at all?
					if (!toolFound) {
						var tools = getToolsByHeater(heater);
						if (tools.length > 0) {
							// Yes - use the first one to set the target temperature(s)
							var type = $(this).data("type");
							var temps = [];
							getTool(tools[0]).heaters.forEach(function(h) {
								if (h == heater) {
									temps.push(temperature);
								} else {
									temps.push($("#table_heaters > tbody > tr[data-heater='" + h + "'] > td > input[data-type='" + type + "']").val());
								}
							});

							gcode = "G10 P" + tools[0] + " " + activeOrStandby + temps.reduce(function(a, b) { return a + ":" + b; });
						}
					}
				}
			}
			sendGCode(gcode);

			$(this).select();
			e.preventDefault();
		}
	});

	$(".all-temp-input").keydown(function(e) {
		if (isConnected && e.which == 13) {
			if (toolMapping != undefined) {
				var activeOrStandby = ($(this).data("type") == "active") ? "S" : "R";
				var temperature = $(this).val();

				var gcode = "";
				for(var i = 0; i < toolMapping.length; i++) {
					if ($.inArray(0, toolMapping[i].heaters) == -1) {
						// Make sure we don't set temperatures for the heated bed
						gcode += "G10 P" + toolMapping[i].number + " " + activeOrStandby + $(this).val() + "\n";
					}
				}
				sendGCode(gcode);
			}

			e.preventDefault();
		}
	});

	$("#main_content").resize(function() {
		// It doesn't always make sense to make the main content scrollable. Hence check if
		// a) this option is explicitly enabled
		// b) DWC is not running in a small window
		// c) the sidebar has enough space to be fully displayed
		if (!settings.scrollContent || windowIsXsSm() || $(".sidebar").first().offset().top + $(".sidebar").first().height() > $(window).height()) {
			$(this).css("height", "").css("min-height", "");
		} else {
			var height = "calc(100vh - " + $(this).offset().top + "px)";
			var minHeight = $(".sidebar:not(.sidebar-continuation)").height() + "px";
			$(this).css("height", height).css("min-height", minHeight);

			if ($("body").height() > $(window).height()) {
				$(this).css("height", "").css("min-height", "");
			}
		}
	});

	$(".navbar-brand").click(function(e) { e.preventDefault(); });
	$(".navbar-brand.visible-xs > abbr").click(function(e) {
		showMessage("warning", T("Warning"), T("Some axes are not homed"));
		e.preventDefault();
	});

	$(".navlink").click(function(e) {
		$(this).blur();
		showPage($(this).data("target"));
		e.preventDefault();
	});

	$("#panel_control_misc label.btn").click(function() {
		if ($(this).find("input").val() == 1) {		// ATX on
			sendGCode("M80");
		} else {									// ATX off
			showConfirmationDialog(T("ATX Power"), T("Do you really want to turn off ATX power?<br/><br/>This will turn off all drives, heaters and fans."), function() {
				sendGCode("M81");
			});
		}
	});

	$("#panel_extrude label.btn").click(function() {
		$(this).parent().find("label.btn").removeClass("btn-primary").addClass("btn-default");
		$(this).removeClass("btn-default").addClass("btn-primary");
	});

	$("#table_heaters > tbody > tr > th > a," +
		"#table_tools > tbody > tr[data-heater='bed'] > th:first-child > a," +
		"#table_tools > tbody > tr[data-heater='chamber'] > th:first-child > a").click(cbHeaterClick);


	$("#check_heaters input[type='checkbox'], #check_drives input[type='checkbox']").change(function() {
		var isChecked = $(this).is(":checked");
		$(this).closest("label").toggleClass("btn-primary", isChecked).toggleClass("btn-default", !isChecked);

		validateAddTool();
	});

	$("#div_add_tool input[type='number']").on("input", function() {
		validateAddTool();
	});

	function validateAddTool() {
		var toolNumber = parseInt($("#input_tool_number").val());
		var disableButton =	(!isConnected) ||
			(isNaN(toolNumber) || toolNumber < 0 || toolNumber > 255) ||
			(toolMapping != undefined && getTool(toolNumber) != undefined);
		$("#btn_add_tool").toggleClass("disabled", disableButton);
	}

	$("#div_add_tool input[type='number']").keydown(function(e) {
		if (e.which == 13) {
			if (!$("#btn_add_tool").hasClass("disabled")) {
				$("#btn_add_tool").click();
			}
			e.preventDefault();
		}
	});

	$("#ul_control_dropdown_tools, #ul_control_dropdown_heaters").click(function(e) {
		$(this).find(".dropdown").removeClass("open");
		if ($(e.target).is("a")) {
			$(this).closest(".dropdown").removeClass("open");
		} else {
			e.stopPropagation();
		}
	});

	$("#ul_control_dropdown_tools .btn-active-temp, #ul_control_dropdown_tools .btn-standby-temp," +
		"#ul_control_dropdown_heaters .btn-active-temp, #ul_control_dropdown_heaters .btn-standby-temp").click(function(e) {
		$(this).parent().toggleClass("open");
		e.stopPropagation();
	});

	window.onerror = function (msg, url, lineNo, columnNo, error) {
		var errorMessage;
		if (msg.toLowerCase().indexOf("script error") == -1){
			errorMessage = [
				'Message: ' + msg,
				'URL: ' + url,
				'Line: ' + lineNo + ":" + columnNo,
				'Error object: ' + JSON.stringify(error)
			].join("<br/>");
		} else {
			errorMessage = 'Script Error: See Browser Console for Detail';
		}

		if (isConnected) {
			disconnect();
			showMessage("danger", T("JavaScript Error"), T("A JavaScript error has occurred so the web interface has closed the connection to your board. It is recommended to reload the web interface now. If this happens again, please contact the author and share this error message:") + "<br/><br/>" + errorMessage, 0);
		}

		return false;
	};


	/* Mixed events */

	function cbHeaterClick(e) {
		if (isConnected && !$(this).hasClass("disabled") && lastStatusResponse != undefined) {
			var tool = $(this).closest("tr").data("tool");
			if (tool != undefined) {
				// Heater clicked on Tools panel. Change the associated tool
				if (tool == lastStatusResponse.currentTool) {
					changeTool(-1);
				} else {
					changeTool(tool);
				}
				$(this).blur();
			} else {
				// Heater clicked on Heaters panel. Work out what to do
				var heater = $(this).closest("tr").data("heater");
				if (heater == "bed") {
					var bedState = lastStatusResponse.temps.bed.state;
					if (bedState == 3) {
						showMessage("danger", T("Heater Fault"), T("<strong>Error:</strong> A heater fault has occured on this particular heater.<br/><br/>Please turn off your machine and check your wiring for loose connections."));
					} else if (bedState == 2) {
						// Put bed into standby mode
						sendGCode("M144");
					} else {
						// Bed is either off or in standby mode, send M140 to turn it back on
						sendGCode("M140 S" + lastStatusResponse.temps.bed.active);
					}
					$(this).blur();
				} else if (heater == "chamber") {
					var chamberState = lastStatusResponse.temps.chamber.state;
					if (chamberState == 3) {
						showMessage("danger", T("Heater Fault"), T("<strong>Error:</strong> A heater fault has occured on this particular heater.<br/><br/>Please turn off your machine and check your wiring for loose connections."));
					} else if (chamberState == 2) {
						// Put chamber into off mode
						sendGCode("M141 S-273.15");
					} else {
						// Bed is either off or in standby mode, send M140 to turn it back on
						sendGCode("M141 S" + lastStatusResponse.temps.chamber.active);
					}
					$(this).blur();
				} else {
					var heaterState = lastStatusResponse.temps.heads.state[heater - 1];
					if (heaterState == 3) {
						showMessage("danger", T("Heater Fault"), T("<strong>Error:</strong> A heater fault has occured on this particular heater.<br/><br/>Please turn off your machine and check your wiring for loose connections."));
					} else {
						var tools = getToolsByHeater(heater), hasToolSelected = false;
						tools.forEach(function(tool) {
							if (tool == lastStatusResponse.currentTool) {
								hasToolSelected = true;
							}
						});

						if (hasToolSelected) {
							changeTool(-1);
							$(this).blur();
						} else if (tools.length == 1) {
							changeTool(tools[0]);
							$(this).blur();
						} else if (tools.length > 0) {
							var popover = $(this).parent().children("div.popover");
							if (popover.length > 0) {
								$(this).popover("hide");
								$(this).blur();
							} else {
								var content = '<div class="btn-group-vertical btn-group-vertical-justified">';
								tools.forEach(function(toolNumber) {
									content += '<div class="btn-group"><a href="#" class="btn btn-default btn-sm tool" data-tool="' + toolNumber + '">T' + toolNumber + '</a></div>';
								});
								content += '</div>';

								$(this).popover({
									content: content,
									html: true,
									title: T("Select Tool"),
									trigger: "manual",
									placement: "bottom",
								}).popover("show");
							}
						}
					}
				}
			}
		}
		e.preventDefault();
	}


	/* GUI Helpers */

	function addBedTemperature(temperature) {
		// Drop-Down item
		$(".ul-bed-temp").append('<li><a href="#" class="bed-temp" data-temp="' + temperature + '">' + T("{0} °C", temperature) + '</a></li>');
		$(".btn-bed-temp").removeClass("disabled");

		// Entry on Settings page
		var item =	'<li class="list-group-item col-md-6" data-temperature="' + temperature + '">' + T("{0} °C", temperature);
		item +=		'<button class="btn btn-danger btn-sm btn-delete-parent pull-right" title="' + T("Delete this temperature item") + '">';
		item +=		'<span class="glyphicon glyphicon-trash"></span></button></li>';
		$("#ul_bed_temps").append(item);
	}

	function addDefaultGCode(label, gcode) {
		// Drop-Down item
		var item =	'<li><a href="#" class="gcode" data-gcode="' + gcode + '">';
		item +=		'<span>' + label + '</span>';
		item +=		'<span class="label label-primary">' + gcode + '</span>';
		item +=		'</a></li>';

		$(".ul-gcodes").append(item);
		$(".btn-gcodes").removeClass("disabled");

		// Entry on Settings page
		item =	'<tr><td><label class="label label-primary">' + gcode + '</label></td><td>' + label + '</td><td>';
		item +=	'<button class="btn btn-sm btn-danger btn-delete-parent" title="' + T("Delete this G-Code item") + '">';
		item += '<span class="glyphicon glyphicon-trash"></span></button></td></tr>';
		$("#table_gcodes > tbody").append(item);
	}

	function addHeadTemperature(temperature, type) {
		// Drop-Down item
		$(".ul-" + type + "-temp").append('<li><a href="#" class="heater-temp" data-temp="' + temperature + '">' + T("{0} °C", temperature) + '</a></li>');
		$(".btn-" + type + "-temp").removeClass("disabled");

		// Entry on Settings page
		var item =	'<li class="list-group-item col-xs-6 col-lg-3" data-temperature="' + temperature + '">' + T("{0} °C", temperature);
		item +=		'<button class="btn btn-danger btn-sm btn-delete-parent pull-right" title="' + T("Delete this temperature item") + '">';
		item +=		'<span class="glyphicon glyphicon-trash"></span></button></li>';
		$("#ul_" + type + "_temps").append(item);
	}

	function changeTool(tool) {
		// Check if any tool change macros can be skipped
		var param = 7;
		if (!settings.doTfree) { param &= ~1; }
		if (!settings.doTpre) { param &= ~2; }
		if (!settings.doTpost) { param &= ~4; }

		// If all the macros shall be run, send only the T-code
		if (param == 7) {
			sendGCode("T" + tool);
		} else {
			sendGCode("T" + tool + " P" + param);
		}
	}

	function clearBedTemperatures() {
		$(".ul-bed-temp, #ul_bed_temps").html("");
		$(".btn-bed-temp").addClass("disabled");
	}

	function clearDefaultGCodes() {
		$(".ul-gcodes").html("");
		$("#table_gcodes > tbody").children().remove();
		$(".btn-gcodes").addClass("disabled");
	}

	function clearHeadTemperatures() {
		$(".ul-active-temp, .ul-standby-temp, #ul_active_temps, #ul_standby_temps").html("");
		$(".btn-active-temp, .btn-standby-temp").addClass("disabled");
	}

	function setAxesHomed(axes) {
		// Set button colors and prepare list of unhomed axes
		var unhomedAxes = "";
		if (axes[0]) {
			$(".btn-home-x").removeClass("btn-warning").addClass("btn-primary");
		} else {
			unhomedAxes = (geometry == "delta") ? ", A" : ", X";
			$(".btn-home-x").removeClass("btn-primary").addClass("btn-warning");
		}
		if (axes[1]) {
			$(".btn-home-y").removeClass("btn-warning").addClass("btn-primary");
		} else {
			unhomedAxes += (geometry == "delta") ? ", B" : ", Y";
			$(".btn-home-y").removeClass("btn-primary").addClass("btn-warning");
		}
		if (axes[2]) {
			$(".btn-home-z").removeClass("btn-warning").addClass("btn-primary");
		} else {
			unhomedAxes += (geometry == "delta") ? ", C" : ", Z";
			$(".btn-home-z").removeClass("btn-primary").addClass("btn-warning");
		}
		if (axes.length > 3) {
			if (axes[3]) {
				$(".btn-home-u").removeClass("btn-warning").addClass("btn-primary");
			} else {
				unhomedAxes += ", U";
				$(".btn-home-u").removeClass("btn-primary").addClass("btn-warning");
			}
		}
		if (axes.length > 4) {
			if (axes[4]) {
				$(".btn-home-v").removeClass("btn-warning").addClass("btn-primary");
			} else {
				unhomedAxes += ", V";
				$(".btn-home-v").removeClass("btn-primary").addClass("btn-warning");
			}
		}
		if (axes.length > 5) {
			if (axes[5]) {
				$(".btn-home-w").removeClass("btn-warning").addClass("btn-primary");
			} else {
				unhomedAxes += ", W";
				$(".btn-home-w").removeClass("btn-primary").addClass("btn-warning");
			}
		}
		if (axes.length > 6) {
			if (axes[6]) {
				$(".btn-home-a").removeClass("btn-warning").addClass("btn-primary");
			} else {
				unhomedAxes += ", A";
				$(".btn-home-a").removeClass("btn-primary").addClass("btn-warning");
			}
		}
		if (axes.length > 7) {
			if (axes[7]) {
				$(".btn-home-b").removeClass("btn-warning").addClass("btn-primary");
			} else {
				unhomedAxes += ", B";
				$(".btn-home-b").removeClass("btn-primary").addClass("btn-warning");
			}
		}
		if (axes.length > 8) {
			if (axes[8]) {
				$(".btn-home-c").removeClass("btn-warning").addClass("btn-primary");
			} else {
				unhomedAxes += ", C";
				$(".btn-home-c").removeClass("btn-primary").addClass("btn-warning");
			}
		}

		// Set home alert visibility
		if (unhomedAxes == "") {
			$(".home-warning").addClass("hidden");
		} else {
			if (unhomedAxes.length > 3) {
				$("#unhomed_warning").html(T("The following axes are not homed: <strong>{0}</strong>", unhomedAxes.substring(2)));
			} else {
				$("#unhomed_warning").html(T("The following axis is not homed: <strong>{0}</strong>", unhomedAxes.substring(2)));
			}
			$(".home-warning").removeClass("hidden");
		}
	}

	function setATXPower(value) {
		$("input[name='atxPower']").prop("checked", false).parent().removeClass("active");
		$("input[name='atxPower'][value='" + (value ? "1" : "0") + "']").prop("checked", true).parent().addClass("active");
	}

	function setBoardType(type) {
		var isWiFi = false;
		var show7Extruders = false, show7Heaters = false;

		if (type.indexOf("duetwifi") == 0) {
			firmwareFileName = "DuetWiFiFirmware";
			isWiFi = show7Extruders = show7Heaters = true;
		} else if (type.indexOf("duetethernet") == 0) {
			firmwareFileName = "DuetEthernetFirmware";
			show7Extruders = show7Heaters = true;
		} else {
			firmwareFileName = "RepRapFirmware";
		}

		$(".7-extruders").toggleClass("hidden", !show7Extruders);
		$(".7-heaters").toggleClass("hidden", !show7Heaters);
		$(".wifi-setting").toggleClass("hidden", !isWiFi);

		boardType = type;
	}

	function setCurrentTemperature(heater, temperature) {
		// Set current heater temperature
		var tempCell = $("#div_tools_heaters tr[data-heater='" + heater + "'] > td.current");
		if (temperature == undefined) {
			tempCell.html(T("n/a"));
		} else if (temperature < -270) {
			tempCell.html(T("error"));
		} else {
			tempCell.html(T("{0} °C", temperature.toFixed(1)));
		}

		// Update Extrude+Retract buttons
		if (heater != "bed" && heater != "chamber" && lastStatusResponse != undefined) {
			if (lastStatusResponse.currentTool != -1) {
				var isActiveHead = false;
				getToolsByHeater(heater).forEach(function(tool) { if (tool == lastStatusResponse.currentTool) { isActiveHead = true; } });
				if (isActiveHead) {
					if (temperature >= coldRetractTemp) {
						$(".btn-retract").removeClass("disabled");
					} else {
						$(".btn-retract").addClass("disabled");
					}

					if (temperature >= coldExtrudeTemp) {
						$(".btn-extrude").removeClass("disabled");
					} else {
						$(".btn-extrude").addClass("disabled");
					}
				}
			} else {
				$(".btn-retract, .btn-extrude").addClass("disabled");
			}
		}
	}

	function setCurrentToolTemperature(tool, heater, temperature) {
		var tempCell = $("#table_tools tr[data-tool='" + tool + "'][data-heater='" + heater + "'] > td.current");
		if (temperature == undefined) {
			tempCell.html(T("n/a"));
		} else if (temperature < -270) {
			tempCell.html(T("error"));
		} else {
			tempCell.html(T("{0} °C", temperature.toFixed(1)));
		}
	}

	function setGeometry(g) {
		// The following may be extended in future versions
		if (g == "delta") {
			$("#btn_bed_compensation").text(T("Auto Delta Calibration"));
			$("#panel_head_movement .home-buttons div, #panel_head_movement div.home-buttons").addClass("hidden");
			$("#panel_head_movement td.home-buttons").css("padding-right", "0px");
			$("#btn_homeall").css("min-width", "");
		} else {
			$("#btn_bed_compensation").text(T("Auto Bed Compensation"));
			$("#panel_head_movement .home-buttons div, #panel_head_movement div.home-buttons").removeClass("hidden");
			$("#panel_head_movement td.home-buttons").css("padding-right", "");
			$("#btn_homeall").resize();
		}
		$("#dd_geometry").text(T(g.charAt(0).toUpperCase() + g.slice(1)));
		geometry = g;
	}

	function setHeaterState(heater, state, currentTool) {
		var statusText = getHeaterStateText(state);
		if (heater == "bed" || heater == "chamber") {
			$("#div_tools_heaters tr[data-heater='" + heater + "'] > th > span:last-child").text(statusText);
		} else {
			// Set status texts on Tools panel
			$("#table_tools > tbody > tr[data-heater='" + heater + "']").each(function() {
				$(this).find("span.heater-state").html(statusText);
			});

			// Set status texts on Heaters panel
			var tools = getToolsByHeater(heater);
			if (tools.length != 0) {
				var toolList = [];
				for(var i = 0; i < tools.length; i++) {
					toolList.push((tools[i] == currentTool) ? ("<u>T" + tools[i] + "</u>") : ("T" + tools[i]));
				}
				statusText += " (" + toolList.reduce(function(a, b) { return a + ", " + b; }) + ")";

				if (tools.length > 1) {
					$("#table_heaters > tbody > tr[data-heater='" + heater + "'] > th").find(".caret").removeClass("hidden");
				} else {
					$("#table_heaters > tbody > tr[data-heater='" + heater + "'] > th").find(".caret").addClass("hidden");
				}
			} else {
				$("#table_heaters tr > th:first-child").eq(heater).find(".caret").addClass("hidden");
			}
			$("#table_heaters > tbody > tr[data-heater='" + heater + "'] span.heater-state").html(statusText);
		}
	}

	function setPauseStatus(paused) {
		if (paused == isPaused) {
			return;
		}

		$("#div_cancel").toggleClass("hidden", !paused);
		if (paused) {
			$("#btn_cancel").removeClass("disabled");
			$("#btn_pause").removeClass("btn-warning disabled").addClass("btn-success").attr("title", T("Resume paused print (M24)"));
			$("#btn_pause > span.glyphicon").removeClass("glyphicon-pause").addClass("glyphicon-play");
			$("#btn_pause > span:last-child").text(T("Resume"));
		} else {
			$("#btn_pause").removeClass("btn-success").addClass("btn-warning").attr("title", T("Pause current print (M25)"));
			$("#btn_pause > span.glyphicon").removeClass("glyphicon-play").addClass("glyphicon-pause");
			$("#btn_pause > span:last-child").text(T("Pause Print"));
			if (isPrinting) {
				$("#btn_pause").removeClass("disabled");
			}
		}
		isPaused = paused;
	}

	function setPrintStatus(printing) {
		if (printing == isPrinting) {
			return;
		}

		if (printing) {
			if (justConnected) {
				showPage("print");
			}

			layerData = [];
			currentLayerTime = maxLayerTime = lastLayerPrintDuration = 0;
			drawPrintChart();
			printHasFinished = false;

			// Progress is set in the status response callback

			$(".btn-upload").addClass("disabled");
			$("#page_general .btn-upload").removeClass("disabled");

			$("#btn_pause").removeClass("disabled");
			$("#div_print_another").addClass("hidden");
			$(".row-progress").removeClass("hidden");
			$("#td_last_layertime").html(T("n/a"));

			requestFileInfo();
		} else {
			$("#btn_pause").addClass("disabled");
			$(".btn-upload").toggleClass("disabled", !isConnected);

			if (!isConnected || fileInfo == undefined) {
				$(".row-progress").addClass("hidden");
			}

			if (isConnected) {
				if ($("#auto_sleep").is(":checked")) {
					sendGCode("M1");
					$("#auto_sleep").prop("checked", false);
				}

				if (!printHasFinished && currentLayerTime > 0) {
					addLayerData(currentLayerTime, true);
					$("#td_layertime").html(T("n/a"));
				}
				printHasFinished = true;

				if (fileInfo != undefined) {
					$("#div_print_another").removeClass("hidden");
					$("#btn_print_another").data("file", fileInfo.fileName);

					setProgress(100, T("Printed {0}, 100% Complete", fileInfo.fileName), undefined);
				} else {
					setProgress(100, T("Print Complete!"), undefined);
				}

				["filament", "layer", "file"].forEach(function(id) {
					if ($("#tl_" + id).html() != T("n/a")) {
						$("#tl_" + id).html("00s");
						$("#et_" + id).html((new Date()).toLocaleTimeString());
					}
				});
			}

			fileInfo = undefined;
		}

		isPrinting = printing;

		if (waitingForPrintStart && printing) {
			$("#modal_upload").modal("hide");
			showPage("print");
			waitingForPrintStart = false;
		}
	}

	function setProbeValue(value, secondaryValue) {
		if (value < 0) {
			$("#td_probe").html(T("n/a"));
		} else if (secondaryValue == undefined) {
			$("#td_probe").html(value);
		} else {
			$("#td_probe").html(value + " (" + secondaryValue.reduce(function(a, b) { return a + b; }) + ")");
		}

		if (probeTriggerValue != undefined && value > probeTriggerValue && !isPrinting) {
			$("#td_probe").css("background-color", probeTriggerColor);
		} else if (probeSlowDownValue != undefined && value > probeSlowDownValue && !isPrinting) {
			$("#td_probe").css("background-color", probeSlowDownColor);
		} else {
			$("#td_probe").css("background-color", "");
		}
	}

	function setProgress(progress, labelLeft, labelRight) {
		if (labelLeft != undefined) {
			$("#span_progress_left").text(labelLeft);
		}
		if (labelRight != undefined) {
			$("#span_progress_right").text(labelRight);
		}
		$("#progress").css("width", progress + "%");

		if (progress == 100) {
			Piecon.reset();
		} else {
			Piecon.setProgress(progress);
		}
	}

	function setStatusLabel(text, style) {
		text = T(text);
		$(".label-status").removeClass("label-default label-danger label-info label-warning label-success label-primary").addClass("label-" + style).text(text);
	}

	function setTemperatureInput(heater, value, active, setToolHeaters) {
		var prefix = (setToolHeaters) ? "" : "#table_heaters ";

		var tempInput = undefined;
		if (heater == "bed") {
			tempInput = $(prefix + "tr[data-heater='bed'] input");
		} else if (heater == "chamber") {
			tempInput = $(prefix + "tr[data-heater='chamber'] input");
		} else {
			var activeOrStandby = (active) ? "active": "standby";
			tempInput = $(prefix + "tr[data-heater='" + heater + "'] input[data-type='" + activeOrStandby + "']");
		}

		if (tempInput != undefined) {
			// FIXME: This limits inputs to 0C. Maybe it should be configurable instead?
			tempInput.filter(":not(:focus)").val((value < 0) ? 0 : value);
		}
	}

	function setToolTemperatureInput(tool, heater, value, active) {
		// Update Heaters panel as well
		setTemperatureInput(heater, value, active, false);

		var tempInput = undefined;
		if (heater == "bed") {
			tempInput = $("#table_tools tr[data-heater='bed'] input");
		} else if (heater == "chamber") {
			tempInput = $("#table_tools tr[data-heater='chamber'] input");
		} else {
			var activeOrStandby = (active) ? "active": "standby";
			tempInput = $("#table_tools tr[data-tool='" + tool + "'][data-heater='" + heater + "'] input[data-type='" + activeOrStandby + "']");
		}

		if (tempInput != undefined) {
			// FIXME: This limits inputs to 0C. Maybe it should be configurable instead?
			tempInput.filter(":not(:focus)").val((value < 0) ? 0 : value);
		}
	}

	function setTimeLeft(field, value) {
		if (value == undefined || (value == 0 && isPrinting)) {
			$("#et_" + field + ", #tl_" + field).html(T("n/a"));
		} else {
			// Estimate end time
			var now = new Date();
			var estEndTime = new Date(now.getTime() + value * 1000); // Date uses ms
			$("#et_" + field).html(estEndTime.toLocaleTimeString());

			// Estimate time left
			$("#tl_" + field).html(formatTime(value));
		}
	}

	function setMachineName(name) {
		if (name == machineName) {
			return;
		}

		$("#title, .machine-name").text(name);
		machineName = name;
	}

	function showPage(name) {
		$(".navitem, .page").removeClass("active");
		$(".navitem-" + name + ", #page_" + name).addClass("active");

		if (name != currentPage) {
			if (name == "control") {
				$("#slider_fan_control").slider("relayout");
				if (currentMacroDirectory == "0:/macros" && !macrosLoaded) {
					updateMacroFiles();
				}
			}

			if (name == "print") {
				$("#slider_speed").slider("relayout");
				$("#slider_fan_print").slider("relayout");
				for(var extr = 1; extr <= maxExtruders; extr++) {
					$("#slider_extr_" + extr).slider("relayout");
				}
				if (refreshPrintChart) {
					drawPrintChart();
				}
				waitingForPrintStart = false;
			}

			if (name == "scanner") {
				if (scansLoaded) {
					$(".span-refresh-scans").removeClass("hidden");
				} else {
					updateScanFiles();
				}
			} else {
				$(".span-refresh-scans").addClass("hidden");
			}

			if (name == "pressure") {
				currentPage = "pressure";
				if (windowIsMdLg()) {
					$("#page_pressure input").focus();
				}
			}

			if (name == "console") {
				currentPage = "console";
				if (windowIsMdLg()) {
					$("#page_console input").focus();
				}
			}

			if (name == "files") {
				if (gcodeUpdateIndex == knownGCodeFiles.length) {
					$(".span-refresh-files").removeClass("hidden");
				} else {
					updateGCodeFiles();
				}
			} else {
				$(".span-refresh-files").addClass("hidden");
			}

			if (name == "macros" && isConnected) {
				if (macrosLoaded) {
					$(".span-refresh-macros").removeClass("hidden");
				} else {
					updateMacroFiles();
				}
			} else {
				$(".span-refresh-macros").addClass("hidden");
			}

			if (name == "filaments" && isConnected) {
				if (filamentsLoaded) {
					$(".span-refresh-filaments").removeClass("hidden");
				} else {
					updateFilaments();
				}
			}
			if (name == "signal" && isConnected) {

			}else {
				$(".span-refresh-filaments").addClass("hidden");
			}

			if (name == "settings" && isConnected) {
				getConfigResponse();

				if ($("#page_ui").is(".active")) {
					$("#btn_clear_cache").toggleClass("disabled", $.isEmptyObject(cachedFileInfo));
				} else if ($("#page_sysedit").is(".active")) {
					if (sysLoaded) {
						$("#a_refresh_sys").removeClass("hidden");
					} else {
						updateSysFiles();
					}
				}
			}
		}

		// Scroll to top of the main content on small devices
		if (windowIsXsSm() && $(".btn-hide-info").hasClass("active")) {
			$('html, body').animate({
				scrollTop: ($('#main_content').offset().top)
			}, 500);
		}
		currentPage = name;
	}


	/* Theme support */

	function applyThemeColors() {
		// Update temp chart colors and repaint it
		for(var heater = 0; heater < maxHeaters; heater++) {
			tempChartOptions.colors[heater] = $(".heater-" + heater).css("color");
		}
		tempChartOptions.colors[maxHeaters] = $(".chamber").css("color");
		for(var tempSensor = 0; tempSensor < maxTempSensors; tempSensor++) {
			tempChartOptions.colors[maxHeaters + 1 + tempSensor] = $(".temp-sensor-" + tempSensor).css("color");
		}

		if (tempChart != undefined) {
			tempChart.destroy();
			tempChart = undefined;
			drawTemperatureChart();
		}

		// Update layer times chart
		printChartOptions.colors[0] = getColorFromCSS("chart-print-line");
		if (printChart != undefined) {
			printChart.destroy();
			printChart = undefined;
			drawPrintChart();
		}

		// Update background color for print chart tooltip
		if (settings.theme == "dark") {
			$("#layer_tooltip").css("background-color", $("#panel_print_info").css("background-color"));
		} else {
			$("#layer_tooltip").css("background-color", "");
		}

		// Update Z-probe colors
		probeSlowDownColor = getColorFromCSS("probe-slow-down");
		probeTriggerColor = getColorFromCSS("probe-trigger");
	}

	function getColorFromCSS(classname)
	{
		var ghostSpan = $('<span class="hidden ' + classname + '"></span>');
		ghostSpan.appendTo("body");
		var color = ghostSpan.css("color");
		ghostSpan.remove();
		return color;
	}
	/* Modal dialog functions for Duet Web Control
	 *
	 * written by Christian Hammacher (c) 2016-2017
	 *
	 * licensed under the terms of the GPL v3
	 * see http://www.gnu.org/licenses/gpl-3.0.html
	 */


	/* Generic workarounds */

	$(".modal").on("hidden.bs.modal", function() {
		// Bootstrap bug: Padding is added to the right, but never cleaned
		$("body").css("padding-right", "");
	});


	/* Confirmation Dialog */

	function showConfirmationDialog(title, message, callback) {
		$("#modal_confirmation h4").html('<span class="glyphicon glyphicon-question-sign"></span> ' + title);
		$("#modal_confirmation p").html(message);
		$("#modal_confirmation button.btn-success").off().one("click", callback);
		$("#modal_confirmation").modal("show");
		$("#modal_confirmation .btn-success").focus();
	}


	/* Text Input Dialog */

	function showTextInput(title, message, callback, text, emptyCallback) {
		$("#modal_textinput h4").html(title);
		$("#modal_textinput p").html(message);
		$("#modal_textinput input").val((text == undefined) ? "" : text);
		$("#modal_textinput form").off().submit(function(e) {
			$("#modal_textinput").modal("hide");
			var value = $("#modal_textinput input").val();
			if (value.trim() != "") {
				callback(value);
			} else if (emptyCallback != undefined) {
				emptyCallback();
			}
			e.preventDefault();
		});
		$("#modal_textinput").modal("show");
	}

	$("#modal_textinput").on("shown.bs.modal", function() {
		$("#modal_textinput input").focus();
	});


	/* Host Prompt */

	function showHostPrompt() {
		if (settings.hasOwnProperty("lastHost")) {
			$('#input_host').val(settings.lastHost);
		}
		$("#modal_host_input").modal("show");
	}

	$("#modal_host_input").on("shown.bs.modal", function() {
		$("#input_host").focus();
	});

	$("#form_host").submit(function(e) {
		$("#modal_host_input").off("hide.bs.modal").modal("hide");
		ajaxPrefix = settings.lastHost = $("#input_host").val();		// let the user decide if this shall be saved

		ajaxPrefix += "/";
		if (ajaxPrefix.indexOf("://") == -1) {
			// Prepend http prefix if no URI scheme is given
			ajaxPrefix = "http://" + ajaxPrefix;
		}

		connect(sessionPassword, true);
		e.preventDefault();
	});


	/* Password prompt */

	function showPasswordPrompt() {
		$('#input_password').val("");
		$("#modal_pass_input").modal("show");
		$("#modal_pass_input").one("hide.bs.modal", function() {
			// The network request will take a few ms anyway, so no matter if the user has
			// cancelled the password input, we can reset the Connect button here...
			$(".btn-connect").removeClass("btn-warning disabled").addClass("btn-info").find("span:not(.glyphicon)").text(T("Connect"));
		});
	}

	$("#form_password").submit(function(e) {
		$("#modal_pass_input").off("hide.bs.modal").modal("hide");
		connect($("#input_password").val(), false);
		e.preventDefault();
	});

	$("#modal_pass_input").on("shown.bs.modal", function() {
		$("#input_password").focus();
	});


	/* Filament Change Dialog */

	var filamentChangeTool, changingFilament;

	function showFilamentDialog(tool, changeFilament) {
		// make list of all available filaments
		$("#div_filaments").children().remove();
		$("#table_filaments > tbody > tr").each(function() {
			var filament = $(this).data("filament");
			var isLoaded = false;
			for(var i = 0; i < toolMapping.length; i++) {
				if (toolMapping[i].hasOwnProperty("filament") && toolMapping[i].filament == filament) {
					isLoaded = true;
					break;
				}
			}

			if (!isLoaded) {
				$("#div_filaments").append('<a href="#" class="a-load-filament list-group-item" data-filament="' + filament + '"><span class="glyphicon glyphicon-cd"></span> ' + filament + '</a>');
			}
		});

		// show notification or selection dialog
		if ($("#div_filaments").children().length == 0) {
			showMessage("warning", T("No Filaments"), T("There are no other filaments available to choose. Please go to the Filaments page and define more."));
		} else {
			filamentChangeTool = tool;
			changingFilament = changeFilament;
			$("#modal_change_filament").modal("show");
		}
	}

	$("body").on("click", ".a-load-filament", function(e) {
		$("#modal_change_filament").modal("hide");

		var gcode = "";
		if (lastStatusResponse != undefined && lastStatusResponse.currentTool != filamentChangeTool) {
			gcode = "T" + filamentChangeTool + "\n";
		}
		if (changingFilament) {
			gcode += "M702\n";
		}
		gcode += "M701 S\"" + $(this).data("filament") + "\"";
		sendGCode(gcode);

		e.preventDefault();
	});


	/* File Edit Dialog */

	function showEditDialog(title, content, callback) {
		$("#modal_edit .modal-title").text(T("Editing {0}", title));
		var edit = $("#modal_edit textarea").val(content).get(0);
		edit.selectionStart = edit.selectionEnd = 0;
		$("#modal_edit").modal("show");
		$("#btn_save_file").off("click").click(function() {
			$("#modal_edit").modal("hide");
			callback($("#modal_edit textarea").val());
		});
	}

	$("#modal_edit").on("shown.bs.modal", function() {
		$("#modal_edit textarea").focus();
	});

	$("#modal_edit div.modal-content").resize(function() {
		var contentHeight = $(this).height();
		var headerHeight = $("#modal_edit div.modal-header").height();
		var footerHeight = $("#modal_edit div.modal-footer").height();
		$("#modal_edit div.modal-body").css("height", (contentHeight - headerHeight - footerHeight - 60) + "px");
	});

	$(document).delegate("#modal_edit textarea", "keydown", function(e) {
		var keyCode = e.keyCode || e.which;

		if (keyCode == 9) {
			e.preventDefault();
			var start = $(this).get(0).selectionStart;
			var end = $(this).get(0).selectionEnd;

			// set textarea value to: text before caret + tab + text after caret
			$(this).val($(this).val().substring(0, start)
					+ "\t"
					+ $(this).val().substring(end));

			// put caret at right position again
			$(this).get(0).selectionStart = $(this).get(0).selectionEnd = start + 1;
		}
	});


	/* Start Scan Dialog (proprietary) */

	$("#modal_start_scan input").keyup(function() {
		$("#btn_start_scan_modal").toggleClass("disabled", $("#modal_start_scan input:invalid").length > 0);
	});

	$("#btn_toggle_laser").click(function(e) {
		if ($(this).hasClass("active")) {
			sendGCode("M755 P0");
			$(this).removeClass("active").children("span.content").text(T("Activate Laser"));
		} else {
			sendGCode("M755 P1")
			$(this).addClass("active").children("span.content").text(T("Deactivate Laser"));
		}

		$(this).blur();
		e.preventDefault();
	});

	$("#modal_start_scan form").submit(function(e) {
		if (!$("#btn_start_scan_modal").hasClass("disabled")) {
			// 1. Turn off the alignment laser if it is still active
			if ($("#btn_toggle_laser").hasClass("active")) {
				$("#btn_toggle_laser").removeClass("active").children("span.content").text(T("Activate Laser"));
				if (isConnected) {
					sendGCode("M755 P0");
				}
			}

			// 2. Start a new scan
			var filename = $("#input_scan_filename").val();
			var length = $("#input_scan_length").val();

			// 3. Check the filename and start a new scan
			if (filenameValid(filename)) {
				sendGCode("M752 S" + length + " P" + filename);
			} else {
				showMessage("danger", T("Error"), T("The specified filename is invalid. It may not contain quotes, colons or (back)slashes."));
			}

			// 4. Hide the modal dialog
			$("#modal_start_scan").modal("hide");
		}

		e.preventDefault();
	});

	$("#modal_start_scan").on("hidden.bs.modal", function() {
		if ($("#btn_toggle_laser").hasClass("active")) {
			$("#btn_toggle_laser").removeClass("active").children("span.content").text(T("Activate Laser"));
			if (isConnected) {
				// Turn off laser again when the dialog is closed
				sendGCode("M755 P0");
			}
		}
	});


	/* Scanner Progress Dialogs */

	function updateScannerDialogs(scanResponse) {
		var scanProgress = 100, postProcessingProgress = 100, uploadProgress = 100;

		if (scanResponse.status == "S" || scanResponse.status == "P" || scanResponse.status == "U") {
			// Scanner is active
			if (!$("#modal_scanner").hasClass("in")) {
				$("#btn_cancel_scan").removeClass("hidden").removeClass("disabled");
				$("#btn_close_scan").addClass("hidden");

				$("#modal_scanner .modal-title").text(T("Scanning..."));
				$("#p_scan_info").text(T("Please wait while a scan is being made. This may take a while..."));

				$("#modal_scanner").modal("show");
			}

			// Update progress
			if (scanResponse.status == "S") {
				scanProgress = scanResponse.progress;
				postProcessingProgress = 0;
				uploadProgress = 0;
			} else if (scanResponse.status == "P") {
				scanProgress = 100;
				postProcessingProgress = scanResponse.progress;
				uploadProgress = 0;
			} else if (scanResponse.status == "U") {
				scanProgress = 100;
				postProcessingProgress = 100;
				uploadProgress = scanResponse.progress;
				$("#btn_cancel_scan").addClass("disabled");
			}
		} else if (scanResponse.status == "C") {
			// Scanner calibration is running
			if (!$("#modal_scanner_calibration").hasClass("in")) {
				$("#btn_cancel_calibration").removeClass("disabled");
				$("#modal_scanner_calibration").modal("show");
			}

			// Update progress
			$("#progress_calibration").css("width", scanResponse.progress + "%");
			$("#span_calibration_progress").text(T("{0} %", scanResponse.progress));
		} else if (scanResponse.status == "I") {
			// Scanner is inactive
			if ($("#modal_scanner").hasClass("in")) {
				$("#modal_scanner .modal-title").text(T("Scan complete"));
				$("#p_scan_info").text(T("Your 3D scan is now complete! You may download it from the file list next."));

				$("#btn_cancel_scan").addClass("hidden");
				$("#btn_close_scan").removeClass("hidden");
			}

			if ($("#modal_scanner_calibration").hasClass("in")) {
				$("#modal_scanner_calibration").modal("hide");
			}
		}

		// Update progress bars
		if ($("#modal_scanner").hasClass("in")) {
			$("#progress_scan").css("width", scanProgress + "%");
			$("#span_scan_progress").text(T("{0} %", scanProgress));

			$("#progress_scan_postprocessing").css("width", postProcessingProgress + "%");
			$("#span_scan_postprocessing_progress").text(T("{0} %", postProcessingProgress));

			$("#progress_scan_upload").css("width", uploadProgress + "%");
			$("#span_scan_upload_progress").text(T("{0} %", uploadProgress));
		}
	}

	$("#btn_cancel_scan").click(function() {
		if (!$(this).hasClass("disabled")) {
			sendGCode("M753");
			$("#modal_scanner").modal("hide");
		}
	});

	$("#btn_cancel_calibration").click(function() {
		if (!$(this).hasClass("disabled")) {
			sendGCode("M753");
			$(this).addClass("disabled");
		}
	});


	/* Message Box Dialog */

	var messageBoxResponse = undefined;

	function updateMessageBox(response) {
		var timeout = response.timeout;
		response.timeout = 0;

		var stringifiedResponse = JSON.stringify(response);
		if (stringifiedResponse != messageBoxResponse)
		{
			messageBoxResponse = stringifiedResponse;
			showMessageBox(response.msg, response.title, response.mode, timeout, response.controls);
		}
	}

	function closeMessageBox() {
		if (messageBoxResponse != undefined) {
			if ($("#modal_messagebox").hasClass("in")) {
				$("#modal_messagebox").modal("hide");
			}
			messageBoxResponse = undefined;
		}
	}


	var messageBoxTimer = undefined;

	function showMessageBox(message, title, mode, timeout, controls) {
		// Display message, title and optionally show Z controls
		$("#h3_messagebox").text(message);
		$("#h4_messagebox_title").text(title);
		$("#modal_messagebox div.modal-header").toggleClass("hidden", title == "");

		// Toggle axis control visibility
		$("#div_x_controls").toggleClass("hidden", (controls & (1 << 0)) == 0);
		$("#div_y_controls").toggleClass("hidden", (controls & (1 << 1)) == 0);
		$("#div_z_controls").toggleClass("hidden", (controls & (1 << 2)) == 0);

		// Toggle button visibility
		$("#modal_messagebox div.modal-footer").toggleClass("hidden", mode == 0);
		$("#modal_messagebox [data-dismiss]").toggleClass("hidden", mode != 1);
		$("#btn_ack_messagebox").toggleClass("hidden", mode == 0 || mode == 1);
		$("#btn_cancel_messagebox").toggleClass("hidden", mode != 3);

		// Show message box
		var backdropValue = (mode != 1) ? "static" : "true";
		$("#modal_messagebox").modal({ backdrop: backdropValue });

		var data = $("#modal_messagebox").data("bs.modal");
		data.options.backdrop = backdropValue;
		$("#modal_messagebox").data("bs.modal", data);

		// Take care of the timeouts
		if (messageBoxTimer != undefined) {
			clearTimeout(messageBoxTimer);
		}
		if (timeout > 0) {
			messageBoxTimer = setTimeout(function() {
				messageBoxTimer = undefined;
				$("#modal_messagebox").modal("hide");
			}, timeout * 1000);
		}
	}

	$("#btn_ack_messagebox").click(function() {
		$("#modal_messagebox").modal("hide");
		sendGCode("M292");
	});

	$("#btn_cancel_messagebox").click(function() {
		$("#modal_messagebox").modal("hide");
		sendGCode("M292 P1");
	});

	$('#modal_messagebox').on("hide.bs.modal", function() {
		if (messageBoxTimer != undefined) {
			clearTimeout(messageBoxTimer);
			messageBoxTimer = undefined;
		}

		// FIXME: This is needed to ensure the backdrop always works as intended
		$('#modal_messagebox').removeData();
	});

	/* Notification subsystem for Duet Web Control
	 *
	 * written by Christian Hammacher (c) 2016-2017
	 *
	 * licensed under the terms of the GPL v3
	 * see http://www.gnu.org/licenses/gpl-3.0.html
	 */


	var jsNotificationOptions = {
		animate: {
			enter: 'animated fadeInDown',
			exit: 'animated fadeOutDown'
		},
		placement: {
			from: "bottom",
			align: "center"
		},
		template: '<div data-notify="container" class="col-xs-11 col-sm-9 col-md-8 col-lg-5 alert alert-{0}" role="alert">' +
			'<button type="button" aria-hidden="true" class="close" data-notify="dismiss">×</button>' +
			'<span data-notify="icon"></span> ' +
			'<span data-notify="title">{1}</span> ' +
			'<span data-notify="message">{2}</span>' +
			'<div class="progress" data-notify="progressbar">' +
			'<div class="progress-bar progress-bar-{0}" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;"></div>' +
			'</div>' +
			'<a href="{3}" target="{4}" data-notify="url"></a>' +
			'</div>'
	};

	// Apply custom options for JS plugin
	$.notifyDefaults(jsNotificationOptions);

	function showDownloadMessage() {
		var notifySettings = { icon: "glyphicon glyphicon-compressed",
			title: "<strong>" + T("Downloading Files") + "</strong><br/><br/>",
			message: T("Please wait while the selected files are being downloaded...")
		};
		var options = { type: "info",
			allow_dismiss: false,
			delay: -1,
			showProgressbar: true
		};
		return $.notify(notifySettings, options);
	}

	function showHaltMessage() {
		// Display backdrop and hide it when ready
		$("#modal_backdrop").modal("show");
		setTimeout(function() {
			$("#modal_backdrop").modal("hide");
		}, settings.haltedReconnectDelay);

		// Display notification
		var notifySettings = { icon: "glyphicon glyphicon-flash",
			title: "<strong>" + T("Emergency STOP") + "</strong><br/><br/>",
			message: T("Please wait while the firmware is restarting..."),
			progress: settings.haltedReconnectDelay / 100,
		};
		var options = { type: "warning",
			allow_dismiss: false,
			delay: settings.haltedReconnectDelay,
			timeout: 1000,
			showProgressbar: true
		};
		var notification = $.notify(notifySettings, options);
		$(notification.$ele).css("z-index", 9999);
	}

	function showMessage(type, title, message, timeout, allowDismiss) {
		// Set default arguments
		if (timeout == undefined) { timeout = settings.notificationTimeout; }
		if (allowDismiss == undefined) { allowDismiss = true; }

		// Check if an HTML5 notification shall be displayed
		if (document.hidden && settings.useHtmlNotifications) {
			// HTML5 notifications expect plain strings. Remove potential styles first
			if (title.indexOf("<") != -1) { title = $("<span>" + title + "</span>").text(); }
			if (message.indexOf("<") != -1) { message = $("<span>" + message + "</span>").text(); }

			// Create new notification and display it
			var options = {
				body: message,
				icon: "favicon.ico",
				dir : "ltr",
				requireInteraction: allowDismiss
			};
			var notification = new Notification(title, options);
			if (allowDismiss) { notification.onclick = function() { this.close(); }; }
			if (timeout > 0) { setTimeout(function() { notification.close(); }, timeout); }
			return notification;
		}

		// Otherwise display a JQuery notification. Find a suitable icon first
		var icon = "glyphicon glyphicon-info-sign";
		if (type == "warning") {
			icon = "glyphicon glyphicon-warning-sign";
		} else if (type == "danger") {
			icon = "glyphicon glyphicon-exclamation-sign";
		}

		// Check if the title can be displayed as bold text
		if (title != "")
		{
			if (title.indexOf("<strong>") == -1)
			{
				title = "<strong>" + title + "</strong>";
			}
			title += "<br/><br/>";
		}

		// Show the notification
		var notifySettings = { icon: icon,
			title: title,
			message: message};
		var options = { type: type,
			allow_dismiss: (allowDismiss == undefined) ? true : allowDismiss,
			delay: (timeout == undefined) ? settings.notificationTimeout : timeout };
		var notification = $.notify(notifySettings, options);
		if (allowDismiss == undefined || allowDismiss) {
			$(notification.$ele).click(function() {
				notification.close();
			});
		}
		return notification;
	}

	function showUpdateMessage(type, customTimeout) {
		// Determine the message and timespan for the notification
		var title, message, timeout;
		switch (type) {
			case 0: // Firmware
				title = T("Updating Firmware...");
				message = T("Please wait while the firmware is being updated...");
				timeout = settings.updateReconnectDelay;
				break;

			case 1: // Duet WiFi Server
				title = T("Updating WiFi Server...");
				message = T("Please wait while the Duet WiFi Server firmware is being updated...");
				timeout = settings.dwsReconnectDelay;
				break;

			case 2: // Duet Web Control
				title = T("Updating Web Interface...");
				message = T("Please wait while Duet Web Control is being updated...");
				timeout = settings.dwcReconnectDelay;
				break;

			case 3: // Multiple Updates
				title = T("Updating Firmware...");
				message = T("Please wait while multiple firmware updates are being installed...");
				timeout = customTimeout;
				break;

			default: // Unknown
				alert(T("Error! Unknown update parameter!"));
				return;
		}

		// Display backdrop and hide it when ready
		$("#modal_backdrop").modal("show");
		setTimeout(function() {
			$("#modal_backdrop").modal("hide");
		}, timeout);

		// Display notification
		var notifySettings = { icon: "glyphicon glyphicon-time",
			title: "<strong>" + title + "</strong><br/><br/>",
			message: message,
			progress: timeout / 100,
		};
		var options = { type: "success",
			allow_dismiss: false,
			delay: timeout,
			timeout: 1000,
			showProgressbar: true
		};
		var notification = $.notify(notifySettings, options);
		$(notification.$ele).css("z-index", 9999);
		return notification;
	}

	/* Settings management for Duet Web Control
	 *
	 * written by Christian Hammacher (c) 2016-2017
	 *
	 * licensed under the terms of the GPL v3
	 * see http://www.gnu.org/licenses/gpl-3.0.html
	 */


	var settings = {
		autoConnect: true,				// automatically connect once the page has loaded
		lastHost: "",					// only used on localhost
		updateInterval: 250,			// in ms
		extendedStatusInterval: 10,		// nth status request will include extended values
		maxRetries: 1,					// number of AJAX retries before the connection is terminated

		haltedReconnectDelay: 10000,	// in ms (increased from 5000 for Duet WiFi)
		updateReconnectDelay: 20000,	// in ms
		dwsReconnectDelay: 45000,		// in ms
		dwcReconnectDelay: 225000,		// in ms

		confirmStop: false,				// ask for confirmation when pressing Emergency STOP
		useKiB: true,					// display file sizes in KiB instead of KB
		theme: "default",				// name of the theme to use
		scrollContent: true,			// make the main content scrollable on md+ resolutions
		language: "en",

		moveFeedrate: 6000,				// in mm/min
		halfZMovements: false,			// use half Z movements
		babysteppingZ: 0.05,			// in mm
		showATXControl: false,			// show ATX control

		showFan1: true,					// show fan controls for fan 1
		showFan2: false,				// show fan controls for fan 2
		showFan3: false,				// show fan controls for fan 3
		showFanRPM: false,				// show fan RPM in sensors

		logSuccess: false,				// log all sucessful G-Codes in the console
		uppercaseGCode: true,			// convert G-Codes to upper-case before sending them

		doTfree: true,					// tool
		doTpre: true,					// change
		doTpost: true,					// options

		useHtmlNotifications: false,	// whether HTML5-based notifications can be used
		notificationTimeout: 5000,		// in ms
		autoCloseUserMessages: false,	// whether M117 messages are automatically closed

		webcamURL: "",
		webcamInterval: 5000,			// in ms
		webcamFix: false,				// do not append extra HTTP qualifier when reloading images
		webcamEmbedded: false,			// use iframe to embed webcam stream

		defaultActiveTemps: [0, 180, 190, 200, 210, 220, 235],
		defaultStandbyTemps: [0, 95, 120, 140, 155, 170],
		defaultBedTemps: [0, 55, 60, 65, 90, 110, 120],
		defaultGCodes: [
			["M0", "Stop"],
			["M1", "Sleep"],
			["M84", "Motors Off"],
			["M561", "Disable bed compensation"]
		]
	};

	var defaultSettings = jQuery.extend(true, {}, settings);		// need to do this to get a valid copy

	var themeInclude;


	/* Setting methods */

	function loadSettings() {
		// Delete cookie and use localStorage instead
		document.cookie = "settings=; expires=Thu, 01 Jan 1970 00:00:00 UTC";

		// Try to parse the stored settings (if any)
		if (localStorage.getItem("settings") != null) {
			var loadedSettings = localStorage.getItem("settings");
			if (loadedSettings != undefined && loadedSettings.length > 0) {
				loadedSettings = JSON.parse(loadedSettings);

				for(var key in settings) {
					// Try to copy each setting if their types are equal
					if (loadedSettings.hasOwnProperty(key) && settings[key].constructor === loadedSettings[key].constructor) {
						settings[key] = loadedSettings[key];
					}
				}

				// Backward-compatibility
				if (loadedSettings.hasOwnProperty("useDarkTheme")) {
					settings.theme = loadedSettings.useDarkTheme ? "dark" : "default";
				}
			}
		}

		// Apply them
		applySettings();

		// Try to load the translation data
		$.ajax("language.xml", {
			type: "GET",
			dataType: "xml",
			global: false,
			error: function() {
				pageLoadComplete();
			},
			success: function(response) {
				translationData = response;

				if (translationData.children == undefined)
				{
					// Internet Explorer and Edge cannot deal with XML files in the way we want.
					// Disable translations for those browsers.
					translationData = undefined;
					$("#dropdown_language, #label_language").addClass("hidden");
				} else {
					$("#dropdown_language ul > li:not(:first-child)").remove();
					for(var i = 0; i < translationData.children[0].children.length; i++) {
						var id = translationData.children[0].children[i].tagName;
						var name = translationData.children[0].children[i].attributes["name"].value;
						$("#dropdown_language ul").append('<li><a data-language="' + id + '" href="#">' + name + '</a></li>');
						if (settings.language == id) {
							$("#btn_language > span:first-child").text(name);
						}
					}

					translatePage();
				}

				pageLoadComplete();
			}
		});
	}

	function applySettings() {
		/* Apply settings */

		// Set AJAX timeout
		$.ajaxSetup({ timeout: sessionTimeout / (settings.maxRetries + 1) });

		// Webcam
		if (settings.webcamURL != "") {
			$("#panel_webcam").removeClass("hidden");
			$("#img_webcam").toggleClass("hidden", settings.webcamEmbedded);
			$("#div_ifm_webcam").toggleClass("hidden", !settings.webcamEmbedded);

			updateWebcam(true);
		} else {
			$("#panel_webcam").addClass("hidden");
		}

		// Half Z Movements
		var decreaseChildren = $("#td_decrease_z a");
		var decreaseVal = (settings.halfZMovements) ? 50 : 100;
		decreaseChildren.each(function(index) {
			decreaseChildren.eq(index).data("z", decreaseVal * (-1)).contents().last().replaceWith(" Z-" + decreaseVal);
			decreaseVal /= 10;
		});
		var increaseChildren = $("#td_increase_z a");
		var increaseVal = (settings.halfZMovements) ? 0.05 : 0.1;
		increaseChildren.each(function(index) {
			increaseChildren.eq(index).data("z", increaseVal).contents().first().replaceWith("Z+" + increaseVal + " ");
			increaseVal *= 10;
		});

		decreaseVal = (settings.halfZMovements) ? 5 : 10;
		increaseVal = (settings.halfZMovements) ? 0.05 : 0.1;
		$("#div_z_controls > div > button[data-z]").each(function() {
			if ($(this).data("z") < 0) {
				$(this).data("z", decreaseVal * (-1)).contents().last().replaceWith(" -" + decreaseVal);
				decreaseVal /= 10;
			} else {
				$(this).data("z", increaseVal).contents().first().replaceWith("+" + increaseVal + " ");
				increaseVal *= 10;
			}
		});

		// Babystepping
		$("#btn_baby_down > span.content").text(T("{0} mm", (-settings.babysteppingZ)));
		$("#btn_baby_up > span.content").text(T("{0} mm ", "+" + settings.babysteppingZ));
		$(".babystepping").toggleClass("hidden", settings.babysteppingZ <= 0);

		// Show/Hide Fan Controls
		setFanVisibility(0, settings.showFan1);
		setFanVisibility(1, settings.showFan2);
		setFanVisibility(2, settings.showFan3);
		numFans = undefined;						// let the next status response callback hide fans that are not available

		// Show/Hide Fan RPM
		$(".fan-rpm").toggleClass("hidden", !settings.showFanRPM);
		$("#th_probe, #td_probe").css("border-right", settings.showFanRPM ? "" : "0px");

		// Show/Hide ATX Power
		$(".atx-control").toggleClass("hidden", !settings.showATXControl);

		// Apply or revoke theme
		if (themeInclude != undefined) {
			themeInclude.remove();
			themeInclude = undefined;
		}

		switch (settings.theme) {
			case "default":	// Default Bootstrap theme
				themeInclude = $('<link onload="applyThemeColors();" rel="stylesheet" href="css/bootstrap-theme.css" type="text/css"></link>');
				themeInclude.appendTo("head");
				$("#theme_notice").addClass("hidden");
				break;

			case "dark":	// Bootstrap theme + fotomas's customizations
				themeInclude = $('<link rel="stylesheet" href="css/bootstrap-theme.css" type="text/css"></link>' +
								 '<link onload="applyThemeColors();" rel="stylesheet" href="css/slate.css" type="text/css"></link>');
				themeInclude.appendTo("head");
				$("#theme_notice").removeClass("hidden");
				break;

			case "none":	// No theme at all
				applyThemeColors();
				$("#theme_notice").addClass("hidden");
				break;
		}

		// Make main content scrollable on md+ screens or restore default behavior
		$("#main_content").css("overflow-y", (settings.scrollContent) ? "auto" : "").resize();

		/* Set values on the Settings page */

		// Set input values
		for(var key in settings) {
			var element = $('[data-setting="' + key + '"]');
			if (element.length != 0) {
				var type = element.attr("type");
				if (type == "checkbox") {
					element.prop("checked", settings[key]);
				} else if (type == "number") {
					var factor = element.data("factor");
					if (factor == undefined) {
						factor = 1;
					}
					element.val(settings[key] / factor);
				} else if (type != "button") {
					element.val(settings[key]);
				}
			}
		}

		// Set theme selection
		$("#btn_theme").data("theme", settings.theme);
		var themeName = $('#dropdown_theme ul [data-theme="' + settings.theme + '"]').text();
		$("#btn_theme > span:first-child").text(themeName);

		// Language is set in XML AJAX handler

		// Default head temperatures
		clearHeadTemperatures();
		settings.defaultActiveTemps.forEach(function(temp) {
			addHeadTemperature(temp, "active");
		});
		settings.defaultStandbyTemps.forEach(function(temp) {
			addHeadTemperature(temp, "standby");
		});

		// Default bed temperatures
		clearBedTemperatures();
		settings.defaultBedTemps.forEach(function(temp) {
			addBedTemperature(temp);
		});

		// Default G-Codes
		clearDefaultGCodes();
		settings.defaultGCodes.forEach(function(entry) {
			addDefaultGCode(entry[1], entry[0]);
		});
	}

	function saveSettings() {
		// Get input values
		for(var key in settings) {
			var element = $('[data-setting="' + key + '"]');
			if (element.length != 0) {
				var type = element.attr("type");
				if (type == "checkbox") {
					settings[key] = element.is(":checked");
				} else if (type == "number") {
					var min = element.data("min");
					var max = element.data("max");
					var factor = element.data("factor");
					if (factor == undefined) {
						factor = 1;
					}
					settings[key] = constrainSetting(element.val() * factor, defaultSettings[key], min, max);
				} else {
					settings[key] = element.val();
				}
			}
		}

		// Save theme
		settings.theme = $("#btn_theme").data("theme");

		// Save language
		if (settings.language != $("#btn_language").data("language")) {
			showMessage("success", T("Language has changed"), T("You have changed the current language. Please reload the web interface to apply this change."), 0);
		}
		settings.language = $("#btn_language").data("language");

		// Default G-Codes
		settings.defaultGCodes = [];
		$("#table_gcodes > tbody > tr").each(function() {
			settings.defaultGCodes.push([$(this).find("label").text(), $(this).find("td:eq(1)").text()]);
		});
		settings.defaultGCodes = settings.defaultGCodes.sort(function(a, b) {
			if (a[0][0] != b[0][0]) {
				return a[0].charCodeAt(0) - b[0].charCodeAt(0);
			}
			var x = a[0].match(/(\d+)/g)[0];
			var y = b[0].match(/(\d+)/g)[0];
			if (x == undefined || y == undefined) {
				return parseInt(a[0]) - parseInt(b[0]);
			}
			return x - y;
		});

		// Default Heater Temperatures
		settings.defaultActiveTemps = [];
		$("#ul_active_temps > li").each(function() {
			settings.defaultActiveTemps.push($(this).data("temperature"));
		});
		settings.defaultActiveTemps = settings.defaultActiveTemps.sort(function(a, b) { return a - b; });
		settings.defaultStandbyTemps = [];
		$("#ul_standby_temps > li").each(function() {
			settings.defaultStandbyTemps.push($(this).data("temperature"));
		});
		settings.defaultStandbyTemps = settings.defaultStandbyTemps.sort(function(a, b) { return a - b; });

		// Default Bed Temperatures
		settings.defaultBedTemps = [];
		$("#ul_bed_temps > li").each(function() {
			settings.defaultBedTemps.push($(this).data("temperature"));
		});
		settings.defaultBedTemps = settings.defaultBedTemps.sort(function(a, b) { return a - b; });

		// Save Settings
		localStorage.setItem("settings", JSON.stringify(settings));
	}

	function constrainSetting(value, defaultValue, minValue, maxValue) {
		if (isNaN(value)) {
			return defaultValue;
		}
		if (value < minValue) {
			return minValue;
		}
		if (value > maxValue) {
			return maxValue;
		}

		return value;
	}


	/* Setting events */

	// Apply & Reset settings

	$("#btn_reset_settings").click(function(e) {
		showConfirmationDialog(T("Reset Settings"), T("Are you sure you want to revert to Factory Settings?"), function() {
			if (defaultSettings.language != settings.language) {
				showMessage("info", T("Language has changed"), T("You have changed the current language. Please reload the web interface to apply this change."), 0);
			}

			settings = jQuery.extend(true, {}, defaultSettings);
			$("#btn_language").data("language", "en").children("span:first-child").text("English");
			$("#btn_theme").data("theme", "default").children("span:first-child").text(T("Bootstrap"));

			applySettings();
			saveSettings();

			localStorage.removeItem("extraSensorVisibility");
			resetChartData();

			localStorage.removeItem("cachedFileInfo");
		});
		e.preventDefault();
	});

	$("#frm_settings").submit(function(e) {
		saveSettings();
		applySettings();
		showMessage("success", "", "<strong>" + T("Settings applied!") + "</strong>");
		e.preventDefault();
	});

	$("#frm_settings > ul > li a").on("shown.bs.tab", function(e) {
		$("#frm_settings > ul li").removeClass("active");
		var links = $('#frm_settings > ul > li a[href="' + $(this).attr("href") + '"]');
		$.each(links, function() {
			$(this).parent().addClass("active");
		});
	});

	// User Interface

	$("#dropdown_theme > ul a").click(function(e) {
		$("#btn_theme > span:first-child").text($(this).text());
		$("#btn_theme").data("theme", $(this).data("theme"));
		e.preventDefault();
	});

	$("body").on("click", "#dropdown_language > ul a", function(e) {
		$("#btn_language > span:first-child").text($(this).text());
		$("#btn_language").data("language", $(this).data("language"));
		e.preventDefault();
	});

	$('a[href="#page_ui"]').on('shown.bs.tab', function () {
		$("#btn_clear_cache").toggleClass("disabled", $.isEmptyObject(cachedFileInfo));
	});

	$("#btn_clear_cache").click(function(e) {
		gcodeUpdateIndex = -1;
		clearFileCache();
		$("#btn_clear_cache").addClass("disabled");
		e.preventDefault();
	});

	$("[data-setting='useHtmlNotifications']").change(function() {
		if ($(this).prop("checked")) {
			if (!("Notification" in window)) {
				// Don't allow this option to be set if the browser doesn't support it
				$(this).prop("checked", false);
				alert(T("This browser does not support desktop notification"));
			}
			else if (Notification.permission !== 'denied') {
				$(this).prop("checked", false);
				Notification.requestPermission(function(permission) {
					if (!('permission' in Notification)) {
						Notification.permission = permission;
					}

					if (permission === "granted") {
						// Don't allow this option to be set unless permission has been granted
						$("[data-setting='useHtmlNotifications']").prop("checked", true);
					}
				});
			}
		}
	});

	// List Items

	$("#btn_add_gcode").click(function(e) {
		var item =	'<tr><td><label class="label label-primary">' + $("#input_gcode").val().trim() + '</label></td><td>' + $("#input_gcode_description").val().trim() + '</td><td>';
		item +=		'<button class="btn btn-sm btn-danger btn-delete-parent" title="' + T("Delete this G-Code item") + '">';
		item += 	'<span class="glyphicon glyphicon-trash"></span></button></td></tr>';
		$("#table_gcodes > tbody").append(item);

		e.preventDefault();
	});

	$("input[name='temp_selection']:radio").change(function() {
		if ($(this).val() == "active") {
			$("#ul_active_temps").removeClass("hidden");
			$("#ul_standby_temps").addClass("hidden");
		} else {
			$("#ul_standby_temps").removeClass("hidden");
			$("#ul_active_temps").addClass("hidden");
		}
	});

	$("#btn_add_head_temp").click(function(e) {
		var temperature = constrainSetting($("#input_add_head_temp").val(), 0, -273.15, 300);
		var type = $('input[name="temp_selection"]:checked').val();

		var item =	'<li class="list-group-item col-xs-6 col-lg-3" data-temperature="' + temperature + '">' + temperature + ' °C';
		item +=		'<button class="btn btn-danger btn-sm btn-delete-parent pull-right" title="' + T("Delete this temperature item") + '">';
		item +=		'<span class="glyphicon glyphicon-trash"></span></button></li>';
		$("#ul_" + type + "_temps").append(item);

		e.preventDefault();
	});

	$("#btn_add_bed_temp").click(function(e) {
		var temperature = constrainSetting($("#input_add_bed_temp").val(), 0, -273.15, 180);

		var item =	'<li class="list-group-item col-md-6" data-temperature="' + temperature + '">' + temperature + ' °C';
		item +=		'<button class="btn btn-danger btn-sm btn-delete-parent pull-right" title="' + T("Delete this temperature item") + '">';
		item +=		'<span class="glyphicon glyphicon-trash"></span></button></li>';
		$("#ul_bed_temps").append(item);

		e.preventDefault();
	});

	$("body").on("click", ".btn-delete-parent", function(e) {
		$(this).parents("tr, li").remove();
		e.preventDefault();
	});

	$("#page_listitems input").on("input", function() {
		// Validate form controls
		$("#btn_add_gcode").toggleClass("disabled", $("#input_gcode").val().trim() == "" || $("#input_gcode_description").val().trim() == "");
		$("#btn_add_head_temp").toggleClass("disabled", isNaN(parseFloat($("#input_add_head_temp").val())));
		$("#btn_add_bed_temp").toggleClass("disabled", isNaN(parseFloat($("#input_add_bed_temp").val())));
	});

	$("#page_listitems input").keydown(function(e) {
		if (e.which == 13) {
			var button = $(this).closest("div:not(.input-group):eq(0)").find("button");
			if (!button.hasClass("disabled")) {
				button.click();
			}
			e.preventDefault();
		}
	});

	// Machine Properties

	$("#btn_fw_diagnostics").click(function() {
		if (isConnected) {
			sendGCode("M122");
			showPage("console");
		}
	});

	// Tools

	$("#btn_add_tool").click(function(e) {
		var gcode = "M563 P" + $("#input_tool_number").val() + " S\"" + $("#input_tool_name").val() + "\"";

		var drives = $("input[name='tool_drives']:checked");
		if (drives.length > 0) {
			var driveList = [];
			drives.each(function() { driveList.push($(this).val()); });
			gcode += " D" + driveList.reduce(function(a, b) { return a + ":" + b; });
		}

		var heaters = $("input[name='tool_heaters']:checked");
		if (heaters.length > 0) {
			var heaterList = [];
			heaters.each(function() { heaterList.push($(this).val()); });
			gcode += " H" + heaterList.reduce(function(a, b) { return a + ":" + b; });
		}

		sendGCode(gcode);
		extendedStatusCounter = settings.extendedStatusInterval;

		e.preventDefault();
	});

	// Display toggle for settings sub-pages

	$('a[href="#page_general"], a[href="#page_ui"], a[href="#page_listitems"]').on('shown.bs.tab', function () {
		$("#row_save_settings, #btn_reset_settings").removeClass("hidden");
	});

	$('a[href="#page_machine"], a[href="#page_tools"], a[href="#page_sysedit"]').on('shown.bs.tab', function () {
		$("#row_save_settings").addClass("hidden");
	});

	// Piecon settings

	Piecon.setOptions({
		color: "#0000ff",		// Pie chart color
		background: "#bbb",		// Empty pie chart color
		shadow: "#fff",			// Outer ring color
		fallback: "force"		// Toggles displaying percentage in the title bar (possible values - true, false, 'force')
	});

	/* Slider implementation for the Duet Web Control
	 *
	 * written by Christian Hammacher (c) 2016-2017
	 *
	 * licensed under the terms of the GPL v3
	 * see http://www.gnu.org/licenses/gpl-3.0.html
	 */


	var fanSliderActive, speedSliderActive, extrSliderActive;
	var overriddenFanValues = [undefined, undefined, undefined];	// this must have maxFans items


	/* Fan Control */

	$('#slider_fan_control').slider({
		enabled: false,
		id: "fan_control",
		min: 0,
		max: 100,
		step: 1,
		value: 35,
		tooltip: "always",

		formatter: function(value) {
			return value + " %";
		}
	}).on("slideStart", function() {
		fanSliderActive = true;
	}).on("slideStop", function(slideEvt) {
		if (isConnected && !isNaN(slideEvt.value)) {
			var fan = getFanSelection();
			var fanValue = slideEvt.value / 100.0;

			if (overriddenFanValues[fan] != undefined) {
				overriddenFanValues[fan] = fanValue;
			}
			sendGCode("M106 P" + fan + " S" + fanValue);

			$("#slider_fan_print").slider("setValue", slideEvt.value);
		}
		fanSliderActive = false;
	});

	$('#slider_fan_print').slider({
		enabled: false,
		id: "fan_print",
		min: 0,
		max: 100,
		step: 1,
		value: 35,
		tooltip: "always",

		formatter: function(value) {
			return value + " %";
		}
	}).on("slideStart", function() {
		fanSliderActive = true;
	}).on("slideStop", function(slideEvt) {
		if (isConnected && !isNaN(slideEvt.value)) {
			var fan = getFanSelection();
			var fanValue = slideEvt.value / 100.0;

			if (overriddenFanValues[fan] != undefined) {
				overriddenFanValues[fan] = fanValue;
			}
			sendGCode("M106 P" + fan + " S" + fanValue);

			$("#slider_fan_control").slider("setValue", slideEvt.value);
		}
		fanSliderActive = false;
	});

	function setFanVisibility(fan, visible) {
		var visibleFans = $(".table-fan-control [data-fan]:not(.hidden)");

		// update selection and check if the whole panel can be hidden
		var hideFanControl = false;
		if (visible) {
			if (visibleFans.length == 0) {
				// set selected fan to this fan
				setFanSelection(fan);
			}
		} else {
			var firstVisibleFan;
			visibleFans.each(function() {
				if ($(this).data("fan") != fan) {
					firstVisibleFan = $(this);
					return false;
				}
			});

			hideFanControl = (firstVisibleFan == undefined);
			if (!hideFanControl) {
				// set selected fan to first visible fan
				setFanSelection(firstVisibleFan.data("fan"));
			}
		}

		$(".fan-control").toggleClass("hidden", hideFanControl);
		if (hideFanControl) {
			// Hide entire misc control panel if ATX control is hidden
			$("#panel_control_misc").toggleClass("hidden", !settings.showATXControl);
		}

		// set visibility of control buttons
		$('.table-fan-control [data-fan="' + fan + '"]').toggleClass("hidden", !visible);

		// if this fan value is being enforced, undo it
		setFanOverride(fan, undefined);
	}

	function getFanSelection() {
		return $(".table-fan-control button.btn-primary.fan-selection").data("fan");
	}

	function setFanSelection(fan) {
		$(".table-fan-control button.fan-selection").removeClass("btn-primary").removeClass("active").addClass("btn-default");
		$('.table-fan-control button.fan-selection[data-fan="' + fan + '"]').removeClass("btn-default").addClass("btn-primary").addClass("active");
	}

	function setFanOverride(fan, overriddenValue) {
		// set model value
		overriddenFanValues[fan] = overriddenValue;

		// update UI
		var overridden = (overriddenValue != undefined);
		var toggleButton = $('.table-fan-control button.fan-override[data-fan="' + fan + '"]');
		toggleButton.toggleClass("btn-primary", overridden).toggleClass("btn-default", !overridden);
		toggleButton.toggleClass("active", overridden);
	}

	$("button.fan-selection").click(function() {
		var fan = $(this).data("fan");
		if ($(this).hasClass("disabled") || fan == getFanSelection()) {
			// only apply other values if the selection has changed
			return;
		}
		setFanSelection(fan);

		var fanValue = overriddenFanValues[fan];
		if (fanValue == undefined && lastStatusResponse != undefined) {
			// this is only called if the firmware reports fan values as an array
			fanValue = lastStatusResponse.params.fanPercent[fan] / 100.0;
		}
		if (fanValue != undefined) {
			$(".fan-slider").children("input").slider("setValue", fanValue * 100.0);
		}
	});

	$("button.fan-override").click(function() {
		var fan = $(this).data("fan");
		if ($(this).hasClass("disabled")) {
			return;
		}

		if (overriddenFanValues[fan] == undefined) {
			if (fan == getFanSelection()) {
				var sliderValue = $(".fan-slider").children("input").slider("getValue") / 100.0;
				setFanOverride(fan, sliderValue);
			}
		} else {
			setFanOverride(fan, undefined);
		}
	});


	/* Extrusion Multiplier */

	for(var extr = 1; extr <= maxExtruders; extr++) {
		$('#slider_extr_' + extr).slider({
			enabled: false,
			id: "extr-" + extr,
			min: 50,
			max: 150,
			step: 1,
			value: 100,
			tooltip: "always",

			formatter: function(value) {
				return value + " %";
			}
		}).on("slideStart", function() {
			extrSliderActive = true;
		}).on("slideStop", function(slideEvt) {
			if (isConnected && !isNaN(slideEvt.value)) {
				sendGCode("M221 D" + $(this).data("drive") + " S" + slideEvt.value);
			}
			extrSliderActive = false;
		});
	}


	/* Speed slider */

	$('#slider_speed').slider({
		enabled: false,
		id: "speed",
		min: 20,
		max: 300,
		step: 1,
		value: 100,
		tooltip: "always",

		formatter: function(value) {
			return value + " %";
		}
	}).on("slideStart", function() {
		speedSliderActive = true;
	}).on("slideStop", function(slideEvt) {
		if (isConnected && !isNaN(slideEvt.value)) {
			sendGCode("M220 S" + slideEvt.value);
		}
		speedSliderActive = false;
	});
	/* Upload handling for Duet Web Control
	 *
	 * written by Christian Hammacher (c) 2016-2017
	 *
	 * licensed under the terms of the GPL v3
	 * see http://www.gnu.org/licenses/gpl-3.0.html
	 */


	var isUploading = false;					// Is a file upload in progress?

	var uploadType, uploadFiles, uploadRows, uploadedFileCount;
	var uploadTotalBytes, uploadedTotalBytes;
	var uploadStartTime, uploadRequest, uploadFileSize, uploadFileName, uploadPosition;
	var uploadedDWC, uploadIncludedConfig, uploadFirmwareFile, uploadDWCFile, uploadDWSFile, uploadDWSSFile;
	var uploadHadError, uploadFilesSkipped;

	var firmwareFileName = "RepRapFirmware";	// Name of the firmware file without .bin extension


	function uploadTextFile(filename, content, callback, showNotification, configFileHandled) {
		if (showNotification == undefined) { showNotification = true; }
		if (configFileHandled == undefined) { configFileHandled = false; }

		// Move config.g to config.g.bak if it is overwritten
		if (filename == "0:/sys/config.g" && !configFileHandled && $("#table_sys_files tr[data-file='config.g']").length != 0) {
			if ($("#table_sys_files tr[data-file='config.g.bak']").length == 0) {
				$.ajax(ajaxPrefix + "rr_move?old=0:/sys/config.g&new=0:/sys/config.g.bak", {
					dataType: "json",
					success: function() {
						uploadTextFile(filename, content, callback, showNotification, true);
					}
				});
			} else {
				$.ajax(ajaxPrefix + "rr_delete?name=0:/sys/config.g.bak", {
					dataType: "json",
					success: function() {
						$.ajax(ajaxPrefix + "rr_move?old=0:/sys/config.g&new=0:/sys/config.g.bak", {
							dataType: "json",
							success: function() {
								uploadTextFile(filename, content, callback, showNotification, true);
							}
						});
					}
				});
			}
			return;
		}

		// Ideally we should use FileAPI here, but IE+Edge don't support it
		//var file = new File([content], filename, { type: "application/octet-stream" });
		var file = new Blob([content], { type: "application/octet-stream" });
		file.name = filename;
		file.lastModified = (new Date()).getTime();

		var uploadRequest = $.ajax(ajaxPrefix + "rr_upload?name=" + encodeURIComponent(filename) + "&time=" + encodeURIComponent(timeToStr(new Date())), {
			data: file,
			dataType: "json",
			filename: filename,
			processData: false,
			contentType: false,
			timeout: 0,
			type: "POST",
			global: false,
			error: function(jqXHR, textStatus, errorThrown) {
				finishCurrentUpload(false);
			},
			success: function(response) {
				if (response.err == 0) {
					if (showNotification) {
						showMessage("success", T("File Updated"), T("The file {0} has been successfully uploaded.", this.filename));
						if (lastStatusResponse != undefined && lastStatusResponse.status == 'I') {
							if (this.filename.toLowerCase() == "0:/sys/config.g") {
								showConfirmationDialog(T("Reboot Duet?"), T("You have just uploaded a config file. Would you like to reboot your Duet now?"), function() {
									// Perform software reset
									sendGCode("M999");
								});
							}
						}
					}
				} else {
					showMessage("danger", T("Error"), T("Could not update file {0}!", this.filename));
				}

				if (callback != undefined) {
					callback();
				}
			}
		});
	}

	function startUpload(type, files, fromCallback) {
		// Unzip files if necessary
		if (type == "filament" || type == "macro" || type == "generic") {
			var containsZip = false;
			$.each(files, function() {
				if (this.name.toLowerCase().match("\\.zip$") != null) {
					uploadedDWC |= this.name.toLowerCase().match("^duetwebcontrol.*\\.zip") != null;

					var fileReader = new FileReader();
					fileReader.onload = (function(theFile) {
						return function(e) {
							try {
								var zipFile = new JSZip(), filesToUnpack = 0, filesUnpacked = 0;
								zipFile.loadAsync(e.target.result).then(function(zip) {
									var zipFiles = [];
									$.each(zip.files, function(index, zipEntry) {
										if (!zipEntry.dir && zipEntry.name.indexOf(".") != 0 && zipEntry.name.match("README") == null) {
											var zipName = zipEntry.name;
											if (type != "filament") {
												zipName = zipEntry.name.split("/");
												zipName = zipName[zipName.length - 1];
											}

											filesToUnpack++;
											zipEntry.async("arraybuffer").then(function(buffer) {
												// See above. FileAPI isn't supported by IE+Edge
												//var unpackedFile = new File([zipEntry.asArrayBuffer()], zipName, { type: "application/octet-stream", lastModified: zipEntry.date });
												var unpackedFile = new Blob([buffer], { type: "application/octet-stream" });
												unpackedFile.name = zipName;
												unpackedFile.lastModified = zipEntry.date;
												zipFiles.push(unpackedFile);

												filesUnpacked++;
												if (filesToUnpack == filesUnpacked) {
													// This had to be moved because the new JSZip API is completely async
													startUpload(type, zipFiles, true);
												}
											});
										}
									});

									if (zip.files.length == 0) {
										showMessage("warning", T("Error"), T("The archive {0} does not contain any files!", theFile.name));
									}
								});
							} catch(e) {
								console.log("ZIP error: " + e);
								showMessage("danger", T("Error"), T("Could not read contents of file {0}!", theFile.name));
							}
						}
					})(this);
					fileReader.readAsArrayBuffer(this);

					containsZip = true;
					return false;
				}
			});

			if (containsZip) {
				// We're relying on an async task which will trigger this method again when required
				return false;
			}
		}

		// Safety check for Upload and Print
		if (type == "print" && files.length > 1) {
			showMessage("warning", T("Error"), T("You can only upload and print one file at once!"));
			return false;
		}

		// Safety check for Filament uploads
		if (type == "filament") {
			var hadError = false;
			$.each(files, function() {
				if (this.name.indexOf("/") == -1) {
					showMessage("danger", T("Error"), T("You cannot upload single files. Please upload only ZIP files that contain at least one directory per filament configuration."));
					hadError = true;
					return false;
				}
			});
			if (hadError) {
				return false;
			}
		}

		// Initialize some values
		stopUpdates();
		isUploading = true;
		uploadType = type;
		uploadTotalBytes = uploadedTotalBytes = uploadedFileCount = 0;
		uploadFiles = files;
		$.each(files, function() {
			uploadTotalBytes += this.size;
		});
		uploadRows = [];
		if (!fromCallback) {
			uploadedDWC = false;
		}
		uploadIncludedConfig = false;
		uploadFirmwareFile = uploadDWCFile = uploadDWSFile = uploadDWSSFile = undefined;
		uploadFilesSkipped = uploadHadError = false;

		// Reset modal dialog
		$("#modal_upload").data("backdrop", "static");
		$("#modal_upload .close, #modal_upload button[data-dismiss='modal']").addClass("hidden");
		$("#btn_cancel_upload, #modal_upload p").removeClass("hidden");
		$("#modal_upload h4").text(T("Uploading File(s), {0}% Complete", 0));

		// Add files to the table
		$("#table_upload_files > tbody").children().remove();
		$.each(files, function() {
			if (type == "generic") {
				// config and firmware files can be always uploaded
				uploadIncludedConfig |= (this.name == "config.g");
				if (this.name.toUpperCase().match("^" + firmwareFileName.toUpperCase() + ".*\.BIN") != null) {
					uploadFirmwareFile = this.name;
				}

				// DuetWiFi-specific files can be used only on a Duet WiFi
				if (boardType.indexOf("duetwifi") == 0) {
					if (this.name.toUpperCase().match("^DUETWIFISOCKETSERVER.*\.BIN") != null) {
						uploadDWSSFile = this.name;
					} else if (this.name.toUpperCase().match("^DUETWIFISERVER.*\.BIN") != null) {
						uploadDWSFile = this.name;
					} else if (this.name.toUpperCase().match("^DUETWEBCONTROL.*\.BIN") != null) {
						uploadDWCFile = this.name;
					}
				}
			}

			var row = 	'<tr><td><span class="glyphicon glyphicon-asterisk"></span> ' + this.name + '</td>';
			row += 		'<td>' + formatSize(this.size) + '</td>';
			row +=		'<td><div class="progress"><div class="progress-bar progress-bar-info progress-bar-striped" role="progressbar"><span></span></div></div></td></tr>';

			var rowElem = $(row);
			rowElem.appendTo("#table_upload_files > tbody");
			uploadRows.push(rowElem);
		});
		$("#modal_upload").modal("show");

		// Start file upload
		uploadNextFile();
	}

	function uploadNextFile() {
		// Prepare some upload values
		var file = uploadFiles[uploadedFileCount];
		uploadFileName = file.name;
		uploadFileSize = file.size;
		uploadStartTime = new Date();
		uploadPosition = 0;

		// Check if this file should be skipped
		if (uploadType == "generic") {
			var skipFile = false;

			if (!filenameValid(uploadFileName)) {
				// Skip files that contain invalid characters
				skipFile = true;
				showMessage("danger", T("Error"), T("The specified filename is invalid. It may not contain quotes, colons or (back)slashes."));
			} else if (boardType.indexOf("duetwifi") != 0) {
				var lcName = uploadFileName.toLowerCase();

				// Skip DuetWebControl*.bin on wired Duets
				if (lcName.match("^duetwebcontrol.*\\.bin") != null) {
					skipFile = true;
				}

				// Skip DuetWiFiServer*.bin and DuetWiFiSocketServer*.bin on wired Duets
				if (lcName.match("^duetwifiserver.*\\.bin") != null || lcName.match("^duetwifisocketserver.*\\.bin") != null) {
					skipFile = true;
				}
			}

			if (skipFile) {
				fileUploadSkipped();
				return;
			}
		}

		// Determine the right path
		var targetPath = "";
		switch (uploadType) {
			case "gcode":	// Upload G-Code
			case "print":	// Upload & Print G-Code
				targetPath = currentGCodeDirectory + "/" + uploadFileName;
				clearFileCache(targetPath);
				break;

			case "macro":	// Upload Macro
				targetPath = currentMacroDirectory + "/" + uploadFileName;
				break;

			case "filament": // Filament (only to sub-directories)
				targetPath = "0:/filaments/" + uploadFileName;
				break;

			default:		// Generic Upload (on the Settings page)
				var fileExts = uploadFileName.split('.');
				var fileExt = fileExts.pop().toLowerCase();
				if (fileExt == "gz") {
					// If this file was compressed, try to get the actual extension
					fileExt = fileExts.pop();
				}

				switch (fileExt) {
					case "ico":
					case "html":
					case "htm":
					case "xml":
						targetPath = "0:/www/" + uploadFileName;
						break;

					case "css":
					case "map":
						targetPath = "0:/www/css/" + uploadFileName;
						break;

					case "eot":
					case "svg":
					case "ttf":
					case "woff":
					case "woff2":
						targetPath = "0:/www/fonts/" + uploadFileName;
						break;

					case "jpeg":
					case "jpg":
					case "png":
						targetPath = "0:/www/img/" + uploadFileName;
						break;

					case "js":
						targetPath = "0:/www/js/" + uploadFileName;
						break;

					default:
						targetPath = "0:/sys/" + uploadFileName;
				}
		}

		// Update the GUI
		uploadRows[0].find(".progress-bar > span").text(T("Starting"));
		uploadRows[0].find(".glyphicon").removeClass("glyphicon-asterisk").addClass("glyphicon-cloud-upload");

		// Begin another POST file upload
		uploadRequest = $.ajax(ajaxPrefix + "rr_upload?name=" + encodeURIComponent(targetPath) + "&time=" + encodeURIComponent(timeToStr(new Date(file.lastModified))), {
			data: file,
			dataType: "json",
			processData: false,
			contentType: false,
			timeout: 0,
			type: "POST",
			global: false,
			error: function(jqXHR, textStatus, errorThrown) {
				finishCurrentUpload(false);
			},
			success: function(data) {
				if (isUploading) {
					finishCurrentUpload(data.err == 0);
				}
			},
			xhr: function() {
				var xhr = new window.XMLHttpRequest();
				xhr.upload.addEventListener("progress", function(event) {
					if (isUploading && event.lengthComputable) {
						// Calculate current upload speed (Date is based on milliseconds)
						uploadSpeed = event.loaded / (((new Date()) - uploadStartTime) / 1000);

						// Update global progress
						uploadedTotalBytes += (event.loaded - uploadPosition);
						uploadPosition = event.loaded;

						var uploadTitle = T("Uploading File(s), {0}% Complete", ((uploadedTotalBytes / uploadTotalBytes) * 100).toFixed(0));
						if (uploadSpeed > 0) {
							uploadTitle += " (" + formatUploadSpeed(uploadSpeed) + ")";
						}
						$("#modal_upload h4").text(uploadTitle);

						// Update progress bar
						var progress = ((event.loaded / event.total) * 100).toFixed(0);
						uploadRows[0].find(".progress-bar").css("width", progress + "%");
						uploadRows[0].find(".progress-bar > span").text(progress + " %");
					}
				}, false);
				return xhr;
			}
		});
	}

	function finishCurrentUpload(success) {
		// Keep the progress updated
		if (!success) {
			uploadHadError = true;
			uploadedTotalBytes += (uploadFileSize - uploadPosition);
		}

		// Update glyphicon and progress bar
		uploadRows[0].find(".glyphicon").removeClass("glyphicon-cloud-upload").addClass(success ? "glyphicon-ok" : "glyphicon-alert");
		uploadRows[0].find(".progress-bar").removeClass("progress-bar-info").addClass(success ? "progress-bar-success" : "progress-bar-danger").css("width", "100%");
		uploadRows[0].find(".progress-bar > span").text(success ? "100 %" : T("ERROR"));

		// Go on with upload logic if we're still busy
		if (isUploading) {
			uploadedFileCount++;
			if (uploadFiles.length > uploadedFileCount) {
				// Purge last-uploaded file row
				uploadRows.shift();

				// Upload the next one
				uploadNextFile();
			} else {
				// We're done
				finishUpload(!uploadHadError);
			}
		}
	}

	function fileUploadSkipped() {
		// Keep the progress updated
		uploadedTotalBytes += (uploadFileSize - uploadPosition);

		// Update glyphicon and progress bar
		uploadRows[0].find(".glyphicon").removeClass("glyphicon-cloud-asterisk").addClass("glyphicon-warning-sign");
		uploadRows[0].find(".progress-bar").removeClass("progress-bar-info").addClass("progress-bar-warning").css("width", "100%");
		uploadRows[0].find(".progress-bar > span").text(T("SKIPPED"));

		// Go on with upload logic if we're still busy
		uploadFilesSkipped = true;
		if (isUploading) {
			uploadedFileCount++;
			if (uploadFiles.length > uploadedFileCount) {
				// Purge last-uploaded file row
				uploadRows.shift();

				// Upload the next one
				uploadNextFile();
			} else {
				// We're done
				finishUpload(true);
			}
		}
	}

	function cancelUpload() {
		isUploading = uploadFilesSkipped = false;
		finishCurrentUpload(false);
		uploadRequest.abort();
		finishUpload(false);
		$("#modal_upload h4").text(T("Upload Cancelled!"));
		startUpdates();
	}

	function finishUpload(success) {
		// Reset upload variables
		isUploading = false;
		uploadFiles = uploadRows = [];
		$("#input_file_upload").val("");

		// Set some values in the modal dialog
		$("#modal_upload h4").text(T("Upload Complete!"));
		$("#btn_cancel_upload, #modal_upload p").addClass("hidden");
		$("#modal_upload .close, #modal_upload button[data-dismiss='modal']").removeClass("hidden");

		if (success) {
			// If everything went well, update the GUI immediately
			uploadHasFinished(true);
		} else {
			// In case an upload has been aborted, give the firmware some time to recover
			setTimeout(function() { uploadHasFinished(false); }, 1000);
		}
	}

	function uploadHasFinished(success) {
		// Make sure the G-Codes and Macro pages are updated
		if (uploadType == "gcode" || uploadType == "print") {
			gcodeUpdateIndex = -1;
			if (currentPage == "files") {
				updateGCodeFiles();
			}
		} else if (uploadType == "macro") {
			macroUpdateIndex = -1;
			if (currentPage == "control" || currentPage == "macros") {
				updateMacroFiles();
			}
		} else if (uploadType == "filament") {
			if (currentPage == "filaments") {
				updateFilaments();
			}
		}

		// Start polling again
		startUpdates();

		// Deal with different upload types
		if (success) {
			// Check if a print is supposed to be started
			if (uploadType == "print") {
				waitingForPrintStart = true;
				sendGCode("M32 " + currentGCodeDirectory + "/" + uploadFileName);
			}

			// Ask for page reload if DWC has been updated (wired Duets, DWC on SD card)
			if (uploadedDWC) {
				$("#modal_upload").modal("hide");

				if (sessionPassword != defaultPassword) {
					connect(sessionPassword, false);

					showConfirmationDialog(T("Reload Page?"), T("You have just updated Duet Web Control. Would you like to reload the page now?"), function() {
						location.reload();
					});
				} else {
					location.reload();
				}
			}

			// Ask for software reset if it's safe to do
			else if (lastStatusResponse != undefined && lastStatusResponse.status == 'I') {
				// Test for firmware update before we test for a new config file, because a firmware update includes a reset
				if (uploadFirmwareFile != undefined && uploadDWSFile == undefined && uploadDWSSFile == undefined && uploadDWCFile == undefined) {
					$("#modal_upload").modal("hide");
					showConfirmationDialog(T("Perform Firmware Update?"), T("You have just uploaded a firmware file. Would you like to update your Duet now?"), startFirmwareUpdate);
				} else if ((uploadDWSFile != undefined || uploadDWSSFile != undefined) && uploadFirmwareFile == undefined && uploadDWCFile == undefined) {
					$("#modal_upload").modal("hide");
					showConfirmationDialog(T("Perform WiFi Server Update?"), T("You have just uploaded a Duet WiFi server firmware file. Would you like to install it now?"), startDWSUpdate);
				} else if (uploadDWCFile != undefined && uploadFirmwareFile == undefined && uploadDWSFile == undefined && uploadDWSSFile == undefined) {
					$("#modal_upload").modal("hide");
					showConfirmationDialog(T("Perform Duet Web Control Update?"), T("You have just uploaded a Duet Web Control package. Would you like to install it now?"), startDWCUpdate);
				} else if (uploadFirmwareFile != undefined || uploadDWSFile != undefined || uploadDWSSFile != undefined || uploadDWCFile != undefined) {
					$("#modal_upload").modal("hide");
					showConfirmationDialog(T("Perform Firmware Update?"), T("You have just uploaded multiple firmware files. Would you like to install them now?"), startFirmwareUpdates);
				} else if (uploadIncludedConfig) {
					$("#modal_upload").modal("hide");
					showConfirmationDialog(T("Reboot Duet?"), T("You have just uploaded a config file. Would you like to reboot your Duet now?"), function() {
						// Perform software reset
						sendGCode("M999");
					});
				}
			}
		}
	}

	function startFirmwareUpdates() {
		var sParams = [], fwFile, dwsFile, dwcFile;
		if (uploadFirmwareFile != undefined) {
			fwFile = "0:/sys/" + uploadFirmwareFile;
			sParams.push("0");
		}
		if (uploadDWSSFile != undefined) {
			dwsFile = "0:/sys/" + uploadDWSSFile;
			sParams.push("1");
		} else if (uploadDWSFile != undefined) {
			dwsFile = "0:/sys/" + uploadDWSFile;
			sParams.push("1");
		}
		if (uploadDWCFile != undefined) {
			dwcFile = "0:/sys/" + uploadDWCFile;
			sParams.push("2");
		}

		// Stop status updates so the user doesn't see any potential error messages
		stopUpdates();

		// Move the file(s) into place
		moveFile(fwFile, "0:/sys/" + firmwareFileName + ".bin", function() {
			moveFile(dwsFile, "0:/sys/DuetWiFiServer.bin", function() {
				moveFile(dwcFile, "0:/sys/DuetWebControl.bin", function() {
					// Initiate firmware updates
					var sParam = sParams.join(":");
					sendGCode("M997 S" + sParam);

					// Resume the status update loop
					startUpdates();
				}, startUpdates);
			}, startUpdates);
		}, startUpdates);
	}

	function startFirmwareUpdate() {
		// Stop status updates so the user doesn't see any potential error messages
		stopUpdates();

		// The filename is hardcoded in the firmware binary, so try to rename the uploaded file first
		moveFile("0:/sys/" + uploadFirmwareFile, "0:/sys/" + firmwareFileName + ".bin", function() {
			// Rename succeeded and flashing can be performed now
			sendGCode("M997 S0");
			startUpdates();
		}, startUpdates);
	}

	function startDWSUpdate() {
		// Stop status updates so the user doesn't see any potential error messages
		stopUpdates();

		// We prefer DWSS over DWS. Move it into place and start the update
		if (uploadDWSSFile != undefined) {
			moveFile("0:/sys/" + uploadDWSSFile, "0:/sys/DuetWiFiServer.bin", function() {
				// Rename succeeded and flashing can be performed now
				sendGCode("M997 S1");
				startUpdates();
			}, startUpdates);
		} else {
			moveFile("0:/sys/" + uploadDWSFile, "0:/sys/DuetWiFiServer.bin", function() {
				// Rename succeeded and flashing can be performed now
				sendGCode("M997 S1");
				startUpdates();
			}, startUpdates);
		}
	}

	function startDWCUpdate() {
		// Stop status updates so the user doesn't see any potential error messages
		stopUpdates();

		// The filename is hardcoded in the firmware binary, so try to rename the uploaded file first
		moveFile("0:/sys/" + uploadDWCFile, "0:/sys/DuetWebControl.bin", function() {
			// Rename succeeded and flashing can be performed now
			sendGCode("M997 S2");
			startUpdates();
		}, startUpdates);
	}


	/* Upload events */

	$("#btn_cancel_upload").click(function() {
		cancelUpload();
	});

	$(".btn-upload").click(function(e) {
		if (!$(this).is(".disabled")) {
			var type = $(this).data("type"), filter = "";
			if (type == "print" || type == "gcode") {
				filter = ".gcode,.gc,.gco,.tap";
			} else if (type == "filament") {
				filter = ".zip";
			} else if (type == "generic") {
				filter=".zip,.bin,.csv,.g,.json,.htm,.html,.ico,.xml,.css,.map,.js,.ttf,.eot,.svg,.woff,.woff2,.jpeg,.jpg,.png,.gz";
			}
			$("#input_file_upload").prop("accept", filter).data("type", type).click();
		}
		e.preventDefault();
	});

	["print", "gcode", "macro", "filament", "generic"].forEach(function(type) {
		var child = $(".btn-upload[data-type='" + type + "']");

		// Drag Enter
		child.on("dragover", function(e) {
			$(this).removeClass($(this).data("style")).addClass("btn-success");
			e.preventDefault();
			e.stopPropagation();
		});

		// Drag Leave
		child.on("dragleave", function(e) {
			$(this).removeClass("btn-success").addClass($(this).data("style"));
			e.preventDefault();
			e.stopPropagation();
		});

		// Drop
		child.on("drop", function(e) {
			$(this).removeClass("btn-success").addClass($(this).data("style"));
			e.preventDefault();
			e.stopPropagation();

			var files = e.originalEvent.dataTransfer.files;
			if (!$(this).hasClass("disabled") && files != null && files.length > 0) {
				// Start new file upload
				startUpload($(this).data("type"), files, false);
			}
		});
	});

	$("#input_file_upload").change(function(e) {
		if (this.files.length > 0) {
			// For POST uploads we need file blobs
			startUpload($(this).data("type"), this.files, false);
		}
	});

	$('#modal_upload').on('hidden.bs.modal', function (e) {
		if (uploadFilesSkipped) {
			showMessage("warning", T("Warning"), T("Some files were not uploaded because they were not suitable for your board."));
		}
	})
	/* Utility functions for Duet Web Control
	 *
	 * written by Christian Hammacher (c) 2016-2017
	 *
	 * licensed under the terms of the GPL v3
	 * see http://www.gnu.org/licenses/gpl-3.0.html
	 */

	var heatersInUse;


	/* Text formatting */

	function formatUploadSpeed(bytesPerSec) {
		if (settings.useKiB) {
			if (bytesPerSec > 1073741824) {		// GiB
				return (bytesPerSec / 1073741824).toFixed(2) + " GiB/s";
			}
			if (bytesPerSec > 1048576) {		// MiB
				return (bytesPerSec / 1048576).toFixed(2) + " MiB/s";
			}
			if (bytesPerSec > 1024) {			// KiB
				return (bytesPerSec / 1024).toFixed(1) + " KiB/s";
			}
		} else {
			if (bytesPerSec > 1000000000) {		// GB
				return (bytesPerSec / 1000000000).toFixed(2) + " GB/s";
			}
			if (bytesPerSec > 1000000) {		// MB
				return (bytesPerSec / 1000000).toFixed(2) + " MB/s";
			}
			if (bytesPerSec > 1000) {			// KB
				return (bytesPerSec / 1000).toFixed(1) + " KB/s";
			}
		}
		return bytesPerSec + " B/s";
	}

	function formatSize(bytes) {
		if (settings.useKiB) {
			if (bytes > 1073741824) {	// GiB
				return (bytes / 1073741824).toFixed(1) + " GiB";
			}
			if (bytes > 1048576) {		// MiB
				return (bytes / 1048576).toFixed(1) + " MiB";
			}
			if (bytes > 1024) {			// KiB
				return (bytes / 1024).toFixed(1) + " KiB";
			}
		} else {
			if (bytes > 1000000000) {	// GB
				return (bytes / 1000000000).toFixed(1) + " GB";
			}
			if (bytes > 1000000) {		// MB
				return (bytes / 1000000).toFixed(1) + " MB";
			}
			if (bytes > 1000) {			// KB
				return (bytes / 1000).toFixed(1) + " KB";
			}
		}
		return bytes + " B";
	}

	function formatTime(value) {
		value = Math.round(value);
		if (value < 0) {
			value = 0;
		}

		var timeLeft = [], temp;
		if (value >= 3600) {
			temp = Math.floor(value / 3600);
			if (temp > 0) {
				timeLeft.push(temp + "h");
				value = value % 3600;
			}
		}
		if (value >= 60) {
			temp = Math.floor(value / 60);
			if (temp > 0) {
				timeLeft.push((temp > 9 ? temp : "0" + temp) + "m");
				value = value % 60;
			}
		}
		value = value.toFixed(0);
		timeLeft.push((value > 9 ? value : "0" + value) + "s");

		return timeLeft.reduce(function(a, b) { return a + " " + b; });
	}

	function timeToStr(time) {
		// Should return an ISO-like datetime string like "2016-10-24T15:39:09"
		// Cannot use toISOString() here because it doesn't output the localtime
		var result = "";
		result += time.getFullYear() + "-";
		result += (time.getMonth() + 1) + "-";
		result += time.getDate() + "T";
		result += time.getHours() + ":";
		result += time.getMinutes() + ":";
		result += time.getSeconds();
		return result;
	}

	function strToTime(str) {
		// Date.parse() doesn't always return correct dates.
		// Hence we must parse it using a regex here
		var re = /(\d+)-(\d+)-(\d+)T(\d+):(\d+):(\d+)/;
		var results;
		if ((results = re.exec(str)) != null) {
			var date = new Date();
			date.setFullYear(results[1]);
			date.setMonth(results[2] - 1);
			date.setDate(results[3]);
			date.setHours(results[4]);
			date.setMinutes(results[5]);
			date.setSeconds(results[6]);
			return date;
		}
		return undefined;
	}

	function getHeaterStateText(state) {
		switch (state) {
			case 0:
				return T("off");
			case 1:
				return T("standby");
			case 2:
				return T("active");
			case 3:
				return T("fault");
			case 4:
				return T("tuning");
		}
		return T("n/a");
	}


	/* CSV Parsing */

	function parseCSV(str) {
	    var arr = [];
	    var quote = false;  // true means we're inside a quoted field

	    // iterate over each character, keep track of current row and column (of the returned array)
	    for (var row = col = c = 0; c < str.length; c++) {
	        var cc = str[c], nc = str[c+1];        // current character, next character
			if (arr.length <= row) { arr.push([]); }
			if (arr[row].length <= col) { arr[row].push([""]); }

	        // If the current character is a quotation mark, and we're inside a
	        // quoted field, and the next character is also a quotation mark,
	        // add a quotation mark to the current column and skip the next character
	        if (cc == '"' && quote && nc == '"') { arr[row][col] += cc; ++c; continue; }

	        // If it's just one quotation mark, begin/end quoted field
	        if (cc == '"') { quote = !quote; continue; }

	        // If it's a comma and we're not in a quoted field, move on to the next column
	        if (cc == ',' && !quote) { ++col; continue; }

	        // If it's a newline and we're not in a quoted field, move on to the next
	        // row and move to column 0 of that new row
	        if (cc == '\n' && !quote) { ++row; col = 0; continue; }

	        // Otherwise, append the current character to the current column
	        arr[row][col] += cc;
	    }
	    return arr;
	}

	function getCSVValue(csvArray, key) {
		if (csvArray.length > 1) {
			var index = csvArray[0].indexOf(key);
			if (index == -1) {
				return undefined;
			}
			return csvArray[1][index].trim();
		}
		return undefined;
	}


	/* Heaters */

	function setHeatersInUse() {
		heatersInUse = [];
		for(var heater = 0; heater < maxHeaters; heater++) {
			var heaterAssigned = (heater == bedHeater);
			heaterAssigned |= (heater == chamberHeater);
			heaterAssigned |= (getToolsByHeater(heater).length > 0);
			heatersInUse.push(heaterAssigned);
		}
	}


	/* Tool Mapping */

	var initialTools = "";
	$("#table_tools > tbody > tr[data-tool]").each(function() {
		initialTools += this.outerHTML;
	});

	function setToolMapping(mapping) {
		var mappingHasChanged = (toolMapping == undefined);
		if (!mappingHasChanged) {
			// Add missing fields in case we're talking with an older firmware version
			for(var i = 0; i < mapping.length; i++) {
				if (!mapping[i].hasOwnProperty("number")) {
					// This is rather ugly and should be never used
					mapping[i].number = i + 1;
				}

				if (!mapping[i].hasOwnProperty("name")) {
					mapping[i].name = "";
				}
			}

			// Compare the old tool mapping with the new one
			if (mapping.length != toolMapping.length) {
				mappingHasChanged = true;
			} else {
				for(var i = 0; i < mapping.length; i++) {
					// Stop immediately if anything significant has changed
					if (mapping[i].number != toolMapping[i].number ||
						mapping[i].name != toolMapping[i].name ||
						mapping[i].hasOwnProperty("filament") != toolMapping[i].hasOwnProperty("filament") ||
						mapping[i].heaters.toString() != toolMapping[i].heaters.toString() ||
						mapping[i].drives.toString() != toolMapping[i].drives.toString()
					) {
						mappingHasChanged = true;
						break;
					}

					// If only the filament has changed, update it
					if (mapping[i].hasOwnProperty("filament") && mapping[i].filament != toolMapping[i].filament) {
						setToolFilament(i, mapping[i].filament);
					}
				}
			}
		}

		// See if anything significant has changed
		if (mappingHasChanged) {
			toolMapping = mapping;
			setHeatersInUse();

			// TODO: The web interface has no idea which drive is assigned to which axis/extruder,
			// so the following cannot be fully implemented yet.

			/**
			// Find out which drives may be assigned to XYZ
			xyzAxisMapping = [[0], [1], [2]];
			if (toolMapping != undefined) {
				for(var i = 0; i < toolMapping.length; i++) {
					var tool = toolMapping[i];
					if (tool.hasOwnProperty("axisMap")) {
						for(var k = 0; k < tool.axisMap.length; i++) {
							for(var l = 0; l < tool.axisMap[k].length; l++) {
								var mappedDrive = tool.axisMap[k][l];
								if (xyzAxisMapping[k].indexOf(mappedDrive) == -1) {
									xyzAxisMapping[k].push(mappedDrive);
								}
							}
						}
					}
				}
			}

			// Adjust the column headers of the XYZ position to match this mapping
			if (axisMapping[0].length > 1) {
				var content = "X (";


				content += ")";
			} else {
				$("#th_x").text("X");
			}*/

			return true;
		}
		return false;
	}

	function setToolFilament(tool, filament) {
		toolMapping[tool].filament = filament;

		var label = "T" + toolMapping[tool].number + ((filament == "") ? "" : (" - " + filament));
		$("#table_tools tr[data-tool='" + toolMapping[tool].number + "'] > th:first-child > span.text-muted").text(label);

		var filamentLabel = (filament == "") ? T("none") : filament;
		$("#page_tools div[data-tool='" + toolMapping[tool].number + "'] dd.filament").text(filamentLabel);
	}

	function updateFixedToolTemps(rows) {
		settings.defaultActiveTemps.forEach(function(temp) {
			rows.find(".ul-active-temp").append('<li><a href="#" class="heater-temp" data-temp="' + temp + '">' + T("{0} °C", temp) + '</a></li>');
			rows.find(".btn-active-temp").removeClass("disabled");
		});

		settings.defaultStandbyTemps.forEach(function(temp) {
			rows.find(".ul-standby-temp").append('<li><a href="#" class="heater-temp" data-temp="' + temp + '">' + T("{0} °C", temp) + '</a></li>');
			rows.find(".btn-standby-temp").removeClass("disabled");
		});

		rows.find("input").prop("disabled", !isConnected);
	}

	function getTool(number) {
		if (toolMapping == undefined) {
			return undefined;
		}

		for(var i = 0; i < toolMapping.length; i++) {
			if (toolMapping[i].hasOwnProperty("number")) {
				if (toolMapping[i].number == number) {
					return toolMapping[i];
				}
			} else if (i + 1 == number) {
				return toolMapping[i];
			}
		}
		return undefined;
	}

	function getToolsByHeater(heater) {
		if (toolMapping == undefined) {
			return [];
		}

		var result = [];
		for(var i = 0; i < toolMapping.length; i++) {
			for(var k = 0; k < toolMapping[i].heaters.length; k++) {
				if (toolMapping[i].heaters[k] == heater) {
					if (toolMapping[i].hasOwnProperty("number")) {
						result.push(toolMapping[i].number);
					} else {
						result.push(i + 1);
					}
				}
			}
		}
		return result;
	}

	function setCurrentTool(toolNumber) {
		if (toolMapping == undefined) {
			return;
		}
		var hideExtruderInputs = true;

		// Hide extruder drives that cannot be used
		if (toolNumber >= 0) {
			var drives = getTool(toolNumber).drives;
			for(var i = 0; i < numExtruderDrives; i++) {
				var toolHasDrive = (drives.indexOf(i) != -1);
				$("#div_extruders > div > .extr-" + (i + 1)).toggleClass("hidden", !toolHasDrive);
			}

			hideExtruderInputs = (drives.length < 2);
		}

		// Hide whole selection if there is no point showing it
		$("#div_extruders").toggleClass("hidden", hideExtruderInputs);
		if (hideExtruderInputs) {
			$("#div_feedrate, #div_feed").removeClass("col-lg-4").addClass("col-lg-5");
			$("#div_extrude").removeClass("col-lg-1").addClass("col-lg-2");
		} else {
			$("#div_feedrate, #div_feed").addClass("col-lg-4").removeClass("col-lg-5");
			$("#div_extrude").addClass("col-lg-1").removeClass("col-lg-2");

			// Select first available extruder
			if ($('input[name="extruder"]:checked').parent().hasClass("hidden")) {
				$("#div_extruders > div > label:not(.hidden):first-child").click();
			}
		}

		// Underline current tool
		$("#table_tools > tbody > tr").each(function() {
			$(this).find("th:first-child > a > span:first-child").css("text-decoration", ($(this).data("tool") == toolNumber) ? "underline" : "");
		});

		// Update tools on the Settings page
		$("#page_tools button.btn-select-tool").prop("title", T("Select this tool")).html('<span class="glyphicon glyphicon-pencil"></span> <span>' + T("Select") + '</span>');
		$("#page_tools div[data-tool='" + toolNumber + "'] button.btn-select-tool").prop("title", T("Deselect this tool")).html('<span class="glyphicon glyphicon-remove"></span> <span>' + T("Deselect") + '</span>');
	}


	/* Control state management */

	function enableControls() {
		$("nav input, #div_tools_heaters input, #main_content input").prop("disabled", false);		// Generic inputs
		$("#page_tools label").removeClass("disabled");												// and on Settings page
		$(".machine-button").removeClass("disabled");

		$(".btn-emergency-stop, .gcode-input button[type=submit], .gcode").removeClass("disabled");	// Navbar
		$(".bed-temp, .gcode, .heater-temp, .btn-upload").removeClass("disabled");					// List items and Upload buttons

		$("#mobile_home_buttons button, #btn_homeall, .table-move a").removeClass("disabled");		// Move buttons
		$("#btn_bed_dropdown").removeClass("disabled");												// Automatic Bed Compensation
		$("#panel_extrude label.btn, #panel_extrude button").removeClass("disabled");				// Extruder Control
		$("#panel_control_misc label.btn").removeClass("disabled");									// ATX Power
		$("#slider_fan_control").slider("enable");													// Fan Control

		$("#page_scanner button").removeClass("disabled");											// Scanner
		$("#page_print .checkbox, #btn_baby_down, #btn_baby_up").removeClass("disabled");			// Print Control
		$("#slider_fan_print").slider("enable");													// Fan ...
		$(".table-fan-control button").removeClass("disabled");										// ... Control
		$("#slider_speed").slider("enable");														// Speed Factor
		for(var extr = 1; extr <= maxExtruders; extr++) {
			$("#slider_extr_" + extr).slider("enable");												// Extrusion Factors
		}

		$(".online-control").removeClass("hidden");													// G-Code/Macro Files
	}

	function disableControls() {
		$("nav input, #div_tools_heaters input, #main_content input").prop("disabled", true);		// Generic inputs
		$("#page_general input, #page_ui input, #page_listitems input").prop("disabled", false);	// ... except ...
		$("#page_tools label").addClass("disabled");												// ... for Settings
		$(".machine-button").addClass("disabled");

		$(".btn-emergency-stop, .gcode-input button[type=submit], .gcode").addClass("disabled");	// Navbar
		$(".bed-temp, .gcode, .heater-temp, .btn-upload").addClass("disabled");						// List items and Upload buttons

		$("#mobile_home_buttons button, #btn_homeall, #table_move_head a").addClass("disabled");	// Move buttons
		$("#btn_bed_dropdown").addClass("disabled");												// Automatic Bed Compensation
		$("#panel_extrude label.btn, #panel_extrude button").addClass("disabled");					// Extruder Control
		$("#panel_control_misc label.btn").addClass("disabled");									// ATX Power
		$("#slider_fan_control").slider("disable");													// Fan Control

		$("#page_scanner button").addClass("disabled");												// Scanner
		$("#btn_pause, #page_print .checkbox, #btn_baby_down, #btn_baby_up").addClass("disabled");	// Print Control
		$("#slider_fan_print").slider("disable");													// Fan ...
		$(".table-fan-control button").addClass("disabled");										// ... Control
		$("#slider_speed").slider("disable");														// Speed Factor
		for(var extr = 1; extr <= maxExtruders; extr++) {
			$("#slider_extr_" + extr).slider("disable");											// Extrusion Factors
		}

		$(".online-control").addClass("hidden");													// G-Code/Macro Files
	}


	/* Window size queries */

	function windowIsXsSm() {
		return window.matchMedia('(max-width: 991px)').matches;
	}

	function windowIsMdLg() {
		return window.matchMedia('(min-width: 992px)').matches;
	}


	/* Misc */

	function arraysEqual(a, b) {
		if (a != undefined && b != undefined && a.length == b.length) {
			for(var i = 0; i < a.length; i++) {
				if (a[i].constructor === Array && b[i].constructor === Array) {
					if (!arraysEqual(a[i], b[i])) {
						return false;
					}
				} else if (a[i] != b[i]) {
					return false;
				}
			}
			return true;
		}
		return false;
	}

	function log(style, message) {
		var entry =		'<div class="row alert-' + style + '">';
		entry +=		'<div class="col-xs-2 col-sm-2 col-md-2 col-lg-1 text-center"><strong>' + (new Date()).toLocaleTimeString() + '</strong></div>';
		entry +=		'<div class="col-xs-10 col-sm-10 col-md-10 col-lg-11">' + message + '</div></div>';
		$("#console_log").prepend(entry);
	}

	var audioContext = new (window.AudioContext || window.webkitAudioContext);
	function beep(frequency, duration) {
		var oscillator = audioContext.createOscillator();

		oscillator.type = 'sine';
		oscillator.frequency.value = frequency;
		oscillator.connect(audioContext.destination);
		oscillator.start();

		setTimeout(function() {
			oscillator.disconnect();
		}, duration);
	}
	/* 3D bed visualization for Duet Web Control
	 *
	 * written by Christian Hammacher (c) 2016-2017
	 *
	 * licensed under the terms of the GPL v3
	 * see http://www.gnu.org/licenses/gpl-3.0.html
	 */

	var scaleZ = 0.5, maxVisualizationZ = 0.25, pointTolerance = 2.0;
	var smallIndicatorRadius = 0.01, mediumIndicatorRadius = 0.02, bigIndicatorRadius = 0.05;
	var indicatorColor = 0xFFFFFF, indicatorOpacity = 0.4, indicatorOpacityHighlighted = 1.0;

	var colorScheme = "terrain";
	var scene, camera, renderer, raycaster;
	var meshGeometry, meshPlane, meshIndicators, lastIntersection;
	var bedProbePoints, probePoints, probeXMin, probeXMax, probeYMin, probeYMax;


	function testHeightmap() {
		var csv = 'RepRapFirmware height map file v1\nxmin,xmax,ymin,ymax,radius,spacing,xnum,ynum\n-140.00,140.10,-140.00,140.10,150.00,20.00,15,15\n0,0,0,0,0,-0.139,-0.188,-0.139,-0.202,-0.224,0,0,0,0,0\n0,0,0,-0.058,-0.066,-0.109,-0.141,-0.129,-0.186,-0.198,-0.191,-0.176,0,0,0\n0,0,0.013,-0.008,-0.053,-0.071,-0.087,-0.113,-0.162,-0.190,-0.199,-0.267,-0.237,0,0\n0,0.124,0.076,0.025,-0.026,-0.054,-0.078,-0.137,-0.127,-0.165,-0.201,-0.189,-0.227,-0.226,0\n0,0.198,0.120,0.047,0.089,-0.074,-0.097,-0.153,-0.188,-0.477,-0.190,-0.199,-0.237,-0.211,0\n0.312,0.229,0.198,0.098,0.097,0.004,-0.089,-0.516,-0.150,-0.209,-0.197,-0.183,-0.216,-0.296,-0.250\n0.287,0.263,0.292,0.100,0.190,0.015,-0.102,-0.039,-0.125,-0.149,-0.137,-0.198,-0.188,-0.220,-0.192\n0.378,0.289,0.328,0.172,0.133,0.078,-0.086,0.134,-0.100,-0.150,-0.176,-0.234,-0.187,-0.199,-0.221\n0.360,0.291,0.260,0.185,0.111,0.108,0.024,0.073,-0.024,-0.116,-0.187,-0.252,-0.201,-0.215,-0.187\n0.447,0.397,0.336,0.276,0.180,0.164,0.073,-0.050,-0.049,-0.109,-0.151,-0.172,-0.211,-0.175,-0.161\n0,0.337,0.289,0.227,0.179,0.127,0.086,0.034,-0.039,-0.060,-0.113,-0.108,-0.171,-0.153,0\n0,0.478,0.397,0.374,0.270,0.141,0.085,0.074,0.037,-0.048,-0.080,-0.187,-0.126,-0.175,0\n0,0,0.373,0.364,0.265,0.161,0.139,0.212,0.040,0.046,-0.008,-0.149,-0.115,0,0\n0,0,0,0.346,0.295,0.273,0.148,0.136,0.084,0.024,-0.055,-0.078,0,0,0\n0,0,0,0,0,0.240,0.178,0.084,0.090,0.004,0,0,0,0,0';

		// The first line is a comment generated by RepRapFirmware. Remove it
		csv = csv.substr(csv.indexOf("\n") + 1);

		// Convert the CSV text into an array that we can use
		var csvArray = parseCSV(csv);

		// Get the values that are interesting for us
		var probeRadius = parseFloat(getCSVValue(csvArray, "radius"));
		var xMin = parseFloat(getCSVValue(csvArray, "xmin"));
		var xMax = parseFloat(getCSVValue(csvArray, "xmax"));
		var yMin = parseFloat(getCSVValue(csvArray, "ymin"));
		var yMax = parseFloat(getCSVValue(csvArray, "ymax"));
		var spacing = parseFloat(getCSVValue(csvArray, "spacing"));

		// Convert each point to a vector
		var heightmap = [];
		for(var y = 2; y < csvArray.length; y++) {
			for(var x = 0; x < csvArray[y].length; x++) {
				var value = csvArray[y][x];
				if (value == "0") {
					heightmap.push([xMin + x * spacing, yMin + (y - 2) * spacing, NaN]);
				} else {
					var value = parseFloat(csvArray[y][x]);
					heightmap.push([xMin + x * spacing, yMin + (y - 2) * spacing, value]);
				}
			}
		}

		// Generate 3D mesh
		showHeightmap(heightmap, probeRadius, xMin, yMin);
	}

	function testBedCompensation(numPoints) {
		var testPoints;
		switch (numPoints) {
			case 3:
				testPoints = [[15.0, 15.0, 0.123], [15.0, 195.0, -0.243], [215.0, 105.0, 0.034]];
				setGeometry("cartesian");
				break;

			case 4:
				testPoints = [[15.0, 15.0, 0.015], [15.0, 185.0, -0.193], [175.0, 185.0, 0.156], [175.0, 15.0, 0.105]];
				setGeometry("cartesian");
				break;

			case 5:
				testPoints = [[15.0, 15.0, 0.007], [15.0, 185.0, -0.121], [175.0, 185.0, -0.019], [175.0, 15.0, 0.193], [95.0, 100.0, 0.05]];
				setGeometry("cartesian");
				break;

			case 7:
				testPoints = [[0.0, 84.0, 0.01], [73.53, -42.45, 0.125], [-73.53, -42.45, 0.25], [0.0, 42.4, 0.0], [36.72, -21.2, -0.125], [-36.72, -21.2, -0.25], [0.0, 0.0, 0.25]];
				setGeometry("delta");
				break;

			case 9:
				testPoints = [[15.0, 15.0, 0.034], [95.0, 15.0, 0.143], [175.0, 15.0, -0.123], [15.0, 100.0, 0.154], [95.0, 100.0, -0.252], [175.0, 100.0, -0.135], [15.0, 185.0, 0.234], [95.0, 185.0, -0.242], [175.0, 185.0, 0.123]];
				setGeometry("cartesian");
				break;

			case 10:
				testPoints = [[0,84.9,0],[49.9,68.69,0],[80.74,26.24,0],[80.74,-26.24,0],[49.9,-68.69,0],[0,-84.9,0],[-49.9,-68.69,0],[-80.74,-26.24,0],[-80.74,26.24,0],[-49.9,68.69,0],[0,0,0]];
				setGeometry("delta");
				break;

			case 17:
				testPoints = [[0,84.9,0.05630809461178765],[49.9,68.69,0.17599528333331518],[80.74,26.24,0.2594756296464064],[80.74,-26.24,0.015530445498113554],[49.9,-68.69,0.23133485970358503],[0,-84.9,0.21997378657053593],[-49.9,-68.69,0.11618119110103399],[-80.74,-26.24,0.2772662322205023],[-80.74,26.24,0.08411930426155993],[-49.9,68.69,0.01151950813684679],[0,42.4,0.131994449059145],[36.72,21.2,0.056566293905866843],[36.72,-21.2,0.25405071944089047],[0,-42.4,0.1763972630845728],[-36.72,-21.2,0.07603902615730086],[-36.72,21.2,0.12579173035981916],[0,0,0.08963820511571098]];
				setGeometry("delta");
				break;

			case 121:
				testPoints = [[-50,-50,0.12002740834777786],[-50,-40,-0.11153931027113302],[-50,-30,0.03726485452325734],[-50,-20,0.10955886411136477],[-50,-10,-0.04435246652525355],[-50,0,-0.0028156396602971867],[-50,10,-0.051632028852817126],[-50,20,-0.05794016520470719],[-50,30,-0.030471271734211446],[-50,40,-0.06971687368573451],[-50,50,-0.12195742398687667],[-40,-50,0.14254362562578415],[-40,-40,-0.08126858523700416],[-40,-30,-0.06198184729114495],[-40,-20,-0.037504449710496],[-40,-10,0.07361124455504224],[-40,0,-0.08754060897951484],[-40,10,0.035879996249150815],[-40,20,-0.09360238058545878],[-40,30,0.11442068820906585],[-40,40,-0.08363311975376284],[-40,50,0.043518350809534076],[-30,-50,-0.057116822070275464],[-30,-40,0.08955138441010302],[-30,-30,0.1185910894111243],[-30,-20,-0.07601355576245762],[-30,-10,-0.005618731185199488],[-30,0,-0.13563892359086296],[-30,10,0.09300977253840119],[-30,20,0.0165485225775021],[-30,30,0.1291417905009324],[-30,40,0.10952998968672502],[-30,50,0.03606211423795047],[-20,-50,0.054808296166161605],[-20,-40,-0.08239703812918384],[-20,-30,-0.029730835473283677],[-20,-20,0.11280340342421669],[-20,-10,-0.0134227744832083],[-20,0,-0.03363528493561929],[-20,10,-0.001022756045073314],[-20,20,0.03156257223821328],[-20,30,0.005150101179566757],[-20,40,0.1342733417639501],[-20,50,0.08662800628200462],[-10,-50,-0.11251500729320446],[-10,-40,-0.10152120320535729],[-10,-30,-0.13947973240148234],[-10,-20,-0.0055081718158396685],[-10,-10,0.012406068888191889],[-10,0,0.019127386274646805],[-10,10,-0.060339695184274754],[-10,20,0.09475372058120354],[-10,30,0.04504534407928413],[-10,40,0.09264861231075873],[-10,50,-0.12986678193884427],[0,-50,0.044021329858792965],[0,-40,0.12602510485509355],[0,-30,-0.1358244106091512],[0,-20,0.04885005208852744],[0,-10,-0.07742114874082186],[0,0,-0.002289637865387117],[0,10,-0.00815542589988023],[0,20,0.0011158536939211317],[0,30,0.10700301631570701],[0,40,-0.054518657864691365],[0,50,0.017084666415419524],[10,-50,-0.11298043262249217],[10,-40,-0.14008436368192323],[10,-30,-0.1271727984317276],[10,-20,0.06333304984467969],[10,-10,0.060342445616347384],[10,0,0.08104223768183395],[10,10,-0.0024036494807740502],[10,20,0.003092740116676751],[10,30,-0.016183497677099833],[10,40,-0.021855589456963597],[10,50,0.06043936839655179],[20,-50,0.11820755728621879],[20,-40,-0.01702291734385255],[20,-30,-0.06449113235394623],[20,-20,-0.14055632865897286],[20,-10,-0.01994879304716839],[20,0,0.003604964896454832],[20,10,-0.04220968285722817],[20,20,0.01872527251135445],[20,30,0.035094267945042175],[20,40,0.08625901330376684],[20,50,0.14685416531566567],[30,-50,0.11423465093082014],[30,-40,-0.010328196199440342],[30,-30,0.07359570163736166],[30,-20,-0.016141161970606156],[30,-10,-0.061684955393020456],[30,0,0.12939173181232735],[30,10,-0.02237449658065016],[30,20,-0.14749891451903582],[30,30,0.1473553275042116],[30,40,-0.050145519405154326],[30,50,0.04250744539879927],[40,-50,0.14224393364505666],[40,-40,0.037228715024125926],[40,-30,0.06499028067572622],[40,-20,0.061523275439891195],[40,-10,-0.011061591645928103],[40,0,0.061033484764153975],[40,10,0.1205016965624641],[40,20,0.023848178520022387],[40,30,-0.0021676609838422677],[40,40,-0.06590936366459543],[40,50,0.08999587447670003],[50,-50,-0.13398415024828852],[50,-40,0.09659652345656729],[50,-30,-0.12894582833974588],[50,-20,0.08685982032429304],[50,-10,0.0007890629119364334],[50,0,-0.06152535417010243],[50,10,0.13123240948087636],[50,20,-0.07158442576405022],[50,30,-0.14788950165050954],[50,40,-0.1278763640481279],[50,50,0.07007486386303274]];
				setGeometry("delta");
				break;
		}

		showBedCompensation(testPoints);
	}

	function getHeightmap(file) {
		if (!isConnected) {
			return;
		}

		if (file == undefined) {
			file = "0:/sys/heightmap.csv";
		}

		$.ajax(ajaxPrefix + "rr_download?name=" + encodeURIComponent(file), {
			dataType: "html",
			cache: false,
			global: false,
			error: function() {
				showMessage("warning", T("Failed to download height map"), T("Failed to download and process {0} from the SD card. Have you run G29 yet?"));
			},
			success: function(csv) {
				// Are we dealing with a proper heightmap file?
				var version = undefined;
				if (csv.indexOf("RepRapFirmware height map file v1") == 0) {
					version = 1;
				} else if (csv.indexOf("RepRapFirmware height map file v2") == 0) {
					version = 2;
				} else {
					// No - open it in the text editor
					showEditDialog(file, csv, function(value) {
						uploadTextFile(file, value, function() {
							if (currentPage == "files") {
								updateGCodeFiles();
							} else if (currentPage == "macros") {
								updateMacroFiles();
							} else if (currentPage == "settings") {
								updateSysFiles();
							}
						});
					});
					return;
				}

				// The first line is a comment generated by RepRapFirmware. Remove it
				csv = csv.substr(csv.indexOf("\n") + 1);

				// Convert the CSV text into an array that we can use
				var csvArray = parseCSV(csv);

				// Get the values that are interesting for us
				var probeRadius = parseFloat(getCSVValue(csvArray, "radius"));
				var xMin = parseFloat(getCSVValue(csvArray, "xmin"));
				//var xMax = parseFloat(getCSVValue(csvArray, "xmax"));		// unreliable!
				var yMin = parseFloat(getCSVValue(csvArray, "ymin"));
				//var yMax = parseFloat(getCSVValue(csvArray, "ymax"));		// unreliable!
				var xspacing, yspacing;
				if (version == 1) {
					xspacing = yspacing = parseFloat(getCSVValue(csvArray, "spacing"));
				} else {
					xspacing = parseFloat(getCSVValue(csvArray, "xspacing"));
					yspacing = parseFloat(getCSVValue(csvArray, "yspacing"));
				}

				// Convert each point to a vector and add it to the vector list
				var heightmap = [];
				for(var y = 2; y < csvArray.length; y++) {
					for(var x = 0; x < csvArray[y].length; x++) {
						var value = csvArray[y][x].trim();
						if (value == "0") {
							heightmap.push([xMin + x * xspacing, yMin + (y - 2) * yspacing, NaN]);
						} else {
							var value = parseFloat(csvArray[y][x]);
							heightmap.push([xMin + x * xspacing, yMin + (y - 2) * yspacing, value]);
						}
					}
				}

				// Generate and show 3D mesh
				try {
					// If we supply invalid values from the CSV file, this function will throw an error
					showHeightmap(heightmap, probeRadius, xMin, yMin);
				} catch (e) {
					this.error();
				}
			}
		});
	}

	function clearBedPoints() {
		$("#a_show_bed_points").parent().addClass("disabled");

		bedProbePoints = undefined;
	}

	function showBedCompensation(points) {
		$("#a_show_bed_points").parent().removeClass("disabled");

		bedProbePoints = points;
		showHeightmap(points);
	}

	function showHeightmap(points, probeRadius, xMin, yMin) {
		// Generate stats
		var xMax, yMax;
		var minDiff, maxDiff, numProbePoints = 0, rmsError = 0, meanError = 0;
		for(var i = 0; i < points.length; i++) {
			var z = points[i][2];
			if (!isNaN(z)) {
				var x = points[i][0];
				var y = points[i][1];
				if (xMin == undefined || xMin > x) { xMin = x; }
				if (xMax == undefined || xMax < x) { xMax = x; }
				if (yMin == undefined || yMin > y) { yMin = y; }
				if (yMax == undefined || yMax < y) { yMax = y; }

				numProbePoints++;
				meanError += z;
				rmsError += z * z;
				if (minDiff == undefined || minDiff > z) { minDiff = z; }
				if (maxDiff == undefined || maxDiff < z) { maxDiff = z; }
			}
		}

		if (numProbePoints > 0) {
			rmsError = Math.sqrt(((rmsError * numProbePoints) - (meanError * meanError))) / numProbePoints;
			meanError = meanError / numProbePoints;
		}

		// Try to prepare a mesh geometry for the final visualization
		probePoints = points;
		meshGeometry = generateMeshGeometry(points, probeRadius, xMin, xMax, yMin, yMax);
		if (meshGeometry == undefined) {
			showMessage("warning", T("Cannot generate 3D visualization"), T("Failed to generate mesh for bed points!"));
			return;
		}

		// Calculate probe area lengths and size
		var probeArea = NaN;
		if (xMin == undefined || xMax == undefined || yMin == undefined || yMax == undefined) {
			probeXMin = probeXMax = probeYMin = probeYMax = undefined;
		} else {
			probeXMin = xMin;
			probeXMax = xMax;
			probeYMin = yMin;
			probeYMax = yMax;
			probeArea = Math.abs((xMin - xMax) * (yMin - yMax));
		}

		if (probeRadius != undefined && geometry == "delta") {
			probeArea = probeRadius * probeRadius * Math.PI;
		}

		// Display them
		$("#num_probe_points").text(numProbePoints);
		$("#probing_radius").text((probeRadius == undefined) ? T("n/a") : T("{0} mm", probeRadius));
		$("#probe_area").text((isNaN(probeArea)) ? T("n/a") : T("{0} cm²", (probeArea / 100).toFixed(1)));
		$("#max_deviations").text(T("{0} / {1} mm", (minDiff == undefined) ? T("n/a") : minDiff.toFixed(3), (maxDiff == undefined) ? T("n/a") : maxDiff.toFixed(3)));
		$("#mean_error").text(T("{0} mm", meanError.toFixed(3)));
		$("#rms_error").text(T("{0} mm", rmsError.toFixed(3)));

		// Show modal dialog
		$("#modal_bed").modal("show");
	}

	function getNearestZOnRing(points, x, y) {
		// Get point that is closest to X+Y
		var point, delta = undefined;
		for(var i = 0; i < points.length; i++) {
			var deltaNew = Math.sqrt(Math.pow(x - points[i][0], 2) + Math.pow(y - points[i][1], 2));
			if (delta == undefined || deltaNew < delta) {
				point = points[i];
				delta = deltaNew;
			}
		}

		// Return its Z value
		return (delta == undefined) ? NaN : point[2];
	}

	function getNearestZOnGrid(points, x, y, maxDelta) {
		// Get the point that is closest to X+Y
		var point, delta = undefined;
		for(var i = 0; i < points.length; i++) {
			var deltaNew = Math.sqrt(Math.pow(x - points[i][0], 2) + Math.pow(y - points[i][1], 2));
			if (delta == undefined || deltaNew < delta) {
				point = points[i];
				delta = deltaNew;
			}
		}

		// Check if we exceed the maximum allowed delta
		if (delta == undefined || (maxDelta != undefined && delta > maxDelta)) {
			return NaN;
		}

		// Otherwise return the closest Z coordinate of this point
		return point[2];
	}

	function generateMeshGeometry(probePoints, probeRadius, xMin, xMax, yMin, yMax) {
		/** Delta visualization for old-fashioned probe points **/

		if (geometry == "delta" && probePoints.length <= 17) {
			// Check if we need to set the probing radius
			if (probeRadius == undefined) {
				probeRadius = 0;
			}

			// If we have a reasonably small number of probe points, try to group them by their radii
			var radiiGroups = [], zeroPoint = undefined, probeRadius = 0;
			for(var i = 0; i < probePoints.length; i++) {
				var radius = Math.sqrt(Math.pow(probePoints[i][0], 2) + Math.pow(probePoints[i][1], 2));
				if (radius > 0) {
					var groupFound = false;
					for(var k = 0; k < radiiGroups.length; k++) {
						if (Math.abs(radiiGroups[k][0] - radius) < pointTolerance) {
							radiiGroups[k].push(probePoints[i]);
							groupFound = true;
							break;
						}
					}

					if (!groupFound) {
						radiiGroups.push([radius, probePoints[i]]);
					}

					if (radius > probeRadius) {
						probeRadius = radius;
					}
				} else {
					zeroPoint = probePoints[i];
				}
			}

			// Check if the determined groups are valid
			var groupingOkay = (zeroPoint != undefined) && (radiiGroups.length > 0);
			var maxPointsPerGroup = 1;
			for(var i = 0; i < radiiGroups.length; i++) {
				// Each group must have more than three entries
				if (radiiGroups[i].length < 4) {
					groupingOkay = false;
					break;
				}

				// Check how many max. points per group we have
				if (radiiGroups[i].length > maxPointsPerGroup + 1) {
					maxPointsPerGroup = radiiGroups[i].length - 1;
				}
			}

			// Everything OK - we can visualize a typical delta probe point grid
			if (groupingOkay) {
				radiiGroups = radiiGroups.sort(function(a, b) { return a[0] > b[0]; });

				// Generate a geometry with 3*maxPointsPerGroup points per circle segment, because the probe points on
				// the inner circle(s) are usually rotated by a certain amount
				var ringGeometry = new THREE.RingGeometry(0.000000001, 0.5, maxPointsPerGroup * 3, radiiGroups.length);

				for(var i = 0; i < ringGeometry.vertices.length; i++) {
					var vRadius = Math.sqrt(Math.pow(ringGeometry.vertices[i].x, 2) + Math.pow(ringGeometry.vertices[i].y, 2));
					if (vRadius < 0.0001) {
						// If the radius of this vertex is extremely small, treat it as the zero point
						ringGeometry.vertices[i].z = zeroPoint[2] * scaleZ;
					} else {
						var rGroupIndex = Math.round(vRadius / 0.25) - 1;
						if (rGroupIndex < 0 || rGroupIndex >= radiiGroups.length) {
							console.log("WARNING: Failed to find point group near vRadius=" + vRadius);
						} else {
							// Because extra segments are generated, the getNearestZ function tends to fail for extremely small Y
							// values. Hence we round it to 0 in this case to avoid interrupts of the grid surface
							var x = ringGeometry.vertices[i].x * probeRadius * 2;
							if (x > -0.0001 && x < 0.0001) { x = 0; }
							var y = ringGeometry.vertices[i].y * probeRadius * 2;
							if (y > -0.0001 && y < 0.0001) { y = 0; }
							ringGeometry.vertices[i].z = getNearestZOnRing(radiiGroups[rGroupIndex].slice(1), x, y) * scaleZ;
						}
					}
				}

				return ringGeometry;
			}
		}


		/** Cartesian 3-point and 5-point bed compensation **/

		if (geometry != "delta" && (probePoints.length == 3 || probePoints.length == 5)) {
			var planeGeometry = new THREE.Geometry();

			// Generate vertices
			for(var i = 0; i < probePoints.length; i++) {
				var x = (probePoints[i][0] - xMin) / (xMax - xMin) - 0.5;
				var y = (probePoints[i][1] - yMin) / (yMax - yMin) - 0.5;
				var z = probePoints[i][2] * scaleZ;

				planeGeometry.vertices.push(new THREE.Vector3(x, y, z));
			}

			// Generate faces
			if (probePoints.length == 3) {
				planeGeometry.faces.push(new THREE.Face3(0, 1, 2));
			} else {
				planeGeometry.faces.push(new THREE.Face3(0, 1, 4));
				planeGeometry.faces.push(new THREE.Face3(1, 2, 4));
				planeGeometry.faces.push(new THREE.Face3(2, 3, 4));
				planeGeometry.faces.push(new THREE.Face3(3, 0, 4));
			}

			return planeGeometry;
		}


		/** New grid-based compensation **/

		// Find out how many different X+Y coordinates are used
		var xPoints = [], yPoints = [];
		for(var i = 0; i < probePoints.length; i++) {
			var z = probePoints[i][2];
			if (!isNaN(z)) {
				var x = probePoints[i][0], y = probePoints[i][1];
				if (xPoints.indexOf(x) == -1) {
					xPoints.push(x);
				}
				if (yPoints.indexOf(y) == -1) {
					yPoints.push(y);
				}
			}
		}

		// Generate plane geometry for grid
		var width = (xMax - xMin);
		var height = (yMax - yMin);
		var planeWidth = (width < height) ? Math.abs(width / height) : 1.0;
		var planeHeight = (height < width) ? Math.abs(height / width) : 1.0;
		var planeGeometry = new THREE.PlaneGeometry(planeWidth, planeHeight, xPoints.length - 1, yPoints.length - 1);
		for(var i = planeGeometry.vertices.length - 1; i >= 0; i--) {
			var x = ((planeGeometry.vertices[i].x / planeWidth) + 0.5) * width + xMin;
			var y = ((planeGeometry.vertices[i].y / planeHeight) + 0.5) * height + yMin;
			var z = getNearestZOnGrid(probePoints, x, y) * scaleZ;

			planeGeometry.vertices[i].z = z;
		}

		// Add extra faces to each top row to avoid zig-zag lines
		var yCurrent = undefined;
		for(var i = 1; i < planeGeometry.vertices.length / 2; i++) {
			var vertex = planeGeometry.vertices[i];
			var prevVertex = planeGeometry.vertices[i - 1];
			if (!isNaN(prevVertex.z) && isNaN(vertex.z)) {
				var yPoint = vertex.y;
				if (yCurrent == undefined || yCurrent > yPoint) {
					// We are at the last defined point in this row
					yCurrent = yPoint;

					// Find the next two points below and below+right to this one
					var a = undefined, b;
					for(var k = i + 1; k < planeGeometry.vertices.length - 1; k++) {
						var nextVertex = planeGeometry.vertices[k];
						if (nextVertex.x == prevVertex.x && nextVertex.y == planeGeometry.vertices[k + 1].y) {
							a = k;
							b = k + 1;
							break;
						}
					}

					// If that succeeds add a new face
					if (a != undefined && !isNaN(planeGeometry.vertices[a].z) && !isNaN(planeGeometry.vertices[b].z)) {
						var face = new THREE.Face3(a, b, i - 1);
						planeGeometry.faces.push(face);
					}
				}
			}
		}

		// Add extra faces to each bottom row to avoid zig-zag lines
		var prevVertex = undefined;
		for(var i = Math.floor(planeGeometry.vertices.length / 2); i < planeGeometry.vertices.length; i++) {
			var vertex = planeGeometry.vertices[i];

			// Check if this is the first defined point in this row
			if (prevVertex != undefined && prevVertex.y == vertex.y && isNaN(prevVertex.z) && !isNaN(vertex.z)) {
				// Find the two points above and above+left to this one
				var a = undefined, b;
				for(var k = i - 1; k > 0; k--) {
					var prevVertex = planeGeometry.vertices[k];
					var prev2Vertex = planeGeometry.vertices[k - 1];
					if (prevVertex.x == vertex.x && prevVertex.y == planeGeometry.vertices[k - 1].y) {
						a = k - 1;
						b = k;
						break;
					}
				}

				// If that succeeds add a new face
				if (a != undefined && !isNaN(planeGeometry.vertices[a].z) && !isNaN(planeGeometry.vertices[b].z)) {
					var face = new THREE.Face3(a, b, i);
					planeGeometry.faces.push(face);
				}
			}
			prevVertex = vertex;
		}

		// Remove all the points and faces that have invalid values
		for(var i = planeGeometry.vertices.length - 1; i >= 0; i--) {
			if (isNaN(planeGeometry.vertices[i].z)) {
				// Remove and rearrange the associated face(s)
				for(var k = planeGeometry.faces.length - 1; k >= 0; k--) {
					var face = planeGeometry.faces[k];
					if (face.a == i || face.b == i || face.c == i) {
						planeGeometry.faces.splice(k, 1);
					} else {
						if (face.a > i) {
							face.a--;
						}
						if (face.b > i) {
							face.b--;
						}
						if (face.c > i) {
							face.c--;
						}
					}
				}

				// Remove this vertex
				planeGeometry.vertices.splice(i, 1);
			}
		}

		return planeGeometry;
	}

	function getColorByZ(modelZ) {
		var z = modelZ / scaleZ;

		// Terrain color scheme (i.e. from blue to red, asymmetric)
		if (colorScheme == "terrain") {
			z = Math.max(Math.min(z, maxVisualizationZ), -maxVisualizationZ);
			var hue = 240 - ((z + maxVisualizationZ) / maxVisualizationZ) * 120;
			return new THREE.Color("hsl(" + hue + ",100%,45%)");
		}

		// Default color scheme (i.e. the worse the redder, symmetric)
		var hue = 120 - Math.min(Math.abs(z), maxVisualizationZ) / maxVisualizationZ * 120;
		return new THREE.Color("hsl(" + hue + ",100%,45%)");
	}

	function setFaceColors(geometry) {
		for(var i = 0; i < geometry.faces.length; i++) {
			var face = geometry.faces[i];
			var a = getColorByZ(geometry.vertices[face.a].z);
			var b = getColorByZ(geometry.vertices[face.b].z);
			var c = getColorByZ(geometry.vertices[face.c].z);

			if (face.vertexColors.length < 3) {
				face.vertexColors = [a, b, c];
			} else {
				face.vertexColors[0].copy(a);
				face.vertexColors[1].copy(b);
				face.vertexColors[2].copy(c);
			}
		}
		geometry.colorsNeedUpdate = true;
	}

	function translateGridPoint(meshGeometry, vector) {
		var x, y, z = vector.z / scaleZ;
		if (meshGeometry.type == "PlaneGeometry") {
			x = (vector.x / meshGeometry.parameters.width + 0.5) * (probeXMax - probeXMin) + probeXMin;
			y = (vector.y / meshGeometry.parameters.height + 0.5) * (probeYMax - probeYMin) + probeYMin;
		} else if (meshGeometry.type == "Geometry") {
			x = (vector.x + 0.5) * (probeXMax - probeXMin) + probeXMin;
			y = (vector.y + 0.5) * (probeYMax - probeYMin) + probeYMin;
		} else {
			x = vector.x * (probeXMax - probeXMin) / 2;
			y = vector.y * (probeYMax - probeYMin) / 2;
		}

		return new THREE.Vector3(x, y, z);
	}

	function generateIndicators(meshGeometry) {
		var indicators = [], centerPointGenerated = false;

		for(var i = 0; i < meshGeometry.vertices.length; i++) {
			// Convert world coordinate to "real" probe coordinates
			var x = meshGeometry.vertices[i].x;
			var y = meshGeometry.vertices[i].y;
			var z = meshGeometry.vertices[i].z;
			var trueProbePoint = translateGridPoint(meshGeometry, new THREE.Vector3(x, y, z));

			// Skip center point if it already exists
			if (Math.sqrt(trueProbePoint.x*trueProbePoint.x + trueProbePoint.y*trueProbePoint.y) < pointTolerance) {
				if (centerPointGenerated) {
					continue;
				}
				centerPointGenerated = true;
			}

			// FIXME: Implement this for delta geometries as well
			if (meshGeometry.type != "RingGeometry") {
				// Calculate the actual height from the model.
				// Since we're using double precision this should be accurate enough
				trueProbePoint.z = z / scaleZ;
			}

			// If we have a close point, create a new indicator
			if (!isNaN(trueProbePoint.z)) {
				var radius =	(probePoints.length > 64) ? smallIndicatorRadius :
								(probePoints.length > 9) ? mediumIndicatorRadius :
								 bigIndicatorRadius;
				var sphereGeometry = new THREE.SphereGeometry(radius);
				sphereGeometry.applyMatrix(new THREE.Matrix4().makeTranslation(x, y, z));

				var material = new THREE.MeshBasicMaterial({ color: indicatorColor, opacity: indicatorOpacity, transparent: true });
				var sphere = new THREE.Mesh(sphereGeometry, material);
				sphere.coords = trueProbePoint;

				indicators.push(sphere);
			}
		}

		return indicators;
	}

	$("#modal_bed").on("shown.bs.modal", function () {
		if (meshGeometry == undefined) {
			// Don't proceed if we couldn't generate a mesh
			return;
		}

		// Get boundaries
		var width = $("#div_visualization").width();
		var height = $("#div_visualization").height();

		// Create THREE context
		scene = new THREE.Scene();

		camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
		camera.position.set(1.5, 1.5, 1.5);
		camera.up = new THREE.Vector3(0, 0, 1);

		renderer = new THREE.WebGLRenderer();
		renderer.setSize(width, height);

		// Allow grid to be moved and rotated by THREE OrbitControl
		var controls = new THREE.OrbitControls(camera, renderer.domElement);

		// Show legend+canvas div and insert WebGL element
		$("#div_visualization_placeholder").addClass("hidden");
		$("#div_visualization, #div_legend").removeClass("hidden");
		$("#div_visualization").html(renderer.domElement);
		$("#div_visualization > canvas").mousemove(canvasMouseMove).tooltip({ title: function() { return canvasTitle.split('\n').join("<br/>"); }, html: true, trigger: "manual" }).click(canvasClick);
		$("#modal_bed div.modal-content").resize();

		// Apply colors to geometry
		setFaceColors(meshGeometry);

		// Make 3D mesh
		var material = new THREE.MeshBasicMaterial({ vertexColors: THREE.VertexColors, side: THREE.DoubleSide });
		meshPlane = new THREE.Mesh(meshGeometry, material);
		scene.add(meshPlane);

		// Make indicators
		meshIndicators = generateIndicators(meshGeometry);
		meshIndicators.forEach(function(indicator) {
			scene.add(indicator);
		});

		// Make axis arrows
		var xMin = -0.6, yMin = -0.6;
		if (meshGeometry.hasOwnProperty("parameters") && meshGeometry.parameters.hasOwnProperty("width")) {
			xMin = meshGeometry.parameters.width * -0.5 - 0.1;
			yMin = meshGeometry.parameters.height * -0.5 - 0.1;
		}

		var xAxis = new THREE.ArrowHelper(new THREE.Vector3(1, 0, 0), new THREE.Vector3(xMin, yMin, 0), 0.5, 0xFF0000);
		var yAxis = new THREE.ArrowHelper(new THREE.Vector3(0, 1, 0), new THREE.Vector3(xMin, yMin, 0), 0.5, 0x00FF00);
		var zAxis = new THREE.ArrowHelper(new THREE.Vector3(0, 0, 1), new THREE.Vector3(xMin, yMin, 0), 0.5, 0x0000FF);
		scene.add(xAxis);
		scene.add(yAxis);
		scene.add(zAxis);

		// Make grid on XY plane
		var grid = new THREE.GridHelper(0.75, 15);
		grid.rotation.x = -Math.PI / 2;
		scene.add(grid);

		// Make raycaster
		raycaster = new THREE.Raycaster();

		// Render scene
		var render = function () {
			if (renderer != undefined) {
				requestAnimationFrame(render);
				renderer.render(scene, camera);
			}
		};
		render();
	});

	$("#modal_bed").on("hidden.bs.modal", function () {
		renderer.dispose();
		scene = camera = renderer = raycaster = undefined;

		$("#div_visualization").html("");
		$("#div_visualization_placeholder").removeClass("hidden");
		$("#div_visualization, #div_legend").addClass("hidden");
	});

	function canvasMouseMove(e) {
		if (e.pageX == undefined || probeXMin == undefined) {
			return;
		}

		// Try to get the Z value below the cursor
		// For that we need normalized X+Y coordinates between -1.0 and 1.0
		var mouse = new THREE.Vector2();
		var offset = $(this).offset();
		mouse.x = (e.pageX - offset.left) / $(this).width() * 2 - 1;
		mouse.y = -(e.pageY - offset.top) / $(this).height() * 2 + 1;

		// Is the cursor on a point indicator?
		raycaster.setFromCamera(mouse, camera);
		var intersection = raycaster.intersectObjects(meshIndicators);
		if (lastIntersection != undefined &&
			(intersection.length == 0 || intersection[0] != lastIntersection)) {
			lastIntersection.object.material.opacity = indicatorOpacity;
			lastIntersection = undefined;
		}

		var intersectionPoint = undefined;
		if (intersection.length > 0) {
			if (intersection[0] != lastIntersection) {
				lastIntersection = intersection[0];
				lastIntersection.object.material.opacity = indicatorOpacityHighlighted;
			}
			intersectionPoint = intersection[0].object.coords;
		}

		// Show the tooltip on md/lg devices and store it for xs/sm devices
		if (intersectionPoint == undefined) {
			updateCanvasTitle(undefined);
		} else {
			updateCanvasTitle(T("X: {0} mm\nY: {1} mm\nZ: {2} mm",
				intersectionPoint.x.toFixed(1), intersectionPoint.y.toFixed(1), intersectionPoint.z.toFixed(3)),
				e.pageX - offset.left, e.pageY - offset.top);
		}
	}

	var canvasTooltip, canvasTitle;
	function updateCanvasTitle(title, x, y) {
		var canvas = $("#div_visualization > canvas");
		if (title == undefined) {
			// Remove title
			canvasTitle = undefined;

			// Hide tooltip if it exists
			if (canvasTooltip != undefined) {
				canvas.tooltip("hide");
				canvasTooltip = undefined;
			}
		} else {
			// Set title
			canvasTitle = title;

			// Show info on md/lg screens
			if (!windowIsXsSm()) {
				// Show tooltip
				if (canvasTooltip == undefined) {
					canvas.tooltip("show");
					canvasTooltip = $("#div_visualization > div.tooltip");
				}

				// Reposition tooltip
				canvasTooltip.css("left", x + 15 - canvasTooltip.outerWidth() / 2).css("top", y - canvasTooltip.outerHeight());
			}
		}
	}

	function canvasClick(e) {
		if (windowIsXsSm() && canvasTitle != undefined) {
			// Show message on xs/sm devices because the tooltip isn't really working there
			alert(canvasTitle);
		}
	}

	$("#modal_bed > div > div.modal-content").resize(function() {
		var contentHeight = $(this).height();
		var headerHeight = $("#modal_bed > div > div > div.modal-header").outerHeight();
		var footerHeight = $("#modal_bed > div > div > div.modal-footer").outerHeight();

		// Set body height
		var bodyHeight = contentHeight - headerHeight - footerHeight;
		$("#modal_bed > div > div > div.modal-body").css("height", bodyHeight);

		// Set canvas height
		var childrenHeight = 45; // top+bottom margins
		$("#modal_bed > div > div > div.modal-body").children().each(function() {
			if ($(this).children("#div_visualization").length == 0) {
				childrenHeight += $(this).outerHeight();
			}
		});

		var canvasHeight = bodyHeight - childrenHeight;
		$("#div_visualization, #div_legend").css("height", canvasHeight + "px");
		$("#div_visualization_placeholder > div").css("height", canvasHeight + "px").css("line-height", canvasHeight + "px");

		if (camera != undefined) {
			var canvasWidth = $("#div_visualization").width();

			camera.aspect = canvasWidth / canvasHeight;
			camera.updateProjectionMatrix();

			renderer.setSize(canvasWidth, canvasHeight);
		}

		// Resize and redraw legend canvas
		var canvas = document.getElementById("canvas_legend");
		canvas.height = canvasHeight;
		canvas.width = $("#canvas_legend").parent().width();
		canvas.style.width = canvas.width + "px";
		canvas.style.height = canvasHeight + "px";
		var legendWidth = canvas.width;
		var context = canvas.getContext("2d");

		// clear background
		context.rect(0, 0, legendWidth, canvasHeight);
		context.fillStyle = "black";
		context.fill();

		// annotations above gradient
		context.font = "14px Helvetica";
		context.textAlign = "center";
		context.fillStyle = "white";
		context.fillText(T("Scale:"), legendWidth / 2, 21);
		context.fillText(T("{0} mm", maxVisualizationZ), legendWidth / 2, 44);
		context.fillText(T("or more"), legendWidth / 2, 60);

		// scale gradient
		var showAxes = canvasHeight > 180;
		var scaleHeight = showAxes ? (canvasHeight - 139) : (canvasHeight - 96);
		if (colorScheme == "terrain") {
			scaleHeight -= 16;
		}

		var gradient = context.createLinearGradient(0, 66, 0, 66 + scaleHeight);
		if (colorScheme == "terrain") {
			gradient.addColorStop(0.0, "hsl(0,100%,45%)");
			gradient.addColorStop(0.25, "hsl(60,100%,45%)");
			gradient.addColorStop(0.5, "hsl(120,100%,45%)");
			gradient.addColorStop(0.75, "hsl(180,100%,45%)");
			gradient.addColorStop(1.0, "hsl(240,100%,45%)");
		} else {
			gradient.addColorStop(0.0, "hsl(0,100%,45%)");
			gradient.addColorStop(0.5, "hsl(60,100%,45%)");
			gradient.addColorStop(1.0, "hsl(120,100%,45%)");
		}
		context.fillStyle = gradient;
		context.fillRect(legendWidth / 2 - 12, 66, 24, scaleHeight);

		// annotation below gradient
		context.fillStyle = "white";
		if (colorScheme == "terrain") {
			context.fillText(T("{0} mm", -maxVisualizationZ), legendWidth / 2, scaleHeight + 82);
			context.fillText(T("or less"), legendWidth / 2, scaleHeight + 98);
			scaleHeight += 16;
		} else {
			context.fillText(T("{0} mm", "0.00"), legendWidth / 2, scaleHeight + 82);
		}

		// axes
		if (showAxes) {
			context.fillText(T("Axes:"), legendWidth / 2, scaleHeight + 109);
			context.font = "bold 14px Helvetica";
			context.fillStyle = "rgb(255,0,0)";
			context.fillText("X", legendWidth / 3, scaleHeight + 129);
			context.fillStyle = "rgb(0,255,0)";
			context.fillText("Y", legendWidth / 2, scaleHeight + 129);
			context.fillStyle = "rgb(0,0,255)";
			context.fillText("Z", 2 * legendWidth / 3, scaleHeight + 129);
		}
	});

	$("#btn_top_view").click(function() {
		camera.position.set(0, 0, 2);
		camera.rotation.set(0, 0, 0);
		camera.updateProjectionMatrix();
	});

	$("#a_show_bed_points").click(function(e) {
		if (bedProbePoints != undefined) {
			showBedCompensation(bedProbePoints);
		}
		e.preventDefault();
	});

	$("#a_show_heightmap").click(function(e) {
		getHeightmap();
		e.preventDefault();
	});

	$(".color-scheme").click(function(e) {
		colorScheme = $(this).data("scheme");

		setFaceColors(meshGeometry);
		$("#modal_bed > div > div.modal-content").resize();

		e.preventDefault();
	});
